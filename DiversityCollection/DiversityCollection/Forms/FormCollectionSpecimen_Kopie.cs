//#define NAGOYA_TEST

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Text;
using System.Windows.Forms;
using System.Globalization;
using WpfSamplingPlotPage;


namespace DiversityCollection
{

    public partial class FormCollectionSpecimen : Form, DiversityWorkbench.AnnotationProvider, DiversityWorkbench.Spreadsheet.iMainForm, DiversityWorkbench.WorkbenchUnitUserInterface
    {

        #region Parameter

        private System.Windows.Forms.BindingSource _CustomSubstrateUnitBinding;
        private System.Windows.Forms.BindingSource _CustomSubstrateIdentificationBinding;
        private System.Windows.Forms.BindingSource _CustomAltitudeBinding;
        private System.Windows.Forms.BindingSource _CustomGazetteerBinding;

        private bool? _LocalDatabaseNotMissing = null;

        private int? _SeriesID = null;

        private DiversityWorkbench.FormFunctions _FormFunctions;

        private System.Data.DataTable _dtProjects;
        private System.Data.DataTable _dtLoan;
        private System.Data.DataTable _dtCollection;
        private System.Data.DataTable _dtProcessing;
        private System.Data.DataTable _dtExchange;
        private System.Data.DataTable _dtLocalisationSystem;
        private System.Data.DataTable _dtAnalysis;
        private System.Data.DataTable _dtImageUnits;
        private System.Data.DataTable _dtImageParts;
        private System.Data.DataTable _dtGender;
        private System.Data.DataTable _dtLifeStage;
        private System.Data.DataTable _dtAnalysisOfPart;
        private System.Data.DataTable _dtAnalysisResult;
        private System.Data.DataView _dvAnalysisResult;

        private System.Collections.Generic.List<DiversityWorkbench.QueryCondition> _CustomFields;
        private System.Collections.Generic.Dictionary<string, bool> _CustomFieldsVisibility;

        private bool PermissionStorageInsert = false;
        private bool PermissionStorageUpdate = false;
        private bool PermissionStorageDelete = false;
        private bool PermissionProcessingInsert = false;
        private bool PermissionProcessingUpdate = false;
        private bool PermissionProcessingDelete = false;

        private int? _DefaultCollection = -1;

        DiversityCollection.CollectionSpecimen.AvailabilityState _Availability = CollectionSpecimen.AvailabilityState.Unknown;

        private enum IdentInsertType { New, Confirm, Old };
        private enum ImageDisplayState { Missing, Hidden, Shown };
        private enum AnalysisDisplayStyle { Hidden, NoHierarchy, ListByName, ListByNumber, HierarchyType, HierarchyDate, HierarchyTypeDate, HierarchyDateType, HierarchyOfAnalysis };
        private enum HierachyDisplayStyle { Hidden, Parents, Hierarchy };

        // GridMode
        /// <summary>
        /// Mode of the form
        /// Spreadsheetmode: Called by a spreadsheet to show the details of a dataset
        /// QueryMode: Called e.g. by distribution map for the restriction of a setting
        /// SpreadsheetMode: Form is not closing, but hiding to enable call for single inspection datasets from spreadsheets
        /// ProcessOnly: No userinterface, only process
        /// Scanmode: Searching for specimen via barcode scanner
        /// SingleInspectionMode: Showing data of a single specimen e.g. for inspection calls from maintenance
        /// </summary>
        public enum ViewMode { Default, Scanmode, CollectionScanMode, Gridmode, SpreadsheetMode, ProcessOnly, QueryMode, SingleInspectionMode };
        private System.Collections.Generic.List<DiversityCollection.GridModeQueryField> _GridModeQueryFields;
        private System.Collections.Generic.List<DiversityCollection.GridModeQueryField> _GridModeHiddenQueryFields;
        private System.Collections.Generic.List<string> _GridModeColumnList;
        private DiversityCollection.FormCollectionSpecimen.ViewMode _ViewMode = ViewMode.Default;
        public void setViewMode(DiversityCollection.FormCollectionSpecimen.ViewMode Mode)
        {
            this._ViewMode = Mode;
        }
        private System.Collections.Generic.Dictionary<string, string> _GridModeTableList;
        private string _RememberQueryConditionSettingsFile;

        #region Geography
        // GEOGRAPHY
        private enum MeasurementUnit { m, km, feet, mile, degree, percent, numeric, deg_min_sec, orientation };
        private string[] NamedOrientation = new string[16] { "N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW" };
        private readonly string GeoOriValStart = "[Ori.val.: ";
        private readonly string GeoOriValEnd = "]";

        private System.Data.DataView dvUnitsDisplay;
        private System.Data.DataView dvUnitsHide;

        private System.Data.DataView _DvPartDescription;

        private System.Data.DataView _dvImageProperty;

        private bool _PrintPart = false;

        /// <summary>
        /// the WPF control for the graphical operations
        /// </summary>
        private WpfSamplingPlotPage.WpfControl _wpfControl;


        //private System.Windows.Forms.Integration.ElementHost elementHost;

        //public WpfSamplingPlotPage.WpfControl WpfControl
        //{
        //    get
        //    {
        //        if (this._wpfControl == null)
        //        {
        //            this.elementHost = new System.Windows.Forms.Integration.ElementHost();
        //            this.elementHost.Dock = System.Windows.Forms.DockStyle.Fill;
        //            //this.panelForWpfControl.Controls.Add(this.elementHost);

        //            this._wpfControl = new WpfSamplingPlotPage.WpfControl();
        //            this._wpfControl.WpfSetMode(2);
        //            //this.elementHost.Child = this._wpfControl.WpfGetCanvas(this.panelForWpfControl);
        //        }
        //        return _wpfControl;
        //    }
        //    set { _wpfControl = value; }
        //}


        private enum GisMapState { Single, Distribution };
        private GisMapState _GisMapState = GisMapState.Single;

        
        #endregion

        #region Scanning

        private enum ScanStep { Idle, Scanning};
        private ScanStep _CurrentScanStep = ScanStep.Idle;

        #endregion

        #region Data

        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterSpecimen;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterSpecimenImage;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterSpecimenImageProperty;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterAgent;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterProject;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterReference;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterRelation;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterRelationInvers;

        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterPart;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterProcessing;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterProcessingMethod;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterProcessingMethodParameter;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterTransaction;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterPartDescription;
        //private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterPartRegulation;

        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterUnit;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterUnitInPart;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterIdentification;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterAnalysis;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterGeoAnalysis;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterGeoAnalysisGeography;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterAnalysisMethod;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterAnalysisMethodParameter;

        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterEvent;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterEventGeography;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterEventImage;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterEventRegulation;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterLocalisation;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterLocalisationSystem;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterProperty;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterCollectionEventMethod;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterCollectionEventMethodParameter;

        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterEventSeriesSuperiorList;

        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterEventSeries;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterEventSeriesImage;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterEventSeriesEvent;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterEventSeriesSpecimen;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterEventSeriesSpecimenExtern;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterEventSeriesUnit;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterEventSeriesUnitExtern;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterEventSeriesLocalisation;

        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterPlotEvent;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterPlotSpecimen;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterPlotSpecimenExtern;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterPlotUnit;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterPlotUnitExtern;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterPlotLocalisation;

        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterCollection;

        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterIdentifier;
        private System.Data.SqlClient.SqlDataAdapter sqlDataAdapterAnnotation;

        DiversityCollection.Datasets.DataSetCollectionEventSeries.CollectionEventSeriesImageDataTable _CollectionEventSeriesImageDataTable = new DiversityCollection.Datasets.DataSetCollectionEventSeries.CollectionEventSeriesImageDataTable();

        private System.Windows.Forms.BindingSource _collectionEventLocalisationGeoBindingSource;

        private DiversityCollection.Datasets.DataSetSamplingPlotList _DataSetSamplingPlotList;
        private string _CurrentPlotID;

        #endregion

        // Menu - predefined statements
        private System.Data.DataTable dtApplicationSearchSelectionStrings;

        private DiversityWorkbench.SamplingPlot _SamplingPlot;// = new DiversityWorkbench.SamplingPlot(DiversityWorkbench.Settings.ServerConnection);

        private static bool? _HasTransactionAccess;

        public static bool HasTransactionAccess
        {
            get 
            {
                if (DiversityCollection.FormCollectionSpecimen._HasTransactionAccess == null)
                {
                    if (DiversityWorkbench.Database.DatabaseRoles().Contains("StorageManager") || 
                        DiversityWorkbench.Database.DatabaseRoles().Contains("CollectionManager") ||
                        DiversityWorkbench.Database.DatabaseRoles().Contains("Administrator") ||
                        DiversityWorkbench.Database.DatabaseRoles().Contains("TransactionUser") ||
                        DiversityWorkbench.Database.DatabaseRoles().Contains("db_owner"))
                        DiversityCollection.FormCollectionSpecimen._HasTransactionAccess = true;
                    else DiversityCollection.FormCollectionSpecimen._HasTransactionAccess = false;
                }
                if (DiversityCollection.FormCollectionSpecimen._HasTransactionAccess != null)
                    return (bool)_HasTransactionAccess; 
                else
                    return false;
            }
            set { _HasTransactionAccess = value; }
        }

        private bool _ClientIsOutdated = false;

        #endregion

        #region Construction

        public FormCollectionSpecimen()
        {
            InitializeComponent();

            ///TODO
            //this.textBoxLocalityDescriptionVerbatim.Enabled = false;

            ///TODO - nach korrektur wieder weg
            //this.textBoxNumberOfUnitsModifier.Visible = false;
            //this.toolStripTextBoxAnalysisMethodMarker.Visible = false;

            try
            {
                try { DiversityWorkbench.Settings.ModuleName = "DiversityCollection"; }
                catch { }
                bool OK = true;
                if (1 == 1) //DiversityWorkbench.Settings.DatabaseServer != "127.0.0.1")
                    OK = this.setDatabase();
                else
                    this.splitContainerData.Visible = false;

                this.initForm();
                this.initQuery();
                this.setQueryControlEvents();
                this.helpProviderDiversityCollection.HelpNamespace = System.Windows.Forms.Application.StartupPath + "\\DiversityCollection.chm";
                DiversityWorkbench.FormFeedback.HelpProviderHelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlImageEventImage.HelpNameSpace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlImageCollectionEventSeries.HelpNameSpace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlImageSpecimenImage.HelpNameSpace = this.helpProviderDiversityCollection.HelpNamespace;
                if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection > -1)
                    this.DefaultCollection = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection;
                this.setLanguage();
                if (DiversityCollection.Properties.Settings.Default.KioskMode)
                    this.setKioskMode();
                this.timerScanning.Interval = DiversityCollection.Forms.FormTransactionSettings.Default.TimerIntervall;

                if (Spreadsheet.Target.StarterTarget() != null)
                {
                    //this.Hide();
                    switch (Spreadsheet.Target.StarterTarget())
                    {
                        case Spreadsheet.Target.SheetTarget.Organisms:
                            this.StartSpreadSheet(Spreadsheet.Target.SheetTarget.Organisms);
                            break;
                        case Spreadsheet.Target.SheetTarget.Parts:
                            this.StartSpreadSheet(Spreadsheet.Target.SheetTarget.Parts);
                            break;
                        case Spreadsheet.Target.SheetTarget.Event:
                            this.StartSpreadSheet(Spreadsheet.Target.SheetTarget.Event);
                            break;
                        case Spreadsheet.Target.SheetTarget.Image:
                            this.StartSpreadSheet(Spreadsheet.Target.SheetTarget.Image);
                            break;
                        case Spreadsheet.Target.SheetTarget.TK25:
                            this.StartSpreadSheet(Spreadsheet.Target.SheetTarget.TK25);
                            break;
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="args">
        /// For CacheTransfer the following parameters are needed:
        /// CacheTransfer
        /// Server for SQL-Server database
        /// Port of server
        /// Database with source data
        /// If data should be transferred to SQL-Server database (1 or 0)
        /// Server for Postgres database
        /// Port for Postgres server
        /// Name of Postgres database
        /// Name of Postgres user
        /// Password of Postgres user
        /// If data should be transferred to Postgres database (1 or 0)</param>
        public FormCollectionSpecimen(string[] args)
            : this()
        {
            try
            {
                System.Collections.Generic.List<string> Arguments = new List<string>();
                string ArgumentsString = "";
                foreach (var arg in args)
                {
                    if (ArgumentsString.Length > 0)
                        ArgumentsString += "; ";
                    ArgumentsString += arg;
                    Arguments.Add(arg.ToString());
                }
                this._ViewMode = ViewMode.ProcessOnly;
                string Target = Arguments[0].ToLower().Trim();
                string CacheTransferMessage = "___CacheTransfer__________________________";
                if (Target == "cachetransferwithlogging")
                {
                    CacheTransferMessage = "___Cache_transfer_with_logging__________________________";
                    CacheDatabase.CacheDBsettings.Default.LogEvents = true;
                }
                System.DateTime _ArchiveIncrementalStartDate;
                bool _ArchiveIncremental = false;
                switch (Target)
                {
                    case "cachetransferpostgres":
                        CacheDatabase.CacheDB.IncludePostgres = true;
                        CacheDatabase.CacheDB.IncludeCacheDB = false;
                        goto case "cachetransfer";
                    case "cachetransfercachedb":
                        CacheDatabase.CacheDB.IncludePostgres = false;
                        CacheDatabase.CacheDB.IncludeCacheDB = true;
                        goto case "cachetransfer";
                    case "cachetransferwithlogging":
                    case "cachetransfer":
                        CacheDatabase.CacheDB.ProcessOnly = true;
                        try
                        {
                            if(DiversityCollection.CacheDatabase.CacheDBsettings.Default.LogEvents)
                                DiversityWorkbench.ExceptionHandling.InitErrorLogFile(CacheTransferMessage);

                            // Last argument is password
                            ArgumentsString = ArgumentsString.Substring(0, ArgumentsString.LastIndexOf(";")) + "; *****";

                            DiversityCollection.CacheDatabase.CacheDB.LogEvent(this.Name.ToString(), "FormCollectionSpecimen(string[] args)", "Starting application with arguments " + ArgumentsString, false);

                            this.Hide();
                            this.InitCacheTransferConnections(args);
                            string[] ArgsCacheStart = new string[1];
                            ArgsCacheStart[0] = "";// args[9];
                            DiversityCollection.CacheDatabase.FormCacheDatabase f = new CacheDatabase.FormCacheDatabase(ArgsCacheStart);
                            if (f.TransferFinished)
                            {
                                DiversityCollection.CacheDatabase.CacheDB.LogEvent("", "", "___Successful_end_of_CacheTransfer__________________________");
                                Application.Exit();
                                this.Close();
                                System.Environment.Exit(0);
                            }
                            else
                            {
                                DiversityCollection.CacheDatabase.CacheDB.LogEvent("", "", "___CacheTransfer_exit_with_failure__________________________");
                                Application.Exit();
                                this.Close();
                                System.Environment.Exit(1);
                            }
                        }
                        catch (System.Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                            System.Environment.Exit(1);
                        }
                        break;
                    case "databasetocache":
                        // not supported any longer
                        try
                        {
                            DiversityWorkbench.ExceptionHandling.InitErrorLogFile("DatabaseToCache");
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(this.Name.ToString(), "FormCollectionSpecimen(string[] args)", "Starting application with arguments " + ArgumentsString);
                            this.Hide();
                            this.InitCacheTransferConnections(args, false);
                            string[] ArgsCacheStart = new string[2];
                            ArgsCacheStart[0] = Target;
                            ArgsCacheStart[1] = args[4];
                            DiversityCollection.CacheDatabase.FormCacheDatabase f = new CacheDatabase.FormCacheDatabase(ArgsCacheStart);
                            if (f.TransferFinished)
                            {
                                Application.Exit();
                                this.Close();
                                System.Environment.Exit(1);
                            }
                        }
                        catch (System.Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        }
                        break;
                    case "cachetopostgres":
                        // not supported any longer
                        try
                        {
                            DiversityWorkbench.ExceptionHandling.InitErrorLogFile("CacheToPostgres");
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(this.Name.ToString(), "FormCollectionSpecimen(string[] args)", "Starting application with arguments " + ArgumentsString);
                            this.Hide();
                            this.InitCacheTransferConnections(args, true);
                            string[] ArgsCacheStart = new string[2];
                            ArgsCacheStart[0] = Target;
                            ArgsCacheStart[1] = args[4];
                            DiversityCollection.CacheDatabase.FormCacheDatabase f = new CacheDatabase.FormCacheDatabase(ArgsCacheStart);
                            if (f.TransferFinished)
                            {
                                Application.Exit();
                                this.Close();
                                System.Environment.Exit(1);
                            }
                        }
                        catch (System.Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        }
                        break;
                    case "archiveincremental":
                        // not supported so far
                        try
                        {
                            if (System.DateTime.TryParse(Arguments[5], out _ArchiveIncrementalStartDate))
                            {
                                _ArchiveIncremental = true;
                                goto case "archive";
                            }
                        }
                        catch (System.Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        }
                        break;
                    case "archive":
                        try
                        {
                            this.Hide();
                            DiversityWorkbench.ExceptionHandling.InitErrorLogFile("Archive");
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile("FormCollectionSpecimen", "FormCollectionSpecimen(string[] args)", "Starting archive with arguments " + ArgumentsString);
                            // Setting the connection
                            DiversityWorkbench.Settings.DatabaseServer = Arguments[1];
                            DiversityWorkbench.Settings.DatabasePort = int.Parse(Arguments[2].ToString());
                            DiversityWorkbench.Settings.DatabaseName = Arguments[3];
                            DiversityWorkbench.Settings.IsTrustedConnection = true;
                            string ArchiveDirectory = System.Windows.Forms.Application.StartupPath + "\\Archive";
                            if (Arguments.Count > 4 && Arguments[4].Length > 0)
                                ArchiveDirectory = Arguments[4];
                            DiversityWorkbench.Archive.FormArchiveAdministration fA = new DiversityWorkbench.Archive.FormArchiveAdministration(
                                ArchiveDirectory, "ProjectProxy", "Project", "ProjectID", "CreateArchive", "ArchiveProtocol", "CollectionProject", "CollectionSpecimenID", this.ArchiveTables());
                            //if (_ArchiveIncremental)
                            //    fA.set
                            fA.CreateArchives();
                            Application.Exit();
                            this.Close();
                            System.Environment.Exit(1);
                        }
                        catch (System.Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        }
                        break;
                    case "singleitem":
                        // DiversityCollection.exe singleItem development.diversityworkbench.de 5432 DiversityCollection_Test 
                        try
                        {
                            this._ViewMode = ViewMode.SingleInspectionMode;
                            DiversityWorkbench.Settings.DatabaseServer = Arguments[1];
                            string Port = Arguments[2];
                            int iPort;
                            if (int.TryParse(Port, out iPort))
                                DiversityWorkbench.Settings.DatabasePort = iPort;
                            string Database = Arguments[3];
                            DiversityWorkbench.Settings.DatabaseName = Database;
                            string URI = Arguments[4];
                            if (Arguments.Count > 5)
                            {
                                string User = Arguments[5];
                                string Password = Arguments[6];
                                if (User.Length > 0 && Password.Length > 0)
                                {
                                    DiversityWorkbench.Settings.DatabaseUser = User;
                                    DiversityWorkbench.Settings.Password = Password;
                                    DiversityWorkbench.Settings.IsTrustedConnection = false;
                                }
                                else
                                    DiversityWorkbench.Settings.IsTrustedConnection = true;
                            }
                            else
                                DiversityWorkbench.Settings.IsTrustedConnection = true;
                            string ID = DiversityWorkbench.WorkbenchUnit.getIDFromURI(URI, true);
                            this.initQuery();
                            this.setDatabase();
                            int iID;
                            if (int.TryParse(ID, out iID))
                                this.userControlQueryList.AddListItem(iID, ID);
                            this.setSpecimen(int.Parse(ID));
                        }
                        catch (System.Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        }
                        break;
                    default:
                        this.showQueryToolStripMenuItem_Click(null, null);
                        this.setConnection(args);
                        this.setDatabase();
                        this.setSpecimen(int.Parse(args[0]));
                        break;
                }

                //return;



                #region AlterCode
                /////Weg nach Test
                //System.Windows.Forms.MessageBox.Show("Argument 0: " + Arguments[0].ToLower());
                /////Weg nach Test
                //if (Arguments[0].ToLower() == "cachetransfer")
                //{
                //    DiversityWorkbench.ExceptionHandling.WriteToEventLog(this.Name.ToString(), "FormCollectionSpecimen(string[] args)", "Starting application", DiversityWorkbench.Settings.ModuleName);
                //    ///Weg nach Test
                //    //System.Windows.Forms.MessageBox.Show("Started FormCollectionSpecimen");
                //    ///Weg nach Test
                //    this.Hide();
                //    this.InitCacheTransferConnections(args);
                //    string[] ArgsCacheStart = new string[1];
                //    ArgsCacheStart[0] = args[9];
                //    DiversityCollection.CacheDatabase.FormCacheDatabase f = new CacheDatabase.FormCacheDatabase(ArgsCacheStart);
                //    if (f.TransferFinished)
                //    {
                //        ///Weg nach Test
                //        //System.Windows.Forms.MessageBox.Show("Application.Exit");
                //        Application.Exit();
                //        //System.Windows.Forms.MessageBox.Show("Closing FormCollectionSpecimen");
                //        this.Close();
                //        //System.Windows.Forms.MessageBox.Show("Environment.Exit");
                //        ///Weg nach Test
                //        System.Environment.Exit(1);
                //    }
                //    //f.ShowDialog();
                //}
                //else if (Arguments[0].ToLower() == "databasetocache")
                //{
                //    DiversityWorkbench.ExceptionHandling.WriteToEventLog(this.Name.ToString(), "FormCollectionSpecimen(string[] args)", "Starting application", DiversityWorkbench.Settings.ModuleName);
                //    ///Weg nach Test
                //    //System.Windows.Forms.MessageBox.Show("Started FormCollectionSpecimen");
                //    ///Weg nach Test
                //    this.Hide();
                //    this.InitCacheTransferConnections(args);
                //    string[] ArgsCacheStart = new string[1];
                //    ArgsCacheStart[0] = args[9];
                //    DiversityCollection.CacheDatabase.FormCacheDatabase f = new CacheDatabase.FormCacheDatabase(ArgsCacheStart);
                //    if (f.TransferFinished)
                //    {
                //        ///Weg nach Test
                //        //System.Windows.Forms.MessageBox.Show("Application.Exit");
                //        Application.Exit();
                //        //System.Windows.Forms.MessageBox.Show("Closing FormCollectionSpecimen");
                //        this.Close();
                //        //System.Windows.Forms.MessageBox.Show("Environment.Exit");
                //        ///Weg nach Test
                //        System.Environment.Exit(1);
                //    }
                //    //f.ShowDialog();
                //}
                //else if (Arguments[0].ToLower() == "cachetopostgres")
                //{
                //    DiversityWorkbench.ExceptionHandling.WriteToEventLog(this.Name.ToString(), "FormCollectionSpecimen(string[] args)", "Starting application", DiversityWorkbench.Settings.ModuleName);
                //    ///Weg nach Test
                //    //System.Windows.Forms.MessageBox.Show("Started FormCollectionSpecimen");
                //    ///Weg nach Test
                //    this.Hide();
                //    this.InitCacheTransferConnections(args);
                //    string[] ArgsCacheStart = new string[1];
                //    ArgsCacheStart[0] = args[9];
                //    DiversityCollection.CacheDatabase.FormCacheDatabase f = new CacheDatabase.FormCacheDatabase(ArgsCacheStart);
                //    if (f.TransferFinished)
                //    {
                //        ///Weg nach Test
                //        //System.Windows.Forms.MessageBox.Show("Application.Exit");
                //        Application.Exit();
                //        //System.Windows.Forms.MessageBox.Show("Closing FormCollectionSpecimen");
                //        this.Close();
                //        //System.Windows.Forms.MessageBox.Show("Environment.Exit");
                //        ///Weg nach Test
                //        System.Environment.Exit(1);
                //    }
                //    //f.ShowDialog();
                //}
                //else if (Arguments[0].ToLower() == "archive")
                //{
                //    ///Weg nach Test
                //    System.Windows.Forms.MessageBox.Show("In Pfad archive");
                //    ///Weg nach Test
                //    this.Hide();
                //    // Setting the connection
                //    DiversityWorkbench.Settings.DatabaseServer = args[1];
                //    DiversityWorkbench.Settings.DatabasePort = int.Parse(args[2].ToString());
                //    DiversityWorkbench.Settings.DatabaseName = args[3];
                //    DiversityWorkbench.Settings.IsTrustedConnection = true;
                //    string ArchiveDirectory = args[4];
                //    DiversityWorkbench.Archive.FormArchiveAdministration f = new DiversityWorkbench.Archive.FormArchiveAdministration(
                //        ArchiveDirectory, "ProjectProxy", "Project", "ProjectID", "CreateArchive", "ArchiveProtocol", "CollectionProject", "CollectionSpecimenID", this.ArchiveTables());
                //    f.CreateArchives();
                //    Application.Exit();
                //    this.Close();
                //    System.Environment.Exit(1);
                //}
                //else
                //{
                //    this.showQueryToolStripMenuItem_Click(null, null);
                //    this.setConnection(args);
                //    this.setDatabase();
                //    this.setSpecimen(int.Parse(args[0]));
                //}
 
	        #endregion            
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void InitCacheTransferConnections(string[] args)
        {
            try
            {
                DiversityWorkbench.Settings.DatabaseServer = args[1];
                DiversityWorkbench.Settings.DatabasePort = int.Parse(args[2].ToString());
                DiversityWorkbench.Settings.DatabaseName = args[3];
                DiversityWorkbench.Settings.IsTrustedConnection = true;
                if (args.Length > 3)
                {
                    DiversityWorkbench.PostgreSQL.Connection.SetCurrentServer(args[4]);
                    DiversityWorkbench.PostgreSQL.Connection.SetCurrentPort(int.Parse(args[5].ToString()));
                    DiversityWorkbench.PostgreSQL.Connection.SetCurrentDatabase(args[6]);
                    DiversityWorkbench.PostgreSQL.Connection.SetCurrentRole(args[7]);
                    DiversityWorkbench.PostgreSQL.Connection.Password = args[8];
                }

                DiversityWorkbench.ExceptionHandling.WriteToEventLog(this.Name.ToString(), "InitCacheTransferConnections(string[] args)", "Connection parameters set", DiversityWorkbench.Settings.ModuleName);
                ///Weg nach Test
                //System.Windows.Forms.MessageBox.Show("Database " + args[7]);
                //System.Windows.Forms.MessageBox.Show("Postgres DefaultConnectionString " + DiversityWorkbench.PostgreSQL.Connection.DefaultConnectionString());
                ///Weg nach Test
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                DiversityWorkbench.ExceptionHandling.WriteToEventLog(this.Name.ToString(), "InitCacheTransferConnections(string[] args)", "Setting connection parameters failed", DiversityWorkbench.Settings.ModuleName);
            }
        }

        private void InitCacheTransferConnections(string[] args, bool ForPostgres)
        {
            try
            {
                DiversityWorkbench.Settings.DatabaseServer = args[1];
                DiversityWorkbench.Settings.DatabasePort = int.Parse(args[2].ToString());
                DiversityWorkbench.Settings.DatabaseName = args[3];
                DiversityWorkbench.Settings.IsTrustedConnection = true;
                if (args.Length > 4 && ForPostgres)
                {
                    DiversityWorkbench.PostgreSQL.Connection.SetCurrentServer(args[5]);
                    DiversityWorkbench.PostgreSQL.Connection.SetCurrentPort(int.Parse(args[6].ToString()));
                    DiversityWorkbench.PostgreSQL.Connection.SetCurrentDatabase(args[7]);
                    DiversityWorkbench.PostgreSQL.Connection.SetCurrentRole(args[8]);
                    DiversityWorkbench.PostgreSQL.Connection.Password = args[9];
                }

                DiversityWorkbench.ExceptionHandling.WriteToEventLog(this.Name.ToString(), "InitCacheTransferConnections(string[] args)", "Connection parameters set", DiversityWorkbench.Settings.ModuleName);
                ///Weg nach Test
                //System.Windows.Forms.MessageBox.Show("Database " + args[7]);
                //System.Windows.Forms.MessageBox.Show("Postgres DefaultConnectionString " + DiversityWorkbench.PostgreSQL.Connection.DefaultConnectionString());
                ///Weg nach Test
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                DiversityWorkbench.ExceptionHandling.WriteToEventLog(this.Name.ToString(), "InitCacheTransferConnections(string[] args)", "Setting connection parameters failed", DiversityWorkbench.Settings.ModuleName);
            }
        }

        public FormCollectionSpecimen(int CollectionSpecimenID, bool ShowDialogPanel, bool ShowMenu) 
        {
            // Replace : this() to avoid initQuery if not needed
            InitializeComponent();
            try
            {
                try { DiversityWorkbench.Settings.ModuleName = "DiversityCollection"; }
                catch { }
                bool OK = true;
                if (DiversityWorkbench.Settings.DatabaseServer != "127.0.0.1")
                    OK = this.setDatabase();
                else
                    this.splitContainerData.Visible = false;
                this.initForm();
                if (ShowMenu)
                    this.initQuery();
                this.setQueryControlEvents();
                this.helpProviderDiversityCollection.HelpNamespace = System.Windows.Forms.Application.StartupPath + "\\DiversityCollection.chm";
                this.userControlImageEventImage.HelpNameSpace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlImageCollectionEventSeries.HelpNameSpace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlImageSpecimenImage.HelpNameSpace = this.helpProviderDiversityCollection.HelpNamespace;
                if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection > -1)
                    this.DefaultCollection = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection;
                this.setLanguage();
                if (DiversityCollection.Properties.Settings.Default.KioskMode)
                    this.setKioskMode();
                this.timerScanning.Interval = DiversityCollection.Forms.FormTransactionSettings.Default.TimerIntervall;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            try
            {
                if (this.Parent != null)
                {
                    this.Width = this.Parent.Width - 20;
                    this.Height = this.Parent.Height - 20;
                }
                this.StartPosition = FormStartPosition.CenterParent;
                this.splitContainerMain.Panel1Collapsed = true;
                this.setSpecimen(CollectionSpecimenID);
                if (this.textBoxHeaderAccessionNumber.Text.Length == 0)
                    this.Text = "[ID: " + this.ID.ToString() + "]";
                else
                    this.Text = this.textBoxHeaderAccessionNumber.Text;
                this.Text += " - " + this.textBoxHeaderIdentification.Text;
                this.Text = this.Text.Replace("\r\n", " - ");
                this.userControlDialogPanel.Visible = ShowDialogPanel;
                this.menuStripMain.Visible = ShowMenu;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        public FormCollectionSpecimen(int CollectionSpecimenID, bool ShowDialogPanel, bool ShowMenu, ViewMode Mode)
        {
            // Replace : this() to avoid initQuery if not needed
            InitializeComponent();
            try
            {
                try { DiversityWorkbench.Settings.ModuleName = "DiversityCollection"; }
                catch { }
                bool OK = true;
                this._ViewMode = Mode;
                if (DiversityWorkbench.Settings.DatabaseServer != "127.0.0.1")
                    OK = this.setDatabase();
                else
                    this.splitContainerData.Visible = false;
                this.initForm();
                if (ShowMenu)
                    this.initQuery();
                this.setQueryControlEvents();
                this.helpProviderDiversityCollection.HelpNamespace = System.Windows.Forms.Application.StartupPath + "\\DiversityCollection.chm";
                this.userControlImageEventImage.HelpNameSpace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlImageCollectionEventSeries.HelpNameSpace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlImageSpecimenImage.HelpNameSpace = this.helpProviderDiversityCollection.HelpNamespace;
                if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection > -1)
                    this.DefaultCollection = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection;
                this.setLanguage();
                if (DiversityCollection.Properties.Settings.Default.KioskMode)
                    this.setKioskMode();
                this.timerScanning.Interval = DiversityCollection.Forms.FormTransactionSettings.Default.TimerIntervall;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            try
            {
                if (this.Parent != null)
                {
                    this.Width = this.Parent.Width - 20;
                    this.Height = this.Parent.Height - 20;
                }
                this.StartPosition = FormStartPosition.CenterParent;
                this.splitContainerMain.Panel1Collapsed = true;
                this.setSpecimen(CollectionSpecimenID);
                if (this.textBoxHeaderAccessionNumber.Text.Length == 0)
                    this.Text = "[ID: " + this.ID.ToString() + "]";
                else
                    this.Text = this.textBoxHeaderAccessionNumber.Text;
                this.Text += " - " + this.textBoxHeaderIdentification.Text;
                this.Text = this.Text.Replace("\r\n", " - ");
                this.userControlDialogPanel.Visible = ShowDialogPanel;
                this.menuStripMain.Visible = ShowMenu;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        public FormCollectionSpecimen(int CollectionSpecimenID, bool ShowDialogPanel, bool ShowMenu, ViewMode Mode, string RememberQueryConditionSettingsFile)
            : this(CollectionSpecimenID, ShowDialogPanel, ShowMenu, Mode)
        {
            this._RememberQueryConditionSettingsFile = RememberQueryConditionSettingsFile;
        }

        #endregion

        #region Exception Handling

        private void initExceptionHandling()
        {
            string Logfile = System.Windows.Forms.Application.StartupPath + "\\" + System.Windows.Forms.Application.ProductName.ToString() + "Error.log";
            if (System.IO.File.Exists(Logfile))
                try
                {
                    System.IO.File.Delete(Logfile);

                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
        }

        #endregion

        #region Menu

        private void setMenu()
        {
            this.setHelpMenu();
            this.setUpdateMenu();
            if (!this._ClientIsOutdated)
            {
                this.setDataMenu();
                this.setAdminMenu();
                this.setContextMenu();
                this.setTableEditorMenu();
                this.setSpreadsheetMenu();
                timeoutForDatabaseToolStripMenuItem.ToolTipText = DiversityWorkbench.Settings.TimeoutDatabase.ToString() + " sec.";
            }
            this.dataToolStripMenuItem.Enabled = !this._ClientIsOutdated;
            this.gridToolStripMenuItem.Enabled = !this._ClientIsOutdated;
            this.administrationToolStripMenuItem.Enabled = !this._ClientIsOutdated;

            //this.scanModeCollectionToolStripMenuItem.Visible = false;
            this.toolStripMenuItemScanTargetCollection.Visible = false;

            //TODO - WIEDER EINBAUEN WENN OK
            //this.eventSheetToolStripMenuItem.Visible = false;
        }

        #region Connection

        private void databaseToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.userControlQueryList.QueryConditionVisiblity.Length > 0)
                    DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.QueryConditionVisibility = this.userControlQueryList.QueryConditionVisiblity;
                DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();

                DiversityWorkbench.Forms.FormConnectToDatabase f = new DiversityWorkbench.Forms.FormConnectToDatabase();
                f.setHelpProviderNameSpace(System.Windows.Forms.Application.StartupPath + "\\DiversityCollection.chm", "Login");
                f.StartPosition = FormStartPosition.CenterParent;
                f.ShowDialog();
                if (f.DialogResult == DialogResult.OK)
                {
                    this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                    if (!this.setDatabase())
                        this.userControlQueryList.QueryTable.Clear();
                    this.initQuery();
                }
                else
                {
                    this.userControlQueryList.QueryTable.Clear();
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void moduleConnectionsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.FormConnectionAdministration f = new DiversityWorkbench.FormConnectionAdministration(System.Windows.Forms.Application.StartupPath + "\\DiversityCollection.chm");
            f.ShowDialog();
        }

        private void timeoutForDatabaseToolStripMenuItem_Click(object sender, EventArgs e)
        {
            int Timeout = DiversityWorkbench.Settings.TimeoutDatabase; 
            DiversityWorkbench.FormGetInteger f = new DiversityWorkbench.FormGetInteger(Timeout, "Timeout", "Please enter the timeout for database queries in seconds");
            f.ShowDialog();
            if (f.DialogResult == System.Windows.Forms.DialogResult.OK && f.Integer != null)
            {
                DiversityWorkbench.Settings.TimeoutDatabase = (int)f.Integer;
                timeoutForDatabaseToolStripMenuItem.ToolTipText = DiversityWorkbench.Settings.TimeoutDatabase.ToString() + " sec.";
            }
        }

        private void quitToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.Close();
        }

        /// <summary>
        /// transfer the settings as stored in the modul and Workbench settings files from the old to the new version
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void transferSettingsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                DiversityWorkbench.Settings.TransferPreviousSettings();
                try
                {
                    this.setDatabase();
                }
                catch { }

                try
                {
                    DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Upgrade();
                    DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Reload();
                    DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();

                    DiversityCollection.Forms.FormCollectionSpecimenGridModeSettings.Default.Upgrade();
                    DiversityCollection.Forms.FormCollectionSpecimenGridModeSettings.Default.Reload();
                    DiversityCollection.Forms.FormCollectionSpecimenGridModeSettings.Default.Save();

                    DiversityCollection.Forms.FormIdentificationUnitGridModeSettings.Default.Upgrade();
                    DiversityCollection.Forms.FormIdentificationUnitGridModeSettings.Default.Reload();
                    DiversityCollection.Forms.FormIdentificationUnitGridModeSettings.Default.Save();

                    DiversityCollection.Forms.FormMaintenanceSettings.Default.Upgrade();
                    DiversityCollection.Forms.FormMaintenanceSettings.Default.Reload();
                    DiversityCollection.Forms.FormMaintenanceSettings.Default.Save();

                    DiversityCollection.Forms.FormPartGridSettings.Default.Upgrade();
                    DiversityCollection.Forms.FormPartGridSettings.Default.Reload();
                    DiversityCollection.Forms.FormPartGridSettings.Default.Save();

                    DiversityCollection.Forms.FormReplicationSettings.Default.Upgrade();
                    DiversityCollection.Forms.FormReplicationSettings.Default.Reload();
                    DiversityCollection.Forms.FormReplicationSettings.Default.Save();

                    DiversityCollection.Forms.FormTransactionSettings.Default.Upgrade();
                    DiversityCollection.Forms.FormTransactionSettings.Default.Reload();
                    DiversityCollection.Forms.FormTransactionSettings.Default.Save();

                    DiversityCollection.Forms.FormXmlExportSettings.Default.Upgrade();
                    DiversityCollection.Forms.FormXmlExportSettings.Default.Reload();
                    DiversityCollection.Forms.FormXmlExportSettings.Default.Save();

                    DiversityCollection.Forms.FormImportImagesSettings.Default.Upgrade();
                    DiversityCollection.Forms.FormImportImagesSettings.Default.Reload();
                    DiversityCollection.Forms.FormImportImagesSettings.Default.Save();

                }
                catch (System.Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }

                this.setSearchOptions();

                return;

                #region Old version

                string Setting = "";
                try
                {
                    Setting = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.GetPreviousVersion("CustomSetting").ToString();
                    if (Setting.Length > 0)
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.CustomSetting = Setting;
                }
                catch { }

                try
                {
                    int Distance = 333;
                    if (int.TryParse(DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.GetPreviousVersion("SplitContainerData_SplitterDistance").ToString(), out Distance))
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.SplitContainerData_SplitterDistance = Distance;
                }
                catch { }

                try
                {
                    Setting = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.GetPreviousVersion("QueryConditionVisibility").ToString();
                    if (Setting.Length > 0)
                    {
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.QueryConditionVisibility = Setting;
                    }
                    else if (this.userControlQueryList.QueryConditionVisiblity.Length > 0 &&
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.QueryConditionVisibility.Length == 0)
                    {
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.QueryConditionVisibility = this.userControlQueryList.QueryConditionVisiblity;
                    }
                }
                catch { }

                try
                {
                    Setting = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.GetPreviousVersion("ImageDisplay").ToString();
                    if (Setting.Length > 0)
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.ImageDisplay = Setting;
                }
                catch { }

                try
                {
                    Setting = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.GetPreviousVersion("ExportFields").ToString();
                    if (Setting.Length > 0)
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.ExportFields = Setting;
                }
                catch { }

                try
                {
                    Setting = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.GetPreviousVersion("LocalisationSystems").ToString();
                    if (Setting.Length > 0)
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.LocalisationSystems = Setting;
                }
                catch { }

                try
                {
                    Setting = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.GetPreviousVersion("CollectionSiteProperties").ToString();
                    if (Setting.Length > 0)
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.CollectionSiteProperties = Setting;
                }
                catch { }

                try
                {
                    Setting = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.GetPreviousVersion("TaxonomicGroups").ToString();
                    if (Setting.Length > 0)
                    {
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.TaxonomicGroups = Setting;
                        //this.setToolStripDropDownButtonOverviewHierarchyNewUnit();
                        this.setToolStripDropDownButtonOverviewHierarchyNewUnitWithAdaptiveHierarchy();
                    }
                    DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();
                }
                catch { }

                try
                {
                    Setting = DiversityCollection.Forms.FormImportImagesSettings.Default.GetPreviousVersion("FolderOriginal").ToString();
                    if (Setting.Length > 0)
                        DiversityCollection.Forms.FormImportImagesSettings.Default.FolderOriginal = Setting;
                }
                catch { }

                try
                {
                    Setting = DiversityCollection.Forms.FormImportImagesSettings.Default.GetPreviousVersion("WebFolder").ToString();
                    if (Setting.Length > 0)
                        DiversityCollection.Forms.FormImportImagesSettings.Default.WebFolder = Setting;
                    DiversityCollection.Forms.FormImportImagesSettings.Default.Save();
                }
                catch { }
                DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();
            }
            catch { }
            
                #endregion
        }

        #endregion

        #region Grid

        #region Grids

        private void gridToolStripMenuItem_Click(object sender, EventArgs e)
        {
        }

        private void specimensToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (DiversityWorkbench.Settings.ConnectionString.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please connect to a database");
                return;
            }
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            this.labelHeaderID.Focus();
            bool CanUpdate = this.FormFunctions.getObjectPermissions("CollectionSpecimen", "UPDATE");
            if (CanUpdate)
                this.updateSpecimen();
            int SpecimenID = this.SpecimenID;
            System.Collections.Generic.List<int> IDs = this.userControlQueryList.ListOfIDs;
            DiversityCollection.FormCollectionSpecimenGridMode f = new FormCollectionSpecimenGridMode(IDs, this.Text, this.userControlQueryList.ProjectID);
            f.Width = this.Width - 10;
            f.Height = this.Height - 10;
            f.setHelp("Grid specimen");
            if (CanUpdate)
                this.userControlQueryList.listBoxQueryResult.SelectedIndex = -1;
            f.ShowDialog();
            if (CanUpdate)
            {
                if (f.DialogResult == DialogResult.OK)
                    this.setSpecimen(f.SpecimenID);
                else this.setSpecimen(SpecimenID);
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void imageGridToolStripMenuItem_Click(object sender, EventArgs e)
        {
            //System.Windows.Forms.MessageBox.Show("Available in upcoming version");
            //return;
            if (DiversityWorkbench.Settings.ConnectionString.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please connect to a database");
                return;
            }
            System.Collections.Generic.List<int> IDs = this.userControlQueryList.ListOfIDs;
            if (IDs.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("No datasets have been selected");
                return;
            }
            //if (!this.userControlQueryList.ProjectIsSelected)
            //{
            //    System.Windows.Forms.MessageBox.Show("Only possible for datasets of one project");
            //    return;
            //}
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            this.labelHeaderID.Focus();
            bool CanUpdate = this.FormFunctions.getObjectPermissions("CollectionSpecimen", "UPDATE");
            if (CanUpdate)
                this.updateSpecimen();
            int SpecimenID = this.SpecimenID;
            DiversityCollection.Forms.FormImageGrid f = new DiversityCollection.Forms.FormImageGrid(IDs, this.userControlQueryList.ProjectID);
            f.Width = this.Width - 10;
            f.Height = this.Height - 10;
            if (CanUpdate)
                this.userControlQueryList.listBoxQueryResult.SelectedIndex = -1;
            f.setHelp("Images");
            f.ShowDialog();
            if (CanUpdate)
            {
                if (f.DialogResult == DialogResult.OK && f.CollectionSpecimenID != null)
                    this.setSpecimen((int)f.CollectionSpecimenID);
                else this.setSpecimen(SpecimenID);
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void organismstoolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (DiversityWorkbench.Settings.ConnectionString.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please connect to a database");
                return;
            }
            System.Collections.Generic.List<int> IDs = this.userControlQueryList.ListOfIDs;
            if (IDs.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("No datasets have been selected");
                return;
            }
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            this.labelHeaderID.Focus();
            bool CanUpdate = this.FormFunctions.getObjectPermissions("CollectionSpecimen", "UPDATE");
            if (CanUpdate)
                this.updateSpecimen();
            int SpecimenID = this.SpecimenID;
            DiversityCollection.FormIdentificationUnitGridMode f = new FormIdentificationUnitGridMode(IDs, this.Text, this.userControlQueryList.ProjectID);
            f.Width = this.Width - 10;
            f.Height = this.Height - 10;
            DiversityWorkbench.FormFunctions.SetHelp(this.helpProviderDiversityCollection, f, "Grid organism");
            if (CanUpdate)
                this.userControlQueryList.listBoxQueryResult.SelectedIndex = -1;
            f.ShowDialog();
            if (CanUpdate)
            {
                if (f.DialogResult == DialogResult.OK && f.CollectionSpecimenID != null)
                    this.setSpecimen((int)f.CollectionSpecimenID);
                else this.setSpecimen(SpecimenID);
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void PartGridtoolStripMenuItem_Click(object sender, EventArgs e)
        {
            //System.Windows.Forms.MessageBox.Show("Available in upcoming version");
            //return;

            if (DiversityWorkbench.Settings.ConnectionString.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please connect to a database");
                return;
            }
            System.Collections.Generic.List<int> IDs = this.userControlQueryList.ListOfIDs;
            if (IDs.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("No datasets have been selected");
                return;
            }
            if (!this.userControlQueryList.ProjectIsSelected)
            {
                System.Windows.Forms.MessageBox.Show("Please select a project");
                return;
            }
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            this.labelHeaderID.Focus();
            bool CanUpdate = this.FormFunctions.getObjectPermissions("CollectionSpecimen", "UPDATE");
            if (CanUpdate)
                this.updateSpecimen();
            int SpecimenID = this.SpecimenID;
            DiversityCollection.Forms.FormPartGrid f = new DiversityCollection.Forms.FormPartGrid(IDs, this.Text, this.userControlQueryList.ProjectID);
            f.Width = this.Width - 10;
            f.Height = this.Height - 10;
            f.StartPosition = FormStartPosition.CenterParent;
            if (CanUpdate)
                this.userControlQueryList.listBoxQueryResult.SelectedIndex = -1;
            f.setHelp("Grid parts");
            f.ShowDialog();
            if (CanUpdate)
            {
                if (f.DialogResult == DialogResult.OK && f.CollectionSpecimenID != null)
                    this.setSpecimen((int)f.CollectionSpecimenID);
                else this.setSpecimen(SpecimenID);
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void eventSeriesGridtoolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (DiversityWorkbench.Settings.ConnectionString.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please connect to a database");
                return;
            }
            System.Collections.Generic.List<int> IDs = this.userControlQueryList.ListOfIDs;
            if (IDs.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("No datasets have been selected");
                return;
            }
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            this.labelHeaderID.Focus();
            bool CanUpdate = this.FormFunctions.getObjectPermissions("CollectionSpecimen", "UPDATE");
            if (CanUpdate)
                this.updateSpecimen();
            int SpecimenID = this.SpecimenID;
            try
            {
                DiversityCollection.Forms.FormCollectionEventSeriesGridMode f = new DiversityCollection.Forms.FormCollectionEventSeriesGridMode(this.userControlQueryList.ListOfIDs, this.userControlQueryList.ProjectID);
                f.Width = this.Width - 10;
                f.Height = this.Height - 10;
                f.setHelp("Grid event series");
                if (!f.IsDisposed)
                {
                    f.ShowDialog();
                    if (f.DialogResult == DialogResult.OK && f.CollectionSpecimenID != null && CanUpdate)
                        this.setSpecimen((int)f.CollectionSpecimenID);
                }
            }
            catch (System.Exception ex) { }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void EventGridToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (DiversityWorkbench.Settings.ConnectionString.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please connect to a database");
                return;
            }
            System.Collections.Generic.List<int> IDs = this.userControlQueryList.ListOfIDs;
            if (IDs.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("No datasets have been selected");
                return;
            }
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            this.labelHeaderID.Focus();
            bool CanUpdate = this.FormFunctions.getObjectPermissions("CollectionSpecimen", "UPDATE");
            if (CanUpdate)
                this.updateSpecimen();
            int SpecimenID = this.SpecimenID;
            DiversityCollection.Forms.FormCollectionEventGridMode f = new DiversityCollection.Forms.FormCollectionEventGridMode(this.userControlQueryList.ListOfIDs, "", this.userControlQueryList.ProjectID);
            f.Width = this.Width - 10;
            f.Height = this.Height - 10;
            f.setHelp("Grid collection event");
            if (CanUpdate)
                this.userControlQueryList.listBoxQueryResult.SelectedIndex = -1;
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK && f.CollectionSpecimenID != null && CanUpdate)
                this.setSpecimen((int)f.CollectionSpecimenID);
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        #endregion

        #region Table editors

        private void setTableEditorMenu()
        {
            try
            {
                if (DiversityWorkbench.Settings.ConnectionString.Length > 0)
                {
                    bool Any = false;
                    bool OK;
                    string TableName = "";

                    // CollectionEventSeries
                    TableName = "CollectionEventSeries";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.eventSeriesTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollectionEvent
                    TableName = "CollectionEvent";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.eventTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollectionEventLocalisation
                    TableName = "CollectionEventLocalisation";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.localisationTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollectionEventProperty
                    TableName = "CollectionEventProperty";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.siteTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollectionEventMethod
                    TableName = "CollectionEventMethod";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.eventMethodTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollectionEventParameterValue
                    TableName = "CollectionEventParameterValue";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.eventParameterTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // IdentificationUnitAnalysis
                    TableName = "IdentificationUnitAnalysis";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.analysisTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // IdentificationUnitAnalysisMethod
                    TableName = "IdentificationUnitAnalysisMethod";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.analysisMethodTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // IdentificationUnitAnalysisMethodParameter
                    TableName = "IdentificationUnitAnalysisMethodParameter";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.analysisParameterTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // IdentificationUnitGeoAnalysis
                    TableName = "IdentificationUnitGeoAnalysis";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.geoAnalysisTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // IdentificationUnit
                    TableName = "IdentificationUnit";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.organismTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // Identification
                    TableName = "Identification";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.identificationTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollectionSpecimen
                    TableName = "CollectionSpecimen";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.specimenTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollectionAgent
                    TableName = "CollectionAgent";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.collectorTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollectionSpecimenImage
                    TableName = "CollectionSpecimenImage";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.imageTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollectionSpecimenPart
                    TableName = "CollectionSpecimenPart";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.partTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollectionSpecimenReference
                    TableName = "CollectionSpecimenReference";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.referenceTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollectionSpecimenRelation
                    TableName = "CollectionSpecimenRelation";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.relationTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollectionSpecimenProcessing
                    TableName = "CollectionSpecimenProcessing";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.processingTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollectionSpecimenProcessingMethod
                    TableName = "CollectionSpecimenProcessingMethod";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.processingMethodTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollectionSpecimenProcessingMethodParameter
                    TableName = "CollectionSpecimenProcessingMethodParameter";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.processingParameterTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // Transaction
                    TableName = "Transaction";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.transactionTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // ExternalIdentifier 
                    TableName = "ExternalIdentifier";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.identifierTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // Annotation 
                    TableName = "Annotation";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.annotationTableToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    this.tableEditorToolStripMenuItem.Visible = Any;
                }
                else
                {
                    this.tableEditorToolStripMenuItem.Visible = false;

                    this.collectorTableToolStripMenuItem.Visible = false;
                    this.imageTableToolStripMenuItem.Visible = false;
                    this.specimenTableToolStripMenuItem.Visible = false;
                    this.identificationTableToolStripMenuItem.Visible = false;
                    this.organismTableToolStripMenuItem.Visible = false;
                    this.partTableToolStripMenuItem.Visible = false;
                    this.analysisTableToolStripMenuItem.Visible = false;
                    this.processingTableToolStripMenuItem.Visible = false;
                }
            }
            catch (Exception ex)
            {
                this.tableEditorToolStripMenuItem.Visible = false;
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void eventSeriesTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("CollectionEventSeries", DiversityCollection.Resource.Event);
        }

        private void eventMethodTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("CollectionEventMethod", DiversityCollection.Resource.Event);
        }

        private void eventParameterTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("CollectionEventParameterValue", DiversityCollection.Resource.Event);
        }

        private void relationTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("CollectionSpecimenRelation", DiversityCollection.Resource.Event);
        }

        private void eventTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("CollectionEvent", DiversityCollection.Resource.Event);
        }

        private void localisationTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("CollectionEventLocalisation", DiversityCollection.Resource.Localisation);
        }

        private void siteTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("CollectionEventProperty", DiversityCollection.Resource.EventProperty);
        }

        private void organismTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("IdentificationUnit", DiversityCollection.Resource.Plant);
        }

        private void identificationTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("Identification", DiversityCollection.Resource.Identification);
        }

        private void collectorTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("CollectionAgent", DiversityCollection.Resource.Agent);
        }

        private void partTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("CollectionSpecimenPart", DiversityCollection.Resource.Specimen);
        }

        private void specimenTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("CollectionSpecimen", DiversityCollection.Resource.CollectionSpecimen);
        }

        private void imageTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("CollectionSpecimenImage", DiversityCollection.Resource.Icones);
        }

        private void analysisTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("IdentificationUnitAnalysis", DiversityCollection.Resource.Analysis);
        }

        private void analysisMethodTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("IdentificationUnitAnalysisMethod", DiversityCollection.Resource.Tools);
        }

        private void analysisParameterTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("IdentificationUnitAnalysisMethodParameter", DiversityCollection.Resource.Parameter);
        }

        private void geoAnalysisTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("IdentificationUnitGeoAnalysis", DiversityCollection.Resource.Parameter);
        }

        private void processingTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("CollectionSpecimenProcessing", DiversityCollection.Resource.Processing);
        }

        private void processingMethodTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("CollectionSpecimenProcessingMethod", DiversityCollection.Resource.Processing);
        }

        private void processingParameterTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("CollectionSpecimenProcessingMethodParameter", DiversityCollection.Resource.Processing);
        }

        private void referenceTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("CollectionSpecimenReference", DiversityCollection.Resource.References);
        }

        private void transactionTableToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditing("Transaction", DiversityCollection.Resource.Transaction);
        }

        #region ExternalIdentifier

        private void eventIdentifierToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditingForReferencingTable("ExternalIdentifier", DiversityCollection.Resource.Identifier, "CollectionEvent", DiversityCollection.Resource.Event);
        }

        private void specimenIdentifierToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditingForReferencingTable("ExternalIdentifier", DiversityCollection.Resource.Identifier, "CollectionSpecimen", DiversityCollection.Resource.CollectionSpecimen);
        }

        private void organismIdentifierToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditingForReferencingTable("ExternalIdentifier", DiversityCollection.Resource.Identifier, "IdentificationUnit", DiversityCollection.Resource.Plant);
        }

        private void partIdentifierToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditingForReferencingTable("ExternalIdentifier", DiversityCollection.Resource.Identifier, "CollectionSpecimenPart", DiversityCollection.Resource.Specimen);
        }


        #endregion

        #region Annotation

        private void eventAnnotationsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditingForReferencingTable("Annotation", DiversityCollection.Resource.Note1, "CollectionEvent", DiversityCollection.Resource.Event);
            //this.TableEditingForAnnotation("CollectionEvent", DiversityCollection.Resource.Event);
        }

        private void specimenAnnotationsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditingForReferencingTable("Annotation", DiversityCollection.Resource.Note1, "CollectionSpecimen", DiversityCollection.Resource.CollectionSpecimen);
            //this.TableEditingForAnnotation("CollectionSpecimen", DiversityCollection.Resource.CollectionSpecimen);
        }

        private void organismAnnotationsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditingForReferencingTable("Annotation", DiversityCollection.Resource.Note1, "IdentificationUnit", DiversityCollection.Resource.Plant);
            //this.TableEditingForAnnotation("IdentificationUnit", DiversityCollection.Resource.Plant);
        }

        private void partAnnotationsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.TableEditingForReferencingTable("Annotation", DiversityCollection.Resource.Note1, "CollectionSpecimenPart", DiversityCollection.Resource.Specimen);
            //this.TableEditingForAnnotation("CollectionSpecimenPart", DiversityCollection.Resource.Specimen);
        }
        
        #endregion

        private void setTimeoutToolStripMenuItem_Click(object sender, EventArgs e)
        {
            int TimeOut = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout;
            DiversityWorkbench.FormGetInteger f = new DiversityWorkbench.FormGetInteger(TimeOut, "Timeout", "Please enter the seconds to wait for the result of a query");
            f.ShowDialog();
            if (f.DialogResult == System.Windows.Forms.DialogResult.OK && f.Integer != null)
            {
                DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout = (int)f.Integer;
                DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();
            }
        }

        private void TableEditing(string Table, System.Drawing.Image Icon)
        {
            try
            {
                if (this.userControlQueryList.OptimizingIsUsed())
                {
                    this.TableEditingForOptimizing(Table, Icon);
                }
                else
                {
                    this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                    if (this.userControlQueryList.ListOfIDs.Count == 0)
                    {
                        System.Windows.Forms.MessageBox.Show("Nothing selected");
                        this.Cursor = System.Windows.Forms.Cursors.Default;
                        return;
                    }
                    System.Collections.Generic.List<string> ReadOnlyColumns = new List<string>();
                    string SqlCol = "SELECT C.COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS C WHERE C.TABLE_NAME = '" + Table + "'";
                    System.Data.DataTable dt = new DataTable();
                    System.Data.SqlClient.SqlDataAdapter adCol = new System.Data.SqlClient.SqlDataAdapter(SqlCol, DiversityWorkbench.Settings.ConnectionString);
                    adCol.Fill(dt);
                    foreach (System.Data.DataRow R in dt.Rows)
                    {
                        if (R[0].ToString().EndsWith("ID") || R[0].ToString().StartsWith("Log"))
                            ReadOnlyColumns.Add(R[0].ToString());
                    }

                    string IDs = "";
                    foreach (int i in this.userControlQueryList.ListOfIDs)
                    {
                        if (IDs.Length > 0) IDs += ",";
                        IDs += i.ToString();
                    }
                    string SQL = "SELECT * FROM " + Table + " T WHERE T.CollectionSpecimenID IN (" + IDs + ")";
                    if (Table.StartsWith("CollectionEventSeries"))
                    {
                        string SqlIDs = "SELECT DISTINCT E.SeriesID FROM CollectionEvent E, CollectionSpecimen T WHERE E.CollectionEventID = T.CollectionEventID AND T.CollectionSpecimenID IN (" + IDs + ") ";
                        System.Data.DataTable _DtIDs = new DataTable();
                        System.Data.SqlClient.SqlDataAdapter adIDs = new System.Data.SqlClient.SqlDataAdapter(SqlIDs, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout * 1000));
                        adIDs.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout * 1000;
                        adIDs.Fill(_DtIDs);
                        IDs = "";
                        foreach (System.Data.DataRow R in _DtIDs.Rows)
                        {
                            if (IDs.Length > 0) IDs += ",";
                            IDs += R[0].ToString();
                        }
                        if (IDs.Length == 0)
                        {
                            System.Windows.Forms.MessageBox.Show("Nothing selected");
                            this.Cursor = System.Windows.Forms.Cursors.Default;
                            return;
                        }
                        SQL = "SELECT * FROM " + Table + " T WHERE T.SeriesID IN (" + IDs + ")";
                    }
                    else if (Table.StartsWith("CollectionEvent"))
                    {
                        string SqlIDs = "SELECT DISTINCT CollectionEventID FROM CollectionSpecimen T WHERE T.CollectionSpecimenID IN (" + IDs + ") AND NOT CollectionEventID IS NULL ";
                        System.Data.DataTable _DtIDs = new DataTable();
                        //System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout * 1000));
                        System.Data.SqlClient.SqlDataAdapter adIDs = new System.Data.SqlClient.SqlDataAdapter(SqlIDs, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout * 1000));
                        adIDs.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout * 1000;
                        //con.Open();
                        adIDs.Fill(_DtIDs);
                        //con.Close();
                        IDs = "";
                        foreach (System.Data.DataRow R in _DtIDs.Rows)
                        {
                            if (IDs.Length > 0) IDs += ",";
                            IDs += R[0].ToString();
                        }
                        if (IDs.Length == 0)
                        {
                            System.Windows.Forms.MessageBox.Show("Nothing selected");
                            this.Cursor = System.Windows.Forms.Cursors.Default;
                            return;
                        }
                        SQL = "SELECT * FROM " + Table + " T WHERE T.CollectionEventID IN (" + IDs + ")";
                    }
                    else if (Table == "Transaction")
                    {
                        string SqlIDs = "SELECT DISTINCT TransactionID FROM CollectionSpecimenTransaction T WHERE T.CollectionSpecimenID IN (" + IDs + ")";
                        System.Data.DataTable _DtIDs = new DataTable();
                        System.Data.SqlClient.SqlDataAdapter adIDs = new System.Data.SqlClient.SqlDataAdapter(SqlIDs, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout * 1000));
                        adIDs.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout * 1000;
                        adIDs.Fill(_DtIDs);
                        IDs = "";
                        foreach (System.Data.DataRow R in _DtIDs.Rows)
                        {
                            if (IDs.Length > 0) IDs += ",";
                            IDs += R[0].ToString();
                        }
                        if (IDs.Length == 0)
                        {
                            System.Windows.Forms.MessageBox.Show("Nothing selected");
                            this.Cursor = System.Windows.Forms.Cursors.Default;
                            return;
                        }
                        SQL = "SELECT * FROM [" + Table + "] T WHERE T.TransactionID IN (" + IDs + ")";
                    }
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout * 1000));
                    ad.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout * 1000;
                    DiversityWorkbench.Forms.FormTableEditor f = new DiversityWorkbench.Forms.FormTableEditor(Icon, ad, ReadOnlyColumns, DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout);
                    f.StartPosition = FormStartPosition.CenterParent;
                    f.Width = this.Width - 10;
                    f.Height = this.Height - 10;
                    f.setHelpProvider(this.HelpProvider.HelpNamespace, "Table editor");
                    bool SetTimeout = false;
                    try
                    {
                        f.ShowDialog();
                        this.setSpecimen(this.ID);
                    }
                    catch (System.Exception ex)
                    {
                        SetTimeout = true;
                    }
                    if (SetTimeout)
                    {
                        int? Timeout = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout;
                        DiversityWorkbench.FormGetInteger ftimeout = new DiversityWorkbench.FormGetInteger(Timeout, "Set timeout", "A timeout occured. Please set the seconds you are prepared to wait");
                        ftimeout.ShowDialog();
                        if (ftimeout.DialogResult == System.Windows.Forms.DialogResult.OK && ftimeout.Integer != null)
                        {
                            DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout = (int)ftimeout.Integer;
                            DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex, "TableEditing(string Table, System.Drawing.Image Icon)");
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void TableEditingForOptimizing(string Table, System.Drawing.Image Icon)
        {
            if (this.userControlQueryList.OptimizingIsUsed())
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                if (this.userControlQueryList.ListOfIDs.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Nothing selected");
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                    return;
                }
                System.Collections.Generic.List<string> ReadOnlyColumns = this.TableEditingReadOnlyColumns(Table);

                string SQL = "SELECT T.* FROM [" + Table + "] T WHERE T.CollectionSpecimenID IN (SELECT ID FROM #ID)";
                if (Table.StartsWith("CollectionEventSeries"))
                {
                    SQL = "SELECT T.* FROM [" + Table + "] T WHERE T.SeriesID IN (SELECT E.SeriesID FROM CollectionEvent E, CollectionSpecimen S, #ID I " +
                        "WHERE E.CollectionEventID = S.CollectionEventID AND S.CollectionSpecimenID = I.ID )";
                }
                else if (Table.StartsWith("CollectionEvent"))
                {
                    SQL = "SELECT T.* FROM [" + Table + "] T WHERE T.CollectionEventID IN (SELECT S.CollectionEventID FROM CollectionSpecimen S, #ID I " +
                        "WHERE S.CollectionSpecimenID = I.ID) ";
                }
                else if (Table.StartsWith("Transaction"))
                {
                    SQL = "SELECT T.* FROM [" + Table + "] T WHERE T.TransactionID IN (SELECT S.TransactionID FROM CollectionSpecimenTransaction S, #ID I " +
                        "WHERE S.CollectionSpecimenID = I.ID )";
                }
                System.Data.SqlClient.SqlDataAdapter ad = this.userControlQueryList.DataAdapterForTempIDs(SQL); 
                DiversityWorkbench.Forms.FormTableEditor f = new DiversityWorkbench.Forms.FormTableEditor(Icon, ad, Table, "T", ReadOnlyColumns, this.TableEditingLookupValues(Table));
                f.StartPosition = FormStartPosition.CenterParent;
                f.Width = this.Width - 10;
                f.Height = this.Height - 10;
                f.setHelpProvider(this.HelpProvider.HelpNamespace, "Table editor");
                bool SetTimeout = false;
                try
                {
                    f.ShowDialog();
                    this.setSpecimen(this.ID);
                }
                catch (System.Exception ex)
                {
                    SetTimeout = true;
                }
                if (SetTimeout)
                {
                    int? Timeout = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout;
                    DiversityWorkbench.FormGetInteger ftimeout = new DiversityWorkbench.FormGetInteger(Timeout, "Set timeout", "A timeout occured. Please set the seconds you are prepared to wait");
                    ftimeout.ShowDialog();
                    if (ftimeout.DialogResult == System.Windows.Forms.DialogResult.OK && ftimeout.Integer != null)
                    {
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout = (int)ftimeout.Integer;
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();
                    }
                }
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
        }

        private void TableEditingForReferencingTable(string ReferencingTable, System.Drawing.Image ReferencingTableIcon, string Table, System.Drawing.Image Icon)
        {
            try
            {
                if (!this.userControlQueryList.OptimizingIsUsed())
                    System.Windows.Forms.MessageBox.Show("Only for optimized query");
                else
                {
                    this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                    if (this.userControlQueryList.ListOfIDs.Count == 0)
                    {
                        System.Windows.Forms.MessageBox.Show("Nothing selected");
                        this.Cursor = System.Windows.Forms.Cursors.Default;
                        return;
                    }
                    System.Collections.Generic.List<string> ReadOnlyColumns = this.TableEditingReadOnlyColumns(ReferencingTable);
                    ReadOnlyColumns.Add("ReferencedTable");

                    string SQL = "SELECT T.* FROM [" + ReferencingTable + "] T WHERE T.ReferencedTable = '" + Table + "' ";
                    switch (Table)
                    {
                        case "CollectionEvent":
                            SQL += " AND T.ReferencedID IN (SELECT S.CollectionEventID FROM CollectionSpecimen S, #ID I " +
                            "WHERE S.CollectionSpecimenID = I.ID) ";
                            break;
                        case "CollectionSpecimen":
                            SQL += " AND T.ReferencedID IN (SELECT ID FROM #ID)";
                            break;
                        case "IdentificationUnit":
                            SQL += " AND T.ReferencedID IN (SELECT U.IdentificationUnitID FROM IdentificationUnit U, #ID I " +
                            "WHERE U.CollectionSpecimenID = I.ID) ";
                            break;
                        case "CollectionSpecimenPart":
                            SQL += " AND T.ReferencedID IN (SELECT P.SpecimenPartID FROM CollectionSpecimenPart P, #ID I " +
                            "WHERE P.CollectionSpecimenID = I.ID) ";
                            break;
                    }
                    System.Data.SqlClient.SqlDataAdapter ad = this.userControlQueryList.DataAdapterForTempIDs(SQL);

                    System.Collections.Generic.Dictionary<string, DiversityWorkbench.Forms.FormTableEditor.ComboBoxValues> DD = new Dictionary<string, DiversityWorkbench.Forms.FormTableEditor.ComboBoxValues>();
                    System.Data.DataTable dt = new DataTable();
                    string SqlLookup = "";
                    string ValueColumn = "";
                    string DisplayColumn = "";
                    string TableColumn = "";
                    switch (ReferencingTable)
                    {
                        case "ExternalIdentifier":
                            SqlLookup = "SELECT Type, Type AS DisplayText FROM ExternalIdentifierType ORDER BY Type";
                            ValueColumn = "Type";
                            DisplayColumn = "DisplayText";
                            TableColumn = "Type";
                            break;
                        case "Annotation":
                            SqlLookup = "SELECT Code, DisplayText FROM AnnotationType_Enum WHERE (DisplayEnable = 1) ORDER BY DisplayText";
                            ValueColumn = "Code";
                            DisplayColumn = "DisplayText";
                            TableColumn = "AnnotationType";
                            break;
                    }
                    System.Data.SqlClient.SqlDataAdapter adType = new System.Data.SqlClient.SqlDataAdapter(SqlLookup, DiversityWorkbench.Settings.ConnectionString);
                    adType.Fill(dt);
                    DiversityWorkbench.Forms.FormTableEditor.ComboBoxValues CBV = new DiversityWorkbench.Forms.FormTableEditor.ComboBoxValues(dt, DisplayColumn, ValueColumn);
                    DD.Add(TableColumn, CBV);
                    DiversityWorkbench.Forms.FormTableEditor f = new DiversityWorkbench.Forms.FormTableEditor(ReferencingTableIcon, ad, ReferencingTable, "T", ReadOnlyColumns, DD);

                    f.StartPosition = FormStartPosition.CenterParent;
                    f.Width = this.Width - 10;
                    f.Height = this.Height - 10;
                    f.setHelpProvider(this.HelpProvider.HelpNamespace, "Table editor");
                    bool SetTimeout = false;
                    try
                    {
                        f.ShowDialog();
                    }
                    catch (System.Exception ex)
                    {
                        SetTimeout = true;
                    }
                    if (SetTimeout)
                    {
                        int? Timeout = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout;
                        DiversityWorkbench.FormGetInteger ftimeout = new DiversityWorkbench.FormGetInteger(Timeout, "Set timeout", "A timeout occured. Please set the seconds you are prepared to wait");
                        ftimeout.ShowDialog();
                        if (ftimeout.DialogResult == System.Windows.Forms.DialogResult.OK && ftimeout.Integer != null)
                        {
                            DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Timeout = (int)ftimeout.Integer;
                            DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();
                        }
                    }
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        private System.Collections.Generic.List<string> TableEditingReadOnlyColumns(string Table)
        {
            System.Collections.Generic.List<string> ReadOnlyColumns = new List<string>();
            string SqlCol = "SELECT C.COLUMN_NAME, C.DATA_TYPE FROM INFORMATION_SCHEMA.COLUMNS C WHERE C.TABLE_NAME = '" + Table + "'";
            System.Data.DataTable dt = new DataTable();
            System.Data.SqlClient.SqlDataAdapter adCol = new System.Data.SqlClient.SqlDataAdapter(SqlCol, DiversityWorkbench.Settings.ConnectionString);
            adCol.Fill(dt);

            System.Collections.Generic.List<string> LookUpColumns = new List<string>();
            LookUpColumns.Add("ParameterID");
            LookUpColumns.Add("MethodID");
            LookUpColumns.Add("ProcessingID");
            LookUpColumns.Add("ExternalDatasourceID");
            LookUpColumns.Add("AnalysisID");
            LookUpColumns.Add("CollectionID");
            //LookUpColumns.Add("LocalisationSystemID");
            LookUpColumns.Add("ParentTransactionID");

            foreach (System.Data.DataRow R in dt.Rows)
            {
                if (LookUpColumns.Contains(R[0].ToString()))
                    continue;
                if (R[0].ToString().EndsWith("ID") 
                    || R[0].ToString().StartsWith("Log") 
                    || R[1].ToString() == "uniqueidentifier"
                    || R[1].ToString() == "geography"
                    || R[1].ToString() == "geometry")
                    ReadOnlyColumns.Add(R[0].ToString());
            }
            return ReadOnlyColumns;
        }

        private System.Collections.Generic.Dictionary<string, DiversityWorkbench.Forms.FormTableEditor.ComboBoxValues> TableEditingLookupValues(string TableName)
        {
            System.Collections.Generic.Dictionary<string, DiversityWorkbench.Forms.FormTableEditor.ComboBoxValues> DD = new Dictionary<string, DiversityWorkbench.Forms.FormTableEditor.ComboBoxValues>();
            DiversityWorkbench.Data.Table T = new DiversityWorkbench.Data.Table(TableName, DiversityWorkbench.Settings.ConnectionString);
            T.FindColumnsWithForeignRelations();
            foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.Data.Column> C in T.Columns)
            {
                if (C.Value.ForeignRelations.Count == 1
                    && C.Value.ForeignRelationColumn.Length > 0
                    && C.Value.ForeignRelationTable.Length > 0
                    && C.Value.ForeignRelationTable.ToLower().EndsWith("_enum"))
                {
                    System.Data.DataTable dt = new DataTable();
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter("SELECT NULL AS Code, NULL AS DisplayText UNION SELECT Code, DisplayText FROM " + C.Value.ForeignRelationTable + " WHERE DisplayEnable = 1 ORDER BY DisplayText", DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(dt);
                    DiversityWorkbench.Forms.FormTableEditor.ComboBoxValues CBV = new DiversityWorkbench.Forms.FormTableEditor.ComboBoxValues(dt, "DisplayText", "Code");
                    DD.Add(C.Key, CBV);
                }
                else if (C.Value.ForeignRelations.Count > 0)
                {
                    foreach (System.Collections.Generic.KeyValuePair<string, string> KV in C.Value.ForeignRelations)
                    {
                        if (!DD.ContainsKey(C.Key))
                        {
                            System.Data.DataTable dt = new DataTable();
                            string SQL = "";
                            string DisplayColumn = "DisplayText";
                            string ColumnHeader = "";
                            string Union = "SELECT NULL AS " + KV.Value + ", NULL AS DisplayText UNION ";
                            switch (KV.Value)
                            {
                                case "ParameterID":
                                    SQL = Union + "SELECT ParameterID, DisplayText FROM Parameter ORDER BY DisplayText";
                                    ColumnHeader = "Parameter";
                                    break;
                                case "SeriesID":
                                    SQL = Union + "SELECT SeriesID, case when SeriesCode is null or SeriesCode = '' then Description else SeriesCode end AS DisplayText FROM CollectionEventSeries ORDER BY DisplayText";
                                    ColumnHeader = "EventSeries";
                                    break;
                                case "MethodID":
                                    SQL = Union + "SELECT MethodID, DisplayText FROM Method ORDER BY DisplayText";
                                    ColumnHeader = "Method";
                                    break;
                                case "ProjectID":
                                    SQL = Union + "SELECT ProjectID, Project FROM ProjectProxy ORDER BY DisplayText";
                                    ColumnHeader = "Project";
                                    break;
                                case "ProcessingID":
                                    SQL = Union + "SELECT ProcessingID, DisplayText FROM Processing ORDER BY DisplayText";
                                    ColumnHeader = "Processing";
                                    break;
                                case "ExternalDatasourceID":
                                    SQL = Union + "SELECT ExternalDatasourceID, ExternalDatasourceName FROM CollectionExternalDatasource ORDER BY DisplayText";
                                    ColumnHeader = "ExternalDatasource";
                                    break;
                                case "AnalysisID":
                                    SQL = Union + "SELECT AnalysisID, DisplayText FROM Analysis ORDER BY DisplayText";
                                    ColumnHeader = "Analysis";
                                    break;
                                case "CollectionID":
                                    SQL = Union + "SELECT CollectionID, CollectionName AS DisplayText FROM Collection ORDER BY DisplayText";
                                    ColumnHeader = C.Value.Name;
                                    if (ColumnHeader.EndsWith("ID"))
                                        ColumnHeader = ColumnHeader.Substring(0, ColumnHeader.Length - 2);
                                    break;
                                case "PropertyID":
                                    SQL = Union + "SELECT PropertyID, DisplayText FROM Property ORDER BY DisplayText";
                                    ColumnHeader = "Property";
                                    break;
                                case "LocalisationSystemID":
                                    SQL = Union + "SELECT LocalisationSystemID, DisplayText FROM LocalisationSystem ORDER BY DisplayText";
                                    ColumnHeader = "LocalisationSystem";
                                    break;
                                case "TransactionID":
                                    SQL = Union + "SELECT TransactionID, TransactionTitle FROM [Transaction] ORDER BY DisplayText";
                                    ColumnHeader = C.Value.Name;
                                    if (ColumnHeader.EndsWith("ID"))
                                        ColumnHeader = ColumnHeader.Substring(0, ColumnHeader.Length - 2);
                                    break;
                            }
                            if (SQL.Length > 0)
                            {
                                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                                ad.Fill(dt);
                                DiversityWorkbench.Forms.FormTableEditor.ComboBoxValues CBV = new DiversityWorkbench.Forms.FormTableEditor.ComboBoxValues(dt, DisplayColumn, KV.Value, ColumnHeader);
                                DD.Add(C.Key, CBV);
                            }
                        }
                    }
                }
            }
            return DD;
        }

        #endregion

        #region Spreadsheets

        private void setSpreadsheetMenu()
        {
            ///TODO: einblenden wenn OK
            this.wGS84SheetToolStripMenuItem.Visible = false;
#if !DEBUG
#endif
        }

        private void organismSheetToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartSpreadSheet(Spreadsheet.Target.SheetTarget.Organisms);
        }

        private void partSheetToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartSpreadSheet(Spreadsheet.Target.SheetTarget.Parts);
        }

        private void tK25SheetToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartSpreadSheet(Spreadsheet.Target.SheetTarget.TK25);
        }

        private void wGS84SheetToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartSpreadSheet(Spreadsheet.Target.SheetTarget.WGS84);
        }

        private void eventSheetToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartSpreadSheet(Spreadsheet.Target.SheetTarget.Event);
        }

        private void imageSheetToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartSpreadSheet(Spreadsheet.Target.SheetTarget.Image);
        }

        private void mineralSheetToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartSpreadSheet(Spreadsheet.Target.SheetTarget.Minerals);
//#if DEBUG
//#else
//            System.Windows.Forms.MessageBox.Show("Available in upcoming version");
//#endif
        }

        private void analysisSheetToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartSpreadSheet(Spreadsheet.Target.SheetTarget.Analysis);
        }

        private void StartSpreadSheet(Spreadsheet.Target.SheetTarget Target)
        {
            try
            {
                this.Enabled = false;
                string CurrentConnection = DiversityWorkbench.Settings.ConnectionString;
                DiversityWorkbench.Import.FormStartWizard fs = new DiversityWorkbench.Import.FormStartWizard("Starting spreadsheet...", "", DiversityCollection.Resource.SpeadsheetEditor);
                int X = this.Location.X + (int)(this.Width / 2) - (int)(fs.Width / 2);
                int Y = this.Location.Y + (int)(this.Height / 2) - (int)(fs.Height / 2);
                System.Drawing.Point P = new Point(X, Y);
                fs.Location = P;
                fs.StartPosition = FormStartPosition.Manual;//.CenterScreen;

                fs.Show();
                fs.ShowCurrentStep("Getting definitions of the tables");
                Application.DoEvents();

                DiversityWorkbench.Spreadsheet.Sheet Sheet = null;
                switch (Target)
                {
                    case Spreadsheet.Target.SheetTarget.Analysis:
                        Sheet = Spreadsheet.Target.TargetSheet(Spreadsheet.Target.SheetTarget.Analysis);
                        break;
                    case Spreadsheet.Target.SheetTarget.Event:
                        Sheet = Spreadsheet.Target.TargetSheet(Spreadsheet.Target.SheetTarget.Event);
                        break;
                    case Spreadsheet.Target.SheetTarget.Image:
                        Sheet = Spreadsheet.Target.TargetSheet(Spreadsheet.Target.SheetTarget.Image);
                        break;
                    case Spreadsheet.Target.SheetTarget.Organisms:
                        Sheet = Spreadsheet.Target.TargetSheet(Spreadsheet.Target.SheetTarget.Organisms);
                        break;
                    case Spreadsheet.Target.SheetTarget.Parts:
                        Sheet = Spreadsheet.Target.TargetSheet(Spreadsheet.Target.SheetTarget.Parts);
                        break;
                    case Spreadsheet.Target.SheetTarget.Specimen:
                        Sheet = Spreadsheet.Target.TargetSheet(Spreadsheet.Target.SheetTarget.Specimen);
                        break;
                    case Spreadsheet.Target.SheetTarget.TK25:
                        Sheet = Spreadsheet.Target.TargetSheet(Spreadsheet.Target.SheetTarget.TK25);
                        break;
                    case Spreadsheet.Target.SheetTarget.WGS84:
                        Sheet = Spreadsheet.Target.TargetSheet(Spreadsheet.Target.SheetTarget.WGS84);
                        break;
                    case Spreadsheet.Target.SheetTarget.Minerals:
                        Sheet = Spreadsheet.Target.TargetSheet(Spreadsheet.Target.SheetTarget.Minerals);
                        break;
                }
                if (Sheet != null)
                {
                    DiversityCollection.FormCollectionSpecimen fMain = new FormCollectionSpecimen(-1, false, false, ViewMode.SpreadsheetMode, "");
                    Sheet.setInterfaceMainForm(fMain);

                    fs.ShowCurrentStep("Reading settings");
                    Application.DoEvents();
                    DiversityWorkbench.Spreadsheet.FormSpreadsheet f = new DiversityWorkbench.Spreadsheet.FormSpreadsheet(Sheet, this.helpProviderDiversityCollection.HelpNamespace);

                    // setting the image column if present
                    switch (Sheet.Target())
                    {
                        case "Event":
                            if (Sheet.DataTables().ContainsKey("B3_EI"))
                                f.setImageColumn(Sheet.DataTables()["B3_EI"].DataColumns()["URI"]);
                            else if (Sheet.DataTables().ContainsKey("C6_Im"))
                                f.setImageColumn(Sheet.DataTables()["C6_Im"].DataColumns()["URI"]);
                            break;
                        case "Parts":
                            if (Sheet.DataTables().ContainsKey("F8_Im"))
                                f.setImageColumn(Sheet.DataTables()["F8_Im"].DataColumns()["URI"]);
                            break;
                        case "Image":
                            if (Sheet.DataTables().ContainsKey("D0_Im"))
                                f.setImageColumn(Sheet.DataTables()["D0_Im"].DataColumns()["URI"]);
                            break;
                        case "Minerals":
                        case "Organisms":
                            if (Sheet.DataTables().ContainsKey("E6_Im"))
                                f.setImageColumn(Sheet.DataTables()["E6_Im"].DataColumns()["URI"]);
                            break;
                        case "Specimen":
                            if (Sheet.DataTables().ContainsKey("C6_Im"))
                                f.setImageColumn(Sheet.DataTables()["C6_Im"].DataColumns()["URI"]);
                            break;
                    }
                    //if (Sheet.DataTables().ContainsKey("C2_I"))
                    //    f.setImageColumn(Sheet.DataTables()["C2_I"].DataColumns()["URI"]);
                    //else if (Sheet.DataTables().ContainsKey("Z1_I"))
                    //    f.setImageColumn(Sheet.DataTables()["Z1_I"].DataColumns()["URI"]);
                    //else if (Sheet.DataTables().ContainsKey("B3_EI"))
                    //    f.setImageColumn(Sheet.DataTables()["B3_EI"].DataColumns()["URI"]);
                    //else if (Sheet.DataTables().ContainsKey("E3_Im"))
                    //    f.setImageColumn(Sheet.DataTables()["E3_Im"].DataColumns()["URI"]);
                    //else if (Sheet.DataTables().ContainsKey("D2_I"))
                    //    f.setImageColumn(Sheet.DataTables()["D2_I"].DataColumns()["URI"]);

                    if (Spreadsheet.Target.StarterTarget() != null)
                        f.IsStarter = true;
                    else
                    {
                        f.IsStarter = false;
                        f.setSize(this.Width, this.Height);
                        f.setLocation(this.Location.X, this.Location.Y);
                        f.StartPosition = FormStartPosition.Manual;
                    }
                    if (Target == Spreadsheet.Target.SheetTarget.TK25)
                        f.SetMapColumns("Geography", "A2_EL", "IdentificationUnitID", "E0_U");
                    else if (Target == Spreadsheet.Target.SheetTarget.WGS84)
                        f.SetMapColumns("Geography", "A2_EL", "IdentificationUnitID", "E0_U");
                    fs.Close();
                    if (!f.IsDisposed)
                    {
                        f.ShowDialog();
                        if (f.IsStarter)
                        {
                            Spreadsheet.Target.SetStart(Target);
                        }
                        else Spreadsheet.Target.SetStart(null);
                        if (DiversityWorkbench.Settings.ConnectionString != CurrentConnection)
                        {
                            System.Windows.Forms.MessageBox.Show("Connection changed to new database");
                            this.setDatabase();
                        }
                        //DiversityWorkbench.Spreadsheet.Sheet.iStaticMainForm.Close();
                        //DiversityWorkbench.Spreadsheet.Sheet.iStaticMainForm.Dispose();
                        fMain.Close();
                        fMain.Dispose();
                    }
                }
                else
                {
                    fs.Close();
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.Enabled = true;
            }
        }

        //public static DiversityCollection.FormCollectionSpecimen _
        private void CreateSpreadSheetMainForm()
        {
            DiversityCollection.FormCollectionSpecimen fMain = new FormCollectionSpecimen(-1, false, false, ViewMode.SpreadsheetMode, "");
            DiversityWorkbench.Spreadsheet.Sheet.setStaticInterfaceMainForm(fMain);
        }

        public void ShowInMainForm(int ID, bool ShowDialogPanel, bool ShowMenu)
        {
            try
            {
                try { DiversityWorkbench.Settings.ModuleName = "DiversityCollection"; }
                catch { }
                bool OK = true;
                if (DiversityWorkbench.Settings.DatabaseServer != "127.0.0.1")
                    OK = this.setDatabase();
                else
                    this.splitContainerData.Visible = false;
                this.initForm();
                if (ShowMenu)
                    this.initQuery();
                this.setQueryControlEvents();
                this.helpProviderDiversityCollection.HelpNamespace = System.Windows.Forms.Application.StartupPath + "\\DiversityCollection.chm";
                this.userControlImageEventImage.HelpNameSpace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlImageCollectionEventSeries.HelpNameSpace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlImageSpecimenImage.HelpNameSpace = this.helpProviderDiversityCollection.HelpNamespace;
                if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection > -1)
                    this.DefaultCollection = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection;
                this.setLanguage();
                if (DiversityCollection.Properties.Settings.Default.KioskMode)
                    this.setKioskMode();
                this.timerScanning.Interval = DiversityCollection.Forms.FormTransactionSettings.Default.TimerIntervall;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            try
            {
                if (this.Parent != null)
                {
                    this.Width = this.Parent.Width - 20;
                    this.Height = this.Parent.Height - 20;
                }
                this.StartPosition = FormStartPosition.CenterParent;
                this.splitContainerMain.Panel1Collapsed = true;
                this.setSpecimen(ID);
                if (this.textBoxHeaderAccessionNumber.Text.Length == 0)
                    this.Text = "[ID: " + this.ID.ToString() + "]";
                else
                    this.Text = this.textBoxHeaderAccessionNumber.Text;
                this.Text += " - " + this.textBoxHeaderIdentification.Text;
                this.Text = this.Text.Replace("\r\n", " - ");
                this.userControlDialogPanel.Visible = ShowDialogPanel;
                this.menuStripMain.Visible = ShowMenu;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            this._ViewMode = ViewMode.SpreadsheetMode;
            this.Show();
        }
        
        #endregion

        #endregion

        #region Data

        private void setDataMenu()
        {
            ///TODO: reaktivieren sobald fertig
            //this.exportWizardToolStripMenuItem.Visible = false;
            this.cacheDatabaseToolStripMenuItem.Visible = false;
            this.bayernFloraToolStripMenuItem.Visible = false;
            this.toolStripMenuItemFloristicLists.Visible = false;
            this.importABCDToolStripMenuItem.Visible = false;

            bool IsAdmin = false;
            try
            {
                if (DiversityWorkbench.Settings.ConnectionString.Length > 0)
                {
                    // Import
                    string TableName = "CollectionSpecimen";
                    bool OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.importToolStripMenuItem.Visible = OK;
                    this.archiveToolStripMenuItem.Visible = OK;

                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                    //this.importABCDToolStripMenuItem.Visible = OK;
                    //this.importListAddToolStripMenuItem.Visible = OK;
                    this.importListToolStripMenuItem.Visible = OK;
                    this.reimportListToolStripMenuItem.Visible = OK;

                    // Transfer
                    bool ShowTransfer = false;
                    // Project
                    TableName = "CollectionProject";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.transerToProjectToolStripMenuItem.Visible = OK;
                    if (OK) ShowTransfer = OK;
                    // Transaction
                    TableName = "CollectionSpecimenTransaction";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.transferToTransactionToolStripMenuItem.Visible = OK;
                    this.transferTransactionToolStripMenuItem.Visible = OK;
                    if (OK) ShowTransfer = OK;
                    // Collection
                    TableName = "CollectionSpecimenPart";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.toCollectionToolStripMenuItem.Visible = OK;
                    if (OK) ShowTransfer = OK;
                    // Transfer
                    this.transferToolStripMenuItem.Visible = ShowTransfer;

                    // Export
                    //this.exportEventsToolStripMenuItem.Visible = false;

                    // Update
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.saveToolStripMenuItem.Visible = OK;

                    // Removal
                    TableName = "CollectionSpecimen_log";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                    this.removeSpecimenToolStripMenuItem.Visible = OK;

                    // Identifier
                    TableName = "ExternalIdentifier";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.allIdentifierToolStripMenuItem.Visible = OK;

                    // Removal of project
                    TableName = "CollectionProject";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                    this.removeFromProjectToolStripMenuItem.Visible = OK;

                    // Cache DB
                    OK = this.FormFunctions.getObjectPermissions("CacheDatabase2", "SELECT");
                    this.cacheDatabaseToolStripMenuItem1.Visible = OK;

                    // Backup - only for dbo
                    if (DiversityWorkbench.Database.DatabaseRoles().Contains("Administrator")
                        || DiversityWorkbench.Database.DatabaseRoles().Contains("db_owner"))
                        IsAdmin = true;
                    if (DiversityWorkbench.Database.DatabaseRoles().Contains("db_owner"))
                        this.backupDatabasetoolStripMenuItem.Visible = true;
                    else
                        this.backupDatabasetoolStripMenuItem.Visible = false;
                }
            }
            catch (Exception ex)
            {
                this.administrationToolStripMenuItem.Visible = false;
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }

            this.initReplicationMenu(IsAdmin);

        }

        #region Import

        #region Commmon

        private void specimenScansToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (DiversityWorkbench.Settings.ConnectionString.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please connect to the database before importing images");
                return;
            }
            DiversityCollection.FormImportSpecimenScans f = new FormImportSpecimenScans();
            f.ShowDialog();
            DiversityCollection.FormMaintenance.SynchronizeLastIdentificationCache();
        }

        private void importListToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityCollection.FormImportList f = new FormImportList(false, false);
            f.ShowDialog();
        }

        private void importListAddToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityCollection.FormImportList f = new FormImportList(false, true);
            f.ShowDialog();
        }

        private void reimportListToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityCollection.FormImportList f = new FormImportList(true, false);
            f.ShowDialog();
        }

        private void importABCDToolStripMenuItem_Click(object sender, EventArgs e)
        {
            System.Windows.Forms.MessageBox.Show("Function will be available in upcoming version");
        }

        private void importWizardToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            DiversityCollection.FormImportWizard f = new FormImportWizard();
            f.Height = this.Height - 10;
            f.Width = this.Width - 10;
            this.Cursor = System.Windows.Forms.Cursors.Default;
            f.ShowDialog();
        }
        
        #endregion

        #region Wizard

        #region Tool strip events
        
        private void wizardToolStripMenuItem_Click(object sender, EventArgs e)
        {
            //System.Windows.Forms.MessageBox.Show("Available in upcoming version");
            //return;
        }

        private void importSeriesToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartWizard("Series");//, this.ImportStepsSeries());
        }

        private void importEventsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartWizard("Event");//, this.ImportStepsEvent(true));
        }

        private void importSpecimenToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartWizard("Specimen");//, this.ImportStepsSpecimen());
        }

        private void importObservationsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartWizard("Observation");//, this.ImportStepsObservation());
        }

        private void importAnalysisToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartWizard("Analysis");//, this.ImportStepsAnalysis);
        }

        private void importCollectionsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartWizard("Collection");//, this.ImportStepsCollection);
        }

        private void importMethodsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartWizard("Method");//, this.ImportStepsMethod);
        }

        private void importProcessingsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartWizard("Processing");//, this.ImportStepsProcessing);
        }

        private void importTransactionsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.StartWizard("Transaction");//, this.ImportStepsTransaction);
        }

        private void StartWizard(string Target)
        {
            try
            {
                this.Enabled = false;

                // Show start window
                DiversityWorkbench.Import.FormStartWizard fs = new DiversityWorkbench.Import.FormStartWizard();
                fs.StartPosition = FormStartPosition.CenterParent;
                fs.Show();
                Application.DoEvents();

                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                fs.ShowCurrentStep("Resetting the templates for the tables\r\n..........");
                DiversityWorkbench.Import.Import.ResetTemplate();
                System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> ImportSteps = null;
                fs.ShowCurrentStep("Getting the steps for " + Target + "\r\n|.........");
                DiversityWorkbench.Import.Import.DefaultDuplicateCheckColumn = null;
                switch (Target)
                {
                    case "Series":
                        ImportSteps = this.ImportStepsSeries();
                        break;
                    case "Event":
                        ImportSteps = this.ImportStepsEvent(true);
                        break;
                    case "Specimen":
                        ImportSteps = this.ImportStepsSpecimen(fs);
                        break;
                    case "Observation":
                        ImportSteps = this.ImportStepsObservation(fs);
                        break;
                    case "Analysis":
                        ImportSteps = this.ImportStepsAnalysis;
                        break;
                    case "Collection":
                        ImportSteps = this.ImportStepsCollection;
                        break;
                    case "Method":
                        ImportSteps = this.ImportStepsMethod;
                        break;
                    case "Processing":
                        ImportSteps = this.ImportStepsProcessing;
                        break;
                    case "Transaction":
                        ImportSteps = this.ImportStepsTransaction;
                        break;
                }
                if (ImportSteps == null)
                    ImportSteps = new Dictionary<string, DiversityWorkbench.Import.Step>();
                fs.ShowCurrentStep("Import steps for " + Target + " created. Opening import form\r\n||||||||..");
                DiversityWorkbench.Import.FormWizard f = new DiversityWorkbench.Import.FormWizard(Target, DiversityCollection.Properties.Settings.Default.DatabaseVersion, ImportSteps, this.helpProviderDiversityCollection.HelpNamespace, fs);
                f.Height = this.Height - 10;
                f.StartPosition = FormStartPosition.CenterParent;

                fs.Close();

                f.ShowDialog();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.Enabled = true;
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void StartWizard(string Target, System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> ImportSteps)
        {
            try
            {
                this.Enabled = false;
                // Show start window
                DiversityWorkbench.Import.FormStartWizard fs = new DiversityWorkbench.Import.FormStartWizard();
                fs.Show();
                Application.DoEvents();

                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                DiversityWorkbench.Import.Import.ResetTemplate();
                DiversityWorkbench.Import.FormWizard f = new DiversityWorkbench.Import.FormWizard(Target, DiversityCollection.Properties.Settings.Default.DatabaseVersion, ImportSteps, this.helpProviderDiversityCollection.HelpNamespace);
                f.Height = this.Height - 10;

                this.Cursor = System.Windows.Forms.Cursors.Default;
                // Close start window
                fs.Close();

                f.ShowDialog();
            }
            catch (Exception ex)
            {
            }
            finally
            {
                this.Enabled = true;
            }
        }
        
        #endregion

        #endregion

        #endregion

        #region Replication

        private System.Data.DataTable _DtReplicationPublisher;

        private void initReplicationMenu(bool IsAdmin)
        {
            this.addServerToolStripMenuItem.Visible = true;
            this.setServerToolStripMenuItem.Visible = false;
            this.downloadToolStripMenuItem.Visible = false;
            this.uploadToolStripMenuItem.Visible = false;
            this.mergeToolStripMenuItem.Visible = false;
            this.cleanDatabaseToolStripMenuItem.Visible = true;

            this.replicationToolStripMenuItem.DropDownItems.Clear();

            // Test access
            bool OK = this.FormFunctions.getObjectPermissions("ReplicationPublisher", "SELECT");

            if (IsAdmin && OK)
            {
                this.replicationToolStripMenuItem.DropDownItems.Add(this.addServerToolStripMenuItem);
                this.replicationToolStripMenuItem.DropDownItems.Add(this.cleanDatabaseToolStripMenuItem);
            }
            else
            {
                this.addServerToolStripMenuItem.Visible = false;
                this.cleanDatabaseToolStripMenuItem.Visible = false;
                return;
            }

            string SQL = "";
            if (this._DtReplicationPublisher == null)
                this._DtReplicationPublisher = new DataTable();
            else
                this._DtReplicationPublisher.Clear();

            try
            {
                if (DiversityWorkbench.Settings.ConnectionString.Length > 0)
                {
                    if (OK)
                    {
                        // Import
                        SQL = "SELECT DatabaseName, Server, Port FROM ReplicationPublisher";
                        System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                        ad.Fill(this._DtReplicationPublisher);
                        if (this._DtReplicationPublisher.Rows.Count > 0)
                        {
                            foreach (System.Data.DataRow R in this._DtReplicationPublisher.Rows)
                            {
                                string DisplayText = R["DatabaseName"].ToString() + " on " + R["Server"].ToString();
                                System.Windows.Forms.ToolStripMenuItem MI = new ToolStripMenuItem(DisplayText, DiversityCollection.Resource.Synchronize);
                                this.replicationToolStripMenuItem.DropDownItems.Add(MI);

                                System.Windows.Forms.ToolStripMenuItem MiDownload = new ToolStripMenuItem("Download ...", DiversityCollection.Resource.Download, this.downloadToolStripMenuItem_Click);
                                MiDownload.Tag = R;
                                MiDownload.ToolTipText = "Download data from the replication publisher";
                                MI.DropDownItems.Add(MiDownload);

                                System.Windows.Forms.ToolStripMenuItem MiMerge = new ToolStripMenuItem("Merge ...", DiversityCollection.Resource.Merge, this.mergeToolStripMenuItem_Click);
                                MiMerge.Tag = R;
                                MiMerge.ToolTipText = "Merge data for the current project between the replication publisher and your local database";
                                MI.DropDownItems.Add(MiMerge);

                                System.Windows.Forms.ToolStripMenuItem MiUpload = new ToolStripMenuItem("Upload ...", DiversityCollection.Resource.Upload, this.uploadToolStripMenuItem_Click);
                                MiUpload.Tag = R;
                                MiUpload.ToolTipText = "Upload the data of the current project to the replication publisher";
                                MI.DropDownItems.Add(MiUpload);

                                System.Windows.Forms.ToolStripMenuItem MiTools = new ToolStripMenuItem("Tools ...", DiversityCollection.Resource.SystemTools, this.replicationToolsToolStripMenuItem_Click);
                                MiTools.Tag = R;
                                MiTools.ToolTipText = "System tools for the replication subscriber";
                                MI.DropDownItems.Add(MiTools);

                                if (IsAdmin)
                                {
                                    System.Windows.Forms.ToolStripMenuItem MiDelete = new ToolStripMenuItem("Remove", DiversityCollection.Resource.NoDatabase, this.deleteReplicationPublisherToolStripMenuItem_Click);
                                    MiDelete.Tag = R;
                                    MiDelete.ToolTipText = "Remove the replication publisher from the list";
                                    MI.DropDownItems.Add(MiDelete);
                                }
                            }
                            this.replicationToolStripMenuItem.Visible = true;
                            this.addServerToolStripMenuItem.Visible = true;
                            this.setServerToolStripMenuItem.Visible = false;
                            this.downloadToolStripMenuItem.Visible = false;
                            this.uploadToolStripMenuItem.Visible = false;
                            this.mergeToolStripMenuItem.Visible = false;
                            this.cleanDatabaseToolStripMenuItem.Visible = true;
                        }
                        this.replicationToolStripMenuItem.DropDownItems.Add(this.cleanDatabaseToolStripMenuItem);
                    }
                }
            }
            catch (Exception ex)
            {
                this.replicationToolStripMenuItem.Visible = false;
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void addServerToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.ServerConnection SC = new DiversityWorkbench.ServerConnection();
            SC.ModuleName = "DiversityCollection";
            SC.DatabaseServer = DiversityWorkbench.Settings.DatabaseServer;
            SC.DatabaseServerPort = DiversityWorkbench.Settings.DatabasePort;
            SC.IsTrustedConnection = DiversityWorkbench.Settings.IsTrustedConnection;
            SC.DatabaseUser = DiversityWorkbench.Settings.DatabaseUser;
            SC.DatabasePassword = DiversityWorkbench.Settings.Password;
            DiversityWorkbench.Forms.FormConnectToDatabase f = new DiversityWorkbench.Forms.FormConnectToDatabase(SC);
            f.ShowDialog();
            if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
            {
                DiversityWorkbench.ServerConnection ScPulisher = f.ServerConnection;
                if (ScPulisher.DatabaseName == DiversityWorkbench.Settings.DatabaseName
                    && ScPulisher.DatabaseServer == DiversityWorkbench.Settings.DatabaseServer)
                {
                    System.Windows.Forms.MessageBox.Show("You can not add the current database as a publisher to itself");
                    return;
                }
                string SQL = "INSERT INTO ReplicationPublisher " +
                    "(DatabaseName, Server, Port) " +
                    "VALUES ('" + ScPulisher.DatabaseName + "', '" + ScPulisher.DatabaseServer + "', " + ScPulisher.DatabaseServerPort.ToString() + ")";
                try
                {
                    string Message = "";
                    if (DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL, ref Message))
                        this.initReplicationMenu(true);
                    else
                        System.Windows.Forms.MessageBox.Show("Insert failed:\r\n" + Message);
                }
                catch (System.Exception ex)
                {
                }
            }
        }

        private void replicationToolStripMenuItem_Click(object sender, EventArgs e)
        {
            //System.Windows.Forms.MessageBox.Show("Available in upcoming version");
            //return;

            //DiversityCollection.Forms.FormReplication f = new DiversityCollection.Forms.FormReplication(DiversityCollection.Forms.FormReplication.ReplicationDirection.Upload, this.;
            //f.ShowDialog();
        }

        private void downloadToolStripMenuItem_Click(object sender, EventArgs e)
        {
            //System.Windows.Forms.MessageBox.Show("Available in upcoming version");
            //return;
            System.Windows.Forms.ToolStripMenuItem T = (System.Windows.Forms.ToolStripMenuItem)sender;
            System.Data.DataRow R = (System.Data.DataRow)T.Tag;
            try
            {
                DiversityCollection.Forms.FormReplication f = new DiversityCollection.Forms.FormReplication(DiversityWorkbench.UserControls.UserControlReplicateTable.ReplicationDirection.Download, null, this.ReplicationPublisherConnectionString(R));
                f.setHelp("Replication");
                f.ShowDialog();
            }
            catch (System.Exception ex) { }
        }

        private void uploadToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (!this.userControlQueryList.ProjectIsSelected)
            {
                System.Windows.Forms.MessageBox.Show("Please select a project");
                return;
            }
            System.Windows.Forms.ToolStripMenuItem T = (System.Windows.Forms.ToolStripMenuItem)sender;
            System.Data.DataRow R = (System.Data.DataRow)T.Tag;
            if (!ProjectForUploadIsAvailableInPublisher(this.ReplicationPublisherConnectionString(R)))
            {
                System.Windows.Forms.MessageBox.Show("Either you have no access to the publishing database or the current project does not exist there");
                return;
            }
            try
            {
                DiversityCollection.Forms.FormReplication f = new DiversityCollection.Forms.FormReplication(DiversityWorkbench.UserControls.UserControlReplicateTable.ReplicationDirection.Upload, this.userControlQueryList.ProjectID, this.ReplicationPublisherConnectionString(R));
                f.setHelp("Replication");
                f.ShowDialog();
            }
            catch (System.Exception ex) { }
        }

        private void cleanDatabaseToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                DiversityCollection.Forms.FormReplication f = new DiversityCollection.Forms.FormReplication(DiversityWorkbench.UserControls.UserControlReplicateTable.ReplicationDirection.Clean, null, "");
                f.setHelp("Replication");
                f.ShowDialog();
            }
            catch (System.Exception ex) { }
        }

        private void mergeToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (!this.userControlQueryList.ProjectIsSelected)
            {
                System.Windows.Forms.MessageBox.Show("Please select a project");
                return;
            }
            System.Windows.Forms.ToolStripMenuItem T = (System.Windows.Forms.ToolStripMenuItem)sender;
            System.Data.DataRow R = (System.Data.DataRow)T.Tag;
            try
            {
                DiversityCollection.Forms.FormReplication f = new DiversityCollection.Forms.FormReplication(DiversityWorkbench.UserControls.UserControlReplicateTable.ReplicationDirection.Merge, this.userControlQueryList.ProjectID, this.ReplicationPublisherConnectionString(R));
                f.setHelp("Replication");
                f.ShowDialog();
            }
            catch (System.Exception ex) { }
        }
        
        private void deleteReplicationPublisherToolStripMenuItem_Click(object sender, EventArgs e)
        {
            System.Windows.Forms.ToolStripMenuItem T = (System.Windows.Forms.ToolStripMenuItem)sender;
            System.Data.DataRow R = (System.Data.DataRow)T.Tag;
            string SQL = "DELETE R " +
                "FROM  ReplicationPublisher AS R " +
                "WHERE (R.DatabaseName = '" + R["DatabaseName"].ToString() + "') AND (R.Server = '" + R["Server"].ToString() + "')";
            if (DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL))
                this.initReplicationMenu(true);
            else System.Windows.Forms.MessageBox.Show("Removal of replication publisher failed");
        }

        private void replicationToolsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                System.Windows.Forms.ToolStripMenuItem T = (System.Windows.Forms.ToolStripMenuItem)sender;
                System.Data.DataRow R = (System.Data.DataRow)T.Tag;
                DiversityWorkbench.ServerConnection SP = new DiversityWorkbench.ServerConnection();
                SP.DatabaseName = R["DatabaseName"].ToString();
                SP.DatabaseServer = R["Server"].ToString();
                SP.DatabaseServerPort = int.Parse(R["Port"].ToString());
                SP.IsTrustedConnection = true;
                DiversityWorkbench.UserControls.ReplicationRow.SqlConnectionPublisher = new System.Data.SqlClient.SqlConnection(SP.ConnectionString);
                DiversityWorkbench.UserControls.ReplicationRow.SqlConnectionSubscriber = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);

                System.Collections.Generic.List<string> Tables = new List<string>();
                Tables.Add("");
                //Tables.Add("Analysis");
                //Tables.Add("Collection");
                Tables.Add("LocalisationSystem");
                //Tables.Add("Method");
                //Tables.Add("Processing");
                Tables.Add("ProjectProxy");
                Tables.Add("Property");
                //Tables.Add("Transaction");
                DiversityWorkbench.Forms.FormReplicationTools f = new DiversityWorkbench.Forms.FormReplicationTools(Tables);
                f.setHelp("Replication");
                f.StartPosition = FormStartPosition.CenterParent;
                f.ShowDialog();
            }
            catch (System.Exception ex) { }
        }

        /// <summary>
        /// For upload the project must be availble in the publishing database
        /// </summary>
        private bool ProjectForUploadIsAvailableInPublisher(string ReplicationPublisherConnectionString)
        {
            bool OK = false;
            try
            {
                string SqlProject = "SELECT Project FROM ProjectProxy WHERE ProjectID = " + this.userControlQueryList.ProjectID.ToString();
                System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(ReplicationPublisherConnectionString);
                System.Data.SqlClient.SqlCommand C = new System.Data.SqlClient.SqlCommand(SqlProject, con);
                con.Open();
                string Project = C.ExecuteScalar().ToString();
                string SQL = "SELECT COUNT(*) " +
                    "FROM ProjectProxy AS P INNER JOIN " +
                    "ProjectUser AS U ON P.ProjectID = U.ProjectID " +
                    "WHERE U.LoginName = USER_NAME() AND P.Project = N'" + Project + "' AND P.ProjectID = " + this.userControlQueryList.ProjectID.ToString();
                C.CommandText = SQL;
                string Result = C.ExecuteScalar().ToString();
                if (Result != "1")
                {
                    OK = false;
                    string Message = "The project " + Project + " (ID = " + this.userControlQueryList.ProjectID.ToString() + ") is either missing in the publisher database, has a different name or you have no access.";
                    System.Windows.Forms.MessageBox.Show(Message);
                }
                else OK = true;
                con.Close();
            }
            catch (System.Exception ex) { OK = false; }
            return OK;
        }
        
        /// <summary>
        /// this function defines the replication publisher for a subscriber database. 
        /// this can only be done by the dbo or a user with proper rights
        /// only one publisher can be defined or one database
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void setServerToolStripMenuItem_Click(object sender, EventArgs e)
        {
            //try
            //{
            //    DiversityWorkbench.Forms.FormConnectToDatabase f = new DiversityWorkbench.Forms.FormConnectToDatabase(DiversityWorkbench.Settings.ServerConnection);
            //    //DiversityWorkbench.FormDatabaseConnection f = new DiversityWorkbench.FormDatabaseConnection(DiversityWorkbench.Settings.ServerConnection);
            //    f.ShowDialog();
            //    if (f.DialogResult == DialogResult.OK &&
            //        f.ServerConnection.DatabaseName != DiversityWorkbench.Settings.DatabaseName &&
            //        f.ServerConnection.ConnectionIsValid &&
            //        f.ServerConnection.ConnectionString.Length > 0)
            //    {
            //        string SQL = "CREATE FUNCTION [dbo].[ReplicationPublisherConnection] ()  " +
            //            "RETURNS  varchar (255) AS  " +
            //            "BEGIN " +
            //            "declare @URL varchar(255) " +
            //            "set @URL =  'Data Source=" + f.ServerConnection.DatabaseServer +
            //            "," + f.ServerConnection.DatabaseServerPort.ToString() +
            //            ";Initial Catalog=" + f.ServerConnection.DatabaseName + "' " +
            //            "return @URL " +
            //            "END ";
            //        string Grant = "GRANT EXECUTE ON [dbo].[ReplicationPublisherConnection] TO [USER]";
            //        if (DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL) && 
            //            DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(Grant))
            //        {
            //            this.setDataMenu();
            //        }
            //    }

            //}
            //catch (Exception ex)
            //{
            //    this.replicationToolStripMenuItem.Visible = false;
            //    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            //}
        }

        private System.Collections.Generic.Dictionary<string, string> _ReplicationPublisherConnections;

        public System.Collections.Generic.Dictionary<string, string> ReplicationPublisherConnections
        {
            get 
            {
                if (this._ReplicationPublisherConnections == null)
                {
                    this._ReplicationPublisherConnections = new Dictionary<string, string>();
                    string SQL = "SELECT   'Data Source=' + Server  + ',' + CAST( Port as varchar) + ';Initial Catalog=' + DatabaseName " +
                        "FROM         ReplicationPublisher";
                    System.Data.DataTable dt = new DataTable();
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(dt);
                    foreach (System.Data.DataRow R in dt.Rows)
                        this._ReplicationPublisherConnections.Add(R[0].ToString(), "");
                }
                return _ReplicationPublisherConnections;
            }
            //set { _ReplicationPublisherConnections = value; }
        }

        public string ReplicationPublisherConnectionString(System.Data.DataRow R)
        {
            if (R["DatabaseName"].Equals(System.DBNull.Value)
                || R["DatabaseName"].ToString().Length == 0
                || R["Server"].Equals(System.DBNull.Value)
                || R["Server"].ToString().Length == 0 
                || R["Port"].Equals(System.DBNull.Value)
                || R["Port"].ToString().Length == 0)
                return "";

            string ReplicationPublisherConnection = "Data Source=" + R["Server"].ToString() + "," + R["Port"].ToString() + ";Initial Catalog=" + R["DatabaseName"].ToString();
            if (!this.ReplicationPublisherConnections.ContainsKey(ReplicationPublisherConnection))
                this.ReplicationPublisherConnections.Add(ReplicationPublisherConnection, "");
            if (this.ReplicationPublisherConnections[ReplicationPublisherConnection].Length > 0)
                return this.ReplicationPublisherConnections[ReplicationPublisherConnection];
            // try the current login data to connect to the database
            string ConnectionLogin = "";
            if (DiversityWorkbench.Settings.IsTrustedConnection)
                ConnectionLogin = ";Integrated Security=True";
            else
                ConnectionLogin = ";User ID=" + DiversityWorkbench.Settings.DatabaseUser + ";Password=" + DiversityWorkbench.Settings.Password;
            try
            {
                string SQL = "SELECT dbo.BaseURL()";
                System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(ReplicationPublisherConnection + ConnectionLogin);
                System.Data.SqlClient.SqlCommand C = new System.Data.SqlClient.SqlCommand(SQL, con);
                con.Open();
                string BaseURL = C.ExecuteScalar().ToString();
                con.Close();
                con.Dispose();
                if (BaseURL.Length > 0)
                    this.ReplicationPublisherConnections[ReplicationPublisherConnection] = ReplicationPublisherConnection + ConnectionLogin;
            }
            catch (System.Exception ex) { }
            if (this.ReplicationPublisherConnections[ReplicationPublisherConnection].Length == 0)
            {
                DiversityWorkbench.ServerConnection SC = new DiversityWorkbench.ServerConnection();
                SC.DatabaseName = R["DatabaseName"].ToString();
                SC.DatabaseServer = R["Server"].ToString();
                SC.DatabaseServerPort = int.Parse(R["Port"].ToString());
                DiversityWorkbench.Forms.FormConnectToDatabase f = new DiversityWorkbench.Forms.FormConnectToDatabase(true, SC);
                f.setHelp("Connection");
                f.ShowDialog();
                if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                {
                    if (f.ServerConnection.ConnectionString.Length > 0)
                        this.ReplicationPublisherConnections[ReplicationPublisherConnection] = f.ServerConnection.ConnectionString;
                }
            }

            return this.ReplicationPublisherConnections[ReplicationPublisherConnection];
        }

        #endregion

        #region Export

        #region NON wizard exports
        
        private void exportListToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityCollection.FormExportList f = new FormExportList(ref this.userControlQueryList);
            f.setHelp("Export list");
            f.ShowDialog();
        }

        private void GPIexportToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (this.userControlQueryList.ListOfIDs.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select at least one item for the export");
                return;
            }
            try
            {
                DiversityCollection.Forms.FormExportGPI f = new DiversityCollection.Forms.FormExportGPI(this.userControlQueryList.ListOfIDs);
                f.setHelp("JSTOR");
                f.ShowDialog();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void ABCDexportToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (this.userControlQueryList.ListOfIDs.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select at least one item for the export");
                return;
            }
            if (this.userControlQueryList.ListOfIDs.Count > 100)
            {
                if (System.Windows.Forms.MessageBox.Show("You selected more than 100 item for the export! OK?", "Export more than 100 items?", MessageBoxButtons.OKCancel) != DialogResult.OK)
                    return;
            }

            DiversityCollection.CollectionSpecimen Specimen = new CollectionSpecimen(this.ServerConnection);
            DiversityCollection.Datasets.DataSetCollectionSpecimen dsSpecimen = new DiversityCollection.Datasets.DataSetCollectionSpecimen();
            DiversityCollection.Datasets.DataSetCollectionEventSeries dsEventSeries = new DiversityCollection.Datasets.DataSetCollectionEventSeries();
            try
            {
                for (int i = 0; i < this.userControlQueryList.listBoxQueryResult.Items.Count; i++)
                {
                    System.Data.DataRowView rv = (System.Data.DataRowView)this.userControlQueryList.listBoxQueryResult.Items[i];
                    int SpecimenID = int.Parse(rv["ID"].ToString());
                    Specimen.fillSpecimen(SpecimenID, ref dsSpecimen, ref dsEventSeries);
                }
                DiversityCollection.FormXmlExport f = new FormXmlExport(dsSpecimen, dsEventSeries);
                f.ShowDialog();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void cacheDBToolStripMenuItem_Click(object sender, EventArgs e)
        {
            //System.Windows.Forms.MessageBox.Show("Available in upcoming version");//
            //return;

            //DiversityCollection.Forms.FormExportToCacheDB f = new Forms.FormExportToCacheDB();

            //try
            //{
            //    DiversityCollection.CacheDatabase.FormCacheDB f = new DiversityCollection.CacheDatabase.FormCacheDB();
            //    f.SetFormState(CacheDatabase.FormCacheDB.FormState.Transfer);
            //    f.ShowDialog();
            //}
            //catch (System.Exception ex) { }

            //try
            //{
            //    DiversityCollection.Forms.FormCacheDBExport f = new Forms.FormCacheDBExport();
            //    f.ShowDialog();
            //}
            //catch (System.Exception ex) { }
        }

        private void cSVbcpToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Forms.FormExportToCSV f = new DiversityWorkbench.Forms.FormExportToCSV();
            f.StartPosition = FormStartPosition.CenterParent;
            f.ShowDialog();
        }

        private void backupDatabasetoolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (System.Windows.Forms.MessageBox.Show("Do you want to create a backup of the whole database?", "Backup", MessageBoxButtons.YesNo) == System.Windows.Forms.DialogResult.Yes)
            {
                string BackupPath;
                string Filename = "";
                DiversityWorkbench.Database.BackupCopy(DiversityWorkbench.Settings.DatabaseName, ref Filename, out BackupPath);
                System.Windows.Forms.MessageBox.Show(BackupPath);
            }
        }
        
        private void projectArchiveToolStripMenuItem_Click(object sender, EventArgs e)
        {
        }

        #region Special lists

        private void bayernFloraToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                BayernFlora.FormExport f = new BayernFlora.FormExport();
                f.ShowDialog();
            }
            catch (Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private void NaturGuckerToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.userControlQueryList.listBoxQueryResult.Items.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select at least one item");
                    return;
                }
                DiversityCollection.Forms.FormExportNaturgucker F = new DiversityCollection.Forms.FormExportNaturgucker(this.IDs, this.userControlQueryList.ProjectID);
                F.StartPosition = FormStartPosition.CenterParent;
                F.setHelp("Naturgucker");
                F.ShowDialog();
            }
            catch { }
        }

        private void BIBToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                DiversityCollection.Forms.FormExportBIB F = new DiversityCollection.Forms.FormExportBIB(this.IDs);
                F.setHelp("BIB");
                F.ShowDialog();
            }
            catch { }
        }
        
        #endregion

        #region Externe Syteme - abgeschaltet wegen nicht Benutzung

        private void seSamToolStripMenuItem_Click(object sender, EventArgs e)
        {
            System.Windows.Forms.MessageBox.Show("Available in upcoming version");//
            return;

            DiversityCollection.Forms.FormExportSeSam f = new Forms.FormExportSeSam(this.userControlQueryList.ListOfIDs);
            f.ShowDialog();
        }

        private void iMDASToolStripMenuItem_Click(object sender, EventArgs e)
        {
            System.Windows.Forms.MessageBox.Show("Available in upcoming version");
            return;
        }
        
        #endregion

        #endregion

        #region Wizard

        private void exportWizardToolStripMenuItem_Click(object sender, EventArgs e)
        {
            //System.Windows.Forms.MessageBox.Show("Available in upcoming version");
        }

        private void eventSeriesToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (this.userControlQueryList.ListOfIDs.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }

            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            DiversityWorkbench.Export.Exporter.ResetAll();

            // getting the IDs
            System.Collections.Generic.List<int> L = new List<int>();
            System.Data.DataTable dt = new DataTable();
            string SQL = "";
            foreach (int ID in this.userControlQueryList.ListOfIDs)
            {
                if (SQL.Length > 0) SQL += ", ";
                SQL += ID.ToString();
            }
            SQL = "SELECT E.SeriesID " +
                "FROM  CollectionEvent AS E INNER JOIN " +
                "CollectionSpecimen AS S ON E.CollectionEventID = S.CollectionEventID " +
                "WHERE (S.CollectionSpecimenID IN (" + SQL + ")) " +
                "GROUP BY E.SeriesID " +
                "HAVING (NOT (E.SeriesID IS NULL))";
            System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            ad.Fill(dt);
            foreach (System.Data.DataRow R in dt.Rows)
                L.Add(int.Parse(R[0].ToString()));
            if (L.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("No data found");
                this.Cursor = System.Windows.Forms.Cursors.Default;
                return;
            }

            // getting the tables
            // getting the template tables
            DiversityWorkbench.Export.Table TSeries = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventSeries", "Event series", DiversityWorkbench.Export.Table.Parallelity.unique, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.EventSeries), null, null, null, "");
            TSeries.IsStartPoint = true;
            // Images
            System.Collections.Generic.Dictionary<string, string> T_SeriesImage_M = new Dictionary<string, string>();
            T_SeriesImage_M.Add("CreatorAgentURI", "DiversityAgents");
            T_SeriesImage_M.Add("LicenseHolderAgentURI", "DiversityAgents");
            DiversityWorkbench.Export.Table TSeriesImage = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventSeriesImage", "Series image", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.ImageArea), TSeries, null, T_SeriesImage_M, "");

            System.Collections.Generic.Dictionary<string, string> TM = new Dictionary<string, string>();
            TM.Add("ReferenceURI", "DiversityReferences");
            DiversityWorkbench.Export.Table TEvent = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEvent", "Event", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Event), TSeries, null, TM, "");

            // Localisation
            this.ExportWizardLocalisationTables(TEvent);
            // Site properties
            this.ExportWizardEventPropertyTables(TEvent);
            // Images
            System.Collections.Generic.Dictionary<string, string> T_EventImage_M = new Dictionary<string, string>();
            T_EventImage_M.Add("CreatorAgentURI", "DiversityAgents");
            T_EventImage_M.Add("LicenseHolderAgentURI", "DiversityAgents");
            DiversityWorkbench.Export.Table TEventImage = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventImage", "Event image", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.ImageArea), TEvent, null, T_EventImage_M, "");

            // Method
            DiversityWorkbench.Export.Table TEventMethod = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventMethod", "Event method", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Tool), TEvent, null, null, "");
            DiversityWorkbench.Export.Table TEventMethodParameter = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventParameterValue", "Event method parameter", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Parameter), TEventMethod, null, null, "");

            // Specimen
            System.Collections.Generic.Dictionary<string, string> TSM = new Dictionary<string, string>();
            TSM.Add("DepositorsAgentURI", "DiversityAgents");
            TSM.Add("ExsiccataURI", "DiversityExsiccatae");
            TSM.Add("ReferenceURI", "DiversityReferences");
            DiversityWorkbench.Export.Table TSpecimen = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimen", "Specimen", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Specimen), TEvent, null, TSM, "");

            // Table list
            System.Collections.Generic.List<DiversityWorkbench.Export.Table> TT = new List<DiversityWorkbench.Export.Table>();
            TT.Add(TSeries);
            TT.Add(TEvent);
            TT.Add(TSpecimen);



            DiversityWorkbench.Export.FormExport f = new DiversityWorkbench.Export.FormExport(TSeries, L, TT, this.helpProviderDiversityCollection.HelpNamespace);
            f.Width = this.Width - 10;
            f.Height = this.Height - 10;
            f.StartPosition = FormStartPosition.CenterParent;
            this.Cursor = System.Windows.Forms.Cursors.Default;
            f.ShowDialog();
        }

        private void exportEventsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.userControlQueryList.ListOfIDs.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Nothing selected");
                    return;
                }
                else if (this.userControlQueryList.ListOfIDs.Count > 1000)
                {
                    if (System.Windows.Forms.MessageBox.Show("You want to export the data of " + this.userControlQueryList.ListOfIDs.Count.ToString() + " specimen. This may take a while. Are you sure?", this.userControlQueryList.ListOfIDs.Count.ToString() + " datasets?", MessageBoxButtons.OKCancel) == System.Windows.Forms.DialogResult.Cancel)
                        return;
                }

                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                DiversityWorkbench.Export.Exporter.ResetAll();

                // getting the IDs
                System.Collections.Generic.List<int> L = new List<int>();
                System.Data.DataTable dt = new DataTable();
                string SQL = "";
                foreach (int ID in this.userControlQueryList.ListOfIDs)
                {
                    if (SQL.Length > 0) SQL += ", ";
                    SQL += ID.ToString();
                }
                SQL = "SELECT DISTINCT CollectionEventID FROM CollectionSpecimen WHERE CollectionSpecimenID IN (" + SQL + ") AND (NOT (CollectionEventID IS NULL))";
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityWorkbench.Settings.TimeoutDatabase));
                ad.SelectCommand.CommandTimeout = DiversityWorkbench.Settings.TimeoutDatabase;
                ad.Fill(dt);
                foreach (System.Data.DataRow R in dt.Rows)
                    L.Add(int.Parse(R[0].ToString()));
                if (L.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("No data found");
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                    return;
                }

                // getting the tables
                // getting the template tables
                DiversityWorkbench.Export.Table TSeries = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventSeries", "Event series", DiversityWorkbench.Export.Table.Parallelity.unique, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.EventSeries), null, null, null, "");

                System.Collections.Generic.Dictionary<string, string> TM = new Dictionary<string, string>();
                TM.Add("ReferenceURI", "DiversityReferences");
                DiversityWorkbench.Export.Table TEvent = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEvent", "Event", DiversityWorkbench.Export.Table.Parallelity.unique, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Event), TSeries, null, TM, "");
                TEvent.IsStartPoint = true;

                // Localisation
                this.ExportWizardLocalisationTables(TEvent);
                // Site properties
                this.ExportWizardEventPropertyTables(TEvent);
                // Images
                System.Collections.Generic.Dictionary<string, string> T_EventImage_M = new Dictionary<string, string>();
                T_EventImage_M.Add("CreatorAgentURI", "DiversityAgents");
                T_EventImage_M.Add("LicenseHolderAgentURI", "DiversityAgents");
                DiversityWorkbench.Export.Table TEventImage = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventImage", "Event image", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.ImageArea), TEvent, null, T_EventImage_M, "");

                // Method
                DiversityWorkbench.Export.Table TEventMethod = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventMethod", "Event method", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Tool), TEvent, null, null, "");
                DiversityWorkbench.Export.Table TEventMethodParameter = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventParameterValue", "Event method parameter", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Parameter), TEventMethod, null, null, "");

                // Specimen
                System.Collections.Generic.Dictionary<string, string> TSM = new Dictionary<string, string>();
                TSM.Add("DepositorsAgentURI", "DiversityAgents");
                TSM.Add("ExsiccataURI", "DiversityExsiccatae");
                TSM.Add("ReferenceURI", "DiversityReferences");
                DiversityWorkbench.Export.Table TSpecimen = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimen", "Specimen", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Specimen), TEvent, null, TSM, "");

                // Table list
                System.Collections.Generic.List<DiversityWorkbench.Export.Table> TT = new List<DiversityWorkbench.Export.Table>();
                TT.Add(TSeries);
                TT.Add(TEvent);
                TT.Add(TSpecimen);

                DiversityWorkbench.Export.FormExport f = new DiversityWorkbench.Export.FormExport(TEvent, L, TT, this.helpProviderDiversityCollection.HelpNamespace);
                f.Width = this.Width - 10;
                f.Height = this.Height - 10;
                f.StartPosition = FormStartPosition.CenterParent;
                this.Cursor = System.Windows.Forms.Cursors.Default;
                f.ShowDialog();
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void exportSpecimenToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                this.Enabled = false;

                // Show start window
                DiversityWorkbench.Import.FormStartWizard fs = new DiversityWorkbench.Import.FormStartWizard("Starting export wizard...", DiversityWorkbench.Import.FormStartWizard.Direction.Export);
                fs.Show();
                Application.DoEvents();

                if (this.userControlQueryList.ListOfIDs.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Nothing selected");
                    fs.Close();
                    return;
                }
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                DiversityWorkbench.Export.Exporter.ResetAll();

                // getting the IDs
                System.Collections.Generic.List<int> L = new List<int>();
                foreach (int ID in this.userControlQueryList.ListOfIDs)
                {
                    L.Add(ID);
                }
                if (L.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("No data found");
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                    return;
                }

                // getting the template tables
                DiversityWorkbench.Export.Table TSeries = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventSeries", "Event series", DiversityWorkbench.Export.Table.Parallelity.unique, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.EventSeries), null, null, null, "");

                System.Collections.Generic.Dictionary<string, string> TM = new Dictionary<string, string>();
                TM.Add("ReferenceURI", "DiversityReferences");
                DiversityWorkbench.Export.Table TEvent = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEvent", "Event", DiversityWorkbench.Export.Table.Parallelity.unique, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Event), TSeries, null, TM, "");

                // Localisation
                this.ExportWizardLocalisationTables(TEvent);
                // Site properties
                this.ExportWizardEventPropertyTables(TEvent);

                DiversityWorkbench.Export.Table TEventMethod = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventMethod", "Event method", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Tool), TEvent, null, null, "");
                DiversityWorkbench.Export.Table TEventMethodParameter = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventParameterValue", "Event method parameter", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Parameter), TEventMethod, null, null, "");

                System.Collections.Generic.Dictionary<string, string> T_EventImage_M = new Dictionary<string, string>();
                T_EventImage_M.Add("CreatorAgentURI", "DiversityAgents");
                T_EventImage_M.Add("LicenseHolderAgentURI", "DiversityAgents");
                DiversityWorkbench.Export.Table TEventImage = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventImage", "Event image", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.ImageArea), TEvent, null, T_EventImage_M, "");

                // IdentifierEvent
                System.Collections.Generic.Dictionary<string, string> T_IdentifierEvent_Joins = new Dictionary<string, string>();
                T_IdentifierEvent_Joins.Add("CollectionEventID", "CollectionEventID");
                System.Collections.Generic.List<string> IdentifierSortingColumns = new List<string>();
                IdentifierSortingColumns.Add("ID");
                DiversityWorkbench.Export.Table T_IdentifierEvent = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentifierEvent", "Identifier for event", DiversityWorkbench.Export.Table.Parallelity.referencing, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.ID), TEvent, IdentifierSortingColumns, null, ""/*ReferencedTable = 'CollectionEvent'"*/, T_IdentifierEvent_Joins, null);

                // AnnotationEvent
                System.Collections.Generic.Dictionary<string, string> T_AnnotationEvent_Joins = new Dictionary<string, string>();
                T_AnnotationEvent_Joins.Add("CollectionEventID", "CollectionEventID");
                System.Collections.Generic.List<string> AnnotationSortingColumns = new List<string>();
                AnnotationSortingColumns.Add("AnnotationID");
                DiversityWorkbench.Export.Table T_AnnotationEvent = DiversityWorkbench.Export.Exporter.AddTemplateTable("AnnotationEvent", "Annotation for event", DiversityWorkbench.Export.Table.Parallelity.referencing, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Annotation), TEvent, AnnotationSortingColumns, null, ""/*ReferencedTable = 'CollectionEvent'"*/, T_AnnotationEvent_Joins, null);

                // Specimen
                System.Collections.Generic.Dictionary<string, string> TSM = new Dictionary<string, string>();
                TSM.Add("DepositorsAgentURI", "DiversityAgents");
                TSM.Add("ExsiccataURI", "DiversityExsiccatae");
                TSM.Add("ReferenceURI", "DiversityReferences");
                DiversityWorkbench.Export.Table TSpecimen = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimen", "Specimen", DiversityWorkbench.Export.Table.Parallelity.unique, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Specimen), TEvent, null, TSM, "");
                TSpecimen.IsStartPoint = true;

                DiversityWorkbench.Project P = new DiversityWorkbench.Project(DiversityWorkbench.Settings.ServerConnection);

                // Project
                System.Collections.Generic.Dictionary<string, string> T_PM = new Dictionary<string, string>();
                T_PM.Add("ProjectID", "DiversityProjects");
                DiversityWorkbench.Export.Table TProject = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionProject", "Project", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Project), TSpecimen, null, T_PM, "");

                // IdentifierSpecimen
                System.Collections.Generic.Dictionary<string, string> T_Identifier_Joins = new Dictionary<string, string>();
                T_Identifier_Joins.Add("CollectionSpecimenID", "CollectionSpecimenID");
                DiversityWorkbench.Export.Table T_IdentifierSpecimen = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentifierSpecimen", "Identifier for specimen", DiversityWorkbench.Export.Table.Parallelity.referencing, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.ID), TSpecimen, IdentifierSortingColumns, null, ""/*ReferencedTable = 'CollectionSpecimen'"*/, T_Identifier_Joins, null);

                // AnnotationSpecimen
                System.Collections.Generic.Dictionary<string, string> T_Annotation_Joins = new Dictionary<string, string>();
                T_Annotation_Joins.Add("CollectionSpecimenID", "CollectionSpecimenID");
                DiversityWorkbench.Export.Table T_AnnotationSpecimen = DiversityWorkbench.Export.Exporter.AddTemplateTable("AnnotationSpecimen", "Annotation for specimen", DiversityWorkbench.Export.Table.Parallelity.referencing, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Annotation), TSpecimen, AnnotationSortingColumns, null, ""/*ReferencedTable = 'CollectionSpecimen'"*/, T_Annotation_Joins, null);

                // Agent
                System.Collections.Generic.Dictionary<string, string> TAgentM = new Dictionary<string, string>();
                TAgentM.Add("CollectorsAgentURI", "DiversityAgents");
                System.Collections.Generic.List<string> SortingColumnsAgent = new List<string>();
                SortingColumnsAgent.Add("CollectorsSequence");
                DiversityWorkbench.Export.Table TAgent = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionAgent", "Collector", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Agent), TSpecimen, SortingColumnsAgent, TAgentM, "");

                // Reference
                System.Collections.Generic.List<string> SortingColumns_Reference = new List<string>();
                SortingColumns_Reference.Add("ReferenceTitle");
                DiversityWorkbench.Export.Table T_Reference = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenReference", "Reference", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Reference), TSpecimen, SortingColumns_Reference, null, "");

                // Relation
                System.Collections.Generic.List<string> SortingColumns_Relation = new List<string>();
                SortingColumns_Relation.Add("RelatedSpecimenDisplayText");
                DiversityWorkbench.Export.Table T_Relation = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenRelation", "Relation", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Relation), TSpecimen, SortingColumns_Relation, null, "");

                // Relation invers
                System.Collections.Generic.Dictionary<string, string> NoForeignTables = new Dictionary<string, string>();
                System.Collections.Generic.Dictionary<string, string> JoinColumnsRelationInvers = new Dictionary<string, string>();
                JoinColumnsRelationInvers.Add("CollectionSpecimenID", "CollectionSpecimenID");
                DiversityWorkbench.Export.Table T_RelationInvers = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenRelationInvers", "Relation invers", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.RelationInversGrey), TSpecimen, null, null, "", JoinColumnsRelationInvers, NoForeignTables);

                // Specimen Image
                System.Collections.Generic.Dictionary<string, string> T_SpecimenImage_M = new Dictionary<string, string>();
                T_SpecimenImage_M.Add("CreatorAgentURI", "DiversityAgents");
                T_SpecimenImage_M.Add("LicenseHolderAgentURI", "DiversityAgents");
                DiversityWorkbench.Export.Table TSpecimenImage = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenImage", "Specimen image", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.ImageArea), TSpecimen, null, T_SpecimenImage_M, "");

                // Unit
                System.Collections.Generic.List<string> SortingColumnsUnit = new List<string>();
                SortingColumnsUnit.Add("DisplayOrder");
                DiversityWorkbench.Export.Table TUnit = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentificationUnit", "Organism", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTaxon.Plant), TSpecimen, SortingColumnsUnit, null, "");

                System.Collections.Generic.Dictionary<string, string> TIdentM = new Dictionary<string, string>();
                TIdentM.Add("NameURI", "DiversityTaxonNames");
                TIdentM.Add("ResponsibleAgentURI", "DiversityAgents");
                TIdentM.Add("ReferenceURI", "DiversityReferences");
                System.Collections.Generic.List<string> SortingColumns = new List<string>();
                SortingColumns.Add("IdentificationSequence");
                DiversityWorkbench.Export.Table TIdent = DiversityWorkbench.Export.Exporter.AddTemplateTable("Identification", "Identification", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Identification), TUnit, SortingColumns, TIdentM, "");

                System.Collections.Generic.Dictionary<string, string> T_UnitAnalysis_M = new Dictionary<string, string>();
                T_UnitAnalysis_M.Add("ResponsibleAgentURI", "DiversityAgents");
                System.Collections.Generic.List<string> T_UnitAnalysis_SortingColumns = new List<string>();
                T_UnitAnalysis_SortingColumns.Add("AnalysisNumber");
                DiversityWorkbench.Export.Table T_UnitAnalysis = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentificationUnitAnalysis", "Analysis", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Analysis), TUnit, T_UnitAnalysis_SortingColumns, T_UnitAnalysis_M, "");

                DiversityWorkbench.Export.Table T_UnitIdentificationUnitGeoAnalysisAnalysis = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentificationUnitGeoAnalysis", "Geography", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Localisation), TUnit, null, null, "");

                DiversityWorkbench.Export.Table T_UnitAnalysisMethod = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentificationUnitAnalysisMethod", "Method", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Tool), T_UnitAnalysis, null, null, "");

                DiversityWorkbench.Export.Table T_UnitAnalysisMethodParameter = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentificationUnitAnalysisMethodParameter", "Parameter", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Parameter), T_UnitAnalysisMethod, null, null, "");

                // IdentifierUnit
                System.Collections.Generic.Dictionary<string, string> T_IdentifierUnit_Joins = new Dictionary<string, string>();
                T_IdentifierUnit_Joins.Add("IdentificationUnitID", "IdentificationUnitID");
                DiversityWorkbench.Export.Table T_IdentifierUnit = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentifierUnit", "Identifier for organism", DiversityWorkbench.Export.Table.Parallelity.referencing, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.ID), TUnit, IdentifierSortingColumns, null, ""/*ReferencedTable = 'IdentificationUnit'"*/, T_IdentifierUnit_Joins, null);

                // AnnotationUnit
                System.Collections.Generic.Dictionary<string, string> T_AnnotationUnit_Joins = new Dictionary<string, string>();
                T_AnnotationUnit_Joins.Add("IdentificationUnitID", "IdentificationUnitID");
                DiversityWorkbench.Export.Table T_AnnotationUnit = DiversityWorkbench.Export.Exporter.AddTemplateTable("AnnotationUnit", "Annotation for organism", DiversityWorkbench.Export.Table.Parallelity.referencing, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Annotation), TUnit, AnnotationSortingColumns, null, ""/*ReferencedTable = 'IdentificationUnit'"*/, T_AnnotationUnit_Joins, null);

                // Part
                System.Collections.Generic.Dictionary<string, string> T_Part_M = new Dictionary<string, string>();
                T_Part_M.Add("ResponsibleAgentURI", "DiversityAgents");
                System.Collections.Generic.List<string> SortingColumnsPart = new List<string>();
                SortingColumnsPart.Add("DisplayOrder");
                DiversityWorkbench.Export.Table TPart = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenPart", "Part", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageStorage.Specimen), TSpecimen, SortingColumnsPart, T_Part_M, "");

                DiversityWorkbench.Export.Table T_Transaction = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenTransaction", "Transaction", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Transaction), TPart, null, null, "");

                DiversityWorkbench.Export.Table T_Processing = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenProcessing", "Processing", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Processing), TPart, null, null, "");
                DiversityWorkbench.Export.Table T_ProcessingMethod = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenProcessingMethod", "Method", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Tool), T_Processing, null, null, "");
                DiversityWorkbench.Export.Table T_ProcessingParameter = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenProcessingMethodParameter", "Parameter", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Parameter), T_ProcessingMethod, null, null, "");

                DiversityWorkbench.Export.Table T_PartDescription = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenPartDescription", "Description", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.PartDescription), TPart, null, null, "");

                // IdentifierPart
                System.Collections.Generic.Dictionary<string, string> T_IdentifierPart_Joins = new Dictionary<string, string>();
                T_IdentifierPart_Joins.Add("SpecimenPartID", "SpecimenPartID");
                DiversityWorkbench.Export.Table T_IdentifierPart = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentifierPart", "Identifier for part", DiversityWorkbench.Export.Table.Parallelity.referencing, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.ID), TPart, IdentifierSortingColumns, null, ""/*ReferencedTable = 'CollectionSpecimenPart'"*/, T_IdentifierPart_Joins, null);

                // AnnotationPart
                System.Collections.Generic.Dictionary<string, string> T_AnnotationPart_Joins = new Dictionary<string, string>();
                T_AnnotationPart_Joins.Add("SpecimenPartID", "SpecimenPartID");
                DiversityWorkbench.Export.Table T_AnnotationPart = DiversityWorkbench.Export.Exporter.AddTemplateTable("AnnotationPart", "Annotation for part", DiversityWorkbench.Export.Table.Parallelity.referencing, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Annotation), TPart, AnnotationSortingColumns, null, ""/*ReferencedTable = 'CollectionSpecimenPart'"*/, T_AnnotationPart_Joins, null);

                // Table list
                System.Collections.Generic.List<DiversityWorkbench.Export.Table> TT = new List<DiversityWorkbench.Export.Table>();
                TT.Add(TSeries);
                TT.Add(TEvent);
                //TT.Add(TAltitude);
                //TT.Add(TMTB);
                //TT.Add(TWGS84);
                TT.Add(TSpecimen);
                TT.Add(TAgent);
                TT.Add(TUnit);
                TT.Add(TPart);

                DiversityWorkbench.Export.FormExport f = new DiversityWorkbench.Export.FormExport(TSpecimen, L, TT, this.helpProviderDiversityCollection.HelpNamespace);
                f.Width = this.Width - 10;
                f.Height = this.Height - 10;
                f.StartPosition = FormStartPosition.CenterParent;

                fs.Close();
                f.ShowDialog();

            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
                this.Enabled = true;
            }
        }

        private void organismsToolStripMenuItem1_Click(object sender, EventArgs e)
        {
            if (this.userControlQueryList.ListOfIDs.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }

            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            try
            {
                DiversityWorkbench.Export.Exporter.ResetAll();

                // getting the IDs
                System.Collections.Generic.List<int> L = new List<int>();
                System.Data.DataTable dt = new DataTable();
                string SQL = "";
                foreach (int ID in this.userControlQueryList.ListOfIDs)
                {
                    if (SQL.Length > 0) SQL += ", ";
                    SQL += ID.ToString();
                }
                SQL = "SELECT DISTINCT IdentificationUnitID FROM IdentificationUnit WHERE CollectionSpecimenID IN (" + SQL + ")";
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.SelectCommand.CommandTimeout = DiversityWorkbench.Settings.TimeoutDatabase;
                ad.Fill(dt);
                foreach (System.Data.DataRow R in dt.Rows)
                {
                    try
                    {
                        L.Add(int.Parse(R[0].ToString()));
                    }
                    catch (System.Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        break;
                    }
                }
                if (L.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("No data found");
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                    return;
                }

                // Event
                System.Collections.Generic.Dictionary<string, string> TM = new Dictionary<string, string>();
                TM.Add("ReferenceURI", "DiversityReferences");
                DiversityWorkbench.Export.Table TEvent = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEvent", "Event", DiversityWorkbench.Export.Table.Parallelity.unique, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Event), null, null, TM, "");

                // Localisation
                this.ExportWizardLocalisationTables(TEvent);
                // Site properties
                this.ExportWizardEventPropertyTables(TEvent);

                // Specimen
                System.Collections.Generic.Dictionary<string, string> TSM = new Dictionary<string, string>();
                TSM.Add("DepositorsAgentURI", "DiversityAgents");
                TSM.Add("ExsiccataURI", "DiversityExsiccatae");
                TSM.Add("ReferenceURI", "DiversityReferences");
                DiversityWorkbench.Export.Table TSpecimen = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimen", "Specimen", DiversityWorkbench.Export.Table.Parallelity.unique, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Specimen), TEvent, null, TSM, "");

                // IdentifierSpecimen
                System.Collections.Generic.List<string> IdentifierSortingColumns = new List<string>();
                IdentifierSortingColumns.Add("ID");
                System.Collections.Generic.Dictionary<string, string> T_Identifier_Joins = new Dictionary<string, string>();
                T_Identifier_Joins.Add("CollectionSpecimenID", "CollectionSpecimenID");
                DiversityWorkbench.Export.Table T_IdentifierSpecimen = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentifierSpecimen", "Identifier for specimen", DiversityWorkbench.Export.Table.Parallelity.referencing, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.ID), TSpecimen, IdentifierSortingColumns, null, ""/*ReferencedTable = 'CollectionSpecimen'"*/, T_Identifier_Joins, null);

                // AnnotationSpecimen
                System.Collections.Generic.List<string> AnnotationSortingColumns = new List<string>();
                AnnotationSortingColumns.Add("AnnotationID");
                System.Collections.Generic.Dictionary<string, string> T_Annotation_Joins = new Dictionary<string, string>();
                T_Annotation_Joins.Add("CollectionSpecimenID", "CollectionSpecimenID");
                DiversityWorkbench.Export.Table T_AnnotationSpecimen = DiversityWorkbench.Export.Exporter.AddTemplateTable("AnnotationSpecimen", "Annotation for specimen", DiversityWorkbench.Export.Table.Parallelity.referencing, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Annotation), TSpecimen, AnnotationSortingColumns, null, ""/*ReferencedTable = 'CollectionSpecimen'"*/, T_Annotation_Joins, null);

                // Project
                System.Collections.Generic.Dictionary<string, string> T_PM = new Dictionary<string, string>();
                T_PM.Add("ProjectID", "DiversityProjects");
                DiversityWorkbench.Export.Table TProject = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionProject", "Project", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Project), TSpecimen, null, T_PM, "");

                // Agent
                System.Collections.Generic.Dictionary<string, string> TAgentM = new Dictionary<string, string>();
                TAgentM.Add("CollectorsAgentURI", "DiversityAgents");
                System.Collections.Generic.List<string> SortingColumnsAgent = new List<string>();
                SortingColumnsAgent.Add("CollectorsSequence");
                DiversityWorkbench.Export.Table TAgent = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionAgent", "Collector", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Agent), TSpecimen, SortingColumnsAgent, TAgentM, "");

                // Reference
                System.Collections.Generic.List<string> SortingColumns_Reference = new List<string>();
                SortingColumns_Reference.Add("ReferenceTitle");
                DiversityWorkbench.Export.Table T_Reference = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenReference", "Reference", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Reference), TSpecimen, SortingColumns_Reference, null, "");

                // Relation
                System.Collections.Generic.List<string> SortingColumns_Relation = new List<string>();
                SortingColumns_Relation.Add("RelatedSpecimenDisplayText");
                DiversityWorkbench.Export.Table T_Relation = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenRelation", "Relation", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Relation), TSpecimen, SortingColumns_Relation, null, "");

                // Unit
                System.Collections.Generic.List<string> SortingColumnsUnit = new List<string>();
                SortingColumnsUnit.Add("DisplayOrder");
                DiversityWorkbench.Export.Table TUnit = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentificationUnit", "Organism", DiversityWorkbench.Export.Table.Parallelity.unique, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTaxon.Plant), TSpecimen, SortingColumnsUnit, null, "");
                TUnit.IsStartPoint = true;

                // IdentifierUnit
                System.Collections.Generic.Dictionary<string, string> T_IdentifierUnit_Joins = new Dictionary<string, string>();
                T_IdentifierUnit_Joins.Add("IdentificationUnitID", "IdentificationUnitID");
                DiversityWorkbench.Export.Table T_IdentifierUnit = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentifierUnit", "Identifier for organism", DiversityWorkbench.Export.Table.Parallelity.referencing, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.ID), TUnit, IdentifierSortingColumns, null, ""/*ReferencedTable = 'IdentificationUnit'"*/, T_IdentifierUnit_Joins, null);

                // AnnotationUnit
                System.Collections.Generic.Dictionary<string, string> T_AnnotationUnit_Joins = new Dictionary<string, string>();
                T_AnnotationUnit_Joins.Add("IdentificationUnitID", "IdentificationUnitID");
                DiversityWorkbench.Export.Table T_AnnotationUnit = DiversityWorkbench.Export.Exporter.AddTemplateTable("AnnotationUnit", "Annotation for organism", DiversityWorkbench.Export.Table.Parallelity.referencing, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Annotation), TUnit, AnnotationSortingColumns, null, ""/*ReferencedTable = 'IdentificationUnit'"*/, T_AnnotationUnit_Joins, null);

                System.Collections.Generic.Dictionary<string, string> TIdentM = new Dictionary<string, string>();
                TIdentM.Add("NameURI", "DiversityTaxonNames");
                TIdentM.Add("ResponsibleAgentURI", "DiversityAgents");
                TIdentM.Add("ReferenceURI", "DiversityReferences");
                System.Collections.Generic.List<string> SortingColumns = new List<string>();
                SortingColumns.Add("IdentificationSequence");
                DiversityWorkbench.Export.Table TIdent = DiversityWorkbench.Export.Exporter.AddTemplateTable("Identification", "Identification", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Identification), TUnit, SortingColumns, TIdentM, "");

                System.Collections.Generic.Dictionary<string, string> T_UnitAnalysis_M = new Dictionary<string, string>();
                T_UnitAnalysis_M.Add("ResponsibleAgentURI", "DiversityAgents");
                System.Collections.Generic.List<string> T_UnitAnalysis_SortingColumns = new List<string>();
                T_UnitAnalysis_SortingColumns.Add("AnalysisNumber");
                DiversityWorkbench.Export.Table T_UnitAnalysis = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentificationUnitAnalysis", "Analysis", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Analysis), TUnit, T_UnitAnalysis_SortingColumns, T_UnitAnalysis_M, "");

                DiversityWorkbench.Export.Table T_UnitIdentificationUnitGeoAnalysisAnalysis = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentificationUnitGeoAnalysis", "Geography", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Localisation), TUnit, null, null, "");

                DiversityWorkbench.Export.Table T_UnitAnalysisMethod = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentificationUnitAnalysisMethod", "Method", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Tool), T_UnitAnalysis, null, null, "");

                DiversityWorkbench.Export.Table T_UnitAnalysisMethodParameter = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentificationUnitAnalysisMethodParameter", "Parameter", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Parameter), T_UnitAnalysisMethod, null, null, "");

                // UnitInPart
                DiversityWorkbench.Export.Table TUnitInPart = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentificationUnitInPart", "Unit in Part", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.UnitInPart), TUnit, null, null, "");

                // Part
                System.Collections.Generic.Dictionary<string, string> T_Part_M = new Dictionary<string, string>();
                T_Part_M.Add("ResponsibleAgentURI", "DiversityAgents");
                System.Collections.Generic.List<string> SortingColumnsPart = new List<string>();
                SortingColumnsPart.Add("DisplayOrder");
                DiversityWorkbench.Export.Table TPart = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenPart", "Part", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageStorage.Specimen), TUnitInPart, SortingColumnsPart, T_Part_M, "");

                // Table list
                System.Collections.Generic.List<DiversityWorkbench.Export.Table> TT = new List<DiversityWorkbench.Export.Table>();
                TT.Add(TUnit);

                DiversityWorkbench.Export.FormExport f = new DiversityWorkbench.Export.FormExport(TUnit, L, TT, this.helpProviderDiversityCollection.HelpNamespace);
                f.Width = this.Width - 10;
                f.Height = this.Height - 10;
                f.StartPosition = FormStartPosition.CenterParent;
                f.ShowDialog();
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void exportPartsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.userControlQueryList.ListOfIDs.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Nothing selected");
                    return;
                }
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                DiversityWorkbench.Export.Exporter.ResetAll();

                // getting the IDs
                System.Collections.Generic.List<int> L = new List<int>();
                System.Data.DataTable dt = new DataTable();
                string SQL = "";
                foreach (int ID in this.userControlQueryList.ListOfIDs)
                {
                    if (SQL.Length > 0) SQL += ", ";
                    SQL += ID.ToString();
                }
                SQL = "SELECT DISTINCT SpecimenPartID FROM CollectionSpecimenPart WHERE CollectionSpecimenID IN (" + SQL + ")";
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                foreach (System.Data.DataRow R in dt.Rows)
                    L.Add(int.Parse(R[0].ToString()));
                if (L.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("No data found");
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                    return;
                }

                // getting the template tables

                // Specimen
                System.Collections.Generic.Dictionary<string, string> TSM = new Dictionary<string, string>();
                TSM.Add("DepositorsAgentURI", "DiversityAgents");
                TSM.Add("ExsiccataURI", "DiversityExsiccatae");
                TSM.Add("ReferenceURI", "DiversityReferences");
                DiversityWorkbench.Export.Table TSpecimen = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimen", "Specimen", DiversityWorkbench.Export.Table.Parallelity.unique, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Specimen), null, null, TSM, "");

                // Part
                System.Collections.Generic.Dictionary<string, string> T_Part_M = new Dictionary<string, string>();
                T_Part_M.Add("ResponsibleAgentURI", "DiversityAgents");
                System.Collections.Generic.List<string> SortingColumnsPart = new List<string>();
                SortingColumnsPart.Add("DisplayOrder");
                DiversityWorkbench.Export.Table TPart = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenPart", "Part", DiversityWorkbench.Export.Table.Parallelity.unique, DiversityCollection.Specimen.getImage(Specimen.OverviewImageStorage.Specimen), TSpecimen, SortingColumnsPart, T_Part_M, "");
                TPart.IsStartPoint = true;

                DiversityWorkbench.Export.Table T_Transaction = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenTransaction", "Transaction", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Transaction), TPart, null, null, "");
                DiversityWorkbench.Export.Table T_Processing = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenProcessing", "Processing", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Processing), TPart, null, null, "");
                DiversityWorkbench.Export.Table T_ProcessingMethod = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenProcessingMethod", "Method", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Tool), T_Processing, null, null, "");
                DiversityWorkbench.Export.Table T_ProcessingParameter = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenProcessingMethodParameter", "Parameter", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Parameter), T_ProcessingMethod, null, null, "");
                DiversityWorkbench.Export.Table T_PartDescription = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionSpecimenPartDescription", "Description", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.PartDescription), TPart, null, null, "");

                DiversityWorkbench.Export.Table T_UnitInPart = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentificationUnitInPart", "UnitInPart", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTaxon.Plant), TPart, null, null, "");
                DiversityWorkbench.Export.Table T_Analysis = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentificationUnitAnalysis", "Analysis", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Analysis), T_UnitInPart, null, null, "");
                DiversityWorkbench.Export.Table T_AnalysisMethod = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentificationUnitAnalysisMethod", "Method", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Tool), T_Analysis, null, null, "");
                DiversityWorkbench.Export.Table T_AnalysisParameter = DiversityWorkbench.Export.Exporter.AddTemplateTable("IdentificationUnitAnalysisMethodParameter", "Parameter", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Parameter), T_AnalysisMethod, null, null, "");

                // Table list
                System.Collections.Generic.List<DiversityWorkbench.Export.Table> TT = new List<DiversityWorkbench.Export.Table>();
                TT.Add(TPart);

                DiversityWorkbench.Export.FormExport f = new DiversityWorkbench.Export.FormExport(TPart, L, TT, this.helpProviderDiversityCollection.HelpNamespace);
                f.Width = this.Width - 10;
                f.Height = this.Height - 10;
                f.StartPosition = FormStartPosition.CenterParent;
                this.Cursor = System.Windows.Forms.Cursors.Default;
                f.ShowDialog();
            }
            catch (System.Exception ex)
            {
            }
        }

        private void exportTransactionsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (this.userControlQueryList.ListOfIDs.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            DiversityWorkbench.Export.Exporter.ResetAll();

            // getting the IDs
            System.Collections.Generic.List<int> L = new List<int>();
            System.Data.DataTable dt = new DataTable();
            string SQL = "";
            foreach (int ID in this.userControlQueryList.ListOfIDs)
            {
                if (SQL.Length > 0) SQL += ", ";
                SQL += ID.ToString();
            }
            SQL = "SELECT DISTINCT T.TransactionID " +
                "FROM  CollectionSpecimenTransaction AS T " +
                "WHERE (T.CollectionSpecimenID IN (" + SQL + ")) ";
            System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            ad.Fill(dt);
            foreach (System.Data.DataRow R in dt.Rows)
                L.Add(int.Parse(R[0].ToString()));
            if (L.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("No data found");
                this.Cursor = System.Windows.Forms.Cursors.Default;
                return;
            }

            // getting the tables
            // getting the template tables
            DiversityWorkbench.Export.Table TTransaction = DiversityWorkbench.Export.Exporter.AddTemplateTable("Transaction", "Transaction", DiversityWorkbench.Export.Table.Parallelity.unique, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Transaction), null, null, null, "");
            TTransaction.IsStartPoint = true;

            // Document
            DiversityWorkbench.Export.Table TTransactionDocument = DiversityWorkbench.Export.Exporter.AddTemplateTable("TransactionDocument", "Documents", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Document), TTransaction, null, null, "");

            // Agents
            System.Collections.Generic.Dictionary<string, string> TM = new Dictionary<string, string>();
            TM.Add("AgentURI", "DiversityAgents");
            DiversityWorkbench.Export.Table TAgent = DiversityWorkbench.Export.Exporter.AddTemplateTable("TransactionAgent", "Agent", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Agent), TTransaction, null, TM, "");

            // Payment
            System.Collections.Generic.Dictionary<string, string> TP = new Dictionary<string, string>();
            TP.Add("PayerAgentURI", "DiversityAgents");
            TP.Add("RecipientAgentURI", "DiversityAgents");
            DiversityWorkbench.Export.Table TPayment = DiversityWorkbench.Export.Exporter.AddTemplateTable("TransactionPayment", "Payment", DiversityWorkbench.Export.Table.Parallelity.parallel, DiversityCollection.Specimen.getImage(Specimen.OverviewImageTableOrField.Payment), TTransaction, null, TP, "");

            // Table list
            System.Collections.Generic.List<DiversityWorkbench.Export.Table> TT = new List<DiversityWorkbench.Export.Table>();
            TT.Add(TTransaction);

            DiversityWorkbench.Export.FormExport f = new DiversityWorkbench.Export.FormExport(TTransaction, L, TT, this.helpProviderDiversityCollection.HelpNamespace);
            f.Width = this.Width - 10;
            f.Height = this.Height - 10;
            f.StartPosition = FormStartPosition.CenterParent;
            this.Cursor = System.Windows.Forms.Cursors.Default;
            f.ShowDialog();
        }

        private void ExportWizardLocalisationTables(DiversityWorkbench.Export.Table Parent)
        {
            System.Collections.Generic.Dictionary<string, string> TWGS84M = new Dictionary<string, string>();
            TWGS84M.Add("ResponsibleAgentURI", "DiversityAgents");
            DiversityWorkbench.Export.Table TWGS84 = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventLocalisation", "WGS84", DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForLocalisationSystem(Specimen.OverviewImageLocalisationSystem.Localisation), Parent, null, TWGS84M, "LocalisationSystemID = 8");

            System.Collections.Generic.Dictionary<string, string> TaltM = new Dictionary<string, string>();
            TaltM.Add("ResponsibleAgentURI", "DiversityAgents");
            DiversityWorkbench.Export.Table TAltitude = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventLocalisation", "Altitude", DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForLocalisationSystem(Specimen.OverviewImageLocalisationSystem.Altitide), Parent, null, TaltM, "LocalisationSystemID = 4");

            string Caption = "Gazetteer";
            string Entity = "LocalisationSystem.LocalisationSystemID.7";
            System.Collections.Generic.Dictionary<string, string> E = DiversityWorkbench.Entity.EntityInformation(Entity, "General", DiversityWorkbench.Settings.Language);
            if (E[DiversityWorkbench.Entity.EntityInformationField.DisplayTextOK.ToString()] == "True")
                Caption = E["DisplayText"];

            System.Collections.Generic.Dictionary<string, string> TGazetteerM = new Dictionary<string, string>();
            TGazetteerM.Add("ResponsibleAgentURI", "DiversityAgents");
            TGazetteerM.Add("Location2", "DiversityGazetteer");
            DiversityWorkbench.Export.Table TGazetteer = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventLocalisation", Caption, DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForLocalisationSystem(Specimen.OverviewImageLocalisationSystem.Place), Parent, null, TGazetteerM, "LocalisationSystemID = 7");

            Entity = "LocalisationSystem.LocalisationSystemID.18";
            System.Collections.Generic.Dictionary<string, string> E18 = DiversityWorkbench.Entity.EntityInformation(Entity, "General", DiversityWorkbench.Settings.Language);
            if (E18[DiversityWorkbench.Entity.EntityInformationField.DisplayTextOK.ToString()] == "True")
                Caption = E18["DisplayText"];

            System.Collections.Generic.Dictionary<string, string> TGazetteerM2 = new Dictionary<string, string>();
            TGazetteerM2.Add("ResponsibleAgentURI", "DiversityAgents");
            TGazetteerM2.Add("Location2", "DiversityGazetteer");
            DiversityWorkbench.Export.Table TGazetteer2 = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventLocalisation", Caption, DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForLocalisationSystem(18), Parent, null, TGazetteerM2, "LocalisationSystemID = 18");

            Entity = "LocalisationSystem.LocalisationSystemID.19";
            System.Collections.Generic.Dictionary<string, string> E19 = DiversityWorkbench.Entity.EntityInformation(Entity, "General", DiversityWorkbench.Settings.Language);
            if (E19[DiversityWorkbench.Entity.EntityInformationField.DisplayTextOK.ToString()] == "True")
                Caption = E19["DisplayText"];

            System.Collections.Generic.Dictionary<string, string> TGazetteerM3 = new Dictionary<string, string>();
            TGazetteerM3.Add("ResponsibleAgentURI", "DiversityAgents");
            TGazetteerM3.Add("Location2", "DiversityGazetteer");
            DiversityWorkbench.Export.Table TGazetteer3 = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventLocalisation", Caption, DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForLocalisationSystem(19), Parent, null, TGazetteerM3, "LocalisationSystemID = 19");

            Entity = "LocalisationSystem.LocalisationSystemID.20";
            System.Collections.Generic.Dictionary<string, string> E20 = DiversityWorkbench.Entity.EntityInformation(Entity, "General", DiversityWorkbench.Settings.Language);
            if (E20[DiversityWorkbench.Entity.EntityInformationField.DisplayTextOK.ToString()] == "True")
                Caption = E20["DisplayText"];

            System.Collections.Generic.Dictionary<string, string> TGazetteerM4 = new Dictionary<string, string>();
            TGazetteerM4.Add("ResponsibleAgentURI", "DiversityAgents");
            TGazetteerM4.Add("Location2", "DiversityGazetteer");
            DiversityWorkbench.Export.Table TGazetteer4 = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventLocalisation", Caption, DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForLocalisationSystem(20), Parent, null, TGazetteerM4, "LocalisationSystemID = 20");

            Entity = "LocalisationSystem.LocalisationSystemID.21";
            System.Collections.Generic.Dictionary<string, string> E21 = DiversityWorkbench.Entity.EntityInformation(Entity, "General", DiversityWorkbench.Settings.Language);
            if (E21[DiversityWorkbench.Entity.EntityInformationField.DisplayTextOK.ToString()] == "True")
                Caption = E21["DisplayText"];

            System.Collections.Generic.Dictionary<string, string> TGazetteerM5 = new Dictionary<string, string>();
            TGazetteerM5.Add("ResponsibleAgentURI", "DiversityAgents");
            TGazetteerM5.Add("Location2", "DiversityGazetteer");
            DiversityWorkbench.Export.Table TGazetteer5 = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventLocalisation", Caption, DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForLocalisationSystem(21), Parent, null, TGazetteerM5, "LocalisationSystemID = 21");

            System.Collections.Generic.Dictionary<string, string> TPlotM = new Dictionary<string, string>();
            TPlotM.Add("ResponsibleAgentURI", "DiversityAgents");
            TPlotM.Add("Location2", "DiversitySamplingPlots");
            DiversityWorkbench.Export.Table TPlot = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventLocalisation", "Plot", DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForLocalisationSystem(Specimen.OverviewImageLocalisationSystem.SamplingPlot), Parent, null, TPlotM, "LocalisationSystemID = 13");

            System.Collections.Generic.Dictionary<string, string> T_GK_M = new Dictionary<string, string>();
            T_GK_M.Add("ResponsibleAgentURI", "DiversityAgents");
            DiversityWorkbench.Export.Table T_GK = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventLocalisation", "Gauss Krger", DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForLocalisationSystem(Specimen.OverviewImageLocalisationSystem.GaussKrueger), Parent, null, T_GK_M, "LocalisationSystemID = 2");

            System.Collections.Generic.Dictionary<string, string> TMTBM = new Dictionary<string, string>();
            TMTBM.Add("ResponsibleAgentURI", "DiversityAgents");
            DiversityWorkbench.Export.Table TMTB = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventLocalisation", "MTB", DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForLocalisationSystem(Specimen.OverviewImageLocalisationSystem.MTB), Parent, null, TMTBM, "LocalisationSystemID = 3");

        }

        private void ExportWizardEventPropertyTables(DiversityWorkbench.Export.Table Parent)
        {
            System.Collections.Generic.Dictionary<string, string> T_Chronostratigraphy_M = new Dictionary<string, string>();
            T_Chronostratigraphy_M.Add("PropertyURI", "DiversityScientificTerms");
            T_Chronostratigraphy_M.Add("ResponsibleAgentURI", "DiversityAgents");
            DiversityWorkbench.Export.Table T_Chronostratigraphy = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventProperty", "Chronostratigraphy", DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForCollectionEventProperty(20), Parent, null, T_Chronostratigraphy_M, "PropertyID = 20");

            System.Collections.Generic.Dictionary<string, string> T_Lithostratigraphy_M = new Dictionary<string, string>();
            T_Lithostratigraphy_M.Add("PropertyURI", "DiversityScientificTerms");
            T_Lithostratigraphy_M.Add("ResponsibleAgentURI", "DiversityAgents");
            DiversityWorkbench.Export.Table T_Lithostratigraphy = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventProperty", "Lithostratigraphy", DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForCollectionEventProperty(false, "Stratigraphy"), Parent, null, T_Lithostratigraphy_M, "PropertyID = 30");

            System.Collections.Generic.Dictionary<string, string> T_Biostratigraphy_M = new Dictionary<string, string>();
            T_Biostratigraphy_M.Add("PropertyURI", "DiversityScientificTerms");
            T_Biostratigraphy_M.Add("ResponsibleAgentURI", "DiversityAgents");
            DiversityWorkbench.Export.Table T_Biostratigraphy = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventProperty", "Biostratigraphy", DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForCollectionEventProperty(false, "Stratigraphy"), Parent, null, T_Biostratigraphy_M, "PropertyID = 60");

            System.Collections.Generic.Dictionary<string, string> T_Lebensraum_M = new Dictionary<string, string>();
            T_Lebensraum_M.Add("PropertyURI", "DiversityScientificTerms");
            T_Lebensraum_M.Add("ResponsibleAgentURI", "DiversityAgents");
            DiversityWorkbench.Export.Table T_Lebensraum = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventProperty", "Lebensraum", DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForCollectionEventProperty(false, "Vegetation"), Parent, null, T_Lebensraum_M, "PropertyID = 40");

            System.Collections.Generic.Dictionary<string, string> T_BiotoptypenBfN_M = new Dictionary<string, string>();
            T_BiotoptypenBfN_M.Add("PropertyURI", "DiversityScientificTerms");
            T_BiotoptypenBfN_M.Add("ResponsibleAgentURI", "DiversityAgents");
            DiversityWorkbench.Export.Table T_BiotoptypenBfN = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventProperty", "Biotoptypen", DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForCollectionEventProperty(false, "Vegetation"), Parent, null, T_BiotoptypenBfN_M, "PropertyID = 41");

            System.Collections.Generic.Dictionary<string, string> T_Pflanzengesellschaft_M = new Dictionary<string, string>();
            T_Pflanzengesellschaft_M.Add("PropertyURI", "DiversityScientificTerms");
            T_Pflanzengesellschaft_M.Add("ResponsibleAgentURI", "DiversityAgents");
            DiversityWorkbench.Export.Table T_Pflanzengesellschaft = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventProperty", "Pflanzengesellschaft", DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForCollectionEventProperty(false, "Vegetation"), Parent, null, T_Lebensraum_M, "PropertyID = 50");

            System.Collections.Generic.Dictionary<string, string> T_Eunis_M = new Dictionary<string, string>();
            T_Eunis_M.Add("PropertyURI", "DiversityScientificTerms");
            T_Eunis_M.Add("ResponsibleAgentURI", "DiversityAgents");
            DiversityWorkbench.Export.Table T_Eunis = DiversityWorkbench.Export.Exporter.AddTemplateTable("CollectionEventProperty", "EUNIS", DiversityWorkbench.Export.Table.Parallelity.restricted, DiversityCollection.Specimen.ImageForCollectionEventProperty(false, "Vegetation"), Parent, null, T_Eunis_M, "PropertyID = 1");

        }
        
        #endregion

        #endregion

        #region Archive

        private void createArchiveToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                this.Enabled = false;

                // Show start window
                DiversityWorkbench.Import.FormStartWizard fs = new DiversityWorkbench.Import.FormStartWizard("Initialise archive ...", "Archive", DiversityCollection.Resource.ArchivCreate);
                fs.Show();
                Application.DoEvents();

                DiversityWorkbench.Archive.FormCreateArchive f = new DiversityWorkbench.Archive.FormCreateArchive(
                    "Select the project you want to create an archive from",
                    "ProjectProxy",
                    "Project",
                    "ProjectID",
                    " WHERE ProjectID IN (SELECT ProjectID FROM ProjectList)",
                    "CollectionProject",
                    "CollectionSpecimenID",
                    "ArchiveProtocol",
                    this.ArchiveTables(),
                    "ProjectDataLastChanges");

                // Close start window
                fs.Close();

                f.setHelp("Archive");
                f.ShowDialog();
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.Enabled = true;
            }
        }

        private System.Collections.Generic.Dictionary<string, string> ArchiveTables()
        {
            System.Collections.Generic.Dictionary<string, string> DataTables = new Dictionary<string, string>();
            DataTables.Add("CollectionProject", "ProjectProxy");
            DataTables.Add("CollectionSpecimen", "CollectionProject");
            // Event tables
            DataTables.Add("CollectionEvent", "CollectionSpecimen");
            DataTables.Add("CollectionEventSeries", "CollectionEvent");
            DataTables.Add("CollectionEventSeriesImage", "CollectionEventSeries");
            DataTables.Add("CollectionEventLocalisation", "CollectionEvent");
            DataTables.Add("CollectionEventProperty", "CollectionEvent");
            DataTables.Add("CollectionEventImage", "CollectionEvent");
            DataTables.Add("CollectionEventMethod", "CollectionEvent");
            DataTables.Add("CollectionEventParameterValue", "CollectionEventMethod");
            // Specimen related tables
            DataTables.Add("CollectionSpecimenImage", "CollectionSpecimen");
            DataTables.Add("CollectionSpecimenImageProperty", "CollectionSpecimenImage");
            DataTables.Add("CollectionAgent", "CollectionSpecimen");
            DataTables.Add("CollectionSpecimenReference", "CollectionSpecimen");
            DataTables.Add("CollectionSpecimenRelation", "CollectionSpecimen");
            DataTables.Add("CollectionExternalDatasource", "CollectionSpecimen");
            // Unit related tables
            DataTables.Add("IdentificationUnit", "CollectionSpecimen");
            DataTables.Add("Identification", "IdentificationUnit");
            DataTables.Add("IdentificationUnitGeoAnalysis", "IdentificationUnit");
            DataTables.Add("IdentificationUnitInPart", "IdentificationUnit");
            // Analyis related tables
            DataTables.Add("IdentificationUnitAnalysis", "IdentificationUnit");
            DataTables.Add("IdentificationUnitAnalysisMethod", "IdentificationUnitAnalysis");
            DataTables.Add("IdentificationUnitAnalysisMethodParameter", "IdentificationUnitAnalysisMethod");
            DataTables.Add("Analysis", "IdentificationUnitAnalysis|ProjectAnalysis|ProjectProcessing");
            DataTables.Add("AnalysisResult", "Analysis");
            DataTables.Add("AnalysisTaxonomicGroup", "Analysis");
            DataTables.Add("ProjectAnalysis", "ProjectProxy");
            // Part related tables
            DataTables.Add("CollectionSpecimenPart", "CollectionSpecimen");
            DataTables.Add("Collection", "CollectionSpecimenPart|Transaction|CollectionSpecimenRelation|CollectionSpecimenReference");
            DataTables.Add("CollectionImage", "Collection");
            // Processing related tables
            DataTables.Add("CollectionSpecimenProcessing", "CollectionSpecimenPart");
            DataTables.Add("CollectionSpecimenProcessingMethod", "CollectionSpecimenProcessing");
            DataTables.Add("CollectionSpecimenProcessingMethodParameter", "CollectionSpecimenProcessingMethod");
            DataTables.Add("Processing", "CollectionSpecimenProcessing");
            DataTables.Add("ProcessingMaterialCategory", "Processing");
            DataTables.Add("ProjectProcessing", "ProjectProxy");
            // Transaction tables
            DataTables.Add("CollectionSpecimenTransaction", "CollectionSpecimenPart");
            DataTables.Add("Transaction", "CollectionSpecimenTransaction");
            DataTables.Add("TransactionPayment", "Transaction");
            DataTables.Add("TransactionDocument", "Transaction");
            DataTables.Add("TransactionAgent", "Transaction");
            // ExternalIdentifier
            DataTables.Add("ExternalIdentifier", "");// "ReferencedTable.ReferencedID");
            DataTables.Add("ExternalIdentifierType", "ExternalIdentifier");
            // Annotation
            DataTables.Add("Annotation", "");
            DataTables.Add("AnnotationType_Enum", "");
            // Method
            DataTables.Add("MethodForProcessing", "CollectionSpecimenProcessingMethod");
            DataTables.Add("MethodForAnalysis", "IdentificationUnitAnalysisMethod");
            DataTables.Add("Method", "CollectionEventMethod|MethodForProcessing|MethodForAnalysis");
            DataTables.Add("Parameter", "Method");
            DataTables.Add("ParameterValue_Enum", "Parameter");

            return DataTables;
        }

        private void restoreArchiveToolStripMenuItem_Click(object sender, EventArgs e)
        {
            System.Collections.Generic.List<string> TableList = new List<string>();
            // Project
            TableList.Add("ProjectProxy");
            // Method tables
            TableList.Add("Method");
            TableList.Add("Parameter");
            TableList.Add("ParameterValue_Enum");
            // Event tables
            TableList.Add("CollectionEventSeries");
            TableList.Add("CollectionEventSeriesImage");
            TableList.Add("CollectionEvent");
            TableList.Add("CollectionEventLocalisation");
            TableList.Add("CollectionEventProperty");
            TableList.Add("CollectionEventImage");
            TableList.Add("CollectionEventMethod");
            TableList.Add("CollectionEventParameterValue");
            // Specimen
            TableList.Add("CollectionExternalDatasource");
            TableList.Add("CollectionSpecimen");
            TableList.Add("CollectionProject");
            TableList.Add("CollectionSpecimenImage");
            TableList.Add("CollectionSpecimenImageProperty");
            TableList.Add("CollectionAgent");
            // Unit
            TableList.Add("IdentificationUnit");
            TableList.Add("Identification");
            TableList.Add("IdentificationUnitGeoAnalysis");
            // Collection and Part related tables
            TableList.Add("Collection");
            TableList.Add("CollectionImage");
            TableList.Add("CollectionSpecimenPart");
            TableList.Add("IdentificationUnitInPart");
            // Analyis related tables
            TableList.Add("Analysis");
            TableList.Add("MethodForAnalysis");
            TableList.Add("AnalysisResult");
            TableList.Add("AnalysisTaxonomicGroup");
            TableList.Add("ProjectAnalysis");
            TableList.Add("IdentificationUnitAnalysis");
            TableList.Add("IdentificationUnitAnalysisMethod");
            TableList.Add("IdentificationUnitAnalysisMethodParameter");
            // Reference
            TableList.Add("CollectionSpecimenReference");
            // Relation
            TableList.Add("CollectionSpecimenRelation");
            // Processing related tables
            TableList.Add("Processing");
            TableList.Add("MethodForProcessing");
            TableList.Add("ProcessingMaterialCategory");
            TableList.Add("ProjectProcessing");
            TableList.Add("CollectionSpecimenProcessing");
            TableList.Add("CollectionSpecimenProcessingMethod");
            TableList.Add("CollectionSpecimenProcessingMethodParameter");
            // Transaction tables
            TableList.Add("Transaction");
            TableList.Add("CollectionSpecimenTransaction");
            TableList.Add("TransactionPayment");
            TableList.Add("TransactionDocument");
            TableList.Add("TransactionAgent");
            // ExternalIdentifier
            TableList.Add("ExternalIdentifierType");
            TableList.Add("ExternalIdentifier");
            // Annotation
            TableList.Add("AnnotationType_Enum");
            TableList.Add("Annotation");

            DiversityWorkbench.Archive.FormRestoreArchive f = new DiversityWorkbench.Archive.FormRestoreArchive(
                "Restore an archive of DiversityCollection", TableList);
            f.setHelp("Archive");
            f.ShowDialog();
            if (f.ProjectID() != null)
            {
                // Insert the current user
                string SQL = "INSERT INTO UserProxy (LoginName, CombinedNameCache, CurrentProjectID) " +
                    "VALUES (SUSER_SNAME(), SUSER_SNAME()," + f.ProjectID().ToString() + ")";
                DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL);
                SQL = "INSERT INTO UserProxy (LoginName, CombinedNameCache, CurrentProjectID) " +
                    "SELECT USER_NAME(), SUSER_SNAME(), " + f.ProjectID().ToString() + " WHERE SUSER_SNAME() != USER_NAME()";
                DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL);
                // Insert the projects for the user
                SQL = "INSERT INTO ProjectUser (LoginName, ProjectID, ReadOnly) " +
                    "select SUSER_SNAME(), " + f.ProjectID().ToString() + ", 0";
                DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL);
                SQL = "INSERT INTO ProjectUser (LoginName, ProjectID, ReadOnly) " +
                    "select USER_NAME(), " + f.ProjectID().ToString() + ", 0 WHERE SUSER_SNAME() != USER_NAME()";
                DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL);
                // Requery project list
                this.initQuery();
            }
        }
        
        private void administrateArchivesToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Archive.FormArchiveAdministration f = new DiversityWorkbench.Archive.FormArchiveAdministration(
                this.ArchiveTables(),
                "Administrate the scheduler based creation of archives",
                "ProjectProxy",
                "Project",
                "ProjectID",
                "CreateArchive",
                "ArchiveProtocol",
                " WHERE ProjectID IN (SELECT ProjectID FROM ProjectList)");
            f.setHelp("Archive");
            f.ShowDialog();
        }

        private void resetDatabaseToolStripMenuItem_Click(object sender, EventArgs e)
        {
            System.Collections.Generic.List<string> Tables = new List<string>();
            Tables.Add("ReplicationPublisher");
            Tables.Add("ProjectProcessing");
            Tables.Add("ProjectAnalysis");
            Tables.Add("ProcessingMaterialCategory");
            Tables.Add("IdentificationUnitInPart");
            Tables.Add("IdentificationUnitGeoAnalysis");
            Tables.Add("Identification");
            Tables.Add("IdentificationUnitAnalysisMethodParameter");
            Tables.Add("IdentificationUnitAnalysisMethod");
            Tables.Add("IdentificationUnitAnalysis");
            Tables.Add("IdentificationUnit");
            Tables.Add("ExternalRequestCredentials");
            Tables.Add("CollectionUser");
            Tables.Add("CollectionSpecimenTransaction");
            Tables.Add("CollectionSpecimenReference");
            Tables.Add("CollectionSpecimenRelation");
            Tables.Add("CollectionSpecimenProcessingMethodParameter");
            Tables.Add("CollectionSpecimenProcessingMethod");
            Tables.Add("CollectionSpecimenProcessing");
            Tables.Add("Processing");
            Tables.Add("CollectionSpecimenPart");
            Tables.Add("CollectionSpecimenImageProperty");
            Tables.Add("CollectionSpecimenImage");
            Tables.Add("CollectionSpecimen");
            Tables.Add("CollectionRequester");
            Tables.Add("CollectionProject");
            Tables.Add("CollectionManager");
            Tables.Add("CollectionImage");
            Tables.Add("CollectionExternalDatasource");
            Tables.Add("CollectionEventProperty");
            Tables.Add("CollectionEventParameterValue");
            Tables.Add("CollectionEventMethod");
            Tables.Add("CollectionEventLocalisation");
            Tables.Add("CollectionEventImage");
            Tables.Add("CollectionEvent");
            Tables.Add("CollectionEventSeriesImage");
            Tables.Add("CollectionEventSeries");
            Tables.Add("ParameterValue_Enum");
            Tables.Add("Parameter");
            Tables.Add("MethodForProcessing");
            Tables.Add("MethodForAnalysis");
            Tables.Add("Method");
            Tables.Add("CollectionAgent");
            Tables.Add("CacheDatabase");
            Tables.Add("ApplicationSearchSelectionStrings");
            Tables.Add("AnonymCollector");
            Tables.Add("ExternalIdentifier");
            Tables.Add("Annotation");
            Tables.Add("AnalysisTaxonomicGroup");
            Tables.Add("AnalysisResult");
            Tables.Add("Analysis");
            Tables.Add("ProjectUser");
            Tables.Add("ProjectProxy");
            Tables.Add("UserProxy");
            Tables.Add("TransactionPayment");
            Tables.Add("TransactionDocument");
            Tables.Add("TransactionAgent");
            Tables.Add("Transaction");
            Tables.Add("Collection");
            DiversityWorkbench.Archive.FormResetDatabase f = new DiversityWorkbench.Archive.FormResetDatabase(Tables);
            f.setHelp("Archive");
            f.ShowDialog();
        }

        #endregion

        #region Cache database
        
        private void cacheDatabaseToolStripMenuItem1_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            DiversityCollection.CacheDatabase.FormCacheDatabase f = new CacheDatabase.FormCacheDatabase();
            f.setHelp("Cache database");
            this.Cursor = System.Windows.Forms.Cursors.Default;
            try
            {
                f.ShowDialog();
            }
            catch (System.Exception ex)
            {
            }
        }
        
        #endregion

        #region Project and transaction transfer

        private void toCollectionToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (this.userControlQueryList.ListOfIDs.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }
            DiversityCollection.FormCollection f = new FormCollection(null);
            f.ShowInTaskbar = true;
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                string Message = "Transfer all " + this.userControlQueryList.ListOfIDs.Count.ToString() + " specimen into the collection " + f.DisplayText;
                if (System.Windows.Forms.MessageBox.Show(Message, "Transfer to collection", MessageBoxButtons.OKCancel) == System.Windows.Forms.DialogResult.OK)
                {
                    this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                    try
                    {
                        string SQL = "";
                        foreach (int i in this.userControlQueryList.ListOfIDs)
                        {
                            if (SQL.Length > 0)
                                SQL += ", ";
                            SQL += i.ToString();
                        }
                        SQL = "UPDATE P SET CollectionID = " + f.ID.ToString() + " FROM CollectionSpecimenPart P WHERE P.CollectionSpecimenID IN (" + SQL + ")";
                        Message = "";
                        if (DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL, ref Message))
                        {
                            System.Windows.Forms.MessageBox.Show(this.userControlQueryList.ListOfIDs.Count.ToString() + " specimen transferred into the collection " + f.DisplayText);
                        }
                        else
                            System.Windows.Forms.MessageBox.Show("Transfer failed: " + Message);
                    }
                    catch(System.Exception ex)
                    {

                    }
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                }
            }
        }

        private void transerToProjectToolStripMenuItem_Click(object sender, EventArgs e)
        {
            System.Data.DataTable dtProjects = DiversityCollection.LookupTable.DtProject;
            DiversityWorkbench.FormGetStringFromList f = new DiversityWorkbench.FormGetStringFromList(dtProjects, "Project", "ProjectID", "Project", "Please select the additional project for the specimen");
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                int ProjectID = int.Parse(f.SelectedValue);
                string Project = f.SelectedString;
                int i = 0;
                try
                {
                    foreach (int ID in this.userControlQueryList.ListOfIDs)
                    {
                        string SQL = "INSERT INTO CollectionProject " +
                            "(CollectionSpecimenID, ProjectID) " +
                            "SELECT    CollectionSpecimenID, " + ProjectID.ToString() + " AS ProjectID FROM CollectionSpecimen " +
                            "WHERE  CollectionSpecimenID = " + ID.ToString() + " AND   (NOT EXISTS " +
                            "(SELECT     CollectionSpecimenID " +
                            "FROM          CollectionProject AS CollectionProject_1 " +
                            "WHERE      (CollectionSpecimenID = " + ID.ToString() + ") AND (ProjectID = " + ProjectID.ToString() + ")))";
                        DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL);
                        i++;
                    }
                }
                catch (Exception ex)
                {
                    System.Windows.Forms.MessageBox.Show(ex.Message);
                }
                this.Cursor = System.Windows.Forms.Cursors.Default;
                System.Windows.Forms.MessageBox.Show(i.ToString() + " specimens are now placed project\r\n" + Project);
            }
        }

        private void transferTransactionToolStripMenuItem_Click(object sender, EventArgs e)
        {
            //DiversityCollection.FormTransaction f = new FormTransaction("WHERE TransactionType NOT IN ('return', 'forwarding')", "Transfer to transaction");
            DiversityCollection.FormTransaction f = new FormTransaction(true);
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                int TransactionID = f.ID;
                string Transaction = f.TransactionTitle;
                string TransactionType = f.TypeOfTransaction;

                // Checking for a collection
                int? CollectionID = null;
                DiversityWorkbench.FormGetItemFromHierarchy fColl = new DiversityWorkbench.FormGetItemFromHierarchy(DiversityCollection.LookupTable.DtCollectionWithHierarchy, "CollectionID", "CollectionParentID", "CollectionName", "CollectionID", "Do you want to restrict the transfer to a certain collection?", "Restrict to collection?");
                fColl.ShowDialog();
                int CID;
                if (fColl.DialogResult == System.Windows.Forms.DialogResult.OK && fColl.SelectedValue.Length > 0)
                {
                    if (int.TryParse(fColl.SelectedValue, out CID))
                        CollectionID = CID;
                }

                // Checking for a material category
                string MatCat = "";
                System.Data.DataTable dtMat = DiversityWorkbench.EnumTable.EnumTableForQuery("CollMaterialCategory_Enum", false, false, true);
                DiversityWorkbench.FormGetStringFromList fMat = new DiversityWorkbench.FormGetStringFromList(dtMat, "DisplayText", "Code", "Restrict to material?", "Do you want to restrict the transfer to the transaction to a material category?");
                fMat.ShowDialog();
                if (fMat.DialogResult == System.Windows.Forms.DialogResult.OK)
                    MatCat = fMat.SelectedValue;
                int iFailedReturns = 0;
                int i = 0;
                try
                {
                    foreach (int ID in this.userControlQueryList.ListOfIDs)
                    {
                        if (TransactionType == "return" || TransactionType == "forwarding")
                        {
                            string SqlReturn = "SELECT COUNT(*) " +
                                "FROM CollectionSpecimenTransaction CL, [Transaction] TL,  [Transaction] TR " +
                                "WHERE TR.TransactionID = " + TransactionID.ToString() + " " +
                                "AND TL.TransactionType = 'loan' " +
                                "AND CL.TransactionID = TL.TransactionID " +
                                "AND CL.CollectionSpecimenID = " + ID.ToString() + " " +
                                "AND TR.ParentTransactionID = TL.TransactionID ";
                            if (DiversityWorkbench.FormFunctions.SqlExecuteScalar(SqlReturn) == "0")
                            {
                                iFailedReturns++;
                                continue;
                            }
                        }
                        string SqlSource = "FROM CollectionSpecimenPart AS P " +
                            "WHERE (CollectionSpecimenID = " + ID.ToString() + ") AND (NOT EXISTS " +
                            "(SELECT CollectionSpecimenID " +
                            "FROM CollectionSpecimenTransaction AS T " +
                            "WHERE (CollectionSpecimenID = " + ID.ToString() + ") AND (TransactionID = " + TransactionID.ToString() + ") " +
                            "AND T.SpecimenPartID = P.SpecimenPartID))";
                        if (CollectionID != null)
                            SqlSource += " AND P.CollectionID = " + CollectionID.ToString();
                        if (MatCat.Length > 0)
                            SqlSource += " AND P.MaterialCategory = '" + MatCat + "'";
                        string SqlTest = "SELECT COUNT(*) " + SqlSource;
                        int iParts = 0;
                        if (int.TryParse(DiversityWorkbench.FormFunctions.SqlExecuteScalar(SqlTest), out iParts) && iParts > 0)
                        {
                            i += iParts;
                            string SQL = "INSERT INTO CollectionSpecimenTransaction " +
                                "(CollectionSpecimenID, TransactionID, SpecimenPartID, IsOnLoan, AccessionNumber) " +
                                "SELECT  CollectionSpecimenID, " + TransactionID.ToString() + " AS TransactionID, SpecimenPartID, 1 AS IsOnLoan, AccessionNumber " +
                                SqlSource + "; ";
                            if (TransactionType == "return" || TransactionType == "forwarding")
                            {
                                SQL = "BEGIN TRY BEGIN TRANSACTION TR " 
                                    + SQL
                                    + " UPDATE CL SET CL.TransactionReturnID = " + TransactionID.ToString() + " " +
                                    "FROM CollectionSpecimenTransaction CL, [Transaction] TL,  [Transaction] TR " +
                                    "WHERE TR.TransactionID = " + TransactionID.ToString() + " " +
                                    "AND TL.TransactionType = 'loan' " +
                                    "AND CL.TransactionID = TL.TransactionID " +
                                    "AND CL.CollectionSpecimenID = " + ID.ToString() + " " +
                                    "AND TR.ParentTransactionID = TL.TransactionID "
                                    + " COMMIT TRANSACTION TR END TRY BEGIN CATCH ROLLBACK TRANSACTION TR END CATCH ";
                            }
                            DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL);
                        }
                    }
                }
                catch (Exception ex)
                {
                    System.Windows.Forms.MessageBox.Show(ex.Message);
                }
                this.Cursor = System.Windows.Forms.Cursors.Default;
                string Message =  i.ToString() + " parts of the selected specimens";
                if (CollectionID != null)
                    Message += " within collection " + fColl.SelectedString;
                if (MatCat.Length > 0)
                    Message += " of the material category " + MatCat;
                Message += " are now included in the transaction\r\n" + Transaction;
                if ((TransactionType == "return" || TransactionType == "forwarding") && iFailedReturns > 0)
                    Message += "\r\n\r\n" + iFailedReturns.ToString() + " parts could not be included because no matching loan was found for the " + TransactionType;
                System.Windows.Forms.MessageBox.Show(Message);
            }
        }

        private void removeFromProjectToolStripMenuItem_Click(object sender, EventArgs e)
        {
            //System.Data.DataTable dtProjects = DiversityCollection.LookupTable.DtProject;
            System.Data.DataTable dtProjects = DiversityCollection.LookupTable.DtProjectList;
            DiversityWorkbench.FormGetStringFromList f = new DiversityWorkbench.FormGetStringFromList(dtProjects, "Project", "ProjectID", "Remove from project", "Please select the project from which the specimens should be REMOVED");
            f.ForeColor = System.Drawing.Color.Red;
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                int ProjectID = int.Parse(f.SelectedValue);
                string Project = f.SelectedString;
                int i = 0;
                int iNot = 0;
                try
                {
                    foreach (int ID in this.userControlQueryList.ListOfIDs)
                    {
                        string SQL = " FROM CollectionProject P " +
                            "WHERE  CollectionSpecimenID = " + ID.ToString() + " AND ProjectID = " + ProjectID.ToString() +
                            " AND (EXISTS " +
                            "(SELECT CollectionSpecimenID " +
                            "FROM CollectionProject AS CollectionProject_1 " +
                            "WHERE (CollectionSpecimenID = " + ID.ToString() + ") AND (ProjectID <> " + ProjectID.ToString() + ")))";
                        int CC = 0;
                        if (int.TryParse(DiversityWorkbench.FormFunctions.SqlExecuteScalar("SELECT COUNT(*) " + SQL).ToString(), out CC) && CC > 0)
                        {
                            if (DiversityWorkbench.FormFunctions.SqlExecuteNonQuery("DELETE P " + SQL))
                                i++;
                        }
                        else iNot++;
                    }
                }
                catch (Exception ex)
                {
                    System.Windows.Forms.MessageBox.Show(ex.Message);
                }
                this.Cursor = System.Windows.Forms.Cursors.Default;
                string Message = i.ToString() + " specimens where removed";
                if (iNot > 0)
                    Message += "\r\n" + iNot.ToString() + " specimens could not be removed";
                Message += "\r\nfrom project\r\n" + Project;
                System.Windows.Forms.MessageBox.Show(Message);
            }
        }
        
        #endregion

        #region others ...

        private void allIdentifierToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                //System.Data.DataTable dtIdentifierType = new DataTable();
                //string SQL = "SELECT Type FROM ExternalIdentifierType";
                //System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                //ad.Fill(dtIdentifierType);

                DiversityCollection.Forms.FormExternalIdentifier f = new Forms.FormExternalIdentifier(this.dataSetCollectionSpecimen.ExternalIdentifier, DiversityWorkbench.ReferencingTable.IdentifierType.ID);// new DiversityWorkbench.Forms.FormAnnotation(this, dtIdentifierType, "All identifiers", this.helpProviderDiversityCollection.HelpNamespace);// (this.dataSetCollectionSpecimen, dtAnnotationType, "All annotations", this.helpProviderDiversityCollection.HelpNamespace);
                f.ShowDialog();
            }
            catch(System.Exception ex) { }
        }

        private void allAnnotationsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataTable dtAnnotationType = new DataTable();
                string SQL = "SELECT Code FROM AnnotationType_Enum";
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dtAnnotationType);

                DiversityWorkbench.Forms.FormAnnotation f = new DiversityWorkbench.Forms.FormAnnotation(this, dtAnnotationType, "All annotations", this.helpProviderDiversityCollection.HelpNamespace);// (this.dataSetCollectionSpecimen, dtAnnotationType, "All annotations", this.helpProviderDiversityCollection.HelpNamespace);
                f.ShowDialog();
            }
            catch { }
        }

        private void removeSpecimenToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (this.userControlQueryList.ListOfIDs.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }
            DiversityCollection.Forms.FormRemoveSpecimen f = new Forms.FormRemoveSpecimen(this.userControlQueryList.ListOfIDs);
            f.StartPosition = FormStartPosition.CenterParent;
            f.ShowDialog();
        }

        private void recoverFromLogToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.Enabled = false;
            DiversityWorkbench.Data.Restore.RestoreFromLog(this.RestoreRootTables());
            this.Enabled = true;
        }

        private void withholdDataToolStripMenuItem_Click(object sender, EventArgs e)
        {
            //System.Windows.Forms.MessageBox.Show("Available in upcoming version");
            if (this.IDs.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }
            else if (this.IDs.Count > 1000)
            {
                System.Windows.Forms.MessageBox.Show("You selected more than 1000 entries. Please reduce your selection");
                return;
            }
            DiversityCollection.Forms.FormDatawithholding f = new Forms.FormDatawithholding(this.IDs);
            f.ShowDialog();
        }

        private string SqlRestoreDataset(string Restriction, System.DateTime From, System.DateTime Until)
        {
            string SQL = "SELECT CASE WHEN count(*) = 1 then CAST(1 AS bit) else CAST(0 AS bit) end AS OK, L.AccessionNumber, count(*) AS Quantity, MIN(L.CollectionSpecimenID) AS FirstID , MAX(L.CollectionSpecimenID) AS LastID " +
                "FROM [dbo].[CollectionSpecimen_log] L " +
                "WHERE L.CollectionSpecimenID not in ( " +
                "SELECT [CollectionSpecimenID] " +
                "FROM [dbo].[CollectionSpecimen] " +
                ") and L.AccessionNumber <> '' " +
                "and L.LogState = 'D' " +
                "and L.LogDate between '" + From.Year.ToString() + "-" + From.Month.ToString() + "-" + From.Day.ToString() + "' and '" + Until.Year.ToString() + "-" + Until.Month.ToString() + "-" + Until.Day.ToString() + "' " +
                "and L.AccessionNumber like '" + Restriction + "%'" +
                "group by L.AccessionNumber" +
                "order by L.AccessionNumber";
            return SQL;
        }
        
        #endregion

        #endregion

        #region Query

        private void showQueryToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.showQueryToolStripMenuItem.Checked)
                {
                    this.splitContainerMain.Panel1Collapsed = true;
                    this.showQueryToolStripMenuItem.Checked = false;
                    this.userControlQueryList.Visible = false;
                }
                else
                {
                    this.splitContainerMain.Panel1Collapsed = false;
                    this.showQueryToolStripMenuItem.Checked = true;
                    this.userControlQueryList.Visible = true;
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #region Menu - Predefined statements

        /// <summary>
        /// Event for the MenuItems in the search menu
        /// </summary>
        /// <param name="sender">The Menu Item</param>
        /// <param name="e"></param>
        private void menuItemSearchOnClick(object sender, System.EventArgs e)
        {
            System.Windows.Forms.ToolStripMenuItem m = (System.Windows.Forms.ToolStripMenuItem)sender;
            string s = m.Text;
            s = s.Substring(s.IndexOf(" - ") + 2).Trim();
            try
            {
                System.Data.DataRow[] rr = this.dtApplicationSearchSelectionStrings.Select("SqlStringIdentifier = '" + s.ToString() + "'");
                System.Data.DataRow r = rr[0];
                string SQL = r["SQLString"].ToString();
                string Description = r["Description"].ToString();
                string Table = r["ItemTable"].ToString();
                if (SQL.Length > 0)
                {
                    this.userControlQueryList.IsPredefinedQuery = true;
                    this.userControlQueryList.setQueryConditions(s, Table, SQL, Description);
                    //this.userControlQueryList.setQueryConditions(s, Table, SQL);
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        /// <summary>
        /// building the menu for editing the data. For predefined entries menuItems are added
        /// </summary>
        public void buildSearchMenu()
        {
            try
            {
                this.FormFunctions.buildSearchMenu(ref this.predefinedQueriesToolStripMenuItem, ref this.dtApplicationSearchSelectionStrings, this.menuItemSearchOnClick);
                this.userControlQueryList.setPredefinedQueryPersistentConditionList(this.CollectionSpecimen.PredefinedQueryPersistentConditionList());
            }
            catch (System.Exception ex) { }
        }

        #endregion

        #region Scan mode

        private enum ScanTargets { SpecimenAccessionNumber, CollectionSpecimenID, PartAccessionNumber, UnitIdentifier, CollectionCode };
        private ScanTargets _ScanTarget = ScanTargets.SpecimenAccessionNumber;

        private void scanModeToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (this._ViewMode != ViewMode.Scanmode)
            {
                this._ViewMode = ViewMode.Scanmode;
                this.toolStripDropDownButtonScanTarget.Visible = true;
                this.toolStripScanTarget.Visible = true;
                this.textBoxHeaderAccessionNumber.Visible = true;
                switch (this._ScanTarget)
                {
                    case ScanTargets.CollectionSpecimenID:
                        this.labelHeaderAccessionNumber.Text = toolStripMenuItemScanTargetSpecimenID.Text;
                        break;
                    case ScanTargets.SpecimenAccessionNumber:
                        this.labelHeaderAccessionNumber.Text = toolStripMenuItemScanTargetSpecimenAccessionNumber.Text;
                        break;
                    case ScanTargets.PartAccessionNumber:
                        this.labelHeaderAccessionNumber.Text = toolStripMenuItemScanTargetPartAccessionNumber.Text;
                        break;
                    case ScanTargets.UnitIdentifier:
                        this.labelHeaderAccessionNumber.Text = toolStripMenuItemScanTargetUnitIdentifier.Text;
                        break;
                    case ScanTargets.CollectionCode:
                        this.labelHeaderAccessionNumber.Text = this.toolStripMenuItemScanTargetCollection.Text;;
                        break;
                }
            }
            else
            {
                this._ViewMode = ViewMode.Default;
                this.toolStripDropDownButtonScanTarget.Visible = false;
                this.toolStripScanTarget.Visible = false;
                this.labelHeaderAccessionNumber.Text = "Acc.Nr.";
                this.textBoxHeaderAccessionNumber.Visible = false;
            }
            this.setViewMode();
        }

        private void scanModeCollectionToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (this._ViewMode != ViewMode.CollectionScanMode)
            {
                this._ViewMode = ViewMode.CollectionScanMode;
                this.toolStripDropDownButtonScanTarget.Visible = false;
                this.toolStripScanTarget.Visible = false;
                this.textBoxHeaderAccessionNumber.Visible = true;
                this._ScanTarget = ScanTargets.CollectionCode;
                //this.userControlQueryList.IsPredefinedQuery = true;
                //this.userControlQueryList.setQueryConditions("Collection", "CollectionSpecimen", "WHERE 1 = 0", "Content of a collection ");
                //this.pictureBoxScanner.Image = DiversityCollection.Resource.ScannerCollection;
            }
            else
            {
                this._ViewMode = ViewMode.Default;
                this.toolStripDropDownButtonScanTarget.Visible = false;
                this.toolStripScanTarget.Visible = false;
                this.labelHeaderAccessionNumber.Text = "Acc.Nr.";
                this.textBoxHeaderAccessionNumber.Visible = false;
                //this.userControlQueryList.IsPredefinedQuery = false;
                //this.userControlQueryList.setQueryConditions(this.CollectionSpecimen.QueryConditions(), DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.QueryConditionVisibility.ToString());
                //this.pictureBoxScanner.Image = DiversityCollection.Resource.ScannerBarcode;
            }
            this.setViewMode();
            this.tableLayoutPanelHeader.Visible = true;
        }

        private void textBoxHeaderAccessionNumber_MouseEnter(object sender, EventArgs e)
        {
            if (this.scanModeToolStripMenuItem.Checked)
            {
                this.textBoxHeaderAccessionNumber.Focus();
                this.textBoxHeaderAccessionNumber.SelectAll();
            }
        }

        private void textBoxHeaderAccessionNumber_TextChanged(object sender, EventArgs e)
        {
            if (this.scanModeToolStripMenuItem.Checked)
            {
                this.startScanner();
            }
        }

        private void textBoxCollectionScanner_TextChanged(object sender, EventArgs e)
        {
            if (this.scanModeCollectionToolStripMenuItem.Checked)
            {
                this.startScanner();
            }
        }

        private void textBoxCollectionScanner_MouseEnter(object sender, EventArgs e)
        {
            if (this.scanModeCollectionToolStripMenuItem.Checked)
            {
                this.textBoxCollectionScanner.Focus();
                this.textBoxCollectionScanner.SelectAll();
            }
        }

        private void pictureBoxScanner_Click(object sender, EventArgs e)
        {
            this.setTimerIntervall();
        }

        /// <summary>
        /// Setting the timer intervall for the Scanner
        /// </summary>
        private void setTimerIntervall()
        {
            DiversityWorkbench.FormGetInteger f = new DiversityWorkbench.FormGetInteger(DiversityCollection.Forms.FormTransactionSettings.Default.TimerIntervall,
                "Timer intervall", "Please give a value for the timer intervall of the scanner in milliseconds");
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                if (f.Integer != null)
                {
                    int i = (int)f.Integer;
                    this.timerScanning.Interval = i;
                    this.timerScanning.Interval = i;
                    this.timerScanning.Interval = i;
                    DiversityCollection.Forms.FormTransactionSettings.Default.TimerIntervall = i;
                }
            }
        }


        private void timerScanning_Tick(object sender, EventArgs e)
        {
            if (this.textBoxHeaderAccessionNumber.Text.Length > 0 && this.scanModeToolStripMenuItem.Checked)
            {
                int CollectionSpecimenID;
                string SQL = "";
                switch (this._ScanTarget)
                {
                    case ScanTargets.SpecimenAccessionNumber:
                        if (!this.setSpecimen(this.textBoxHeaderAccessionNumber.Text))
                        {
                            this.timerScanning.Stop();
                            string Header = this.Message("No dataset could be found. Do you want to create a new dataset for\r\n" + this.textBoxHeaderAccessionNumber.Text + "?");
                            if (Header == null || Header.Length == 0)
                            {
                                Header = "An error occured. May be the detected string\r\n" + this.textBoxHeaderAccessionNumber.Text + "\r\nis no valid accession number.";
                                System.Windows.Forms.MessageBox.Show(Header);
                            }
                            else
                            {
                                string Message = Header + "\r\n" + DiversityWorkbench.Entity.EntityInformation("CollectionSpecimen.AccessionNumber")["DisplayText"] + ": " + this.textBoxHeaderAccessionNumber.Text;
                                if (System.Windows.Forms.MessageBox.Show(Message, Header, MessageBoxButtons.YesNo) == DialogResult.No)
                                    this.textBoxHeaderAccessionNumber.Text = "";
                                else
                                {
                                    string AccNr = this.textBoxHeaderAccessionNumber.Text;
                                    int ID = this.InsertNewSpecimen(ref AccNr, null);
                                    this.setSpecimen(ID);
                                }
                            }
                        }
                        break;
                    case ScanTargets.CollectionSpecimenID:
                        if (int.TryParse(this.textBoxHeaderAccessionNumber.Text, out CollectionSpecimenID) &&
                            !this.setSpecimen(CollectionSpecimenID))
                        {
                            this.timerScanning.Stop();
                            System.Windows.Forms.MessageBox.Show("No dataset could be found with the ID\r\n" + this.textBoxHeaderAccessionNumber.Text);
                        }
                        break;
                    case ScanTargets.PartAccessionNumber:
                        System.Data.DataTable dt = new DataTable();
                        SQL = "SELECT DISTINCT CollectionSpecimenID FROM CollectionSpecimenPart WHERE AccessionNumber = '" + this.textBoxHeaderAccessionNumber.Text + "'";
                        System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                        ad.Fill(dt);
                        if (dt.Rows.Count == 1)
                        {
                            if (int.TryParse(dt.Rows[0][0].ToString(), out CollectionSpecimenID))
                                this.setSpecimen(CollectionSpecimenID);
                        }
                        else if (dt.Rows.Count == 0)
                        {
                            this.timerScanning.Stop();
                            System.Windows.Forms.MessageBox.Show("No dataset could be found with the part accession number\r\n" + this.textBoxHeaderAccessionNumber.Text);
                        }
                        else
                        {
                            this.timerScanning.Stop();
                            string Message = dt.Rows.Count.ToString() + " datasets were found for the part accession number\r\n" + this.textBoxHeaderAccessionNumber.Text +
                                "\r\nOnly unique accession number can be used for the scanner";
                            System.Windows.Forms.MessageBox.Show(Message);
                        }
                        break;
                    case ScanTargets.UnitIdentifier:
                        System.Data.DataTable dtUnit = new DataTable();
                        SQL = "SELECT DISTINCT CollectionSpecimenID FROM IdentificationUnit WHERE AccessionNumber = '" + this.textBoxHeaderAccessionNumber.Text + "'";
                        System.Data.SqlClient.SqlDataAdapter adUnit = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                        adUnit.Fill(dtUnit);
                        if (dtUnit.Rows.Count == 1)
                        {
                            if (int.TryParse(dtUnit.Rows[0][0].ToString(), out CollectionSpecimenID))
                                this.setSpecimen(CollectionSpecimenID);
                        }
                        else if (dtUnit.Rows.Count == 0)
                        {
                            this.timerScanning.Stop();
                            System.Windows.Forms.MessageBox.Show("No dataset could be found with the identifier of the organism\r\n" + this.textBoxHeaderAccessionNumber.Text);
                        }
                        else
                        {
                            this.timerScanning.Stop();
                            string Message = dtUnit.Rows.Count.ToString() + " datasets were found for the identifier of the organism\r\n" + this.textBoxHeaderAccessionNumber.Text +
                                "\r\nOnly unique identifiers can be used for the scanner";
                            System.Windows.Forms.MessageBox.Show(Message);
                        }
                        break;
                }
            }
            else if (this.textBoxCollectionScanner.Text.Length > 0 && this.scanModeCollectionToolStripMenuItem.Checked)
            {
                this.timerScanning.Stop();
                string ScannedIdentifier = this.textBoxCollectionScanner.Text;
                string SQL = "SELECT dbo.StableIdentifierBase() + 'Collection/'";
                string StableIdentierBase = DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL);
                string sCollectionID = ""; 
                int CollectionID;
                string Collection = "";
                bool ScannedCollectionIdentified = false;
                if (StableIdentierBase.Length > 0 && ScannedIdentifier.StartsWith(StableIdentierBase))
                {
                    sCollectionID = this.textBoxCollectionScanner.Text.Substring(this.textBoxCollectionScanner.Text.LastIndexOf('/') + 1);
                    if (int.TryParse(sCollectionID, out CollectionID))
                        ScannedCollectionIdentified = true;
                }
                else
                {
                    SQL = "SELECT MIN(CollectionID) AS ID " +
                        "FROM Collection AS C " +
                        "GROUP BY CollectionName " +
                        "HAVING (CollectionName = '" + ScannedIdentifier.Replace("'", "''") + "') AND (COUNT(*) = 1) ";
                    sCollectionID = DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL);
                    if (int.TryParse(sCollectionID, out CollectionID))
                        ScannedCollectionIdentified = true;
                }
                if (ScannedCollectionIdentified)
                {
                    SQL = "SELECT CASE WHEN CollectionAcronym <> '' THEN CollectionAcronym ELSE CollectionName END AS Name FROM Collection WHERE CollectionID = " + CollectionID.ToString();
                    Collection = DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL);
                    if (Collection.Length == 0)
                    {
                        System.Windows.Forms.MessageBox.Show("The identifier\r\n" + this.textBoxCollectionScanner.Text + "\r\ndoes not correspond to a collection");
                    }
                    else
                    {
                        SQL = "SELECT DISTINCT CollectionSpecimenID FROM CollectionSpecimenPart P, Collection C WHERE P.CollectionID = C.CollectionID AND C.CollectionID  = " + CollectionID.ToString();
                        System.Data.DataTable dtColl = new DataTable();
                        System.Data.SqlClient.SqlDataAdapter adColl = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                        adColl.Fill(dtColl);
                        if (dtColl.Rows.Count > 0)
                        {
                            SQL = "";
                            foreach (System.Data.DataRow R in dtColl.Rows)
                            {
                                if (SQL.Length > 0)
                                    SQL += ", ";
                                SQL += R[0].ToString();
                            }
                            SQL = "WHERE CollectionSpecimenID IN(" + SQL + ")";
                            this.userControlQueryList.IsPredefinedQuery = true;
                            this.userControlQueryList.setQueryConditions(Collection, "CollectionSpecimen", SQL, "Content of collection " + Collection);
                            if (Collection.Length > 9)
                            {
                                this.labelCollectionScanner.Text = Collection.Substring(0, 9) + "...";
                            } 
                            else
                                this.labelCollectionScanner.Text = Collection;
                            this.toolTip.SetToolTip(this.textBoxCollectionScanner, "Stable identifier for collection " + Collection);
                            this.toolTip.SetToolTip(this.labelCollectionScanner, Collection);
                        }
                        else
                        {
                            //this.timerScanning.Stop();
                            System.Windows.Forms.MessageBox.Show("The collection " + Collection + " contains no items");
                        }
                    }
                }
                else
                {
                    if (this.textBoxHeaderAccessionNumber.Text.Length > 0)
                    {
                        //this.timerScanning.Stop();
                        System.Windows.Forms.MessageBox.Show("The identifier " + this.textBoxCollectionScanner.Text + " is not corresponding to a valid stable identifier for a collection");
                    }
                }
            }
            this._CurrentScanStep = ScanStep.Idle;
            this.textBoxHeaderAccessionNumber.SelectAll();
            this.timerScanning.Stop();
        }

        private void startScanner()
        {
            if (this._CurrentScanStep == ScanStep.Idle && (this.scanModeToolStripMenuItem.Checked || this.scanModeCollectionToolStripMenuItem.Checked))
            {
                this._CurrentScanStep = ScanStep.Scanning;
                this.timerScanning.Start();
            }
        }

        private void toolStripMenuItemScanTargetSpecimenAccessionNumber_Click(object sender, EventArgs e)
        {
            this.setScanTarget(ScanTargets.SpecimenAccessionNumber, this.toolStripMenuItemScanTargetSpecimenAccessionNumber);
        }

        private void toolStripMenuItemScanTargetSpecimenID_Click(object sender, EventArgs e)
        {
            this.setScanTarget(ScanTargets.CollectionSpecimenID, this.toolStripMenuItemScanTargetSpecimenID);
        }

        private void toolStripMenuItemScanTargetPartAccessionNumber_Click(object sender, EventArgs e)
        {
            this.setScanTarget(ScanTargets.PartAccessionNumber, this.toolStripMenuItemScanTargetPartAccessionNumber);
        }

        private void toolStripMenuItemScanTargetUnitIdentifier_Click(object sender, EventArgs e)
        {
            this.setScanTarget(ScanTargets.UnitIdentifier, this.toolStripMenuItemScanTargetUnitIdentifier);
        }

        private void toolStripMenuItemScanTargetCollection_Click(object sender, EventArgs e)
        {
            this.setScanTarget(ScanTargets.CollectionCode, this.toolStripMenuItemScanTargetCollection);
        }

        private void setScanTarget(ScanTargets ScanTarget, System.Windows.Forms.ToolStripMenuItem MenuItem)
        {
            this._ScanTarget = ScanTarget;
            this.toolStripDropDownButtonScanTarget.Image = MenuItem.Image;
            this.labelHeaderAccessionNumber.Text = MenuItem.Text;
            if (MenuItem.ToolTipText != null)
            {
                this.toolTip.SetToolTip(this.labelHeaderAccessionNumber, MenuItem.ToolTipText);
                this.toolStripDropDownButtonScanTarget.ToolTipText = MenuItem.ToolTipText;
            }
            else
            {
                this.toolTip.SetToolTip(this.labelHeaderAccessionNumber, MenuItem.Text);
                this.toolStripDropDownButtonScanTarget.ToolTipText = MenuItem.Text;
            }
        }

        #endregion

        #region Grid mode
        private void gridModeToolStripMenuItem_Click(object sender, EventArgs e)
        {
            System.Collections.Generic.List<int> IDs = this.userControlQueryList.ListOfIDs;
            DiversityCollection.FormCollectionSpecimenGridMode f = new FormCollectionSpecimenGridMode(IDs, this.Text, this.userControlQueryList.ProjectID);
            f.Width = this.Width;
            f.Height = this.Height;
            this.userControlQueryList.listBoxQueryResult.SelectedIndex = -1;
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
                this.setSpecimen(f.SpecimenID);
        }
        
        #endregion

        private void setViewMode()
        {
            try
            {
                this.userControlQueryList.IsPredefinedQuery = false;
                this.userControlQueryList.setQueryConditions(this.CollectionSpecimen.QueryConditions(), DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.QueryConditionVisibility.ToString());
                this.pictureBoxScanner.Image = DiversityCollection.Resource.ScannerBarcode;
                this.labelCollectionScanner.Visible = false;
                this.textBoxCollectionScanner.Visible = false;
                switch (this._ViewMode)
                {
                    case ViewMode.Default:
                        this.gridModeToolStripMenuItem.Checked = false;
                        this.scanModeCollectionToolStripMenuItem.Checked = false;
                        this.scanModeToolStripMenuItem.Checked = false;
                        this.splitContainerMain.Panel1Collapsed = false;
                        this.textBoxHeaderAccessionNumber.Width = 100;
                        this.textBoxHeaderAccessionNumber.ReadOnly = true;
                        this.textBoxHeaderAccessionNumber.BorderStyle = BorderStyle.None;
                        this.textBoxHeaderAccessionNumber.Dock = DockStyle.Bottom;
                        this.textBoxHeaderAccessionNumber.BackColor = System.Drawing.SystemColors.Control;
                        this.pictureBoxScanner.Visible = false;
                        // hide or show the panel for the grid options
                        this.splitContainerGridOptionsAndImages.Panel1Collapsed = true;
                        // hide or show the Overview
                        this.splitContainerGridAndOverview.Panel2Collapsed = false;
                        this.splitContainerGridAndOverview.Panel1Collapsed = true;
                        this.buttonSave.Visible = false;
                        if (this.ID == -1)
                        {
                            this.tableLayoutPanelHeader.Visible = false;
                        }
                        break;
                    case ViewMode.Gridmode:
                        this.scanModeToolStripMenuItem.Checked = false;
                        this.gridModeToolStripMenuItem.Checked = true;
                        this.setImageVisibility("0010");
                        this.splitContainerMain.Panel1Collapsed = true;
                        this.buttonSave.Visible = false;
                        // hide or show the Query list
                        this.splitContainerMain.Panel1Collapsed = true;
                        // hide or show the panel for the grid options
                        this.splitContainerGridOptionsAndImages.Panel1Collapsed = false;
                        // hide or show the Overview
                        this.splitContainerGridAndOverview.Panel2Collapsed = true;
                        this.splitContainerGridAndOverview.Panel1Collapsed = false;
                        this.tableLayoutPanelHeader.Visible = false;
                        break;
                    case ViewMode.Scanmode:
                        this.scanModeToolStripMenuItem.Checked = true;
                        this.scanModeCollectionToolStripMenuItem.Checked = false;
                        this.gridModeToolStripMenuItem.Checked = false;
                        this.splitContainerMain.Panel1Collapsed = true;
                        this.textBoxHeaderAccessionNumber.Width = 120;
                        this.textBoxHeaderAccessionNumber.ReadOnly = false;
                        this.textBoxHeaderAccessionNumber.BorderStyle = BorderStyle.Fixed3D;
                        this.textBoxHeaderAccessionNumber.Dock = DockStyle.Fill;
                        this.textBoxHeaderAccessionNumber.BackColor = System.Drawing.Color.Pink;
                        this.pictureBoxScanner.Visible = true;
                        this.buttonSave.Visible = true;
                        this.textBoxHeaderAccessionNumber.Focus();
                        this.textBoxHeaderAccessionNumber.SelectAll();
                        // hide or show the panel for the grid options
                        this.splitContainerGridOptionsAndImages.Panel1Collapsed = true;
                        // hide or show the Overview
                        this.splitContainerGridAndOverview.Panel2Collapsed = false;
                        this.splitContainerGridAndOverview.Panel1Collapsed = true;
                        if (this.ID == -1)
                        {
                            this.setHeader();
                            this.tableLayoutPanelHeader.Visible = true;
                        }
                        break;
                    case ViewMode.CollectionScanMode:
                        this.scanModeCollectionToolStripMenuItem.Checked = true;
                        this.labelCollectionScanner.Text = "";
                        this.scanModeToolStripMenuItem.Checked = false;
                        this.gridModeToolStripMenuItem.Checked = false;
                        this.splitContainerMain.Panel1Collapsed = false;
                        this.textBoxHeaderAccessionNumber.Width = 100;
                        this.textBoxHeaderAccessionNumber.ReadOnly = true;
                        this.textBoxHeaderAccessionNumber.BorderStyle = BorderStyle.None;
                        this.textBoxHeaderAccessionNumber.Dock = DockStyle.Bottom;
                        this.textBoxHeaderAccessionNumber.BackColor = System.Drawing.SystemColors.Control;
                        this.pictureBoxScanner.Visible = true;
                        this.buttonSave.Visible = false;
                        this.labelCollectionScanner.Visible = true;
                        this.textBoxCollectionScanner.Visible = true;
                        this.textBoxCollectionScanner.Focus();
                        this.textBoxCollectionScanner.SelectAll();
                        // hide or show the panel for the grid options
                        this.splitContainerGridOptionsAndImages.Panel1Collapsed = true;
                        // hide or show the Overview
                        this.splitContainerGridAndOverview.Panel2Collapsed = false;
                        this.splitContainerGridAndOverview.Panel1Collapsed = true;
                        if (this.ID == -1)
                        {
                            this.setHeader();
                            this.tableLayoutPanelHeader.Visible = true;
                        }
                        else if (this._ViewMode == ViewMode.CollectionScanMode)
                            this.tableLayoutPanelHeader.Visible = true;
                        this.userControlQueryList.IsPredefinedQuery = true;
                        this.userControlQueryList.setQueryConditions("Collection", "CollectionSpecimen", "WHERE 1 = 0", "Content of a collection ");
                        this.pictureBoxScanner.Image = DiversityCollection.Resource.ScannerCollection;
                        break;
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }
       
        #endregion

        #region View

        ////TODO: wegen serializ.. ausgeblendet
        //private void customEntryToolStripMenuItem_Click(object sender, EventArgs e)
        //{
        //    //    //this.tabControlSpecimen.SelectedTab = this.tabPageCustomizedEntry;
        //    //    DiversityWorkbench.FormQueryOptions f = new DiversityWorkbench.FormQueryOptions(this.CustomFields, DiversityCollection.FormCollectionSpecimenSettings.Default.CustomSetting.ToString(), " Set the visibility of the custom entry");
        //    //    f.ShowDialog();
        //    //    if (f.DialogResult == DialogResult.OK)
        //    //    {
        //    //        DiversityCollection.FormCollectionSpecimenSettings.Default.CustomSetting = f.QueryConditionVisibility;
        //    //        this.setCustomFieldVisibility();
        //    //        this.setCustomFields();
        //    //        this.setCustomFieldsHeight();
        //    //        //DiversityCollection.FormCollectionSpecimenSettings.Default.SplitContainerData_SplitterDistance = this.splitContainerData.SplitterDistance;
        //    //        DiversityCollection.FormCollectionSpecimenSettings.Default.Save();
        //    //    }
        //}

        private void showExistingImagesToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (this.showExistingImagesToolStripMenuItem.Checked) 
                this.showExistingImagesToolStripMenuItem.Checked = false;
            else this.showExistingImagesToolStripMenuItem.Checked = true;
        }

        #endregion

        #region Administration

        private void setAdminMenu()
        {
            try
            {
                if (DiversityWorkbench.Settings.ConnectionString.Length > 0)
                {
                    bool Any = false;
                    bool AnyTransaction = false;
                    bool OK;
                    string TableName = "";

                    // Analysis
                    TableName = "Analysis";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.analysisToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // Application Description
                    try
                    {
                        TableName = "Entity";
                        OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    }
                    catch { OK = false; }
                    this.applicationDescriptionToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CacheDB
                    if (DiversityWorkbench.Database.DatabaseRoles().Contains("Administrator")
                        || DiversityWorkbench.Database.DatabaseRoles().Contains("db_owner"))
                    {
                        this.cacheDatabaseToolStripMenuItem.Visible = false;// = true; //  ToDo
                        Any = true;//
                    }
                    else
                        this.cacheDatabaseToolStripMenuItem.Visible = false;

                    // CacheDatabase
                    //if (DiversityWorkbench.Database.DatabaseRoles().Contains("Administrator")
                    //    || DiversityWorkbench.Database.DatabaseRoles().Contains("db_owner"))
                    //{
                    //    this.cacheDatabaseToolStripMenuItem1.Visible = true; //  = false;//  ToDo
                    //    Any = true;//
                    //}
                    //else
                    //    this.cacheDatabaseToolStripMenuItem1.Visible = false;

                    // External idenfier
                    TableName = "ExternalIdentifierType";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                    this.externalIdentifierToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // Password
                    if ((DiversityWorkbench.Database.DatabaseRoles().Contains("User") &&
                        DiversityWorkbench.Database.DatabaseRoles().Count == 1)
                        || DiversityWorkbench.Settings.IsTrustedConnection)
                    {
                        this.changePasswordToolStripMenuItem.Visible = false;
                    }
                    else
                    {
                        this.changePasswordToolStripMenuItem.Visible = true;
                        Any = true;
                    }

                    // Collection
                    TableName = "ManagerCollectionList";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "SELECT");
                    this.collectionsToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollectionExternalDatasource
                    TableName = "CollectionExternalDatasource";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.externalDatasourcesToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // DatabaseTools
                    TableName = "CollectionSpecimen_log";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                    //this.databaseToolsToolStripMenuItem.Visible = false;
                    this.databaseToolsToolStripMenuItem.Visible = OK;
                    //if (OK) Any = true;

                    // Image description template
                    TableName = "ProjectProxy";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    // abgeschaltet - ersetzt durch EXIF und Properties
                    //OK = true;
                    this.imageDescriptionTemplatetoolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // KioskMode
                    if (DiversityWorkbench.Settings.ConnectionString.Length > 0) OK = true;
                    else OK = false;
                    this.kioskModeToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // LinkedServer
                    if (DiversityWorkbench.Database.DatabaseRoles().Contains("Administrator")
                        || DiversityWorkbench.Database.DatabaseRoles().Contains("db_owner"))
                    {
                        this.linkedServerToolStripMenuItem.Visible = true;
                        Any = true;
                    }
                    else
                        this.linkedServerToolStripMenuItem.Visible = false;

                    // Method
                    TableName = "Method";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.methodsToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // Regulations
//                    TableName = "Regulation"; //ExternalIdentifierType";
//                    // TODO Regulation - wieder einbauen wenn D. Neumann getestet hat
//                    OK = false;
//#if NAGOYA_TEST
//                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
//#endif
//                    this.regulationsToolStripMenuItem.Visible = OK;
//                    if (OK) Any = true;

                    // Projects
                    TableName = "ProjectProxy";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.projectsToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;
                    // Stable identifier
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.stableIdentifierToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // Withholding
                    TableName = "CollectionSpecimen";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                    this.withholdDataToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // Maintenance
                    TableName = "CollectionSpecimen";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.maintenanceToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollMaterialCategory_Enum
                    TableName = "CollMaterialCategory_Enum";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.materialCategoriesToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // Processing
                    TableName = "Processing";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.processingToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // Property
                    TableName = "Property";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.sitePropertiesToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollTaxonomicGroup_Enum
                    TableName = "CollTaxonomicGroup_Enum";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.taxonomicGroupsToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // CollRetrievalType_Enum
                    TableName = "CollRetrievalType_Enum";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.retrievalTypeToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // Tool
                    TableName = "Tool";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.toolsToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // Queries
                    TableName = "ApplicationSearchSelectionStrings";
                    //TableName = "ApplicationSearchSelectionStrings_Core";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.queriesToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    #region Transaction

                    // Transaction
                    TableName = "Transaction";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.transactionToolStripMenuItem.Visible = OK;
                    if (OK)
                    {
                        Any = true;
                        AnyTransaction = true;
                    }

                    // Expired loans
                    TableName = "CollectionManager";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "SELECT");
                    if (OK)
                    {
                        string SQL = "SELECT  COUNT(*) " +
                            "FROM [Transaction] INNER JOIN " +
                            "CollectionSpecimenTransaction ON [Transaction].TransactionID = CollectionSpecimenTransaction.TransactionID INNER JOIN " +
                            "CollectionManager ON [Transaction].AdministratingCollectionID = CollectionManager.AdministratingCollectionID " +
                            "WHERE (CollectionManager.LoginName = USER_NAME())  " +
                            "AND (CollectionSpecimenTransaction.IsOnLoan = 1)  " +
                            "AND ([Transaction].AgreedEndDate < GETDATE())  " +
                            "AND NOT [Transaction].AgreedEndDate IS NULL  " +
                            "AND ([Transaction].TransactionType = N'loan')";
                        System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                        System.Data.SqlClient.SqlCommand C = new System.Data.SqlClient.SqlCommand(SQL, con);
                        int i = 0;
                        try
                        {
                            con.Open();
                            if (int.TryParse(C.ExecuteScalar().ToString(), out i))
                            {
                                if (i > 0)
                                {
                                    TableName = "Transaction";
                                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                                    this.expiredLoansToolStripMenuItem.Visible = OK;
                                    if (OK)
                                    {
                                        Any = true;
                                        AnyTransaction = true;
                                    }
                                }
                                else
                                    this.expiredLoansToolStripMenuItem.Visible = false;
                            }
                            else
                                this.expiredLoansToolStripMenuItem.Visible = false;
                            con.Close();
                        }
                        catch
                        {
                            this.expiredLoansToolStripMenuItem.Visible = false;
                        }
                    }
                    else this.expiredLoansToolStripMenuItem.Visible = false;

                    // Loan requests
                    TableName = "CollectionManager";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "SELECT");
                    if (OK)
                    {
                        string SQL = "SELECT COUNT(*) FROM TransactionForeignRequest";
                        System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                        System.Data.SqlClient.SqlCommand C = new System.Data.SqlClient.SqlCommand(SQL, con);
                        int i = 0;
                        try
                        {
                            con.Open();
                            if (int.TryParse(C.ExecuteScalar().ToString(), out i))
                            {
                                if (i > 0)
                                {
                                    TableName = "Transaction";
                                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                                    this.loanRequestsToolStripMenuItem.Visible = OK;
                                    if (OK)
                                    {
                                        Any = true;
                                        AnyTransaction = true;
                                    }
                                }
                                else
                                    this.loanRequestsToolStripMenuItem.Visible = false;
                            }
                            else
                                this.loanRequestsToolStripMenuItem.Visible = false;
                            con.Close();
                        }
                        catch
                        {
                            this.loanRequestsToolStripMenuItem.Visible = false;
                        }
                    }
                    else this.loanRequestsToolStripMenuItem.Visible = false;

                    // My requests
                    TableName = "CollectionSpecimenTransactionRequest";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "SELECT");

                    // abgeschaltet - falls benoetigt hier wieder aktivieren
                    OK = false;

                    if (OK)
                    {
                        string SQL = "SELECT  COUNT(*) FROM TransactionUserRequest";
                        System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                        System.Data.SqlClient.SqlCommand C = new System.Data.SqlClient.SqlCommand(SQL, con);
                        int i = 0;
                        try
                        {
                            con.Open();
                            if (int.TryParse(C.ExecuteScalar().ToString(), out i))
                            {
                                if (i > 0)
                                {
                                    this.myRequestsToolStripMenuItem.Visible = OK;
                                    if (OK)
                                    {
                                        Any = true;
                                        AnyTransaction = true;
                                    }
                                }
                                else
                                    this.myRequestsToolStripMenuItem.Visible = false;
                            }
                            else
                                this.myRequestsToolStripMenuItem.Visible = false;
                            con.Close();
                        }
                        catch
                        {
                            this.myRequestsToolStripMenuItem.Visible = false;
                        }
                    }
                    else this.myRequestsToolStripMenuItem.Visible = false;

                    // Manager
                    TableName = "CollectionManager";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.curatorsToolStripMenuItem.Visible = OK;
                    if (OK)
                    {
                        Any = true;
                        AnyTransaction = true;
                    }

                    // Requester
                    TableName = "CollectionRequester";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.loanRequestorsToolStripMenuItem.Visible = OK;
                    if (OK)
                    {
                        Any = true;
                        AnyTransaction = true;
                    }
                    // TransactionManagement
                    if (AnyTransaction) this.transactionManagementToolStripMenuItem.Visible = true;
                    else this.transactionManagementToolStripMenuItem.Visible = false;
                    
                    #endregion

                    // User
                    TableName = "UserProxy";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    this.userToolStripMenuItem.Visible = false;
                    this.loginsToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // Renaming the database and the BaseURL
                    if (!DiversityWorkbench.Settings.IsTrustedConnection && DiversityWorkbench.Settings.DatabaseUser.Length > 0)
                        OK = DiversityWorkbench.Database.LoginIsSysAdmin(DiversityWorkbench.Settings.DatabaseUser);
                    else
                    {
                        string User = System.Environment.UserName;
                        OK = DiversityWorkbench.Database.LoginIsSysAdmin(User);
                        if (!OK)
                        {
                            string Sql = "select user_name()";
                            User = DiversityWorkbench.FormFunctions.SqlExecuteScalar(Sql);
                            OK = DiversityWorkbench.Database.LoginIsSysAdmin(User);
                            if (!OK && User == "dbo")
                                OK = true;
                        }
                    }
                    this.renameDatabaseToolStripMenuItem.Visible = OK;
                    this.setPublishedAddressToolStripMenuItem.Visible = OK;

                    // Maintenance
                    OK = this.FormFunctions.getObjectPermissions("CollectionSpecimen", "UPDATE");
                    if (OK) OK = this.FormFunctions.getObjectPermissions("Identification", "UPDATE");
                    if (OK) OK = this.FormFunctions.getObjectPermissions("IdentificationUnit", "UPDATE");
                    if (OK) OK = this.FormFunctions.getObjectPermissions("CollectionEventLocalisation", "UPDATE");
                    if (OK) OK = this.FormFunctions.getObjectPermissions("CollectionEvent", "UPDATE");
                    this.maintenanceToolStripMenuItem.Visible = OK;
                    if (OK) Any = true;

                    // Version
                    this.versionsToolStripMenuItem.Visible = false;
                    //string SqlVersion = "select user_name()";
                    //System.Data.SqlClient.SqlConnection ConVersion = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                    //System.Data.SqlClient.SqlCommand CVersion = new System.Data.SqlClient.SqlCommand(SqlVersion, ConVersion);
                    //try
                    //{
                    //    bool IsAdmin = false;
                    //    if (DiversityWorkbench.Database.DatabaseRoles().Contains("Administrator"))
                    //        IsAdmin = true;
                    //    ConVersion.Open();
                    //    if (CVersion.ExecuteScalar().ToString() == "dbo" || IsAdmin)
                    //    {
                    //        this.versionsToolStripMenuItem.Visible = true;
                    //        Any = true;
                    //    }
                    //    else
                    //    {
                    //        this.versionsToolStripMenuItem.Visible = false;
                    //    }
                    //    ConVersion.Close();
                    //}
                    //catch
                    //{
                    //    this.versionsToolStripMenuItem.Visible = false;
                    //}

                    // Replication
                    TableName = "CollectionSpecimen";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    try
                    {
                        if (OK)
                        {
                            this.replicationToolStripMenuItem.Visible = true;
                            Any = true;
                        }
                        else
                        {
                            this.replicationToolStripMenuItem.Visible = false;
                        }
                    }
                    catch
                    {
                        this.replicationToolStripMenuItem.Visible = false;
                    }

                    // Statistics and Label editing
                    TableName = "CollectionSpecimen";
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                    // disabled
                    this.labelEditorToolStripMenuItem.Visible = OK;
                    this.labelEditorToolStripMenuItem.Visible = false;

                    if (Any)
                        this.administrationToolStripMenuItem.Visible = true;
                    else
                        this.administrationToolStripMenuItem.Visible = false;
                }
                else
                {
                    this.analysisToolStripMenuItem.Visible = false;
                    this.collectionsToolStripMenuItem.Visible = false;
                    this.maintenanceToolStripMenuItem.Visible = false;
                    this.processingToolStripMenuItem.Visible = false;
                    this.queriesToolStripMenuItem.Visible = false;
                    this.projectsToolStripMenuItem.Visible = false;
                    //this.taxonomicGroupsToolStripMenuItem.Visible = false;
                    this.transactionToolStripMenuItem.Visible = false;
                    this.userToolStripMenuItem.Visible = false;
                    this.administrationToolStripMenuItem.Visible = false;
                }
            }
            catch (Exception ex)
            {
                this.administrationToolStripMenuItem.Visible = false;
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void analysisToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityCollection.FormAnalysis f = new FormAnalysis();
            if (f.Width > this.Width - 20)
                f.Width = this.Width - 20;
            if (f.Height > this.Height - 20)
                f.Height = this.Height - 20;
            f.setHelp("Analysis");
            f.ShowDialog();
            if (f.ChangeToSpecimen)
                this.setSpecimen(f.CollectionSpecimenID);
            DiversityCollection.LookupTable.ResetAnalysis();
            this.initQueryOptimizing();
        }

        private void cacheDatabaseToolStripMenuItem_Click(object sender, EventArgs e)
        {
            //System.Windows.Forms.MessageBox.Show("Available in upcoming version");
            //return;

            //try
            //{
            //    DiversityCollection.CacheDatabase.FormCacheDB f = new DiversityCollection.CacheDatabase.FormCacheDB();
            //    f.SetFormState(CacheDatabase.FormCacheDB.FormState.Administration);
            //    f.ShowDialog();
            //}
            //catch (System.Exception ex) { }

            //DiversityCollection.Forms.FormCacheDBAdministration f = new Forms.FormCacheDBAdministration();
            //f.ShowDialog();
        }

        private void changePasswordToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                DiversityWorkbench.Forms.FormPassword f = new DiversityWorkbench.Forms.FormPassword();
                f.ShowDialog();
            }
            catch (System.Exception ex) { }
        }

        private void collectionsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityCollection.FormCollection f = new FormCollection();
            if (f.Width > this.Width - 20)
                f.Width = this.Width - 20;
            if (f.Height > this.Height - 20)
                f.Height = this.Height - 20;
            f.setHelp("Collection");
            f.ShowDialog();
            if (f.ChangeToSpecimen)
                this.setSpecimen(f.CollectionSpecimenID);
            DiversityCollection.LookupTable.ResetCollection();

            this.setCollectionSource();
            this.initQueryOptimizing();
        }

        private void customizeDisplayToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.CustomizeDisplay(FormCustomizeDisplay.Customization.All);
        }

        private void CustomizeDisplay(DiversityCollection.FormCustomizeDisplay.Customization Customize)
        {
            try
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                DiversityCollection.FormCustomizeDisplay f =
                    new FormCustomizeDisplay(DiversityCollection.Specimen.ImageList, Customize);
                f.setHelp("Customize");
                this.Cursor = System.Windows.Forms.Cursors.Default;
                f.ShowDialog();
                if (f.DialogResult == DialogResult.OK)
                {
                    if (f.VisibilityOfTaxaHasChanges)
                    {
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.TaxonomicGroups = f.VisibilityTaxonomicGroups;
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();
                        DiversityCollection.LookupTable.ResetTaxonomicGroupList();
                        //this.setToolStripDropDownButtonOverviewHierarchyNewUnit();
                        this.setToolStripDropDownButtonOverviewHierarchyNewUnitWithAdaptiveHierarchy();
                    }

                    if (f.VisibilityOfMaterialHasChanges)
                    {
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.MaterialCategories = f.VisibilityMaterialCategories;
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();
                        DiversityCollection.LookupTable.ResetMaterialCategoryList();
                        this.setToolStripDropDownButtonOverviewHierarchyNewPartWithAdaptiveHierarchy();
                    }

                    if (f.VisibilityOfLocalisationsHasChanges)
                    {
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.LocalisationSystems = f.VisibilityLocalisations;
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();
                        this.setToolStripDropDownButtonsEventLocalisationVisibilty();
                    }

                    if (f.VisibilityOfMapsHasChanges)
                    {
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.LocalisationSystemsInMaps = f.VisibilityMaps;
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();
                    }

                    if (f.VisibilityOfPropertiesHasChanges)
                    {
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.CollectionSiteProperties = f.VisibilityCollectionSiteProperties;
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();
                        this.setToolStripDropDownButtonsEventPropertyVisibilty();
                    }

                    if (f.DefaultsHaveChanges)
                    {
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultResponsible = f.DefaultResponsibe;
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultResponsibleUsage = f.DefaultResponsibeUsage;
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();
                    }

                    if (f.ContextHasChanged || f.LanguageHasChanged)
                    {
                        if (f.LanguageHasChanged)
                        {
                            DiversityCollection.LookupTable.ResetLanguageVariantLookupTables();
                            languageToolStripMenuItem.Image = DiversityWorkbench.Entity.LanguageImage;
                        }
                        if (f.ContextHasChanged)
                        {
                            this.contextToolStripMenuItem.Text = "Context: " + DiversityWorkbench.Settings.Context;
                        }
                        DiversityWorkbench.Entity.setEntity(this, this.toolTip);
                    }

                    this.setModuleInfoTextOption();
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            this.DefaultCollection = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection;
        }

        #region Database administration
        
        private void applicationDescriptionToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.FormApplicationEntity f = new DiversityWorkbench.FormApplicationEntity();
            f.StartPosition = FormStartPosition.CenterParent;
            f.Width = this.Width - 20;
            f.Height = this.Height - 20;
            f.setHelpProviderPath(this.helpProviderDiversityCollection.HelpNamespace);
            f.ShowDialog();
            DiversityWorkbench.Entity.Reset();
        }

        private void documentationToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Forms.FormDocumentation f = new DiversityWorkbench.Forms.FormDocumentation();
            f.setHelp("Documentation");
            //DiversityWorkbench.Forms.FormDocumentation f = new DiversityWorkbench.Forms.FormDocumentation(this.helpProviderDiversityCollection.HelpNamespace);
            f.ShowDialog();
        }

        private void maintenanceToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                DiversityCollection.FormMaintenance f = new FormMaintenance();
                try
                {
                    if (f.Width > this.Width - 20)
                        f.Width = this.Width - 20;
                    if (f.Height > this.Height - 20)
                        f.Height = this.Height - 20;
                }
                catch { }
                f.ShowDialog();
                if (f.DialogResult == DialogResult.OK)
                {
                    if (f.ShowList && f.CollectionSpecimenIDs.Count > 0)
                    {
                        string WhereClause = "";
                        foreach (int i in f.CollectionSpecimenIDs)
                        {
                            if (WhereClause.Length > 0) WhereClause += ", ";
                            WhereClause += i.ToString();
                        }
                        WhereClause = " WHERE CollectionSpecimenID IN (" + WhereClause + ")";
                        this.userControlQueryList.clearQueryList();
                        this.userControlQueryList.IsPredefinedQuery = true;
                        this.userControlQueryList.WhereClause = WhereClause;
                        this.userControlQueryList.setQueryConditions(f.ShowListQueryHeader, "CollectionSpecimen", WhereClause, f.ShowListQueryDescription);
                        this.userControlQueryList.StartQuery();
                    }
                    else
                    {
                        this.setSpecimen(f.CollectionSpecimenID);
                    }
                }
                else
                {
                    if (this.ID != -1)
                        this.setSpecimen(this.ID);
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void queriesToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.FormApplicationSearchSelectionStrings f = new DiversityWorkbench.FormApplicationSearchSelectionStrings(System.Windows.Forms.Application.StartupPath + "\\DiversityCollection.chm");
            f.SetDefaults("CollectionSpecimen", "Where CollectionSpecimenID in (SELECT S.CollectionSpecimenID FROM CollectionSpecimen AS S INNER JOIN CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID)");
            f.Width = this.Width - 20;
            f.Height = this.Height - 20;
            f.StartPosition = FormStartPosition.CenterParent;
            f.ShowInTaskbar = false;
            f.ShowDialog();
            this.buildSearchMenu();
        }

        private void renameDatabaseToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (DiversityWorkbench.Database.RenameDatabase())
                this.setDatabase();
        }

        private void setPublishedAddressToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Database.SetBaseURL();
        }

        private void loginsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Forms.FormLoginAdministration f = new DiversityWorkbench.Forms.FormLoginAdministration();
            f.setHelp("Login administration");
            f.ShowDialog();
            DiversityCollection.LookupTable.ResetUser();
        }

        private void databaseToolsToolStripMenuItem_Click(object sender, EventArgs e)
        {
#if !DEBUG
            DiversityWorkbench.Forms.FormRestricted FR = new DiversityWorkbench.Forms.FormRestricted();
            if (FR.ShowDialog() != System.Windows.Forms.DialogResult.OK)
            {
                System.Windows.Forms.MessageBox.Show("Obviously not qualified ...");
                return;
            }
#endif
            DiversityWorkbench.Forms.FormDatabaseTool f = new DiversityWorkbench.Forms.FormDatabaseTool();
            f.setHelpProvider(this.helpProviderDiversityCollection.HelpNamespace, "Database tools");
            f.ShowDialog();
        }

        #endregion
        
        private void externalIdentifierToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Forms.FormEnumAdministration f = new DiversityWorkbench.Forms.FormEnumAdministration(DiversityCollection.Resource.Identifier, "ExternalIdentifierType", "Type", "ParentType", "Type", "Administration of external identifiers", false, "ID", DiversityWorkbench.ReferencingTable.IDs());
            f.setHelp("External identifier");
            f.ShowDialog();
            DiversityWorkbench.ReferencingTable.ResetIDs();
        }

        private void imageDescriptionTemplatetoolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (!this.userControlQueryList.ProjectIsSelected)
            {
                System.Windows.Forms.MessageBox.Show("Please select a project");
                return;
            }
            try
            {
                string Template = this.ImageDescriptionTemplate;
                if (Template.Length == 0)
                    Template = "<Description></Description>";
                string Header = "Please edit the image description template for the current project";
                System.Data.DataTable dtTemplate = new DataTable();
                string SQL = "SELECT P.Project, CAST(P.ImageDescriptionTemplate as nvarchar(MAX)) AS ImageDescriptionTemplate " +
                    "FROM         ProjectProxy AS P INNER JOIN " +
                    "ProjectList AS L ON P.ProjectID = L.ProjectID " +
                    "WHERE     (NOT (P.ImageDescriptionTemplate IS NULL)) " +
                    "ORDER BY P.Project";
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dtTemplate);
                DiversityWorkbench.Forms.FormEditXmlTemplate f = new DiversityWorkbench.Forms.FormEditXmlTemplate(Template, Header, dtTemplate, "Project", "ImageDescriptionTemplate");
                f.StartPosition = FormStartPosition.CenterParent;
                f.ShowDialog();
                if (f.DialogResult == DialogResult.OK)
                {
                    Template = f.TemplateWithoutEncoding;
                    SQL = "UPDATE P SET ImageDescriptionTemplate = '" + Template + "' FROM ProjectProxy P WHERE P.ProjectID = " + this.userControlQueryList.ProjectID.ToString();
                    System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                    System.Data.SqlClient.SqlCommand C = new System.Data.SqlClient.SqlCommand(SQL, con);
                    con.Open();
                    C.ExecuteNonQuery();
                    con.Close();
                }
            }
            catch (Exception ex)
            {
            }
        }

        private void kioskModeToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (DiversityWorkbench.Settings.ConnectionString.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please connect to a database first");
                return;
            }
            if (System.Windows.Forms.MessageBox.Show("Are you sure you want to change to the kiosk mode? This will hide close buttons, connection menus etc.", "Lock client?", MessageBoxButtons.YesNo) == System.Windows.Forms.DialogResult.Yes)
            {
                if (System.Windows.Forms.MessageBox.Show("Do you want to fix the kiosk mode for restrart?", "Fix kiosk mode", MessageBoxButtons.YesNo) == System.Windows.Forms.DialogResult.Yes)
                {
                    DiversityCollection.Properties.Settings.Default.KioskMode = true;
                }
                this.setKioskMode();
            }
        }

        private void setKioskMode()
        {
            this.ControlBox = false;
            this.WindowState = FormWindowState.Maximized;
            this.connectionToolStripMenuItem.Visible = false;
            this.administrationToolStripMenuItem.Visible = false;
            this.dataToolStripMenuItem.Visible = false;
            this.feedbackHistoryToolStripMenuItem.Visible = false;
            this.feedbackToolStripMenuItem.Visible = false;
            this.queriesToolStripMenuItem.Visible = false;
            this.userControlQueryList.toolStripButtonConnection.Enabled = false;
        }

        private void labelEditorToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.XsltEditor.FormEditor fEditor = new DiversityWorkbench.XsltEditor.FormEditor();
            fEditor.ShowDialog();

            System.Windows.Forms.MessageBox.Show("Available in upcoming version");
            return;

            try
            {
                string UrlFile = this.webBrowserLabel.Url.ToString();
                if (UrlFile.StartsWith("file:///"))
                    UrlFile = UrlFile.Substring(8);
                System.IO.FileInfo f = new System.IO.FileInfo(UrlFile);
                if (f.Extension.ToLower() == ".xml")
                {
                    DiversityWorkbench.XslEditor.FormXslEditor F = new DiversityWorkbench.XslEditor.FormXslEditor(f.FullName, false);
                    F.Width = this.Width - 10;
                    F.Height = this.Height - 10;
                    F.StartPosition = FormStartPosition.CenterParent;
                    F.ShowDialog();
                }
                else
                    System.Windows.Forms.MessageBox.Show("The editor needs a valid xml document");
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private void linkedServerToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Forms.FormLinkedServer f = new DiversityWorkbench.Forms.FormLinkedServer();
            f.setHelp("Linked server");
            f.ShowDialog();
        }

        private void projectsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataTable dtProjectProxy = new DataTable("ProjectProxy");
                string SQL = "SELECT ProjectID, Project, ProjectURI " +
                    "FROM ProjectProxy";
                System.Data.SqlClient.SqlDataAdapter adProjectProxy = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                adProjectProxy.Fill(dtProjectProxy);
                DataSet DsProjectProxy = new DataSet();
                DsProjectProxy.Tables.Add(dtProjectProxy);
                System.Data.SqlClient.SqlCommandBuilder cb = new System.Data.SqlClient.SqlCommandBuilder(adProjectProxy);
                System.Windows.Forms.BindingSource ProjectBindingSource = new System.Windows.Forms.BindingSource(DsProjectProxy, "ProjectProxy");
                ((System.ComponentModel.ISupportInitialize)(ProjectBindingSource)).BeginInit();
                ((System.ComponentModel.ISupportInitialize)(ProjectBindingSource)).EndInit();
                DiversityWorkbench.Forms.FormLoginAdminGetProjects f = new DiversityWorkbench.Forms.FormLoginAdminGetProjects(dtProjectProxy, this.ServerConnection, this.helpProviderDiversityCollection.HelpNamespace);
                f.StartPosition = FormStartPosition.CenterParent;
                f.setHelp("Projects");
                f.ShowDialog();
                if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                {
                    if (f.AddedProjectRows.Count > 0)
                    {
                        foreach (System.Data.DataRow R in f.AddedProjectRows)
                        {
                            System.Data.DataRow[] rr = dtProjectProxy.Select("ProjectID = " + R["ProjectID"].ToString());
                            if (rr.Length == 0)
                            {
                                System.Data.DataRow RN = dtProjectProxy.NewRow();
                                RN["ProjectID"] = R["ProjectID"];
                                RN["Project"] = R["Project"];
                                RN["ProjectURI"] = R["ProjectURI"];
                                dtProjectProxy.Rows.Add(RN);
                            }
                            else
                            {
                                if (R["Project"].ToString() == rr[0]["Project"].ToString())
                                {
                                    rr[0]["ProjectURI"] = R["ProjectURI"];
                                }
                                else
                                {
                                    if (System.Windows.Forms.MessageBox.Show("The ProjectID " + R["ProjectID"].ToString() + " for the project " + R["Project"].ToString() + " is used for the project " + rr[0]["Project"].ToString(), "Change project name", MessageBoxButtons.YesNo) == System.Windows.Forms.DialogResult.Yes)
                                        rr[0]["Project"] = R["Project"];
                                }
                            }
                        }
                        ProjectBindingSource.EndEdit();
                        adProjectProxy.Update(dtProjectProxy);
                    }
                    if (f.DifferingProjectRows.Count > 0)
                    {
                        foreach (System.Data.DataRow R in f.DifferingProjectRows)
                        {
                            System.Data.DataRow[] rr = dtProjectProxy.Select("ProjectID = " + R["ProjectID"].ToString());
                            if (System.Windows.Forms.MessageBox.Show("The ProjectID " + R["ProjectID"].ToString() + " for the project\r\n" + R["Project"].ToString() + "\r\nis used for the project\r\n" + rr[0]["Project"].ToString() + "\r\n\r\nDo you want to change the name to\r\n" + R["Project"].ToString(), "Change project name", MessageBoxButtons.YesNo) == System.Windows.Forms.DialogResult.Yes)
                                rr[0]["Project"] = R["Project"];
                        }
                        ProjectBindingSource.EndEdit();
                        adProjectProxy.Update(dtProjectProxy);
                    }
                }
            }
            catch (Exception ex)
            {
            }
        }

        private void processingToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityCollection.FormProcessing f = new FormProcessing();
            if (f.Width > this.Width - 20)
                f.Width = this.Width - 20;
            if (f.Height > this.Height - 20)
                f.Height = this.Height - 20;
            f.ShowDialog();
            if (f.ChangeToSpecimen)
            {
                this.userControlQueryList.listBoxQueryResult.SelectedIndex = -1;
                this.setSpecimen(f.CollectionSpecimenID);
            }
            DiversityCollection.LookupTable.ResetProcessing();
            this.setProcessingSource();
            this.initQueryOptimizing();
        }

        private void setProcessingSource()
        {
            try
            {
                if (this.comboBoxProcessingID.SelectedIndex > -1)
                {
                    int Position = this.comboBoxProcessingID.SelectedIndex;
                    System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxProcessingID.SelectedItem;
                    int ProcessingIDBefore = int.Parse(R["ProcessingID"].ToString());
                    this._dtProcessing = null;
                    int ProcessingIDAfter = int.Parse(this.DtProcessing.Rows[Position]["ProcessingID"].ToString());
                    if (ProcessingIDAfter == ProcessingIDBefore)
                    {
                        this.comboBoxProcessingID.DataSource = null;
                        this.comboBoxProcessingID.DataSource = this.DtProcessing;
                        this.comboBoxProcessingID.DisplayMember = "DisplayText";
                        this.comboBoxProcessingID.ValueMember = "ProcessingID";
                        this.comboBoxProcessingID.SelectedIndex = Position;
                    }
                }
                else
                {
                    this._dtProcessing = null;
                    this.comboBoxProcessingID.DataSource = null;
                    this.comboBoxProcessingID.DataSource = this.DtProcessing;
                    this.comboBoxProcessingID.DisplayMember = "DisplayText";
                    this.comboBoxProcessingID.ValueMember = "ProcessingID";
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void regulationsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            return;

            DiversityCollection.Forms.FormRegulation f = new Forms.FormRegulation();
            f.setHelp("Regulation");
            f.ShowDialog();
            //LookupTable.ResetRegulation();
        }

        private void resourcesDirectoryToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Settings.setResourcesDirectory();
        }

        private void sitePropertiesToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityCollection.Forms.FormProperty f = new Forms.FormProperty();
            f.ShowDialog();
        }

        private void stableIdentifierToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Forms.FormStableIdentifier f = new DiversityWorkbench.Forms.FormStableIdentifier();//dtProject);
            f.setHelp("Stable identifier");
            f.ShowDialog();
        }

        private void taxonomicGroupsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                DiversityWorkbench.Forms.FormEnumAdministration f = new DiversityWorkbench.Forms.FormEnumAdministration(
                    DiversityCollection.Resource.Plant,
                    "CollTaxonomicGroup_Enum",
                    "Administration of taxonomic groups",
                    "",
                    DiversityCollection.Specimen.TaxonomicGroup_Images);//, Directory);
                f.HierarchyChangesEnabled = true;
                f.setHelp("Taxonomic group");
                f.labelCode.TextChanged += new EventHandler(this.TaxonomicGroup_TextChanged);
                f.setOption("", DiversityCollection.Resource.DiversityWorkbench);
                f.ShowDialog();
                if (f.DataHaveBeenChanged)
                {
                    DiversityWorkbench.CollectionSpecimen.TaxonomyRelatedTaxonomicGroups = null;
                    DiversityCollection.Specimen.TaxonomicGroup_Images = f.Images;
                    this.setTaxonomicGroupSource();
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void TaxonomicGroup_TextChanged(object sender, EventArgs e)
        {
            try
            {
                System.Windows.Forms.Label L = (System.Windows.Forms.Label)sender;
                System.Windows.Forms.TableLayoutPanel T = (System.Windows.Forms.TableLayoutPanel)L.Parent;
                foreach (System.Windows.Forms.Control C in T.Controls)
                {
                    if (C.Name == "labelOption")
                    {
                            System.Windows.Forms.Label LO = (System.Windows.Forms.Label)C;
                        if (DiversityWorkbench.CollectionSpecimen.TaxonomyRelatedTaxonomicGroups.Contains(L.Text))
                            LO.Text = "Source for identification: DiversityTaxonNames";
                        else
                            LO.Text = "Source for identification: DiversityScientificTerms";
                        break;
                    }
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        private void setTaxonomicGroupSource()
        {
            DiversityCollection.LookupTable.ResetTaxonomicGroupList();
            DiversityCollection.Specimen.ResetTaxonomicGroup_Images();
            this.setToolStripDropDownButtonOverviewHierarchyNewUnitWithAdaptiveHierarchy();
        }

        private void toolsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityCollection.Forms.FormTool f = new Forms.FormTool();
            if (f.Width > this.Width - 20)
                f.Width = this.Width - 20;
            if (f.Height > this.Height - 20)
                f.Height = this.Height - 20;
            f.ShowDialog();
            DiversityCollection.LookupTable.ResetTool();
            return;
        }

        private void methodsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            //System.Windows.Forms.MessageBox.Show("Available in upcoming version");//
            //return;
            DiversityCollection.Forms.FormMethod f = new Forms.FormMethod();
            if (f.Width > this.Width - 20)
                f.Width = this.Width - 20;
            if (f.Height > this.Height - 20)
                f.Height = this.Height - 20;
            f.setHelp("Method");
            f.ShowDialog();
            DiversityCollection.LookupTable.ResetMethod();
            return;
        }

        private void materialCategoriesToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Forms.FormEnumAdministration f = new DiversityWorkbench.Forms.FormEnumAdministration(
                DiversityCollection.Resource.Specimen,
                "CollMaterialCategory_Enum",
                "Administration of material categories",
                "",
                DiversityCollection.Specimen.MaterialCategory_Images);
            f.HierarchyChangesEnabled = true;
            f.setHelp("Material Category");
            f.ShowDialog();
            if (f.DataHaveBeenChanged)
            {
                DiversityCollection.Specimen.MaterialCategory_Images = f.Images;
                this.setMaterialCategoriesSource();
            }
        }

        private void setMaterialCategoriesSource()
        {
            DiversityCollection.LookupTable.ResetMaterialCategoryList();
            DiversityCollection.Specimen.Reset_MaterialCategory_Images();
            this.setToolStripDropDownButtonOverviewHierarchyNewPartWithAdaptiveHierarchy();
        }

        private void retrievalTypeToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Forms.FormEnumAdministration f = new DiversityWorkbench.Forms.FormEnumAdministration(
                DiversityCollection.Resource.Observation,
                "CollRetrievalType_Enum",
                "Administration of retrieval types",
                "");
            f.HierarchyChangesEnabled = true;
            f.setHelp("Retrieval type");
            f.ShowDialog();
            this.setRetrievalTypeSource();
        }

        private void setRetrievalTypeSource()
        {
            DiversityCollection.LookupTable.ResetDtRetrievalType();
            System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxUnitRetrievalType, "CollRetrievalType_Enum", con, true, true, true);
        }

        #region Transaction
        
        private void transactionToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try 
            {
                DiversityCollection.FormTransaction f = new FormTransaction();
                if (f.Width > this.Width - 20)
                    f.Width = this.Width - 20;
                if (f.Height > this.Height - 20)
                    f.Height = this.Height - 20;
                f.ShowDialog();
                if (f.DialogResult == DialogResult.OK)
                {
                    if (f.ChangeToSpecimen)
                        this.setSpecimen(f.CollectionSpecimenID);
                }
                DiversityCollection.LookupTable.ResetTransaction();
                this.initQueryOptimizing();
            }
            catch(System.Exception ex)
            {

            }
        }

        private void externalDatasourcesToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityCollection.FormExternalDatasource f = new FormExternalDatasource();
            f.setHelpProviderNameSpace(System.Windows.Forms.Application.StartupPath + "\\DiversityCollection.chm", "External source");
            f.ShowDialog();
        }

        private void expiredLoansToolStripMenuItem_Click(object sender, EventArgs e)
        {
            string SQL = "WHERE TransactionID IN ( " +
                "SELECT  DISTINCT [Transaction].TransactionID " +
                "FROM [Transaction] INNER JOIN " +
                "CollectionSpecimenTransaction ON [Transaction].TransactionID = CollectionSpecimenTransaction.TransactionID INNER JOIN " +
                "CollectionManager ON [Transaction].AdministratingCollectionID = CollectionManager.AdministratingCollectionID " +
                "WHERE (CollectionManager.LoginName = USER_NAME())  " +
                "AND (CollectionSpecimenTransaction.TransactionReturnID IS NULL ) " +
                "AND (CASE WHEN [Transaction].ActualEndDate IS NULL THEN [Transaction].AgreedEndDate ELSE [Transaction].ActualEndDate END < GETDATE())  " +
                "AND NOT [Transaction].AgreedEndDate IS NULL  " +
                "AND ([Transaction].TransactionType = N'loan' OR [Transaction].TransactionType = N'forwarding'))";
            string Description = "Expired loans";
            DiversityCollection.FormTransaction f = new FormTransaction(SQL, Description);
            f.Width = this.Width - 20;
            f.Height = this.Height - 20;
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                if (f.ChangeToSpecimen)
                    this.setSpecimen(f.CollectionSpecimenID);
                DiversityCollection.LookupTable.ResetTransaction();
            }
            this.initQueryOptimizing();
        }

        private void loanRequestsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            string SQL = "WHERE TransactionID IN (SELECT TransactionID FROM TransactionForeignRequest)";
            string Description = "Foreign loan requests";
            DiversityCollection.FormTransaction f = new FormTransaction(SQL, Description);
            f.Width = this.Width - 20;
            f.Height = this.Height - 20;
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                if (f.ChangeToSpecimen)
                    this.setSpecimen(f.CollectionSpecimenID);
                DiversityCollection.LookupTable.ResetTransaction();
            }
            this.initQueryOptimizing();
        }

        private void myRequestsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            string SQL = "WHERE TransactionID IN (SELECT TransactionID FROM TransactionUserRequest)";
            string Description = "My requests";
            DiversityCollection.FormTransaction f = new FormTransaction(SQL, Description, true);
            f.Width = this.Width - 20;
            f.Height = this.Height - 20;
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                if (f.ChangeToSpecimen)
                    this.setSpecimen(f.CollectionSpecimenID);
                DiversityCollection.LookupTable.ResetTransaction();
            }
            this.initQueryOptimizing();
        }

        private void loanRequestorsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityCollection.FormRequester f = new FormRequester();
            if (f.Width > this.Width - 20)
                f.Width = this.Width - 20;
            if (f.Height > this.Height - 20)
                f.Height = this.Height - 20;
            f.ShowDialog();
        }

        private void curatorsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityCollection.FormManagers f = new FormManagers();
            f.Width = this.Width - 20;
            //if (f.Width > this.Width - 20)
            //    f.Width = this.Width - 20;
            //else
            //    f.Width = this.Width - 10;
            if (f.Height > this.Height - 20)
                f.Height = this.Height - 20;
            f.ShowDialog();
            DiversityCollection.LookupTable.ResetManagedCollections();
        }

        private void collectionUsersToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityCollection.Forms.FormCollectionUser f = new Forms.FormCollectionUser();
            f.Width = this.Width - 20;
            f.Height = this.Height - 20;
            f.StartPosition = FormStartPosition.CenterParent;
            f.setHelp("Collection user");
            f.ShowDialog();
            DiversityCollection.LookupTable.ResetCollection();
        }

        private void transferToTransactionToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.transferTransactionToolStripMenuItem_Click(null, null);
        }


        #endregion

        #region Obsolet

        //private void databaseToolsToolStripMenuItem_Click(object sender, EventArgs e)
        //{
        //    DiversityWorkbench.Forms.FormDatabaseTool f = new DiversityWorkbench.Forms.FormDatabaseTool();
        //    f.ShowDialog();
        //}

        private void userToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.FormUserAdministration f = new DiversityWorkbench.FormUserAdministration(DiversityWorkbench.Settings.ConnectionString, System.Windows.Forms.Application.StartupPath + "\\DiversityCollection.chm");
            f.setHelpProviderNameSpace(System.Windows.Forms.Application.StartupPath + "\\DiversityCollection.chm", "User administration");
            if (f.Width > this.Width - 20)
                f.Width = this.Width - 20;
            if (f.Height > this.Height - 20)
                f.Height = this.Height - 20;
            f.ShowDialog();
            DiversityCollection.LookupTable.ResetUser();
        }

        private void versionsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            string VersionClient = System.Windows.Forms.Application.ProductVersion.ToString();
            string VersionDB = DiversityCollection.Properties.Settings.Default.DatabaseVersion;
            string EditDbVersion = "Please edit the DatabaseVersion in the source code setting DiversityCollection - Properties - Settings";
            DiversityWorkbench.FormVersion f = new DiversityWorkbench.FormVersion(VersionDB, EditDbVersion);
            f.ShowDialog();
        }
        
        #endregion

        #endregion

        #region Help

        private void setHelpMenu()
        {
            if (DiversityWorkbench.Database.DatabaseRoles().Contains("Administrator")
                || DiversityWorkbench.Database.DatabaseRoles().Contains("db_owner"))
            {
                this.editFeedbackToolStripMenuItem.Visible = true;// = true; //  ToDo
            }
            else
                this.editFeedbackToolStripMenuItem.Visible = false;

            bool OK = this.FormFunctions.getObjectPermissions("CollectionSpecimen", "UPDATE");
            this.feedbackHistoryToolStripMenuItem.Visible = OK;
            OK = this.FormFunctions.getObjectPermissions("CollectionSpecimen", "SELECT");
            this.statisticsToolStripMenuItem.Visible = OK;

            this.generateTraceFileToolStripMenuItem.Visible = false;

        }

        private void manualToolStripMenuItem_Click(object sender, EventArgs e)
        {
            try
            {
                string Manual = this.helpProviderDiversityCollection.HelpNamespace;
                System.Diagnostics.Process.Start(Manual);
            }
            catch { }
        }

        private void infoToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityCollection.FormAbout f = new FormAbout();
            f.ShowDialog();
        }

        private void feedbackToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Feedback.SendFeedback(
                System.Reflection.Assembly.GetAssembly(this.GetType()).GetName().Version.ToString(), 
                this.userControlQueryList.QueryString(), 
                this.ID.ToString());
        }

        private void feedbackHistoryToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Feedback.FeedbackHistory();
        }

        private void editFeedbackToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Feedback.EditFeedback();
        }

        private void informationModelToolStripMenuItem_Click(object sender, EventArgs e)
        {
            System.Diagnostics.Process.Start("http://www.diversityworkbench.net/Portal/DiversityCollection_Information_Models");
            //DiversityWorkbench.FormWebBrowser f = new DiversityWorkbench.FormWebBrowser("http://www.diversityworkbench.net/Portal/DiversityCollection_Information_Models");
            //f.StartPosition = FormStartPosition.CenterParent;
            //f.ShowDialog();
        }

        private void downloadApplicationsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            System.Diagnostics.Process.Start("http://www.diversityworkbench.net/Portal/DiversityCollection");
            //DiversityWorkbench.FormWebBrowser f = new DiversityWorkbench.FormWebBrowser("http://www.diversityworkbench.net/Portal/DiversityCollection");
            //f.StartPosition = FormStartPosition.CenterParent;
            //f.ShowDialog();
        }

        private void diversityMobileToolStripMenuItem_Click(object sender, EventArgs e)
        {
            System.Diagnostics.Process.Start("http://www.diversitymobile.net/wiki/Main_Page");
            //DiversityWorkbench.FormWebBrowser f = new DiversityWorkbench.FormWebBrowser("http://www.diversitymobile.net/wiki/Main_Page");
            //f.StartPosition = FormStartPosition.CenterParent;
            //f.ShowDialog();
        }

        private void gitHubToolStripMenuItem_Click(object sender, EventArgs e)
        {
        }

        private void gitHubSNSBToolStripMenuItem_Click(object sender, EventArgs e)
        {
            System.Diagnostics.Process.Start("https://github.com/SNSB/DWB-Contrib/tree/master/DiversityCollection");
        }

        private void gitHubZFMKToolStripMenuItem_Click(object sender, EventArgs e)
        {
            System.Diagnostics.Process.Start("https://github.com/ZFMK");
        }

        private void statisticsToolStripMenuItem_Click(object sender, EventArgs e)
        {
            // Show start window
            DiversityWorkbench.Forms.FormStarting fs = new DiversityWorkbench.Forms.FormStarting("Computing statistics...", DiversityCollection.Resource.GRAPH01);
            fs.Show();
            Application.DoEvents();

            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            DiversityCollection.FormStatistics f = new FormStatistics(this.userControlQueryList.ListOfIDs);
            f.Width = this.Width - 20;
            f.Height = this.Height - 20;
            f.StartPosition = FormStartPosition.CenterParent;
            DiversityWorkbench.FormFunctions.SetHelp(this.helpProviderDiversityCollection, f, "Statistics");
            this.Cursor = System.Windows.Forms.Cursors.Default;
            // Close start window
            fs.Close();

            f.ShowDialog();
        }

        private void generateTraceFileToolStripMenuItem_CheckedChanged(object sender, EventArgs e)
        {

        }

        private void generateTraceFileToolStripMenuItem_Click(object sender, EventArgs e)
        {

        }

        #endregion

        #region Update

        private void setVersionToolStripMenuItem_Click(object sender, EventArgs e)
        {
            string VersionClient = System.Windows.Forms.Application.ProductVersion.ToString();
            string VersionDB = DiversityCollection.Properties.Settings.Default.DatabaseVersion;
            string EditDbVersion = "Please edit the DatabaseVersion in the source code setting DiversityCollection - Properties - Settings";
            DiversityWorkbench.FormVersion f = new DiversityWorkbench.FormVersion(VersionDB, EditDbVersion);
            f.ShowDialog();
        }
        
        private void setUpdateMenu()
        {
            this.setVersionToolStripMenuItem.Visible = false;
            string SQL = "select user_name()";
            string User = "";
            bool UpdateDatabase = false;
            bool UpdateClient = false;
            if (DiversityWorkbench.Settings.ConnectionString.Length > 0)
            {
                System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                System.Data.SqlClient.SqlCommand C = new System.Data.SqlClient.SqlCommand(SQL, con);
                try
                {
                    con.Open();
                    User = C.ExecuteScalar().ToString();
                    con.Close();
                    bool IsOwner = false;
                    if (DiversityWorkbench.Database.DatabaseRoles().Contains("db_owner"))
                        IsOwner = true;
                    if (User == "dbo" || IsOwner)
                    {
                        UpdateDatabase = this.UpdateCheckForDatabase();
                        this.updateDatabaseToolStripMenuItem.Visible = UpdateDatabase;
                    }
                    string Version = "";
                    UpdateClient = this.UpdateCheckForClient(ref Version);
                    //UpdateClient = true;
                    this.updateClientToolStripMenuItem.Visible = UpdateClient;
                    this._ClientIsOutdated = UpdateClient;
                    if (UpdateClient)
                        this.updateClientToolStripMenuItem.Text = "Download client version " + Version;

                    if (UpdateClient || UpdateDatabase)
                        this.updateToolStripMenuItem.Visible = true;
                    else this.updateToolStripMenuItem.Visible = false;
                }
                catch { }
            }
        }

        private void updateDatabaseToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.UpdateDatabase();
        }

        private void updateClientToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.UpdateClient();
        }

        #endregion

        #region Test

        private void setSettingToolStripMenuItem_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Settings.DatabaseUser = "TestColl";
        }

        private void getSettingToolStripMenuItem_Click(object sender, EventArgs e)
        {
            System.Windows.Forms.MessageBox.Show(DiversityWorkbench.Settings.DatabaseUser);
        }

        #endregion

        #region Context and language

        private void setContextMenu()
        {
            try
            {
                if (DiversityWorkbench.Settings.ConnectionString.Length > 0)
                {
                    bool OK = DiversityWorkbench.Entity.EntityTablesExist;
                    this.languageToolStripMenuItem.Visible = OK;
                    this.contextToolStripMenuItem.Visible = OK;
                    if (OK)
                    {
                        string CurrentContext = DiversityWorkbench.Settings.Context;
                        System.Data.DataRow[] RR = DiversityWorkbench.Entity.DtContext.Select("Code = '" + DiversityWorkbench.Settings.Context + "'", "");
                        if (RR.Length == 1)
                            CurrentContext = RR[0]["DisplayText"].ToString();
                        else
                        {
                            System.Data.DataRow[] RRdefault = DiversityWorkbench.Entity.DtContext.Select("Code = 'General'", "");
                            if (RRdefault.Length == 1)
                            {
                                CurrentContext = RRdefault[0]["DisplayText"].ToString();
                                DiversityWorkbench.Settings.Context = CurrentContext;
                                DiversityWorkbench.Entity.setEntity(this, this.toolTip);
                                this.contextToolStripMenuItem.Text = DiversityCollection.Forms.FormCollectionSpecimenText.Context + ": " + CurrentContext;// DiversityWorkbench.Settings.Context;
                            }
                            else
                                DiversityWorkbench.Settings.Context = "";
                        }
                        //this.contextToolStripMenuItem.Text = DiversityCollection.Forms.FormCollectionSpecimenText.Context + ": " + CurrentContext;
                        if (DiversityWorkbench.Settings.Context.Length == 0)
                            this.contextToolStripMenuItem.Text += "?";
                        this.languageToolStripMenuItem.Image = DiversityWorkbench.Entity.LanguageImage;
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
#if !DEBUG
#endif
            // MW 29.10.2018
            // Wurde aufgenommen um fuer die Datumsformatierung zwischen US und GB unterscheiden zu koennen. 
            // Laeuft noch nicht fehlerfrei, insbesondere bei Wechsel zwischen Datenbanken wenn Eintrag in EntityLanguageCode_Enum fehlt
            // Wird erst bei Bedarf reaktiviert
            this.englishGBToolStripMenuItem.Visible = false;
            this.englishtoolStripMenuItem.Image = DiversityCollection.Resource.English;
            this.englishtoolStripMenuItem.Text = "English";
            this.languageToolStripMenuItem.Image = DiversityCollection.Resource.English;
        }

        private void englishtoolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.setLanguage("en-US");
        }

        private void deutschtoolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.setLanguage("de-DE");
        }

        private void englishGBToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.setLanguage("en-GB");
        }

        private void contextToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (DiversityWorkbench.Entity.DtContext.Rows.Count == 0)
                return;

            DiversityWorkbench.FormGetStringFromList f = new DiversityWorkbench.FormGetStringFromList(DiversityWorkbench.Entity.DtContext, "DisplayText", "Code", "Context", "Please select a context");
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                if (DiversityWorkbench.Settings.Context != f.SelectedValue)
                {
                    DiversityWorkbench.Settings.Context = f.SelectedValue;
                    DiversityWorkbench.Entity.setEntity(this, this.toolTip);
                    this.contextToolStripMenuItem.Text = DiversityCollection.Forms.FormCollectionSpecimenText.Context + ": " + f.SelectedString;// DiversityWorkbench.Settings.Context;
                }
            }
        }

        private void setLanguage()
        {
            if (DiversityWorkbench.Settings.Language != "en-US")
            {
                DiversityCollection.LookupTable.ResetLanguageVariantLookupTables();
                this.languageToolStripMenuItem.Image = DiversityWorkbench.Entity.LanguageImage;
                DiversityWorkbench.Entity.setEntity(this, this.toolTip);
                if (DiversityWorkbench.Settings.Language != System.Globalization.CultureInfo.CurrentUICulture.Name)
                {
                    System.Threading.Thread.CurrentThread.CurrentUICulture = new System.Globalization.CultureInfo(DiversityWorkbench.Settings.Language);
                }
            }
        }

        private void setLanguage(string LanguageCode)
        {
            try
            {
                if (LanguageCode != DiversityWorkbench.Settings.Language)
                {
                    DiversityWorkbench.Settings.Language = LanguageCode;
                    DiversityCollection.LookupTable.ResetLanguageVariantLookupTables();
                    this.languageToolStripMenuItem.Image = DiversityWorkbench.Entity.LanguageImage;
                    DiversityWorkbench.Entity.setEntity(this, this.toolTip);
                    // Notloesung - sollte von obiger Funktion aufgerufen werden, klappt aber nicht
                    this.userControlQueryList.setEntity();
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            try
            {
                if (DiversityWorkbench.Settings.Language != System.Globalization.CultureInfo.CurrentUICulture.Name)
                {
                    System.Threading.Thread.CurrentThread.CurrentUICulture = new System.Globalization.CultureInfo(DiversityWorkbench.Settings.Language);
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            this.setMenuText(this.menuStripMain);
        }

        private void setMenuText(System.Windows.Forms.MenuStrip Menu)
        {
            try
            {
                foreach (System.Object O in Menu.Items)
                {
                    if (O.GetType() == typeof(System.Windows.Forms.ToolStripMenuItem))
                    {
                        System.Windows.Forms.ToolStripMenuItem M = (System.Windows.Forms.ToolStripMenuItem)O;
                        this.getMenuText(M);
                        foreach (System.Object Ochild in M.DropDownItems)
                        {
                            try
                            {
                                if (Ochild.GetType() == typeof(System.Windows.Forms.ToolStripMenuItem))
                                {
                                    try
                                    {
                                        System.Windows.Forms.ToolStripMenuItem MT = (System.Windows.Forms.ToolStripMenuItem)Ochild;
                                        this.getMenuText(MT);
                                        this.setMenuText(MT);
                                    }
                                    catch (System.Exception ex) { }
                                }
                            }
                            catch (System.Exception ex)
                            {
                            }
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setMenuText(System.Windows.Forms.ToolStripMenuItem Menu)
        {
            foreach (System.Windows.Forms.ToolStripMenuItem M in Menu.DropDownItems)
            {
                this.getMenuText(M);
                try
                {
                    foreach (System.Object Mchild in M.DropDownItems)
                    {
                        if (Mchild.GetType() == typeof(System.Windows.Forms.ToolStripMenuItem))
                        {
                            System.Windows.Forms.ToolStripMenuItem MT = (System.Windows.Forms.ToolStripMenuItem)Mchild;
                            this.getMenuText(MT);
                            this.setMenuText(MT);
                        }
                    }
                }
                catch (System.Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void getMenuText(System.Windows.Forms.ToolStripMenuItem M)
        {
            try
            {
                if (M.AccessibleName == null || M.AccessibleName.Length == 0)
                {
                    M.AccessibleName = M.Text.Replace(" ", "_");
                    if (M.AccessibleName.StartsWith("&"))
                        M.AccessibleName = M.AccessibleName.Substring(1);
                }
                string Title = this.Message(M.AccessibleName.Replace("_...", ""));
                if (M.Text != null && M.Text.EndsWith("...") && Title != null)
                    Title += " ...";
                if (Title != null && Title.Length > 0 && Title != " ...")
                    M.Text = Title;
                else if (M.AccessibleName.Length > 0 && (M.Text == null || M.Text.Length == 0))
                    M.Text = M.AccessibleName.Replace("_", " ");
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion        

        #endregion

        #region Update

        /// <summary>
        /// Checks if a new version of the client is available
        /// This is documented in the database with the function dbo.VersionClient()
        /// </summary>
        /// <returns>true = New version is available. false = no new version</returns>
        private bool UpdateCheckForClient(ref string Version)
        {
            bool Update = false;
            int VersionMajor = System.Reflection.Assembly.GetAssembly(this.GetType()).GetName().Version.Major;
            int VersionMinor = System.Reflection.Assembly.GetAssembly(this.GetType()).GetName().Version.Minor;
            int VersionBuild = System.Reflection.Assembly.GetAssembly(this.GetType()).GetName().Version.Build;
            int VersionRevision = System.Reflection.Assembly.GetAssembly(this.GetType()).GetName().Version.Revision;
            //VersionRevision = 19; - nur fuer Test
            string CurrentClientVersion = System.Reflection.Assembly.GetAssembly(this.GetType()).GetName().Version.ToString();
            string ClientVersionAsInDB = "";
            Version = DiversityWorkbench.FormFunctions.LatestClientVersion;

            try
            {
                string[] VersionParts;
                if (Version.IndexOf('/') > -1)
                    VersionParts = Version.Split(new char[] { '/' });
                else
                    VersionParts = Version.Split(new char[] { '.' });

                int LastVersionMajor = int.Parse(VersionParts[0]);
                int LastVersionMinor = int.Parse(VersionParts[1]);
                int LastVersionBuild = int.Parse(VersionParts[2]);
                int LastVersionRevision = int.Parse(VersionParts[3]);
                if (LastVersionMajor != VersionMajor
                    || LastVersionMinor != VersionMinor
                    || LastVersionBuild != VersionBuild
                    || LastVersionRevision != VersionRevision)
                {
                    if (LastVersionMajor > VersionMajor)
                        Update = true;
                    else if (LastVersionMajor == VersionMajor)
                    {
                        if (LastVersionMinor > VersionMinor)
                            Update = true;
                        else if (LastVersionMinor == VersionMinor)
                        {
                            if (LastVersionBuild > VersionBuild)
                                Update = true;
                            else if (LastVersionBuild == VersionBuild)
                            {
                                if (LastVersionRevision > VersionRevision)
                                    Update = true;
                                else Update = false;
                            }
                            else Update = false;
                        }
                        else Update = false;
                    }
                    else Update = false;
                }
            }
            catch { }

            if (Update)
            {
                this.updateClientToolStripMenuItem.ToolTipText = "The Version of your client is " + CurrentClientVersion + ". Please update to new client version " + ClientVersionAsInDB;
            }
            else
            {
                this.updateClientToolStripMenuItem.ToolTipText = "No updates for client";
            }
            return Update;
        }

        private void UpdateClient()
        {
            DiversityWorkbench.FormWebBrowser f = new DiversityWorkbench.FormWebBrowser(DiversityWorkbench.FormFunctions.WikiDownloadPath("DiversityCollection"));
            f.ShowDialog();
        }
        
        private bool UpdateCheckForDatabase()
        {
            bool Update = false;
            string SQL = "select dbo.Version()";
            string Version = "";
            System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            System.Data.SqlClient.SqlCommand C = new System.Data.SqlClient.SqlCommand(SQL, con);
            try
            {
                con.Open();
                Version = C.ExecuteScalar().ToString();
                con.Close();
            }
            catch { }
            try
            {
                if (Version != DiversityCollection.Properties.Settings.Default.DatabaseVersion)
                {
                    int DBversionMajor;
                    int DBversionMinor;
                    int DBversionRevision;
                    int C_versionMajor;
                    int C_versionMinor;
                    int C_versionRevision;
                    string[] VersionDBParts;
                    if (Version.IndexOf('.') > -1) VersionDBParts = Version.Split(new Char[] { '.' });
                    else if (Version.IndexOf('/') > -1) VersionDBParts = Version.Split(new Char[] { '/' });
                    else VersionDBParts = Version.Split(new Char[] { ' ' });
                    if (!int.TryParse(VersionDBParts[0], out DBversionMajor)) return false;
                    if (!int.TryParse(VersionDBParts[1], out DBversionMinor)) return false;
                    if (!int.TryParse(VersionDBParts[2], out DBversionRevision)) return false;

                    string[] VersionC_Parts = DiversityCollection.Properties.Settings.Default.DatabaseVersion.Split(new Char[] { '.' });
                    if (!int.TryParse(VersionC_Parts[0], out C_versionMajor)) return false;
                    if (!int.TryParse(VersionC_Parts[1], out C_versionMinor)) return false;
                    if (!int.TryParse(VersionC_Parts[2], out C_versionRevision)) return false;

                    if (C_versionMajor > DBversionMajor ||
                        (C_versionMajor == DBversionMajor && C_versionMinor > DBversionMinor) ||
                        (C_versionMajor == DBversionMajor && C_versionMinor == DBversionMinor && C_versionRevision > DBversionRevision))
                        Update = true;
                }

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            } 

            if (Update) this.updateDatabaseToolStripMenuItem.ToolTipText = "Your version of the database is " + Version + ". Please update the database to version " + DiversityCollection.Properties.Settings.Default.DatabaseVersion;
            else this.updateDatabaseToolStripMenuItem.ToolTipText = "No updates for database";
            return Update;
        }

        private void UpdateDatabase()
        {
            try
            {
                string DatabaseCurrentVersion = "";
                string SQL = "select dbo.Version()";
                System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                System.Data.SqlClient.SqlCommand C = new System.Data.SqlClient.SqlCommand(SQL, con);
                try
                {
                    con.Open();
                    DatabaseCurrentVersion = C.ExecuteScalar().ToString();
                    con.Close();
                }
                catch { }
                DatabaseCurrentVersion = DatabaseCurrentVersion.Replace(".", "").Replace("/", "");
                string DatabaseFinalVersion = DiversityCollection.Properties.Settings.Default.DatabaseVersion;
                DatabaseFinalVersion = DatabaseFinalVersion.Replace(".", "").Replace("/", "");

                // check resouces for update scripts
                System.Collections.Generic.Dictionary<string, string> Versions = new Dictionary<string, string>();
                System.Resources.ResourceManager rm = Properties.Resources.ResourceManager;
                System.Resources.ResourceSet rs = rm.GetResourceSet(new System.Globalization.CultureInfo("en-US"), true, true);
                if (rs != null)
                {
                    System.Collections.IDictionaryEnumerator de = rs.GetEnumerator();
                    while (de.MoveNext() == true)
                    {
                        if (de.Entry.Value is string)
                        {
                            if (de.Key.ToString().StartsWith("DiversityCollectionUpdate_"))
                            {
                                Versions.Add(de.Key.ToString(), de.Value.ToString());
                            }
                        }
                    }
                }

                if (Versions.Count > 0)
                {
                    DiversityWorkbench.FormUpdateDatabase f = new DiversityWorkbench.FormUpdateDatabase(DiversityWorkbench.Settings.DatabaseName, DiversityCollection.Properties.Settings.Default.DatabaseVersion, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityWorkbench.Settings.TimeoutDatabase), Versions, System.Windows.Forms.Application.StartupPath + "\\DiversityCollection.chm");
                    f.ShowDialog();
                    if (f.Reconnect) this.setDatabase();
                    this.setUpdateMenu();
                }
                else
                {
                    System.Windows.Forms.MessageBox.Show("Upgrade resources are missing");
                }

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #region Form

        private DiversityWorkbench.FormFunctions FormFunctions
        {
            get
            {
                if (this._FormFunctions == null)
                    this._FormFunctions = new DiversityWorkbench.FormFunctions(this, DiversityWorkbench.Settings.ConnectionString, ref this.toolTip);
                return this._FormFunctions;
            }
        }

        private void initForm()
        {
            try
            {
                // TODO: nach fertigstellung der CacheDB wieder aktivieren
                this.cacheDatabaseToolStripMenuItem.Visible = false;
                this.cacheDBToolStripMenuItem.Visible = false;

                // alter Ansatz - obsolet
                this.regulationsToolStripMenuItem.Visible = false;

                // TODO: falls wieder benutzbar einblende
                this.toolStripDropDownButtonImagePropertyArea.Visible = false;

                this.setCulture();
                this.setMenuText(this.menuStripMain);
                this.AcceptButton = this.userControlDialogPanel.buttonOK;
                this.CancelButton = this.userControlDialogPanel.buttonCancel;
                this.FormFunctions.addEditOnDoubleClickToTextboxes();

                //#if DEBUG Wunsch A. Jandl, Feedback 12.03.2018 10:59
                this.FormFunctions.addRestrictLengthToTextboxes();
                //this.FormFunctions.setMaxLengthForTextboxes();
                //#endif

                this.setDatabindings();
                //this.initRemoteModules(); // Aufruf 2

                this.setPicklists();
                this.setViewMode();
                this.initDataWithholdingControls();
                this.splitContainerData.SplitterDistance = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.SplitContainerData_SplitterDistance;
                this.setImageVisibility(DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.ImageDisplay);
                this.treeViewOverviewHierarchy.ImageList = DiversityCollection.Specimen.ImageList;
                this.treeViewOverviewHierarchyStorage.ImageList = DiversityCollection.Specimen.ImageList;
                this.tableLayoutPanelBackground.Dock = DockStyle.Fill;
                this.tableLayoutPanelBackground.Visible = true;
                this.toolStripScanTarget.Visible = false;
                this.initAnalysisDisplayMode();
                this.initSamplingPlotDisplayMode();
                this.initEventSeriesDisplayMode();
                this.userControlImageSpecimenImage.MaxSizeOfImageVisible = true;
                this.toolTip.AutoPopDelay = 30000;
                //TODO: unklar warum diese Controls verschwinden
                if (this.comboBoxCollection.Visible == false)
                    this.comboBoxCollection.Visible = true;
                if (this.labelCollection.Visible == false)
                    this.labelCollection.Visible = true;

                this.toolStripButtonOverviewHierarchyDisplayShowOnLoan.Visible = false;

                this.userControlQueryList.RememberSettingIsAvailable(true);
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setCulture()
        {
            try
            {
                if (DiversityWorkbench.Settings.Language != System.Globalization.CultureInfo.CurrentUICulture.Name)
                {
                    System.Threading.Thread.CurrentThread.CurrentUICulture = new System.Globalization.CultureInfo(DiversityWorkbench.Settings.Language);
                }
            }
            catch  { }
        }

        private void setAutoCompletion()
        {
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxAccessionDateCategory);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxAnalysisResult);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxAnalysisSpecimenPart);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxCircumstances);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxCollectionEventSeriesImageType);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxCollectionSpecimenDataWithholdingReason);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxCollectorDataWithholdingReason);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxDataWithholdingReasonEvent);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxEventImageDataWithholdingReason);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxEventImageType);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxExternalSource);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxGender);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxHeaderDataWithholdingReason);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxIdentificationCategory);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxIdentificationQualifier);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxLabelTitle);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxLabelTranscriptionState);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxLabelType);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxLifeStage);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxMaterialCategory);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxPreparationMethod);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxRelatedSpecimenRelationType);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxRevisionState);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxSpecimenImageType);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxStorageLocation);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxStorageNotes);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxSubstrateRelationType);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxTaxonomicGroup);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxTypeStatus);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.comboBoxVernacularTerm);

            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxAnalysisNumber);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxAnalysisURI);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxCollectionAcronym);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxCollectionLocation);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxCollectionName);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxCollectionOwner);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxCollectorsEventNumber);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxColonizedSubstratePart);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxCountryCache);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxFamilyCache);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxLabelNotes);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxLocationDirection);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxOrderCache);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxOverviewEventSeriesCode);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxPartSublabel);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxPreparationMethod);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxProcessingNotes);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxProcessingProtocoll);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxRelatedSpecimenURL);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxStorageLocation);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxTypeNotes);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxUnitIdentifier);
            DiversityWorkbench.FormFunctions.setAutoCompletion(this.textBoxUnitNotes);
        }

        private void splitContainerData_SplitterMoved(object sender, SplitterEventArgs e)
        {
            DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.SplitContainerData_SplitterDistance = this.splitContainerData.SplitterDistance;
            DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();
        }

        private void FormCollectionSpecimen_FormClosing(object sender, FormClosingEventArgs e)
        {
            try
            {
                if (this._ViewMode == ViewMode.Default)
                {
                    if (System.Windows.Forms.MessageBox.Show("Do you really want to quit DiversityCollection?", "Quit DiversityCollection?", MessageBoxButtons.YesNo, MessageBoxIcon.Warning) == System.Windows.Forms.DialogResult.No)
                    {
                        e.Cancel = true;
                        return;
                    }
                }
                else if (this._ViewMode == ViewMode.SpreadsheetMode)
                {
                    this.Hide();
                    e.Cancel = true;
                    return;
                }
                else if (this._ViewMode == ViewMode.SingleInspectionMode)
                {
                    // just close form
                }
                else if (this._ViewMode == ViewMode.QueryMode)
                {
                    this.userControlQueryList.RememberQueryConditionSettings_SaveToFile(this._RememberQueryConditionSettingsFile);
                }

                if (this._ViewMode == ViewMode.Default)
                {
                    if (this.userControlQueryList.QueryConditionVisiblity.Length > 0)
                    {
                        DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.QueryConditionVisibility = this.userControlQueryList.QueryConditionVisiblity;
                    }
                    DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.SplitContainerData_SplitterDistance = this.splitContainerData.SplitterDistance;
                    string ImageVisibility = "";
                    if (this.ShowImagesMaps) ImageVisibility = "1"; else ImageVisibility = "0";
                    if (this.ShowImagesEvent) ImageVisibility += "1"; else ImageVisibility += "0";
                    if (this.ShowImagesSpecimen) ImageVisibility += "1"; else ImageVisibility += "0";
                    if (this.ShowImagesLabel) ImageVisibility += "1"; else ImageVisibility += "0";
                    DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.ImageDisplay = ImageVisibility;
                    DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();
                    DiversityWorkbench.Settings.SaveWorkbenchSettings();
                    bool CanUpdate = this.FormFunctions.getObjectPermissions("CollectionSpecimen", "UPDATE");
                    if (CanUpdate)
                        this.updateSpecimen();
                    this.userControlQueryList.CloseConnectionTempIDs();
                    if (this.userControlQueryList.RememberQuerySettings())
                        this.userControlQueryList.RememberQueryConditionSettings_SaveToFile();
                    else
                        this.userControlQueryList.RememberQueryConditionSettings_RemoveFile();
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        private string Message(string Resource)
        {
            string Message = "";
            try
            {
                System.ComponentModel.ComponentResourceManager resources = new System.ComponentModel.ComponentResourceManager(typeof(Forms.FormCollectionSpecimenText));
                Message = resources.GetString(Resource);
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            return Message;
        }

        private void FormCollectionSpecimen_Load(object sender, EventArgs e)
        {

        }

        #endregion

        #region Databindings and events

        private void setDatabindings()
        {
            try
            {
                this.setUserControlDatabindings();
                this.SetEventsForSourcesForModuleRelatedControls();
                if (this.dvUnitsDisplay == null)
                    this.dvUnitsDisplay = new System.Data.DataView(this.dataSetCollectionSpecimen.IdentificationUnit, "DisplayOrder > 0", "DisplayOrder", System.Data.DataViewRowState.CurrentRows);
                this.listBoxDisplayOrderListShow.DataSource = this.dvUnitsDisplay;
                this.listBoxDisplayOrderListShow.DisplayMember = "LastIdentificationCache";
                if (this.dvUnitsHide == null)
                    this.dvUnitsHide = new System.Data.DataView(this.dataSetCollectionSpecimen.IdentificationUnit, "DisplayOrder = 0", "LastIdentificationCache", System.Data.DataViewRowState.CurrentRows);
                this.listBoxDisplayOrderListHide.DataSource = this.dvUnitsHide;
                this.listBoxDisplayOrderListHide.DisplayMember = "LastIdentificationCache";

                this.setCollectionSource();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setCollectionSource()
        {
            try
            {
                if (DiversityCollection.LookupTable.DtCollectionWithHierarchy != null)
                {
                    int DropDownWithForCollection = 360;

                    System.Data.DataTable dtCollection = DiversityCollection.LookupTable.DtCollectionWithHierarchy.Copy(); // aufruf bei start als 2. aus setDatabase() Zeile 3696 und nochmal als 3. aus setDatabindings() Zeile 2433
                    this.comboBoxCollection.DataSource = dtCollection;
                    this.comboBoxCollection.DisplayMember = "DisplayText";
                    this.comboBoxCollection.ValueMember = "CollectionID";
                    this.comboBoxCollection.DropDownWidth = DropDownWithForCollection;

                    System.Data.DataTable dtCollectionOfSpecimen = DiversityCollection.LookupTable.DtCollectionWithHierarchy.Copy();
                    this.comboBoxCollectionSpecimenCollectionID.DataSource = dtCollectionOfSpecimen;
                    this.comboBoxCollectionSpecimenCollectionID.DisplayMember = "DisplayText";
                    this.comboBoxCollectionSpecimenCollectionID.ValueMember = "CollectionID";
                    this.comboBoxCollectionSpecimenCollectionID.DropDownWidth = DropDownWithForCollection;

                    System.Data.DataTable dtCollectionOfRelation = DiversityCollection.LookupTable.DtCollectionWithHierarchy.Copy();
                    this.comboBoxRelatedSpecimenCollectionID.DataSource = dtCollectionOfRelation;
                    this.comboBoxRelatedSpecimenCollectionID.DisplayMember = "DisplayText";
                    this.comboBoxRelatedSpecimenCollectionID.ValueMember = "CollectionID";
                    this.comboBoxRelatedSpecimenCollectionID.DropDownWidth = DropDownWithForCollection;

                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setUserControlDatabindings()
        {
            try
            {
                #region Event
                // EVENT
                // reference
                this.userControlModuleRelatedEntryEventReference.bindToData("CollectionEvent", "ReferenceTitle", "ReferenceURI", this.collectionEventBindingSource);
                // date
                this.userControlDatePanelEventDate.setDataBindings(this.collectionEventBindingSource, "CollectionDay", "CollectionMonth", "CollectionYear", "CollectionDateSupplement");
                this.userControlDatePanelEventEnd.setDataBindings(this.collectionEventBindingSource, "CollectionEndDay", "CollectionEndMonth", "CollectionEndYear", "");
                //this.userControlDatePanelEventEnd.s

                // GEOGRAPHY
                // responsible
                this.userControlModuleRelatedEntryLocalisationResponsible.bindToData("CollectionEventLocalisation", "ResponsibleName", "ResponsibleAgentURI", this.collectionEventLocalisationBindingSource);

                //// gazetteer
                //this.userControlModuleRelatedEntryGazetteer.bindToData("CollectionEventLocalisation", "Location1", "Location2", "LocalisationSystemID = 7", this.collectionEventLocalisationBindingSource);
                this.userControlModuleRelatedEntryGazetteer.bindToData("CollectionEventLocalisation", "Location1", "Location2", this.collectionEventLocalisationBindingSource);
                
                System.Collections.Generic.List<DiversityWorkbench.RemoteValueBinding> RvbGazetteer = new List<DiversityWorkbench.RemoteValueBinding>();
                
                DiversityWorkbench.RemoteValueBinding RvbCountry = new DiversityWorkbench.RemoteValueBinding();
                RvbCountry.BindingSource = this.collectionEventBindingSource;
                RvbCountry.Column = "CountryCache";
                RvbCountry.RemoteParameter = "Country";
                RvbCountry.ModeOfUpdate = DiversityWorkbench.RemoteValueBinding.UpdateMode.AskForUpdate;
                RvbGazetteer.Add(RvbCountry);

                DiversityWorkbench.RemoteValueBinding RvbLatitude = new DiversityWorkbench.RemoteValueBinding();
                RvbLatitude.BindingSource = this.collectionEventLocalisationBindingSource;
                RvbLatitude.Column = "AverageLatitudeCache";
                RvbLatitude.RemoteParameter = "Latitude";
                RvbGazetteer.Add(RvbLatitude);

                DiversityWorkbench.RemoteValueBinding RvbLongitude = new DiversityWorkbench.RemoteValueBinding();
                RvbLongitude.BindingSource = this.collectionEventLocalisationBindingSource;
                RvbLongitude.Column = "AverageLongitudeCache";
                RvbLongitude.RemoteParameter = "Longitude";
                RvbGazetteer.Add(RvbLongitude);

                DiversityWorkbench.RemoteValueBinding RvbAltitude = new DiversityWorkbench.RemoteValueBinding();
                RvbAltitude.BindingSource = this.collectionEventLocalisationBindingSource;
                RvbAltitude.Column = "AverageAltitudeCache";
                RvbAltitude.RemoteParameter = "Altitude";
                RvbGazetteer.Add(RvbAltitude);

                DiversityWorkbench.RemoteValueBinding RvbGazGeo = new DiversityWorkbench.RemoteValueBinding();
                RvbGazGeo.BindingSource = this.CollectionEventLocalisationGeoBindingSource;
                RvbGazGeo.Column = "GeographyAsString";
                RvbGazGeo.RemoteParameter = "Geography";
                RvbGazetteer.Add(RvbGazGeo);

                this.userControlModuleRelatedEntryGazetteer.setRemoteValueBindings(RvbGazetteer);


                // SAMPLING PLOT

                this.userControlModuleRelatedEntrySamplingPlot.bindToData("CollectionEventLocalisation", "Location1", "Location2", "LocalisationSystemID = 13", this.collectionEventLocalisationBindingSource);

                System.Collections.Generic.List<DiversityWorkbench.RemoteValueBinding> RvbSamplingPlot = new List<DiversityWorkbench.RemoteValueBinding>();

                DiversityWorkbench.RemoteValueBinding RvbPlotCountry = new DiversityWorkbench.RemoteValueBinding();
                RvbPlotCountry.BindingSource = this.collectionEventBindingSource;
                RvbPlotCountry.Column = "CountryCache";
                RvbPlotCountry.RemoteParameter = "Country";
                RvbSamplingPlot.Add(RvbPlotCountry);

                DiversityWorkbench.RemoteValueBinding RvbLat = new DiversityWorkbench.RemoteValueBinding();
                RvbLat.BindingSource = this.collectionEventLocalisationBindingSource;
                RvbLat.Column = "AverageLatitudeCache";
                RvbLat.RemoteParameter = "Latitude";
                RvbSamplingPlot.Add(RvbLat);

                DiversityWorkbench.RemoteValueBinding RvbLong = new DiversityWorkbench.RemoteValueBinding();
                RvbLong.BindingSource = this.collectionEventLocalisationBindingSource;
                RvbLong.Column = "AverageLongitudeCache";
                RvbLong.RemoteParameter = "Longitude";
                RvbSamplingPlot.Add(RvbLong);

                DiversityWorkbench.RemoteValueBinding RvbAlt = new DiversityWorkbench.RemoteValueBinding();
                RvbAlt.BindingSource = this.collectionEventLocalisationBindingSource;
                RvbAlt.Column = "AverageAltitudeCache";
                RvbAlt.RemoteParameter = "Altitude";
                RvbSamplingPlot.Add(RvbAlt);

                DiversityWorkbench.RemoteValueBinding RvbAcc = new DiversityWorkbench.RemoteValueBinding();
                RvbAcc.BindingSource = this.collectionEventLocalisationBindingSource;
                RvbAcc.Column = "LocationAccuracy";
                RvbAcc.RemoteParameter = "Accuracy";
                RvbSamplingPlot.Add(RvbAcc);

                DiversityWorkbench.RemoteValueBinding RvbGeo = new DiversityWorkbench.RemoteValueBinding();
                RvbGeo.BindingSource = this.CollectionEventLocalisationGeoBindingSource;
                RvbGeo.Column = "GeographyAsString";
                RvbGeo.RemoteParameter = "Geography";
                RvbSamplingPlot.Add(RvbGeo);

                this.userControlModuleRelatedEntrySamplingPlot.setRemoteValueBindings(RvbSamplingPlot);


                // EVENT PROPERTY
                this.userControlModuleRelatedEntryScientificTerm.bindToData("CollectionEventProperty", "DisplayText", "PropertyURI", this.collectionEventPropertyBindingSource);
                System.Collections.Generic.List<DiversityWorkbench.RemoteValueBinding> RvbScientificTerm = new List<DiversityWorkbench.RemoteValueBinding>();

                DiversityWorkbench.RemoteValueBinding RvbHierarchy = new DiversityWorkbench.RemoteValueBinding();
                RvbHierarchy.BindingSource = this.collectionEventPropertyBindingSource;
                RvbHierarchy.Column = "PropertyHierarchyCache";
                RvbHierarchy.RemoteParameter = "HierarchyCache";
                RvbScientificTerm.Add(RvbHierarchy);

                this.userControlModuleRelatedEntryScientificTerm.setRemoteValueBindings(RvbScientificTerm);

                // responsible
                this.userControlModuleRelatedEntryEventPropertyResponsible.bindToData("CollectionEventProperty", "ResponsibleName", "ResponsibleAgentURI", this.collectionEventPropertyBindingSource);
                #endregion

                #region Identification and analysis
                // IDENTIFICATION
                // taxonomic name
                this.userControlModuleRelatedEntryTaxonomicName.bindToData("Identification", "TaxonomicName", "NameURI", this.identificationBindingSource);
                this.userControlModuleRelatedEntryTaxonomicName.textBoxValue.TextChanged += new System.EventHandler(this.updateHierarchyNodeByUserControlModuleRelatedEntry);
                this.userControlModuleRelatedEntryTaxonomicName.LinkDeleteConnectionToModuleToTableGrant = true;

                System.Collections.Generic.List<DiversityWorkbench.RemoteValueBinding> RvbIdentification = new List<DiversityWorkbench.RemoteValueBinding>();

                DiversityWorkbench.RemoteValueBinding RvbFamily = new DiversityWorkbench.RemoteValueBinding();
                RvbFamily.BindingSource = this.identificationUnitBindingSource;
                RvbFamily.Column = "FamilyCache";
                RvbFamily.RemoteParameter = "Family";
                //RvbFamily.ModeOfUpdate = DiversityWorkbench.RemoteValueBinding.UpdateMode.AskForUpdate;
                RvbIdentification.Add(RvbFamily);

                DiversityWorkbench.RemoteValueBinding RvbOrder = new DiversityWorkbench.RemoteValueBinding();
                RvbOrder.BindingSource = this.identificationUnitBindingSource;
                RvbOrder.Column = "OrderCache";
                RvbOrder.RemoteParameter = "Order";
                //RvbOrder.ModeOfUpdate = DiversityWorkbench.RemoteValueBinding.UpdateMode.AskForUpdate;
                RvbIdentification.Add(RvbOrder);

                DiversityWorkbench.RemoteValueBinding RvbHierarchyCache = new DiversityWorkbench.RemoteValueBinding();
                RvbHierarchyCache.BindingSource = this.identificationUnitBindingSource;
                RvbHierarchyCache.Column = "HierarchyCache";
                RvbHierarchyCache.RemoteParameter = "Hierarchy";
                //RvbHierarchyCache.ModeOfUpdate = DiversityWorkbench.RemoteValueBinding.UpdateMode.AskForUpdate;
                RvbIdentification.Add(RvbHierarchyCache);

                this.userControlModuleRelatedEntryTaxonomicName.setRemoteValueBindings(RvbIdentification);
                this.userControlModuleRelatedEntryTaxonomicName.SupressEmptyRemoteValues = true;

                this.userControlModuleRelatedEntryTaxonomicName.ShowInfo = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.ShowAcceptedNames;

                // ScientificTerm
                this.userControlModuleRelatedEntryIdentificationScientificTerm.bindToData("Identification", "VernacularTerm", "TermURI", this.identificationBindingSource);

                System.Collections.Generic.List<DiversityWorkbench.RemoteValueBinding> RvbIdentificationScientificTerm = new List<DiversityWorkbench.RemoteValueBinding>();
                DiversityWorkbench.RemoteValueBinding RvbHierarchyCacheScientificTerm = new DiversityWorkbench.RemoteValueBinding();
                RvbHierarchyCacheScientificTerm.BindingSource = this.identificationUnitBindingSource;
                RvbHierarchyCacheScientificTerm.Column = "HierarchyCache";
                RvbHierarchyCacheScientificTerm.RemoteParameter = "HierarchyCache";
                RvbIdentificationScientificTerm.Add(RvbHierarchyCacheScientificTerm);
                this.userControlModuleRelatedEntryIdentificationScientificTerm.setRemoteValueBindings(RvbIdentificationScientificTerm);

                //this.userControlModuleRelatedEntryIdentificationScientificTerm.textBoxValue.TextChanged += new System.EventHandler(this.updateHierarchyNodeByUserControlModuleRelatedEntry);
                //this.userControlModuleRelatedEntryIdentificationScientificTerm.LinkDeleteConnectionToModuleToTableGrant = true;


                // responsible
                this.userControlModuleRelatedEntryIdentificationResponsible.bindToData("Identification", "ResponsibleName", "ResponsibleAgentURI", this.identificationBindingSource);
                this.userControlModuleRelatedEntryIdentificationResponsible.textBoxValue.TextChanged += new System.EventHandler(this.updateIdentificationResponsibleUserControlModuleRelatedEntry);

                // reference
                this.userControlModuleRelatedEntryIdentificationReference.bindToData("Identification", "ReferenceTitle", "ReferenceURI", this.identificationBindingSource);
                // date
                this.userControlDatePanelIdentificationDate.setDataBindings(this.identificationBindingSource, "IdentificationDay", "IdentificationMonth", "IdentificationYear", "IdentificationDateSupplement");

                // ANALYSIS
                this.userControlModuleRelatedEntryAnalysisResponsible.bindToData("IdentificationUnitAnalysis", "ResponsibleName", "ResponsibleAgentURI", this.identificationUnitAnalysisBindingSource);

                // GEOANALYSIS
                this.userControlModuleRelatedEntryGeoAnalysisResponsible.bindToData("IdentificationUnitGeoAnalysis", "ResponsibleName", "ResponsibleAgentURI", this.identificationUnitGeoAnalysisBindingSource);
                #endregion

                #region Specimen and relation
                // SPECIMEN
                // exsiccate
                this.userControlModuleRelatedEntryExsiccate.bindToData("CollectionSpecimen", "ExsiccataAbbreviation", "ExsiccataURI", this.collectionSpecimenBindingSource);
                // depositor
                this.userControlModuleRelatedEntryDepositor.bindToData("CollectionSpecimen", "DepositorsName", "DepositorsAgentURI", this.collectionSpecimenBindingSource);
                // reference
                this.userControlModuleRelatedEntrySpecimenReference.bindToData("CollectionSpecimen", "ReferenceTitle", "ReferenceURI", this.collectionSpecimenBindingSource);
                // accession date
                this.userControlDatePanelAccessionDate.setDataBindings(this.collectionSpecimenBindingSource, "AccessionDay", "AccessionMonth", "AccessionYear", "AccessionDateSupplement");

                // IMAGES
                // Creator
                this.userControlModuleRelatedEntrySpecimenImageCreator.bindToData("CollectionSpecimenImage", "CreatorAgent", "CreatorAgentURI", this.collectionSpecimenImageBindingSource);
                this.userControlModuleRelatedEntryEventImageCreator.bindToData("CollectionEventImage", "CreatorAgent", "CreatorAgentURI", this.collectionEventImageBindingSource);
                this.userControlModuleRelatedEntryEventSeriesImageCreator.bindToData("CollectionEventSeriesImage", "CreatorAgent", "CreatorAgentURI", this.collectionEventSeriesImageBindingSource);

                // LicenseHolder
                this.userControlModuleRelatedEntrySpecimenImageLicenseHolder.bindToData("CollectionSpecimenImage", "LicenseHolder", "LicenseHolderAgentURI", this.collectionSpecimenImageBindingSource);
                this.userControlModuleRelatedEntryEventImageLicenseHolder.bindToData("CollectionEventImage", "LicenseHolder", "LicenseHolderAgentURI", this.collectionEventImageBindingSource);
                this.userControlModuleRelatedEntryEventSeriesImageLicenseHolder.bindToData("CollectionEventSeriesImage", "LicenseHolder", "LicenseHolderAgentURI", this.collectionEventSeriesImageBindingSource);

                // RELATION
                // specimen
                this.userControlModuleRelatedEntryRelatedSpecimen.bindToData("CollectionSpecimenRelation", "RelatedSpecimenDisplayText", "RelatedSpecimenURI", this.collectionSpecimenRelationBindingSource);
                
                #endregion

                // PART
                this.userControlModuleRelatedEntryPreparationResponsible.bindToData("CollectionSpecimenPart", "ResponsibleName", "ResponsibleAgentURI", this.collectionSpecimenPartBindingSource);
                // PROCESSING
                this.userControlModuleRelatedEntryProcessingResponsible.bindToData("CollectionSpecimenProcessing", "ResponsibleName", "ResponsibleAgentURI", this.collectionSpecimenProcessingBindingSource);
                // Description
                this.userControlModuleRelatedEntryPartDescription.bindToData("CollectionSpecimenPartDescription", "Description", "DescriptionTermURI", this.collectionSpecimenPartDescriptionBindingSource);

                // COLLECTION
                this.userControlModuleRelatedEntryCollectionContact.bindToData("Collection", "AdministrativeContactName", "AdministrativeContactAgentURI", this.collectionBindingSource);

                // COLLECTOR
                this.userControlModuleRelatedEntryCollector.bindToData("CollectionAgent", "CollectorsName", "CollectorsAgentURI", this.collectionAgentBindingSource);
                this.userControlModuleRelatedEntryCollector.textBoxValue.TextChanged += new System.EventHandler(this.updateHierarchyNodeByUserControlModuleRelatedEntry);

                // Reference
                this.userControlModuleRelatedEntryReference.bindToData("CollectionReference", "ReferenceTitle", "ReferenceURI", this.collectionSpecimenReferenceBindingSource);
                this.userControlModuleRelatedEntryReferenceResponsible.bindToData("CollectionReference", "ResponsibleName", "ResponsibleAgentURI", this.collectionSpecimenReferenceBindingSource);

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void updateIdentificationResponsibleUserControlModuleRelatedEntry(object sender, EventArgs e)
        {
            try
            {
                System.Windows.Forms.TextBox T = (System.Windows.Forms.TextBox)sender;
                if (T.DataBindings.Count == 0) return;
                if (T.Text.Length == 0)
                {
                    System.Windows.Forms.Binding B = T.DataBindings[0];
                    if (B.DataSource == null) return;
                    System.Windows.Forms.BindingSource BS = (System.Windows.Forms.BindingSource)B.DataSource;
                    if (BS.Current == null) return;
                    System.Data.DataRowView RV = (System.Data.DataRowView)BS.Current;
                    System.Data.DataRow R = RV.Row;
                    if (!R["ResponsibleAgentURI"].Equals(System.DBNull.Value) && R["ResponsibleAgentURI"].ToString().Length == 0)
                    {
                        R.BeginEdit();
                        R["ResponsibleAgentURI"] = System.DBNull.Value;
                        R.EndEdit();
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #region Fixing the sources for module related controls
        
        private void SetEventsForSourcesForModuleRelatedControls()
        {
            System.Collections.Generic.List<DiversityWorkbench.UserControlModuleRelatedEntry> UCMRElist = new List<DiversityWorkbench.UserControlModuleRelatedEntry>();
            UCMRElist.Add(this.userControlModuleRelatedEntryAnalysisResponsible);
            UCMRElist.Add(this.userControlModuleRelatedEntryCollectionContact);
            UCMRElist.Add(this.userControlModuleRelatedEntryCollector);
            UCMRElist.Add(this.userControlModuleRelatedEntryDepositor);
            UCMRElist.Add(this.userControlModuleRelatedEntryEventReference);
            UCMRElist.Add(this.userControlModuleRelatedEntryEventImageCreator);
            UCMRElist.Add(this.userControlModuleRelatedEntryEventImageLicenseHolder);
            UCMRElist.Add(this.userControlModuleRelatedEntryEventPropertyResponsible);
            UCMRElist.Add(this.userControlModuleRelatedEntryEventSeriesImageCreator);
            UCMRElist.Add(this.userControlModuleRelatedEntryEventSeriesImageLicenseHolder);
            UCMRElist.Add(this.userControlModuleRelatedEntryExsiccate);
            UCMRElist.Add(this.userControlModuleRelatedEntryGazetteer);
            UCMRElist.Add(this.userControlModuleRelatedEntryGeoAnalysisResponsible);
            UCMRElist.Add(this.userControlModuleRelatedEntryIdentificationReference);
            UCMRElist.Add(this.userControlModuleRelatedEntryIdentificationResponsible);
            UCMRElist.Add(this.userControlModuleRelatedEntryLocalisationResponsible);
            UCMRElist.Add(this.userControlModuleRelatedEntryPreparationResponsible);
            UCMRElist.Add(this.userControlModuleRelatedEntryProcessingResponsible);
            UCMRElist.Add(this.userControlModuleRelatedEntrySamplingPlot);
            UCMRElist.Add(this.userControlModuleRelatedEntryScientificTerm);
            UCMRElist.Add(this.userControlModuleRelatedEntrySpecimenReference);
            UCMRElist.Add(this.userControlModuleRelatedEntrySpecimenImageCreator);
            UCMRElist.Add(this.userControlModuleRelatedEntrySpecimenImageLicenseHolder);
            UCMRElist.Add(this.userControlModuleRelatedEntryTaxonomicName);
            UCMRElist.Add(this.userControlModuleRelatedEntryIdentificationScientificTerm);
            UCMRElist.Add(this.userControlModuleRelatedEntryReference);
            UCMRElist.Add(this.userControlModuleRelatedEntryReferenceResponsible);
            UCMRElist.Add(this.userControlModuleRelatedEntryPartDescription);

            foreach (DiversityWorkbench.UserControlModuleRelatedEntry UCMRE in UCMRElist)
            {
                try
                {
                    UCMRE.FixingOfSourceEnabled = true;
                    UCMRE.buttonFixSource.Click += new System.EventHandler(this.FixSource_Click);
                }
                catch (System.Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void FixSource_Click(object sender, EventArgs e)
        {
            try
            {
                System.Windows.Forms.Button B = (System.Windows.Forms.Button)sender;
                System.Windows.Forms.Panel P = (System.Windows.Forms.Panel)B.Parent;
                DiversityWorkbench.UserControlModuleRelatedEntry UCMRE = (DiversityWorkbench.UserControlModuleRelatedEntry)P.Parent;
                DiversityWorkbench.UserSettings U = new DiversityWorkbench.UserSettings();
                System.Collections.Generic.List<string> Setting = new List<string>();
                Setting.Add(DiversityWorkbench.UserSettings.SettingGroups.ModuleSource.ToString());
                Setting.Add(UCMRE.TableName);
                switch (UCMRE.TableName)
                {
                    case "Identification":
                        switch (UCMRE.ValueColumn)
                        {
                            case "TermURI":
                            case "NameURI":
                                Setting.Add("TaxonomicGroup");
                                System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
                                Setting.Add(R["TaxonomicGroup"].ToString());
                                break;
                            default:
                                Setting.Add(UCMRE.ValueColumn);
                                break;
                        }
                        break;
                    case "CollectionSpecimenPartDescription":
                        switch (UCMRE.ValueColumn)
                        {
                            case "DescriptionTermURI":
                                Setting.Add("MaterialCategory");
                                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
                                Setting.Add(R["MaterialCategory"].ToString());
                                break;
                            default:
                                Setting.Add(UCMRE.ValueColumn);
                                break;
                        }
                        break;
                    case "CollectionEventLocalisation":
                        switch (UCMRE.ValueColumn)
                        {
                            case "Location2":
                                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                                Setting.Add("LocalisationSystemID_" + R["LocalisationSystemID"].ToString());
                                break;
                            default:
                                Setting.Add(UCMRE.ValueColumn);
                                break;
                        }
                        break;
                    case "CollectionEventProperty":
                        switch (UCMRE.ValueColumn)
                        {
                            case "PropertyURI":
                                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventPropertyBindingSource.Current;
                                Setting.Add("PropertyID_" + R["PropertyID"].ToString());
                                break;
                            default:
                                Setting.Add(UCMRE.ValueColumn);
                                break;
                        }
                        break;
                    default:
                        Setting.Add(UCMRE.ValueColumn);
                        break;
                }
                if (!DiversityWorkbench.WorkbenchUnit.SaveSetting(Setting, UCMRE.SourceServerConnection(), UCMRE.SourceWebSerice(), UCMRE.SourceWebserviceOptions()))
                    System.Windows.Forms.MessageBox.Show("Saving of setting failed");

                //if (UCMRE.SourceServerConnection() != null)
                //{
                //    if (UCMRE.SourceServerConnection().ProjectID != null)
                //    {
                //        U.DeleteSettingAttribute(Setting, "Webservice");
                //        U.SaveSetting(Setting, "Project", UCMRE.SourceServerConnection().Project);
                //        // repeat to ensure entry
                //        U.SaveSetting(Setting, "Project", UCMRE.SourceServerConnection().Project);
                //        U.SaveSetting(Setting, "ProjectID", UCMRE.SourceServerConnection().ProjectID.ToString());
                //        U.SaveSetting(Setting, "Database", UCMRE.SourceServerConnection().DisplayText);
                //    }
                //}
                //else if (UCMRE.SourceWebSerice() != null)
                //{
                //    U.DeleteSettingAttribute(Setting, "Project");
                //    U.DeleteSettingAttribute(Setting, "ProjectID");
                //    U.DeleteSettingAttribute(Setting, "Database");
                //    U.SaveSetting(Setting, "", "");
                //    U.SaveSetting(Setting, "Webservice", UCMRE.SourceWebSerice().ServiceName());
                //    //U.SaveSetting(Setting, UCMRE.SourceWebSerice().ServiceName(), "");
                //    if (UCMRE.SourceWebserviceOptions() != null && UCMRE.SourceWebserviceOptions().Count > 0)
                //    {
                //        foreach (DiversityWorkbench.WebserviceQueryOption O in UCMRE.SourceWebserviceOptions())
                //        {
                //            if (O.Value != null && O.Value.Length > 0)
                //                U.SaveSetting(Setting, O.Name(), O.Value);
                //        }
                //    }
                //}
                //else
                //    U.SaveSetting(Setting, "", "");
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setUserControlModuleRelatedEntrySources(string Table)
        {
            DiversityWorkbench.UserSettings U = new DiversityWorkbench.UserSettings();
            string Source = "";
            string ProjectID = "";
            string Project = "";
            switch (Table)
            {
                case "Identification":
                    string TaxonomicGroup = "";
                    System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
                    TaxonomicGroup = R["TaxonomicGroup"].ToString();
                    System.Collections.Generic.List<string> Settings = new List<string>();
                    Settings.Add("ModuleSource");
                    Settings.Add("Identification");
                    Settings.Add("TaxonomicGroup");
                    Settings.Add(TaxonomicGroup);
                    Source = U.GetSetting(Settings);
                    if (Source.Length > 0)
                    {
                        this.userControlModuleRelatedEntryTaxonomicName.FixSource(Source);
                        System.Collections.Generic.Dictionary<string, string> Options = U.GetSettingOptions(Settings, this.userControlModuleRelatedEntryTaxonomicName.SourceWebSerice());
                        foreach (System.Collections.Generic.KeyValuePair<string, string> KV in Options)
                        {
                            this.userControlModuleRelatedEntryTaxonomicName.SetSourceWebserviceOptions(KV.Key, KV.Value);
                        }
                    }
                    else
                    {
                        Source = U.GetSetting(Settings, "Database");
                        if (Source.Length == 0)
                        {
                            Source = U.GetSetting(Settings, "Webservice");
                            if (Source.Length == 0)
                                this.userControlModuleRelatedEntryTaxonomicName.ReleaseSource();
                            else
                            {
                                this.userControlModuleRelatedEntryTaxonomicName.FixSource(Source);
                                this.userControlModuleRelatedEntryIdentificationScientificTerm.FixSource(Source);
                            }
                        }
                        else
                        {
                            ProjectID = U.GetSetting(Settings, "ProjectID");
                            Project = U.GetSetting(Settings, "Project");
                            this.userControlModuleRelatedEntryTaxonomicName.FixSource(Source, ProjectID, Project);
                            this.userControlModuleRelatedEntryIdentificationScientificTerm.FixSource(Source, ProjectID, Project);
                            System.Collections.Generic.Dictionary<string, string> Options = U.GetSettingOptions(Settings, this.userControlModuleRelatedEntryTaxonomicName.SourceWebSerice());
                            foreach (System.Collections.Generic.KeyValuePair<string, string> KV in Options)
                            {
                                this.userControlModuleRelatedEntryTaxonomicName.SetSourceWebserviceOptions(KV.Key, KV.Value);
                            }
                        }
                    }
                    break;
                case "CollectionEventProperty":
                    string PropertyID = "";
                    System.Data.DataRowView RP = (System.Data.DataRowView)this.collectionEventPropertyBindingSource.Current;
                    PropertyID = "PropertyID_" + RP["PropertyID"].ToString();
                    System.Collections.Generic.List<string> SettingsProperty = new List<string>();
                    SettingsProperty.Add("ModuleSource");
                    SettingsProperty.Add("CollectionEventProperty");
                    SettingsProperty.Add(PropertyID);
                    Source = U.GetSetting(SettingsProperty);
                    if (Source.Length > 0)
                        this.userControlModuleRelatedEntryScientificTerm.FixSource(Source);
                    else
                    {
                        Source = U.GetSetting(SettingsProperty, "Database");
                        if (Source.Length == 0)
                            this.userControlModuleRelatedEntryScientificTerm.ReleaseSource();
                        else
                        {
                            ProjectID = U.GetSetting(SettingsProperty, "ProjectID");
                            Project = U.GetSetting(SettingsProperty, "Project");
                            this.userControlModuleRelatedEntryScientificTerm.FixSource(Source, ProjectID, Project);
                        }
                    }
                    break;
                case "CollectionEventLocalisation":
                    string LocalisationSystemID = "";
                    System.Data.DataRowView RL = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                    LocalisationSystemID = "LocalisationSystemID_" + RL["LocalisationSystemID"].ToString();
                    System.Collections.Generic.List<string> SettingsLocalisation = new List<string>();
                    SettingsLocalisation.Add("ModuleSource");
                    SettingsLocalisation.Add("CollectionEventLocalisation");
                    SettingsLocalisation.Add(LocalisationSystemID);
                    Source = U.GetSetting(SettingsLocalisation);
                    string ParsingMethod = DiversityCollection.LookupTable.ParsingMethodName(int.Parse(RL["LocalisationSystemID"].ToString()));
                    switch (ParsingMethod)
                    {
                        case "Gazetteer":
                            if (Source.Length > 0)
                                this.userControlModuleRelatedEntryGazetteer.FixSource(Source);
                            else
                            {
                                Source = U.GetSetting(SettingsLocalisation, "Database");
                                if (Source.Length == 0)
                                    this.userControlModuleRelatedEntryGazetteer.ReleaseSource();
                                else
                                {
                                    ProjectID = U.GetSetting(SettingsLocalisation, "ProjectID");
                                    Project = U.GetSetting(SettingsLocalisation, "Project");
                                    this.userControlModuleRelatedEntryGazetteer.FixSource(Source, ProjectID, Project);
                                }
                            }
                            break;
                        case "SamplingPlot":
                            if (Source.Length > 0)
                                this.userControlModuleRelatedEntrySamplingPlot.FixSource(Source);
                            else
                            {
                                Source = U.GetSetting(SettingsLocalisation, "Database");
                                if (Source.Length == 0)
                                    this.userControlModuleRelatedEntrySamplingPlot.ReleaseSource();
                                else
                                {
                                    ProjectID = U.GetSetting(SettingsLocalisation, "ProjectID");
                                    Project = U.GetSetting(SettingsLocalisation, "Project");
                                    this.userControlModuleRelatedEntrySamplingPlot.FixSource(Source, ProjectID, Project);
                                }
                            }
                            break;
                    }
                    break;
            }
        }

        /// <summary>
        /// setting the sources for those controls that do not depend on values within the data
        /// </summary>
        private void setUserControlModuleRelatedEntrySources()
        {
            System.Collections.Generic.List<string> Settings = new List<string>();

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("IdentificationUnitAnalysis");
            Settings.Add("ResponsibleAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryAnalysisResponsible);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("Collection");
            Settings.Add("AdministrativeContactAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryCollectionContact);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionAgent");
            Settings.Add("CollectorsAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryCollector);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionSpecimen");
            Settings.Add("DepositorsAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryDepositor);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionEventImage");
            Settings.Add("CreatorAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryEventImageCreator);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionEventImage");
            Settings.Add("LicenseHolderAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryEventImageLicenseHolder);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionEventProperty");
            Settings.Add("ResponsibleAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryEventPropertyResponsible);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionEvent");
            Settings.Add("ReferenceURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryEventReference);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionEventSeriesImage");
            Settings.Add("CreatorAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryEventSeriesImageCreator);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionEventSeriesImage");
            Settings.Add("LicenseHolderAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryEventSeriesImageLicenseHolder);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionSpecimen");
            Settings.Add("ExsiccataURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryExsiccate);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("IdentificationUnitGeoAnalysis");
            Settings.Add("ResponsibleAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryGeoAnalysisResponsible);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("Identification");
            Settings.Add("ReferenceURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryIdentificationReference);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("Identification");
            Settings.Add("ResponsibleAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryIdentificationResponsible);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionEventLocalisation");
            Settings.Add("ResponsibleAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryLocalisationResponsible);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionSpecimenPart");
            Settings.Add("ResponsibleAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryPreparationResponsible);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionSpecimenProcessing");
            Settings.Add("ResponsibleAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryProcessingResponsible);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionSpecimenReference");
            Settings.Add("ReferenceURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryReference);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionSpecimenReference");
            Settings.Add("ResponsibleAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryReferenceResponsible);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionSpecimenRelation");
            Settings.Add("RelatedSpecimenURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntryRelatedSpecimen);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionSpecimenImage");
            Settings.Add("CreatorAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntrySpecimenImageCreator);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionSpecimenImage");
            Settings.Add("LicenseHolderAgentURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntrySpecimenImageLicenseHolder);

            Settings.Clear();
            Settings.Add("ModuleSource");
            Settings.Add("CollectionSpecimen");
            Settings.Add("ReferenceURI");
            this.setUserControlModuleRelatedEntrySources(Settings, this.userControlModuleRelatedEntrySpecimenReference);
        }

        private void setUserControlModuleRelatedEntrySources(System.Collections.Generic.List<string> Settings, DiversityWorkbench.UserControlModuleRelatedEntry UC)
        {
            try
            {
                DiversityWorkbench.UserSettings U = new DiversityWorkbench.UserSettings();
                string Source = "";
                string ProjectID = "";
                string Project = "";
                Source = U.GetSetting(Settings);
                if (Source.Length > 0)
                {
                    UC.FixSource(Source);
                    System.Collections.Generic.Dictionary<string, string> Options = U.GetSettingOptions(Settings, UC.SourceWebSerice());
                    foreach (System.Collections.Generic.KeyValuePair<string, string> KV in Options)
                    {
                        UC.SetSourceWebserviceOptions(KV.Key, KV.Value);
                    }
                }
                else
                {
                    Source = U.GetSetting(Settings, "Database");
                    if (Source.Length == 0)
                        UC.ReleaseSource();
                    else
                    {
                        ProjectID = U.GetSetting(Settings, "ProjectID");
                        Project = U.GetSetting(Settings, "Project");
                        UC.FixSource(Source, ProjectID, Project);
                        UC.FixSource(Source, ProjectID, Project);
                        System.Collections.Generic.Dictionary<string, string> Options = U.GetSettingOptions(Settings, UC.SourceWebSerice());
                        foreach (System.Collections.Generic.KeyValuePair<string, string> KV in Options)
                        {
                            UC.SetSourceWebserviceOptions(KV.Key, KV.Value);
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        public System.Windows.Forms.BindingSource CollectionEventLocalisationGeoBindingSource
        {
            get 
            {
                if (this._collectionEventLocalisationGeoBindingSource == null)
                {
                    if (this.components != null)
                        this._collectionEventLocalisationGeoBindingSource = new System.Windows.Forms.BindingSource(this.components);
                    else
                        this._collectionEventLocalisationGeoBindingSource = new BindingSource(this.dataSetCollectionSpecimen, this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.TableName.ToString());
                    this.textBoxGeography.DataBindings.Clear();
                    this.textBoxGeography.ReadOnly = true;
                    ((System.ComponentModel.ISupportInitialize)(this._collectionEventLocalisationGeoBindingSource)).BeginInit();
                    this.textBoxGeography.DataBindings.Add(new System.Windows.Forms.Binding("Text", this._collectionEventLocalisationGeoBindingSource, "GeographyAsString", true));
                    this._collectionEventLocalisationGeoBindingSource.DataMember = "CollectionEventLocalisationGeo";
                    this._collectionEventLocalisationGeoBindingSource.DataSource = this.dataSetCollectionSpecimen;
                    ((System.ComponentModel.ISupportInitialize)(this._collectionEventLocalisationGeoBindingSource)).EndInit();
                }
                return _collectionEventLocalisationGeoBindingSource; 
            }
            //set { _collectionEventLocalisationGeoBindingSource = value; }
        }

        private void setUserControlHierarchySelectors()
        {
            try
            {
                if (DiversityCollection.LookupTable.DtCollectionWithHierarchy == null) return;

                System.Data.DataTable DtCollection = DiversityCollection.LookupTable.DtCollectionWithHierarchy.Copy();
                this.userControlHierarchySelectorCollectionSpecimenCollectionID.initHierarchy(
                    DtCollection,
                    "CollectionID",
                    "CollectionParentID",
                    "CollectionName",
                    "CollectionName",
                    "CollectionID",
                    true,
                    this.collectionSpecimenBindingSource, true);

                System.Data.DataTable DtCollectionForPart = DiversityCollection.LookupTable.DtCollectionWithHierarchy.Copy();
                this.userControlHierarchySelectorCollection.initHierarchy(
                    DtCollectionForPart,
                    "CollectionID",
                    "CollectionParentID",
                    "CollectionName",
                    "CollectionName",
                    "CollectionID",
                    true,
                    this.collectionSpecimenPartBindingSource, true);

                System.Data.DataTable DtCollectionForRelation = DiversityCollection.LookupTable.DtCollectionWithHierarchy.Copy();
                this.userControlHierarchySelectorRelatedSpecimenCollectionID.initHierarchy(
                    DtCollectionForRelation,
                    "CollectionID",
                    "CollectionParentID",
                    "CollectionName",
                    "CollectionName",
                    "RelatedSpecimenCollectionID",
                    this.collectionSpecimenRelationBindingSource, true);

                this.userControlHierarchySelectorIdentificationQualifier.initHierarchyForEnum("CollIdentificationQualifier_Enum", "IdentificationQualifier", this.comboBoxIdentificationQualifier, this.identificationBindingSource);
                this.userControlHierarchySelectorIdentificationCategory.initHierarchyForEnum("CollIdentificationCategory_Enum", "IdentificationCategory", this.comboBoxIdentificationCategory, this.identificationBindingSource);
                this.userControlHierarchySelectorIdentificationDateCategory.initHierarchyForEnum("CollIdentificationDateCategory_Enum", "IdentificationDateCategory", this.comboBoxIdentificationDateCategory, this.identificationBindingSource);
                this.userControlHierarchySelectorTypeStatus.initHierarchyForEnum("CollTypeStatus_Enum", "TypeStatus", this.comboBoxTypeStatus, this.identificationBindingSource);
                this.userControlHierarchySelectorCircumstances.initHierarchyForEnum("CollCircumstances_Enum", "Circumstances", this.comboBoxCircumstances, this.identificationUnitBindingSource);
                this.userControlHierarchySelectorAccessionDateCategory.initHierarchyForEnum("CollDateCategory_Enum", "AccessionDateCategory", this.comboBoxAccessionDateCategory, this.collectionSpecimenBindingSource);
                this.userControlHierarchySelectorCollectionDateCategory.initHierarchyForEnum("CollEventDateCategory_Enum", "CollectionDateCategory", this.comboBoxCollectionDateCategory, this.collectionEventBindingSource);

                this.userControlHierarchySelectorUnitDescription.initHierarchy(
                    this.dtUnitDescription,
                    "HierarchyColumn",
                    "ParentColumn",
                    "HierarchyColumn",
                    "OrderColumn",
                    "UnitDescription",
                    "ImageIndexColumn",
                    DiversityCollection.Specimen.ImageListUnitDescription,
                    this.comboBoxUnitDescription,
                    this.identificationUnitBindingSource);

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        System.Data.DataTable dtUnitDescription
        {
            get
            {
                System.Data.DataTable dtUnitDescription = new DataTable();
                System.Data.DataColumn cHierarchy = new System.Data.DataColumn("HierarchyColumn", System.Type.GetType("System.String"));
                dtUnitDescription.Columns.Add(cHierarchy);
                System.Data.DataColumn cParent = new System.Data.DataColumn("ParentColumn", System.Type.GetType("System.String"));
                dtUnitDescription.Columns.Add(cParent);
                System.Data.DataColumn cOrder = new System.Data.DataColumn("OrderColumn", System.Type.GetType("System.Int32"));
                dtUnitDescription.Columns.Add(cOrder);
                System.Data.DataColumn cValue = new System.Data.DataColumn("ValueColumn", System.Type.GetType("System.String"));
                dtUnitDescription.Columns.Add(cValue);
                System.Data.DataColumn cImageIndex = new System.Data.DataColumn("ImageIndexColumn", System.Type.GetType("System.Int32"));
                dtUnitDescription.Columns.Add(cImageIndex);

                System.Data.DataRow R0 = dtUnitDescription.NewRow();
                R0["HierarchyColumn"] = "plant";
                //R1["ParentColumn"] = "";
                R0["OrderColumn"] = 0;
                //R0["ValueColumn"] = "plant";
                //R0["ImageIndexColumn"] = 0;
                dtUnitDescription.Rows.Add(R0);

                System.Data.DataRow R1 = dtUnitDescription.NewRow();
                R1["HierarchyColumn"] = "tree";
                R1["ParentColumn"] = "plant";
                R1["OrderColumn"] = 1;
                R1["ValueColumn"] = "tree";
                R1["ImageIndexColumn"] = 0;
                dtUnitDescription.Rows.Add(R1);

                System.Data.DataRow R2 = dtUnitDescription.NewRow();
                R2["HierarchyColumn"] = "branch";
                R2["ParentColumn"] = "plant";
                R2["OrderColumn"] = 2;
                R2["ValueColumn"] = "branch";
                R2["ImageIndexColumn"] = 1;
                dtUnitDescription.Rows.Add(R2);

                System.Data.DataRow R3 = dtUnitDescription.NewRow();
                R3["HierarchyColumn"] = "leaf";
                R3["ParentColumn"] = "plant";
                R3["OrderColumn"] = 3;
                R3["ValueColumn"] = "leaf";
                R3["ImageIndexColumn"] = 2;
                dtUnitDescription.Rows.Add(R3);

                System.Data.DataRow R4 = dtUnitDescription.NewRow();
                R4["HierarchyColumn"] = "flower";
                R4["ParentColumn"] = "plant";
                R4["OrderColumn"] = 4;
                R4["ValueColumn"] = "flower";
                R4["ImageIndexColumn"] = 3;
                dtUnitDescription.Rows.Add(R4);

                System.Data.DataRow R5 = dtUnitDescription.NewRow();
                R5["HierarchyColumn"] = "gall";
                R5["ParentColumn"] = "plant";
                R5["OrderColumn"] = 5;
                R5["ValueColumn"] = "gall";
                R5["ImageIndexColumn"] = 4;
                dtUnitDescription.Rows.Add(R5);

                System.Data.DataRow R6 = dtUnitDescription.NewRow();
                R6["HierarchyColumn"] = "root";
                R6["ParentColumn"] = "plant";
                R6["OrderColumn"] = 4;
                R6["ValueColumn"] = "root";
                R6["ImageIndexColumn"] = 5;
                dtUnitDescription.Rows.Add(R6);

                return dtUnitDescription;
            }
        }
        
        #endregion

        #region Query

        private void initQuery()
        {
            try
            {
                if (this.scanModeCollectionToolStripMenuItem.Checked)
                    this.scanModeCollectionToolStripMenuItem_Click(null, null);
                this.userControlQueryList.TableColors = DiversityCollection.HierarchyNode.TableColors;
                this.userControlQueryList.TableImageIndex = DiversityCollection.HierarchyNode.TableAndGroupImageIndex;
                this.userControlQueryList.ImageList = DiversityCollection.Specimen.ImageList;
                this.initQueryOptimizing();
                if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.QueryConditionVisibility.Length > 0)
                    this.userControlQueryList.QueryConditionVisiblity = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.QueryConditionVisibility;
                this.setSearchOptions(); // kommt 2 x, 2. mal Aufruf von initQuery() Zeile 2502 und 2506
                this.userControlQueryList.AllowOptimizing(true);
                this.setQueryDisplayColumns();
                this.userControlQueryList.ResetListOfBlockedIDs();
                this.userControlQueryList.SetSqlForBlockedIDs("SELECT CollectionSpecimenID FROM CollectionSpecimenID_AvailableReadOnly");

                this.userControlQueryList.RememberQueryConditionSettings_ReadFromFile();
                if (this.userControlQueryList.RememberQuerySettings() && this.userControlQueryList.ListOfIDs.Count > 0)
                {
                    this.userControlQueryList.listBoxQueryResult.SelectedIndex = -1;
                    this.userControlQueryList.listBoxQueryResult.SelectedIndex = this.userControlQueryList.RememberedIndex();
                    this.listBoxQueryResult_SelectedIndexChanged(null, null);
                }
                //this.scanModeCollectionToolStripMenuItem.Checked = false;
                //this.textBoxCollectionScanner.Text = "";
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }

        }

        private void initQueryOptimizing()
        {
            DiversityWorkbench.UserControlQueryList.QueryMainTable = "CollectionSpecimen_Core2";
            this.userControlQueryList.QueryMainTableLocal = "CollectionSpecimen_Core2";
        }

        private void setQueryDisplayColumns()
        {
            this.userControlQueryList.QueryDisplayColumns = this.CollectionSpecimen.QueryDisplayColumns();
        }

        private void setSearchOptions()
        {
            try
            {
                if (DiversityWorkbench.Settings.ConnectionString.Length > 0)
                    this.userControlQueryList.setQueryConditions(this.CollectionSpecimen.QueryConditions(), DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.QueryConditionVisibility.ToString());

                // wird beim Start des Formulars 3 mal aufgerufen

                //1 	DiversityCollection.exe!DiversityCollection.FormCollectionSpecimen.setDatabase() Zeile 3266
                //1 	DiversityCollection.exe!DiversityCollection.FormCollectionSpecimen.FormCollectionSpecimen() Zeile 161 + 0x8 Bytes	C#

                //2  	
                /* 	DiversityCollection.exe!DiversityCollection.FormCollectionSpecimen.initQuery() Zeile 2503 + 0x8 Bytes	C#
 	                DiversityCollection.exe!DiversityCollection.FormCollectionSpecimen.FormCollectionSpecimen() Zeile 165 + 0x8 Bytes	C#
                */

                // Verbindung zur Datenbank
                // noch da
                //1 	DiversityCollection.exe!DiversityCollection.FormCollectionSpecimen.setDatabase() Zeile 3255 + 0x8 Bytes	C#
 	            //1     DiversityCollection.exe!DiversityCollection.FormCollectionSpecimen.databaseToolStripMenuItem_Click(object sender = {System.Windows.Forms.ToolStripButton}, System.EventArgs e = {System.EventArgs}) Zeile 265 + 0x8 Bytes	C#

                //2 	DiversityCollection.exe!DiversityCollection.FormCollectionSpecimen.initQuery() Zeile 2503 + 0x8 Bytes	C#
                //2 	DiversityCollection.exe!DiversityCollection.FormCollectionSpecimen.setDatabase() Zeile 3277 + 0x8 Bytes	C#
                //2 	DiversityCollection.exe!DiversityCollection.FormCollectionSpecimen.databaseToolStripMenuItem_Click(object sender = {System.Windows.Forms.ToolStripButton}, System.EventArgs e = {System.EventArgs}) Zeile 265 + 0x8 Bytes	C#


            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setQueryControlEvents()
        {
            try
            {
                // QueryList
                this.userControlQueryList.toolStripButtonConnection.Click += new System.EventHandler(this.databaseToolStripMenuItem_Click);
                this.userControlQueryList.toolStripButtonCopy.Click += new System.EventHandler(this.copySpecimen);
                this.userControlQueryList.toolStripButtonDelete.Click += new System.EventHandler(this.deleteSpecimen);
                this.userControlQueryList.toolStripButtonNew.Click += new System.EventHandler(this.createNewSpecimen);
                this.userControlQueryList.toolStripButtonSave.Click += new System.EventHandler(this.saveSpecimen);
                this.buttonSave.Click += new System.EventHandler(this.saveSpecimen);
                this.toolStripButtonSave.Click += new System.EventHandler(this.saveSpecimen);
                this.saveToolStripMenuItem.Click += new System.EventHandler(this.saveSpecimen);
                this.userControlQueryList.toolStripButtonUndo.Click += new System.EventHandler(this.undoChangesInSpecimen);
                this.userControlQueryList.toolStripButtonSwitchOrientation.Click += new System.EventHandler(this.switchQueryOrientation);
                this.userControlQueryList.listBoxQueryResult.SelectedIndexChanged += new System.EventHandler(this.listBoxQueryResult_SelectedIndexChanged);
                this.userControlQueryList.buttonQuery.Click += new System.EventHandler(this.buttonQuery_Click);
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void switchQueryOrientation(object sender, System.EventArgs e)
        {
            try
            {
                if (this.userControlQueryList.splitContainerMain.Orientation == Orientation.Vertical)
                    this.splitContainerMain.SplitterDistance = (int)this.splitContainerMain.SplitterDistance / 2;
                else
                    this.splitContainerMain.SplitterDistance = (int)this.splitContainerMain.SplitterDistance * 2;
                this.userControlQueryList.switchOrientation();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private int? _PrevoiusID = null;
        private DiversityCollection.CollectionSpecimen.AvailabilityState _PreviousAvailability = CollectionSpecimen.AvailabilityState.Unknown;

        private void listBoxQueryResult_SelectedIndexChanged(object sender, System.EventArgs e)
        {
            try
            {
                if (this.ID.ToString() != this.userControlQueryList.ID.ToString())
                {
                    this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                    this._PrevoiusID = this.ID;
                    this._PreviousAvailability = this._Availability;
                    this.SuspendLayout();
                    this.setSpecimen(this.userControlQueryList.ID);
                    if (this.userControlQueryList.RememberQuerySettings() && this.userControlQueryList.OptimizingIsUsed())
                        this.PreSelectTreeNode();
                    this.ResumeLayout();
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonQuery_Click(object sender, System.EventArgs e)
        {
            try
            {
                if (this.userControlQueryList.listBoxQueryResult.SelectedIndex == -1 && this.userControlQueryList.ListOfIDs.Count == 0)
                {
                    this.setToolbarPermissions();
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void PreSelectTreeNode()
        {
            try
            {
                System.Collections.Generic.SortedList<float, string> TableList = new SortedList<float, string>();
                foreach (System.Collections.Generic.KeyValuePair<string, string> KV in DiversityWorkbench.UserControlQueryList.TableAliases)
                {
                    switch (KV.Key)
                    {
                        case "IdentificationUnit_Core2":
                            this.PreSelectTreeNodeTableSequence(ref TableList, "IdentificationUnit_Core2", this.dataSetCollectionSpecimen.IdentificationUnit);
                            break;
                        case "Identification_Core2":
                            this.PreSelectTreeNodeTableSequence(ref TableList, "Identification_Core2", this.dataSetCollectionSpecimen.Identification);
                            break;
                        case "Identification":
                            this.PreSelectTreeNodeTableSequence(ref TableList, "Identification", this.dataSetCollectionSpecimen.Identification);
                            break;
                        case "IdentificationUnitAnalysis":
                            this.PreSelectTreeNodeTableSequence(ref TableList, "IdentificationUnitAnalysis", this.dataSetCollectionSpecimen.IdentificationUnitAnalysis);
                            break;
                        case "CollectionSpecimenPart":
                            this.PreSelectTreeNodeTableSequence(ref TableList, "CollectionSpecimenPart", this.dataSetCollectionSpecimen.CollectionSpecimenPart);
                            break;
                        case "CollectionSpecimenProcessing":
                            this.PreSelectTreeNodeTableSequence(ref TableList, "CollectionSpecimenProcessing", this.dataSetCollectionSpecimen.CollectionSpecimenProcessing);
                            break;
                        case "CollectionSpecimenRelation":
                            this.PreSelectTreeNodeTableSequence(ref TableList, "CollectionSpecimenRelation", this.dataSetCollectionSpecimen.CollectionSpecimenRelation);
                            break;
                        case "CollectionSpecimenReference":
                            this.PreSelectTreeNodeTableSequence(ref TableList, "CollectionSpecimenReference", this.dataSetCollectionSpecimen.CollectionSpecimenReference);
                            break;
                        case "CollectionProject":
                            this.PreSelectTreeNodeTableSequence(ref TableList, KV.Key, this.dataSetCollectionSpecimen.CollectionSpecimen);
                            break;
                        case "CollectionEvent":
                            this.PreSelectTreeNodeTableSequence(ref TableList, KV.Key, this.dataSetCollectionSpecimen.CollectionEvent);
                            break;
                        case "CollectionEventLocalisation":
                            this.PreSelectTreeNodeTableSequence(ref TableList, KV.Key, this.dataSetCollectionSpecimen.CollectionEventLocalisation);
                            break;
                        case "CollectionEventImage":
                            this.PreSelectTreeNodeTableSequence(ref TableList, KV.Key, this.dataSetCollectionSpecimen.CollectionEvent);
                            break;
                        case "CollectionEventProperty":
                            this.PreSelectTreeNodeTableSequence(ref TableList, KV.Key, this.dataSetCollectionSpecimen.CollectionEventProperty);
                            break;
                        case "CollectionAgent":
                        case "CollectionAgent_Core":
                            this.PreSelectTreeNodeTableSequence(ref TableList, KV.Key, this.dataSetCollectionSpecimen.CollectionAgent);
                            break;
                    }
                }
                if (TableList.Count > 0)
                {
                    string Table = TableList[TableList.Keys[0]];
                    switch (Table)
                    {
                        case "IdentificationUnit_Core2":
                            this.PreSelectTreeNode("IdentificationUnit_Core2", this.dataSetCollectionSpecimen.IdentificationUnit, this.treeViewOverviewHierarchy);
                            break;
                        case "Identification_Core2":
                        case "Identification":
                            this.PreSelectTreeNode(Table, this.dataSetCollectionSpecimen.Identification, this.treeViewOverviewHierarchy);
                            break;
                        case "IdentificationUnitAnalysis":
                            {
                                if (!this.PreSelectTreeNode("IdentificationUnitAnalysis", this.dataSetCollectionSpecimen.IdentificationUnitAnalysis, this.treeViewOverviewHierarchy))
                                    this.PreSelectTreeNode("IdentificationUnitAnalysis", this.dataSetCollectionSpecimen.IdentificationUnitAnalysis, this.treeViewOverviewHierarchyStorage);
                            }
                            break;
                        case "CollectionSpecimenPart":
                            this.PreSelectTreeNode("CollectionSpecimenPart", this.dataSetCollectionSpecimen.CollectionSpecimenPart, this.treeViewOverviewHierarchyStorage);
                            break;
                        case "CollectionSpecimenProcessing":
                            this.PreSelectTreeNode("CollectionSpecimenProcessing", this.dataSetCollectionSpecimen.CollectionSpecimenProcessing, this.treeViewOverviewHierarchyStorage);
                            break;
                        case "CollectionSpecimenRelation":
                            {
                                if (!this.PreSelectTreeNode("CollectionSpecimenRelation", this.dataSetCollectionSpecimen.CollectionSpecimenRelation, this.treeViewOverviewHierarchy))
                                    this.PreSelectTreeNode("CollectionSpecimenRelation", this.dataSetCollectionSpecimen.CollectionSpecimenRelation, this.treeViewOverviewHierarchyStorage);
                            }
                            break;
                        case "CollectionSpecimenReference":
                            {
                                if (!this.PreSelectTreeNode("CollectionSpecimenReference", this.dataSetCollectionSpecimen.CollectionSpecimenReference, this.treeViewOverviewHierarchy))
                                    this.PreSelectTreeNode("CollectionSpecimenReference", this.dataSetCollectionSpecimen.CollectionSpecimenReference, this.treeViewOverviewHierarchyStorage);
                            }
                            break;
                        case "CollectionSpecimen_Core2":
                            this.PreSelectTreeNode("CollectionSpecimen_Core2", this.dataSetCollectionSpecimen.CollectionSpecimen, this.treeViewOverviewHierarchy);
                            break;
                        case "CollectionEvent":
                            this.PreSelectTreeNode(Table, this.dataSetCollectionSpecimen.CollectionEvent, this.treeViewOverviewHierarchy);
                            break;
                        case "CollectionEventLocalisation":
                            this.PreSelectTreeNode(Table, this.dataSetCollectionSpecimen.CollectionEventLocalisation, this.treeViewOverviewHierarchy);
                            break;
                        case "CollectionEventProperty":
                            this.PreSelectTreeNode(Table, this.dataSetCollectionSpecimen.CollectionEventProperty, this.treeViewOverviewHierarchy);
                            break;
                        case "CollectionAgent":
                        case "CollectionAgent_Core":
                            this.PreSelectTreeNode(Table, this.dataSetCollectionSpecimen.CollectionAgent, this.treeViewOverviewHierarchy);
                            break;
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }
        
        private void PreSelectTreeNodeTableSequence(ref System.Collections.Generic.SortedList<float, string> TableList, string TableName, System.Data.DataTable Table)
        {
            string WhereClause = "";
            try
            {
                if (Table.Rows.Count > 1 && DiversityWorkbench.UserControlQueryList.TableAliases.ContainsKey(TableName))
                {
                    if (DiversityWorkbench.UserControlQueryList.TableQueryConditions[TableName].Count > 0)
                    {
                        foreach (DiversityWorkbench.IUserControlQueryCondition Q in DiversityWorkbench.UserControlQueryList.TableQueryConditions[TableName])
                        {
                            bool IsAddedSetControl = false;
                            bool IsSetControl = false;
                            if (DiversityWorkbench.UserControlQueryList.QueryConditionSets.ContainsKey(Q.Condition().Table) &&
                                DiversityWorkbench.UserControlQueryList.QueryConditionSets[Q.Condition().Table].ContainsKey(Q.Condition().Column))
                            {
                                DiversityWorkbench.UserControls.UserControlQueryConditionSet S = (DiversityWorkbench.UserControls.UserControlQueryConditionSet)Q;
                                if (DiversityWorkbench.UserControlQueryList.QueryConditionSets[Q.Condition().Table][Q.Condition().Column][0] != S)
                                {
                                    IsAddedSetControl = true;
                                }
                                IsSetControl = true;
                            }
                            if (IsAddedSetControl)
                                continue;

                            string Where = "";
                            if (IsSetControl)
                            {
                                Where = Q.Condition().Column + " = " + Q.WhereClause();
                                if (Where.IndexOf(".[") > -1)
                                    Where = Where.Substring(Where.IndexOf(".[") + 1);
                            }
                            else
                                Where = Q.WhereClause();
                            Where = Where.Replace(DiversityWorkbench.UserControlQueryList.TableAliases[TableName] + ".", "");
                            Where = Where.Replace("[", "").Replace("]", "");
                            if (WhereClause.Length > 0) WhereClause += " AND ";
                            WhereClause += Where;
                        }
                        WhereClause = WhereClause.Replace(" N'", " '");
                        System.Data.DataRow[] RR = Table.Select(WhereClause, "");
                        if (RR.Length > 0)
                        {
                            float Sq = (float)RR.Length / Table.Rows.Count;
                            while (TableList.ContainsKey(Sq))
                                Sq += (float)0.00001;
                            TableList.Add(Sq, TableName);
                        }
                    }
                }
                else
                {
                    if (!TableList.ContainsValue(TableName))
                    {
                        switch (TableName)
                        {
                            case "CollectionProject":
                            case "CollectionSpecimen_Core2":
                                TableList.Add(14, "CollectionSpecimen_Core2");
                                break;
                            case "CollectionEventImage":
                                TableList.Add(13, "CollectionEvent");
                                break;
                            case "CollectionEvent":
                                TableList.Add(12, TableName);
                                break;
                            case "CollectionAgent_Core":
                                TableList.Add(11, TableName);
                                break;
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private bool PreSelectTreeNode(string TableName, System.Data.DataTable Table, System.Windows.Forms.TreeView TreeView)
        {
            try
            {
                if (DiversityWorkbench.UserControlQueryList.TableAliases.ContainsKey(TableName))
                {
                    if (DiversityWorkbench.UserControlQueryList.TableQueryConditions[TableName].Count > 0)
                    {
                        string WhereClause = "";
                        foreach (DiversityWorkbench.IUserControlQueryCondition Q in DiversityWorkbench.UserControlQueryList.TableQueryConditions[TableName])
                        {
                            if (Q.Condition().IsSet && Q.Condition().SetCount > 1)
                                continue;
                            string Where = Q.WhereClause();
                            Where = Where.Replace(DiversityWorkbench.UserControlQueryList.TableAliases[TableName] + ".", "");
                            Where = Where.Replace("[", "").Replace("]", "");
                            if (WhereClause.Length > 0) WhereClause += " AND ";
                            WhereClause += Where;
                        }
                        WhereClause = WhereClause.Replace(" N'", " '");
                        System.Data.DataRow[] RR = Table.Select(WhereClause, "");
                        if (RR.Length > 0)
                        {
                            System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                            this.getOverviewHierarchyNodes(null, Table.TableName, TreeView, ref Nodes);
                            foreach (System.Windows.Forms.TreeNode N in Nodes)
                            {
                                if (N.Tag == RR[0])
                                {
                                    N.EnsureVisible();
                                    TreeView.SelectedNode = N;
                                    return true;
                                }
                            }
                        }
                    }
                }
                else if (TableName == "CollectionSpecimen_Core2")
                {
                    System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                    this.getOverviewHierarchyNodes(null, Table.TableName, TreeView, ref Nodes);
                    if (Nodes.Count > 0)
                    {
                        //Nodes[0].EnsureVisible();
                        TreeView.SelectedNode = Nodes[0];
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            return false;
        }

        #region toolStripQuery

        #region Copy

        private void copySpecimen(object sender, System.EventArgs e)
        {
            bool PartAccessionNumberIncludedInGenerationOfAccessionNumber = false;
            //Check if anything is available    
            if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing to copy");
                return;
            }

            //Creating the DataSet used as as template for the Copy form
            DiversityCollection.Datasets.DataSetCollectionSpecimen ds = (DiversityCollection.Datasets.DataSetCollectionSpecimen)this.dataSetCollectionSpecimen.Clone();
            if (this.dataSetCollectionSpecimen.CollectionEvent.Rows.Count > 0)
            {
                DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventRow RE = ds.CollectionEvent.NewCollectionEventRow();
                foreach (System.Data.DataColumn C in this.dataSetCollectionSpecimen.CollectionEvent.Columns)
                {
                    RE[C.ColumnName] = this.dataSetCollectionSpecimen.CollectionEvent.Rows[0][C.ColumnName];
                }
                ds.CollectionEvent.Rows.Add(RE);
            }
            DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenRow RS = ds.CollectionSpecimen.NewCollectionSpecimenRow();
            foreach (System.Data.DataColumn C in this.dataSetCollectionSpecimen.CollectionSpecimen.Columns)
            {
                RS[C.ColumnName] = this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0][C.ColumnName];
            }
            ds.CollectionSpecimen.Rows.Add(RS);

            DiversityCollection.FormCopyDataset f = new FormCopyDataset(ds);
            f.AllowMultiCopy = true;
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                if (f.AccessionNumbers.Count > 0)
                {
                    int OriginalID = (int)this.SpecimenID;
                    foreach (string S in f.AccessionNumbers)
                    {
                        string AccessionNumber = S;// f.AccessionNumber;
                        DiversityCollection.FormCopyDataset.EventCopyMode EventCopyMode = f.ModeForEventCopy;
                        //bool CopyIdentification = f.CopyUnits;
                        int SpecimenID = -1;
                        try
                        {
                            SpecimenID = this.CopySpecimen(OriginalID, AccessionNumber, f.ModeForEventCopy, f.IncludedTables());//, f.CopyUnits);
                            this.CopyAddProjects(SpecimenID, f.SelectedAdditionalProjectIDs());
                            if (f.RelationAddFromOriginal)
                                this.CopyAddRelations(OriginalID, SpecimenID, AccessionNumber, f.RelationTypeFromOriginal);
                            if (f.RelationAddToOriginal)
                                this.CopyAddRelations(SpecimenID, OriginalID, this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString(), f.RelationTypeToOriginal);
                            this.userControlQueryList.AddListItem(SpecimenID, AccessionNumber);
                        }
                        catch (Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        }
                    }
                }
                else
                {
                    System.Windows.Forms.MessageBox.Show("No accession numbers given. Please try again and enter an accession number");
                    return;
                }

                PartAccessionNumberIncludedInGenerationOfAccessionNumber = f.PartAccessionNumberIncludedInGenerationOfAccessionNumber();
                if (PartAccessionNumberIncludedInGenerationOfAccessionNumber)
                {
                    System.Collections.Generic.List<System.Data.DataRow> RowsWithAccNr = new List<DataRow>();
                    foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows)
                    {
                        if (!R["AccessionNumber"].Equals(System.DBNull.Value) && R["AccessionNumber"].ToString().Length > 0)
                        {
                            RowsWithAccNr.Add(R);
                        }
                    }
                    if (RowsWithAccNr.Count > 0)
                    {
                        if (System.Windows.Forms.MessageBox.Show("The parts of the copied data contained accession numbers.\r\nDo you want to search for the next free numbers of these parts?", "Update part numbers", MessageBoxButtons.YesNo) == System.Windows.Forms.DialogResult.Yes)
                        {
                            this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0].BeginEdit();
                            this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0].EndEdit();
                            this.updateSpecimen();
                            foreach (System.Data.DataRow R in RowsWithAccNr)
                            {
                                DiversityCollection.FormAccessionNumber fAN = new FormAccessionNumber(R["AccessionNumber"].ToString(), true, true, true);
                                    R["AccessionNumber"] = fAN.AccessionNumber;
                                    R.BeginEdit();
                                    R.EndEdit();
                                    this.updateSpecimen();

                                //string HeaderInfo = "The part of the copied data contained the accession number " + R["AccessionNumber"].ToString() + ".\r\nFind the next free accession number for this part";
                                //DiversityCollection.FormAccessionNumber fAN = new FormAccessionNumber(HeaderInfo, R["AccessionNumber"].ToString(), false, false);
                                //fAN.ShowDialog();
                                //if (fAN.DialogResult == System.Windows.Forms.DialogResult.OK)
                                //{
                                //    R["AccessionNumber"] = fAN.AccessionNumber;
                                //    R.BeginEdit();
                                //    R.EndEdit();
                                //}
                            }
                            this.setSpecimen(this.ID);
                        }
                    }
                }
            }
        }

        /// <summary>
        /// create a copy of a collection specimen
        /// </summary>
        /// <param name="OriginalID">The CollectionSpecimenID of the original dataset</param>
        /// <param name="AccessionNumber">The new AccessionNumber</param>
        /// <param name="EventCopyMode">The mode for the copy of the collection event</param>
        /// <param name="CopyUnits">If the identification units should be copied</param>
        /// <returns></returns>
        //private int CopySpecimen(int OriginalID, string AccessionNumber, DiversityCollection.FormCopyDataset.EventCopyMode EventCopyMode, bool CopyUnits)
        //{
        //    string SQL = "execute dbo.procCopyCollectionSpecimen NULL , " + OriginalID.ToString() + ", '" + AccessionNumber + "'";
        //    switch (EventCopyMode)
        //    {
        //        case FormCopyDataset.EventCopyMode.NewEvent:
        //            SQL += ", 1";
        //            break;
        //        case FormCopyDataset.EventCopyMode.SameEvent:
        //            SQL += ", 0";
        //            break;
        //        case FormCopyDataset.EventCopyMode.NoEvent:
        //            SQL += ", -1";
        //            break;
        //    }
        //    if (CopyUnits) SQL += ", 1";
        //    else SQL += ", 0";
        //    System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
        //    System.Data.SqlClient.SqlCommand cmd = new System.Data.SqlClient.SqlCommand(SQL, con);
        //    con.Open();
        //    int ID = 0;
        //    try
        //    {
        //        ID = System.Convert.ToInt32(cmd.ExecuteScalar().ToString());
        //        if (ID == 2) // procedure returns extra lines which interferes with expected result
        //        {
        //            try
        //            {
        //                SQL = "SELECT MAX(CollectionSpecimenID) FROM CollectionSpecimen";
        //                cmd.CommandText = SQL;
        //                int IDtest = System.Convert.ToInt32(cmd.ExecuteScalar().ToString());
        //                if (IDtest != ID)
        //                {
        //                    ID = IDtest;
        //                }
        //            }
        //            catch (System.Exception ex)
        //            { }
        //        }
        //    }
        //    catch (Exception ex)
        //    {
        //        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
        //    }
        //    con.Close();
        //    return ID;
        //}

        /// <summary>
        /// create a copy of a collection specimen
        /// </summary>
        /// <param name="OriginalID">The CollectionSpecimenID of the original dataset</param>
        /// <param name="AccessionNumber">The new AccessionNumber</param>
        /// <param name="EventCopyMode">The mode for the copy of the collection event</param>
        /// <param name="IncludedTables">A string containing the tables that should be copied separated with '|'</param>
        /// <returns></returns>
        private int CopySpecimen(int OriginalID, string AccessionNumber, DiversityCollection.FormCopyDataset.EventCopyMode EventCopyMode, string IncludedTables)
        {
            string SQL = "execute dbo.procCopyCollectionSpecimen2 NULL , " + OriginalID.ToString() + ", '" + AccessionNumber + "'";
            switch (EventCopyMode)
            {
                case FormCopyDataset.EventCopyMode.NewEvent:
                    SQL += ", 1";
                    break;
                case FormCopyDataset.EventCopyMode.SameEvent:
                    SQL += ", 0";
                    break;
                case FormCopyDataset.EventCopyMode.NoEvent:
                    SQL += ", -1";
                    break;
                default:
                    SQL += ", -1";
                    break;
            }
            SQL += ", '" + IncludedTables + "'";
            System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            System.Data.SqlClient.SqlCommand cmd = new System.Data.SqlClient.SqlCommand(SQL, con);
            con.Open();
            int ID = 0;
            try
            {
                ID = System.Convert.ToInt32(cmd.ExecuteScalar().ToString());
                if (ID == 2) // procedure returns extra lines which interferes with expected result
                {
                    try
                    {
                        SQL = "SELECT MAX(CollectionSpecimenID) FROM CollectionSpecimen";
                        cmd.CommandText = SQL;
                        int IDtest = System.Convert.ToInt32(cmd.ExecuteScalar().ToString());
                        if (IDtest != ID)
                        {
                            ID = IDtest;
                        }
                    }
                    catch (System.Exception ex)
                    { }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            con.Close();
            return ID;
        }

        private bool CopyAddProjects(int CopyID, System.Collections.Generic.List<int> List)
        {
            if (List.Count == 0)
                return true;

            string P = "";
            foreach (int i in List)
            {
                if (P.Length > 0) P += ", ";
                P += i.ToString();
            }
            string SQL = "INSERT INTO [dbo].[CollectionProject] " +
                "([CollectionSpecimenID] ,[ProjectID]) " +
                "SELECT " + CopyID.ToString() + ", [ProjectID] " +
                "FROM [dbo].[ProjectProxy] " +
                "P where p.ProjectID in (" + P + ")";
            bool OK = DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL);
            return OK;
        }

        private bool CopyAddRelations(int SpecimenID, int RelationID, string RelationDisplayText, string RelationType)
        {
            string SQL = "INSERT INTO CollectionSpecimenRelation " +
                "(CollectionSpecimenID, RelatedSpecimenURI, RelatedSpecimenDisplayText";
            if (RelationType.Length > 0) SQL += ", RelationType";
            SQL += ", IsInternalRelationCache) " +
                "VALUES (" + SpecimenID + ", dbo.BaseURL() + CAST(" + RelationID.ToString() + " AS varchar), N'" + RelationDisplayText.Replace("'", "''") + "' ";
            if (RelationType.Length > 0) SQL += ", '" + RelationType + "'";
            SQL += ", 1)";
            bool OK = DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL);
            return OK;
        }

        #endregion

        #region Delete

        private void deleteSpecimen(object sender, System.EventArgs e)
        {
            if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count > 0)
            {
                int ID = (int)this.ID;
                string SQL = "NameID = " + ID.ToString();
                string DisplayTextDel = this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString();
                try
                {
                    if (System.Windows.Forms.MessageBox.Show("Do you want to delete the specimen\r\n\r\n" + DisplayTextDel, "Delete specimen?", System.Windows.Forms.MessageBoxButtons.OKCancel, System.Windows.Forms.MessageBoxIcon.Question) == System.Windows.Forms.DialogResult.OK)
                    {
                        this.userControlQueryList.RemoveSelectedListItem();
                        this.deleteSpecimen(ID);
                        this.dataSetCollectionSpecimen.Clear();
                        this.dataSetCollectionEventSeries.Clear();
                        this.splitContainerData.Visible = false;
                    }
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
            else
            {
                if (this.userControlQueryList.listBoxQueryResult.Items.Count > 0)
                {
                    if (this.userControlQueryList.listBoxQueryResult.SelectedIndex > -1)
                        this.userControlQueryList.listBoxQueryResult.SelectedIndex = this.userControlQueryList.listBoxQueryResult.SelectedIndex;
                        //System.Windows.Forms.MessageBox.Show("Please select a taxon");
                }
            }
        }

        /// <summary>
        /// delete a name from the database
        /// </summary>
        /// <param name="NameID">the Primary key of table TaxonName corresponding to the name that should be deleted</param>
        private void deleteSpecimen(int ID)
        {
            try
            {
                string SQL = "DELETE FROM IdentificationUnitAnalysisMethodParameter WHERE CollectionSpecimenID = " + ID.ToString();
                System.Data.SqlClient.SqlConnection Conn = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                System.Data.SqlClient.SqlCommand com = new System.Data.SqlClient.SqlCommand(SQL, Conn);
                com.CommandType = System.Data.CommandType.Text;
                Conn.Open();
                com.ExecuteNonQuery();
                com.CommandText = "DELETE FROM CollectionSpecimenProcessingMethodParameter WHERE CollectionSpecimenID = " + ID.ToString();
                com.ExecuteNonQuery();
                com.CommandText = "DELETE FROM CollectionSpecimenProcessingMethod WHERE CollectionSpecimenID = " + ID.ToString();
                com.ExecuteNonQuery();
                com.CommandText = "DELETE FROM IdentificationUnitAnalysisMethod WHERE CollectionSpecimenID = " + ID.ToString();
                com.ExecuteNonQuery();
                com.CommandText = "DELETE FROM IdentificationUnitAnalysis WHERE CollectionSpecimenID = " + ID.ToString();
                com.ExecuteNonQuery();
                com.CommandText = "DELETE FROM CollectionSpecimen WHERE CollectionSpecimenID = " + ID.ToString();
                com.ExecuteNonQuery();
                Conn.Close();
            }
            catch (Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }


        #endregion

        #region New

        private void createNewSpecimen(object sender, System.EventArgs e)
        {
            try
            {
                if (!this.userControlQueryList.ProjectIsSelected)
                {
                    System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.Select_Project);// "Please select a project");
                    return;
                }
                else
                {
                    int ProjectID = this.userControlQueryList.ProjectID;
                    string SQL = "SELECT ProjectList.ReadOnly " +
                        " FROM ProjectList WHERE ProjectList.ProjectID = " + ProjectID.ToString();
                    string Result = DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL);
                }
                if (System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.Create_new_dataset, DiversityCollection.Forms.FormCollectionSpecimenText.Create_new_dataset, /*"Do you want to create a new collection specimen", "New specimen?"*/ System.Windows.Forms.MessageBoxButtons.OKCancel, System.Windows.Forms.MessageBoxIcon.Question) == System.Windows.Forms.DialogResult.OK)
                {
                    string AccessionNumber = "";
                    int ID = this.InsertNewSpecimen(ref AccessionNumber, null);
                    if (ID > -1)
                    {
                        this.setSpecimen(ID);
                        if (AccessionNumber.Length > 0)
                            this.userControlQueryList.AddListItem(ID, AccessionNumber);
                        else
                            this.userControlQueryList.AddListItem(ID, "ID: " + ID.ToString());
                        this._Availability = DiversityCollection.CollectionSpecimen.AvailabilityState.Available;
                        this.setToolbarPermissions();
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        /// <summary>
        /// Creating a specimen within an already existing collection event
        /// </summary>
        /// <param name="AccessionNumber">The accession number of the new specimen</param>
        /// <param name="CollectionEventID">The ID of the collection event in which the specimen was collected</param>
        /// <returns></returns>
        private int InsertNewSpecimen(ref string AccessionNumber, int? CollectionEventID)
        {
            try
            {
                AccessionNumber = "";
                if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count > 0)
                {
                    if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].Equals(System.DBNull.Value))
                    {
                        if (System.Windows.Forms.MessageBox.Show("Do you want the database to search for the next free accession number after " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString(), "Accession number", MessageBoxButtons.YesNo) == DialogResult.Yes)
                        {
                            bool IncludeParts = false;
                            if (System.Windows.Forms.MessageBox.Show("Do you want to include the specimen parts in the search for the next free accession number", "Include parts", MessageBoxButtons.YesNo) == DialogResult.Yes)
                                IncludeParts = true;
                            AccessionNumber = this.NextAccessionNumber(this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString(), true, IncludeParts);
                        }
                    }
                }
                int ID = -1;
                string SQL = "INSERT INTO CollectionSpecimen (Version";
                string SqlValues = "VALUES (1";
                if (AccessionNumber.Length > 0)
                {
                    SQL += ", AccessionNumber";
                    SqlValues += ", '" + AccessionNumber + "'";
                }
                if (CollectionEventID != null)
                {
                    SQL += ", CollectionEventID";
                    SqlValues += ", " + CollectionEventID.ToString();
                }
                SQL += ") " + SqlValues + ") SELECT SCOPE_IDENTITY() AS [SCOPE_IDENTITY]";
                System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                System.Data.SqlClient.SqlCommand cmd = new System.Data.SqlClient.SqlCommand(SQL, con);
                con.Open();
                ID = System.Convert.ToInt32(cmd.ExecuteScalar().ToString());
                if (this.userControlQueryList.ProjectIsSelected)
                {
                    SQL = "INSERT INTO CollectionProject (CollectionSpecimenID, ProjectID) VALUES (" + ID.ToString() + ", " + this.userControlQueryList.ProjectID.ToString() + ")";
                    cmd.CommandText = SQL;
                    cmd.ExecuteNonQuery();
                }
                con.Close();

                return ID;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                return -1;
            }
        }

        #endregion

        #region Save

        private void saveSpecimen(object sender, System.EventArgs e)
        {
            try
            {
                // create a copy of the current datarow to return to it after saving
                System.Data.DataTable dt = new DataTable();
                System.Data.DataRow Rcurrent = dt.NewRow(); //= this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0];
                System.Data.DataRow RCopy = dt.NewRow();
                // get the current tree view
                System.Windows.Forms.TreeView TV = this.treeViewOverviewHierarchy;
                if (this.sqlDataAdapterSpecimen != null)
                {

                    try
                    {
                        if (this.treeViewOverviewHierarchy.SelectedNode != null && treeViewOverviewHierarchy.SelectedNode.Tag != null)
                        {
                            Rcurrent = (System.Data.DataRow)treeViewOverviewHierarchy.SelectedNode.Tag;
                            TV = this.treeViewOverviewHierarchy;
                        }
                        else if (treeViewOverviewHierarchyStorage.SelectedNode != null && treeViewOverviewHierarchyStorage.SelectedNode.Tag != null)
                        {
                            Rcurrent = (System.Data.DataRow)treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                            TV = treeViewOverviewHierarchyStorage;
                        }
                        if (Rcurrent != null)
                        {
                            dt = Rcurrent.Table.Clone();
                            RCopy = dt.NewRow();
                            foreach (System.Data.DataColumn C in dt.Columns)
                                RCopy[C.ColumnName] = Rcurrent[C.ColumnName];
                            dt.Rows.Add(RCopy);
                        }
                    }
                    catch (System.Exception ex) { }
                }

                // move to a neutral control to ensure that the last changes are stored
                this.textBoxHeaderIdentification.Focus();

                // save the specimen
                this.updateSpecimen();
                this.setSpecimen(this.SpecimenID);
                this.userControlQueryList.RefreshItemDisplayText(this.dataSetCollectionSpecimen);

                // move to original data node
                if (TV != null && RCopy != null)
                    this.moveToHierarchyNode(RCopy, TV);
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #region Undo
        private void undoChangesInSpecimen(object sender, System.EventArgs e)
        {
            try
            {
                int i = System.Int32.Parse(this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionSpecimenID"].ToString());
                this.dataSetCollectionSpecimen.Clear();
                this.setSpecimen(i);

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #endregion

        #endregion

        #region Toolbar and Permissions

        private void setToolbarPermissions()
        {
            try
            {
                bool OK;
                if (this._Availability == DiversityCollection.CollectionSpecimen.AvailabilityState.Unknown)
                {
                    if (this.SpecimenID != -1)
                        this._Availability = DiversityCollection.CollectionSpecimen.Availability(this.SpecimenID);
                }
                if(this.SpecimenID == -1 && this.userControlQueryList.ProjectIsSelected && this.userControlQueryList.listBoxQueryResult.SelectedIndex == -1)
                    this._Availability = DiversityCollection.CollectionSpecimen.AvailabilityOfProject(this.userControlQueryList.ProjectID);

                bool AllowAccess = true;
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available)
                    AllowAccess = false;
                this.splitContainerImages.Enabled = AllowAccess;

                this.setMenuPermissions(AllowAccess);
                this.setToolstripHierarchyEditPermissions(AllowAccess);

                string TableName = "";

                #region Event etc.

                // CollectionEvent
                // Check INSERT
                TableName = "CollectionEvent";
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripButtonOverviewHierarchyNewEvent.Enabled = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.groupBoxEvent, OK);
                this.toolStripButtonOverviewHierarchyAssignEventSeries.Enabled = OK;
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                //this.toolStripButtonExpeditionDelete.Enabled = OK;

                // CollectionEventSeries
                // Check INSERT
                TableName = "CollectionEventSeries";
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripButtonOverviewHierarchyNewEventSeries.Enabled = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.groupBoxEventSeries, OK);
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                //this.toolStripButtonExpeditionDelete.Enabled = OK;

                // CollectionExpeditionImage
                // Check INSERT
                TableName = "CollectionEventImage";
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripButtonEventImageNew.Enabled = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.tableLayoutPanelEventImages, OK);
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                this.toolStripButtonEventImageDelete.Enabled = OK;

                // CollectionGeography
                // Check INSERT
                TableName = "CollectionEventLocalisation";
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripDropDownButtonOverviewHierarchyNewEventLocalisation.Enabled = OK;
                //this.toolStripButtonGeographyNew.Enabled = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.groupBoxEventLocalisation, OK);
                this.userControlGIS.Enabled = OK;
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                //this.toolStripButtonGeographyDelete.Enabled = OK;

                // CollectionHabitat
                TableName = "CollectionEventProperty";
                // Check INSERT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripDropDownButtonOverviewHierarchyNewEventProperty.Enabled = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.groupBoxEventProperty, OK);
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                //this.toolStripButtonHabitatDelete.Enabled = OK;
                
                #endregion

                #region Specimen & Image

                // CollectionSpecimen
                TableName = "CollectionSpecimen";
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.tableLayoutPanelExsiccata, OK);
                this.FormFunctions.setDataControlEnabled(this.groupBoxAccession, OK);
                this.FormFunctions.setDataControlEnabled(this.groupBoxNotes, OK);
                this.FormFunctions.setDataControlEnabled(this.groupBoxProjects, OK);
                this.FormFunctions.setDataControlEnabled(this.groupBoxDisplayOrder, OK);
                if (this.scanModeToolStripMenuItem.Checked)
                {
                    this.buttonSave.Enabled = OK;
                    this.toolStripButtonSave.Enabled = OK;
                }
                else this.buttonSave.Visible = false;
                //this.FormFunctions.setDataControlEnabled(this.groupBoxSpecimenReference, OK);
                this.comboBoxHeaderDataWithholdingReason.Enabled = OK;
                this.FormFunctions.setDataControlEnabled(this.groupBoxLabel, OK);
                this.buttonFindNextAccessionNumber.Enabled = OK;

                TableName = "CollectionSpecimen_log";
                // Check SELECT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "SELECT");
                this.buttonHeaderHistory.Enabled = OK;

                // CollectionSpecimenImage
                TableName = "CollectionSpecimenImage";
                // Check INSERT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripButtonSpecimenImageNew.Enabled = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.tableLayoutPanelSpecimenImage, OK);
                this.FormFunctions.setDataControlEnabled(this.tableLayoutPanelSpecimenImageIPR, OK);
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                this.toolStripButtonSpecimenImageDelete.Enabled = OK;

                #endregion

                #region Part etc.
                
                // CollectionSpecimenPart
                TableName = "CollectionSpecimenPart";
                // Check INSERT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                //this.toolStripButtonStorageNew.Enabled = OK;
                this.PermissionStorageInsert = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.groupBoxPart, OK);
                this.PermissionStorageUpdate = OK;
                this.FormFunctions.setDataControlEnabled(this.groupBoxDisplayOrderPart, OK);
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                //this.toolStripButtonStorageDelete.Enabled = OK;
                this.PermissionStorageDelete = OK;

                // Collection
                TableName = "ManagerCollectionList";
                // Check SELECT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "SELECT");
                this.buttonEditDefaultCollection.Enabled = OK;

                // CollectionSpecimenProcessing
                TableName = "CollectionSpecimenProcessing";
                // Check INSERT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripDropDownButtonOverviewHierarchyNewProcessing.Enabled = OK;
                this.PermissionProcessingInsert = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.groupBoxProcessing, OK);
                this.PermissionProcessingUpdate = OK;
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                //this.toolStripButtonProcessingDelete.Enabled = OK;
                this.PermissionStorageDelete = OK;

                // CollectionSpecimenPartDescription
                TableName = "CollectionSpecimenPartDescription";
                // Check INSERT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripButtonPartDescriptionAdd.Enabled = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.groupBoxPartDescription, OK);
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                this.toolStripButtonPartDescriptionDelete.Enabled = OK;
                
                #endregion

                // CollectionSpecimenReference
                TableName = "CollectionSpecimenReference";
                // Check INSERT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripButtonOverviewHierarchyNewReference.Enabled = OK;
                this.toolStripButtonOverviewHierarchyPartNewReference.Enabled = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.groupBoxReference, OK);
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");

                // CollectionSpecimenRelation
                TableName = "CollectionSpecimenRelation";
                // Check INSERT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripButtonOverviewHierarchyNewRelation.Enabled = OK;
                this.toolStripButtonOverviewHierarchyNewRelationExtern.Enabled = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.groupBoxSpecimenRelation, OK);
                this.buttonRelatedSpecimenURL.Enabled = OK;
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");

                // CollectionAgent
                TableName = "CollectionAgent";
                // Check INSERT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripButtonOverviewHierarchyNewAgent.Enabled = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.toolStripButtonOverviewHierarchyAgentDown.Enabled = OK;
                this.toolStripButtonOverviewHierarchyAgentUp.Enabled = OK;
                this.FormFunctions.setDataControlEnabled(this.groupBoxCollector, OK);
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                //this.toolStripButtonCollectorDelete.Enabled = OK;

                // CollectionProject
                TableName = "CollectionProject";
                // Check INSERT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripButtonProjectNew.Enabled = OK;
                this.toolStripButtonProjectOpen.Enabled = OK;
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                this.toolStripButtonProjectDelete.Enabled = OK;

                #region Unit etc.
                
                // IdentificationUnit
                TableName = "IdentificationUnit";
                // Check INSERT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripDropDownButtonOverviewHierarchyNewUnit.Enabled = OK;
                //this.panelCustomPresetSubstrate.Enabled = OK;
                //this.panelCustomPresetMainOrganism.Enabled = OK;
                //this.panelCustomPresetMainOrganismIdentification.Enabled = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.tableLayoutPanelIdentificationUnit, OK);
                this.FormFunctions.setDataControlEnabled(this.groupBoxUnit, OK);
                this.FormFunctions.setDataControlEnabled(this.comboBoxTaxonomicGroup, OK);
                //this.FormFunctions.setDataControlEnabled(this.tabPageSubstrate, OK);
                this.toolStripDisplayOrder.Enabled = OK;
                this.toolStripDisplay.Enabled = OK;
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                //this.toolStripButtonUnitDelete.Enabled = OK;
                //this.buttonShowSynonym.Enabled = OK;

                // IdentificationUnitAnalysis
                TableName = "IdentificationUnitAnalysis";
                // Check INSERT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripDropDownButtonOverviewHierarchyNewAnalysis.Enabled = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.tableLayoutPanelAnalysis, OK);
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                //this.toolStripButtonAnalysisDelete.Enabled = OK;
                //this.buttonShowSynonym.Enabled = OK;

                // Identification
                TableName = "Identification";
                // Check INSERT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripButtonOverviewHierarchyNewConfirmation.Enabled = OK;
                this.toolStripButtonOverviewHierarchyNewIdentAtBase.Enabled = OK;
                this.toolStripButtonOverviewHierarchyNewIdentification.Enabled = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.tableLayoutPanelIdentification, OK);
                this.toolStripButtonOverviewHierarchyIdentificationToBase.Enabled = OK;
                this.toolStripButtonOverviewHierarchyIdentificationToTop.Enabled = OK;
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                //this.toolStripButtonIdentificationDelete.Enabled = OK;

                // IdentificationUnitInPart
                TableName = "IdentificationUnitInPart";
                // Check INSERT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripDropDownButtonOverviewHierarchyNewAnalysis.Enabled = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.tableLayoutPanelDisplayOrderPart, OK);
                // Check DELETE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");
                
                #endregion

                // CollectionSpecimenTransaction
                TableName = "CollectionSpecimenTransaction";
                // Check INSERT
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "INSERT");
                this.toolStripButtonOverviewHierarchyNewTransaction.Enabled = OK;
                // Check UPDATE
                if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                    OK = false;
                else
                    OK = this.FormFunctions.getObjectPermissions(TableName, "UPDATE");
                this.FormFunctions.setDataControlEnabled(this.groupBoxTransaction, OK);
                // Check DELETE
                //if (this._Availability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available || this._ClientIsOutdated)
                //    OK = false;
                //else
                //    OK = this.FormFunctions.getObjectPermissions(TableName, "DELETE");


                //this.toolStripButtonAnalysisDelete.Enabled = OK;
                //this.buttonShowSynonym.Enabled = OK;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            // Corrections of state
            // EventSeries
            //this.textBoxOverviewEventSeriesDate.ReadOnly = true;
            // EventLocalisation
            this.textBoxCountryCache.ReadOnly = true;
            this.textBoxLongitudeCache.ReadOnly = true;
            this.textBoxLatitudeCache.ReadOnly = true;
            this.textBoxAltitudeCache.ReadOnly = true;
            // EventProperty
            this.textBoxEventPropertyHierarchyCache.ReadOnly = true;
            // Header
            this.textBoxHeaderVersion.ReadOnly = true;
            // Unit
            this.textBoxFamilyCache.ReadOnly = true;
            this.textBoxOrderCache.ReadOnly = true;
        }

        private void setMenuPermissions(bool AllowAccess)
        {
            try
            {
                this.dataToolStripMenuItem.Enabled = AllowAccess;
                this.gridToolStripMenuItem.Enabled = AllowAccess;
                this.administrationToolStripMenuItem.Enabled = AllowAccess;
                this.userControlQueryList.setToolStripsButtonsForReadOnly("CollectionSpecimen", !AllowAccess);
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setToolstripHierarchyEditPermissions(bool AllowAccess)
        {
            if (!AllowAccess)
            {
                foreach (System.Object O in this.toolStripOverviewHierarchyEdit.Items)
                {
                    if (O.GetType() == typeof(System.Windows.Forms.ToolStripButton))
                    {
                        System.Windows.Forms.ToolStripButton B = (System.Windows.Forms.ToolStripButton)O;
                        if (B.Name == "toolStripButtonpOverviewHierarchyAnnotationAdd" 
                            || B.Name == "toolStripButtonpOverviewHierarchyAnnotationEdit"
                            || B.Name == "toolStripButtonOverviewHierarchyFind")
                        {
                            B.Enabled = true;
                        }
                        else
                            B.Enabled = false;
                    }
                    else if (O.GetType() == typeof(System.Windows.Forms.ToolStripDropDownButton))
                    {
                        System.Windows.Forms.ToolStripDropDownButton B = (System.Windows.Forms.ToolStripDropDownButton)O;
                        B.Enabled = false;
                    }
                }
            }
            else
            {
                foreach (System.Object O in this.toolStripOverviewHierarchyEdit.Items)
                {
                    if (O.GetType() == typeof(System.Windows.Forms.ToolStripButton))
                    {
                        System.Windows.Forms.ToolStripButton B = (System.Windows.Forms.ToolStripButton)O;
                        B.Enabled = true;
                    }
                    else if (O.GetType() == typeof(System.Windows.Forms.ToolStripDropDownButton))
                    {
                        System.Windows.Forms.ToolStripDropDownButton B = (System.Windows.Forms.ToolStripDropDownButton)O;
                        B.Enabled = true;
                    }
                }
                //this.toolStripOverviewHierarchyEdit.Enabled = AllowAccess;
            }
            if (!AllowAccess)
            {
                foreach (System.Object O in this.toolStripOverviewHierarchyEditStorage.Items)
                {
                    if (O.GetType() == typeof(System.Windows.Forms.ToolStripButton))
                    {
                        System.Windows.Forms.ToolStripButton B = (System.Windows.Forms.ToolStripButton)O;
                        if (B.Name == "toolStripButtonOverviewHierarchyPartAnnotationAdd" || B.Name == "toolStripButtonOverviewHierarchyPartAnnotationEdit")
                        {
                            B.Enabled = true;
                        }
                        else
                            B.Enabled = false;
                    }
                    else if (O.GetType() == typeof(System.Windows.Forms.ToolStripDropDownButton))
                    {
                        System.Windows.Forms.ToolStripDropDownButton B = (System.Windows.Forms.ToolStripDropDownButton)O;
                        B.Enabled = false;
                    }
                }
            }
            else
            {
                foreach (System.Object O in this.toolStripOverviewHierarchyEditStorage.Items)
                {
                    if (O.GetType() == typeof(System.Windows.Forms.ToolStripButton))
                    {
                        System.Windows.Forms.ToolStripButton B = (System.Windows.Forms.ToolStripButton)O;
                        B.Enabled = true;
                    }
                    else if (O.GetType() == typeof(System.Windows.Forms.ToolStripDropDownButton))
                    {
                        System.Windows.Forms.ToolStripDropDownButton B = (System.Windows.Forms.ToolStripDropDownButton)O;
                        B.Enabled = true;
                    }
                }
            }
        }

        #endregion

        #region Database

        public bool LocalDatabaseNotMissing
        {
            get 
            {
                if (this._LocalDatabaseNotMissing == null)
                {
                    this._LocalDatabaseNotMissing = true;
                    if (DiversityWorkbench.Settings.ConnectionString.StartsWith("127.0.0.1"))
                    {
                        if (!this.FormFunctions.DatabaseAccessible)
                            this._LocalDatabaseNotMissing = false;
                    }
                }
                return (bool)_LocalDatabaseNotMissing; 
            }
        }

        private bool setDatabase()
        {
            bool OK = true;
            DiversityCollection.CacheDatabase.CacheDB.ResetDtProjects();
            DiversityWorkbench.PostgreSQL.Connection.ResetDefaultConnectionString();
            DiversityWorkbench.Database.DatabaseRolesReset();

            this.dataSetCollectionSpecimen.Clear();
            this.dataSetCollectionEventSeries.Clear();
            // Reset Images
            DiversityCollection.Specimen.Reset_MaterialCategory_Images();
            DiversityCollection.LookupTable.ResetMaterialCategoryList();
            DiversityCollection.LookupTable.ResetDtMaterialCategories();

            DiversityCollection.Specimen.ResetTaxonomicGroup_Images();
            DiversityCollection.LookupTable.ResetTaxonomicGroupList();
            DiversityCollection.LookupTable.ResetDtTaxonomicGroups();

            DiversityCollection.FormCollectionSpecimen._HasTransactionAccess = null;
            if (DiversityWorkbench.Settings.ConnectionString != "" && this.FormFunctions.DatabaseAccessible && LocalDatabaseNotMissing)
            {
                try
                {
                    this.resetSqlAdapters();
                    this._HasOldVersionOfImageTables = null;
                    DiversityWorkbench.WorkbenchUnit.ResetWorkbenchUnitConnections();
                    DiversityWorkbench.WorkbenchUnit.RemoveMistakenWorkbenchUnitConnections();
                    DiversityCollection.LookupTable.ResetLookupTables();
                    this.ResetSources();

                    this.setToolbarPermissions();
                    //this.setSearchOptions(); // dauert
                    this.setEnumDataSource();
                    this.setPicklists();
                    this.initRemoteModules(); // Aufruf 1
                    //this.userControlQueryList.setConnection(DiversityWorkbench.Settings.ConnectionString, "CollectionSpecimen");
                    this.userControlQueryList.setConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityWorkbench.Settings.TimeoutDatabase), "CollectionSpecimen");
                    this.buildSearchMenu();
                    if (this._ViewMode != ViewMode.SpreadsheetMode)
                        this.FormFunctions.setDescriptions();
                    this.prepareToolStripDropDownButtonsEventLocalisation();
                    this.prepareToolStripDropDownButtonsEventProperty();
                    //this.setToolStripDropDownButtonOverviewHierarchyNewUnit();
                    this.setToolStripDropDownButtonOverviewHierarchyNewUnitWithAdaptiveHierarchy();
                    this.setToolStripDropDownButtonOverviewHierarchyNewPartWithAdaptiveHierarchy();
                    this.setCollectionSource();
                    this.setUserControlHierarchySelectors();
                    this.setAutoCompletion();
                    if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection > -1)// && this.DefaultCollection != DiversityCollection.FormCollectionSpecimenSettings.Default.DefaultCollection)
                        this.DefaultCollection = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection;

                    DiversityWorkbench.WorkbenchUnit.LoadAddedRemoteConnections();

                    DiversityWorkbench.UserControls.ReplicationRow.ResetConnections();

                    DiversityCollection.CacheDatabase.CacheDB.ResetCacheDB();

                    this.setUserControlModuleRelatedEntrySources();

                    //this.initQuery(); // ruft setSearchOptions() nochmal auf
                }
                catch (Exception ex)
                {
                    OK = false;
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
            else OK = false;
            DiversityWorkbench.Entity.Reset();
            DiversityWorkbench.Entity.setEntity(this, this.toolTip);
            this.splitContainerData.Visible = false;
            this.FormFunctions.setTitle();
            this.userControlQueryList.toolStripButtonConnection.ToolTipText = "Change database. Current connection: " + this.FormFunctions.ConnectionInfo();
            this.setHeader();
            this.setMenu();
            return OK;
        }

        private void ResetSources()
        {
            this.setCollectionSource();
            this.setProcessingSource();
            this.setTaxonomicGroupSource();
            this.setMaterialCategoriesSource();
            this.setRetrievalTypeSource();
        }

        private void resetSqlAdapters()
        {
            this.sqlDataAdapterAgent = null;
            this.sqlDataAdapterAnalysis = null;
            this.sqlDataAdapterAnalysisMethod = null;
            this.sqlDataAdapterAnalysisMethodParameter = null;
            this.sqlDataAdapterEvent = null;
            this.sqlDataAdapterEventImage = null;
            this.sqlDataAdapterEventRegulation = null;
            this.sqlDataAdapterEventSeries = null;
            this.sqlDataAdapterEventSeriesImage = null;
            this.sqlDataAdapterEventSeriesEvent = null;
            this.sqlDataAdapterEventSeriesLocalisation = null;
            this.sqlDataAdapterEventSeriesSpecimen = null;
            this.sqlDataAdapterEventSeriesSuperiorList = null;
            this.sqlDataAdapterEventSeriesUnit = null;
            this.sqlDataAdapterIdentification = null;
            this.sqlDataAdapterLocalisationSystem = null;
            this.sqlDataAdapterProcessing = null;
            this.sqlDataAdapterPartDescription = null;
            //this.sqlDataAdapterPartRegulation = null;
            this.sqlDataAdapterProject = null;
            this.sqlDataAdapterReference = null;
            this.sqlDataAdapterRelation = null;
            this.sqlDataAdapterRelationInvers = null;
            this.sqlDataAdapterSpecimen = null;
            this.sqlDataAdapterSpecimenImage = null;
            this.sqlDataAdapterPart = null;
            this.sqlDataAdapterUnit = null;
        }

        private bool DatabaseCompatible
        {
            get
            {
                bool OK = false;
                try
                {
                    if (this.setSpecimen(-1))
                        OK = true;
                }
                catch { }
                return OK;
            }
        }

        private void setConnection(string[] args)
        {
            try
            {
                DiversityWorkbench.Settings.IsTrustedConnection = bool.Parse(args[1]);
                DiversityWorkbench.Settings.DatabaseServer = args[2];
                DiversityWorkbench.Settings.DatabaseName = args[3];
                if (!DiversityWorkbench.Settings.IsTrustedConnection)
                {
                    DiversityWorkbench.Settings.DatabaseUser = args[4];
                    DiversityWorkbench.Settings.Password = args[5];
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #region Picklists

        private void setEnumDataSource()
        {
            if (LocalDatabaseNotMissing)
            {
                try
                {
                    System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxAccessionDateCategory, "CollDateCategory_Enum", con, true, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxCollectionDateCategory, "CollEventDateCategory_Enum", con, true, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxEventImageType, "CollEventImageType_Enum", con, true, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxCollectionEventSeriesImageType, "CollEventImageType_Enum", con, true, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxIdentificationCategory, "CollIdentificationCategory_Enum", con, true, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxIdentificationDateCategory, "CollIdentificationDateCategory_Enum", con, true, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxIdentificationQualifier, "CollIdentificationQualifier_Enum", con, true, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxSubstrateRelationType, "CollUnitRelationType_Enum", con, true, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxTaxonomicGroup, "CollTaxonomicGroup_Enum", con, false, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxTypeStatus, "CollTypeStatus_Enum", con, true, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxSpecimenImageType, "CollSpecimenImageType_Enum", con, true, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxMaterialCategory, "CollMaterialCategory_Enum", con, false, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxLabelTranscriptionState, "CollLabelTranscriptionState_Enum", con, true, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxRevisionState, "CollLabelTranscriptionState_Enum", con, true, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxLabelType, "CollLabelType_Enum", con, true, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxRelatedSpecimenRelationType, "CollSpecimenRelationType_Enum", con, true, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxCircumstances, "CollCircumstances_Enum", con, true, true, true);
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxUnitRetrievalType, "CollRetrievalType_Enum", con, true, true, true);
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void setPicklists()
        {
            if (DiversityWorkbench.Settings.ConnectionString.Length > 0 && LocalDatabaseNotMissing)
            {
                try
                {
                    this.comboBoxProcessingID.DataSource = this.DtProcessing;
                    this.comboBoxProcessingID.DisplayMember = "DisplayText";
                    this.comboBoxProcessingID.ValueMember = "ProcessingID";

                    this.setCollectionSource();

                    this._dtProjects = null;

                    DiversityCollection.LookupTable.ResetExternalDatasource();
                    this.comboBoxExternalSource.DataSource = DiversityCollection.LookupTable.DtExternalDatasource;
                    this.comboBoxExternalSource.DisplayMember = "ExternalDatasourceName";
                    this.comboBoxExternalSource.ValueMember = "ExternalDatasourceID";

                    if (this.comboBoxLabelConversion.Items.Count == 0)
                    {
                        foreach (System.Collections.Generic.KeyValuePair<DiversityCollection.Transaction.ConversionType, string> KV in DiversityCollection.Transaction.ConversionDictionary)
                            this.comboBoxLabelConversion.Items.Add(KV.Key.ToString().Replace("_", " "));
                    }

                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        #endregion

        #region Modules

        private void initRemoteModules()
        {
            try
            {
                // Agents
                DiversityWorkbench.Agent A = new DiversityWorkbench.Agent(DiversityWorkbench.Settings.ServerConnection);
                this.userControlModuleRelatedEntryCollector.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntryDepositor.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntryEventPropertyResponsible.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntryIdentificationResponsible.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntryLocalisationResponsible.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntryAnalysisResponsible.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntryPreparationResponsible.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntryProcessingResponsible.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntryCollectionContact.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntryGeoAnalysisResponsible.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntrySpecimenImageCreator.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntryEventImageCreator.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntryEventSeriesImageCreator.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntrySpecimenImageLicenseHolder.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntryEventSeriesImageLicenseHolder.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntryEventImageLicenseHolder.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
                this.userControlModuleRelatedEntryReferenceResponsible.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;

                // Collection
                DiversityWorkbench.CollectionSpecimen C = new DiversityWorkbench.CollectionSpecimen(DiversityWorkbench.Settings.ServerConnection);
                this.userControlModuleRelatedEntryRelatedSpecimen.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)C;
                this.userControlModuleRelatedEntryRelatedSpecimen.CanDeleteConnectionToModule = false;

                // Exsiccatae
                DiversityWorkbench.Exsiccate E = new DiversityWorkbench.Exsiccate(DiversityWorkbench.Settings.ServerConnection);
                this.userControlModuleRelatedEntryExsiccate.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)E;
               
                // Gazetteer
                DiversityWorkbench.Gazetteer G = new DiversityWorkbench.Gazetteer(DiversityWorkbench.Settings.ServerConnection);
                //if (G.DatabaseIsAvailable())
                this.userControlModuleRelatedEntryGazetteer.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)G;

                // SamplingPlot
                DiversityWorkbench.SamplingPlot P = new DiversityWorkbench.SamplingPlot(DiversityWorkbench.Settings.ServerConnection);
                this.userControlModuleRelatedEntrySamplingPlot.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)P;

                // ScientificTerm
                DiversityWorkbench.ScientificTerm S = new DiversityWorkbench.ScientificTerm(DiversityWorkbench.Settings.ServerConnection);
                this.userControlModuleRelatedEntryScientificTerm.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)S;
                this.userControlModuleRelatedEntryScientificTerm.IsListInDatabase = true;
                this.userControlModuleRelatedEntryPartDescription.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)S;
                //this.userControlModuleRelatedEntryPartDescription.IsListInDatabase = true;
                this.userControlModuleRelatedEntryIdentificationScientificTerm.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)S;

                // References
                DiversityWorkbench.Reference L = new DiversityWorkbench.Reference(DiversityWorkbench.Settings.ServerConnection);
                this.userControlModuleRelatedEntryIdentificationReference.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)L;
                this.userControlModuleRelatedEntryEventReference.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)L;
                this.userControlModuleRelatedEntrySpecimenReference.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)L;
                this.userControlModuleRelatedEntryReference.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)L;

                // TaxonNames
                DiversityWorkbench.TaxonName T = new DiversityWorkbench.TaxonName(DiversityWorkbench.Settings.ServerConnection);
                this.userControlModuleRelatedEntryTaxonomicName.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)T;

                this.setHelpProviders();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setHelpProviders()
        {
            try
            {
                // Agents
                this.userControlModuleRelatedEntryCollector.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryDepositor.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryEventPropertyResponsible.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryIdentificationResponsible.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryLocalisationResponsible.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryAnalysisResponsible.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryPreparationResponsible.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryProcessingResponsible.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryCollectionContact.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryGeoAnalysisResponsible.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntrySpecimenImageCreator.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryEventImageCreator.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryEventSeriesImageCreator.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntrySpecimenImageLicenseHolder.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryEventSeriesImageLicenseHolder.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryEventImageLicenseHolder.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryReferenceResponsible.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;

                // Collection
                this.userControlModuleRelatedEntryRelatedSpecimen.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;

                // Exsiccatae
                this.userControlModuleRelatedEntryExsiccate.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;

                // Gazetteer
                this.userControlModuleRelatedEntryGazetteer.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;

                // SamlingPlot
                this.userControlModuleRelatedEntrySamplingPlot.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;

                // ScientificTerm
                this.userControlModuleRelatedEntryScientificTerm.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryPartDescription.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryIdentificationScientificTerm.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;

                // References
                this.userControlModuleRelatedEntryIdentificationReference.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryEventReference.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntrySpecimenReference.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.userControlModuleRelatedEntryReference.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;

                // TaxonNames
                this.userControlModuleRelatedEntryTaxonomicName.HelpProvider.HelpNamespace = this.helpProviderDiversityCollection.HelpNamespace;
                this.setModuleInfoTextOption();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setLocalListForScientificTerm()
        {
            try
            {
                System.Data.DataRow DataRow = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                int PropertyID = int.Parse(DataRow["PropertyID"].ToString());
                string ListInDatabase = DiversityCollection.LookupTable.PropertyName(PropertyID);
                this.userControlModuleRelatedEntryScientificTerm.ListInDatabase = ListInDatabase;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #region InfoText in userControlModuleRelatedEntryTaxonomicName
        
        private void setModuleInfoTextOption()
        {
            this.userControlModuleRelatedEntryTaxonomicName.ShowInfo = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.ShowAcceptedNames;
            //this.userControlModuleRelatedEntryTaxonomicName.Dock = DockStyle.Fill;
            if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.ShowAcceptedNames &&
                !_InfoTextAcceptedNameEventHandlerSet)
            {
                this.userControlModuleRelatedEntryTaxonomicName.labelURI.TextChanged += new System.EventHandler(this.setInfoTextAcceptedName);
            }
        }

        private void setInfoTextAcceptedName(object sender, EventArgs e)
        {
            try
            {
                System.Windows.Forms.Label L = (System.Windows.Forms.Label)sender;
                string URI = L.Text;
                string UrlAcceptedName = "";
                string AcceptedName = this.GetAcceptedName(URI, ref UrlAcceptedName);
                this.userControlModuleRelatedEntryTaxonomicName.SetInfoText(DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.ShowAcceptedNames, AcceptedName, UrlAcceptedName, System.Drawing.Color.Green);
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private string GetAcceptedName(string URI, ref string UrlAcceptedName)
        {
            string AcceptedName = "";
            if (URI.Length > 0)
                AcceptedName = DiversityWorkbench.TaxonName.AcceptedName(URI, ref UrlAcceptedName);
            return AcceptedName;
        }

        private bool _InfoTextAcceptedNameEventHandlerSet = false;

        #endregion

        #endregion

        #region Specimen

        private bool setSpecimen(int SpecimenID)
        {
            bool OK = true;
            try
            {
                if (this.userControlQueryList.ListOfIDs.Count > 0)
                {
                    DiversityCollection.CollectionSpecimen.AvailabilityState A = DiversityCollection.CollectionSpecimen.Availability(SpecimenID);
                    if (this.userControlQueryList.ListOfIDs.Count > 0
                        && this._Availability != A)
                    {
                        this._Availability = A;
                        this.setToolbarPermissions();
                    }
                    if ((this._Availability == DiversityCollection.CollectionSpecimen.AvailabilityState.NotAvailable
                        || this._Availability == DiversityCollection.CollectionSpecimen.AvailabilityState.Unknown)
                        && this.userControlQueryList.ID != 0
                        && this.userControlQueryList.ListOfIDs.Count > 0)
                    {
                        System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.You_have_no_access_to_this_dataset);//"You have no access to this dataset");
                        return false;
                    }
                    if (this.userControlQueryList.ListOfIDs.Count == 0 &&
                        this._Availability == DiversityCollection.CollectionSpecimen.AvailabilityState.Unknown &&
                        this.menuStripMain.Visible == false &&
                        SpecimenID > 0)
                    {
                        this._Availability = A;
                        this.setToolbarPermissions();
                    }
                }
                else
                {
                    DiversityCollection.CollectionSpecimen.AvailabilityState A = DiversityCollection.CollectionSpecimen.Availability(SpecimenID);
                    if (this.userControlQueryList.ID > 0
                        && this._Availability != A)
                    {
                        this._Availability = A;
                    }
                    else
                    {
                        if (this.userControlQueryList.ListOfIDs.Count == 0 && this.userControlQueryList.ProjectIsSelected)
                        {
                            this._Availability = DiversityCollection.CollectionSpecimen.AvailabilityOfProject(this.userControlQueryList.ProjectID);
                        }
                        else
                        {
                            this._Availability = DiversityCollection.CollectionSpecimen.AvailabilityState.NotAvailable;
                        }
                    }
                    this.setToolbarPermissions();
                }
            }
            catch (Exception ex)
            {
                OK = false;
                this._Availability = DiversityCollection.CollectionSpecimen.AvailabilityState.NotAvailable;
                this.setToolbarPermissions();
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }

            if (DiversityWorkbench.Settings.ConnectionString.Length == 0) return false;
            try
            {
                if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count > 0)
                {
                    this.updateSpecimen();
                }
                this.userControlImageSpecimenImage.ImagePath = "";
                this.userControlImageEventImage.ImagePath = "";
                this.userControlImageCollectionEventSeries.ImagePath = "";
                this.webBrowserEventMap.Url = new Uri("about:blank ");
                this.webBrowserLabel.Url = new Uri("about:blank ");
                this.userControlGoogleMaps.ClearMap();
                this.fillSpecimen(SpecimenID);
                if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count > 0)
                {
                    this.tableLayoutPanelBackground.Visible = false;
                    this.tableLayoutPanelBackground.Dock = DockStyle.Right;
                    this.setHeader();
                    this.splitContainerData.Visible = true;
                    this.tableLayoutPanelHeader.Visible = true;
                    this.initGisMap();
                    this.setUnitDatawithholding();
                    this.CheckDuplicateAccessionNumber();
                }
                else
                {
                    this.tableLayoutPanelBackground.Dock = DockStyle.Fill;
                    this.tableLayoutPanelBackground.Visible = true;
                    this.splitContainerData.Visible = false;
                    if (!this.scanModeToolStripMenuItem.Checked)
                        this.tableLayoutPanelHeader.Visible = false;
                    if (SpecimenID != 0 && SpecimenID != -1)
                        System.Windows.Forms.MessageBox.Show("You have no access to this dataset");
                }
                this.setLogData();
                if ((this._Availability == DiversityCollection.CollectionSpecimen.AvailabilityState.ReadOnly ||
                    this._Availability == DiversityCollection.CollectionSpecimen.AvailabilityState.NotAvailable))
                {
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            return OK;
        }

        private void setLogData()
        {
            string SQL = "SELECT CASE WHEN s.LogCreatedWhen IS NULL THEN '' ELSE CONVERT(nvarchar(10), s.LogCreatedWhen, 126) END + CASE WHEN UI.CombinedNameCache IS NULL  " +
                "THEN CASE WHEN s.LogCreatedBy IS NULL THEN '' ELSE ' by ' + s.LogCreatedBy END ELSE ' by ' + UI.CombinedNameCache END AS Creation, " +
                "CASE WHEN s.LogUpdatedWhen IS NULL THEN '' ELSE CONVERT(nvarchar(10), s.LogUpdatedWhen, 126) END + CASE WHEN UU.CombinedNameCache IS NULL  " +
                "THEN CASE WHEN s.LogUpdatedBy IS NULL THEN '' ELSE ' by ' + s.LogUpdatedBy END ELSE ' by ' + UU.CombinedNameCache END AS LastChanges " +
                "FROM UserProxy AS UI RIGHT OUTER JOIN " +
                "CollectionSpecimen AS s ON UI.LoginName = s.LogCreatedBy LEFT OUTER JOIN " +
                "UserProxy AS UU ON s.LogUpdatedBy = UU.LoginName " +
                "WHERE s.CollectionSpecimenID = " + this.ID.ToString();
            try
            {
                System.Data.DataTable dt = new DataTable();
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                if (dt.Rows.Count > 0)
                {
                    this.textBoxLogCreation.Text = dt.Rows[0][0].ToString();
                    this.textBoxLogChanges.Text = dt.Rows[0][1].ToString();
                }
                else
                {
                    this.textBoxLogCreation.Text = "";
                    this.textBoxLogChanges.Text = "";
                }
            }
            catch 
            {
                this.textBoxLogCreation.Text = "";
                this.textBoxLogChanges.Text = "";
            }
        }

        private bool setSpecimen(string AccessionNumber)
        {
            bool OK = false;
            string SQL = "SELECT CollectionSpecimenID_UserAvailable.CollectionSpecimenID " +
                "FROM CollectionSpecimen INNER JOIN " +
                "CollectionSpecimenID_UserAvailable ON  " +
                "CollectionSpecimen.CollectionSpecimenID = CollectionSpecimenID_UserAvailable.CollectionSpecimenID " +
                "WHERE (CollectionSpecimen.AccessionNumber = N'" + AccessionNumber + "')";
            System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            System.Data.SqlClient.SqlCommand c = new System.Data.SqlClient.SqlCommand(SQL, con);
            try
            {
                con.Open();
                int ID;
                OK = int.TryParse(c.ExecuteScalar().ToString(), out ID);
                if (!OK)
                {
                    System.Windows.Forms.MessageBox.Show("The " + AccessionNumber + " could not be found in the database");
                    return OK;
                }
                con.Close();
                OK = this.setSpecimen(ID);
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            return OK;
        }

        public void setHeader()
        {
            try
            {
                if (this.userControlGIS.SelectedGISObject == DiversityCollection.UserControls.UserControlGIS.SelectedGisObject.Distribution)
                {
                    this.labelHeaderAccessionNumber.Visible = false;
                    this.textBoxHeaderAccessionNumber.Visible = false;
                    this.textBoxHeaderIdentification.Text = "Distribution map";
                    this.textBoxHeaderIdentification.BackColor = System.Drawing.SystemColors.Control;
                }
                else if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count > 0)
                {
                    if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].Equals(System.DBNull.Value))
                    {
                        this.textBoxHeaderAccessionNumber.Visible = true;
                        this.textBoxHeaderAccessionNumber.Text = this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString();
                        this.labelHeaderAccessionNumber.Visible = true;
                    }
                    else
                    {
                        this.textBoxHeaderAccessionNumber.Visible = false;
                        this.textBoxHeaderAccessionNumber.Text = "";
                        this.labelHeaderAccessionNumber.Visible = false;
                    }
                    if (this.dataSetCollectionSpecimen.IdentificationUnit.Rows.Count > 0)
                    {
                        System.Data.DataRow[] rrType = this.dataSetCollectionSpecimen.Identification.Select("TypeStatus <> '' AND TypeStatus NOT LIKE 'not %'", "IdentificationSequence DESC");
                        if (rrType.Length > 0)
                        {
                            this.textBoxHeaderIdentification.BackColor = System.Drawing.Color.Red;
                            System.Data.DataRow rType = rrType[0];
                            if (!rType["TaxonomicName"].Equals(System.DBNull.Value))
                                this.textBoxHeaderIdentification.Text = rType["TaxonomicName"].ToString() + "\r\n" + rType["TypeStatus"].ToString();
                            else
                                this.textBoxHeaderIdentification.Text = rType["TypeStatus"].ToString();
                        }
                        else
                        {
                            this.textBoxHeaderIdentification.BackColor = System.Drawing.SystemColors.Control;
                            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnit.Select("DisplayOrder > 0 AND (OnlyObserved <> 1 OR OnlyObserved IS NULL)", "DisplayOrder");
                            if (rr.Length > 0)
                            {
                                System.Data.DataRow r = rr[0];
                                if (!r["LastIdentificationCache"].Equals(System.DBNull.Value))
                                    this.textBoxHeaderIdentification.Text = r["LastIdentificationCache"].ToString();
                                else
                                    this.textBoxHeaderIdentification.Text = "";
                            }
                            else
                            {
                                if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].Equals(System.DBNull.Value))
                                {
                                    this.textBoxHeaderIdentification.Text = this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString();
                                }
                                else if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].Equals(System.DBNull.Value)
                                    && this.dataSetCollectionSpecimen.CollectionEvent.Rows.Count > 0)
                                {
                                    string Header = "";
                                    if (!this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["LocalityDescription"].Equals(System.DBNull.Value))
                                        Header += this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["LocalityDescription"].ToString();
                                    //if (Header.Length > 50) Header = Header.Substring(0, 50) + "...";
                                    if (!this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionDate"].Equals(System.DBNull.Value))
                                        Header = System.DateTime.Parse(this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionDate"].ToString()).ToShortDateString() + "\r\n" + Header;
                                    this.textBoxHeaderIdentification.Text = Header;
                                }
                            }
                        }
                    }
                    else
                    {
                        this.textBoxHeaderIdentification.Text = "";
                        this.textBoxHeaderIdentification.BackColor = System.Drawing.SystemColors.Control;
                    }
                }
                //else if (this._ViewMode == ViewMode.CollectionScanMode)
                //{
                //    this.textBoxHeaderAccessionNumber.Visible = true;
                //    this.labelHeaderAccessionNumber.Visible = true;
                //}
                else
                {
                    this.textBoxHeaderID.Text = "";
                    this.textBoxHeaderAccessionNumber.Text = "";
                    this.textBoxHeaderIdentification.Text = "";
                    this.textBoxHeaderIdentification.BackColor = System.Drawing.SystemColors.Control;
                    this.textBoxHeaderVersion.Text = "";
                }
                string SQL = "SELECT dbo.BaseURL()";
                this.labelURI.Text = DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL) + this.ID.ToString();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void fillSpecimen(int SpecimenID)
        {
            try
            {
                this.dataSetCollectionSpecimen.Clear();
                this.dataSetCollectionEventSeries.Clear();
                string WhereClause = " WHERE CollectionSpecimenID = " + SpecimenID.ToString();

                if (this.userControlQueryList.ListOfIDs.Count > 0 && this._Availability != DiversityCollection.CollectionSpecimen.Availability(SpecimenID))
                {
                    this._Availability = DiversityCollection.CollectionSpecimen.Availability(SpecimenID);
                    this.setToolbarPermissions();
                }

                if (this._Availability == DiversityCollection.CollectionSpecimen.AvailabilityState.Available)
                    WhereClause += " AND CollectionSpecimenID IN (SELECT CollectionSpecimenID FROM CollectionSpecimenID_Available)" ;
                else if (this._Availability == DiversityCollection.CollectionSpecimen.AvailabilityState.ReadOnly)
                    WhereClause += " AND CollectionSpecimenID IN (SELECT CollectionSpecimenID FROM CollectionSpecimenID_AvailableReadOnly)";

                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterSpecimen, DiversityCollection.CollectionSpecimen.SqlSpecimen + WhereClause, this.dataSetCollectionSpecimen.CollectionSpecimen, ConflictOption.OverwriteChanges);
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterAgent, DiversityCollection.CollectionSpecimen.SqlAgent + WhereClause + " ORDER BY CollectorsSequence", this.dataSetCollectionSpecimen.CollectionAgent);
                if (this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count > 0 && this._Availability == DiversityCollection.CollectionSpecimen.AvailabilityState.Available)
                    this.buttonCollectorIsResponsible.Enabled = true;
                else this.buttonCollectorIsResponsible.Enabled = false;
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterProject, DiversityCollection.CollectionSpecimen.SqlProject + WhereClause + " ORDER BY ProjectID", this.dataSetCollectionSpecimen.CollectionProject);

                if (this.HasOldVersionOfImageTables)
                    this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterSpecimenImage, DiversityCollection.CollectionSpecimen.SqlSpecimenImageOldVersion + WhereClause + " ORDER BY LogCreatedWhen DESC", this.dataSetCollectionSpecimen.CollectionSpecimenImage);
                else
                {
                    this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterSpecimenImage, DiversityCollection.CollectionSpecimen.SqlSpecimenImage + WhereClause + " ORDER BY DisplayOrder ASC, URI ASC", this.dataSetCollectionSpecimen.CollectionSpecimenImage);
                    this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterSpecimenImageProperty, DiversityCollection.CollectionSpecimen.SqlSpecimenImageProperty + WhereClause, this.dataSetCollectionSpecimen.CollectionSpecimenImageProperty);
                }

                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterReference, DiversityCollection.CollectionSpecimen.SqlReference + WhereClause + " ORDER BY ReferenceTitle", this.dataSetCollectionSpecimen.CollectionSpecimenReference);

                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterRelation, DiversityCollection.CollectionSpecimen.SqlRelation + WhereClause + " ORDER BY RelatedSpecimenDisplayText", this.dataSetCollectionSpecimen.CollectionSpecimenRelation);
                string SQL = "SELECT R.CollectionSpecimenID, R.RelatedSpecimenURI, S.AccessionNumber AS RelatedSpecimenDisplayText, R.RelationType, R.RelatedSpecimenCollectionID, " +
                    "R.RelatedSpecimenDescription, R.Notes, R.IsInternalRelationCache  " +
                    "FROM CollectionSpecimenRelation R, CollectionSpecimen S  " +
                    "WHERE (R.IsInternalRelationCache = 1)  " +
                    "AND rtrim(substring(R.RelatedSpecimenURI, len(dbo.BaseURL()) + 1, 255)) = '" + SpecimenID.ToString() + "'  " +
                    "AND S.CollectionSpecimenID = R.CollectionSpecimenID " +
                    "ORDER BY RelatedSpecimenDisplayText ";
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterRelationInvers, SQL, this.dataSetCollectionSpecimen.CollectionSpecimenRelationInvers);
                
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterPart, DiversityCollection.CollectionSpecimen.SqlPart + WhereClause + " ORDER BY AccessionNumber, PartSublabel, StorageLocation", this.dataSetCollectionSpecimen.CollectionSpecimenPart);

                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterProcessing, DiversityCollection.CollectionSpecimen.SqlProcessing + WhereClause + " ORDER BY ProcessingDate, ProcessingID", this.dataSetCollectionSpecimen.CollectionSpecimenProcessing);
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterProcessingMethod, DiversityCollection.CollectionSpecimen.SqlProcessingMethod + WhereClause, this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethod);
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterProcessingMethodParameter, DiversityCollection.CollectionSpecimen.SqlProcessingMethodParameter + WhereClause, this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameter);

                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterPartDescription, DiversityCollection.CollectionSpecimen.SqlPartDescription + WhereClause + " ORDER BY [Description]", this.dataSetCollectionSpecimen.CollectionSpecimenPartDescription);

                //this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterPartRegulation, DiversityCollection.CollectionSpecimen.SqlPartRegulation + WhereClause, this.dataSetCollectionSpecimen.CollectionSpecimenPartRegulation);

                try
                {
                    SQL = DiversityCollection.CollectionSpecimen.SqlProcessingMethodList + " WHERE T.CollectionSpecimenID = " + this.ID.ToString() + " AND T.CollectionSpecimenID IN (SELECT CollectionSpecimenID FROM CollectionSpecimenID_UserAvailable)";
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodList);
                }
                catch (System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
                try
                {
                    SQL = DiversityCollection.CollectionSpecimen.SqlProcessingMethodParameterList + " WHERE T.CollectionSpecimenID = " + this.ID.ToString() + " AND T.CollectionSpecimenID IN (SELECT CollectionSpecimenID FROM CollectionSpecimenID_UserAvailable)";
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameterList);
                }
                catch (System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }

                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterTransaction, DiversityCollection.CollectionSpecimen.SqlTransaction + WhereClause, this.dataSetCollectionSpecimen.CollectionSpecimenTransaction);

                string OrderClause = " ORDER BY DisplayOrder";
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterUnit, DiversityCollection.CollectionSpecimen.SqlUnit + WhereClause + OrderClause, this.dataSetCollectionSpecimen.IdentificationUnit);
                this.setUnitDatawithholding();

                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterUnitInPart, DiversityCollection.CollectionSpecimen.SqlUnitInPart + WhereClause + OrderClause, this.dataSetCollectionSpecimen.IdentificationUnitInPart);
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterIdentification, DiversityCollection.CollectionSpecimen.SqlIdentification + WhereClause + " ORDER BY IdentificationSequence", this.dataSetCollectionSpecimen.Identification);
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterAnalysis, DiversityCollection.CollectionSpecimen.SqlAnalysis + WhereClause, this.dataSetCollectionSpecimen.IdentificationUnitAnalysis);
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterGeoAnalysis, DiversityCollection.CollectionSpecimen.SqlGeoAnalysis + WhereClause + " ORDER BY AnalysisDate", this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysis);
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterAnalysisMethod, DiversityCollection.CollectionSpecimen.SqlAnalysisMethod + WhereClause, this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethod);
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterAnalysisMethodParameter, DiversityCollection.CollectionSpecimen.SqlAnalysisMethodParameter + WhereClause, this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter);

                try
                {
                    SQL = DiversityCollection.CollectionSpecimen.SqlAnalysisMethodList + WhereClause;
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodList);
                }
                catch { }
                try
                {
                    SQL = DiversityCollection.CollectionSpecimen.SqlAnalysisMethodParameterList + WhereClause;
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameterList);
                }
                catch { }

                try
                {
                    SQL = "SELECT CollectionSpecimenID, IdentificationUnitID, AnalysisDate, Geography.ToString() AS GeographyAsString, Geometry.ToString() AS GeometryAsString " +
                        "FROM IdentificationUnitGeoAnalysis " + WhereClause + " ORDER BY AnalysisDate";
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo);
                }
                catch { }

                this.listBoxSpecimenImage.Items.Clear();
                this.userControlXMLTreeExif.XML = "";
                if (this.ShowImagesSpecimen)
                {
                    this.FormFunctions.FillImageList(this.listBoxSpecimenImage, this.imageListSpecimenImages, this.imageListForm, this.dataSetCollectionSpecimen.CollectionSpecimenImage, "URI", this.userControlImageSpecimenImage);
                    if (this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count == 0)
                    {
                        if (this.ImageMarkingActive)
                            this.toolStripButtonImagePropertyGeometry_Click(null, null);
                        this.tabControlSpecimenImage.Enabled = false;
                    }
                }
                if (this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count == 0)
                {
                    this.tabControlSpecimenImage.Enabled = false;
                    //this.tableLayoutPanelSpecimenImage.Enabled = false;
                    //this.tableLayoutPanelSpecimenImageIPR.Enabled = false;
                }
                if (!this.ShowImagesSpecimen && this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count > 0)
                    this.buttonHeaderShowSpecimenImage.BackColor = System.Drawing.Color.Yellow;
                else if (!this.ShowImagesSpecimen && this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count == 0)
                    this.buttonHeaderShowSpecimenImage.BackColor = System.Drawing.SystemColors.Control;

                this.setSpecimenImageUnitList();
                this.setSpecimenImagePartList();

                if (this.labelSpecimenImageIdentificationUnitID.Visible == false)
                    this.labelSpecimenImageIdentificationUnitID.Visible = true;
                if (this.comboBoxSpecimenImageIdentificationUnitID.Visible == false)
                    this.comboBoxSpecimenImageIdentificationUnitID.Visible = true;

                //TODO: Notlsung fuer Anzeige - Ursache nicht gefunden
                if (this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count > 0)
                {
                    if (!this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows[0]["SpecimenPartID"].Equals(System.DBNull.Value))
                    {
                        //System.Data.DataRow[] rv = this.DtPartList.Select("SpecimenPartID = " + this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows[0]["SpecimenPartID"].ToString());
                        System.Data.DataRow[] rv = this._dtImageParts.Select("SpecimenPartID = " + this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows[0]["SpecimenPartID"].ToString());
                        if (rv.Length > 0)
                            this.comboBoxSpecimenImageSpecimenPart.Text = rv[0]["StorageLocation"].ToString();
                    }
                    if (!this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows[0]["IdentificationUnitID"].Equals(System.DBNull.Value))
                    {
                        System.Data.DataRow[] ru = this._dtImageUnits.Select("IdentificationUnitID = " + this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows[0]["IdentificationUnitID"].ToString());
                        try
                        {
                            if (ru.Length > 0)
                                this.comboBoxSpecimenImageIdentificationUnitID.Text = ru[0]["LastIdentificationCache"].ToString();
                        }
                        catch (System.Exception ex)
                        {
                            System.Windows.Forms.MessageBox.Show(ex.Message, "Error setting the identification unit of the image", System.Windows.Forms.MessageBoxButtons.OK);
                        }
                    }
                    if (this.ImagePropertyFilter().Length > 0)
                        this.RestrictImagesToPropertyFilter();
                }

                //this.buildUnitHierarchy();
                this.fillProjectList();
                //this.buildStorageHierarchy();
                this.treeViewStorageHierarchy_AfterSelect(null, null);

                if (this.listBoxSpecimenImage.Items.Count > 0)
                {
                    //this.listBoxSpecimenImage_SelectedIndexChanged(null, null);
                    //this.listBoxSpecimenImage.SelectedIndex = 0;
                    //this.comboBoxSpecimenImageSpecimenPart.DataSource;
                    //this.comboBoxSpecimenImageSpecimenPart.DisplayMember;
                    //this.comboBoxSpecimenImageSpecimenPart.ValueMember;
                    //this.comboBoxSpecimenImageSpecimenPart.SelectedIndex;
                    //this.comboBoxSpecimenImageSpecimenPart.Text;
                    //this.comboBoxSpecimenImageSpecimenPart.SelectedText;
                    //this.comboBoxSpecimenImageSpecimenPart.SelectedValue;
                    //this.comboBoxSpecimenImageSpecimenPart.SelectedItem;
                }

                this.setRelatedSpecimenControls();

                // Event
                if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count > 0)
                {
                    this.setEvent();
                }
                else
                {
                    this.listBoxEventImages.Items.Clear();
                    this.listBoxCollectionEventSeriesImages.Items.Clear();
                }
                this.fillExternalRelatedSpecimenAndUnits();
                this.setEventControls();

                
                WhereClause = " WHERE (ReferencedID = " + this.ID.ToString() + " AND ReferencedTable = 'CollectionSpecimen')";
                if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count > 0)
                {
                    if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].Equals(System.DBNull.Value))
                        WhereClause += " OR (ReferencedID = " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].ToString() + " AND ReferencedTable = 'CollectionEvent')";
                    if (this.dataSetCollectionSpecimen.CollectionEvent.Rows.Count > 0 &&
                        !this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"].Equals(System.DBNull.Value))
                        WhereClause += " OR (ReferencedID = " + this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"].ToString() + " AND ReferencedTable = 'CollectionEventSeries')";
                    if (this.dataSetCollectionSpecimen.IdentificationUnit.Rows.Count > 0)
                    {
                        WhereClause += " OR (ReferencedID IN (";
                        string UnitIDs = "";
                        foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.IdentificationUnit.Rows)
                        {
                            if (UnitIDs.Length > 0) UnitIDs += ", ";
                            UnitIDs += R["IdentificationUnitID"].ToString();
                        }
                        WhereClause += UnitIDs + ") AND ReferencedTable = 'IdentificationUnit')";
                    }
                    if (this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows.Count > 0)
                    {
                        WhereClause += " OR (ReferencedID IN (";
                        string IDs = "";
                        foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows)
                        {
                            if (IDs.Length > 0) IDs += ", ";
                            IDs += R["SpecimenPartID"].ToString();
                        }
                        WhereClause += IDs + ") AND ReferencedTable = 'CollectionSpecimenPart')";
                    }
                    if (this.dataSetCollectionSpecimen.CollectionSpecimenReference.Rows.Count > 0)
                    {
                        WhereClause += " OR (ReferencedID IN (";
                        string IDs = "";
                        foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenReference.Rows)
                        {
                            if (IDs.Length > 0) IDs += ", ";
                            IDs += R["ReferenceID"].ToString();
                        }
                        WhereClause += IDs + ") AND ReferencedTable = 'CollectionSpecimenReference')";
                    }
                    // Identifier
                    this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterIdentifier, DiversityCollection.CollectionSpecimen.SqlExternalIdentifier + WhereClause + " ORDER BY ID", this.dataSetCollectionSpecimen.ExternalIdentifier);
                    //if (this.dataSetCollectionSpecimen.ExternalIdentifier.Rows.Count > 0)
                    //    this.toolStripButtonOverviewHierarchyShowAnnotation.Visible = true;
                    //else
                    //    this.toolStripButtonOverviewHierarchyShowAnnotation.Visible = false;

                    // Annotations
                    this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterAnnotation, DiversityWorkbench.Annotation.SqlAnnotation + WhereClause + " ORDER BY AnnotationID", this.dataSetCollectionSpecimen.Annotation);
                    if (this.dataSetCollectionSpecimen.Annotation.Rows.Count > 0)
                        this.toolStripButtonOverviewHierarchyShowAnnotation.Visible = true;
                    else
                        this.toolStripButtonOverviewHierarchyShowAnnotation.Visible = false;

                }

                this.buildOverviewHierarchy();
                this.setToolStripDropDownButtonsEventPropertyVisibilty();
                this.setToolStripDropDownButtonsEventLocalisationVisibilty();
                this.setMapControls();

            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message, "Error setting the specimen", System.Windows.Forms.MessageBoxButtons.OK);
            }
        }

        private bool? _HasOldVersionOfImageTables;
        private bool HasOldVersionOfImageTables
        {
            get
            {
                if (this._HasOldVersionOfImageTables == null)
                {
                    string SQL = "SELECT     COUNT(*) AS Expr1 " +
                        "FROM INFORMATION_SCHEMA.COLUMNS AS C " +
                        "WHERE (TABLE_NAME = 'CollectionSpecimenImage') AND (COLUMN_NAME = 'CopyrightStatement')";
                    string Result = DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL);
                    if (Result == "1")
                        this._HasOldVersionOfImageTables = false;
                    else
                        this._HasOldVersionOfImageTables = true;

                    this.textBoxSpecimenImageCopyright.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.textBoxSpecimenImageInternalNotes.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.textBoxSpecimenImageIPR.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.textBoxSpecimenImageLicense.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.textBoxSpecimenImageTitle.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.textBoxSpecimenImageLicenseYear.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.userControlModuleRelatedEntrySpecimenImageCreator.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.userControlModuleRelatedEntrySpecimenImageLicenseHolder.Enabled = !(bool)this._HasOldVersionOfImageTables;

                    this.textBoxEventImageCopyrightStatement.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.textBoxEventImageInternalNotes.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.textBoxEventImageIPR.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.textBoxEventImageLicenseType.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.textBoxEventImageTitle.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.userControlModuleRelatedEntryEventImageCreator.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.userControlModuleRelatedEntryEventImageLicenseHolder.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.textBoxEventImageLicenseYear.Enabled = !(bool)this._HasOldVersionOfImageTables;

                    this.textBoxEventSeriesImageCopyrightStatement.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.textBoxEventSeriesImageIPR.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.textBoxEventSeriesImageLicenseType.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.textBoxEventSeriesImageLicenseYear.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.textBoxCollectionEventSeriesImageInternalNotes.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.textBoxCollectionEventSeriesImageTitle.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.userControlModuleRelatedEntryEventSeriesImageCreator.Enabled = !(bool)this._HasOldVersionOfImageTables;
                    this.userControlModuleRelatedEntryEventSeriesImageLicenseHolder.Enabled = !(bool)this._HasOldVersionOfImageTables;
                }
                return (bool)this._HasOldVersionOfImageTables;
            }
        }

        /// <summary>
        /// filling the list for external specimen and units independent of the series and events
        /// </summary>
        private void fillExternalRelatedSpecimenAndUnits()
        {
            // only if ViewMode is not Grid mode
            if (this._ViewMode == ViewMode.Gridmode) return;

            string SQL = "SELECT CollectionSpecimen.CollectionSpecimenID, CollectionSpecimen.CollectionEventID, CollectionSpecimen.AccessionNumber " +
                "FROM IdentificationUnit INNER JOIN " +
                "IdentificationUnit AS IdentificationUnit_1 ON IdentificationUnit.CollectionSpecimenID <> IdentificationUnit_1.CollectionSpecimenID AND  " +
                "IdentificationUnit.RelatedUnitID = IdentificationUnit_1.IdentificationUnitID INNER JOIN " +
                "CollectionSpecimen ON IdentificationUnit_1.CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID " +
                "WHERE IdentificationUnit.CollectionSpecimenID = " + SpecimenID.ToString() +
                " AND IdentificationUnit.CollectionSpecimenID IN (SELECT CollectionSpecimenID FROM CollectionSpecimenID_UserAvailable)";
            this.sqlDataAdapterEventSeriesSpecimenExtern = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);

            try
            {
                this.sqlDataAdapterEventSeriesSpecimenExtern.Fill(this.dataSetCollectionEventSeries.CollectionSpecimenList);
            }
            catch { }

            SQL = "SELECT IdentificationUnit_1.CollectionSpecimenID, IdentificationUnit_1.IdentificationUnitID, " +
                "IdentificationUnit_1.LastIdentificationCache, IdentificationUnit_1.FamilyCache,  " +
                "IdentificationUnit_1.OrderCache, IdentificationUnit_1.TaxonomicGroup, IdentificationUnit_1.OnlyObserved, IdentificationUnit_1.RelatedUnitID,  " +
                "IdentificationUnit_1.RelationType, IdentificationUnit_1.ColonisedSubstratePart, IdentificationUnit_1.LifeStage, IdentificationUnit_1.Gender,  " +
                "IdentificationUnit_1.NumberOfUnits, IdentificationUnit_1.ExsiccataNumber, IdentificationUnit_1.ExsiccataIdentification,  " +
                "IdentificationUnit_1.UnitIdentifier, IdentificationUnit_1.UnitDescription, IdentificationUnit_1.Circumstances, IdentificationUnit_1.DisplayOrder, IdentificationUnit_1.Notes " +
                "FROM IdentificationUnit INNER JOIN " +
                "IdentificationUnit AS IdentificationUnit_1 ON IdentificationUnit.CollectionSpecimenID <> IdentificationUnit_1.CollectionSpecimenID AND  " +
                "IdentificationUnit.RelatedUnitID = IdentificationUnit_1.IdentificationUnitID INNER JOIN " +
                "CollectionSpecimen ON IdentificationUnit_1.CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID " +
                "WHERE IdentificationUnit.CollectionSpecimenID = " + SpecimenID.ToString() +
                " AND IdentificationUnit.CollectionSpecimenID IN (SELECT CollectionSpecimenID FROM CollectionSpecimenID_UserAvailable)";
            this.sqlDataAdapterEventSeriesUnitExtern = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);

            try
            {
                this.sqlDataAdapterEventSeriesUnitExtern.Fill(this.dataSetCollectionEventSeries.IdentificationUnitList);
            }
            catch { }
        }

        private void updateSpecimen()
        {
            if (this._PreviousAvailability != DiversityCollection.CollectionSpecimen.AvailabilityState.Available && this._PrevoiusID != -1)
            {
                return;
            }

            if (this.sqlDataAdapterSpecimen != null)
            {
                string Message = "";
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimen", this.sqlDataAdapterSpecimen, this.BindingContext, ref Message);
                if (Message.Length > 0)
                {
                    System.Windows.Forms.MessageBox.Show(Message);
                }

                Message = "";
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionAgent", this.sqlDataAdapterAgent, this.collectionAgentBindingSource, ref Message);
                if (Message.Length > 0)
                    System.Windows.Forms.MessageBox.Show(Message);

                // special treatment for Images
                System.Data.DataRowView RImage = (System.Data.DataRowView)this.collectionSpecimenImageBindingSource.Current;
                if (RImage != null)
                {
                    try
                    {
                        RImage.BeginEdit();
                        RImage.EndEdit();
                    }
                    catch  { }
                }

                if (!this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenImage", this.sqlDataAdapterSpecimenImage, this.collectionSpecimenImageBindingSource, ref Message))
                {
                    // if any source is filling the column Description with illeagal values
                    if (Message.StartsWith("XML parsing: "))
                    {
                        try
                        {
                            Message = "";
                            RImage["Description"] = System.DBNull.Value;
                            this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenImage", this.sqlDataAdapterSpecimenImage, this.collectionSpecimenImageBindingSource, ref Message);
                        }
                        catch (System.Exception ex)
                        {
                        }
                    }
                }

                System.Data.DataRowView RImageProperty = (System.Data.DataRowView)this.collectionSpecimenImagePropertyBindingSource.Current;
                if (RImageProperty != null)
                {
                    try
                    {
                        RImageProperty.BeginEdit();
                        RImageProperty.EndEdit();
                    }
                    catch { }
                }
                if (!this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenImageProperty", this.sqlDataAdapterSpecimenImageProperty, this.collectionSpecimenImagePropertyBindingSource))
                {

                }

                System.Data.DataRowView RReference = (System.Data.DataRowView)this.collectionSpecimenReferenceBindingSource.Current;
                if (RReference != null)
                {
                    try
                    {
                        RReference.BeginEdit();
                        RReference.EndEdit();
                    }
                    catch { }
                }
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenReference", this.sqlDataAdapterReference, this.BindingContext);

                // special treatment for Relations
                System.Data.DataRowView RRel = (System.Data.DataRowView)this.collectionSpecimenRelationBindingSource.Current;
                if (RRel != null)
                {
                    try
                    {
                        RRel.BeginEdit();
                        RRel.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                }
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenRelation", this.sqlDataAdapterRelation, this.BindingContext);

                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionProject", this.sqlDataAdapterProject, this.BindingContext);

                // if datasets of this table were deleted, this must happen before deleting the parent tables
                System.Data.DataRowView UIP = (System.Data.DataRowView)this.identificationUnitInPartBindingSource.Current;
                if (UIP != null)
                {
                    try
                    {
                        UIP.BeginEdit();
                        UIP.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }
                System.Collections.Generic.Dictionary<string, string> MessageUnitInPart = new Dictionary<string, string>();
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "IdentificationUnitInPart", this.sqlDataAdapterUnitInPart, this.BindingContext, ref MessageUnitInPart);
                
                System.Data.DataRowView RP = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
                if (RP != null)
                {
                    try
                    {
                        RP.BeginEdit();
                        RP.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenPart", this.sqlDataAdapterPart, this.BindingContext);

                if (this._ViewMode != ViewMode.Gridmode)
                {
                    System.Data.DataRowView RProc = (System.Data.DataRowView)this.collectionSpecimenProcessingBindingSource.Current;
                    if (RProc != null)
                    {
                        try
                        {
                            RProc.BeginEdit();
                            RProc.EndEdit();
                        }
                        catch (System.Data.ConstraintException cex)
                        {
                            System.Windows.Forms.MessageBox.Show(cex.Message);
                        }
                    }
                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenProcessing", this.sqlDataAdapterProcessing, this.BindingContext);
                }
                // ProcessingMethod
                bool UpdateProcessingMethodSuccessful = true;
                if (this._ViewMode != ViewMode.Gridmode)
                {
                    System.Data.DataRowView RProcM = (System.Data.DataRowView)this.collectionSpecimenProcessingMethodBindingSource.Current;
                    if (RProcM != null)
                    {
                        try
                        {
                            RProcM.BeginEdit();
                            RProcM.EndEdit();
                        }
                        catch (System.Data.ConstraintException cex)
                        {
                            System.Windows.Forms.MessageBox.Show(cex.Message);
                        }
                    }
                    UpdateProcessingMethodSuccessful = this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenProcessingMethod", this.sqlDataAdapterProcessingMethod, this.BindingContext);
                }
                //ProcessingMethodParameter
                if (this._ViewMode != ViewMode.Gridmode)
                {
                    System.Data.DataRowView RProcMP = (System.Data.DataRowView)this.collectionSpecimenProcessingMethodParameterBindingSource.Current;
                    if (RProcMP != null)
                    {
                        try
                        {
                            RProcMP.BeginEdit();
                            RProcMP.EndEdit();
                        }
                        catch (System.Data.ConstraintException cex)
                        {
                            System.Windows.Forms.MessageBox.Show(cex.Message);
                        }
                    }
                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenProcessingMethodParameter", this.sqlDataAdapterProcessingMethodParameter, this.BindingContext);
                    if (!UpdateProcessingMethodSuccessful)
                        this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenProcessingMethod", this.sqlDataAdapterProcessingMethod, this.BindingContext);
                }

                if (this._ViewMode != ViewMode.Gridmode)
                {
                    System.Data.DataRowView RPartDes = (System.Data.DataRowView)this.collectionSpecimenPartDescriptionBindingSource.Current;
                    if (RPartDes != null)
                    {
                        try
                        {
                            RPartDes.BeginEdit();
                            RPartDes.EndEdit();
                        }
                        catch (System.Data.ConstraintException cex)
                        {
                            System.Windows.Forms.MessageBox.Show(cex.Message);
                        }
                    }
                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenPartDescription", this.sqlDataAdapterPartDescription, this.BindingContext);
                }

                //if (this._ViewMode != ViewMode.Gridmode)
                //{
                //    System.Data.DataRowView RPartReg = (System.Data.DataRowView)this.collectionSpecimenPartRegulationBindingSource.Current;
                //    if (RPartReg != null)
                //    {
                //        try
                //        {
                //            RPartReg.BeginEdit();
                //            RPartReg.EndEdit();
                //        }
                //        catch (System.Data.ConstraintException cex)
                //        {
                //            System.Windows.Forms.MessageBox.Show(cex.Message);
                //        }
                //    }
                //    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenPartRegulation", this.sqlDataAdapterPartRegulation, this.BindingContext);
                //}

                if (this._ViewMode != ViewMode.Gridmode)
                {
                    System.Data.DataRowView RTrans = (System.Data.DataRowView)this.collectionSpecimenTransactionBindingSource.Current;
                    if (RTrans != null)
                    {
                        try
                        {
                            RTrans.BeginEdit();
                            RTrans.EndEdit();
                        }
                        catch (System.Data.ConstraintException cex)
                        {
                            System.Windows.Forms.MessageBox.Show(cex.Message);
                        }
                    }
                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenTransaction", this.sqlDataAdapterTransaction, this.BindingContext);
                }

                // special treatment for Identifications
                System.Data.DataRowView RU = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
                if (RU != null)
                {
                    try
                    {
                        RU.BeginEdit();
                        RU.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }
                System.Data.DataRowView RI = (System.Data.DataRowView)this.identificationBindingSource.Current;
                if (RI != null)
                {
                    try
                    {
                        RI.BeginEdit();
                        RI.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }
                System.Data.DataRowView RA = (System.Data.DataRowView)this.identificationUnitAnalysisBindingSource.Current;
                if (RA != null)
                {
                    try
                    {
                        RA.BeginEdit();
                        RA.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }

                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "IdentificationUnitAnalysis", this.sqlDataAdapterAnalysis, this.BindingContext);
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "IdentificationUnit", this.sqlDataAdapterUnit, this.BindingContext);
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "Identification", this.sqlDataAdapterIdentification, this.BindingContext);
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "IdentificationUnitAnalysis", this.sqlDataAdapterAnalysis, this.BindingContext);
                if (!this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "IdentificationUnitInPart", this.sqlDataAdapterUnitInPart, this.BindingContext))
                {
                    //this.fillPartDisplayLists(this.treeViewOverviewHierarchyStorage.SelectedNode);
                    //this.toolStripButtonUnitMoveInPartAll_Click(null, null);
                    //this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "IdentificationUnitInPart", this.sqlDataAdapterUnitInPart, this.BindingContext);
                }


                System.Data.DataRowView RGeo = (System.Data.DataRowView)this.identificationUnitGeoAnalysisBindingSource.Current;
                if (RGeo != null)
                {
                    try
                    {
                        RGeo.BeginEdit();
                        RGeo.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "IdentificationUnitGeoAnalysis", this.sqlDataAdapterGeoAnalysis, this.BindingContext);

                System.Data.DataRowView RM = (System.Data.DataRowView)this.identificationUnitAnalysisMethodListBindingSource.Current;
                if (RM != null)
                {
                    try
                    {
                        RM.BeginEdit();
                        RM.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "IdentificationUnitAnalysisMethod", this.sqlDataAdapterAnalysisMethod, this.BindingContext);

                System.Data.DataRowView RPa = (System.Data.DataRowView)this.identificationUnitAnalysisMethodParameterBindingSource.Current;
                if (RPa != null)
                {
                    try
                    {
                        RPa.BeginEdit();
                        RPa.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "IdentificationUnitAnalysisMethodParameter", this.sqlDataAdapterAnalysisMethodParameter, this.BindingContext);

                if (RM != null)
                {
                    try
                    {
                        RM.BeginEdit();
                        RM.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "IdentificationUnitAnalysisMethod", this.sqlDataAdapterAnalysisMethod, this.BindingContext);

                if (RA != null)
                {
                    try
                    {
                        RA.BeginEdit();
                        RA.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }

                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "IdentificationUnitAnalysis", this.sqlDataAdapterAnalysis, this.BindingContext);

                // try a second time as new data in the table CollectionSpecimenPart may be missing for referential integrity
                //System.Data.DataRowView RUP = (System.Data.DataRowView)this.identificationUnitInPartBindingSource.Current;
                //if (RUP != null)
                //{
                //    try
                //    {
                //        RUP.BeginEdit();
                //        RUP.EndEdit();
                //    }
                //    catch (System.Data.ConstraintException cex)
                //    {
                //        System.Windows.Forms.MessageBox.Show(cex.Message);
                //    }
                //    catch (System.Exception ex)
                //    {
                //        System.Windows.Forms.MessageBox.Show(ex.Message);
                //    }
                //}
                //this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "IdentificationUnitInPart", this.sqlDataAdapterUnitInPart, this.BindingContext);

                /// Allready done - geht hier nicht da sonst die Hierarchie verloren geht, muss im Formular erfolgen
                //foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.Annotation.Rows)
                //{
                //    R.BeginEdit();
                //    R.EndEdit();
                //}
                //this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "Annotation", this.sqlDataAdapterAnnotation, this.BindingContext);

                System.Data.DataRowView RE = (System.Data.DataRowView)this.collectionEventBindingSource.Current;
                if (RE != null)
                {
                    try
                    {
                        RE.BeginEdit();
                        RE.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }
                System.Data.DataRowView RL = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                if (RL != null)
                {
                    try
                    {
                        RL.BeginEdit();
                        RL.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionEvent", this.sqlDataAdapterEvent, this.BindingContext);

                System.Data.DataRowView REi = (System.Data.DataRowView)this.collectionEventImageBindingSource.Current;
                if (REi != null)
                {
                    try
                    {
                        REi.BeginEdit();
                        REi.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionEventImage", this.sqlDataAdapterEventImage, this.BindingContext);

                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionEventRegulation", this.sqlDataAdapterEventRegulation, this.BindingContext);

                bool OK = this.FormFunctions.getObjectPermissions("CollectionEventLocalisation", "UPDATE");
                if (OK)
                {
                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionEventLocalisation", this.sqlDataAdapterLocalisation, this.BindingContext);
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Select("GeographyAsString <> ''");
                    if (rr.Length > 0)
                    {
                        for (int i = 0; i < rr.Length; i++)
                        {
                            if (!rr[i][2].Equals(System.DBNull.Value) && rr[i][2].ToString().Length > 0)
                            {
                                string SQL = "SELECT geography::STGeomFromText('" + rr[i][2].ToString() + "', 4326) ";
                                string Geo = DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL);
                                SQL = "SELECT Geography.ToString() FROM CollectionEventLocalisation " +
                                    "WHERE CollectionEventID = " + rr[i][0].ToString() + " AND LocalisationSystemID = " + rr[i][1].ToString(); ;
                                string GeoInDB = DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL);
                                if (Geo != GeoInDB)
                                {
                                    SQL = "UPDATE CollectionEventLocalisation SET Geography = geography::STGeomFromText('" + rr[i][2].ToString() + "', 4326) " +
                                        "WHERE CollectionEventID = " + rr[i][0].ToString() + " AND LocalisationSystemID = " + rr[i][1].ToString();
                                    DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL, ref Message);
                                    if (Message.Length > 0)
                                    {
                                        System.Windows.Forms.MessageBox.Show(Message);
                                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile("updateSpecimen()", SQL, Message);
                                    }
                                }
                            }
                        }
                    }
                }

                System.Data.DataRowView RProp = (System.Data.DataRowView)this.collectionEventPropertyBindingSource.Current;
                if (RProp != null)
                {
                    try
                    {
                        RProp.BeginEdit();
                        RProp.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionEventProperty", this.sqlDataAdapterProperty, this.BindingContext);

                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "Collection", this.sqlDataAdapterCollection, this.BindingContext);

                this.FormFunctions.updateTable(this.dataSetCollectionEventSeries, "CollectionEventSeries", this.sqlDataAdapterEventSeries, this.BindingContext);
                this.FormFunctions.updateTable(this.dataSetCollectionEventSeries, "CollectionEventSeriesImage", this.sqlDataAdapterEventSeriesImage, this.BindingContext);

                System.Data.DataRowView RMeth = (System.Data.DataRowView)this.collectionEventMethodBindingSource.Current;
                if (RMeth != null)
                {
                    try
                    {
                        RMeth.BeginEdit();
                        RMeth.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }
                bool UpdateCollectionEventMethodSuccess = false;
                UpdateCollectionEventMethodSuccess = this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionEventMethod", this.sqlDataAdapterCollectionEventMethod, this.BindingContext);

                System.Data.DataRowView RPar = (System.Data.DataRowView)this.collectionEventParameterValueBindingSource.Current;
                if (RPar != null)
                {
                    try
                    {
                        RPar.BeginEdit();
                        RPar.EndEdit();
                    }
                    catch (System.Data.ConstraintException cex)
                    {
                        System.Windows.Forms.MessageBox.Show(cex.Message);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }
                }
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionEventParameterValue", this.sqlDataAdapterCollectionEventMethodParameter, this.BindingContext);
                if (!UpdateCollectionEventMethodSuccess)
                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionEventMethod", this.sqlDataAdapterCollectionEventMethod, this.BindingContext);
            }
        }

        private void labelURI_Click(object sender, EventArgs e)
        {
            try
            {
                string URI = this.labelURI.Text;
                string Display = this.textBoxAccessionNumber.Text;
                if (Display.Length == 0)
                    Display = "[ID: " + this.ID.ToString() + "]";
                DiversityWorkbench.Forms.FormInfo f = new DiversityWorkbench.Forms.FormInfo("URI of " + Display, URI);
                f.ShowDialog();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #region Accession

        private void buttonFindNextAccessionNumber_Click(object sender, EventArgs e)
        {
            try
            {
                DiversityCollection.FormAccessionNumber f = new FormAccessionNumber(this.textBoxAccessionNumber.Text, true, false);
                f.ShowDialog();
                if (f.DialogResult == DialogResult.OK)
                {
                    if (f.AccessionNumber.Length > 0)
                    {
                        this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"] = f.AccessionNumber;
                        this.textBoxAccessionNumber.Text = f.AccessionNumber;
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void textBoxAccessionNumber_TextChanged(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenBindingSource.Current;
            if (this.textBoxAccessionNumber.Text.Length > 0 && (R["AccessionNumber"].Equals(System.DBNull.Value) || R["AccessionNumber"].ToString().Length == 0))
                this.buttonFindNextAccessionNumber.Enabled = true;
            else
                this.buttonFindNextAccessionNumber.Enabled = false;
        }

        private string NextAccessionNumber(string AccessionNumber, bool IncludeSpecimen, bool IncludeParts)
        {
            string AccNr = "";
            try
            {
                string SQL = "SELECT dbo.NextFreeAccNumber('" + AccessionNumber + "',";
                if (IncludeSpecimen) SQL += " 1, ";
                else SQL += " 0, ";
                if (IncludeParts) SQL += " 1)";
                else SQL += " 0)";
                System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                System.Data.SqlClient.SqlCommand cmd = new System.Data.SqlClient.SqlCommand(SQL, con);
                cmd.CommandText = SQL;
                con.Open();
                AccNr = cmd.ExecuteScalar().ToString();
                con.Close();
                if (AccNr.Length == 0)
                    System.Windows.Forms.MessageBox.Show("The system could not generate a new unique AccessionNumber");
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            return AccNr;
        }

        private void textBoxAccessionNumber_Leave(object sender, EventArgs e)
        {
            this.CheckDuplicateAccessionNumber();
        }

        private void CheckDuplicateAccessionNumber()
        {
            string CollectionSpecimenID = "x";
            if (this.userControlQueryList.ProjectID != 0
                && !this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].Equals(System.DBNull.Value))
            {
                // Check within the project
                try
                {
                    string SQL = "SELECT MIN(P.CollectionSpecimenID) AS ID " +
                        " FROM  CollectionProject AS P INNER JOIN " +
                        " CollectionSpecimen AS S ON P.CollectionSpecimenID = S.CollectionSpecimenID " +
                        " WHERE S.AccessionNumber = N'" + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString() + "'" +
                        " AND P.CollectionSpecimenID <> " + this.ID.ToString() +
                        " AND LEN(S.AccessionNumber) > 0 ";
                    if (this.userControlQueryList.ProjectIsSelected)
                        SQL += " AND P.ProjectID = " + this.userControlQueryList.ProjectID.ToString();
                    CollectionSpecimenID = DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL);
                }
                catch { }
            }
            int ID;
            if (int.TryParse(CollectionSpecimenID, out ID))
            {
                this.buttonGoToDuplicateAccessionNumber.Tag = ID;
                this.buttonGoToDuplicateAccessionNumber.Visible = true;
                this.textBoxAccessionNumber.BackColor = System.Drawing.Color.Pink;
                this.buttonGoToDuplicateAccessionNumber.ForeColor = System.Drawing.Color.Black;
            }
            else
            {
                // Check within the whole database
                try
                {
                    string SQL = "SELECT MIN(S.CollectionSpecimenID) AS ID " +
                        " FROM CollectionSpecimen AS S " +
                        " WHERE S.AccessionNumber = N'" + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString() + "'" +
                        " AND S.CollectionSpecimenID <> " + this.ID.ToString() +
                        " AND LEN(S.AccessionNumber) > 0 ";
                    CollectionSpecimenID = DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL);
                }
                catch { }
                if (int.TryParse(CollectionSpecimenID, out ID))
                {
                    this.buttonGoToDuplicateAccessionNumber.Tag = ID;
                    this.buttonGoToDuplicateAccessionNumber.Visible = true;
                    this.buttonGoToDuplicateAccessionNumber.ForeColor = System.Drawing.Color.Red;
                    this.textBoxAccessionNumber.BackColor = System.Drawing.Color.Pink;
                }
                else
                {
                    this.buttonGoToDuplicateAccessionNumber.Visible = false;
                    this.buttonGoToDuplicateAccessionNumber.Tag = null;

                    // Check UPDATE
                    bool OK = this.FormFunctions.getObjectPermissions("CollectionSpecimen", "UPDATE");
                    if (OK)
                        this.textBoxAccessionNumber.BackColor = System.Drawing.SystemColors.Window;
                    else
                        this.textBoxAccessionNumber.BackColor = System.Drawing.SystemColors.Control;
                }
            }
        }

        private void buttonGoToDuplicateAccessionNumber_Click(object sender, EventArgs e)
        {
            if (this.buttonGoToDuplicateAccessionNumber.Tag != null)
            {
                int ID;
                if (int.TryParse(this.buttonGoToDuplicateAccessionNumber.Tag.ToString(), out ID))
                {
                    string SQL = "SELECT TOP 1 CollectionSpecimenID " +
                        "FROM CollectionSpecimenID_Available " +
                        "WHERE CollectionSpecimenID = " + ID.ToString();
                    string Result = DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL);
                    if (Result.Length > 0)
                        this.setSpecimen(ID);
                    else
                    {
                        SQL = "SELECT TOP (1) P.Project " +
                            "FROM CollectionProject AS c INNER JOIN " +
                            "ProjectProxy AS P ON c.ProjectID = P.ProjectID " +
                            "WHERE c.CollectionSpecimenID = " + ID.ToString();
                        string Message = DiversityCollection.Forms.FormCollectionSpecimenText.You_have_no_access_to_this_dataset +
                            "\r\nYou need access to project\r\n" + DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL);
                        System.Windows.Forms.MessageBox.Show(Message, "No access", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }
            }
        }
        
        #endregion

        #region Specimen images

        #region Common
        
        private void listBoxSpecimenImage_DrawItem(object sender, DrawItemEventArgs e)
        {
            try
            {
                if (e.Index > -1)
                {
                    this.imageListSpecimenImages.Draw(e.Graphics, e.Bounds.X, e.Bounds.Y, 50, 50, e.Index);
                }
            }
            catch (System.Exception ex) 
            { 
            }
        }

        private void listBoxSpecimenImage_MeasureItem(object sender, MeasureItemEventArgs e)
        {
            e.ItemHeight = this.imageListSpecimenImages.ImageSize.Height;
            e.ItemWidth = this.imageListSpecimenImages.ImageSize.Width;
        }

        private void toolStripButtonSpecimenImageNew_Click(object sender, EventArgs e)
        {
            try
            {
                string AccessionNumber = "";
                if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].Equals(System.DBNull.Value))
                    AccessionNumber = this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString();
                int? ProjectID = null;
                if (this.userControlQueryList.ProjectIsSelected)
                    ProjectID = this.userControlQueryList.ProjectID;
                string RowGUID = System.Guid.NewGuid().ToString();
                DiversityWorkbench.FormGetImage f = new DiversityWorkbench.FormGetImage(ProjectID, AccessionNumber);
                if (f.ShowDialog() == System.Windows.Forms.DialogResult.OK)
                {
                    if (f.ImagePath.Length > 0)
                    {
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenImageRow R = this.dataSetCollectionSpecimen.CollectionSpecimenImage.NewCollectionSpecimenImageRow();
                        R.CollectionSpecimenID = this.SpecimenID;
                        R.URI = f.URIImage;
                        R.Description = f.Exif;
                        System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenImage.Select("", "DisplayOrder DESC");
                        int DisplayOrder = 1;
                        if (rr.Length > 0 && !rr[0]["DisplayOrder"].Equals(System.DBNull.Value))
                            DisplayOrder = int.Parse(rr[0]["DisplayOrder"].ToString()) + 1;
                        R.DisplayOrder = DisplayOrder;
                        this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Add(R);
                        this.FormFunctions.FillImageList(this.listBoxSpecimenImage, this.imageListSpecimenImages, this.imageListForm, this.dataSetCollectionSpecimen.CollectionSpecimenImage, "URI", this.userControlImageSpecimenImage);
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonSpecimenImageDelete_Click(object sender, EventArgs e)
        {
            try
            {
                string URL = this.userControlImageSpecimenImage.ImagePath;
                if (URL.Length > 0)
                {
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenImage.Select("URI = '" + URL + "'");
                    if (rr.Length > 0)
                    {
                        System.Data.DataRow r = rr[0];
                        if (r.RowState != System.Data.DataRowState.Deleted)
                        {
                            r.Delete();
                            this.FormFunctions.FillImageList(this.listBoxSpecimenImage, this.imageListSpecimenImages, this.imageListForm, this.dataSetCollectionSpecimen.CollectionSpecimenImage, "URI", this.userControlImageSpecimenImage);
                            if (this.listBoxSpecimenImage.Items.Count > 0) this.listBoxSpecimenImage.SelectedIndex = 0;
                            else
                            {
                                this.listBoxSpecimenImage.SelectedIndex = -1;
                                this.userControlImageSpecimenImage.ImagePath = "";
                            }
                        }
                    }
                }
                bool NoImageLeft = false;
                if (this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count == 0 
                    || (this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count == 1
                    && this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows[0].RowState == DataRowState.Deleted))
                    NoImageLeft = true;
                if (NoImageLeft)
                {
                    this.tabControlSpecimenImage.Enabled = false;
                    //this.tableLayoutPanelSpecimenImage.Enabled = false;
                    //this.tableLayoutPanelSpecimenImageIPR.Enabled = false;
                    //this.tableLayoutPanelImageProperty.Enabled = false;
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void listBoxSpecimenImage_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                int i = this.listBoxSpecimenImage.SelectedIndex;
                for (int p = 0; p <= i; p++)
                {
                    if (this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows[p].RowState == System.Data.DataRowState.Deleted) i++;
                }
                if (this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count > i)
                {
                    this.tabControlSpecimenImage.Enabled = true;
                    System.Data.DataRow r = this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows[i];
                    this.userControlImageSpecimenImage.ImagePath = r["URI"].ToString();
                    this.collectionSpecimenImageBindingSource.Position = i;

                    System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                    string Restriction = "";//(Code LIKE 'audio%' OR Code LIKE 'video%' OR Code LIKE 'sound%')";
                    if (this.userControlImageSpecimenImage.MediumType == DiversityWorkbench.FormFunctions.Medium.Image)
                        Restriction = "NOT " + Restriction;
                    this.setImagePropertyList();
                    //this.listBoxImageProperty_SelectedIndexChanged(null, null);
                    ///##2
                    string XML = r["Description"].ToString();
                    this.userControlXMLTreeExif.setToDisplayOnly();
                    this.userControlXMLTreeExif.XML = XML;
                    // Checking the display order
                    if (!r["DisplayOrder"].Equals(System.DBNull.Value))
                    {
                        int DisplayOrder;
                        if (int.TryParse(r["DisplayOrder"].ToString(), out DisplayOrder))
                        {
                            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenImage.Select("CollectionSpecimenID = " + this.ID.ToString() + " AND DisplayOrder = " + DisplayOrder.ToString(), "");
                            if (rr.Length > 1)
                                this.textBoxSpecimenImageDisplayOrder.BackColor = System.Drawing.Color.Pink;
                            else
                                this.textBoxSpecimenImageDisplayOrder.BackColor = System.Drawing.SystemColors.Window;
                        }
                    }
                }
                else
                {
                    this.tabControlSpecimenImage.Enabled = false;
                    this.userControlXMLTreeExif.XML = "";
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void comboBoxSpecimenImageIdentificationUnitID_SelectionChangeCommitted(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRowView r = (System.Data.DataRowView)this.comboBoxSpecimenImageIdentificationUnitID.SelectedItem;
                System.Data.DataRowView rI = (System.Data.DataRowView)this.collectionSpecimenImageBindingSource.Current;
                rI.BeginEdit();
                if (!r[0].Equals(System.DBNull.Value))
                {
                    int IdentificationUnitID = int.Parse(r[0].ToString());
                    rI["IdentificationUnitID"] = IdentificationUnitID;
                }
                else
                    rI["IdentificationUnitID"] = System.DBNull.Value;
                rI.EndEdit();
            }
            catch { }
        }

        private void setSpecimenImageUnitList()
        {
            try
            {
                if (this._dtImageUnits == null)
                {
                    this._dtImageUnits = new DataTable();
                    System.Data.DataColumn C1 = new System.Data.DataColumn("IdentificationUnitID", System.Type.GetType("System.Int32"));
                    System.Data.DataColumn C2 = new System.Data.DataColumn("LastIdentificationCache", System.Type.GetType("System.String"));
                    _dtImageUnits.Columns.Add(C1);
                    _dtImageUnits.Columns.Add(C2);
                    this.comboBoxSpecimenImageIdentificationUnitID.DataSource = this._dtImageUnits;
                    this.comboBoxSpecimenImageIdentificationUnitID.DisplayMember = "LastIdentificationCache";
                    this.comboBoxSpecimenImageIdentificationUnitID.ValueMember = "IdentificationUnitID";
                }
                this._dtImageUnits.Clear();
                System.Data.DataRow r = this._dtImageUnits.NewRow();
                r["LastIdentificationCache"] = System.DBNull.Value;
                r["IdentificationUnitID"] = System.DBNull.Value;
                this._dtImageUnits.Rows.Add(r);
                if (this.dataSetCollectionSpecimen.IdentificationUnit.Rows.Count > 0)
                {
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnit.Select("", "LastIdentificationCache");
                    foreach (System.Data.DataRow R in rr)
                    {
                        if (!R["LastIdentificationCache"].Equals(System.DBNull.Value))
                        {
                            if (R["LastIdentificationCache"].ToString().Length > 0)
                            {
                                System.Data.DataRow ru = this._dtImageUnits.NewRow();
                                ru["LastIdentificationCache"] = R["LastIdentificationCache"].ToString();
                                ru["IdentificationUnitID"] = int.Parse(R["IdentificationUnitID"].ToString());
                                this._dtImageUnits.Rows.Add(ru);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setSpecimenImagePartList()
        {
            try
            {
                if (this._dtImageParts == null)
                {
                    this._dtImageParts = new DataTable();
                    System.Data.DataColumn C1 = new System.Data.DataColumn("SpecimenPartID", System.Type.GetType("System.Int32"));
                    System.Data.DataColumn C2 = new System.Data.DataColumn("StorageLocation", System.Type.GetType("System.String"));
                    _dtImageParts.Columns.Add(C1);
                    _dtImageParts.Columns.Add(C2);
                    this.comboBoxSpecimenImageSpecimenPart.DataSource = this._dtImageParts;
                    this.comboBoxSpecimenImageSpecimenPart.DisplayMember = "StorageLocation";
                    this.comboBoxSpecimenImageSpecimenPart.ValueMember = "SpecimenPartID";
                }
                this._dtImageParts.Clear();
                System.Data.DataRow r = this._dtImageParts.NewRow();
                r["StorageLocation"] = System.DBNull.Value;
                r["SpecimenPartID"] = System.DBNull.Value;
                this._dtImageParts.Rows.Add(r);
                if (this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows.Count > 0)
                {
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenPart.Select("", "StorageLocation");
                    foreach (System.Data.DataRow R in rr)
                    {
                        string DisplayText = "";
                        if (!R["AccessionNumber"].Equals(System.DBNull.Value) && R["AccessionNumber"].ToString().Length > 0)
                            DisplayText = R["AccessionNumber"].ToString() + " - ";
                        if (!R["PartSublabel"].Equals(System.DBNull.Value) && R["PartSublabel"].ToString().Length > 0)
                            DisplayText += R["PartSublabel"].ToString() + " - ";
                        if (!R["StorageLocation"].Equals(System.DBNull.Value) && R["StorageLocation"].ToString().Length > 0)
                            DisplayText += R["StorageLocation"].ToString() + " - ";
                        if (!R["MaterialCategory"].Equals(System.DBNull.Value) && R["MaterialCategory"].ToString().Length > 0)
                            DisplayText += R["MaterialCategory"].ToString() + " - ";
                        System.Data.DataRow ru = this._dtImageParts.NewRow();
                        ru["StorageLocation"] = DisplayText;
                        ru["SpecimenPartID"] = int.Parse(R["SpecimenPartID"].ToString());
                        this._dtImageParts.Rows.Add(ru);
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void comboBoxSpecimenImageSpecimenPart_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRowView r = (System.Data.DataRowView)this.comboBoxSpecimenImageSpecimenPart.SelectedItem;
                System.Data.DataRowView rI = (System.Data.DataRowView)this.collectionSpecimenImageBindingSource.Current;
                if (r == null || rI == null) return;
                rI.BeginEdit();
                if (!r[0].Equals(System.DBNull.Value))
                {
                    int SpecimenPartID = int.Parse(r[0].ToString());
                    rI["SpecimenPartID"] = SpecimenPartID;
                }
                else
                    rI["SpecimenPartID"] = System.DBNull.Value;
                rI.EndEdit();
            }
            catch { }
        }

        private void toolStripButtonImageDescription_Click(object sender, EventArgs e)
        {
            this.setImageDescription(this.collectionSpecimenImageBindingSource);
        }
        
        #endregion

        #region Moving the image and display order

        private void toolStripButtonImageUp_Click(object sender, EventArgs e)
        {
            if (this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count == 0)
                return;
            this.ReplenishImageDisplayOrder();
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenImageBindingSource.Current;
            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenImage.Select("", "DisplayOrder");
            if (rr[0]["DisplayOrder"].ToString() == R["DisplayOrder"].ToString())
            {
                System.Windows.Forms.MessageBox.Show("The image is already on top of the list");
                return;
            }
            else
            {
                int CurrentDisplayOrder = int.Parse(R["DisplayOrder"].ToString());
                int NewDisplayOrder = CurrentDisplayOrder - 1;
                System.Data.DataRow[] rrChange = this.dataSetCollectionSpecimen.CollectionSpecimenImage.Select("DisplayOrder = " + NewDisplayOrder.ToString(), "DisplayOrder");
                if (rrChange.Length > 0)
                {
                    rrChange[0]["DisplayOrder"] = CurrentDisplayOrder;
                }
                R["DisplayOrder"] = NewDisplayOrder;
                try
                {
                    R.BeginEdit();
                    R.EndEdit();
                    rrChange[0].BeginEdit();
                    rrChange[0].EndEdit();
                }
                catch { }
                //this.SaveSpecimenImages();
                this.setSpecimen(this.SpecimenID);
            }
        }

        private void toolStripButtonImageDown_Click(object sender, EventArgs e)
        {
            if (this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count == 0)
                return;
            this.ReplenishImageDisplayOrder();
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenImageBindingSource.Current;
            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenImage.Select("", "DisplayOrder DESC");
            if (rr[0]["DisplayOrder"].ToString() == R["DisplayOrder"].ToString())
            {
                System.Windows.Forms.MessageBox.Show("The image is already at the end of the list");
                return;
            }
            else
            {
                if (R["DisplayOrder"].Equals(System.DBNull.Value))
                {
                    int DisplayOrder = 1;
                    if (rr.Length > 0 && !rr[0]["DisplayOrder"].Equals(System.DBNull.Value))
                        DisplayOrder = int.Parse(rr[0]["DisplayOrder"].ToString());
                    R.BeginEdit();
                    R["DisplayOrder"] = DisplayOrder;
                    R.EndEdit();
                    //return;
                }
                int CurrentDisplayOrder = int.Parse(R["DisplayOrder"].ToString());
                int NewDisplayOrder = CurrentDisplayOrder + 1;
                System.Data.DataRow[] rrChange = this.dataSetCollectionSpecimen.CollectionSpecimenImage.Select("DisplayOrder = " + NewDisplayOrder.ToString(), "DisplayOrder DESC");
                if (rrChange.Length > 0)
                {
                    rrChange[0]["DisplayOrder"] = CurrentDisplayOrder;
                }
                R["DisplayOrder"] = NewDisplayOrder;
                try
                {
                    R.BeginEdit();
                    R.EndEdit();
                    rrChange[0].BeginEdit();
                    rrChange[0].EndEdit();
                }
                catch { }
                //this.SaveSpecimenImages();
                this.setSpecimen(this.SpecimenID);
            }
        }

        private void ReplenishImageDisplayOrder()
        {
            if (this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count == 0)
                return;
            int Previous = 0;
            int Current = Previous + 1;
            bool OK = true;
            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenImage.Select("", "DisplayOrder ASC");
            foreach (System.Data.DataRow R in rr)
            {
                if (R["DisplayOrder"].Equals(System.DBNull.Value))
                {
                    OK = false;
                    break;
                }
                int.TryParse(R["DisplayOrder"].ToString(), out Current);
                if (Current == Previous)
                {
                    OK = false;
                    break;
                }
                Previous = Current;
            }
            if (OK)
                return;
            Current = 1;
            foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows)
            {
                R["DisplayOrder"] = Current;
                Current++;
            }
        }

        private void SaveSpecimenImages()
        {
            // Update for the tables
            System.Data.DataRowView RImage = (System.Data.DataRowView)this.collectionSpecimenImageBindingSource.Current;
            if (RImage != null)
            {
                try
                {
                    RImage.BeginEdit();
                    RImage.EndEdit();
                }
                catch { }
            }
            this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenImage", this.sqlDataAdapterSpecimenImage, this.collectionSpecimenImageBindingSource);

            System.Data.DataRowView RImageProperty = (System.Data.DataRowView)this.collectionSpecimenImagePropertyBindingSource.Current;
            if (RImageProperty != null)
            {
                try
                {
                    RImageProperty.BeginEdit();
                    RImageProperty.EndEdit();
                }
                catch { }
            }
            this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenImageProperty", this.sqlDataAdapterSpecimenImageProperty, this.collectionSpecimenImagePropertyBindingSource);

            this.userControlImageSpecimenImage.ImagePath = "";

            string WhereClause = " WHERE CollectionSpecimenID = " + SpecimenID.ToString();
            if (this._Availability == DiversityCollection.CollectionSpecimen.AvailabilityState.Available)
                WhereClause += " AND CollectionSpecimenID IN (SELECT CollectionSpecimenID FROM CollectionSpecimenID_UserAvailable)";
            else if (this._Availability == DiversityCollection.CollectionSpecimen.AvailabilityState.ReadOnly)
                WhereClause += " AND CollectionSpecimenID IN (SELECT CollectionSpecimenID FROM CollectionSpecimenID_ReadOnly)";

            this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterSpecimenImage, DiversityCollection.CollectionSpecimen.SqlSpecimenImage + WhereClause + "ORDER BY DisplayOrder ASC", this.dataSetCollectionSpecimen.CollectionSpecimenImage);
            this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterSpecimenImageProperty, DiversityCollection.CollectionSpecimen.SqlSpecimenImageProperty + WhereClause, this.dataSetCollectionSpecimen.CollectionSpecimenImageProperty);

            this.listBoxSpecimenImage.Items.Clear();
            if (this.ShowImagesSpecimen)
            {
                this.FormFunctions.FillImageList(this.listBoxSpecimenImage, this.imageListSpecimenImages, this.imageListForm, this.dataSetCollectionSpecimen.CollectionSpecimenImage, "URI", this.userControlImageSpecimenImage);
            }
            if (this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count == 0)
            {
                this.tabControlSpecimenImage.Enabled = false;
                //this.tableLayoutPanelSpecimenImage.Enabled = false;
                //this.tableLayoutPanelSpecimenImageIPR.Enabled = false;
            }
            if (!this.ShowImagesSpecimen && this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count > 0)
                this.buttonHeaderShowSpecimenImage.BackColor = System.Drawing.Color.Yellow;
            else if (!this.ShowImagesSpecimen && this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count == 0)
                this.buttonHeaderShowSpecimenImage.BackColor = System.Drawing.SystemColors.Control;

            this.setSpecimenImageUnitList();
            this.setSpecimenImagePartList();

            if (this.labelSpecimenImageIdentificationUnitID.Visible == false)
                this.labelSpecimenImageIdentificationUnitID.Visible = true;
            if (this.comboBoxSpecimenImageIdentificationUnitID.Visible == false)
                this.comboBoxSpecimenImageIdentificationUnitID.Visible = true;

            //TODO: Notlsung fuer Anzeige - Ursache nicht gefunden
            if (this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count > 0)
            {
                if (!this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows[0]["SpecimenPartID"].Equals(System.DBNull.Value))
                {
                    //System.Data.DataRow[] rv = this.DtPartList.Select("SpecimenPartID = " + this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows[0]["SpecimenPartID"].ToString());
                    System.Data.DataRow[] rv = this._dtImageParts.Select("SpecimenPartID = " + this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows[0]["SpecimenPartID"].ToString());
                    if (rv.Length > 0)
                        this.comboBoxSpecimenImageSpecimenPart.Text = rv[0]["StorageLocation"].ToString();
                }
                if (!this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows[0]["IdentificationUnitID"].Equals(System.DBNull.Value))
                {
                    System.Data.DataRow[] ru = this._dtImageUnits.Select("IdentificationUnitID = " + this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows[0]["IdentificationUnitID"].ToString());
                    try
                    {
                        if (ru.Length > 0)
                            this.comboBoxSpecimenImageIdentificationUnitID.Text = ru[0]["LastIdentificationCache"].ToString();
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message, "Error setting the identification unit of the image", System.Windows.Forms.MessageBoxButtons.OK);
                    }
                }
            }

        }
        
        private void toolStripMenuItemImageDisplayOrderUriUp_Click(object sender, EventArgs e)
        {
            this.setImageDisplayOrder("URI", false);
        }

        private void toolStripMenuItemImageDisplayOrderUriDown_Click(object sender, EventArgs e)
        {
            this.setImageDisplayOrder("URI", true);
        }

        private void toolStripMenuItemImageDisplayOrderDateUp_Click(object sender, EventArgs e)
        {
            this.setImageDisplayOrder("LogCreatedWhen", false);
        }

        private void toolStripMenuItemImageDisplayOrderDateDown_Click(object sender, EventArgs e)
        {
            this.setImageDisplayOrder("LogCreatedWhen", true);
        }

        private void setImageDisplayOrder(string OrderingColumn, bool Descending)
        {
            try
            {
                string SortString = OrderingColumn;
                if (Descending) SortString += " DESC";
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenImage.Select("", SortString);
                for (int i = 0; i < this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count; i++)
                {
                    rr[i].BeginEdit();
                    rr[i]["DisplayOrder"] = i;
                    rr[i].EndEdit();
                }
                this.setSpecimen(this.SpecimenID);
            }
            catch (System.Exception ex) { }
        }

        private void textBoxSpecimenImageDisplayOrder_TextChanged(object sender, EventArgs e)
        {
            if (this.textBoxSpecimenImageDisplayOrder.Text.Length == 0)
            {
                this.textBoxSpecimenImageDisplayOrder.BackColor = System.Drawing.Color.Pink;
                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenImageBindingSource.Current;
                R.BeginEdit();
                R["DisplayOrder"] = System.DBNull.Value;
                R.EndEdit();
                //string Message = "";
                //this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenImage", this.sqlDataAdapterSpecimenImage, this.BindingContext, ref Message);
                this.textBoxSpecimenImageNotes.Focus();
            }
            else this.textBoxSpecimenImageDisplayOrder.BackColor = System.Drawing.Color.White;
            int i;
            if (this.textBoxSpecimenImageDisplayOrder.Text.Length > 0  && !int.TryParse(this.textBoxSpecimenImageDisplayOrder.Text, out i))
            {
                System.Windows.Forms.MessageBox.Show(this.textBoxSpecimenImageDisplayOrder.Text + " is not a valid sequence");
                this.textBoxSpecimenImageDisplayOrder.Text = "";
            }
        }

        #endregion

        #region Image property

        private void setImagePropertyList()
        {
            try
            {
                this.toolStripImagePropertyFilter.Enabled = false;
                this.toolStripButtonImagePropertyDelete.Enabled = false;
                this.toolStripButtonImagePropertyGeometry.Enabled = false;
                this.toolStripTextBoxImagePropertyFilter.AutoCompleteCustomSource = null;

                System.Data.DataRowView RI = (System.Data.DataRowView)this.collectionSpecimenImageBindingSource.Current;
                string URI = RI["URI"].ToString();
                this._dvImageProperty = new DataView(this.dataSetCollectionSpecimen.CollectionSpecimenImageProperty, "URI = '" + URI + "'", "Property", DataViewRowState.CurrentRows);
                this.listBoxImageProperty.DataSource = this._dvImageProperty;
                this.listBoxImageProperty.DisplayMember = "Property";
                this.listBoxImageProperty.ValueMember = "Property";
                if (this._dvImageProperty.Count == 0)
                {
                    this.textBoxImagePropertyDescription.DataBindings.Clear();
                    this.textBoxImagePropertyDescription.Text = "";
                    if (this.ImageMarkingActive)
                        this.toolStripButtonImagePropertyGeometry_Click(null, null);
                }
                else
                {
                    if (this.textBoxImagePropertyDescription.DataBindings.Count == 0)
                        this.textBoxImagePropertyDescription.DataBindings.Add("Text", this.collectionSpecimenImagePropertyBindingSource, "Description");
                }
                if (this.toolStripDropDownButtonImagePropertyArea.Visible)
                    this.toolStripDropDownButtonImagePropertyArea.Visible = false;
            }
            catch(System.Exception ex)
            {

            }
        }

        private void toolStripButtonImagePropertyAdd_Click(object sender, EventArgs e)
        {
            try
            {
                bool AllowNewProperty = false;
                if (DiversityWorkbench.Database.DatabaseRoles().Contains("Administrator")
                    || DiversityWorkbench.Database.DatabaseRoles().Contains("db_owner"))
                {
                    AllowNewProperty = true;
                }

                System.Data.DataTable dt = new DataTable();
                System.Data.DataRowView RI = (System.Data.DataRowView)this.collectionSpecimenImageBindingSource.Current;
                string CurrentUri = RI["URI"].ToString();

                string SqlList = "";
                foreach (System.Object o in this.listBoxImageProperty.Items)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)o;
                    if (SqlList.Length > 0) SqlList += ", ";
                    SqlList += "'" + R["Property"].ToString() + "'";
                }
                string SQL = "SELECT DISTINCT Property " +
                    "FROM CollectionSpecimenImageProperty ";
                if (SqlList.Length > 0)
                    SQL += " WHERE Property NOT IN ( " + SqlList + ")";

                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                string Header = "Please select the property from the list";
                string Message = "Please select the property from the list";
                if (AllowNewProperty)
                {
                    Message += " above\r\nor\r\nenter a new property in the text box below";
                    Header += " or enter a new one";
                }
                DiversityWorkbench.FormGetStringFromList f = new DiversityWorkbench.FormGetStringFromList(dt, "Property", "Property", "New image property", Message, "", AllowNewProperty);
                f.ReduceInterfaceToCombobox(Header, !AllowNewProperty);
                f.ShowDialog();
                if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                {
                    string Property = f.SelectedString;
                    if (AllowNewProperty && f.String.Length > 0)
                        Property = f.String;

                    if (Property.Length > 0)
                    {
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenImagePropertyRow R = this.dataSetCollectionSpecimen.CollectionSpecimenImageProperty.NewCollectionSpecimenImagePropertyRow();
                        R.CollectionSpecimenID = this.SpecimenID;
                        R.URI = CurrentUri;
                        R.Property = Property;
                        this.dataSetCollectionSpecimen.CollectionSpecimenImageProperty.Rows.Add(R);
                        this.toolStripButtonImagePropertySave.Visible = true;
                    }
                }
            }
            catch (System.Exception ex) { }
        }

        private bool _ImageMarkingActive = false;

        public bool ImageMarkingActive
        {
            get { return _ImageMarkingActive; }
            set 
            {
                if (value)
                    this.toolStripButtonImagePropertyGeometry.BackColor = System.Drawing.Color.Red;
                else
                    this.toolStripButtonImagePropertyGeometry.BackColor = System.Drawing.SystemColors.Control;
                _ImageMarkingActive = value; 
            }
        }

        private void toolStripButtonImagePropertyGeometry_Click(object sender, EventArgs e)
        {
            this.ImageMarkingActive = !this._ImageMarkingActive;

            this.userControlImageSpecimenImage.setMarkingArea(this._ImageMarkingActive);
            if (this._ImageMarkingActive)
            {
                if (this.collectionSpecimenImagePropertyBindingSource.Current == null 
                    || this.dataSetCollectionSpecimen.CollectionSpecimenImageProperty.Rows.Count == 0
                    || this.listBoxImageProperty.SelectedIndex == -1)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a property");
                    return;
                }
                this.userControlImageSpecimenImage.setMarkingTable("CollectionSpecimenImageProperty");
                this.userControlImageSpecimenImage.setMarkingGeometryColumn("ImageArea");
                this.userControlImageSpecimenImage.setMarkingDisplayColumn("Property");
                if (this.collectionSpecimenImagePropertyBindingSource.Current != null)
                {
                    System.Data.DataRowView RI = (System.Data.DataRowView)this.collectionSpecimenImagePropertyBindingSource.Current;
                    this.userControlImageSpecimenImage.setMarkingWhereClause(" WHERE CollectionSpecimenID = " + this.ID.ToString() + " AND URI = '" + RI["URI"].ToString() + "' AND Property = '" + RI["Property"].ToString() + "'");
                }
                else
                    this.userControlImageSpecimenImage.setMarkingWhereClause(" WHERE 1 = 0");
                this.userControlImageSpecimenImage.LoadImageForMarking();
            }
            else
            {
            }

            return;




            //System.Windows.Forms.MessageBox.Show("Available in upcoming version");

            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenImagePropertyBindingSource.Current;
            string Property = R["Property"].ToString();
            string WhereClause = " WHERE CollectionSpecimenID = " + this.ID.ToString() + " AND URI = '" + this.userControlImageSpecimenImage.ImagePath + "' AND Property = '" + Property + "'";
            //string SQL = "DECLARE @Points table(X int, Y int); " +
            //"DECLARE @g geometry; " +
            //    "SET @g = (select ImageArea from [dbo].[CollectionSpecimenImageProperty] " +
            //    WhereClause + ");" +
            //    "INSERT INTO @Points(X, Y) " +
            //    "SELECT @g.STPointN(1).STX, @g.STPointN(1).STY WHERE NOT @g IS NULL; " +
            //    "INSERT INTO @Points(X, Y)  " +
            //    "SELECT @g.STPointN(2).STX, @g.STPointN(2).STY WHERE NOT @g IS NULL; " +
            //    "INSERT INTO @Points(X, Y)  " +
            //    "SELECT @g.STPointN(3).STX, @g.STPointN(3).STY WHERE NOT @g IS NULL; " +
            //    "INSERT INTO @Points(X, Y)  " +
            //    "SELECT @g.STPointN(4).STX, @g.STPointN(4).STY WHERE NOT @g IS NULL; " +
            //    "SELECT * from @Points";
            //System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            System.Data.DataTable dt = this.getImagePropertyArea();// new DataTable();
            //try
            //{
            //    ad.Fill(dt);
            //}
            //catch (System.Exception ex) { }
            System.Drawing.Rectangle Area = new Rectangle();
            if (dt.Rows.Count > 0)
            {
                Area.X = int.Parse(dt.Rows[0]["X"].ToString());
                Area.Y = int.Parse(dt.Rows[0]["Y"].ToString());
                Area.Width = int.Parse(dt.Rows[1]["X"].ToString()) - int.Parse(dt.Rows[0]["X"].ToString());
                Area.Height = int.Parse(dt.Rows[3]["Y"].ToString()) - int.Parse(dt.Rows[0]["Y"].ToString());
            }
            this.userControlImageSpecimenImage.MarkArea("CollectionSpecimenImageProperty", "ImageArea", WhereClause, Area, Property);
            //this.toolStripButtonImagePropertySave.Visible = true;
            return;
        }

        private void toolStripButtonImagePropertyDelete_Click(object sender, EventArgs e)
        {
            if (this.listBoxImageProperty.SelectedItem != null)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxImageProperty.SelectedItem;
                R.Delete();
            }
        }

        private void listBoxImageProperty_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                if (this.listBoxImageProperty.SelectedIndex == -1)
                {
                    if (this.userControlImageSpecimenImage.MarkingArea())
                    {
                        this.userControlImageSpecimenImage.setMarkingWhereClause(" WHERE 1 = 0");
                        this.userControlImageSpecimenImage.LoadGeometry();
                    }
                    this.toolStripImagePropertyFilter.Enabled = false;
                    this.toolStripButtonImagePropertyDelete.Enabled = false;
                    this.toolStripButtonImagePropertyGeometry.Enabled = false;
                }
                else
                {
                    this.toolStripImagePropertyFilter.Enabled = true;
                    this.toolStripButtonImagePropertyDelete.Enabled = true;
                    this.toolStripButtonImagePropertyGeometry.Enabled = true;

                    System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxImageProperty.SelectedItem;
                    string P = R["Property"].ToString();
                    string URI = R["URI"].ToString();
                    if (this.userControlImageSpecimenImage.MarkingArea())
                    {
                        this.userControlImageSpecimenImage.setMarkingWhereClause(" WHERE CollectionSpecimenID = " + this.ID.ToString() + " AND URI = '" + R["URI"].ToString() + "' AND Property = '" + R["Property"].ToString() + "'");
                        this.userControlImageSpecimenImage.LoadGeometry();
                        /// ##1
                    }
                    int i = 0;
                    foreach (System.Data.DataRow RP in this.dataSetCollectionSpecimen.CollectionSpecimenImageProperty.Rows)
                    {
                        if (RP["Property"].ToString() == R["Property"].ToString() &&
                            RP["URI"].ToString() == R["URI"].ToString())
                        {
                            this.collectionSpecimenImagePropertyBindingSource.Position = i;
                            break;
                        }
                        i++;
                    }
                }
                //this.toolStripDropDownButtonImagePropertyArea

                /*
                 * old version
                System.Drawing.Rectangle Area = new Rectangle();
                this.userControlImageSpecimenImage.MarkArea("", "", "", Area, "");
                //this.userControlImageSpecimenImage.MarkArea("", "", "", Area);

                if (this.listBoxImageProperty.SelectedIndex > -1)
                {
                    this.textBoxImagePropertyDescription.Enabled = true;
                    System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxImageProperty.SelectedItem;
                    string P = R["Property"].ToString();
                    string URI = R["URI"].ToString();
                    int Position = 0;
                    for (int i = 0; i < this.dataSetCollectionSpecimen.CollectionSpecimenImageProperty.Rows.Count; i++)
                    {
                        if (this.dataSetCollectionSpecimen.CollectionSpecimenImageProperty.Rows[i]["Property"].ToString() == P &&
                            this.dataSetCollectionSpecimen.CollectionSpecimenImageProperty.Rows[i]["URI"].ToString() == URI)
                            break;
                        Position++;
                    }
                    this.collectionSpecimenImagePropertyBindingSource.Position = Position;
                    System.Data.DataTable dt = this.getImagePropertyArea();// new DataTable();
                    if (dt.Rows.Count > 0)
                    {
                        this.toolStripButtonImagePropertyGeometry.BackColor = System.Drawing.Color.Red;
                    }
                    else
                        this.toolStripButtonImagePropertyGeometry.BackColor = System.Drawing.SystemColors.Control;
                    string Property = "";
                    System.Collections.Generic.Dictionary<string, System.Drawing.Rectangle> Areas = new Dictionary<string, Rectangle>();
                    switch (this._ImagePropertyAreaDisplayStyle)
                    {
                        case ImagePropertyAreaDisplayStyle.All:
                            foreach (System.Data.DataRow Rprop in this.dataSetCollectionSpecimen.CollectionSpecimenImageProperty.Rows)
                            {
                                if (Rprop["URI"].ToString() == URI)
                                {
                                    Property = Rprop["Property"].ToString();
                                    dt = this.getImagePropertyArea(Rprop);
                                    if (dt.Rows.Count > 0)
                                    {
                                        Area.X = int.Parse(dt.Rows[0]["X"].ToString());
                                        Area.Y = int.Parse(dt.Rows[0]["Y"].ToString());
                                        Area.Width = int.Parse(dt.Rows[1]["X"].ToString()) - int.Parse(dt.Rows[0]["X"].ToString());
                                        Area.Height = int.Parse(dt.Rows[3]["Y"].ToString()) - int.Parse(dt.Rows[0]["Y"].ToString());
                                        Areas.Add(Property, Area);
                                    }
                                }
                            }
                            this.userControlImageSpecimenImage.MarkAreas(Areas);
                            break;
                        case ImagePropertyAreaDisplayStyle.Show:
                            Property = R["Property"].ToString();
                            if (dt.Rows.Count > 0)
                            {
                                Area.X = int.Parse(dt.Rows[0]["X"].ToString());
                                Area.Y = int.Parse(dt.Rows[0]["Y"].ToString());
                                Area.Width = int.Parse(dt.Rows[1]["X"].ToString()) - int.Parse(dt.Rows[0]["X"].ToString());
                                Area.Height = int.Parse(dt.Rows[3]["Y"].ToString()) - int.Parse(dt.Rows[0]["Y"].ToString());
                            }
                            Areas.Add(Property, Area);
                            this.userControlImageSpecimenImage.MarkAreas(Areas);
                            break;
                        case ImagePropertyAreaDisplayStyle.Hide:
                            //this.userControlImageSpecimenImage.MarkAreas(Areas);
                            break;
                    }
                }
                else
                {
                    this.textBoxImagePropertyDescription.Enabled = false;
                }
                 * */
            }
            catch (System.Exception ex)
            {
            }
        }

        private System.Data.DataTable getImagePropertyArea()
        {
            System.Data.DataRowView RP = (System.Data.DataRowView)this.collectionSpecimenImagePropertyBindingSource.Current;
            System.Data.DataTable dt = this.getImagePropertyArea(RP.Row); 
            return dt;
        }

        private System.Data.DataTable getImagePropertyArea(System.Data.DataRow RP)
        {
            string Property = RP["Property"].ToString();
            string WhereClause = " WHERE CollectionSpecimenID = " + this.ID.ToString() + " AND URI = '" + this.userControlImageSpecimenImage.ImagePath + "' AND Property = '" + Property + "'";
            string SQL = "DECLARE @Points table(X int, Y int); " +
            "DECLARE @g geometry; " +
                "SET @g = (select ImageArea from [dbo].[CollectionSpecimenImageProperty] " +
                WhereClause + ");" +
                "INSERT INTO @Points(X, Y) " +
                "SELECT @g.STPointN(1).STX, @g.STPointN(1).STY WHERE NOT @g.STPointN(1) IS NULL; " +
                "INSERT INTO @Points(X, Y)  " +
                "SELECT @g.STPointN(2).STX, @g.STPointN(2).STY WHERE NOT @g.STPointN(2) IS NULL; " +
                "INSERT INTO @Points(X, Y)  " +
                "SELECT @g.STPointN(3).STX, @g.STPointN(3).STY WHERE NOT @g.STPointN(3) IS NULL; " +
                "INSERT INTO @Points(X, Y)  " +
                "SELECT @g.STPointN(4).STX, @g.STPointN(4).STY WHERE NOT @g.STPointN(4) IS NULL; " +
                "SELECT * from @Points";
            System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            System.Data.DataTable dt = new DataTable();
            try
            {
                ad.Fill(dt);
            }
            catch (System.Exception ex) { }
            return dt;
        }

        private void textBoxImagePropertyDescription_Leave(object sender, EventArgs e)
        {
            System.Data.DataRowView RImageProperty = (System.Data.DataRowView)this.collectionSpecimenImagePropertyBindingSource.Current;
            if (RImageProperty != null)
            {
                try
                {
                    RImageProperty.BeginEdit();
                    RImageProperty.EndEdit();
                }
                catch { }
            }
        }

        private void toolStripButtonImagePropertySave_Click(object sender, EventArgs e)
        {
            int Pos = this.listBoxSpecimenImage.SelectedIndex;// this.collectionSpecimenImagePropertyBindingSource.Position;
            System.Data.DataRowView RImageProperty = (System.Data.DataRowView)this.collectionSpecimenImagePropertyBindingSource.Current;
            if (RImageProperty != null)
            {
                try
                {
                    RImageProperty.BeginEdit();
                    RImageProperty.EndEdit();
                }
                catch { }
            }
            this.saveSpecimen(null, null);
            this.toolStripButtonImagePropertySave.Visible = false;
            //this.collectionSpecimenImagePropertyBindingSource.Position = Pos;
            this.listBoxSpecimenImage.SelectedIndex = Pos;
            this.toolStripTextBoxImagePropertyFilter.AutoCompleteCustomSource = null;
        }

        private void toolStripButtonImagePropertyFilter_Click(object sender, EventArgs e)
        {
            if (this.ImagePropertyFilter().Length == 0)
                System.Windows.Forms.MessageBox.Show("No filter defined");
            else
                this.RestrictImagesToPropertyFilter();
        }

        private void RestrictImagesToPropertyFilter()
        {
            System.Data.DataRowView RImage = (System.Data.DataRowView)this.collectionSpecimenImageBindingSource.Current;
            if (RImage != null)
            {
                try
                {
                    RImage.BeginEdit();
                    RImage.EndEdit();
                }
                catch { }
            }
            this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenImage", this.sqlDataAdapterSpecimenImage, this.collectionSpecimenImageBindingSource);

            this.listBoxSpecimenImage.Items.Clear();
            this.userControlImageSpecimenImage.ImagePath = "";
            this.dataSetCollectionSpecimen.CollectionSpecimenImage.Clear();
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
            string PropertyFilter = this.ImagePropertyFilter();
            if (PropertyFilter.Length > 0)
            {
                string WhereClause = " WHERE CollectionSpecimenID = " + SpecimenID.ToString() +
                    " AND CollectionSpecimenID IN (SELECT CollectionSpecimenID FROM CollectionSpecimenID_UserAvailable) " +
                    " AND URI IN (SELECT I.URI FROM CollectionSpecimenImage AS I " +
                    "INNER JOIN CollectionSpecimenImageProperty AS P ON I.CollectionSpecimenID = P.CollectionSpecimenID AND I.URI = P.URI " +
                    "WHERE (I.CollectionSpecimenID = " + this.ID.ToString() + ") AND (P.Property LIKE '" + PropertyFilter + "'))" ;
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterSpecimenImage, DiversityCollection.CollectionSpecimen.SqlSpecimenImage + WhereClause + "ORDER BY LogCreatedWhen DESC", this.dataSetCollectionSpecimen.CollectionSpecimenImage);
                this.FormFunctions.FillImageList(this.listBoxSpecimenImage, this.imageListSpecimenImages, this.imageListForm, this.dataSetCollectionSpecimen.CollectionSpecimenImage, "URI", this.userControlImageSpecimenImage);
                this.toolStripButtonImagesSpecimenShowAll.Visible = true;
            }
        }

        private string ImagePropertyFilter()
        {
            return this.toolStripTextBoxImagePropertyFilter.Text.Trim();
        }

        private enum ImagePropertyAreaDisplayStyle {All, Show, Hide };
        private ImagePropertyAreaDisplayStyle _ImagePropertyAreaDisplayStyle = ImagePropertyAreaDisplayStyle.Hide;

        private void toolStripMenuItemImagePropertyAreaShow_Click(object sender, EventArgs e)
        {
            this.toolStripDropDownButtonImagePropertyArea.ForeColor = System.Drawing.Color.Red;
            this.toolStripDropDownButtonImagePropertyArea.Text = "Show";
            this.toolStripDropDownButtonImagePropertyArea.ToolTipText = this.toolStripMenuItemImagePropertyAreaShow.ToolTipText;
            this._ImagePropertyAreaDisplayStyle = ImagePropertyAreaDisplayStyle.Show;
        }

        private void toolStripMenuItemImagePropertyAreaHide_Click(object sender, EventArgs e)
        {
            this.toolStripDropDownButtonImagePropertyArea.ForeColor = System.Drawing.Color.Black;
            this.toolStripDropDownButtonImagePropertyArea.Text = "Hide";
            this.toolStripDropDownButtonImagePropertyArea.ToolTipText = this.toolStripMenuItemImagePropertyAreaHide.ToolTipText;
            this._ImagePropertyAreaDisplayStyle = ImagePropertyAreaDisplayStyle.Hide;
        }

        private void toolStripMenuItemImagePropertyAreaAll_Click(object sender, EventArgs e)
        {
            this.toolStripDropDownButtonImagePropertyArea.ForeColor = System.Drawing.Color.Red;
            this.toolStripDropDownButtonImagePropertyArea.Text = "All";
            this.toolStripDropDownButtonImagePropertyArea.ToolTipText = this.toolStripMenuItemImagePropertyAreaAll.ToolTipText;
            this._ImagePropertyAreaDisplayStyle = ImagePropertyAreaDisplayStyle.All;
        }

        private void toolStripButtonImagePropertyFilterClear_Click(object sender, EventArgs e)
        {
            if (this.toolStripTextBoxImagePropertyFilter.Text.Length > 0)
                this.toolStripButtonImagesSpecimenShowAll_Click(null, null);
        }

        private void toolStripTextBoxImagePropertyFilter_Enter(object sender, EventArgs e)
        {
            if (this.toolStripTextBoxImagePropertyFilter.AutoCompleteCustomSource == null)
            {
                this.toolStripTextBoxImagePropertyFilter.AutoCompleteMode = AutoCompleteMode.SuggestAppend;
                this.toolStripTextBoxImagePropertyFilter.AutoCompleteSource = AutoCompleteSource.CustomSource;
                System.Windows.Forms.AutoCompleteStringCollection Source = new AutoCompleteStringCollection();
                foreach (System.Data.DataRow RP in this.dataSetCollectionSpecimen.CollectionSpecimenImageProperty.Rows)
                {
                    Source.Add(RP["Property"].ToString());
                }
                this.toolStripTextBoxImagePropertyFilter.AutoCompleteCustomSource = Source;
            }
        }

        #endregion

        #region Restriction of the displayed images

        private void toolStripButtonImagesSpecimenShowAll_Click(object sender, EventArgs e)
        {
            this.toolStripTextBoxImagePropertyFilter.Text = "";
            System.Data.DataRowView RImage = (System.Data.DataRowView)this.collectionSpecimenImageBindingSource.Current;
            if (RImage != null)
            {
                try
                {
                    RImage.BeginEdit();
                    RImage.EndEdit();
                }
                catch { }
            }
            this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenImage", this.sqlDataAdapterSpecimenImage, this.collectionSpecimenImageBindingSource);

            this.listBoxSpecimenImage.Items.Clear();
            this.userControlImageSpecimenImage.ImagePath = "";
            this.dataSetCollectionSpecimen.CollectionSpecimenImage.Clear();
            try
            {
                string WhereClause = " WHERE CollectionSpecimenID = " + SpecimenID.ToString() +
                    " AND CollectionSpecimenID IN (SELECT CollectionSpecimenID FROM CollectionSpecimenID_UserAvailable) ";
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterSpecimenImage, DiversityCollection.CollectionSpecimen.SqlSpecimenImage + WhereClause + "ORDER BY LogCreatedWhen DESC", this.dataSetCollectionSpecimen.CollectionSpecimenImage);
                this.FormFunctions.FillImageList(this.listBoxSpecimenImage, this.imageListSpecimenImages, this.imageListForm, this.dataSetCollectionSpecimen.CollectionSpecimenImage, "URI", this.userControlImageSpecimenImage);
                this.toolStripButtonImagesSpecimenShowAll.Visible = false;
                this.buttonRestrictImagesToCurrentUnit.BackColor = System.Drawing.SystemColors.ControlLightLight;
                this.buttonRestrictImagesToCurrrentPart.BackColor = System.Drawing.SystemColors.ControlLightLight;
            }
            catch { }
        }

        private void EnableRestrictImageToUnitButton(System.Data.DataRow R)
        {
            int UnitID;
            try
            {
                if (R.Table.Columns.Contains("IdentificationUnitID"))
                {
                    if (int.TryParse(R["IdentificationUnitID"].ToString(), out UnitID))
                    {
                        System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenImage.Select("IdentificationUnitID = " + UnitID.ToString());
                        if (rr.Length > 0)
                            this.buttonRestrictImagesToCurrentUnit.Enabled = true;
                        else this.buttonRestrictImagesToCurrentUnit.Enabled = false;
                    }
                }
                else this.buttonRestrictImagesToCurrentUnit.Enabled = false;
            }
            catch
            {
                this.buttonRestrictImagesToCurrentUnit.Enabled = false;
            }
        }

        private void buttonRestrictImagesToCurrrentPart_Click(object sender, EventArgs e)
        {
            // Reset the property filter
            this.toolStripTextBoxImagePropertyFilter.Text = "";

            System.Data.DataRowView RImage = (System.Data.DataRowView)this.collectionSpecimenImageBindingSource.Current;
            if (RImage != null)
            {
                try
                {
                    RImage.BeginEdit();
                    RImage.EndEdit();
                }
                catch { }
            }
            this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenImage", this.sqlDataAdapterSpecimenImage, this.collectionSpecimenImageBindingSource);

            this.listBoxSpecimenImage.Items.Clear();
            this.userControlImageSpecimenImage.ImagePath = "";
            this.dataSetCollectionSpecimen.CollectionSpecimenImage.Clear();
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
            int SpecimenPartID;
            if (int.TryParse(R["SpecimenPartID"].ToString(), out SpecimenPartID))
            {
                string WhereClause = " WHERE CollectionSpecimenID = " + SpecimenID.ToString() +
                    " AND CollectionSpecimenID IN (SELECT CollectionSpecimenID FROM CollectionSpecimenID_UserAvailable) " +
                    " AND SpecimenPartID = " + SpecimenPartID.ToString();
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterSpecimenImage, DiversityCollection.CollectionSpecimen.SqlSpecimenImage + WhereClause + "ORDER BY LogCreatedWhen DESC", this.dataSetCollectionSpecimen.CollectionSpecimenImage);
                this.FormFunctions.FillImageList(this.listBoxSpecimenImage, this.imageListSpecimenImages, this.imageListForm, this.dataSetCollectionSpecimen.CollectionSpecimenImage, "URI", this.userControlImageSpecimenImage);
                this.toolStripButtonImagesSpecimenShowAll.Visible = true;
                this.buttonRestrictImagesToCurrrentPart.BackColor = System.Drawing.Color.Red;
            }
        }

        private void EnableRestrictImageToPartButton(System.Data.DataRow R)
        {
            int SpecimenPartID;
            try
            {
                this.buttonRestrictImagesToCurrrentPart.FlatAppearance.BorderSize = 0;
                if (int.TryParse(R["SpecimenPartID"].ToString(), out SpecimenPartID))
                {
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenImage.Select("SpecimenPartID = " + SpecimenPartID.ToString());
                    if (rr.Length > 0)
                        this.buttonRestrictImagesToCurrrentPart.Enabled = true;
                    else this.buttonRestrictImagesToCurrrentPart.Enabled = false;
                }
            }
            catch
            {
                this.buttonRestrictImagesToCurrrentPart.Enabled = false;
            }
        }

        private void buttonRestrictImagesToCurrentUnit_Click(object sender, EventArgs e)
        {
            // Reset the property filter
            this.toolStripTextBoxImagePropertyFilter.Text = "";

            System.Data.DataRowView RImage = (System.Data.DataRowView)this.collectionSpecimenImageBindingSource.Current;
            if (RImage != null)
            {
                try
                {
                    RImage.BeginEdit();
                    RImage.EndEdit();
                }
                catch { }
            }
            this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenImage", this.sqlDataAdapterSpecimenImage, this.collectionSpecimenImageBindingSource);

            this.listBoxSpecimenImage.Items.Clear();
            this.userControlImageSpecimenImage.ImagePath = "";
            this.dataSetCollectionSpecimen.CollectionSpecimenImage.Clear();
            System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
            int UnitID;
            if (int.TryParse(R["IdentificationUnitID"].ToString(), out UnitID))
            {
                string WhereClause = " WHERE CollectionSpecimenID = " + SpecimenID.ToString() +
                    " AND CollectionSpecimenID IN (SELECT CollectionSpecimenID FROM CollectionSpecimenID_UserAvailable) " +
                    " AND IdentificationUnitID = " + UnitID.ToString();
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterSpecimenImage, DiversityCollection.CollectionSpecimen.SqlSpecimenImage + WhereClause + "ORDER BY LogCreatedWhen DESC", this.dataSetCollectionSpecimen.CollectionSpecimenImage);
                this.FormFunctions.FillImageList(this.listBoxSpecimenImage, this.imageListSpecimenImages, this.imageListForm, this.dataSetCollectionSpecimen.CollectionSpecimenImage, "URI", this.userControlImageSpecimenImage);
                this.toolStripButtonImagesSpecimenShowAll.Visible = true;
                this.buttonRestrictImagesToCurrentUnit.BackColor = System.Drawing.Color.Red;
            }
        }

        #endregion

        #endregion

        #region Exsiccate

        private void setExsiccateIdentificationSource(int IdentificationUnitID)
        {
            System.Data.DataRow[] rrU = this.dataSetCollectionSpecimen.IdentificationUnit.Select("IdentificationUnitID = " + IdentificationUnitID.ToString());
            this.comboBoxExsiccataIdentification.DataBindings.Clear();
            this.comboBoxExsiccataIdentification.DataSource = null;
            System.Data.DataTable dtIdent = new System.Data.DataTable("Identification");
            System.Data.DataColumn C1 = new System.Data.DataColumn("IdentificationSequence", System.Type.GetType("System.Int16"));
            System.Data.DataColumn C2 = new System.Data.DataColumn("TaxonomicName", System.Type.GetType("System.String"));
            dtIdent.Columns.Add(C1);
            dtIdent.Columns.Add(C2);
            try
            {
                if (rrU.Length > 0)
                {
                    System.Data.DataRow rU = rrU[0];
                    System.Object[] rowVals = new object[2];
                    rowVals[0] = System.DBNull.Value;
                    rowVals[1] = System.DBNull.Value;
                    dtIdent.Rows.Add(rowVals);
                    System.Data.DataRow[] rr2 = this.dataSetCollectionSpecimen.Identification.Select("IdentificationUnitID = " + IdentificationUnitID.ToString());
                    foreach (System.Data.DataRow r2 in rr2)
                    {
                        System.Object[] rowVals2 = new object[2];
                        rowVals2[0] = r2["IdentificationSequence"];
                        rowVals2[1] = r2["TaxonomicName"];
                        dtIdent.Rows.Add(rowVals2);
                    }
                    this.comboBoxExsiccataIdentification.DataSource = dtIdent;
                    this.comboBoxExsiccataIdentification.DisplayMember = "TaxonomicName";
                    this.comboBoxExsiccataIdentification.ValueMember = "IdentificationSequence";
                    this.comboBoxExsiccataIdentification.DataBindings.Add(new System.Windows.Forms.Binding("SelectedValue", this.dataSetCollectionSpecimen, "IdentificationUnit.ExsiccataIdentification"));
                    if (rU["ExsiccataIdentification"].Equals(System.DBNull.Value)) this.comboBoxExsiccataIdentification.SelectedIndex = 0;
                    else
                    {
                        int EI = int.Parse(rU["ExsiccataIdentification"].ToString());
                        for (int i = 1; i < this.comboBoxExsiccataIdentification.Items.Count; i++)
                        {
                            System.Data.DataRowView RV = (System.Data.DataRowView)this.comboBoxExsiccataIdentification.Items[i];
                            if (RV[0].ToString() == EI.ToString())
                            {
                                this.comboBoxExsiccataIdentification.SelectedIndex = i;
                                break;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void comboBoxExsiccataIdentification_SelectionChangeCommitted(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxExsiccataIdentification.SelectedItem;
            System.Data.DataRowView I = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
            I.BeginEdit();
            I["ExsiccataIdentification"] = R[0];
            I.EndEdit();
            this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "IdentificationUnit", this.sqlDataAdapterUnit, this.BindingContext);
        }

        //private void comboBoxExsiccataIdentification_Validating(object sender, CancelEventArgs e)
        //{
        //    if (this.comboBoxExsiccataIdentification.SelectedIndex == -1)
        //    {
        //        this.comboBoxExsiccataIdentification.SelectedIndex = 0;
        //        System.Windows.Forms.MessageBox.Show("Please select an identification from the list");
        //    }
        //}

        private void textBoxExsiccataNumber_TextChanged(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
            if (R != null)
            {
                R.BeginEdit();
                R.EndEdit();
            }
        }

        #endregion

        #region Event

        private void setEvent()
        {
            this.setCollectionDateWithholding();
            if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].Equals(System.DBNull.Value))
            {
                //this.splitContainerImages.Panel1.Enabled = true;
                try
                {
                    int EventID = int.Parse(this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].ToString());
                    string WhereClause = " WHERE CollectionEventID = " + EventID.ToString();


                    this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterEvent, DiversityCollection.CollectionSpecimen.SqlEvent + WhereClause, this.dataSetCollectionSpecimen.CollectionEvent);
                    this.setCollectionDateWithholding();
                    if (this._ViewMode != ViewMode.Gridmode)
                    {
                        if (this.HasOldVersionOfImageTables)
                            this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterEventImage, DiversityCollection.CollectionSpecimen.SqlEventImageOldVersion + WhereClause, this.dataSetCollectionSpecimen.CollectionEventImage);
                        else
                            this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterEventImage, DiversityCollection.CollectionSpecimen.SqlEventImage + WhereClause, this.dataSetCollectionSpecimen.CollectionEventImage);
                    }
                    this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterLocalisation, DiversityCollection.CollectionSpecimen.SqlEventLocalisation + WhereClause, this.dataSetCollectionSpecimen.CollectionEventLocalisation);
                    this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterProperty, DiversityCollection.CollectionSpecimen.SqlEventProperty + WhereClause, this.dataSetCollectionSpecimen.CollectionEventProperty);
                    this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterEventRegulation, DiversityCollection.CollectionSpecimen.SqlEventRegulation + WhereClause, this.dataSetCollectionSpecimen.CollectionEventRegulation);

                    // METHOD
                    this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterCollectionEventMethod, DiversityCollection.CollectionSpecimen.SqlCollectionEventMethod + WhereClause /*+ " ORDER BY E.MethodID"*/, this.dataSetCollectionSpecimen.CollectionEventMethod);
                    try
                    {
                        string SQL = "SELECT E.CollectionEventID, E.MethodID, M.DisplayText + ' ' + E.MethodMarker AS DisplayText " +
                            "FROM CollectionEventMethod E, Method M  WHERE E.CollectionEventID = " + EventID.ToString() + " AND E.MethodID = M.MethodID";
                        System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                        ad.SelectCommand.CommandText = SQL;
                        ad.Fill(this.dataSetCollectionSpecimen.CollectionEventMethodList);
                    }
                    catch (System.Exception ex) { }

                    // METHOD PARAMETER
                    this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterCollectionEventMethodParameter, DiversityCollection.CollectionSpecimen.SqlCollectionEventMethodParameter + WhereClause /*+ " ORDER BY E.MethodID, ParameterID"*/, this.dataSetCollectionSpecimen.CollectionEventParameterValue);
                    try
                    {
                        string SQL = "SELECT E.CollectionEventID, E.MethodID, E.ParameterID, P.DisplayText, E.Value, E.MethodMarker " +
                            "FROM CollectionEventParameterValue E, Parameter P WHERE E.CollectionEventID = " + EventID.ToString() + " AND E.MethodID = P.MethodID AND E.ParameterID = P.ParameterID";
                        System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                        ad.SelectCommand.CommandText = SQL;
                        ad.Fill(this.dataSetCollectionSpecimen.CollectionEventParameterValueList);
                    }
                    catch (System.Exception ex) { }

                    this.listBoxEventMethodParameter.DataSource = this.dvCollectionEventMethodParameter;
                    this.listBoxEventMethodParameter.DisplayMember = "DisplayText";
                    this.listBoxEventMethodParameter.ValueMember = "ParameterID";

                    try
                    {
                        string SQL = "SELECT CollectionEventID, LocalisationSystemID, Geography.ToString() AS GeographyAsString, Geography.EnvelopeCenter().ToString() AS GeographyEnvelopeCenter " +
                            "FROM CollectionEventLocalisation " + WhereClause + " -- AND NOT Geography IS NULL ";
                        System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                        ad.SelectCommand.CommandText = SQL;
                        ad.Fill(this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo);
                    }
                    catch { }

                    if (this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Rows.Count > 0)
                    {
                    }
                    else
                    {
                        this.textBoxGeography.Text = "";
                        this.toolTip.SetToolTip(this.textBoxGeography, "");
                    }

                    #region Alt
                    //this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterGeography, DiversityCollection.CollectionSpecimen.SqlGeography + WhereClause, this.dataSetCollectionSpecimen.CollectionEventLocalisation);
                    //this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterGeographyList, DiversityCollection.CollectionSpecimen.SqlGeographyList + " AND CollectionEventID = " + EventID.ToString(), this.dataSetCollectionSpecimen.CollectionGeographyList);
                    //this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterHabitat, DiversityCollection.CollectionSpecimen.SqlHabitat + WhereClause, this.dataSetCollectionSpecimen.CollectionEventProperty);
                    #endregion

                    this.listBoxEventImages.Items.Clear();
                    this.FormFunctions.FillImageList(this.listBoxEventImages, this.imageListEventImages, this.imageListForm, this.dataSetCollectionSpecimen.CollectionEventImage, "URI", this.userControlImageEventImage);
                    if (this.dataSetCollectionSpecimen.CollectionEventImage.Rows.Count == 0)
                        this.setEventImageControlsEnabled(false);
                    else
                        this.setEventImageControlsEnabled(true);

                    if (!this.ShowImagesEvent && this.dataSetCollectionSpecimen.CollectionEventImage.Rows.Count > 0)
                        this.buttonHeaderShowEventImage.BackColor = System.Drawing.Color.Yellow;
                    else if (!this.ShowImagesEvent && this.dataSetCollectionSpecimen.CollectionEventImage.Rows.Count == 0)
                        this.buttonHeaderShowEventImage.BackColor = System.Drawing.SystemColors.Control;

                    if (this._ViewMode != ViewMode.Gridmode)
                    {
                        this.fillEventSeries();
                        string SamplingPlotDisplayMode = this.toolStripDropDownButtonOverviewHierarchyShowPlot.Tag.ToString();
                        if (SamplingPlotDisplayMode != "None")
                            this.fillSamplingPlots();
                    }

                    // marking Events with many specimen
                    this.groupBoxEvent.BackColor = System.Drawing.SystemColors.Control;
                    this.groupBoxEvent.Text = "Collection event";
                    if (this.NumberOfSpecimenInEvent() > 1)
                    {
                        this.groupBoxEvent.BackColor = System.Drawing.Color.Wheat;
                        this.groupBoxEvent.Text = "Collection event.   Number of specimen:   " + this.NumberOfSpecimenInEvent().ToString() + " ";
                    }
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
            else
            {
                //this.splitContainerImages.Panel1.Enabled = false;
            }
        }

        /// <summary>
        /// Number of specimen linked to the current CollectionEvent
        /// </summary>
        /// <returns>Specimen count</returns>
        private int NumberOfSpecimenInEvent()
        {
            int SpecimenInEvent = 1;
            string SqlCount = "SELECT COUNT(*) FROM CollectionSpecimen WHERE CollectionEventID = " + EventID.ToString();
            int.TryParse(DiversityWorkbench.FormFunctions.SqlExecuteScalar(SqlCount), out SpecimenInEvent);
            return SpecimenInEvent;
        }

        private void buttonEventCreation_Click(object sender, EventArgs e)
        {
            this.createEvent();
        }

        private void createEvent()
        {
            try
            {
                string SQL = "INSERT INTO CollectionEvent (LocalityDescription)VALUES (NULL) (SELECT SCOPE_IDENTITY() AS [SCOPE_IDENTITY])";
                System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                System.Data.SqlClient.SqlCommand cmd = new System.Data.SqlClient.SqlCommand(SQL, con);
                con.Open();
                int EventID = System.Int32.Parse(cmd.ExecuteScalar().ToString());
                con.Close();
                con.Dispose();
                this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"] = EventID;
                this.setEvent();
                this.setEventControls();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonEventAssignment_Click(object sender, EventArgs e)
        {
            try
            {
                //DiversityCollection.CollectionEvent E = new CollectionEvent(this.ServerConnection);
                //DiversityWorkbench.FormRemoteQuery f = new DiversityWorkbench.FormRemoteQuery(E);
                DiversityCollection.FormCollectionEvent f = new FormCollectionEvent();
                f.ShowDialog();
                if (f.DialogResult == System.Windows.Forms.DialogResult.OK && f.ID != null)
                {
                    this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"] = int.Parse(f.ID.ToString());
                    this.updateSpecimen();
                    this.setEvent();
                    this.buildOverviewHierarchyUnits();
                    //this.setEventControls();
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setEventControls()
        {
            //try
            //{
            //    if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count > 0
            //&& !this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].Equals(System.DBNull.Value))
            //    {
            //        //this.tabControlEvent.Visible = true;
            //        //this.panelEventCreation.Visible = false;
            //        if (this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows.Count > 0)
            //        {
            //            this.tableLayoutPanelGeography.Visible = true;
            //            //this.tableLayoutPanelGeographyLocation.Visible = true;
            //        }
            //        else
            //        {
            //            this.tableLayoutPanelGeography.Visible = false;
            //            //this.tableLayoutPanelGeographyLocation.Visible = false;
            //        }
            //        if (this.dataSetCollectionSpecimen.CollectionEventProperty.Rows.Count > 0)
            //            this.tableLayoutPanelEventProperty.Visible = true;
            //        else
            //            this.tableLayoutPanelEventProperty.Visible = false;
            //        //if (this.dataSetCollectionExpedition.CollectionSpecimen.Rows.Count > 1)
            //        //    this.toolStripButtonEventRemove.Enabled = true;
            //        //else
            //        //    this.toolStripButtonEventRemove.Enabled = false;
            //    }
            //    //else
            //    //{
            //    //    this.tabControlEvent.Visible = false;
            //    //    this.panelEventCreation.Visible = true;
            //    //    this.panelEventCreation.Dock = DockStyle.None;
            //    //    this.panelEventCreation.Top = 100;
            //    //    this.panelEventCreation.Height = 40;
            //    //}
            //}
            //catch (Exception ex)
            //{
            //    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            //}
        }

        #region Method

        private System.Data.DataView _dvCollectionEventMethodParameter;
        private System.Data.DataView dvCollectionEventMethodParameter
        {
            get
            {
                if (this._dvCollectionEventMethodParameter == null)
                    this._dvCollectionEventMethodParameter = new DataView(this.dataSetCollectionSpecimen.CollectionEventParameterValueList);
                int CollectionMethodID;
                if (this.collectionEventMethodBindingSource.Current != null)
                {
                    System.Data.DataRow RM = this.dataSetCollectionSpecimen.CollectionEventMethod.Rows[this.listBoxCollectionEventMethods.SelectedIndex];
                    if (int.TryParse(RM["MethodID"].ToString(), out CollectionMethodID))
                    {
                        string MethodMarker = RM["MethodMarker"].ToString();
                        this._dvCollectionEventMethodParameter.RowFilter = "MethodID = " + CollectionMethodID.ToString() + " AND MethodMarker = '" + MethodMarker + "'";
                        this._dvCollectionEventMethodParameter.Sort = "DisplayText";
                    }
                }
                return this._dvCollectionEventMethodParameter;
            }
        }

        private void toolStripButtonCollectionEventMethodAdd_Click(object sender, EventArgs e)
        {
            string SQL = "SELECT MethodID, DisplayText, ForCollectionEvent " +
                "FROM Method " +
                "WHERE ForCollectionEvent = 1 " ;
            SQL += "ORDER BY DisplayText";
            System.Data.DataTable dtMethods = new DataTable();
            System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            ad.Fill(dtMethods);
            if (dtMethods.Rows.Count == 0)
            {
                string Message = "No methods available";
                System.Windows.Forms.MessageBox.Show(Message);
                return;
            }
            DiversityWorkbench.FormGetStringFromList f = new DiversityWorkbench.FormGetStringFromList(dtMethods, "DisplayText", "MethodID", "New method", "Please select the new method for the event");
            f.ShowDialog();
            if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
            {
                int EventID;
                if (int.TryParse(this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionEventID"].ToString(), out EventID))
                {
                    try
                    {
                        string MethodMarker = "0";
                        System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.CollectionEventMethod.Select("MethodID = " + f.SelectedValue, "MethodMarker DESC");
                        if (RR.Length > 0)
                            MethodMarker = RR[0]["MethodMarker"].ToString();
                        int iMethodMarker;
                        if (int.TryParse(MethodMarker, out iMethodMarker))
                            MethodMarker = (iMethodMarker + 1).ToString();
                        System.Data.DataRow[] RRtest = this.dataSetCollectionSpecimen.CollectionEventMethod.Select("MethodID = " + f.SelectedValue + "AND MethodMarker = '" + MethodMarker + "'", "");
                        int i = RRtest.Length;
                        while (i > 0)
                        {
                            DiversityWorkbench.FormGetString fMarker = new DiversityWorkbench.FormGetString("Method marker", "Please enter a new method marker. The marker " + MethodMarker + " is allready present", "");
                            fMarker.ShowDialog();
                            if (fMarker.DialogResult == System.Windows.Forms.DialogResult.Cancel)
                                return;
                            else if (fMarker.DialogResult == System.Windows.Forms.DialogResult.OK)
                            {
                                MethodMarker = fMarker.String;
                                System.Data.DataRow[] RRt = this.dataSetCollectionSpecimen.CollectionEventMethod.Select("MethodID = " + f.SelectedValue + "AND MethodMarker = '" + MethodMarker + "'", "");
                                i = RRt.Length;
                            }
                        }
                        
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventMethodRow RM = this.dataSetCollectionSpecimen.CollectionEventMethod.NewCollectionEventMethodRow();
                        RM.CollectionEventID = EventID;
                        RM.MethodID = int.Parse(f.SelectedValue);
                        RM.MethodMarker = MethodMarker;
                        this.dataSetCollectionSpecimen.CollectionEventMethod.Rows.Add(RM);
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventMethodListRow RML = this.dataSetCollectionSpecimen.CollectionEventMethodList.NewCollectionEventMethodListRow();
                        RML.CollectionEventID = EventID;
                        RML.MethodID = int.Parse(f.SelectedValue);
                        RML.DisplayText = f.SelectedString + " " + MethodMarker;
                        RML.MethodMarker = MethodMarker;
                        this.dataSetCollectionSpecimen.CollectionEventMethodList.Rows.Add(RML);
                        System.Data.DataTable dtPV = new DataTable();
                        SQL = "SELECT " + EventID.ToString() + ",  MethodID, ParameterID, DisplayText, DefaultValue " +
                            "FROM Parameter " +
                            "WHERE MethodID = " + RM.MethodID.ToString();
                        System.Data.SqlClient.SqlDataAdapter adPV = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                        adPV.Fill(dtPV);
                        foreach (System.Data.DataRow RP in dtPV.Rows)
                        {
                            DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventParameterValueRow RPV = this.dataSetCollectionSpecimen.CollectionEventParameterValue.NewCollectionEventParameterValueRow();
                            DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventParameterValueListRow RPVL = this.dataSetCollectionSpecimen.CollectionEventParameterValueList.NewCollectionEventParameterValueListRow();
                            RPV.CollectionEventID = EventID;
                            RPVL.CollectionEventID = EventID;
                            RPV.MethodID = int.Parse(f.SelectedValue);
                            RPVL.MethodID = int.Parse(f.SelectedValue);
                            RPV.MethodMarker = MethodMarker;
                            RPVL.MethodMarker = MethodMarker;
                            RPV.ParameterID = int.Parse(RP["ParameterID"].ToString());
                            RPVL.ParameterID = int.Parse(RP["ParameterID"].ToString());
                            RPV.Value = RP["DefaultValue"].ToString();
                            RPVL.Value = RP["DefaultValue"].ToString();
                            RPVL.DisplayText = RP["DisplayText"].ToString();
                            this.dataSetCollectionSpecimen.CollectionEventParameterValue.Rows.Add(RPV);
                            this.dataSetCollectionSpecimen.CollectionEventParameterValueList.Rows.Add(RPVL);
                        }
                    }
                    catch (Exception ex)
                    {
                        
                        //throw;
                    }
                }
            }
        }

        private void toolStripButtonCollectionEventMethodDelete_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxCollectionEventMethods.SelectedItem;// .listBoxAnalysisMethod.SelectedItem;
                string Restriction = "MethodID = " + R["MethodID"].ToString() +
                    " AND CollectionEventID = " + R["CollectionEventID"].ToString() +
                    " AND MethodMarker = '" + R["MethodMarker"].ToString() + "'";
                System.Data.DataRow[] rrP = this.dataSetCollectionSpecimen.CollectionEventParameterValue.Select(Restriction);// .IdentificationUnitAnalysisMethodParameter.Select(Restriction);
                System.Data.DataRow[] rrPL = this.dataSetCollectionSpecimen.CollectionEventParameterValueList.Select(Restriction);// .IdentificationUnitAnalysisMethodParameterList.Select(Restriction);
                for (int i = 0; i < rrP.Length; i++)
                    rrP[i].Delete();
                for (int i = 0; i < rrPL.Length; i++)
                    rrPL[i].Delete();

                this.collectionEventMethodBindingSource.RemoveCurrent();
                this.updateSpecimen();
                this.setSpecimen(this.SpecimenID);
            }
            catch (System.Exception ex) { }
        }

        private void listBoxEventMethodParameter_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (this.listBoxEventMethodParameter.SelectedItem != null)
            {
                System.Data.DataRowView RV = (System.Data.DataRowView)this.listBoxEventMethodParameter.SelectedItem;
                for (int i = 0; i < this.dataSetCollectionSpecimen.CollectionEventParameterValue.Rows.Count; i++)
                {
                    if (this.dataSetCollectionSpecimen.CollectionEventParameterValue.Rows[i].RowState != DataRowState.Deleted)// &&                         this.dataSetCollectionSpecimen.CollectionEventParameterValue.Rows[i].RowState != DataRowState.Added)
                    {
                        if (this.dataSetCollectionSpecimen.CollectionEventParameterValue.Rows[i]["ParameterID"].ToString() == RV["ParameterID"].ToString() &&
                            this.dataSetCollectionSpecimen.CollectionEventParameterValue.Rows[i]["MethodID"].ToString() == RV["MethodID"].ToString() &&
                            this.dataSetCollectionSpecimen.CollectionEventParameterValue.Rows[i]["MethodMarker"].ToString() == RV["MethodMarker"].ToString())
                        {
                            this.collectionEventParameterValueBindingSource.Position = i;
                            break;
                        }
                    }
                    else
                    {
                    }
                }

                if (this.collectionEventParameterValueBindingSource.Current != null)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventParameterValueBindingSource.Current;
                    string SQL = "SELECT Value, DisplayText " +
                        "FROM ParameterValue_Enum " +
                        "WHERE (MethodID = " + R["MethodID"].ToString() + ") AND (ParameterID = " + R["ParameterID"].ToString() + ") ORDER BY DisplayText";
                    System.Data.DataTable dt = new DataTable();
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(dt);
                    if (dt.Rows.Count > 0)
                    {
                        this.textBoxEventMethodParameter.Visible = false;
                        this.comboBoxEventMethodParameter.Visible = true;
                        this.comboBoxEventMethodParameter.DataSource = dt;
                        this.comboBoxEventMethodParameter.DisplayMember = "DisplayText";
                        this.comboBoxEventMethodParameter.ValueMember = "Value";
                        for (int i = 0; i < dt.Rows.Count; i++)
                        {
                            if (R["Value"].ToString() == dt.Rows[i]["Value"].ToString())
                            {
                                this.comboBoxEventMethodParameter.SelectedIndex = i;
                                break;
                            }
                        }
                    }
                    else
                    {
                        this.comboBoxEventMethodParameter.Visible = false;
                        this.textBoxEventMethodParameter.Visible = true;
                    }
                }
                else
                {
                    this.textBoxEventMethodParameter.Visible = false;
                    this.comboBoxEventMethodParameter.Visible = false;
                }
            }
        }

        private void listBoxCollectionEventMethods_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.collectionEventMethodBindingSource.Position = this.listBoxCollectionEventMethods.SelectedIndex;
            this.listBoxEventMethodParameter.DataSource = this.dvCollectionEventMethodParameter;
            this.listBoxEventMethodParameter.DisplayMember = "DisplayText";
            this.listBoxEventMethodParameter.ValueMember = "ParameterID";
            this.listBoxEventMethodParameter_SelectedIndexChanged(null, null);
        }

        private void buttonEventMethodParameterAddMissing_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.listBoxCollectionEventMethods.SelectedItem != null)
                {
                    //System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxCollectionEventMethods.SelectedItem; //System.Data.DataRow R = this.dataSetCollectionSpecimen.CollectionEventMethod.Rows[this.collectionEventMethodBindingSource.Position];
                    System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventMethodBindingSource.Current;
                    string SQL = "SELECT MethodID, ParameterID, DisplayText, DefaultValue " +
                        "FROM Parameter AS P " +
                        "WHERE (MethodID = " + R["MethodID"].ToString() + ") AND (ParameterID NOT IN " +
                        "(SELECT ParameterID " +
                        "FROM CollectionEventParameterValue AS U " +
                        "WHERE (CollectionEventID = " + R["CollectionEventID"].ToString() + ") " +
                        "AND (MethodID = " + R["MethodID"].ToString() + ") " +
                        "AND (MethodMarker = '" + R["MethodMarker"].ToString() + "')))";
                    System.Data.DataTable dt = new DataTable();
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(dt);
                    if (dt.Rows.Count > 0)
                    {
                        System.Collections.Generic.Dictionary<string, bool> Dict = new Dictionary<string, bool>();
                        foreach (System.Data.DataRow RP in dt.Rows)
                            Dict.Add(RP["DisplayText"].ToString(), false);
                        DiversityWorkbench.Forms.FormGetMultiFromList f = new DiversityWorkbench.Forms.FormGetMultiFromList("Add parameter", "Select the parameters that should be added", Dict);
                        f.Width = 300;
                        f.Height = 80 + (24 * dt.Rows.Count);
                        f.ShowDialog();
                        if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                        {
                            int EventID = int.Parse(R["CollectionEventID"].ToString());
                            int MethodID = int.Parse(R["MethodID"].ToString());
                            string MethodMarker = R["MethodMarker"].ToString();
                            foreach (System.Collections.Generic.KeyValuePair<string, bool> KV in f.Items)
                            {
                                if (KV.Value)
                                {
                                    System.Data.DataRow[] rr = dt.Select("DisplayText = '" + KV.Key + "'");
                                    if (rr.Length > 0)
                                    {
                                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventParameterValueRow RPV = this.dataSetCollectionSpecimen.CollectionEventParameterValue.NewCollectionEventParameterValueRow();
                                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventParameterValueListRow RPVL = this.dataSetCollectionSpecimen.CollectionEventParameterValueList.NewCollectionEventParameterValueListRow();
                                        RPV.CollectionEventID = EventID;
                                        RPVL.CollectionEventID = EventID;
                                        RPV.MethodID = MethodID;
                                        RPVL.MethodID = MethodID;
                                        RPV.MethodMarker = MethodMarker;
                                        RPVL.MethodMarker = MethodMarker;
                                        RPV.ParameterID = int.Parse(rr[0]["ParameterID"].ToString());
                                        RPVL.ParameterID = int.Parse(rr[0]["ParameterID"].ToString());
                                        RPV.Value = rr[0]["DefaultValue"].ToString();
                                        RPVL.Value = rr[0]["DefaultValue"].ToString();
                                        RPVL.DisplayText = rr[0]["DisplayText"].ToString();
                                        this.dataSetCollectionSpecimen.CollectionEventParameterValue.Rows.Add(RPV);
                                        this.dataSetCollectionSpecimen.CollectionEventParameterValueList.Rows.Add(RPVL);
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        System.Windows.Forms.MessageBox.Show("No parameters missing");
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #endregion

        #region Sampling plots

        private void fillSamplingPlots()
        {
            try
            {
                this._CurrentPlotID = "";
                // Plots
                if (this._DataSetSamplingPlotList == null)
                    this._DataSetSamplingPlotList = new DiversityCollection.Datasets.DataSetSamplingPlotList();
                else
                    this._DataSetSamplingPlotList.Clear();

                System.Data.DataRow[] rLL = this.dataSetCollectionSpecimen.CollectionEventLocalisation.Select("LocalisationSystemID = 13 AND Location2 LIKE 'http:%'");
                if (rLL.Length > 0)
                {
                    int ID;
                    System.Uri U = new Uri(rLL[0]["Location2"].ToString());
                    DiversityWorkbench.SamplingPlot P = new DiversityWorkbench.SamplingPlot(DiversityWorkbench.Settings.ServerConnection, U);
                    if (int.TryParse(rLL[0]["Location2"].ToString().Substring(P.ServerConnection.BaseURL.Length), out ID))
                    {
                        this._CurrentPlotID = rLL[0]["Location2"].ToString();
                        System.Data.DataTable dtPlot = P.SamplingPlotHierarchy(ID);
                        foreach (System.Data.DataRow Rplot in dtPlot.Rows)
                        {
                            DiversityCollection.Datasets.DataSetSamplingPlotList.SamplingPlotRow R = this._DataSetSamplingPlotList.SamplingPlot.NewSamplingPlotRow();
                            R.PlotID = Rplot["PlotID"].ToString();
                            R.PartOfPlotID = Rplot["PartOfPlotID"].ToString();
                            R.DisplayText = Rplot["DisplayText"].ToString();
                            this._DataSetSamplingPlotList.SamplingPlot.Rows.Add(R);
                        }
                    }
                    this.fillSamplingPlotsEvents();
                }
            }
            catch (System.Exception ex) { }
        }

        private void fillSamplingPlotsEvents()
        {
            return;
            string SQL = "";
            if (this._DataSetSamplingPlotList.SamplingPlot.Rows.Count > 0)
            {
                foreach (System.Data.DataRow r in this._DataSetSamplingPlotList.SamplingPlot.Rows)
                {
                    if (SQL.Length > 0) SQL += ", ";
                    SQL += "'" + r["PlotID"].ToString() + "'";
                }
                SQL = DiversityCollection.CollectionSpecimen.SqlPlotEvent + " AND L.Location2 IN (" + SQL + ")";
            }
            else
                SQL = DiversityCollection.CollectionSpecimen.SqlPlotEvent + " AND (E.CollectionEventID = " + this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionEventID"].ToString() + ")";
            SQL += " ORDER BY CollectionDate";
            //if (SQL.EndsWith(", "))
            //    SQL = SQL.Substring(0, SQL.Length - 2) + ")
            //else
            //    SQL = SQL.Substring(0, SQL.Length - 1) + ") ORDER BY CollectionDate";
            this._DataSetSamplingPlotList.CollectionEventList.Clear();
            this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterPlotEvent, SQL, this._DataSetSamplingPlotList.CollectionEventList);
            this.fillSamplingPlotSpecimen();
        }

        private void fillSamplingPlotSpecimen()
        {
            string SQL = "";
            if (this._DataSetSamplingPlotList.CollectionEventList.Rows.Count > 0)
            {
                // Specimen
                SQL = DiversityCollection.CollectionSpecimen.SqlEventSeriesSpecimen + " WHERE CollectionEventID IN (";
                foreach (System.Data.DataRow r in this._DataSetSamplingPlotList.CollectionEventList.Rows)
                {
                    SQL += r["CollectionEventID"].ToString() + ", ";
                }
                SQL = SQL.Substring(0, SQL.Length - 2) + ") ORDER BY AccessionNumber";
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterPlotSpecimen, SQL, this._DataSetSamplingPlotList.CollectionSpecimenList);
                this.fillSamplingPlotUnits();
            }
       }

        private void fillSamplingPlotUnits()
        {
            // Unit
            string SQL = "";
            if (this._DataSetSamplingPlotList.CollectionSpecimenList.Rows.Count > 0)
            {
                SQL = DiversityCollection.CollectionSpecimen.SqlEventSeriesUnit + " WHERE CollectionSpecimenID IN (";
                foreach (System.Data.DataRow r in this._DataSetSamplingPlotList.CollectionSpecimenList.Rows)
                {
                    SQL += r["CollectionSpecimenID"].ToString() + ", ";
                }
                SQL = SQL.Substring(0, SQL.Length - 2) + ")";
                this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterPlotUnit, SQL, this._DataSetSamplingPlotList.IdentificationUnitList);
            }
        }

        #endregion

        #region EventSeries
        
        private void fillEventSeries()
        {
            try
            {
                this.listBoxCollectionEventSeriesImages.Items.Clear();
                if (this.dataSetCollectionSpecimen.CollectionEvent.Rows.Count > 0)
                {
                    string SQL = "";
                    this.dataSetCollectionEventSeries.Clear();
                    if (!this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"].Equals(System.DBNull.Value))
                    {
                        // EventSeries
                        int SeriesID = int.Parse(this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"].ToString());
                        // init the sql adapter
                        string WhereClause = " WHERE SeriesID = " + SeriesID.ToString() + " ORDER BY DateStart";
                        this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterEventSeries, DiversityCollection.CollectionSpecimen.SqlEventSeries + WhereClause, this.dataSetCollectionEventSeries.CollectionEventSeries);
                        // clear the table
                        this.dataSetCollectionEventSeries.CollectionEventSeries.Clear();
                        // fill tables
                        // EventSeries
                        SQL = "SELECT SeriesID, SeriesParentID, DateStart, DateEnd, SeriesCode, Description, Notes FROM  dbo.EventSeriesHierarchy(" + SeriesID.ToString() + ")";
                        System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                        ad.Fill(this.dataSetCollectionEventSeries.CollectionEventSeries);

                        this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterEventSeriesSuperiorList, DiversityCollection.CollectionSpecimen.SqlEventSeries + WhereClause, this.dataSetCollectionSpecimen.CollectionEventSeries);
                        this.dataSetCollectionSpecimen.CollectionEventSeries.Clear();

                        SQL = "SELECT SeriesID, SeriesParentID, DateStart, DateEnd, SeriesCode, Description, Notes FROM dbo.EventSeriesSuperiorList(" + SeriesID.ToString() + ")";
                        ad.SelectCommand.CommandText = SQL;
                        ad.Fill(this.dataSetCollectionSpecimen.CollectionEventSeries);

                        try
                        {
                            SQL = "SELECT SeriesID, Geography.ToString() AS GeographyAsString, Geography.EnvelopeCenter().ToString() AS GeographyEnvelopeCenter, " +
                                "SeriesCode, Description " +
                                "FROM CollectionEventSeries WHERE SeriesID = " + SeriesID.ToString() + " AND NOT Geography IS NULL";
                            ad.SelectCommand.CommandText = SQL;
                            //ad.Fill(this.dataSetCollectionEventSeries.CollectionEventSeriesGeography);
                            ad.Fill(this.dataSetCollectionSpecimen.CollectionEventSeriesGeo);
                            //if (this.dataSetCollectionEventSeries.CollectionEventSeriesGeography.Rows.Count > 0)
                            //    this.toolStripButtonGeoEventSeries.Visible = true;
                            //else
                            //    this.toolStripButtonGeoEventSeries.Visible = false;
                        }
                        catch (System.Exception ex)  { }
                    }
                    // Event
                    if (this.dataSetCollectionEventSeries.CollectionEventSeries.Rows.Count > 0)
                    {
                        SQL = DiversityCollection.CollectionSpecimen.SqlEventSeriesEvent + "WHERE SeriesID IN (";
                        foreach (System.Data.DataRow r in this.dataSetCollectionEventSeries.CollectionEventSeries.Rows)
                        {
                            SQL += r["SeriesID"].ToString() + ", ";
                        }
                    }
                    else
                        SQL = DiversityCollection.CollectionSpecimen.SqlEventSeriesEvent + " WHERE (CollectionEventID = " + this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionEventID"].ToString() + ")";
                    if (SQL.EndsWith(", "))
                        SQL = SQL.Substring(0, SQL.Length - 2) + ") ORDER BY CollectionDate";
                    else
                        SQL = SQL.Substring(0, SQL.Length - 1) + ") ORDER BY CollectionDate";
                    this.dataSetCollectionEventSeries.CollectionEventList.Clear();
                    this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterEventSeriesEvent, SQL, this.dataSetCollectionEventSeries.CollectionEventList);

                    if (this.dataSetCollectionEventSeries.CollectionEventList.Rows.Count > 0)
                    {
                        // Specimen
                        SQL = DiversityCollection.CollectionSpecimen.SqlEventSeriesSpecimen + " WHERE CollectionEventID IN (";
                        foreach (System.Data.DataRow r in this.dataSetCollectionEventSeries.CollectionEventList.Rows)
                        {
                            SQL += r["CollectionEventID"].ToString() + ", ";
                        }
                        SQL = SQL.Substring(0, SQL.Length - 2) + ") ORDER BY AccessionNumber";
                        this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterEventSeriesSpecimen, SQL, this.dataSetCollectionEventSeries.CollectionSpecimenList);
                        // Unit
                        if (this.dataSetCollectionEventSeries.CollectionSpecimenList.Rows.Count > 0)
                        {
                            SQL = DiversityCollection.CollectionSpecimen.SqlEventSeriesUnit + " WHERE CollectionSpecimenID IN (";
                            foreach (System.Data.DataRow r in this.dataSetCollectionEventSeries.CollectionSpecimenList.Rows)
                            {
                                SQL += r["CollectionSpecimenID"].ToString() + ", ";
                            }
                            SQL = SQL.Substring(0, SQL.Length - 2) + ")";
                            this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterEventSeriesUnit, SQL, this.dataSetCollectionEventSeries.IdentificationUnitList);
                        }
                        // Geography
                        SQL = DiversityCollection.CollectionSpecimen.SqlEventLocalisation + " WHERE CollectionEventID IN (";
                        foreach (System.Data.DataRow r in this.dataSetCollectionEventSeries.CollectionEventList.Rows)
                        {
                            SQL += r["CollectionEventID"].ToString() + ", ";
                        }
                        SQL = SQL.Substring(0, SQL.Length - 2) + ")";
                        this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterEventSeriesLocalisation, SQL, this.dataSetCollectionEventSeries.CollectionEventLocalisationList);

                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private System.Collections.Generic.List<string> GetEventSeriesGeography()
        {
            System.Collections.Generic.List<string> GeoData = new List<string>();
            if (this.dataSetCollectionEventSeries.CollectionEventSeriesGeography.Rows.Count > 0)
            {
            }
            return GeoData;
        }

        #region Toolstrip

        private void toolStripButtonEventSeriesNew_Click(object sender, EventArgs e)
        {
            int EventSeriesID = 0;
            string SQL = "INSERT INTO CollectionEventSeries (Description, EventSeriesParentID) " +
                "VALUES ('New EventSeries', ";

            try
            {
                if (this.dataSetCollectionEventSeries.CollectionEventList.Rows.Count > 0)
                {
                    if (this.treeViewOverviewHierarchy.SelectedNode == null)
                    {
                        System.Windows.Forms.MessageBox.Show("Please select an EventSeries / collection event group where the new EventSeries / collection event group should be inserted");
                        return;
                    }
                    try
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        EventSeriesID = int.Parse(r["SeriesID"].ToString());
                        SQL += EventSeriesID.ToString();
                    }
                    catch
                    {
                        System.Windows.Forms.MessageBox.Show("Please select an EventSeries / collection event group where the new EventSeries / collection event group should be inserted");
                        return;
                    }
                }
                else
                {
                    SQL += " NULL ";
                }
                SQL += ") SELECT SCOPE_IDENTITY() AS [SCOPE_IDENTITY]";
                System.Data.SqlClient.SqlConnection c = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                System.Data.SqlClient.SqlCommand cmd = new System.Data.SqlClient.SqlCommand(SQL, c);
                c.Open();
                int i = int.Parse(cmd.ExecuteScalar().ToString());
                c.Close();
                //object[] rowVals = new object[5];
                //rowVals[0] = i;
                //rowVals[4] = "New EventSeries";
                //this.dataSetCollectionEventSeries.CollectionEventList.Rows.Add(rowVals);
                if (this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"].Equals(System.DBNull.Value))
                {
                    this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"] = i;
                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionEvent", this.sqlDataAdapterEvent, this.BindingContext);
                }
                this.FormFunctions.updateTable(this.dataSetCollectionEventSeries, "CollectionEventSeries", this.sqlDataAdapterEventSeries, this.collectionEventSeriesBindingSource);
                this.FormFunctions.updateTable(this.dataSetCollectionEventSeries, "CollectionEventSeriesImage", this.sqlDataAdapterEventSeriesImage, this.collectionEventSeriesImageBindingSource);
                //this.FormFunctions.updateTable(this.dataSetCollectionEventSeries, "CollectionEventSeries", this.sqlDataAdapterEventSeries, this.BindingContext);
                this.fillEventSeries();

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonEventSeriesCopy_Click(object sender, EventArgs e)
        {
            System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
            string SQL = "";
            string Table = R.Table.TableName;
            System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            System.Data.SqlClient.SqlCommand cmd = new System.Data.SqlClient.SqlCommand(SQL, con);
            switch (Table)
            {
                case "CollectionEventSeries":
                    if (System.Windows.Forms.MessageBox.Show("Do you want to copy the EventSeries / collection event group\r\n" + R["Description"].ToString(), "Copy EventSeries", MessageBoxButtons.YesNo) != DialogResult.Yes)
                        return;
                    SQL = "INSERT INTO CollectionEventSeries (EventSeriesParentID, Description, EventSeriesCode, Notes) " +
                        "SELECT CASE WHEN EventSeriesParentID IS NULL THEN EventSeriesID ELSE EventSeriesParentID END EventSeriesParentID, Description, EventSeriesCode, Notes " +
                        "FROM CollectionEventSeries " +
                        "WHERE EventSeriesID = " + R["SeriesID"].ToString();
                    break;
                case "CollectionEvent":
                    if (R["SeriesID"].Equals(System.DBNull.Value))
                    {
                        System.Windows.Forms.MessageBox.Show("Collection events can only be copied if the are related to an EventSeries / collection event group");
                        return;
                    }
                    if (System.Windows.Forms.MessageBox.Show("Do you want to copy the collection event\r\n" + this.treeViewOverviewHierarchy.SelectedNode.Text, "Copy collection event", MessageBoxButtons.YesNo) != DialogResult.Yes)
                        return;
                    SQL = "execute dbo.procInsertCollectionEventCopy NULL , " + R["CollectionEventID"].ToString();
                    break;
                case "CollectionSpecimen":
                    string AccNr = "";
                    if (!R["AccessionNumber"].Equals(System.DBNull.Value)) AccNr = R["AccessionNumber"].ToString();
                    else AccNr = R["CollectionSpecimenID"].ToString();
                    if (System.Windows.Forms.MessageBox.Show("Do you want to copy " + AccNr, "Copy " + AccNr, MessageBoxButtons.YesNo) != DialogResult.Yes)
                        return;
                    if (AccNr.Length > 0) AccNr = "Copy of " + AccNr;
                    SQL = "execute dbo.procInsertCollectionSpecimenCopy NULL , " + R["CollectionSpecimenID"].ToString() + ", '" + AccNr + "'";
                    try
                    {
                        cmd.CommandText = SQL;
                        con.Open();
                        int ID = System.Convert.ToInt32(cmd.ExecuteScalar().ToString());
                        con.Close();
                        this.setSpecimen(ID);
                        return;
                    }
                    catch (Exception ex)
                    {
                        SQL = "";
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        return;
                    }
                    break;
                default:
                    System.Windows.Forms.MessageBox.Show("you can not copy this item");
                    break;
            }
            if (SQL.Length == 0) return;
            //con.Open();
            try
            {
                cmd.CommandText = SQL;
                if (con.State.ToString().ToUpper() != "OPEN") con.Open();
                cmd.ExecuteNonQuery();
                con.Close();
                this.setSpecimen(this.ID);
                //this.buildEventSeriesHierarchy();
                //this.markSpecimenInHierachy();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonEventSeriesDelete_Click(object sender, EventArgs e)
        {
            bool OK = true;
            if (this.treeViewOverviewHierarchy.SelectedNode == null) OK = false;
            if (this.treeViewOverviewHierarchy.SelectedNode.Nodes.Count > 0) OK = false;
            if (!OK)
            {
                System.Windows.Forms.MessageBox.Show("Please select an item that contains no childs");
                return;
            }
            string SQL = "";
            System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            System.Data.SqlClient.SqlCommand cmd = new System.Data.SqlClient.SqlCommand(SQL, con);
            //int EventSeriesID = 0;
            System.Data.DataRow rE = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
            try
            {
                string Table = rE.Table.TableName;
                switch (Table)
                {
                    case "CollectionEventSeries":
                        if (System.Windows.Forms.MessageBox.Show("Do you want to delete the collection event group or EventSeries\r\n" + rE["Description"].ToString(), "Delete EventSeries / collection event group", MessageBoxButtons.YesNo) != DialogResult.Yes)
                            return;
                        SQL = "DELETE FROM " + Table + " WHERE EventSeriesID = " + rE["SeriesID"].ToString();
                        break;
                    case "CollectionEvent":
                        if (System.Windows.Forms.MessageBox.Show("Do you want to delete the collection event\r\n" + this.treeViewOverviewHierarchy.SelectedNode.Text, "Delete collection event", MessageBoxButtons.YesNo) != DialogResult.Yes)
                            return;
                        SQL = "DELETE FROM " + Table + " WHERE CollectionEventID = " + rE["CollectionEventID"].ToString();
                        break;
                }
                con.Open();
                cmd.CommandText = SQL;
                cmd.ExecuteNonQuery();
                con.Close();
                this.setSpecimen(this.ID);
            }
            catch
            {
                System.Windows.Forms.MessageBox.Show("Please select an EventSeries / collection event group that contains no events");
            }
        }

        private void toolStripButtonEventSeriesAssign_Click(object sender, EventArgs e)
        {
            //DiversityCollection.CollectionEventSeries E = new CollectionEventSeries(;
            //DiversityWorkbench.FormRemoteQuery f = new DiversityWorkbench.FormRemoteQuery(E);
            DiversityCollection.FormCollectionEventSeries f = new FormCollectionEventSeries();
            f.ShowDialog();
            if (f.DialogResult == System.Windows.Forms.DialogResult.OK && f.ID != null)
            {
                try
                {
                    if (f.ID != null)
                        //int EventSeriesID = f.ID;
                        this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"] = (int)f.ID;// EventSeriesID;
                    else
                        this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"] = System.DBNull.Value;
                    this.fillEventSeries();

                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void toolStripButtonFindEventSeriesSpecimen_Click(object sender, EventArgs e)
        {
            if (this.treeViewOverviewHierarchy.SelectedNode != null)
            {
                System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                try
                {
                    int SpecimenID = int.Parse(r["CollectionSpecimenID"].ToString());
                    this.setSpecimen(SpecimenID);
                }
                catch (Exception)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a specimen");
                }
            }
        }

        private void toolStripButtonEventSeriesEventRemove_Click(object sender, EventArgs e)
        {
            int i = 0;
            string SQL = "SELECT COUNT(*) FROM CollectionSpecimen WHERE CollectionEventID = " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].ToString();
            System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            System.Data.SqlClient.SqlCommand cmd = new System.Data.SqlClient.SqlCommand(SQL, con);
            con.Open();
            cmd.CommandText = SQL;
            i = int.Parse(cmd.ExecuteScalar().ToString());
            con.Close();
            if (i > 1)
            {
                string Message = "Do you want to remove the current specimen\r\n";
                if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].Equals(System.DBNull.Value)
                    || this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString().Length == 0)
                    Message += "with the ID " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionSpecimenID"].ToString();
                else
                    Message += "with the accession number " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString();
                Message += "\r\nfrom the event\r\n";
                if (!this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionDate"].Equals(System.DBNull.Value)
                    && this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionDate"].ToString().Length > 0)
                    Message += this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionDate"].ToString() + "\r\n";
                if (!this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["LocalityDescription"].Equals(System.DBNull.Value)
                    && this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["LocalityDescription"].ToString().Length > 0)
                    Message += this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["LocalityDescription"].ToString() + "\r\n";
                if (!this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["HabitatDescription"].Equals(System.DBNull.Value)
                    && this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["HabitatDescription"].ToString().Length > 0)
                    Message += this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["HabitatDescription"].ToString() + "\r\n";
                if (System.Windows.Forms.MessageBox.Show(Message, "Remove from event", MessageBoxButtons.YesNo) == DialogResult.Yes)
                {
                    this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0].BeginEdit();
                    this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"] = System.DBNull.Value;
                    this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0].EndEdit();
                    this.setSpecimen(this.ID);
                }
            }
            else
                System.Windows.Forms.MessageBox.Show("You can not remove the only specimen from an event");
        }

        #endregion

        #endregion

        #region Event images

        private void toolStripButtonEventImageNew_Click(object sender, EventArgs e)
        {
            try
            {
                string AccessionNumber = "";
                if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].Equals(System.DBNull.Value))
                    AccessionNumber = this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString();
                int? ProjectID = null;
                if (this.userControlQueryList.ProjectIsSelected)
                    ProjectID = this.userControlQueryList.ProjectID;
                DiversityWorkbench.FormGetImage f = new DiversityWorkbench.FormGetImage(ProjectID, AccessionNumber);
                if (f.ShowDialog() == System.Windows.Forms.DialogResult.OK)
                {
                    if (f.ImagePath.Length > 0)
                    {
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventImageRow R = this.dataSetCollectionSpecimen.CollectionEventImage.NewCollectionEventImageRow();
                        int EventID = int.Parse(this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].ToString());
                        R.CollectionEventID = EventID;
                        R.URI = f.URIImage;
                        R.Description = f.Exif;
                        this.dataSetCollectionSpecimen.CollectionEventImage.Rows.Add(R);
                        this.FormFunctions.FillImageList(this.listBoxEventImages, this.imageListEventImages, this.imageListForm, this.dataSetCollectionSpecimen.CollectionEventImage, "URI", this.userControlImageEventImage);
                    }
                }

            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private void toolStripButtonEventImageDelete_Click(object sender, EventArgs e)
        {
            try
            {
                System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "CollectionEventImage"];
                int p = BMB.Position;
                System.Data.DataRow r = this.dataSetCollectionSpecimen.CollectionEventImage.Rows[p];
                if (r.RowState != System.Data.DataRowState.Deleted)
                {
                    this.dataSetCollectionSpecimen.CollectionEventImage.Rows[p].Delete();
                    this.FormFunctions.FillImageList(this.listBoxEventImages, this.imageListEventImages, this.imageListForm, this.dataSetCollectionSpecimen.CollectionEventImage, "URI", this.userControlImageEventImage);
                    if (this.listBoxEventImages.Items.Count > 0) this.listBoxEventImages.SelectedIndex = 0;
                    else
                    {
                        this.listBoxEventImages.SelectedIndex = -1;
                        this.userControlImageEventImage.ImagePath = "";
                    }
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private void listBoxEventImages_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                int i = this.listBoxEventImages.SelectedIndex;
                for (int p = 0; p <= i; p++)
                {
                    if (this.dataSetCollectionSpecimen.CollectionEventImage.Rows[p].RowState == System.Data.DataRowState.Deleted) i++;
                }
                if (this.dataSetCollectionSpecimen.CollectionEventImage.Rows.Count > i)
                {
                    //this.tableLayoutPanelEventImages.Enabled = true;
                    this.setEventImageControlsEnabled(true);
                    System.Data.DataRow r = this.dataSetCollectionSpecimen.CollectionEventImage.Rows[i];
                    this.userControlImageEventImage.ImagePath = r["URI"].ToString();
                    //System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "CollectionEventImage"];
                    //BMB.Position = i;
                    this.collectionEventImageBindingSource.Position = i;
                    string ImageType = "";
                    if (!r["ImageType"].Equals(System.DBNull.Value))
                        ImageType = r["ImageType"].ToString();

                    System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                    string Restriction = "(Code LIKE 'audio%' OR Code LIKE 'video%')";
                    if (this.userControlImageEventImage.MediumType == DiversityWorkbench.FormFunctions.Medium.Image)
                        Restriction = "NOT " + Restriction;
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxEventImageType, "CollEventImageType_Enum", con, true, true, true, Restriction);
                    if (ImageType.Length > 0)
                    {
                        try
                        {
                            System.Data.DataTable dt = (System.Data.DataTable)this.comboBoxEventImageType.DataSource;
                            int t = 0;
                            foreach (System.Data.DataRow R in dt.Rows)
                            {
                                if (R[0].ToString() == ImageType)
                                {
                                    this.comboBoxEventImageType.SelectedIndex = t;
                                    break;
                                }
                                t++;
                            }
                        }
                        catch (System.Exception ex)
                        {
                        }
                    }
                    string XML = r["Description"].ToString();
                    this.userControlXMLTreeEventImageExif.setToDisplayOnly();
                    this.userControlXMLTreeEventImageExif.XML = XML;
                }
                else
                    this.setEventImageControlsEnabled(false);
                    //this.tableLayoutPanelEventImages.Enabled = false;
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private void setEventImageControlsEnabled(bool IsEnabled)
        {
            this.comboBoxEventImageType.Enabled = IsEnabled;
            this.textBoxEventImageNotes.Enabled = IsEnabled;
            this.textBoxEventImageCopyrightStatement.Enabled = IsEnabled;
            this.textBoxEventImageInternalNotes.Enabled = IsEnabled;
            this.textBoxEventImageIPR.Enabled = IsEnabled;
            this.textBoxEventImageLicenseType.Enabled = IsEnabled;
            this.textBoxEventImageLicenseYear.Enabled = IsEnabled;
            this.textBoxEventImageTitle.Enabled = IsEnabled;
            this.comboBoxEventImageDataWithholdingReason.Enabled = IsEnabled;
            this.userControlModuleRelatedEntryEventImageCreator.Enabled = IsEnabled;
            this.userControlModuleRelatedEntryEventImageLicenseHolder.Enabled = IsEnabled;
            this.toolStripButtonEventImageDescription.Enabled = IsEnabled;
        }

        private void listBoxEventImages_MeasureItem(object sender, MeasureItemEventArgs e)
        {
            e.ItemHeight = this.imageListEventImages.ImageSize.Height;
            e.ItemWidth = this.imageListEventImages.ImageSize.Width;
        }

        private void listBoxEventImages_DrawItem(object sender, DrawItemEventArgs e)
        {
            try
            {
                if (e.Index > -1)
                    this.imageListEventImages.Draw(e.Graphics, e.Bounds.X, e.Bounds.Y, 50, 50, e.Index);
            }
            catch { }
        }

        private void toolStripButtonEventImageDescription_Click(object sender, EventArgs e)
        {
            this.setImageDescription(this.collectionEventImageBindingSource);
        }

        #endregion

        #region Event series images

        private void fillEventSeriesImages()
        {
            try
            {
                this.FormFunctions.updateTable(this.dataSetCollectionEventSeries, "CollectionEventSeriesImage", this.sqlDataAdapterEventSeriesImage, this.BindingContext);
                this.listBoxCollectionEventSeriesImages.Items.Clear();
                this.dataSetCollectionEventSeries.CollectionEventSeriesImage.Rows.Clear();
                // Images

                if (this.dataSetCollectionEventSeries.CollectionEventSeries.Rows.Count > 0)
                {
                    if (this.SeriesID != null)
                    {
                        string SQL = DiversityCollection.CollectionSpecimen.SqlEventSeriesImage + " WHERE SeriesID = " + this.SeriesID.ToString();
                        if (this.HasOldVersionOfImageTables)
                            SQL = DiversityCollection.CollectionSpecimen.SqlEventSeriesImageOldVersion + " WHERE SeriesID = " + this.SeriesID.ToString();
                        this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterEventSeriesImage, SQL, this.dataSetCollectionEventSeries.CollectionEventSeriesImage);
                        this.FormFunctions.FillImageList(this.listBoxCollectionEventSeriesImages, this.imageListCollectionEventSeries, this.imageListForm, this.dataSetCollectionEventSeries.CollectionEventSeriesImage, "URI", this.userControlImageCollectionEventSeries);
                        if (this.dataSetCollectionEventSeries.CollectionEventSeriesImage.Rows.Count > 0)
                            this.setEventSeriesImageControlsEnabled(true);
                        else this.setEventSeriesImageControlsEnabled(false);
                    }
                }

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonCollectionEventSeriesImageNew_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.SeriesID == null) return;

                int? ProjectID = null;
                if (this.userControlQueryList.ProjectIsSelected)
                    ProjectID = this.userControlQueryList.ProjectID;
                string AccessionNumber = "";
                if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].Equals(System.DBNull.Value))
                    AccessionNumber = this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString();

                string RowGUID = System.Guid.NewGuid().ToString();
                DiversityWorkbench.FormGetImage f = new DiversityWorkbench.FormGetImage(ProjectID, AccessionNumber);
                if (f.ShowDialog() == System.Windows.Forms.DialogResult.OK)
                {
                    if (f.ImagePath.Length > 0)
                    {
                        DiversityCollection.Datasets.DataSetCollectionEventSeries.CollectionEventSeriesImageRow R = this.dataSetCollectionEventSeries.CollectionEventSeriesImage.NewCollectionEventSeriesImageRow();
                        R.SeriesID = (int)this.SeriesID;
                        R.URI = f.URIImage;
                        R.Description = f.Exif;
                        this.dataSetCollectionEventSeries.CollectionEventSeriesImage.Rows.Add(R);
                        this.FormFunctions.FillImageList(this.listBoxCollectionEventSeriesImages, this.imageListCollectionEventSeries, this.imageListForm, this.dataSetCollectionEventSeries.CollectionEventSeriesImage, "URI", this.userControlImageCollectionEventSeries);
                    }
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private void toolStripButtonCollectionEventSeriesImageDelete_Click(object sender, EventArgs e)
        {
            try
            {
                System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionEventSeries, "CollectionEventSeriesImage"];
                int p = BMB.Position;
                System.Data.DataRow r = this.dataSetCollectionEventSeries.CollectionEventSeriesImage.Rows[p];
                if (r.RowState != System.Data.DataRowState.Deleted)
                {
                    this.dataSetCollectionEventSeries.CollectionEventSeriesImage.Rows[p].Delete();
                    this.FormFunctions.FillImageList(this.listBoxCollectionEventSeriesImages, this.imageListCollectionEventSeries, this.imageListForm, this.dataSetCollectionEventSeries.CollectionEventSeriesImage, "URI", this.userControlImageCollectionEventSeries);
                    if (this.listBoxCollectionEventSeriesImages.Items.Count > 0) this.listBoxCollectionEventSeriesImages.SelectedIndex = 0;
                    else
                    {
                        this.listBoxCollectionEventSeriesImages.SelectedIndex = -1;
                        this.userControlImageCollectionEventSeries.ImagePath = "";
                    }
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private void listBoxCollectionEventSeriesImages_DrawItem(object sender, DrawItemEventArgs e)
        {
            try
            {
                if (e.Index > -1)
                    this.imageListCollectionEventSeries.Draw(e.Graphics, e.Bounds.X, e.Bounds.Y, 50, 50, e.Index);
            }
            catch { }
        }

        private void listBoxCollectionEventSeriesImages_MeasureItem(object sender, MeasureItemEventArgs e)
        {
            e.ItemHeight = this.imageListCollectionEventSeries.ImageSize.Height;
            e.ItemWidth = this.imageListCollectionEventSeries.ImageSize.Width;
        }

        private void listBoxCollectionEventSeriesImages_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                int i = this.listBoxCollectionEventSeriesImages.SelectedIndex;
                if (this.dataSetCollectionEventSeries.CollectionEventSeriesImage.Rows.Count == 0) return;
                for (int p = 0; p <= i; p++)
                {
                    if (this.dataSetCollectionEventSeries.CollectionEventSeriesImage.Rows[p].RowState == System.Data.DataRowState.Deleted) i++;
                }
                if (this.dataSetCollectionEventSeries.CollectionEventSeriesImage.Rows.Count > i)
                {
                    this.setEventSeriesImageControlsEnabled(true);
                    System.Data.DataRow r = this.dataSetCollectionEventSeries.CollectionEventSeriesImage.Rows[i];
                    this.userControlImageCollectionEventSeries.ImagePath = r["URI"].ToString();
                    //System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionEventSeries, "CollectionEventSeriesImage"];
                    //BMB.Position = i;
                    this.collectionEventSeriesImageBindingSource.Position = i;

                    System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                    string Restriction = "(Code LIKE 'audio%' OR Code LIKE 'video%')";
                    if (this.userControlImageCollectionEventSeries.MediumType == DiversityWorkbench.FormFunctions.Medium.Image)
                        Restriction = "NOT " + Restriction;
                    DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxCollectionEventSeriesImageType, "CollEventSeriesImageType_Enum", con, true, true, true, Restriction);
                }
                else
                    this.setEventSeriesImageControlsEnabled(false);
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }

        }

        private void setEventSeriesImageControlsEnabled(bool IsEnabled)
        {
            this.tableLayoutPanelEventSeriesImageIPR.Enabled = IsEnabled;
            this.tableLayoutPanelEventSeriesImageLicense.Enabled = IsEnabled;
            this.tableLayoutPanelEventSeriesImageType.Enabled = IsEnabled;
        }

        private void toolStripButtonCollectionEventSeriesImageDescription_Click(object sender, EventArgs e)
        {
            this.setImageDescription(this.collectionEventSeriesImageBindingSource);
        }

        #endregion

        #region Maps

        private void toolStripButtonEventSeriesMap_Click(object sender, EventArgs e)
        {
            this.splitContainerImagesGeography.Panel2Collapsed = true;
            this.splitContainerImagesGeography.Panel1Collapsed = false;
            string URL = "";
            string Long = "";
            string Lat = "";
            string Label = "";
            System.Collections.Generic.Dictionary<string, System.Collections.Generic.List<string>> LocationDict = new Dictionary<string, List<string>>();
            string Coordinates = "";
            try
            {
                if (this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows.Count > 0)
                {
                    for (int i = 0; i < this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows.Count; i++)
                    {
                        if (!this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLongitudeCache"].Equals(System.DBNull.Value)
                            && !this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLatitudeCache"].Equals(System.DBNull.Value))
                        {
                            if (this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLongitudeCache"].ToString() != "0"
                                && this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLatitudeCache"].ToString() != "0")
                            {
                                if (Long.Length > 0)
                                {
                                    Long += "|";
                                    Lat += "|";
                                    Label += "|";
                                }
                                double dLong = 0;
                                double dLat = 0;
                                if (
                                double.TryParse(this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLongitudeCache"].ToString().Replace(".", ","), out dLong)
                                &&
                                double.TryParse(this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLatitudeCache"].ToString().Replace(".", ","), out dLat)
                                    && dLong <= 180 && dLong >= -180 && dLat <= 180 && dLat >= -180)
                                {

                                    Long += this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLongitudeCache"].ToString().Replace(",", ".");
                                    Lat += this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLatitudeCache"].ToString().Replace(",", ".");
                                    System.Data.DataRow[] rr = this.dataSetCollectionEventSeries.CollectionEventList.Select("CollectionEventID = " + this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["CollectionEventID"].ToString());
                                    string Event = rr[0]["DisplayText"].ToString();
                                    Label += Event;
                                    //mit liste
                                    Coordinates = this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLongitudeCache"].ToString().Replace(",", ".") + "|"
                                        + this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLatitudeCache"].ToString().Replace(",", ".");
                                    if (LocationDict.ContainsKey(Coordinates))
                                    {
                                        if (Event.Length < 100 && LocationDict[Coordinates][2].Length < 100)
                                            LocationDict[Coordinates][2] += " / " + Event;
                                    }
                                    else
                                    {
                                        System.Collections.Generic.List<string> L = new List<string>();
                                        L.Add(this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLatitudeCache"].ToString().Replace(",", "."));
                                        L.Add(this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLongitudeCache"].ToString().Replace(",", "."));
                                        L.Add(Event);
                                        LocationDict.Add(Coordinates, L);
                                    }
                                    // ende mit liste
                                }
                                else
                                {
                                    string Message = "Wrong coordinates found: Lat.: "
                                        + this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLatitudeCache"].ToString()
                                        + " Long.: " 
                                        + this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLongitudeCache"].ToString();
                                    System.Windows.Forms.MessageBox.Show(Message);
                                }
                            }
                        }
                    }
                }
                // mit liste
                if (LocationDict.Count > 0)
                {
                    URL = "Lat=";
                    foreach (System.Collections.Generic.KeyValuePair<string, System.Collections.Generic.List<string>> KV in LocationDict)
                    {
                        URL += KV.Value[0] + "|";
                    }
                    URL += "&Lng=";
                    foreach (System.Collections.Generic.KeyValuePair<string, System.Collections.Generic.List<string>> KV in LocationDict)
                    {
                        URL += KV.Value[1] + "|";
                    }
                    URL += "&Label=";
                    foreach (System.Collections.Generic.KeyValuePair<string, System.Collections.Generic.List<string>> KV in LocationDict)
                    {
                        URL += KV.Value[2] + "|";
                    }
                    URL += "&Height=" + this.webBrowserEventMap.Height.ToString()
                    + "&Width=" + this.webBrowserEventMap.Width.ToString();
                }
                //if (Long.Length > 0 && Lat.Length > 0 && Label.Length > 0)
                //{
                //    URL = "Lat=" + Lat
                //        + "&Lng=" + Long
                //        + "&Label=" + Label
                //    + "&Height=" + this.webBrowserEventMap.Height.ToString()
                //    + "&Width=" + this.webBrowserEventMap.Width.ToString();
                //}
                this.openMapURL(URL);
                //if (URL.Length > 0)
                //{
                //    URL = System.Web.HttpUtility.UrlEncode(URL);
                //    URL = "http://www.snsb.info/GoogleMaps/" + URL;
                //    System.Uri URI = new Uri(URL);
                //    this.webBrowserEventMap.Url = URI;
                //}
                //else
                //    System.Windows.Forms.MessageBox.Show("Could not find coordinates to generate a map");

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonEventMap_Click(object sender, EventArgs e)
        {
            this.splitContainerImagesGeography.Panel2Collapsed = true;
            this.splitContainerImagesGeography.Panel1Collapsed = false;
            string URL = "";
            string Long = "";
            string Lat = "";
            string Label = "";
            try
            {
                if (this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows.Count > 0)
                {
                    for (int i = 0; i < this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows.Count; i++)
                    {
                        if (!this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows[i]["AverageLongitudeCache"].Equals(System.DBNull.Value)
                            && !this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows[i]["AverageLatitudeCache"].Equals(System.DBNull.Value))
                        {
                            double dLong = 0;
                            double dLat = 0;
                            if (
                            double.TryParse(this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLongitudeCache"].ToString().Replace(".", ","), out dLong)
                            &&
                            double.TryParse(this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLatitudeCache"].ToString().Replace(".", ","), out dLat)
                                && dLong <= 180 && dLong >= -180 && dLat <= 180 && dLat >= -180)
                            {
                                if (this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLongitudeCache"].ToString() != "0"
                                    && this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLatitudeCache"].ToString() != "0")
                                {
                                    if (Long.Length > 0)
                                    {
                                        Long += "|";
                                        Lat += "|";
                                        Label += "|";
                                    }
                                    Long += this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows[i]["AverageLongitudeCache"].ToString().Replace(",", ".");
                                    Lat += this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows[i]["AverageLatitudeCache"].ToString().Replace(",", ".");
                                    Label += DiversityCollection.LookupTable.LocalisationSystemName(int.Parse(this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows[i]["LocalisationSystemID"].ToString()));
                                }
                            }
                            else
                            {
                                string Message = "Wrong coordinates found: Lat.: "
                                    + this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLatitudeCache"].ToString()
                                    + " Long.: "
                                    + this.dataSetCollectionEventSeries.CollectionEventLocalisationList.Rows[i]["AverageLongitudeCache"].ToString();
                                System.Windows.Forms.MessageBox.Show(Message);
                            }
                        }
                    }
                }
                if (Long.Length > 0 && Lat.Length > 0 && Label.Length > 0)
                {
                    URL = "Lat=" + Lat
                        + "&Lng=" + Long
                        + "&Label=" + Label
                    + "&Height=" + this.webBrowserEventMap.Height.ToString()
                    + "&Width=" + this.webBrowserEventMap.Width.ToString();
                }
                this.openMapURL(URL);
                //if (URL.Length > 0)
                //{
                //    URL = "http://www.snsb.info/GoogleMaps/" + URL;
                //    System.Text.ASCIIEncoding ascii = new ASCIIEncoding();
                //    Byte[] encodedBytes = ascii.GetBytes(URL);
                //    URL = System.Web.HttpUtility.UrlEncode(encodedBytes);
                //    System.Uri URI = new Uri(URL);
                //    this.webBrowserEventMap.Url = URI;
                //}
                //else
                //    System.Windows.Forms.MessageBox.Show("Could not find coordinates to generate a map");

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void openMapURL(string URL)
        {
            if (URL.Length > 2000)
            {
                System.Windows.Forms.MessageBox.Show("Too many items, please reduce selection");
                return;
            }
            if (URL.Length > 0)
            {
                try
                {
                    // to change to ASCII encoding use this code:
                    //System.Text.ASCIIEncoding ascii = new ASCIIEncoding();
                    //Byte[] encodedBytes = ascii.GetBytes(URL);
                    //URL = System.Web.HttpUtility.UrlEncode(encodedBytes);
                    URL = System.Web.HttpUtility.UrlEncode(URL);
                    // following code seems not necessary
                    //URL = URL.Replace("?", "%20");
                    //URL = URL.Replace("+", "%20");

                    //URL = "http://www.snsb.info/GoogleMaps/DiversityCollection_MapEvent.cfm?" + URL;
                    URL = "http://www.snsb.info/GoogleMaps/DiversityWorkbench_GoogleMapsV3.html?" + URL;
                    System.Uri URI = new Uri(URL);
                    this.webBrowserEventMap.Url = URI;
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
            else
                System.Windows.Forms.MessageBox.Show("Could not find coordinates to generate a map");
        }

        private void toolStripButtonDistributionMap_Click(object sender, EventArgs e)
        {
            try
            {
                this.splitContainerImagesGeography.Panel2Collapsed = true;
                this.splitContainerImagesGeography.Panel1Collapsed = false;
                System.Collections.Generic.Dictionary<string, System.Collections.Generic.List<System.Collections.Generic.List<string>>> Coordinates = new Dictionary<string, List<List<string>>>();
                string URL = "";
                string Lat = "";
                string Long = "";
                string Label = "";
                string Key = "";
                if (this.userControlQueryList.listBoxQueryResult.Items.Count > 0)
                {
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter("", DiversityWorkbench.Settings.ConnectionString);
                    System.Data.DataTable dt = new DataTable();
                    for (int i = 0; i < this.userControlQueryList.listBoxQueryResult.Items.Count; i++)
                    {
                        dt.Clear();
                        System.Data.DataRowView RV = (System.Data.DataRowView)this.userControlQueryList.listBoxQueryResult.Items[i];
                        int SpecimenID = 0;
                        if (int.TryParse(RV[0].ToString(), out SpecimenID))
                        {
                            ad.SelectCommand.CommandText = "SELECT CollectionSpecimenID, Latitude, Longitude, LocationAccuracy, DistanceToLocation, DirectionToLocation " +
                            "FROM dbo.CollectionSpecimenCoordinates(" + SpecimenID.ToString() + ")";
                            ad.Fill(dt);
                            if (dt.Rows.Count > 0)
                            {
                                double dLat = 0.0;
                                if (double.TryParse(dt.Rows[0]["Latitude"].ToString(), out dLat))
                                {
                                    dLat = System.Math.Round(dLat, 4);
                                    Lat = dLat.ToString();
                                }
                                else
                                    Lat = dt.Rows[0]["Latitude"].ToString();
                                Lat = Lat.Replace(",", ".");

                                double dLong = 0.0;
                                if (double.TryParse(dt.Rows[0]["Longitude"].ToString(), out dLong))
                                {
                                    dLong = System.Math.Round(dLong, 4);
                                    Long = dLong.ToString();
                                }
                                else
                                    Long = dt.Rows[0]["Longitude"].ToString();
                                Long = Long.Replace(",", ".");

                                Label = RV[1].ToString();
                                Key = Long + "/" + Lat;
                                if (Coordinates.ContainsKey(Key))
                                {
                                    if (!Coordinates[Key][2].Contains(Label))
                                        Coordinates[Key][2].Add(Label);
                                }
                                else
                                {
                                    System.Collections.Generic.List<System.Collections.Generic.List<string>> ListCoo = new List<List<string>>();
                                    System.Collections.Generic.List<string> ListLat = new List<string>();
                                    System.Collections.Generic.List<string> ListLong = new List<string>();
                                    System.Collections.Generic.List<string> ListLabel = new List<string>();
                                    ListLat.Add(Lat);
                                    ListLong.Add(Long);
                                    ListLabel.Add(Label);
                                    ListCoo.Add(ListLat);
                                    ListCoo.Add(ListLong);
                                    ListCoo.Add(ListLabel);
                                    Coordinates.Add(Key, ListCoo);
                                }
                                //if (Long.Length > 0)
                                //{
                                //    Long += "|";
                                //    Lat += "|";
                                //    Label += "|";
                                //}
                                //Long += dt.Rows[0]["Longitude"].ToString().Replace(",", ".");
                                //Lat += dt.Rows[0]["Longitude"].ToString().Replace(",", ".");
                                //Label += RV[1].ToString();
                            }
                        }
                    }
                    if (Coordinates.Count > 0)
                    {
                        string UrlLat = "";
                        string UrlLong = "";
                        string UrlLabel = "";
                        foreach (System.Collections.Generic.KeyValuePair<string, System.Collections.Generic.List<System.Collections.Generic.List<string>>> KV in Coordinates)
                        {
                            if (UrlLong.Length > 0)
                            {
                                UrlLat += "|";
                                UrlLong += "|";
                                UrlLabel += "|";
                            }
                            UrlLat += KV.Value[0][0];
                            UrlLong += KV.Value[1][0];
                            UrlLabel += KV.Value[2][0];
                            if (KV.Value[2].Count > 1)
                            {
                                for (int i = 1; i < KV.Value[2].Count; i++)
                                    UrlLabel += "; " + KV.Value[2][i];
                            }
                        }
                        UrlLabel = UrlLabel.Replace("&", "and");
                        URL = "Lat=" + UrlLat
                            + "&Lng=" + UrlLong
                            + "&Label=" + UrlLabel
                        + "&Height=" + this.webBrowserEventMap.Height.ToString()
                        + "&Width=" + this.webBrowserEventMap.Width.ToString();
                    }
                    //if (Long.Length > 0 && Lat.Length > 0 && Label.Length > 0)
                    //{
                    //    URL = "Lat=" + Lat
                    //        + "&Lng=" + Long
                    //        + "&Label=" + Label
                    //    + "&Height=" + this.webBrowserEventMap.Height.ToString()
                    //    + "&Width=" + this.webBrowserEventMap.Width.ToString();
                    //}
                    this.openMapURL(URL);
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        /*
         * hier soll die Mglichkeit geschaffen werden zu korrigieren
         * An GIS-Editor liste mit Symbolen und IDs uebergeben
         * dort wird einzelnes Objekt markiert
         * hier abfragen der markierten ID
         * dann Aufruf e.g. des Spreadsheets um alle davon betroffenen Daten zu korrigieren
         * 
         * die Symbole muessen dabei zugeordnet werden knnen, e.g. Analysen
         * */

        #region Geographies

        /// <summary>
        /// setting the visibility and backgroud colors of the toolstripbuttons for the maps
        /// </summary>
        private void setMapControls()
        {
            // getting the infos about the data
            bool GeoEventSeriesPresent = false;
            try
            {
                if (this.dataSetCollectionEventSeries.CollectionEventSeriesGeography.Rows.Count > 0)
                    GeoEventSeriesPresent = true;
            }
            catch { }
            bool GeoEventPresent = false;
            try
            {
                if (this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Rows.Count > 0)
                    GeoEventPresent = true;
            }
            catch { }
            bool GeoUnit = false;
            try
            {
                if (this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysis.Rows.Count > 0)
                    GeoUnit = true;
            }
            catch { }

            // setting the controls
            this.toolStripButtonGeoEventSeriesEdit.Visible = false;
            this.toolStripButtonGeoEdit.Visible = false;
            this.toolStripButtonGeoEvent.Visible = true;
            this.toolStripButtonGeoEventSeries.Visible = true;
            this.toolStripButtonGeoAnalysis.Visible = true;

            if (GeoEventSeriesPresent)
            {
                this.toolStripButtonGeoEventSeries.BackColor = System.Drawing.Color.Yellow;
            }
            else
            {
                this.toolStripButtonGeoEventSeries.BackColor = System.Drawing.SystemColors.Control;
            }

            if (GeoEventPresent)
            {
                this.toolStripButtonGeoEvent.BackColor = System.Drawing.Color.Yellow;
            }
            else
            {
                this.toolStripButtonGeoEvent.BackColor = System.Drawing.SystemColors.Control;
            }

            if (GeoUnit)
                this.toolStripButtonGeoAnalysis.BackColor = System.Drawing.Color.Yellow;
            else this.toolStripButtonGeoAnalysis.BackColor = System.Drawing.SystemColors.Control;
        }

        private void toolStripButtonGeoEventSeries_Click(object sender, EventArgs e)
        {
            bool GeoEventSeriesPresent = false;
            try
            {
                if (this.dataSetCollectionEventSeries.CollectionEventSeriesGeography.Rows.Count > 0)
                    GeoEventSeriesPresent = true;
            }
            catch { }
            if (GeoEventSeriesPresent)
            {
                this.splitContainerImagesGeography.Panel2Collapsed = false;
                this.splitContainerImagesGeography.Panel1Collapsed = true;
                System.Collections.Generic.List<string> GeographyStringsForGoogleMaps
                    = DiversityWorkbench.GeoFunctions.getGeographyStringsForGoogleMaps(this.dataSetCollectionEventSeries.CollectionEventSeriesGeography.Rows[0][2].ToString());
                this.userControlGoogleMaps.setUrlForPolygon(GeographyStringsForGoogleMaps[0], GeographyStringsForGoogleMaps[1], GeographyStringsForGoogleMaps[2], GeographyStringsForGoogleMaps[3]);
                this.setMapControls();
                this.toolStripButtonGeoEventSeries.BackColor = System.Drawing.Color.Red;
                this.toolStripButtonGeoEventSeriesEdit.Visible = true;
            }
            else
            {
                this.userControlGoogleMaps.ClearMap();
                this.setMapControls();
                System.Windows.Forms.MessageBox.Show("No geography defined");
            }
        }

        private void toolStripButtonGeoEvent_Click(object sender, EventArgs e)
        {
            bool GeoEventPresent = false;
            try
            {
                if (this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Rows.Count > 0)
                    GeoEventPresent = true;
            }
            catch { }
            if (GeoEventPresent)
            {
                this.splitContainerImagesGeography.Panel2Collapsed = false;
                this.splitContainerImagesGeography.Panel1Collapsed = true;
                int i = this.collectionEventLocalisationBindingSource.Position;
                string LocalisationSystemID = this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows[i]["LocalisationSystemID"].ToString();
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Select("LocalisationSystemID = " + LocalisationSystemID);
                System.Collections.Generic.List<string> GeographyStringsForGoogleMaps = new List<string>();
                if (rr.Length > 0)
                    GeographyStringsForGoogleMaps = DiversityWorkbench.GeoFunctions.getGeographyStringsForGoogleMaps(rr[3].ToString());

                //System.Collections.Generic.List<string> GeographyStringsForGoogleMaps
                //    = DiversityWorkbench.GeoFunctions.getGeographyStringsForGoogleMaps(this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Rows[0][3].ToString());
                
                this.userControlGoogleMaps.setUrlForPolygon(GeographyStringsForGoogleMaps[0], GeographyStringsForGoogleMaps[1], GeographyStringsForGoogleMaps[2], GeographyStringsForGoogleMaps[3]);
                this.setMapControls();
                this.toolStripButtonGeoEvent.BackColor = System.Drawing.Color.Red;
                this.toolStripButtonGeoEdit.Visible = true;
            }
            else
            {
                this.userControlGoogleMaps.ClearMap();
                this.setMapControls();
                System.Windows.Forms.MessageBox.Show("No geography defined");
            }
        }

        private void toolStripButtonGeoAnalysis_Click(object sender, EventArgs e)
        {
            bool GeoAnalysisPresent = false;
            try
            {
                if (this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo.Rows.Count > 0)
                    GeoAnalysisPresent = true;
            }
            catch { }
            if (GeoAnalysisPresent)
            {
                if (this.identificationUnitGeoAnalysisBindingSource.Current == null)
                {
                    this.userControlGoogleMaps.ClearMap();
                    this.setMapControls();
                    System.Windows.Forms.MessageBox.Show("Please select a geographical analysis");
                    //this.userControlGoogleMaps.setUrlForPolygon("");
                    return;
                }
                int iSelectedGeoAnalysis = this.identificationUnitGeoAnalysisBindingSource.Position;
                if (this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo.Rows[iSelectedGeoAnalysis][3].Equals(System.DBNull.Value))
                {
                    this.userControlGoogleMaps.ClearMap();
                    this.setMapControls();
                    System.Windows.Forms.MessageBox.Show("No geography defined for this entry");
                    //this.userControlGoogleMaps.setUrlForPolygon("");
                    return;
                }
                this.splitContainerImagesGeography.Panel2Collapsed = false;
                this.splitContainerImagesGeography.Panel1Collapsed = true;
                System.Collections.Generic.List<string> GeographyStringsForGoogleMaps
                    = DiversityWorkbench.GeoFunctions.getGeographyStringsForGoogleMaps(this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo.Rows[iSelectedGeoAnalysis][3].ToString());
                this.userControlGoogleMaps.setUrlForPolygon(GeographyStringsForGoogleMaps[0], GeographyStringsForGoogleMaps[1], GeographyStringsForGoogleMaps[2], GeographyStringsForGoogleMaps[3]);
                this.setMapControls();
                this.toolStripButtonGeoAnalysis.BackColor = System.Drawing.Color.Red;
            }
            else
            {
                if (this.identificationUnitGeoAnalysisBindingSource.Current == null)
                {
                    this.userControlGoogleMaps.ClearMap();
                    this.setMapControls();
                    System.Windows.Forms.MessageBox.Show("Please select a geographical analysis");
                    //this.userControlGoogleMaps.setUrlForPolygon("");
                    return;
                }
                else
                {
                    this.userControlGoogleMaps.ClearMap();
                    this.setMapControls();
                    System.Windows.Forms.MessageBox.Show("No Geography defined");
                }
            }
        }

        private void toolStripButtonGeoEdit_Click(object sender, EventArgs e)
        {
            //System.Windows.Forms.MessageBox.Show("Function available in upcoming version");
            //return;
            CultureInfo InvC = new CultureInfo("");
            string Version = DiversityWorkbench.Functions.InstalledFramework();
            double dV;
            if (double.TryParse(Version, NumberStyles.AllowDecimalPoint, InvC, out dV) &&
                dV < 3.5)
                System.Windows.Forms.MessageBox.Show("You have installed the .Net Framework " + Version + "\r\n To use this function you have to install the .Net Framework 3.5");
        }

        private void toolStripButtonGeoEventSeriesEdit_Click(object sender, EventArgs e)
        {
            System.Windows.Forms.MessageBox.Show("Function available in upcoming version");
        }
        
        #endregion

        #endregion

        #region GIS

        #region Alter Code - jetzt in GIScontrol

        private void toolStripButtonGisEventSeries_Click(object sender, EventArgs e)
        {
            this.resetGisButtons(this.toolStripButtonGisEventSeries);
        }

        private void toolStripButtonGisEventSeriesGeography_Click(object sender, EventArgs e)
        {
            this.resetGisButtons(this.toolStripButtonGisEventSeriesGeography);
        }

        private void toolStripButtonGisEventSeriesEdit_Click(object sender, EventArgs e)
        {
            this.resetGisButtons(this.toolStripButtonGisEventSeriesEdit);
        }

        private void toolStripButtonGisEvent_Click(object sender, EventArgs e)
        {
            this.resetGisButtons(this.toolStripButtonGisEvent);
        }

        private void toolStripButtonGisEventGeography_Click(object sender, EventArgs e)
        {
            this.resetGisButtons(this.toolStripButtonGisEventGeography);
        }

        private void toolStripButtonGisEventEdit_Click(object sender, EventArgs e)
        {
            this.resetGisButtons(this.toolStripButtonGisEventEdit);
        }

        private void toolStripButtonGisGetCoordinates_Click(object sender, EventArgs e)
        {
            this.resetGisButtons(this.toolStripButtonGisGetCoordinates);
        }
        
        /// <summary>
        /// Show the distribution map of the currently selected specimen
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void toolStripButtonGisDistributionMap_Click(object sender, EventArgs e)
        {
            this.resetGisButtons(this.toolStripButtonGisDistributionMap);
            //this.toolStripButtonGisDistributionMap.BackColor = System.Drawing.Color.Red;
            //this._GisMapState = GisMapState.Distribution;

            // getting the list for all available coordinates
            string SQL = "SELECT /*S.CollectionSpecimenID, S.AccessionNumber,*/ Distinct L.Geography.ToString() AS Geography " +
                "FROM CollectionSpecimen AS S INNER JOIN " +
                "CollectionEventLocalisation AS L ON S.CollectionEventID = L.CollectionEventID " +
                "WHERE (NOT (L.Geography IS NULL)) " +
                "AND S.CollectionSpecimenID IN (";
            foreach (int i in this.userControlQueryList.ListOfIDs)
                SQL += i.ToString() + ", ";
            SQL = SQL.Substring(0, SQL.Length - 2) + ")";
            System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            System.Data.DataTable dt = new DataTable();
            ad.Fill(dt);

            // Creating the geoobjects
            List<GeoObject> GeoObjects = new List<GeoObject>();
            foreach (DataRow row in dt.Rows)
            {
                string geoData = row["Geography"].ToString();
                if (geoData.Length > 0)
                {
                    GeoObjects.Add(setupGeoObject("Test", "x", geoData, System.Windows.Media.Brushes.Red));
                    //GeoObjects.Add(setupGeoObject(row[0].ToString(), row[1].ToString(), geoData, System.Windows.Media.Brushes.Red));
                }
            }

            if (GeoObjects.Count > 0)
            {
                _wpfControl.WpfSetGeoObjects(GeoObjects);
            }
            else
                System.Windows.Forms.MessageBox.Show("No coordinates found");

        }

        private void toolStripButtonGisUnitGeoanalysis_Click(object sender, EventArgs e)
        {
            this.resetGisButtons(this.toolStripButtonGisUnitGeoanalysis);
        }

        /// <summary>
        /// Fill up GeoObject structure...
        /// </summary>
        /// <param name="Identifier">the identifier for the object</param>
        /// <param name="DisplayText">the text displayed in the user interface</param>
        /// <param name="data">the geographical data</param>
        /// <param name="brush">the color for the object</param>
        /// <returns></returns>
        private GeoObject setupGeoObject(string Identifier, string DisplayText, string data, System.Windows.Media.Brush brush)
        {
            GeoObject geoObject = new GeoObject();
            geoObject.Identifier = Identifier;
            geoObject.DisplayText = DisplayText;
            geoObject.StrokeBrush = brush;
            geoObject.FillBrush = brush;
            geoObject.StrokeTransparency = 255;
            geoObject.FillTransparency = 32;
            geoObject.StrokeThickness = 2.0;
            geoObject.PointType = WpfSamplingPlotPage.PointSymbol.Pin;
            geoObject.GeometryData = data;
            return geoObject;
        }

        /// <summary>
        /// setting the backcolor of the active button to red
        /// </summary>
        /// <param name="Button">the active button</param>
        private void resetGisButtons(ToolStripButton Button)
        {
            this.toolStripButtonGisDistributionMap.BackColor = System.Drawing.SystemColors.Control;
            this.toolStripButtonGisEvent.BackColor = System.Drawing.SystemColors.Control;
            this.toolStripButtonGisEventEdit.BackColor = System.Drawing.SystemColors.Control;
            this.toolStripButtonGisEventGeography.BackColor = System.Drawing.SystemColors.Control;
            this.toolStripButtonGisEventSeries.BackColor = System.Drawing.SystemColors.Control;
            this.toolStripButtonGisEventSeriesEdit.BackColor = System.Drawing.SystemColors.Control;
            this.toolStripButtonGisEventSeriesGeography.BackColor = System.Drawing.SystemColors.Control;
            this.toolStripButtonGisGetCoordinates.BackColor = System.Drawing.SystemColors.Control;
            this.toolStripButtonGisUnitGeoanalysis.BackColor = System.Drawing.SystemColors.Control;

            Button.BackColor = System.Drawing.Color.Red;
            if (Button == this.toolStripButtonGisDistributionMap)
                this._GisMapState = GisMapState.Distribution;
            else this._GisMapState = GisMapState.Single;
        }
        #endregion

        /// <summary>
        /// Initialize the map only if the map state is not DISTRIBUTION. 
        /// In latter case new localities can be added to the map and it therefore can not be reset until the state
        /// is set to a different mode
        /// </summary>
        private void initGisMap()
        {
            if (!this.ShowImagesMaps) return;
            if (this.userControlGIS.SelectedGISObject == UserControls.UserControlGIS.SelectedGisObject.Event)
            {
                if (this.dataSetCollectionSpecimen.CollectionEvent.Rows.Count > 0
                    && this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Rows.Count > 0)
                {
                    // try to find WGS84
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionEventLocalisation.Select("LocalisationSystemID = 8 AND AverageLatitudeCache <> 0 AND AverageLongitudeCache <> 0");
                    int i = 0;
                    if (rr.Length > 0)
                    {
                        foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows)
                        {
                            if (R["LocalisationSystemID"].ToString() == "8")
                                break;
                            i++;
                        }
                    }
                    else // WGS84 could not be found
                        i = this.collectionEventLocalisationBindingSource.Position;

                    string LocalisationSystemID = this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows[i]["LocalisationSystemID"].ToString();
                    System.Data.DataRow[] rrGeo = this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Select("LocalisationSystemID = " + LocalisationSystemID);
                    if (rrGeo.Length > 0)
                        this.userControlGIS.DataRowCollectionEventLocalisationGeo = rrGeo[0];
                    else
                        this.userControlGIS.DataRowCollectionEventLocalisationGeo = null;
                }
                else
                    this.userControlGIS.DataRowCollectionEventLocalisationGeo = null;
            }
            else if (this.userControlGIS.SelectedGISObject == UserControls.UserControlGIS.SelectedGisObject.Series)
            {
                if (this.dataSetCollectionSpecimen.CollectionEventSeriesGeo.Rows.Count > 0)
                    this.userControlGIS.DataRowCollectionEventSeriesGeo = this.dataSetCollectionSpecimen.CollectionEventSeriesGeo.Rows[0];
                else
                    this.userControlGIS.DataRowCollectionEventSeriesGeo = null;
            }
            else if (this.userControlGIS.SelectedGISObject == UserControls.UserControlGIS.SelectedGisObject.Organism)
            {
                if (this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo.Rows.Count > 0)
                {
                    this.userControlGIS.DataRowIdentificationUnitGeoAnalysisGeo = this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo.Rows[0];
                }
                else
                    this.userControlGIS.DataRowIdentificationUnitGeoAnalysisGeo = null;
            }
            //else
                this.userControlGIS.CollectionSpecimenID = this.ID;

        }

        #endregion

        #region Alter Code

        #region Identification Unit

        private void comboBoxGender_DropDown(object sender, EventArgs e)
        {
            if (this.identificationUnitBindingSource != null)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
                if (!R["TaxonomicGroup"].Equals(System.DBNull.Value))
                {
                    string TaxonomicGroup = R["TaxonomicGroup"].ToString();
                    string SQL = "SELECT DISTINCT Gender FROM IdentificationUnit WHERE TaxonomicGroup = '" + TaxonomicGroup + "' AND Gender <> '' AND NOT Gender IS NULL ORDER BY Gender";
                    if (this._dtGender == null) this._dtGender = new DataTable();
                    this._dtGender.Clear();
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(this._dtGender);
                    this.comboBoxGender.DataSource = this._dtGender;
                    this.comboBoxGender.DisplayMember = "Gender";
                    this.comboBoxGender.ValueMember = "Gender";
                }
            }
        }

        private void comboBoxGender_SelectionChangeCommitted(object sender, EventArgs e)
        {

        }


        private void textBoxNumberOfUnits_TextChanged(object sender, EventArgs e)
        {

        }

        private void textBoxNumberOfUnits_Validating(object sender, CancelEventArgs e)
        {
            int i = 0;
            if (this.textBoxNumberOfUnits.Text.Length > 0 && !int.TryParse(this.textBoxNumberOfUnits.Text, out i))
                System.Windows.Forms.MessageBox.Show("only numbers are allowed here");
            else if (this.textBoxNumberOfUnits.Text.Length == 0)
            {
                if (this.identificationUnitBindingSource != null)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
                    R.BeginEdit();
                    R["NumberOfUnits"] = System.DBNull.Value;
                    R.EndEdit();
                }
            }
        }

        private void comboBoxLifeStage_DropDown(object sender, EventArgs e)
        {
            if (this.identificationUnitBindingSource != null)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
                if (!R["TaxonomicGroup"].Equals(System.DBNull.Value))
                {
                    string TaxonomicGroup = R["TaxonomicGroup"].ToString();
                    string SQL = "SELECT NULL AS LifeStage UNION SELECT DISTINCT LifeStage FROM IdentificationUnit WHERE TaxonomicGroup = '" + TaxonomicGroup + "' AND LifeStage <> '' AND NOT LifeStage IS NULL ORDER BY LifeStage";
                    if (this._dtLifeStage == null) this._dtLifeStage = new DataTable();
                    this._dtLifeStage.Clear();
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(this._dtLifeStage);
                    this.comboBoxLifeStage.DataSource = this._dtLifeStage;
                    this.comboBoxLifeStage.DisplayMember = "LifeStage";
                    this.comboBoxLifeStage.ValueMember = "LifeStage";
                }
            }
        }

        private void comboBoxLifeStage_SelectionChangeCommitted(object sender, EventArgs e)
        {

        }

        #region Family and Order

        private void buttonEditOrderAndFamily_Click(object sender, EventArgs e)
        {
            this.textBoxFamilyCache.ReadOnly = false;
            this.textBoxOrderCache.ReadOnly = false;
        }

        private void ResetFamilyAndOrderFieldsState()
        {
            bool EnableEdit = false;
            string Family = "";
            string Order = "";
            if (this.identificationUnitBindingSource.Current != null)
            {
                System.Data.DataRowView rv = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
                Family = rv["FamilyCache"].ToString();
                Order = rv["OrderCache"].ToString();
                if (!rv["IdentificationUnitID"].Equals(System.DBNull.Value))
                {
                    int UnitID = int.Parse(rv["IdentificationUnitID"].ToString());
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.Identification.Select("CollectionSpecimenID = " + this.ID +
                        " AND IdentificationUnitID = " + UnitID + " AND NOT NameURI IS NULL");
                    if (rr.Length == 0)
                        EnableEdit = true;
                    else
                    {
                        if (Family.Length == 0 || Order.Length == 0)
                            EnableEdit = true;
                    }
                }
            }
            //this.buttonEditOrderAndFamily.Enabled = EnableEdit;
            if (EnableEdit && (Family != this.textBoxFamilyCache.Text || Order != this.textBoxOrderCache.Text))
            {
                this.textBoxFamilyCache.ReadOnly = false;
                this.textBoxOrderCache.ReadOnly = false;
            }
            else
            {
                this.textBoxFamilyCache.ReadOnly = true;
                this.textBoxOrderCache.ReadOnly = true;
            }
        }

        private void textBoxFamilyCache_TextChanged(object sender, EventArgs e)
        {
            //this.ResetFamilyAndOrderFieldsState();
        }

        private void textBoxOrderCache_TextChanged(object sender, EventArgs e)
        {
            //this.ResetFamilyAndOrderFieldsState();
        }

        //private System.Data.DataTable 

        #endregion

        #endregion

        #region Analysis

        private void toolStripButtonAnalysisNew_Click(object sender, EventArgs e)
        {
            if (this.identificationUnitBindingSource.Current != null)
            {
                System.Data.DataRowView RV = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
                if (!RV["TaxonomicGroup"].Equals(System.DBNull.Value))
                {
                    string TaxonomicGroup = RV["TaxonomicGroup"].ToString();
                    string SQL = "SELECT AnalysisID, DisplayTextHierarchy AS DisplayText " +
                        "FROM dbo.AnalysisList( " + this.userControlQueryList.ProjectID.ToString() + ", '" + TaxonomicGroup + "') " +
                        "ORDER BY DisplayTextHierarchy";
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    System.Data.DataTable dt = new DataTable();
                    ad.Fill(dt);
                    if (dt.Rows.Count == 0)
                    {
                        System.Windows.Forms.MessageBox.Show("No Analysis has been assigned to the taxonomic group " + TaxonomicGroup 
                            + "\r\nand the project " + this.ProjectTitle);
                        return;
                    }
                    DiversityWorkbench.FormGetStringFromList f = new DiversityWorkbench.FormGetStringFromList(dt, "Choose an analysis from the list");
                    //DiversityCollection.FormAnalysis f = new FormAnalysis(null);
                    f.ShowDialog();
                    if (f.DialogResult == DialogResult.OK)
                    {
                        try
                        {
                            int p = this.identificationUnitBindingSource.Position;
                            System.Data.DataRow rU = this.dataSetCollectionSpecimen.IdentificationUnit.Rows[p];
                            int IdentificationUnitID = System.Int32.Parse(rU["IdentificationUnitID"].ToString());
                            int CollectionSpecimenID = System.Int32.Parse(rU["CollectionSpecimenID"].ToString());
                            System.Data.DataRow[] rrA = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select("IdentificationUnitID = " + IdentificationUnitID.ToString());
                            string Number;
                            System.Data.DataRow ri;
                            if (rrA.Length == 0)
                            {
                                Number = "1";
                            }
                            else
                            {
                                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select("", "AnalysisNumber DESC");
                                ri = rr[0];
                                Number = ri["AnalysisNumber"].ToString();
                                try
                                {
                                    int Nr = int.Parse(Number);
                                    Nr += 1;
                                    Number = Nr.ToString();
                                }
                                catch
                                {
                                    Number += "ZZ_" + Number;
                                }
                            }
                            // creating the new Datarow
                            System.Data.DataRow R = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.NewRow();
                            R["CollectionSpecimenID"] = CollectionSpecimenID;
                            R["IdentificationUnitID"] = IdentificationUnitID;
                            R["AnalysisNumber"] = Number;
                            R["AnalysisID"] = int.Parse(f.SelectedValue);
                            //this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Rows.Add(R);
                            //object[] rowVals = new object[4];
                            //rowVals[0] = CollectionSpecimenID;
                            //rowVals[1] = IdentificationUnitID;
                            //rowVals[2] = f.ID;
                            //rowVals[3] = 
                            this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Rows.Add(R);
                            this.fillAnalysisList();
                            this.listBoxAnalysis_SelectedIndexChanged(null, null);
                        }
                        catch (Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        }
                    }
                }
            }
        }

        private void toolStripButtonAnalysisDelete_Click(object sender, EventArgs e)
        {
            try
            {
                this.identificationUnitAnalysisBindingSource.RemoveCurrent();
                this.fillAnalysisList();
                this.listBoxAnalysis_SelectedIndexChanged(null, null);
            }
            catch { }
        }

        private void buttonAnalysisURIOpen_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.FormWebBrowser f = new DiversityWorkbench.FormWebBrowser(this.textBoxAnalysisURI.Text);
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
                this.textBoxAnalysisURI.Text = f.URL;
        }

        private void buttonAnalysisOpen_Click(object sender, EventArgs e)
        {
            DiversityCollection.FormAnalysis f;
            if (this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Rows.Count > 0)
            {
                try
                {
                    System.Data.DataRow r = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Rows[this.identificationUnitAnalysisBindingSource.Position];
                    int AnalysisID = int.Parse(r["AnalysisID"].ToString());
                    f = new FormAnalysis((int?)AnalysisID);
                    f.ShowDialog();
                    if (f.DialogResult == DialogResult.OK)
                    {
                        r["AnalysisID"] = f.ID;
                    }
                    this.fillAnalysisList();

                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void listBoxAnalysis_SelectedIndexChanged(object sender, EventArgs e)
        {
            //int i = 0;
            //try
            //{
            //    if (this.listBoxAnalysis.Items.Count > 0 && this.listBoxAnalysis.SelectedIndex > -1)
            //    {
            //        //this.tableLayoutPanelAnalysis.Visible = true;
            //        System.Data.DataRowView rv = (System.Data.DataRowView)this.listBoxAnalysis.SelectedItem;
            //        int CollectionSpecimenID = int.Parse(rv[0].ToString());//System.Int32.Parse(this.dataSetCollectionSpecimen.IdentificationUnitAnalysisList.Rows[0][0].ToString());
            //        int IdentificationUnitID = int.Parse(rv[1].ToString());//System.Int32.Parse(this.dataSetCollectionSpecimen.IdentificationUnitAnalysisList.Rows[0][1].ToString());
            //        int AnalysisID = int.Parse(rv[2].ToString());//System.Int32.Parse(this.listBoxIdentification.SelectedValue.ToString());
            //        string AnalysisNumber = rv[3].ToString();//System.Int32.Parse(this.listBoxIdentification.SelectedValue.ToString());
            //        foreach (System.Data.DataRow r in this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Rows)
            //        {
            //            if (r.RowState != System.Data.DataRowState.Deleted)
            //            {
            //                if (r["CollectionSpecimenID"].ToString() == CollectionSpecimenID.ToString() &&
            //                    r["IdentificationUnitID"].ToString() == IdentificationUnitID.ToString() &&
            //                    r["AnalysisID"].ToString() == AnalysisID.ToString() &&
            //                    r["AnalysisNumber"].ToString() == AnalysisNumber)
            //                {
            //                    break;
            //                }
            //            }
            //            i++;
            //        }
            //    }
            //    else
            //    {
            //        //i = -1;
            //        //this.tableLayoutPanelIdentification.Visible = false;
            //    }

            //}
            //catch (Exception ex)
            //{
            //    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            //}
            //try
            //{
            //    //System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "Identification"];
            //    //BMB.Position = i;
            //    this.identificationUnitAnalysisBindingSource.Position = i;
            //    if (i > -1)
            //    {
            //        //System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitAnalysisBindingSource.Current;
            //        //if (R["ExternalAnalysisURI"].Equals(System.DBNull.Value) || R["ExternalAnalysisURI"].ToString().Length == 0)
            //        //    this.webBrowserExternalAnalysisURI.Visible = false;
            //        //else
            //        //{
            //        //    System.Uri u = new Uri(R["ExternalAnalysisURI"].ToString());
            //        //    this.webBrowserExternalAnalysisURI.Url = u;
            //        //    this.webBrowserExternalAnalysisURI.Visible = true;
            //        //}
            //    }
            //    //    if (i > -1)
            //    //    {
            //    //        this.toolTip.SetToolTip(this.tableLayoutPanelIdentification, "IdentificationSequence: " + this.dataSetCollectionSpecimen.Tables["Identification"].Rows[i]["IdentificationSequence"].ToString());
            //    //        // setting the visibility of the cache fields
            //    //        // TaxonomicName
            //    //        bool IdIsSet = true;
            //    //        if (this.dataSetCollectionSpecimen.Tables["Identification"].Rows[i]["NameURI"].Equals(System.DBNull.Value)) IdIsSet = false;
            //    //        //this._FormFunctions.setCacheFieldVisibility(IdIsSet, this.panelTaxonomicName);
            //    //        //this._FormFunctions.setCacheFieldVisibility(this.panelNameThesaurusSignature, IdIsSet);
            //    //        //					if (IdIsSet)
            //    //        //					{
            //    //        ////						string TaxonomicName = this.dataSetCollectionSpecimen.Identification.Rows[i]["TaxonomicName"].ToString();
            //    //        ////						if (TaxonomicName.IndexOf("&") > -1) TaxonomicName = TaxonomicName.Replace("&", "&&");
            //    //        ////						this.labelTaxonomicNameCache.Text = TaxonomicName;
            //    //        //					}
            //    //        // Responsible
            //    //        //IdIsSet = true;
            //    //        //if (this.dataSetCollectionSpecimen.Identification.Rows[i]["ResponsibleAgentID"].Equals(System.DBNull.Value)) IdIsSet = false;
            //    //        //this._FormFunctions.setCacheFieldVisibility(IdIsSet, this.panelIdentificationResponsible);
            //    //        //// Reference
            //    //        //IdIsSet = true;
            //    //        //if (this.dataSetCollectionSpecimen.Identification.Rows[i]["ReferenceID"].Equals(System.DBNull.Value)) IdIsSet = false;
            //    //        //this._FormFunctions.setCacheFieldVisibility(IdIsSet, this.panelIdentificationReference);
            //    //    }
            //    //}
            //}
            //catch (Exception ex)
            //{
            //    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            //}
        }

        private void fillAnalysisList()
        {
            try
            {
                int p = this.identificationUnitBindingSource.Position;
                System.Data.DataRow r = this.dataSetCollectionSpecimen.IdentificationUnit.Rows[p];
                int UnitID = System.Int32.Parse(r["IdentificationUnitID"].ToString());
                this.fillAnalysisList(UnitID);

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }


        private void fillAnalysisList(int UnitID)
        {
            //System.Data.DataRow Row;
            //this.dataSetCollectionSpecimen.IdentificationUnitAnalysisList.Clear();
            //try
            //{
            //    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select("IdentificationUnitID = " + UnitID.ToString(), "AnalysisID, AnalysisNumber");
            //    foreach (System.Data.DataRow r in rr)
            //    {
            //        object[] rowVals = new object[5];
            //        rowVals[0] = r["CollectionSpecimenID"];
            //        rowVals[1] = r["IdentificationUnitID"];
            //        rowVals[2] = r["AnalysisID"];
            //        rowVals[3] = r["AnalysisNumber"];
            //        rowVals[4] = this.AnalysisDisplayText(int.Parse(r["AnalysisID"].ToString())) + " - " + r["AnalysisNumber"].ToString();
            //        Row = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisList.Rows.Add(rowVals);
            //    }
            //    if (this.dataSetCollectionSpecimen.IdentificationUnitAnalysisList.Rows.Count > 0)
            //    {
            //        this.listBoxAnalysis.SelectedIndex = 0;
            //        this.splitContainerAnalysis.Panel2.Visible = true;
            //    }
            //    else
            //    {
            //        this.listBoxAnalysis.SelectedIndex = -1;
            //        this.splitContainerAnalysis.Panel2.Visible = false;
            //    }

            //}
            //catch (Exception ex)
            //{
            //    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            //}
        }

        #endregion

        #region Identification

        #region toolStrip

        private void toolStripButtonIdentificationNew_Click(object sender, EventArgs e)
        {
            this.createNewIdentification(IdentInsertType.New);
        }

        private void toolStripButtonIdentificationDelete_Click(object sender, EventArgs e)
        {
            try
            {
                //System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "Identification"];
                this.identificationBindingSource.RemoveCurrent();
                //int p = this.identificationBindingSource.Position;
                //System.Data.DataRow r = this.dataSetCollectionSpecimen.Tables["Identification"].Rows[p];
                //if (r.RowState != System.Data.DataRowState.Deleted)
                //{
                //    int UnitID = System.Int32.Parse(r["IdentificationUnitID"].ToString());
                //    this.dataSetCollectionSpecimen.Tables["Identification"].Rows[p].Delete();
                //    this.fillIdentificationList(UnitID);
                //}
                int ID = System.Int32.Parse(this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0][0].ToString());
                this.setSpecimen(ID);

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonIdentificationNewAtBase_Click(object sender, EventArgs e)
        {
            //this.createNewIdentification(IdentInsertType.Old);
            //int i = this.listBoxIdentification.Items.Count;
            //this.listBoxIdentification.SelectedIndex = i - 1;
        }

        private void toolStripButtonIdentificationConfirm_Click(object sender, EventArgs e)
        {
            this.createNewIdentification(IdentInsertType.Confirm);
        }

        #endregion

        private void userControlModuleRelatedEntryTaxonomicName_Leave(object sender, EventArgs e)
        {
            //System.Data.DataRowView R = (System.Data.DataRowView)this.identificationBindingSource.Current;
            //int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
            //int Sequence = int.Parse(R["IdentificationSequence"].ToString());
            //System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.Identification.Select("IdentificationUnitID = " + UnitID.ToString(), "IdentificationSequence DESC");
            //if (rr.Length > 0)
            //{
            //    string TaxonName = this.userControlModuleRelatedEntryTaxonomicName.textBoxValue.Text;
            //    System.Data.DataRow r = rr[0];
            //    string Taxon = R["TaxonomicName"].ToString();
            //    System.Data.DataRowView Ru = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
            //    if (r["IdentificationSequence"].ToString() == R["IdentificationSequence"].ToString()
            //        && Ru["LastIdentificationCache"].ToString() != Taxon)
            //    {
            //        //this.setSpecimen(this.SpecimenID);
            //        Ru["LastIdentificationCache"] = Taxon;
            //        this.buildUnitHierarchy();
            //    }
            //    //else
            //    //{
            //    //System.Data.DataRowView Rl = (System.Data.DataRowView)this.listBoxIdentification.SelectedItem;
            //    System.Data.DataRowView Ril = (System.Data.DataRowView)this.identificationListUnitBindingSource.Current;
            //    if (Ril[3].ToString() != Taxon)
            //    {
            //        Ril[3] = Taxon;
            //        int i = this.identificationListUnitBindingSource.Position;
            //        this.fillIdentificationList(int.Parse(Ril["IdentificationUnitID"].ToString()));
            //        this.identificationListUnitBindingSource.Position = i;
            //    }
            //    //if (Rl[3].ToString() != Taxon)
            //    //    Rl[3] = Taxon;
            //    //}
            //}
        }

        private string getTaxonName(System.Data.DataRow r)
        {
            string Taxon = "";
            try
            {
                Taxon = r["TaxonomicName"].ToString();
                if (Taxon.Length == 0) Taxon = r["VernacularTerm"].ToString();
                if (Taxon.Length == 0) Taxon = "[Sequence: " + r["IdentificationSequence"].ToString() + "]";

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            return Taxon;
        }

        private void listBoxIdentification_EnabledChanged(object sender, System.EventArgs e)
        {
            //if (this.listBoxIdentification.Enabled) this.listBoxIdentification.BackColor = System.Drawing.SystemColors.Window;
            //else this.listBoxIdentification.BackColor = System.Drawing.SystemColors.Control;
        }

        #region Taxon

        private void textBoxTaxonomicName_Leave(object sender, System.EventArgs e)
        {
            //			System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "Identification"];
            //			int p = BMB.Position;
            //			System.Data.DataRowView rv = (System.Data.DataRowView)this.listBoxIdentification.SelectedItem;
            //			if (rv["TaxonomicName"].ToString() != this.textBoxTaxonomicName.Text)
            //			{
            //				rv["TaxonomicName"] = this.textBoxTaxonomicName.Text;
            //				this.dataSetCollectionSpecimen.Identification.Rows[p]["TaxonomicName"] = this.textBoxTaxonomicName.Text;
            //			}
        }

        private void textBoxVernacularName_Leave(object sender, System.EventArgs e)
        {
        }

        #endregion

        #region Reference


        //private void comboBoxIdentificationReference_DropDown(object sender, System.EventArgs e)
        //{
        //    System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "Identification"];
        //    int p = BMB.Position;
        //    this.dataSetCollectionSpecimen.Identification.Rows[p]["ReferenceID"] = System.DBNull.Value;

        //    string SearchString = this.comboBoxIdentificationReference.Text;
        //    if (SearchString.Length < 1)
        //    {
        //        System.Windows.Forms.MessageBox.Show("Please give at least one character to search for a name");
        //        if (this.dtReference != null)
        //            this.dtReference.Clear();
        //        else
        //            this.comboBoxIdentificationReference.DataSource = null;
        //        return;
        //    }
        //    string SQL = "SELECT DISTINCT LiteratureUsed " +
        //        "FROM  Identification " +
        //        "WHERE (ReferenceID IS NULL) " +
        //        "AND (NOT (LiteratureUsed IS NULL)) " +
        //        "AND (LEN(LiteratureUsed) > 0) " +
        //        "AND (LiteratureUsed LIKE N'" + this.comboBoxIdentificationReference.Text + "%') " +
        //        "ORDER BY LiteratureUsed";
        //    System.Data.OleDb.OleDbConnection con = new System.Data.OleDb.OleDbConnection(this.applicationSettings.ConnectionString);
        //    System.Data.OleDb.OleDbDataAdapter ad = new System.Data.OleDb.OleDbDataAdapter(SQL, con);
        //    if (this.dtReference == null)
        //        this.dtReference = new System.Data.DataTable("LiteratureUsed");
        //    try
        //    {
        //        con.Open();
        //        this.dtReference.Clear();
        //        ad.Fill(this.dtReference);
        //        foreach (System.Data.DataRow r in this.dataSetCollectionSpecimen.Identification.Rows)
        //        {
        //            object[] rowVals = new object[1];
        //            if (!r["LiteratureUsed"].Equals(System.DBNull.Value) && r["ReferenceID"].Equals(System.DBNull.Value))
        //            {
        //                rowVals[0] = r["LiteratureUsed"].ToString();
        //                this.dtReference.Rows.Add(rowVals);
        //            }
        //        }
        //    }
        //    finally
        //    {
        //        con.Close();
        //        con.Dispose();
        //    }
        //    this.comboBoxIdentificationReference.DataSource = this.dtReference;
        //    this.comboBoxIdentificationReference.DisplayMember = "LiteratureUsed";
        //    this.comboBoxIdentificationReference.ValueMember = "LiteratureUsed";
        //}

        //private void comboBoxLiteratureUsed_DropDown(object sender, System.EventArgs e)
        //{
        //    //			this.comboBoxLiteratureUsed.DataBindings.Clear();
        //    if (this.RemoteReference == null)
        //        this.RemoteReference = new DiversityWorkbench.RemoteItemReference(this.applicationSettings);
        //    try
        //    {
        //        this.comboBoxLiteratureUsed.DataSource = this.RemoteReference.getReferenceList(this.comboBoxLiteratureUsed.Text);
        //        this.comboBoxLiteratureUsed.DisplayMember = "RefDescription";
        //        this.comboBoxLiteratureUsed.ValueMember = "RefID";
        //    }
        //    catch (System.Exception ex)
        //    {
        //        System.Windows.Forms.MessageBox.Show(ex.Message, "DiversityReferences", System.Windows.Forms.MessageBoxButtons.OK);
        //    }

        //    //			this.comboBoxLiteratureUsed.DataBindings.Add(new System.Windows.Forms.Binding("SelectedValue", this.dataSetCollectionSpecimen, "Identification.ReferenceID"));
        //}

        //private void comboBoxLiteratureUsed_SelectedIndexChanged(object sender, System.EventArgs e)
        //{
        //    if (comboBoxLiteratureUsed.SelectedIndex > -1)
        //    {
        //        System.Data.DataRowView rv = (System.Data.DataRowView)this.comboBoxLiteratureUsed.SelectedItem;
        //        //				this.textBoxReferenceCitation.Text = rv["RefDescription"].ToString();
        //        this.setIdentificationReference(rv["RefDescription"].ToString(), System.Int32.Parse(rv["RefID"].ToString()));
        //        //				this.setReference(rv["RefDescription"].ToString(), System.Int32.Parse(rv["RefID"].ToString()));
        //        //				this.comboBoxLiteratureUsed.DataBindings.Clear();
        //    }
        //}

        //private void setReference(string RefDescription, int RefID)
        //{
        //    if (RefDescription.Length == 0 || RefID == 0)
        //        return;
        //    try
        //    {
        //        System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "Identification"];
        //        int p = BMB.Position;
        //        System.Data.DataRow r = this.dataSetCollectionSpecimen.Identification.Rows[p];
        //        r["LiteratureUsed"] = RefDescription;
        //        r["ReferenceID"] = RefID;
        //        this.updateTable(this.dataSetCollectionSpecimen, "Identification", this.oleDbDataAdapterIdentification);
        //    }
        //    catch { }
        //}


        //private void buttonOpenReference_Click(object sender, System.EventArgs e)
        //{
        //    if (this.RemoteReference == null)
        //        this.RemoteReference = new DiversityWorkbench.RemoteItemReference(this.applicationSettings);
        //    System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "Identification"];
        //    int p = BMB.Position;
        //    System.Data.DataRow r = this.dataSetCollectionSpecimen.Identification.Rows[p];
        //    DiversityWorkbench.ReferenceValues V;
        //    if (r["ReferenceID"].Equals(System.DBNull.Value))
        //        V = this.RemoteReference.getReferenceValues();
        //    else
        //        V = this.RemoteReference.getReferenceValues(System.Int32.Parse(r["ReferenceID"].ToString()));
        //    if (V.OK)
        //    {
        //        this.setIdentificationReference(V.RefDescription, V.ReferenceID);
        //        //				r["ReferenceID"] = V.ReferenceID;
        //        //				r["LiteratureUsed"] = V.RefDescription;
        //        //				this.setReference(V.RefDescription, V.ReferenceID);
        //        //				this.FormFunctions.setCacheFieldVisibility(this.panelIdentificationReference, true);
        //    }
        //}

        //private void buttonIdenitificationReferenceDelete_Click(object sender, System.EventArgs e)
        //{
        //    if (System.Windows.Forms.MessageBox.Show("This will remove all data of the reference used for the identification", "Remove reference", System.Windows.Forms.MessageBoxButtons.OKCancel) == System.Windows.Forms.DialogResult.OK)
        //    {
        //        System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "Identification"];
        //        int p = BMB.Position;
        //        this.dataSetCollectionSpecimen.Identification.Rows[p]["ReferenceID"] = System.DBNull.Value;
        //        this.dataSetCollectionSpecimen.Identification.Rows[p]["LiteratureUsed"] = System.DBNull.Value;
        //        this._FormFunctions.setCacheFieldVisibility(false, this.panelIdentificationReference);
        //    }
        //}
        //private void setIdentificationReference(string LiteratureUsed, int ReferenceID)
        //{
        //    if (LiteratureUsed.Length == 0 || ReferenceID == 0)
        //        return;
        //    try
        //    {
        //        System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "Identification"];
        //        int p = BMB.Position;
        //        System.Data.DataRow r = this.dataSetCollectionSpecimen.Identification.Rows[p];
        //        r["LiteratureUsed"] = LiteratureUsed;
        //        r["ReferenceID"] = ReferenceID;
        //        this.updateTable(this.dataSetCollectionSpecimen, "Identification", this.oleDbDataAdapterIdentification);
        //        //				this.FormFunctions.setCacheFieldVisibility(this.panelIdentificationReference, true);
        //    }
        //    catch { }
        //}

        //private void panelIdentificationReference_Leave(object sender, System.EventArgs e)
        //{
        //    // set Responsible
        //    System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "Identification"];
        //    int p = BMB.Position;
        //    bool IdIsSet = true;
        //    if (this.dataSetCollectionSpecimen.Identification.Rows[p]["ResponsibleAgentID"].Equals(System.DBNull.Value)) IdIsSet = false;
        //    this._FormFunctions.setCacheFieldVisibility(IdIsSet, this.panelIdentificationReference);
        //}

        #endregion

        #region Responsible

        //private void comboBoxIdentificationResponsibleName_DropDown(object sender, System.EventArgs e)
        //{
        //    System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "Identification"];
        //    int p = BMB.Position;
        //    this.dataSetCollectionSpecimen.Identification.Rows[p]["ResponsibleAgentID"] = System.DBNull.Value;
        //    this.setAgentList(this.comboBoxIdentificationResponsibleName, this.dtIdentificationResponsible, this.dataSetCollectionSpecimen.Identification, "ResponsibleName", "ResponsibleAgentID");
        //}

        //private void panelIdentificationResponsible_Leave(object sender, System.EventArgs e)
        //{
        //    bool IdIsSet = true;
        //    System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "Identification"];
        //    int p = BMB.Position;
        //    if (this.dataSetCollectionSpecimen.Identification.Rows[p]["ResponsibleAgentID"].Equals(System.DBNull.Value)) IdIsSet = false;
        //    this._FormFunctions.setCacheFieldVisibility(IdIsSet, this.panelIdentificationResponsible);
        //}

        //private void buttonIdenitificationResponsibleDelete_Click(object sender, System.EventArgs e)
        //{
        //    if (System.Windows.Forms.MessageBox.Show("This will remove the connection to the module DivesityAgents", "Remove module connection", System.Windows.Forms.MessageBoxButtons.OKCancel) == System.Windows.Forms.DialogResult.OK)
        //    {
        //        System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "Identification"];
        //        int p = BMB.Position;
        //        this.dataSetCollectionSpecimen.Identification.Rows[p]["ResponsibleAgentID"] = System.DBNull.Value;
        //        this._FormFunctions.setCacheFieldVisibility(false, this.panelIdentificationResponsible);
        //    }
        //}

        //private void buttonOpenIdentificationResponsible_Click(object sender, System.EventArgs e)
        //{
        //    this.CheckConnectionAgents();
        //    System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "Identification"];
        //    int p = BMB.Position;
        //    DiversityWorkbench.AgentValues AV;
        //    if (this.dataSetCollectionSpecimen.Identification.Rows[p]["ResponsibleAgentID"].Equals(System.DBNull.Value))
        //        AV = this.RemoteAgent.getAgentValues();
        //    else AV = this.RemoteAgent.getAgentValues(System.Int32.Parse(this.dataSetCollectionSpecimen.Identification.Rows[p]["ResponsibleAgentID"].ToString()));
        //    if (AV.OK)
        //    {
        //        this.setIdentificationResponsible(AV.AgentName, AV.AgentID);
        //    }
        //}

        //private void comboBoxIdentificationResponsible_DropDown(object sender, System.EventArgs e)
        //{
        //    if (this.comboBoxIdentificationResponsibleName.Text.Length < 1)
        //    {
        //        System.Windows.Forms.MessageBox.Show("Please give at least 1 character to start the search for a name", "Missing search string", System.Windows.Forms.MessageBoxButtons.OK);
        //        return;
        //    }
        //    this.CheckConnectionAgents();
        //    try
        //    {
        //        System.Data.DataTable dt = this.RemoteAgent.getAgentList(this.comboBoxIdentificationResponsibleName.Text);
        //        this.comboBoxIdentificationResponsible.DataSource = dt;
        //        this.comboBoxIdentificationResponsible.DisplayMember = "DisplayText";
        //        this.comboBoxIdentificationResponsible.ValueMember = "ID";
        //    }
        //    catch (System.Exception ex)
        //    {
        //        System.Windows.Forms.MessageBox.Show(ex.Message, "DiversityAgents", System.Windows.Forms.MessageBoxButtons.OK);
        //    }
        //}

        //private void comboBoxIdentificationResponsible_SelectedIndexChanged(object sender, System.EventArgs e)
        //{
        //    if (comboBoxIdentificationResponsible.SelectedIndex > -1)
        //    {
        //        System.Data.DataRowView rv = (System.Data.DataRowView)this.comboBoxIdentificationResponsible.SelectedItem;
        //        this.setIdentificationResponsible(rv["DisplayText"].ToString(), System.Int32.Parse(rv["ID"].ToString()));
        //    }

        //}

        //private void setIdentificationResponsible(string ResponsibleName, int ResponsibleAgentID)
        //{
        //    if (ResponsibleName.Length == 0 || ResponsibleAgentID == 0)
        //        return;
        //    try
        //    {
        //        System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionSpecimen, "Identification"];
        //        int p = BMB.Position;
        //        System.Data.DataRow r = this.dataSetCollectionSpecimen.Identification.Rows[p];
        //        r["ResponsibleName"] = ResponsibleName;
        //        r["ResponsibleAgentID"] = ResponsibleAgentID;
        //        this.comboBoxIdentificationResponsibleName.Text = ResponsibleName;
        //        this.updateTable(this.dataSetCollectionSpecimen, "Identification", this.oleDbDataAdapterIdentification);
        //    }
        //    catch { }
        //}

        #endregion

        #endregion

        #region Collector

        private void listBoxCollectionAgent_SelectedIndexChanged(object sender, EventArgs e)
        {
            //if (this.listBoxCollectionAgent.SelectedIndex == -1)
            //    this.tableLayoutPanelCollector.Enabled = false;
            //else
            //    this.tableLayoutPanelCollector.Enabled = true;
        }

        private void toolStripButtonCollectorDelete_Click(object sender, EventArgs e)
        {
            if (System.Windows.Forms.MessageBox.Show("Do you want to delete collector\n\r\n\r" + this.dataSetCollectionSpecimen.CollectionAgent.Rows[this.collectionAgentBindingSource.Position]["CollectorsName"].ToString(), "Delete collector?", MessageBoxButtons.YesNo) == DialogResult.Yes)
            {
                try
                {
                    this.collectionAgentBindingSource.RemoveCurrent();
                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionAgent", this.sqlDataAdapterAgent, this.BindingContext);

                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void toolStripButtonColletorNew_Click(object sender, EventArgs e)
        {
            this.createNewCollector();
        }

        private void createNewCollector()
        {
            //try
            //{
            //    System.Data.DataRow R = this.dataSetCollectionSpecimen.CollectionAgent.NewRow();
            //    R["CollectionSpecimenID"] = this.SpecimenID;
            //    R["CollectorsName"] = "New collector";
            //    R["CollectorsSequence"] = System.DateTime.Now.ToShortDateString();
            //    this.dataSetCollectionSpecimen.CollectionAgent.Rows.Add(R);
            //    int i = this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count;
            //    this.listBoxCollectionAgent.SelectedIndex = i - 1;
            //    //if (i == 1)
            //    //    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionAgent", this.sqlDataAdapterAgent, this.collectionAgentBindingSource);
            //}
            //catch (Exception ex)
            //{
            //    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            //}
        }

        private void toolStripButtonCollectorUp_Click(object sender, EventArgs e)
        {
            //try
            //{
            //    if (this.listBoxCollectionAgent.SelectedIndex > 0 && this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count > 1)
            //    {
            //        System.Data.DataRow r = this.dataSetCollectionSpecimen.CollectionAgent.Rows[this.collectionAgentBindingSource.Position];
            //        System.Data.DataRow[] rrTime = this.dataSetCollectionSpecimen.CollectionAgent.Select("", "CollectorsSequence", System.Data.DataViewRowState.CurrentRows);
            //        System.Data.DataRow rTime = rrTime[0];
            //        System.DateTime Time = System.DateTime.Parse(rTime[3].ToString());
            //        System.TimeSpan TS = new TimeSpan(1, 0, 0, 0, 0);
            //        Time = Time.Subtract(TS);
            //        r[3] = Time;
            //        this.setSpecimen(this.SpecimenID);
            //    }

            //}
            //catch (Exception ex)
            //{
            //    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            //}
        }

        private void toolStripButtonCollectorDown_Click(object sender, EventArgs e)
        {
            //try
            //{
            //    if (this.listBoxCollectionAgent.SelectedIndex > -1 && this.listBoxCollectionAgent.SelectedIndex < this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count - 1)
            //    {
            //        System.Data.DataRow r = this.dataSetCollectionSpecimen.CollectionAgent.Rows[this.collectionAgentBindingSource.Position];
            //        System.Data.DataRow[] rrTime = this.dataSetCollectionSpecimen.CollectionAgent.Select("", "CollectorsSequence DESC", System.Data.DataViewRowState.CurrentRows);
            //        System.Data.DataRow rTime = rrTime[0];
            //        System.DateTime Time = System.DateTime.Parse(rTime[3].ToString());
            //        Time = Time.AddDays(1);
            //        r[3] = Time;
            //        this.setSpecimen(this.SpecimenID);
            //    }

            //}
            //catch (Exception ex)
            //{
            //    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            //}
        }

        #endregion

        #region Project

        private System.Data.DataTable DtProjects
        {
            get
            {
                try
                {
                    if (this._dtProjects == null)
                    {
                        this._dtProjects = new System.Data.DataTable("Projects");
                        string SQL = "SELECT ProjectID, Project FROM ProjectProxy ORDER BY Project";
                        System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                        ad.Fill(_dtProjects);
                    }
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
                return this._dtProjects;
            }
        }


        private void toolStripButtonProjectNew_Click(object sender, EventArgs e)
        {
            //System.Data.DataTable Projects = this.DtProjects.Copy();
            System.Data.DataTable Projects = DiversityCollection.LookupTable.DtProjectList.Copy();
            foreach (System.Data.DataRow R in Projects.Rows)
            {
                foreach (System.Data.DataRow rCP in this.dataSetCollectionSpecimen.CollectionProject.Rows)
                {
                    try
                    {
                        if (R["ProjectID"].ToString() == rCP["ProjectID"].ToString())
                            R.Delete();
                    }
                    catch { }
                }
            }
            DiversityCollection.FormGetProject f = new FormGetProject(Projects);
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                try
                {
                    if (f.ProjectID != null)
                    {
                        object[] rowVals = new object[2];
                        rowVals[0] = this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionSpecimenID"];
                        rowVals[1] = (int)f.ProjectID;
                        this.dataSetCollectionSpecimen.CollectionProject.Rows.Add(rowVals);
                        this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionProject", this.sqlDataAdapterProject, this.BindingContext);
                        this.fillProjectList();
                    }
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void toolStripButtonProjectNoAccessNew_Click(object sender, EventArgs e)
        {
            System.Data.DataTable Projects = DiversityCollection.LookupTable.DtProjectNoAccessList.Copy();
            foreach (System.Data.DataRow R in Projects.Rows)
            {
                foreach (System.Data.DataRow rCP in this.dataSetCollectionSpecimen.CollectionProject.Rows)
                {
                    try
                    {
                        if (R["ProjectID"].ToString() == rCP["ProjectID"].ToString())
                            R.Delete();
                    }
                    catch { }
                }
            }
            DiversityCollection.FormGetProject f = new FormGetProject(Projects, "", false);
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                try
                {
                    if (f.ProjectID != null)
                    {
                        object[] rowVals = new object[2];
                        rowVals[0] = this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionSpecimenID"];
                        rowVals[1] = (int)f.ProjectID;
                        this.dataSetCollectionSpecimen.CollectionProject.Rows.Add(rowVals);
                        this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionProject", this.sqlDataAdapterProject, this.BindingContext);
                        this.fillProjectList();
                    }
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void toolStripButtonProjectDelete_Click(object sender, EventArgs e)
        {
            System.Data.DataRowView rv = (System.Data.DataRowView)this.listBoxProjects.SelectedItem;
            try
            {
                if (this.listBoxProjects.Items.Count < 2)
                {
                    System.Windows.Forms.MessageBox.Show("The last project can not be deleted from this list");
                    return;
                }
                string Project = rv["Project"].ToString();
                if (System.Windows.Forms.MessageBox.Show("Do you want to remove this specimen from the project \n\r\n\r" + Project, "Delete project?", MessageBoxButtons.YesNo) == DialogResult.Yes)
                {
                    int ProjectID = int.Parse(this.dataSetCollectionSpecimen.CollectionProjectList.Rows[collectionProjectListBindingSource.Position]["ProjectID"].ToString());
                    this.collectionProjectListBindingSource.RemoveCurrent();
                    foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionProject.Rows)
                    {
                        if (R["ProjectID"].ToString() == ProjectID.ToString())
                        {
                            R.Delete();
                            break;
                        }
                    }
                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionProject", this.sqlDataAdapterProject, this.BindingContext);
                }

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonProjectOpen_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.FormRemoteQuery f;
            try
            {
                if (this.collectionProjectListBindingSource != null)
                {
                    System.Data.DataRowView RU = (System.Data.DataRowView)this.collectionProjectListBindingSource.Current;
                    int ID = 0;
                    if (RU != null)
                    {
                        if (!RU["ProjectID"].Equals(System.DBNull.Value))
                        {
                            ID = int.Parse(RU["ProjectID"].ToString());
                            DiversityWorkbench.Project P = new DiversityWorkbench.Project(DiversityWorkbench.Settings.ServerConnection);
                            f = new DiversityWorkbench.FormRemoteQuery(ID, (DiversityWorkbench.IWorkbenchUnit)P);
                            f.ShowDialog();
                        }
                    }
                    //if (URI.Length == 0)
                    //    f = new DiversityWorkbench.FormRemoteQuery(this._IWorkbenchUnit);
                    //else
                    //    f = new DiversityWorkbench.FormRemoteQuery(URI, this._IWorkbenchUnit);
                    //f.ShowDialog();
                    //if (f.DialogResult == DialogResult.OK)
                    //{
                    //    System.Data.DataRowView R = (System.Data.DataRowView)this._BindingSource.Current;
                    //    R.BeginEdit();
                    //    R[this._ValueColumn] = f.URI;
                    //    R[this._DisplayColumn] = f.DisplayText;
                    //    R.EndEdit();
                    //    this.labelURI.Text = f.URI;
                    //    if (this._RemoteValueBindings != null && this._RemoteValueBindings.Count > 0)
                    //    {
                    //        foreach (DiversityWorkbench.RemoteValueBinding RVB in this._RemoteValueBindings)
                    //        {
                    //            foreach (System.Collections.Generic.KeyValuePair<string, string> P in this._IWorkbenchUnit.UnitValues())
                    //            {
                    //                if (RVB.RemoteParameter == P.Key)
                    //                {
                    //                    System.Data.DataRowView RV = (System.Data.DataRowView)RVB.BindingSource.Current;
                    //                    RV.BeginEdit();
                    //                    RV[RVB.Column] = P.Value;
                    //                    RV.EndEdit();
                    //                }
                    //            }
                    //        }
                    //    }
                    //    //this.textBoxValue.Tag = f.URI;
                    //    this.textBoxValue.Text = f.DisplayText;
                    //    this.setControls();
                    //}
                }
                else
                {
                    //f = new FormRemoteQuery(this._IWorkbenchUnit);
                    //f.ShowDialog();
                    //if (f.DialogResult == DialogResult.OK)
                    //{
                    //    System.Data.DataRowView R = (System.Data.DataRowView)this._BindingSource.Current;
                    //    this.labelURI.Text = f.URI;
                    //    this.textBoxValue.Text = f.DisplayText;
                    //    this.setControls();
                    //}
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void fillProjectList()
        {
            try
            {
                if (this.SpecimenID > -1)
                {
                    // Available
                    string SQL = "SELECT CollectionProject.CollectionSpecimenID, CollectionProject.ProjectID, ProjectList.Project " +
                            "FROM CollectionProject INNER JOIN " +
                            "ProjectList ON CollectionProject.ProjectID = ProjectList.ProjectID " +
                            "WHERE CollectionProject.CollectionSpecimenID = " + this.SpecimenID.ToString() + 
                            " AND ProjectList.ReadOnly = 0 " +
                            " ORDER BY ProjectList.Project";
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    this.dataSetCollectionSpecimen.CollectionProjectList.Clear();
                    ad.Fill(this.dataSetCollectionSpecimen.CollectionProjectList);
                    this.listBoxProjects.SelectedIndex = -1;

                    // Read only
                    SQL = "SELECT CollectionProject.CollectionSpecimenID, CollectionProject.ProjectID, ProjectList.Project " +
                        "FROM CollectionProject INNER JOIN " +
                        "ProjectList ON CollectionProject.ProjectID = ProjectList.ProjectID " +
                        "WHERE CollectionProject.CollectionSpecimenID = " + this.SpecimenID.ToString() +
                        " AND ProjectList.ReadOnly <> 0 " +
                        " ORDER BY ProjectList.Project";
                    ad.SelectCommand.CommandText = SQL;
                    System.Data.DataTable dtProjectReadOnly = new DataTable();
                    ad.Fill(dtProjectReadOnly);
                    if (dtProjectReadOnly.Rows.Count > 0)
                    {
                        this.listBoxProjectsReadOnly.DataSource = dtProjectReadOnly;
                        this.listBoxProjectsReadOnly.DisplayMember = "Project";
                        this.listBoxProjectsReadOnly.ValueMember = "Project";
                        this.listBoxProjectsReadOnly.Height = (dtProjectReadOnly.Rows.Count * this.listBoxProjectsReadOnly.ItemHeight) + 10;
                        this.listBoxProjectsReadOnly.Visible = true;
                        //this.listBoxProjectsReadOnly.SelectedIndex = -1;
                    }
                    else
                        this.listBoxProjectsReadOnly.Visible = false;

                    // No Access
                    SQL = "SELECT ProjectProxy.Project " +
                        "FROM CollectionProject INNER JOIN " +
                        "ProjectProxy ON CollectionProject.ProjectID = ProjectProxy.ProjectID " +
                        "WHERE (CollectionProject.ProjectID NOT IN " +
                        "(SELECT ProjectID " +
                        "FROM ProjectList)) AND (CollectionProject.CollectionSpecimenID = " + this.SpecimenID.ToString() + ") " +
                        "ORDER BY ProjectProxy.Project";
                    ad.SelectCommand.CommandText = SQL;
                    System.Data.DataTable dtProjectNoAccess = new DataTable();
                    ad.Fill(dtProjectNoAccess);
                    if (dtProjectNoAccess.Rows.Count > 0)
                    {
                        this.listBoxProjectsNoAccess.DataSource = dtProjectNoAccess;
                        this.listBoxProjectsNoAccess.DisplayMember = "Project";
                        this.listBoxProjectsNoAccess.ValueMember = "Project";
                        this.listBoxProjectsNoAccess.Height = (dtProjectNoAccess.Rows.Count * this.listBoxProjectsNoAccess.ItemHeight) + 10;
                        this.listBoxProjectsNoAccess.Visible = true;
                        //this.listBoxProjectsNoAccess.SelectedIndex = -1;
                    }
                    else
                        this.listBoxProjectsNoAccess.Visible = false;
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private System.Collections.Generic.Dictionary<string, string> CurrentProject
        {
            get
            {
                System.Collections.Generic.Dictionary<string, string> D;
                try
                {
                    DiversityWorkbench.Project P = new DiversityWorkbench.Project(DiversityWorkbench.Settings.ServerConnection);
                    int ProjectID = this.userControlQueryList.ProjectID;
                    D = P.UnitValues(ProjectID);
                }
                catch
                {
                    D = new Dictionary<string, string>();
                }
                return D;
            }
        }

        private string ProjectTitle
        {
            get
            {
                System.Collections.Generic.Dictionary<string, string> D = this.CurrentProject;
                string P = "";
                try { P = D["Project"]; }
                catch { }
                return P;
            }
        }

        private string ProjectParentTitle
        {
            get
            {
                System.Collections.Generic.Dictionary<string, string> D = this.CurrentProject;
                string P = "";
                try { P = D["Superior project"]; }
                catch { }
                return P;
            }
        }

        #endregion

        #region Storage

        #region Auxilliary tables and functions

        private System.Data.DataTable DtCollection
        {
            get
            {
                try
                {
                    if (this._dtCollection == null)
                    {
                        this._dtCollection = new System.Data.DataTable("Collection");
                        string SQL = "SELECT CollectionID, CollectionParentID, CollectionName, CollectionAcronym, " +
                            "AdministrativeContactName, AdministrativeContactAgentURI, Description, " +
                            "Location, CollectionOwner, DisplayOrder " +
                            "FROM Collection " +
                            "ORDER BY DisplayOrder";
                        System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                        ad.Fill(_dtCollection);
                    }
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
                return this._dtCollection;
            }
        }

        private string CollectionName(int CollectionID)
        {
            string Name = "";
            try
            {
                foreach (System.Data.DataRow R in this.DtCollection.Rows)
                {
                    if (R["CollectionID"].ToString() == CollectionID.ToString())
                    {
                        Name = R["CollectionName"].ToString();
                        break;
                    }
                }

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            return Name;
        }

        private string CollectionOwner(int CollectionID)
        {
            string Owner = "";
            int? ParentID = CollectionID;
            while (ParentID != null)
            {
                try
                {
                    foreach (System.Data.DataRow R in this.DtCollection.Rows)
                    {
                        if (R["CollectionID"].ToString() == ParentID.ToString())
                        {
                            Owner = R["CollectionOwner"].ToString();
                            if (R["CollectionParentID"].Equals(System.DBNull.Value))
                                ParentID = null;
                            else
                                ParentID = int.Parse(R["CollectionParentID"].ToString());
                            break;
                        }
                    }

                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
            return Owner;
        }

        private System.Data.DataTable DtProcessing
        {
            get
            {
                if (this._dtProcessing == null)
                {
                    string SQL = "SELECT ProcessingID, ProcessingParentID, DisplayText, Description, Notes, ProcessingURI " +
                    "FROM Processing ORDER BY DisplayText";
                    this._dtProcessing = new DataTable("Processing");
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    try
                    {
                        ad.Fill(_dtProcessing);
                    }
                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                }
                if (this._dtProcessing.Rows.Count == 0)
                {
                    string SQL = "SELECT ProcessingID, ProcessingParentID, DisplayText, Description, Notes, ProcessingURI " +
                    "FROM Processing ORDER BY DisplayText";
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    try
                    {
                        ad.Fill(_dtProcessing);
                    }
                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                }
                return _dtProcessing;
            }
        }

        private System.Data.DataTable DtLoan
        {
            get
            {
                if (this._dtLoan == null)
                {
                    string SQL = "SELECT NULL AS LoanID, NULL AS LoanTitle UNION SELECT LoanID, LoanTitle FROM Loan ORDER BY LoanTitle";
                    this._dtLoan = new DataTable("Loan");
                    if (DiversityWorkbench.Settings.ConnectionString.Length > 0)
                    {
                        System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                        try
                        {
                            ad.Fill(_dtLoan);
                        }
                        catch (Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        }
                    }
                }
                return _dtLoan;
            }
        }

        private string ProcessingDisplayText(int ProcessingID)
        {
            string DisplayText = "Processing";
            foreach (System.Data.DataRow r in this.DtProcessing.Rows)
            {
                try
                {
                    if (r["ProcessingID"].ToString() == ProcessingID.ToString())
                    {
                        DisplayText = r["DisplayText"].ToString();
                        break;
                    }

                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
            return DisplayText;
        }

        //private void setStorageNodeImage(ref System.Windows.Forms.TreeNode Node, string MaterialCategory)
        //{
        //    switch (MaterialCategory)
        //    {
        //        case "Collection":
        //            Node.ImageIndex = 0;
        //            break;
        //        case "Processing":
        //            Node.ImageIndex = 1;
        //            break;
        //        case "specimen":
        //            Node.ImageIndex = 2;
        //            break;
        //        case "herbarium sheets":
        //            Node.ImageIndex = 3;
        //            break;
        //        case "cultures":
        //            Node.ImageIndex = 4;
        //            break;
        //        case "micr. slide":
        //            Node.ImageIndex = 5;
        //            break;
        //        case "icones":
        //            Node.ImageIndex = 6;
        //            break;
        //        case "drawing":
        //            Node.ImageIndex = 7;
        //            break;
        //        case "bones":
        //            Node.ImageIndex = 8;
        //            break;
        //        default:
        //            Node.ImageIndex = 0;
        //            break;
        //    }
        //    Node.SelectedImageIndex = Node.ImageIndex;
        //}

        private string CurrentUserName(string login)
        {
            string User = login;
            string SQL = "SELECT CombinedNameCache FROM UserProxy WHERE (LoginName = N'" + login + "')";
            //System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            //System.Data.SqlClient.SqlCommand c = new System.Data.SqlClient.SqlCommand(SQL, con);
            System.Data.SqlClient.SqlDataAdapter a = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            System.Data.DataTable dT = new DataTable();
            //con.Open();
            try
            {
                a.Fill(dT);
                if (dT.Rows.Count > 0) User = dT.Rows[0][0].ToString();
                //User = c.ExecuteScalar().ToString();
            }
            catch { }
            //con.Close();
            return User;
        }
        #endregion

        private void textBoxProcessingDate_Leave(object sender, EventArgs e)
        {
            try
            {
                if (this.textBoxProcessingDate.Text.Length == 0)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenProcessingBindingSource.Current;
                    R.BeginEdit();
                    R["ProcessingDate"] = System.DBNull.Value;
                    this.textBoxProcessingDate.Text = null;
                    R.EndEdit();
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void dateTimePickerProcessingDate_DropDown(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenProcessingBindingSource.Current;
                if (!R["ProcessingDate"].Equals(System.DBNull.Value))
                {
                    System.DateTime DT;
                    if (System.DateTime.TryParse(R["ProcessingDate"].ToString(), out DT))
                    {
                        this.dateTimePickerProcessingDate.Value = DT;
                    }
                }
                //string Date = this.dateTimePickerProcessingDate.Value.Year.ToString() + "-"
                //    + this.dateTimePickerProcessingDate.Value.Month.ToString() + "-"
                //    + this.dateTimePickerProcessingDate.Value.Day.ToString() + " "
                //    + this.dateTimePickerProcessingDate.Value.Hour.ToString() + ":"
                //    + this.dateTimePickerProcessingDate.Value.Minute.ToString() + ":"
                //    + this.dateTimePickerProcessingDate.Value.Second.ToString();
                //R["ProcessingDate"] = Date;
                //this.textBoxProcessingDate.Text = Date;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void dateTimePickerProcessingDate_CloseUp(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenProcessingBindingSource.Current;
                string Date = this.dateTimePickerProcessingDate.Value.Year.ToString() + "-"
                    + this.dateTimePickerProcessingDate.Value.Month.ToString() + "-"
                    + this.dateTimePickerProcessingDate.Value.Day.ToString() + " "
                    + this.dateTimePickerProcessingDate.Value.Hour.ToString() + ":"
                    + this.dateTimePickerProcessingDate.Value.Minute.ToString() + ":"
                    + this.dateTimePickerProcessingDate.Value.Second.ToString();
                R["ProcessingDate"] = Date;
                this.textBoxProcessingDate.Text = Date;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }

        }

        private void buttonProcessingDateDelete_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenProcessingBindingSource.Current;
                R.BeginEdit();
                R["ProcessingDate"] = System.DBNull.Value;
                this.textBoxProcessingDate.Text = null;
                R.EndEdit();
                //System.Windows.Forms.BindingManagerBase BMB = BindingContext[this.dataSetCollectionSpecimen, "CollectionSpecimenProcessing"];
                this.sqlDataAdapterProcessing.Update(this.dataSetCollectionSpecimen.CollectionSpecimenProcessing);
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void dateTimePickerProcessingDuration_CloseUp(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenProcessingBindingSource.Current;
                string Duration = this.dateTimePickerProcessingDuration.Value.Year.ToString() + "-"
                    + this.dateTimePickerProcessingDuration.Value.Month.ToString() + "-"
                    + this.dateTimePickerProcessingDuration.Value.Day.ToString() + " " 
                    + this.dateTimePickerProcessingDuration.Value.Hour.ToString() + ":"
                    + this.dateTimePickerProcessingDuration.Value.Minute.ToString() + ":"
                    + this.dateTimePickerProcessingDuration.Value.Second.ToString();
                R["ProcessingDuration"] = Duration;
                this.textBoxProcessingDuration.Text = Duration;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void comboBoxStorageNotes_SelectionChangeCommitted(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
            R.BeginEdit();
            R["Notes"] = this.comboBoxStorageNotes.SelectedValue.ToString(); ;
            this.textBoxStorageNotes.Text = this.comboBoxStorageNotes.SelectedValue.ToString();
            R.EndEdit();
            //this.textBoxStorageNotes.Text = this.comboBoxStorageNotes.SelectedValue.ToString();
        }

        private void comboBoxStorageNotes_DropDown(object sender, EventArgs e)
        {
            this.comboBoxStorageNotes.DropDownWidth = this.textBoxStorageNotes.Width;
            System.Data.DataTable dt = new DataTable();
            string SQL = "SELECT DISTINCT CollectionSpecimenPart.Notes AS Notes " +
                "FROM CollectionSpecimenPart INNER JOIN " +
                "CollectionSpecimenID_UserAvailable ON " +
                "CollectionSpecimenPart.CollectionSpecimenID = CollectionSpecimenID_UserAvailable.CollectionSpecimenID " +
                "WHERE (CollectionSpecimenPart.Notes LIKE N'" + this.textBoxStorageNotes.Text + "%') " +
                "ORDER BY CollectionSpecimenPart.Notes";
            System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            ad.Fill(dt);
            this.comboBoxStorageNotes.DataSource = dt;
            this.comboBoxStorageNotes.DisplayMember = "Notes";
            this.comboBoxStorageNotes.ValueMember = "Notes";
        }


        #region toolStrip

        private void toolStripButtonCollectionOpen_Click(object sender, EventArgs e)
        {
            System.Data.DataRowView r = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
            int ID = int.Parse(r["CollectionID"].ToString());
            DiversityCollection.FormCollection f = new FormCollection((int?)ID);
            f.ShowDialog();
        }

        private void toolStripButtonProcessingOpen_Click(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenProcessingBindingSource.Current;
            int ID = int.Parse(R["ProcessingID"].ToString());
            DiversityCollection.FormProcessing f = new FormProcessing((int?)ID);
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                if (f.ID != ID)
                {
                    R["ProcessingID"] = f.ID;
                    this.comboBoxProcessingID.Text = this.ProcessingDisplayText(f.ID);
                }
            }
        }

        private void toolStripButtonProcessingDelete_Click(object sender, EventArgs e)
        {
            this.collectionSpecimenProcessingBindingSource.RemoveCurrent();
        }

        #endregion

        #region Hierarchy

        private void addStorageHierarchyChildCollectionNodes(System.Windows.Forms.TreeNode Node, DataTable DtCollections)
        {
            if (Node.Tag != null)
            {
                System.Data.DataRow RN = (System.Data.DataRow)Node.Tag;
                foreach (System.Data.DataRow R in DtCollections.Rows)
                {
                    try
                    {
                        if (R["CollectionParentID"].ToString() == RN["CollectionID"].ToString())
                        {
                            System.Windows.Forms.TreeNode N = new TreeNode(R["CollectionName"].ToString());
                            N.ImageIndex = 0;
                            N.Tag = R;
                            Node.Nodes.Add(N);
                            this.addStorageHierarchyChildCollectionNodes(N, DtCollections);
                        }

                    }
                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                }
            }
        }

        private void fillHierarchyTable(DataRow[] RR,
            ref DataTable DtData, DataTable DtLookup,
            string ColumnID, string ColumnParentID, string ColumnName, string ColumnSecondName)
        {
            foreach (System.Data.DataRow R in RR)
            {
                try
                {
                    System.Data.DataRow[] rCC = DtData.Select(ColumnID + " = " + R[ColumnID].ToString());
                    if (rCC.Length == 0)
                    {
                        foreach (System.Data.DataRow rL in DtLookup.Rows)
                        {
                            if (R[ColumnID].ToString() == rL[ColumnID].ToString())
                            {
                                System.Data.DataRow rn = DtData.NewRow();
                                rn[ColumnID] = R[ColumnID];
                                System.Data.DataRow[] rr = DtLookup.Select(ColumnID + " = " + R[ColumnID].ToString());
                                rn[ColumnName] = rr[0][ColumnName];
                                rn[ColumnParentID] = rr[0][ColumnParentID];
                                if (ColumnSecondName != null)
                                    rn[ColumnSecondName] = rr[0][ColumnSecondName];
                                try { DtData.Rows.Add(rn); }
                                catch { }
                                if (!rn[ColumnParentID].Equals(System.DBNull.Value))
                                {
                                    DataRow[] rrP = DtLookup.Select(ColumnID + " = " + rn[ColumnParentID].ToString());
                                    this.fillHierarchyTable(rrP, ref DtData, DtLookup, ColumnID, ColumnParentID, ColumnName, ColumnSecondName);
                                }
                            }
                        }
                    }

                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }


        private void treeViewStorageHierarchy_AfterSelect(object sender, TreeViewEventArgs e)
        {
            try
            {
                //if (this.treeViewStorageHierarchy.Nodes.Count == 0)
                //{
                //    this.tableLayoutPanelStorage.Enabled = false;
                //    this.tableLayoutPanelProcessing.Enabled = false;
                //    this.toolStripStorageHierarchy.Enabled = true;
                //    this.toolStripButtonStorageDelete.Enabled = false;
                //    this.toolStripButtonCollectionOpen.Enabled = false;
                //    this.toolStripButtonStorageNew.Enabled = true;
                //    this.toolStripProcessing.Enabled = false;
                //    this.toolStripLoan.Enabled = false;
                //}
                //else
                //{
                //    if (this.treeViewStorageHierarchy.SelectedNode == null)
                //    {
                //        this.tableLayoutPanelStorage.Enabled = false;
                //        this.tableLayoutPanelProcessing.Enabled = false;
                //        this.toolStripStorageHierarchy.Enabled = false;
                //        this.toolStripProcessing.Enabled = false;
                //        this.toolStripLoan.Enabled = false;
                //    }
                //    else
                //    {
                //        this.toolStripStorageHierarchy.Enabled = true;
                //        this.toolStripProcessing.Enabled = true;
                //        this.toolStripLoan.Enabled = true;
                //        // getting the node type
                //        string NodeType = "Collection";
                //        if (this.treeViewStorageHierarchy.SelectedNode.Tag != null)
                //        {
                //            System.Data.DataRow R = (System.Data.DataRow)this.treeViewStorageHierarchy.SelectedNode.Tag;
                //            NodeType = R.Table.ToString();
                //        }
                //        //if (treeViewStorageHierarchy.SelectedNode.Parent != null)
                //        //{
                //        //    if (treeViewStorageHierarchy.SelectedNode.ForeColor == System.Drawing.Color.Blue)
                //        //        NodeType = "Processing";
                //        //    else NodeType = "Storage";
                //        //}
                //        switch (NodeType)
                //        {
                //            case "Collection":
                //                this.toolStripButtonStorageDelete.Enabled = false;
                //                this.toolStripButtonCollectionOpen.Enabled = true;
                //                if (this.PermissionStorageInsert) this.toolStripButtonStorageNew.Enabled = true;
                //                else this.toolStripButtonStorageNew.Enabled = false;
                //                this.tableLayoutPanelStorage.Enabled = false;

                //                this.toolStripButtonProcessingOpen.Enabled = false;
                //                this.toolStripButtonProcessingNew.Enabled = false;
                //                this.toolStripButtonProcessingDelete.Enabled = false;
                //                this.tableLayoutPanelProcessing.Enabled = false;

                //                this.toolStripButtonLoanOpen.Enabled = false;
                //                break;
                //            case "CollectionStorage":
                //                this.toolStripButtonCollectionOpen.Enabled = true;
                //                if (this.PermissionStorageInsert) this.toolStripButtonStorageNew.Enabled = true;
                //                else this.toolStripButtonStorageNew.Enabled = false;
                //                if (this.PermissionStorageDelete) this.toolStripButtonStorageDelete.Enabled = true;
                //                else this.toolStripButtonStorageDelete.Enabled = false;
                //                this.tableLayoutPanelStorage.Enabled = true;

                //                this.toolStripButtonProcessingOpen.Enabled = false;
                //                if (this.PermissionProcessingInsert) this.toolStripButtonProcessingNew.Enabled = true;
                //                else this.toolStripButtonProcessingNew.Enabled = false;
                //                this.toolStripButtonProcessingDelete.Enabled = false;
                //                this.tableLayoutPanelProcessing.Enabled = false;
                //                if (treeViewStorageHierarchy.SelectedNode.Tag != null)
                //                {
                //                    System.Data.DataRow R = (System.Data.DataRow)this.treeViewStorageHierarchy.SelectedNode.Tag;
                //                    if (R.Table.ToString() == "CollectionStorage")
                //                    {
                //                        this.moveStorageBinding(R);
                //                        if (R["LoanID"].Equals(System.DBNull.Value)) this.toolStripButtonLoanOpen.Enabled = false;
                //                        else if (this.PermissionStorageUpdate) this.toolStripButtonLoanOpen.Enabled = true;
                //                    }
                //                }
                //                break;
                //            case "CollectionSpecimenProcessing":
                //                this.toolStripButtonStorageDelete.Enabled = false;
                //                this.toolStripButtonCollectionOpen.Enabled = true;
                //                if (this.PermissionStorageInsert) this.toolStripButtonStorageNew.Enabled = true;
                //                else this.toolStripButtonStorageNew.Enabled = false;
                //                this.tableLayoutPanelStorage.Enabled = false;

                //                this.toolStripButtonProcessingOpen.Enabled = true;
                //                if (this.PermissionProcessingInsert) this.toolStripButtonProcessingNew.Enabled = true;
                //                else this.toolStripButtonProcessingNew.Enabled = false;
                //                if (this.PermissionProcessingDelete) this.toolStripButtonProcessingDelete.Enabled = true;
                //                else this.toolStripButtonProcessingDelete.Enabled = false;
                //                this.tableLayoutPanelProcessing.Enabled = true;
                //                if (treeViewStorageHierarchy.SelectedNode.Tag != null)
                //                {
                //                    System.Data.DataRow R = (System.Data.DataRow)this.treeViewStorageHierarchy.SelectedNode.Tag;
                //                    this.moveProcessingBinding(R);
                //                }

                //                this.toolStripButtonLoanOpen.Enabled = false;
                //                break;
                //        }
                //    }
                //}

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void moveStorageBinding(System.Data.DataRow Row)
        {
            //int i = 0;
            //try
            //{
            //    foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionStorage.Rows)
            //    {
            //        if (R[2].ToString() == Row[2].ToString() && R[1].ToString() == Row[1].ToString())
            //            break;
            //        i++;
            //    }
            //    this.collectionStorageBindingSource.Position = i;

            //}
            //catch (Exception ex)
            //{
            //    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            //}
        }

        private void moveProcessingBinding(System.Data.DataRow Row)
        {
            int i = 0;
            try
            {
                foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenProcessing.Rows)
                {
                    if (R[1].ToString() == Row[1].ToString()
                        && R[2].ToString() == Row[2].ToString()
                        && R[3].ToString() == Row[3].ToString()
                        && R[4].ToString() == Row[4].ToString())
                        break;
                    i++;
                }
                this.collectionSpecimenProcessingBindingSource.Position = i;

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void treeViewStorageHierarchy_DragDrop(object sender, DragEventArgs e)
        {

        }

        private void treeViewStorageHierarchy_DragOver(object sender, DragEventArgs e)
        {

        }

        private void treeViewStorageHierarchy_ItemDrag(object sender, ItemDragEventArgs e)
        {

        }

        #endregion

        #region Loan
        private void toolStripButtonLoanOpen_Click(object sender, EventArgs e)
        {
            //try
            //{
            //    int ID = int.Parse(this.dataSetCollectionSpecimen.CollectionStorage.Rows[this.collectionStorageBindingSource.Position]["LoanID"].ToString());
            //    DiversityCollection.FormLoan f = new FormLoan(ID);
            //    f.ShowDialog();
            //    if (f.ChangeToSpecimen && f.CollectionSpecimenID != this.ID)
            //    {
            //        this.setSpecimen(f.CollectionSpecimenID);
            //        return;
            //    }
            //    if (f.DialogResult == DialogResult.OK)
            //    {
            //        System.Data.DataRowView RV = (System.Data.DataRowView)this.collectionStorageBindingSource.Current;
            //        if (RV["LoanID"].ToString() != f.ID.ToString())
            //        {
            //            RV["LoanID"] = f.ID;
            //            this.setSpecimen(this.ID);
            //        }
            //    }

            //}
            //catch (Exception ex)
            //{
            //    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            //}
        }

        private void comboBoxLoan_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                //if (this.comboBoxLoan.SelectedIndex > -1)
                //    this.toolStripButtonLoanOpen.Enabled = true;
                //else
                //    this.toolStripButtonLoanOpen.Enabled = false;

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #region Processing
        private void comboBoxProcessingID_SelectionChangeCommitted(object sender, EventArgs e)
        {
            //System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenProcessingBindingSource.Current;
            //R.BeginEdit();
            //int ID = int.Parse(R["ProcessingID"].ToString());
            //R.EndEdit();
            //int ID = int.Parse(this.comboBoxProcessingID.SelectedValue.ToString());
            //this.comboBoxProcessingID.Text = this.ProcessingDisplayText(ID);
            //this.buildStorageHierarchy();
            //this.buildStorageHierarchy();
            //this.treeViewStorageHierarchy.SelectedNode.Text = this.textBoxProcessingDate.Text + " " + this.ProcessingDisplayText(ID);

        }

        #endregion

        #endregion

        #region Relation

        #region toolStrip

        private void toolStripButtonRelationNew_Click(object sender, EventArgs e)
        {
            //try
            //{
            //    System.Data.DataRow R = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.NewRow();
            //    R["CollectionSpecimenID"] = this.ID;
            //    int i = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows.Count + 1;
            //    R["RelatedSpecimenURI"] = "Related Specimen - " + i.ToString();
            //    R["RelatedSpecimenDisplayText"] = R["RelatedSpecimenURI"];
            //    R["IsInternalRelationCache"] = false;
            //    this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows.Add(R);
            //    this.listBoxRelation.SelectedIndex = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows.Count - 1;

            //}
            //catch (Exception ex)
            //{
            //    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            //}
        }

        private void toolStripButtonRelationDelete_Click(object sender, EventArgs e)
        {
            try
            {
                if (System.Windows.Forms.MessageBox.Show("Do you want to delete relation to\n\r\n\r" + this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows[this.collectionSpecimenRelationBindingSource.Position]["RelatedSpecimenDisplayText"].ToString(), "Delete relation?", MessageBoxButtons.YesNo) == DialogResult.Yes)
                {
                    this.collectionSpecimenRelationBindingSource.RemoveCurrent();
                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenRelation", this.sqlDataAdapterRelation, this.BindingContext);
                }

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonOpenModuleCollection_Click(object sender, EventArgs e)
        {
            //if (listBoxRelation.SelectedIndex > -1)
            //{
            //    try
            //    {
            //        int ID = int.Parse(this.listBoxRelation.SelectedValue.ToString());
            //        DiversityWorkbench.FormRemoteQuery f = new DiversityWorkbench.FormRemoteQuery(ID, (DiversityWorkbench.IWorkbenchUnit)this.CollectionSpecimen);
            //        f.ShowDialog();

            //    }
            //    catch (Exception ex)
            //    {
            //        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            //    }
            //}
        }

        private void toolStripButtonRelationNewInternal_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.FormRemoteQuery f = new DiversityWorkbench.FormRemoteQuery((DiversityWorkbench.IWorkbenchUnit)this.CollectionSpecimen);
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                try
                {
                    System.Data.DataRow R = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.NewRow();
                    R["CollectionSpecimenID"] = this.ID;
                    R["RelatedSpecimenURI"] = f.URI;
                    R["RelatedSpecimenDisplayText"] = f.DisplayText;
                    R["IsInternalRelationCache"] = true;
                    this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows.Add(R);
                    //this.listBoxRelation.SelectedIndex = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows.Count - 1;

                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        #endregion

        private void buttonRelatedSpecimenURL_Click(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenRelationBindingSource.Current;
            DiversityWorkbench.FormWebBrowser f = new DiversityWorkbench.FormWebBrowser(R["RelatedSpecimenURI"].ToString());
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                try
                {
                    this.textBoxRelatedSpecimenURL.Text = f.URL;
                    R.BeginEdit();
                    R["RelatedSpecimenDisplayText"] = f.URL;
                    R["RelatedSpecimenURI"] = f.URL;
                    R.EndEdit();

                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void textBoxRelatedSpecimenURL_KeyUp(object sender, KeyEventArgs e)
        {
            if (this.collectionSpecimenRelationBindingSource.Current != null)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenRelationBindingSource.Current;
                bool Internal;
                try
                {
                    if (bool.TryParse(R["IsInternalRelationCache"].ToString(), out Internal))
                    {
                        if (!Internal)
                        {
                            if (R["RelatedSpecimenURI"].ToString() != this.textBoxRelatedSpecimenURL.Text)
                            {
                                R.BeginEdit();
                                R["RelatedSpecimenURI"] = this.textBoxRelatedSpecimenURL.Text;
                                R["RelatedSpecimenDisplayText"] = R["RelatedSpecimenURI"].ToString();
                                R.EndEdit();
                            }
                        }
                    }

                }
                catch (System.Data.ConstraintException cex)
                {
                    System.Windows.Forms.MessageBox.Show(cex.Message);
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void textBoxRelatedSpecimenURL_TextChanged(object sender, EventArgs e)
        {
            //if (this.collectionSpecimenRelationBindingSource.Current != null)
            //{
            //    System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenRelationBindingSource.Current;
            //    bool Internal;
            //    if (bool.TryParse(R["IsInternalRelationCache"].ToString(), out Internal))
            //    {
            //        if (!Internal)
            //        {
            //            if (R["RelatedSpecimenURI"] != this.textBoxRelatedSpecimenURL.Text)
            //                R["RelatedSpecimenURI"] = this.textBoxRelatedSpecimenURL.Text;
            //            R["RelatedSpecimenDisplayText"] = R["RelatedSpecimenURI"].ToString();
            //        }
            //    }
            //}
        }

        private void listBoxRelation_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.setRelatedSpecimenControls();
        }

        #endregion

        #endregion

        #region Label

        private void comboBoxLabelTitle_DropDown(object sender, EventArgs e)
        {
            string SQL = "SELECT NULL AS LabelTitle UNION SELECT DISTINCT LabelTitle FROM CollectionSpecimen " +
                " WHERE (NOT (LabelTitle IS NULL) AND LEN(LabelTitle) > 0) ";
            if (this.comboBoxLabelTitle.Text.Length > 0) SQL += " AND LabelTitle LIKE '" + this.comboBoxLabelTitle.Text + "%'";
            SQL += " ORDER BY LabelTitle";
            System.Data.DataTable dtLabelTitle = new DataTable();
            try
            {
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dtLabelTitle);
                this.comboBoxLabelTitle.DataSource = dtLabelTitle;
                this.comboBoxLabelTitle.DisplayMember = "LabelTitle";
                this.comboBoxLabelTitle.ValueMember = "LabelTitle";

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void tabPageLabel_Enter(object sender, EventArgs e)
        {
            //this.setCollectionMaterialList();
        }

        #region QR code

        private bool _PrintQRcode = false;

        private void buttonLabelQRcode_Click(object sender, EventArgs e)
        {
            this.SetQrCodeControls();
        }

        private void checkBoxLabelQRcode_Click(object sender, EventArgs e)
        {
            this.SetQrCodeControls();
        }

        private void SetQrCodeControls()
        {
            this._PrintQRcode = !this._PrintQRcode;
            this.checkBoxLabelQRcode.Checked = this._PrintQRcode;
            this.comboBoxLabelQRcode.Enabled = this._PrintQRcode;
            this.comboBoxLabelQRcodeType.Enabled = this._PrintQRcode;
            this.pictureBoxLabelQRcodeSource.Enabled = this._PrintQRcode;

            this.buttonLabelQRcode.Image = DiversityCollection.Resource.QRcode;

        }

        private bool StableIdentifierSettingsComplete()
        {
            bool SpecificationsComplete = true;
            if (!this.userControlQueryList.ProjectIsSelected)// || this.userControlQueryList.ProjectID == null)
            {
                System.Windows.Forms.MessageBox.Show("Please select a project");
                SpecificationsComplete = false;
            }
            else
            {
                string Test = DiversityWorkbench.FormFunctions.SqlExecuteScalar("SELECT dbo.StableIdentifier(" + this.userControlQueryList.ProjectID.ToString() + ", " + this.ID.ToString() + ", NULL, NULL)");
                if (Test.Length == 0)
                {
                    string SQL = "SELECT Project, StableIdentifierBase, StableIdentifierTypeID " +
                        "FROM ProjectProxy AS p " +
                        "WHERE ProjectID = " + this.userControlQueryList.ProjectID.ToString();
                    System.Data.DataTable dt = new DataTable();
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(dt);
                    if (dt.Rows.Count == 1)
                    {
                        if (dt.Rows[0]["StableIdentifierBase"].Equals(System.DBNull.Value)
                            || dt.Rows[0]["StableIdentifierBase"].ToString().Length == 0
                            || dt.Rows[0]["StableIdentifierTypeID"].Equals(System.DBNull.Value))
                        {
                            string Message = "Missing specifications:\r\n";
                            if (dt.Rows[0]["StableIdentifierBase"].Equals(System.DBNull.Value) || dt.Rows[0]["StableIdentifierBase"].ToString().Length == 0)
                                Message += "No base for the stable identifier specified\r\n";
                            if (dt.Rows[0]["StableIdentifierTypeID"].Equals(System.DBNull.Value))
                                Message += "No type for the stable identifier selected\r\n";
                            Message += "Do you want to insert the missing specifications?";
                            if (System.Windows.Forms.MessageBox.Show(Message, "Missing specifications", MessageBoxButtons.YesNo) == System.Windows.Forms.DialogResult.Yes)
                            {
                                DiversityWorkbench.Forms.FormStableIdentifier f = new DiversityWorkbench.Forms.FormStableIdentifier(this.userControlQueryList.ProjectID);//dtProject);
                                f.setHelp("Stable identifier");
                                f.ShowDialog();
                                if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                                {
                                    dt.Clear();
                                    ad.Fill(dt);
                                    if (dt.Rows.Count == 0
                                        || dt.Rows[0]["StableIdentifierBase"].Equals(System.DBNull.Value)
                                        || dt.Rows[0]["StableIdentifierBase"].ToString().Length == 0
                                        || dt.Rows[0]["StableIdentifierTypeID"].Equals(System.DBNull.Value))
                                        SpecificationsComplete = false;
                                }
                                else
                                    SpecificationsComplete = false;
                            }
                            else
                                SpecificationsComplete = false;
                        }
                    }
                    else
                    {
                        SpecificationsComplete = false;
                    }
                }
            }
            if (!SpecificationsComplete)
            {
                this.buttonLabelQRcode.Image = DiversityCollection.Resource.QRcodeGray;
                this.comboBoxLabelQRcode.Items.Clear();
            }
            return SpecificationsComplete;
        }

        private void comboBoxLabelQRcode_DropDown(object sender, EventArgs e)
        {
            if (this.comboBoxLabelQRcode.Items.Count == 0)
            {
                this.comboBoxLabelQRcode.Items.Add("");
                this.comboBoxLabelQRcode.Items.Add(DiversityCollection.XmlExport.QRcodeSource.AccessionNumber);
                this.comboBoxLabelQRcode.Items.Add(DiversityCollection.XmlExport.QRcodeSource.CollectorsEventNumber);
                this.comboBoxLabelQRcode.Items.Add(DiversityCollection.XmlExport.QRcodeSource.DepositorsAccessionNumber);
                this.comboBoxLabelQRcode.Items.Add(DiversityCollection.XmlExport.QRcodeSource.ExternalIdentifier);
                this.comboBoxLabelQRcode.Items.Add(DiversityCollection.XmlExport.QRcodeSource.PartAccessionNumber);
                this.comboBoxLabelQRcode.Items.Add(DiversityCollection.XmlExport.QRcodeSource.StableIdentifier);
                this.comboBoxLabelQRcode.Items.Add(DiversityCollection.XmlExport.QRcodeSource.StorageLocation);
                this.comboBoxLabelQRcode.Items.Add(DiversityCollection.XmlExport.QRcodeSource.GUID);
            }
        }

        private void comboBoxLabelQRcode_SelectionChangeCommitted(object sender, EventArgs e)
        {
            this.comboBoxLabelQRcodeType.Items.Clear();
            this.comboBoxLabelQRcodeType.Text = "";
            this.comboBoxLabelQRcodeType.Enabled = false;
            if (this.comboBoxLabelQRcode.SelectedItem.ToString() == DiversityCollection.XmlExport.QRcodeSource.AccessionNumber.ToString())
            {
                this.pictureBoxLabelQRcodeSource.Image = DiversityCollection.Resource.CollectionSpecimen;
            }
            else if (this.comboBoxLabelQRcode.SelectedItem.ToString() == DiversityCollection.XmlExport.QRcodeSource.CollectorsEventNumber.ToString())
            {
                this.pictureBoxLabelQRcodeSource.Image = DiversityCollection.Resource.Event;
            }
            else if (this.comboBoxLabelQRcode.SelectedItem.ToString() == DiversityCollection.XmlExport.QRcodeSource.DepositorsAccessionNumber.ToString())
            {
                this.pictureBoxLabelQRcodeSource.Image = DiversityCollection.Resource.CollectionSpecimen;
            }
            else if (this.comboBoxLabelQRcode.SelectedItem.ToString() == DiversityCollection.XmlExport.QRcodeSource.ExternalIdentifier.ToString())
            {
                this.pictureBoxLabelQRcodeSource.Image = DiversityCollection.Resource.Identifier;
                this.comboBoxLabelQRcodeType.Items.Add("");
                System.Data.DataTable dt = new DataTable();
                string SQL = "SELECT Type FROM ExternalIdentifierType ORDER BY Type";
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                if (dt.Rows.Count > 0)
                {
                    foreach (System.Data.DataRow R in dt.Rows)
                        this.comboBoxLabelQRcodeType.Items.Add(R[0].ToString());
                    this.comboBoxLabelQRcodeType.Enabled = true;
                }
            }
            else if (this.comboBoxLabelQRcode.SelectedItem.ToString() == DiversityCollection.XmlExport.QRcodeSource.PartAccessionNumber.ToString())
            {
                this.pictureBoxLabelQRcodeSource.Image = DiversityCollection.Resource.Specimen;
            }
            else if (this.comboBoxLabelQRcode.SelectedItem.ToString() == DiversityCollection.XmlExport.QRcodeSource.StableIdentifier.ToString())
            {
                this.pictureBoxLabelQRcodeSource.Image = DiversityCollection.Resource.QRcode;
                if (this.StableIdentifierSettingsComplete())
                {
                    this.comboBoxLabelQRcodeType.Items.Add("");
                    this.comboBoxLabelQRcodeType.Items.Add(DiversityCollection.XmlExport.QRcodeStableIdentifierType.AccessionNumber.ToString());
                    this.comboBoxLabelQRcodeType.Items.Add(DiversityCollection.XmlExport.QRcodeStableIdentifierType.SpecimenID.ToString());
                    this.comboBoxLabelQRcodeType.Items.Add(DiversityCollection.XmlExport.QRcodeStableIdentifierType.Units.ToString());
                    this.comboBoxLabelQRcodeType.Items.Add(DiversityCollection.XmlExport.QRcodeStableIdentifierType.UnitsInPart.ToString());
                    this.comboBoxLabelQRcodeType.Enabled = true;
                }
                else
                {
                    //this.checkBoxLabelQRcode_Click(null, null);
                    this.checkBoxLabelQRcode.Checked = false;
                    this.SetQrCodeControls();
                }
            }
            else if (this.comboBoxLabelQRcode.SelectedItem.ToString() == DiversityCollection.XmlExport.QRcodeSource.StorageLocation.ToString())
            {
                this.pictureBoxLabelQRcodeSource.Image = DiversityCollection.Resource.Specimen;
            }
            else if (this.comboBoxLabelQRcode.SelectedItem.ToString() == DiversityCollection.XmlExport.QRcodeSource.GUID.ToString())
            {
                this.pictureBoxLabelQRcodeSource.Image = DiversityCollection.Resource.QRcode;
            }

        }

        private string StableIdentifierSpecimen(int SpecimenID, int UnitID, int? PartID)
        {
            if (!this.userControlQueryList.ProjectIsSelected)
            {
                System.Windows.Forms.MessageBox.Show("Please select a project");
                return "";
            }
            string SIS = "";
            string SQL = "SELECT [dbo].[StableIdentifier] (" + this.userControlQueryList.ProjectID.ToString() +
                ", " + SpecimenID.ToString() + ", " + UnitID.ToString() + ", ";
            if (PartID == null) SQL += "NULL)";
            else SQL += PartID.ToString() + ")";
            SIS = DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL);
            return SIS;
        }
        
        #endregion

        #region XML Export

        private string createXmlFromDataset(DiversityCollection.Datasets.DataSetCollectionSpecimen dsSpecimen,
            DiversityCollection.Datasets.DataSetCollectionEventSeries dsEventSeries, bool MultiLabelPrint)
        {
            string XmlFile = System.Windows.Forms.Application.StartupPath + "\\LabelPrinting\\Label.XML";
            try
            {
                System.Data.DataRow RR;
                DiversityCollection.XmlExport Export;
                int Duplicates;
                bool LabelForSpecimen = true;
                System.Data.DataRow RowToPrint;
                int? PartID = null;
                if (this.treeViewOverviewHierarchyStorage.SelectedNode == null && this.treeViewOverviewHierarchy.SelectedNode != null)
                    RR = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                else if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                    RR = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                else if (this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows.Count == 1)
                    RR = this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows[0];
                else
                {
                    System.Windows.Forms.MessageBox.Show("Please select the item that should be printed in a label");
                    return "";
                }
                string Table = RR.Table.TableName;
                switch (Table)
                {
                    case "CollectionSpecimen":
                        if (this.treeViewOverviewHierarchyStorage.SelectedNode == null && this.treeViewOverviewHierarchy.SelectedNode != null)
                            RowToPrint = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        else if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                            RowToPrint = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        else if (this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows.Count == 1)
                            RowToPrint = this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows[0];
                        else
                            return "";
                        break;
                    case "CollectionSpecimenPart":
                    case "IdentificationUnitInPart":
                        if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                            RowToPrint = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        else if (this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows.Count == 1)
                            RowToPrint = this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows[0];
                        else return "";
                        PartID = int.Parse(RowToPrint["SpecimenPartID"].ToString());
                        LabelForSpecimen = false;
                        break;
                    default:
                        if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                            RowToPrint = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        else if (this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows.Count > 0)
                            RowToPrint = this.dataSetCollectionSpecimen.CollectionSpecimenPart[0];
                        else
                            return "";
                        break;
                }
                if (this.textBoxSchemaFile.Tag == null) this.textBoxSchemaFile.Tag = "";
                if (this.textBoxSchemaFile.Text.Length == 0) this.textBoxSchemaFile.Tag = "";
                Export = new XmlExport(this.textBoxSchemaFile.Tag.ToString(), XmlFile, dsSpecimen, dsEventSeries);
                Duplicates = 1;
                int.TryParse(this.toolStripTextBoxPrintDuplicates.Text, out Duplicates);
                if (RowToPrint != null)
                {
                    bool RestrictToCollection = true;
                    if (!this.checkBoxPrintRestrictToCollection.Visible) RestrictToCollection = false;
                    if (!this.checkBoxPrintRestrictToCollection.Checked) RestrictToCollection = false;

                    bool RestrictToMaterial = true;
                    if (!this.checkBoxPrintRestrictToMaterial.Visible) RestrictToMaterial = false;
                    if (!this.checkBoxPrintRestrictToMaterial.Checked) RestrictToMaterial = false;

                    XmlExport.QRcodeSource QRsource = XmlExport.QRcodeSource.None;
                    if (this.comboBoxLabelQRcode.SelectedItem != null)
                    {
                        if (this.comboBoxLabelQRcode.SelectedItem.ToString() == "AccessionNumber")
                            QRsource = XmlExport.QRcodeSource.AccessionNumber;
                        else if (this.comboBoxLabelQRcode.SelectedItem.ToString() == "CollectorsEventNumber")
                            QRsource = XmlExport.QRcodeSource.CollectorsEventNumber;
                        else if (this.comboBoxLabelQRcode.SelectedItem.ToString() == "DepositorsAccessionNumber")
                            QRsource = XmlExport.QRcodeSource.DepositorsAccessionNumber;
                        else if (this.comboBoxLabelQRcode.SelectedItem.ToString() == "ExternalIdentifier")
                            QRsource = XmlExport.QRcodeSource.ExternalIdentifier;
                        else if (this.comboBoxLabelQRcode.SelectedItem.ToString() == "PartAccessionNumber")
                            QRsource = XmlExport.QRcodeSource.PartAccessionNumber;
                        else if (this.comboBoxLabelQRcode.SelectedItem.ToString() == "StableIdentifier")
                            QRsource = XmlExport.QRcodeSource.StableIdentifier;
                        else if (this.comboBoxLabelQRcode.SelectedItem.ToString() == "StorageLocation")
                            QRsource = XmlExport.QRcodeSource.StorageLocation;
                        else if (this.comboBoxLabelQRcode.SelectedItem.ToString() == "GUID")
                            QRsource = XmlExport.QRcodeSource.GUID;
                        else if (this.comboBoxLabelQRcode.SelectedItem.ToString() == "")
                            QRsource = XmlExport.QRcodeSource.None;
                    }
                    string QRtype = "";
                    if (this.comboBoxLabelQRcodeType.SelectedItem != null)
                        QRtype = this.comboBoxLabelQRcodeType.SelectedItem.ToString();
                    return Export.createXmlFromDatasets(this.textBoxReportTitle.Text,
                        QRsource,
                        QRtype,
                        RowToPrint,
                        this.userControlQueryList.ProjectID,
                        Duplicates,
                        MultiLabelPrint,
                        LabelForSpecimen,
                        RestrictToCollection,
                        RestrictToMaterial,
                        this.checkBoxUseStockForLabelDuplicates.Checked,
                        DiversityCollection.Transaction.ConversionTypeFormString(this.comboBoxLabelConversion.Text));
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            return XmlFile;
        }

        #endregion

        #endregion
       
        #region Properties

        internal DiversityCollection.CollectionSpecimen CollectionSpecimen
        {
            get
            {
                DiversityCollection.CollectionSpecimen C = new CollectionSpecimen(this.ServerConnection);
                return C;
                //if (this._CollectionSpecimen == null)
                //    this._CollectionSpecimen = new CollectionSpecimen(this.ServerConnection);
                //return _CollectionSpecimen; 
            }
            //set { _CollectionSpecimen = value; }
        }

        public int ID { get { return this.SpecimenID; } }

        public int SpecimenID
        {
            get
            {
                int ID = -1;
                try
                {
                    if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count > 0)
                        ID = System.Int32.Parse(this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionSpecimenID"].ToString());
                }
                catch  {  }                
                return ID;
            }
        }

        public int EventID
        {
            get
            {
                int ID = -1;
                if (this.dataSetCollectionSpecimen.CollectionEvent.Rows.Count > 0)
                    ID = System.Int32.Parse(this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionEventID"].ToString());
                return ID;
            }
        }

        public int? SeriesID
        {
            get
            {
                if (this._SeriesID != null)
                {
                    this.textBoxEventSeriesID.Text = this._SeriesID.ToString();
                    return this._SeriesID;
                }
                else
                {
                    if (this.dataSetCollectionEventSeries.CollectionEventSeries.Rows.Count > 0)
                    {
                        System.Windows.Forms.BindingManagerBase BMB = this.BindingContext[this.dataSetCollectionEventSeries, "CollectionEventSeries"];
                        int p = BMB.Position;
                        int ID = -1;
                        if (this.dataSetCollectionEventSeries.CollectionEventSeries.Rows.Count > 0)
                        {
                            ID = System.Int32.Parse(this.dataSetCollectionEventSeries.CollectionEventSeries.Rows[p]["SeriesID"].ToString());
                            this._SeriesID = ID;
                            this.textBoxEventSeriesID.Text = this._SeriesID.ToString();
                        }
                        else
                            this.textBoxEventSeriesID.Text = "";
                        return (int?)ID;
                    }

                    else
                    {
                        this.textBoxEventSeriesID.Text = "";
                        return null;
                    }
                }
            }
        }

        public DiversityWorkbench.ServerConnection ServerConnection
        {
            get
            {
                DiversityWorkbench.ServerConnection S = DiversityWorkbench.Settings.ServerConnection;
                return S;
                //if (this._ServerConnection == null)
                //{
                //    this._ServerConnection = DiversityWorkbench.Settings.ServerConnection;
                //}
                //return _ServerConnection; 
            }
            //set { _ServerConnection = value; }
        }

        public System.Windows.Forms.HelpProvider HelpProvider { get { return this.helpProviderDiversityCollection; } }

        private bool ShowExistingImages { get { return this.showExistingImagesToolStripMenuItem.Checked; } }

        public void ResetIDs()
        {
            this.userControlQueryList.ResetListOfIDs();
        }

        public System.Collections.Generic.List<int> IDs
        {
            get { return this.userControlQueryList.ListOfIDs; }
        }

        public System.Collections.Generic.List<int> selectedIDs
        {
            get { return this.userControlQueryList.ListOfSelectedIDs; }
        }


        #endregion

        #region History

        private void buttonHeaderHistory_Click(object sender, EventArgs e)
        {

            if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select any data");
                return;
            }
            string Title = "History of " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString() + " (SpecimenID: " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionSpecimenID"].ToString() + ")";
#if DEBUG

            try
            {
                System.Collections.Generic.Dictionary<string, int> Keys = new Dictionary<string, int>();
                System.Collections.Generic.Dictionary<string, DiversityWorkbench.LogDatabase.HistoryTable> HistoryTables = DiversityWorkbench.LogDatabase.Database.HistoryTables(Keys);
                if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].Equals(System.DBNull.Value))
                {
                    Keys.Add("CollectionEventID", EventID);

                    DiversityWorkbench.LogDatabase.HistoryTable HannoEvent = new DiversityWorkbench.LogDatabase.HistoryTable(EventID, "ReferencedID", "Annnotation", "", true, true, "ReferencedTable = 'CollectionEventID'");
                    HannoEvent.FillTable();
                    if (HannoEvent.DataTable().Rows.Count > 0)
                        HistoryTables.Add(HannoEvent.Name(), HannoEvent);
                }
                Keys.Add("CollectionSpecimenID", this.SpecimenID);
                System.Collections.Generic.Dictionary<string, DiversityWorkbench.LogDatabase.HistoryTable> LogTables = DiversityWorkbench.LogDatabase.Database.HistoryTables(Keys);
                foreach(System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.LogDatabase.HistoryTable> HT in LogTables)
                {
                    if (HT.Key != "CollectionSpecimen" && (HT.Key.StartsWith("CollectionSpecimen") || HT.Key.StartsWith("Identification")))
                        HT.Value.setVersionTable("CollectionSpecimen");
                    if (HT.Key != "CollectionEvent" && HT.Key.StartsWith("CollectionEvent"))
                        HT.Value.setVersionTable("CollectionEvent");
                    HT.Value.FillTable();
                    if (HT.Value.DataTable().Rows.Count > 0)
                        HistoryTables.Add(HT.Key, HT.Value);
                }

                DiversityWorkbench.LogDatabase.HistoryTable HannoSpec = new DiversityWorkbench.LogDatabase.HistoryTable(this.SpecimenID, "ReferencedID", "Annnotation", "", true, true, "ReferencedTable = 'CollectionSpecimen'");
                HannoSpec.FillTable();
                if (HannoSpec.DataTable().Rows.Count > 0)
                    HistoryTables.Add(HannoSpec.Name(), HannoSpec);

                if (HistoryTables.ContainsKey("IdentificationUnit"))
                {
                    DiversityWorkbench.LogDatabase.HistoryTable HannoUnit = new DiversityWorkbench.LogDatabase.HistoryTable(-1, "ReferencedID", "Annnotation", "", true, true, "ReferencedTable = 'IdentificationUnit'");
                    foreach (System.Data.DataRow R in (HistoryTables["IdentificationUnit"].DataTable().Rows))
                    {
                        int UnitID;
                        if (int.TryParse(R["IdentificationUnitID"].ToString(), out UnitID))
                        {
                            HannoUnit.setID(UnitID);
                            HannoUnit.FillTable();
                        }
                    }
                    if (HannoUnit.DataTable().Rows.Count > 0)
                    {
                        HistoryTables.Add(HannoUnit.Name(), HannoUnit);
                    }
                }

                if (HistoryTables.ContainsKey("CollectionSpecimenPart"))
                {
                    DiversityWorkbench.LogDatabase.HistoryTable HannoPart = new DiversityWorkbench.LogDatabase.HistoryTable(-1, "ReferencedID", "Annnotation", "", true, true, "ReferencedTable = 'CollectionSpecimenPart'");
                    foreach (System.Data.DataRow R in (HistoryTables["CollectionSpecimenPart"].DataTable().Rows))
                    {
                        int PartID;
                        if (int.TryParse(R["SpecimenPartID"].ToString(), out PartID))
                        {
                            HannoPart.setID(PartID);
                            HannoPart.FillTable();
                        }
                    }
                    if (HannoPart.DataTable().Rows.Count > 0)
                    {
                        HistoryTables.Add(HannoPart.Name(), HannoPart);
                    }
                }
                DiversityWorkbench.FormHistory f = new DiversityWorkbench.FormHistory(Title, LogTables, System.Windows.Forms.Application.StartupPath + "\\DiversityCollection.chm");
                f.SetRestoreRootTables(this.RestoreRootTables());// RootTables);
                f.setHelpProviderNameSpace(System.Windows.Forms.Application.StartupPath + "\\DiversityCollection.chm", "History");
                f.ShowDialog();
                if (f.DataRestored)
                    this.setSpecimen(this.ID);
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
#else
            try
            {
                System.Collections.Generic.List<System.Data.DataTable> LogTables = new List<DataTable>();
                LogTables.Add(this.dtCollectionSpecimenHistory);
                LogTables.Add(this.dtCollectionEventHistory);
                if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].Equals(System.DBNull.Value))
                {
                    LogTables.Add(this.dtCollectionEventImageHistory);
                    LogTables.Add(DiversityWorkbench.Database.DtHistory(EventID, "CollectionEventID", this.dataSetCollectionSpecimen.CollectionEventLocalisation.TableName, this.dataSetCollectionSpecimen.CollectionEvent.TableName));
                    LogTables.Add(DiversityWorkbench.Database.DtHistory(EventID, "CollectionEventID", this.dataSetCollectionSpecimen.CollectionEventProperty.TableName, this.dataSetCollectionSpecimen.CollectionEvent.TableName));
                    LogTables.Add(DiversityWorkbench.Database.DtHistory(EventID, "CollectionEventID", this.dataSetCollectionSpecimen.CollectionEventMethod.TableName, this.dataSetCollectionSpecimen.CollectionEvent.TableName));
                    LogTables.Add(DiversityWorkbench.Database.DtHistory(EventID, "CollectionEventID", this.dataSetCollectionSpecimen.CollectionEventParameterValue.TableName, this.dataSetCollectionSpecimen.CollectionEvent.TableName));
                }

                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.CollectionAgent.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));

                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.CollectionProject.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));
                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.CollectionSpecimenImage.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));

                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.CollectionSpecimenReference.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));
                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.CollectionSpecimenRelation.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));
                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.CollectionSpecimenPart.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));
                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.CollectionSpecimenProcessing.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));
                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethod.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));
                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameter.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));

                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.IdentificationUnit.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));
                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.Identification.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));
                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));
                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysis.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));
                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.IdentificationUnitInPart.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));

                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethod.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));
                LogTables.Add(DiversityWorkbench.Database.DtHistory(this.SpecimenID, "CollectionSpecimenID", this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.TableName, this.dataSetCollectionSpecimen.CollectionSpecimen.TableName));

                // Identifer
                try
                {
                    if (this.dataSetCollectionSpecimen.ExternalIdentifier.Rows.Count > 0)
                        LogTables.Add(DiversityWorkbench.Database.DtHistory(this.dataSetCollectionSpecimen.ExternalIdentifier));
                }
                catch (System.Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }


                // Annotation
                try
                {
                    if (this.dataSetCollectionSpecimen.Annotation.Rows.Count > 0)
                        LogTables.Add(DiversityWorkbench.Database.DtHistory(this.dataSetCollectionSpecimen.Annotation));
                }
                catch (System.Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }

                if (this.dataSetCollectionEventSeries.CollectionEventSeries.Rows.Count > 0)
                    LogTables.Add(this.dtCollectionEventSeriesHistory);
                if (this.dataSetCollectionEventSeries.CollectionEventSeriesImage.Rows.Count > 0)
                    LogTables.Add(this.dtCollectionEventSeriesImageHistory);

                DiversityWorkbench.FormHistory f = new DiversityWorkbench.FormHistory(Title, LogTables, System.Windows.Forms.Application.StartupPath + "\\DiversityCollection.chm");
                f.SetRestoreRootTables(this.RestoreRootTables());// RootTables);
                f.setHelpProviderNameSpace(System.Windows.Forms.Application.StartupPath + "\\DiversityCollection.chm", "History");
                f.ShowDialog();
                if (f.DataRestored)
                    this.setSpecimen(this.ID);
            }

            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
#endif
        }

        private System.Collections.Generic.Dictionary<string, System.Collections.Generic.List<string>> RestoreRootTables()
        {
            System.Collections.Generic.Dictionary<string, System.Collections.Generic.List<string>> RootTables = new Dictionary<string, List<string>>();
            System.Collections.Generic.List<string> SpecimenTables = new List<string>();

            System.Data.DataTable dt = new DataTable();
            string Message = "";
            string SQL = "select T.TABLE_NAME from  INFORMATION_SCHEMA.TABLES T " +
                "where T.TABLE_TYPE = 'BASE TABLE' " +
                "and T.TABLE_SCHEMA = 'dbo' " +
                "and T.TABLE_NAME = 'Identification' " +
                "order by T.TABLE_NAME";
            dt.Clear();
            DiversityWorkbench.FormFunctions.SqlFillTable(SQL, ref dt, ref Message);
            foreach (System.Data.DataRow R in dt.Rows)
            {
                if (!SpecimenTables.Contains(R[0].ToString()))
                    SpecimenTables.Add(R[0].ToString());
            }
            RootTables.Add("Identification", SpecimenTables);

            SQL = "select T.TABLE_NAME from  INFORMATION_SCHEMA.TABLES T " +
                "where T.TABLE_TYPE = 'BASE TABLE' " +
                "and T.TABLE_SCHEMA = 'dbo' " +
                "and T.TABLE_NAME = 'IdentificationUnitGeoAnalysis' " +
                "order by T.TABLE_NAME";
            dt.Clear();
            DiversityWorkbench.FormFunctions.SqlFillTable(SQL, ref dt, ref Message);
            foreach (System.Data.DataRow R in dt.Rows)
            {
                if (!SpecimenTables.Contains(R[0].ToString()))
                    SpecimenTables.Add(R[0].ToString());
            }
            RootTables.Add("IdentificationUnitGeoAnalysis", SpecimenTables);

            SQL = "select T.TABLE_NAME from  INFORMATION_SCHEMA.TABLES T " +
                "where T.TABLE_TYPE = 'BASE TABLE' " +
                "and T.TABLE_SCHEMA = 'dbo' " +
                "and (T.TABLE_NAME = 'Annotation' or T.TABLE_NAME = 'ExternalIdentifier' or T.TABLE_NAME like 'Identification%') " +
                "and not T.TABLE_NAME like '%_Enum' " +
                "and not T.TABLE_NAME like '%_log' " +
                "and not T.TABLE_NAME like '%_log_%' " +
                "order by T.TABLE_NAME";
            dt.Clear();
            DiversityWorkbench.FormFunctions.SqlFillTable(SQL, ref dt, ref Message);
            foreach (System.Data.DataRow R in dt.Rows)
            {
                if (!SpecimenTables.Contains(R[0].ToString()))
                    SpecimenTables.Add(R[0].ToString());
            }
            RootTables.Add("IdentificationUnit", SpecimenTables);

            SQL = "select T.TABLE_NAME from  INFORMATION_SCHEMA.TABLES T " +
                "where T.TABLE_TYPE = 'BASE TABLE' " +
                "and T.TABLE_SCHEMA = 'dbo' " +
                "and (T.TABLE_NAME = 'Annotation' or T.TABLE_NAME = 'ExternalIdentifier' or T.TABLE_NAME like 'CollectionSpecimen%' or T.TABLE_NAME = 'CollectionAgent' or T.TABLE_NAME = 'CollectionProject' or T.TABLE_NAME like 'Identification%') " +
                "and not T.TABLE_NAME like '%_Enum' " +
                "and not T.TABLE_NAME like '%_log' " +
                "and not T.TABLE_NAME like '%_log_%' " +
                "order by T.TABLE_NAME";
            DiversityWorkbench.FormFunctions.SqlFillTable(SQL, ref dt, ref Message);
            foreach (System.Data.DataRow R in dt.Rows)
                SpecimenTables.Add(R[0].ToString());
            RootTables.Add("CollectionSpecimen", SpecimenTables);

            SQL = "select T.TABLE_NAME from  INFORMATION_SCHEMA.TABLES T " +
                "where T.TABLE_TYPE = 'BASE TABLE' " +
                "and T.TABLE_SCHEMA = 'dbo' " +
                "and (T.TABLE_NAME = 'Annotation' or T.TABLE_NAME = 'ExternalIdentifier' or T.TABLE_NAME like 'CollectionEvent%') " +
                "and not T.TABLE_NAME like '%_Enum' " +
                "and not T.TABLE_NAME like '%_log' " +
                "and not T.TABLE_NAME like '%_log_%' " +
                "order by T.TABLE_NAME";
            dt.Clear();
            DiversityWorkbench.FormFunctions.SqlFillTable(SQL, ref dt, ref Message);
            foreach (System.Data.DataRow R in dt.Rows)
                SpecimenTables.Add(R[0].ToString());
            RootTables.Add("CollectionEvent", SpecimenTables);

            SQL = "select T.TABLE_NAME from  INFORMATION_SCHEMA.TABLES T " +
                "where T.TABLE_TYPE = 'BASE TABLE' " +
                "and T.TABLE_SCHEMA = 'dbo' " +
                "and (T.TABLE_NAME = 'Annotation' or T.TABLE_NAME = 'ExternalIdentifier' or T.TABLE_NAME like 'CollectionEventSeries%') " +
                "and not T.TABLE_NAME like '%_Enum' " +
                "and not T.TABLE_NAME like '%_log' " +
                "and not T.TABLE_NAME like '%_log_%' " +
                "order by T.TABLE_NAME";
            dt.Clear();
            DiversityWorkbench.FormFunctions.SqlFillTable(SQL, ref dt, ref Message);
            foreach (System.Data.DataRow R in dt.Rows)
            {
                if (!SpecimenTables.Contains(R[0].ToString()))
                    SpecimenTables.Add(R[0].ToString());
            }
            RootTables.Add("CollectionEventSeries", SpecimenTables);

            return RootTables;
        }

        private System.Data.DataTable dtCollectionSpecimenHistory
        {
            get
            {
                System.Data.DataTable dtCollectionSpecimen_Log = new DataTable("Collection specimen");
                string SqlCurrent = "SELECT CollectionSpecimen.Version, CollectionSpecimen.AccessionNumber, CollectionSpecimen.AccessionDate, CollectionSpecimen.AccessionDay,  " +
                      "CollectionSpecimen.AccessionMonth, CollectionSpecimen.AccessionYear, CollectionSpecimen.AccessionDateSupplement,  " +
                      "CollDateCategory_Enum.DisplayText AS AccessionDateCategory, CollectionSpecimen.DepositorsName, CollectionSpecimen.DepositorsAgentURI,  " +
                      "CollectionSpecimen.DepositorsAccessionNumber, CollectionSpecimen.LabelTitle, CollLabelType_Enum.DisplayText AS LabelType,  " +
                      "CollLabelTranscriptionState_Enum.DisplayText AS LabelTranscriptionState, CollectionSpecimen.LabelTranscriptionNotes,  " +
                      "CollectionSpecimen.ExsiccataURI, CollectionSpecimen.ExsiccataAbbreviation, CollectionSpecimen.OriginalNotes, CollectionSpecimen.AdditionalNotes,  " +
                      "CollectionSpecimen.InternalNotes, CollectionSpecimen.ReferenceTitle, CollectionSpecimen.ReferenceURI, CollectionSpecimen.Problems,  " +
                      "CollectionSpecimen.DataWithholdingReason, " +
                      "'current version' AS KindOfChange, convert(varchar(20), CollectionSpecimen.LogUpdatedWhen, 120) AS DateOfChange,  " +
                      "CollectionSpecimen.LogUpdatedBy AS ResponsibleUser, NULL AS LogID " +
                      "FROM CollectionSpecimen LEFT OUTER JOIN " +
                      "CollLabelTranscriptionState_Enum ON CollectionSpecimen.LabelTranscriptionState = CollLabelTranscriptionState_Enum.Code LEFT OUTER JOIN " +
                      "CollLabelType_Enum ON CollectionSpecimen.LabelType = CollLabelType_Enum.Code LEFT OUTER JOIN " +
                      "CollDateCategory_Enum ON CollectionSpecimen.AccessionDateCategory = CollDateCategory_Enum.Code " +
                      "WHERE (CollectionSpecimen.CollectionSpecimenID = " + this.SpecimenID.ToString() + ") ";
                string SQL = "SELECT CollectionSpecimen_log.Version, CollectionSpecimen_log.AccessionNumber, CollectionSpecimen_log.AccessionDate, CollectionSpecimen_log.AccessionDay,  " +
                      "CollectionSpecimen_log.AccessionMonth, CollectionSpecimen_log.AccessionYear, CollectionSpecimen_log.AccessionDateSupplement,  " +
                      "CollDateCategory_Enum.DisplayText AS AccessionDateCategory, CollectionSpecimen_log.DepositorsName, CollectionSpecimen_log.DepositorsAgentURI,  " +
                      "CollectionSpecimen_log.DepositorsAccessionNumber, CollectionSpecimen_log.LabelTitle, CollLabelType_Enum.DisplayText AS LabelType,  " +
                      "CollLabelTranscriptionState_Enum.DisplayText AS LabelTranscriptionState, CollectionSpecimen_log.LabelTranscriptionNotes,  " +
                      "CollectionSpecimen_log.ExsiccataURI, CollectionSpecimen_log.ExsiccataAbbreviation, CollectionSpecimen_log.OriginalNotes, CollectionSpecimen_log.AdditionalNotes,  " +
                      "CollectionSpecimen_log.InternalNotes, CollectionSpecimen_log.ReferenceTitle, CollectionSpecimen_log.ReferenceURI, CollectionSpecimen_log.Problems,  " +
                      "CollectionSpecimen_log.DataWithholdingReason, " +
                      "CASE WHEN LogState = 'U' THEN 'UPDATE' ELSE 'DELETE' END AS KindOfChange, convert(varchar(20), LogDate, 120) AS DateOfChange, LogUser AS ResponsibleUser, LogID " +
                      "FROM CollectionSpecimen_log LEFT OUTER JOIN " +
                      "CollLabelTranscriptionState_Enum ON CollectionSpecimen_log.LabelTranscriptionState = CollLabelTranscriptionState_Enum.Code LEFT OUTER JOIN " +
                      "CollLabelType_Enum ON CollectionSpecimen_log.LabelType = CollLabelType_Enum.Code LEFT OUTER JOIN " +
                      "CollDateCategory_Enum ON CollectionSpecimen_log.AccessionDateCategory = CollDateCategory_Enum.Code " +
                      "WHERE (CollectionSpecimen_log.CollectionSpecimenID = " + this.SpecimenID.ToString() + ") ORDER BY LogID DESC ";
                try
                {
                    System.Data.SqlClient.SqlDataAdapter a = new System.Data.SqlClient.SqlDataAdapter(SqlCurrent, DiversityWorkbench.Settings.ConnectionString);
                    a.Fill(dtCollectionSpecimen_Log);
                    a.SelectCommand.CommandText = SQL;
                    a.Fill(dtCollectionSpecimen_Log);
                }

                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
                return dtCollectionSpecimen_Log;
            }
        }

        private System.Data.DataTable dtCollectionEventLocalisationHistory
        {
            get
            {
                System.Data.DataTable dtCollectionEventLocalisation_Log = new DataTable("CollectionEventLocalisation");
                string SqlCurrent = "SELECT CollectionEvent.Version, LocalisationSystem.LocalisationSystemName AS [Localisation system],  " +
                    "LocalisationSystem.DisplayTextLocation1 + ': ' + CollectionEventLocalisation.Location1 AS [Value 1],  " +
                    "LocalisationSystem.DisplayTextLocation2 + ': ' + CollectionEventLocalisation.Location2 AS [Value 2], CollectionEventLocalisation.LocationAccuracy AS Accuracy,  " +
                    "CollectionEventLocalisation.LocationNotes AS Notes, CollectionEventLocalisation.DeterminationDate AS [Determination date],  " +
                    "CollectionEventLocalisation.DistanceToLocation AS [Distance to location], CollectionEventLocalisation.DirectionToLocation AS [Direction to location],  " +
                    "CollectionEventLocalisation.ResponsibleName AS [Responsible User], CollectionEventLocalisation.ResponsibleAgentURI AS [Responsible agent URI],  " +
                    "CollectionEventLocalisation.AverageAltitudeCache AS [Altitude cache], CollectionEventLocalisation.AverageLatitudeCache AS [Latitude cache],  " +
                    "CollectionEventLocalisation.AverageLongitudeCache AS [Longitude cache], " +
                    "'current version' AS [Kind of change], convert(varchar(20), CollectionEventLocalisation.LogUpdatedWhen, 120) AS [Date of change],  " +
                    "CollectionEventLocalisation.LogUpdatedBy AS [Responsible user], NULL AS LogID " +
                    "FROM CollectionEventLocalisation INNER JOIN " +
                    "CollectionEvent ON CollectionEventLocalisation.CollectionEventID = CollectionEvent.CollectionEventID INNER JOIN " +
                    "LocalisationSystem ON CollectionEventLocalisation.LocalisationSystemID = LocalisationSystem.LocalisationSystemID " +
                    "WHERE CollectionEventLocalisation.CollectionEventID = " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].ToString();
                string SQL = "SELECT CollectionEventLocalisation_Log.LogVersion AS Version, LocalisationSystem.LocalisationSystemName AS [Localisation system],  " +
                    "LocalisationSystem.DisplayTextLocation1 + ': ' + CollectionEventLocalisation_Log.Location1 AS [Value 1],  " +
                    "LocalisationSystem.DisplayTextLocation2 + ': ' + CollectionEventLocalisation_Log.Location2 AS [Value 2], CollectionEventLocalisation_Log.LocationAccuracy AS Accuracy,  " +
                    "CollectionEventLocalisation_Log.LocationNotes AS Notes, CollectionEventLocalisation_Log.DeterminationDate AS [Determination date],  " +
                    "CollectionEventLocalisation_Log.DistanceToLocation AS [Distance to location], CollectionEventLocalisation_Log.DirectionToLocation AS [Direction to location],  " +
                    "CollectionEventLocalisation_Log.ResponsibleName AS [Responsible User], CollectionEventLocalisation_Log.ResponsibleAgentURI AS [Responsible agent URI],  " +
                    "CollectionEventLocalisation_Log.AverageAltitudeCache AS [Altitude cache], CollectionEventLocalisation_Log.AverageLatitudeCache AS [Latitude cache],  " +
                    "CollectionEventLocalisation_Log.AverageLongitudeCache AS [Longitude cache], " +
                    "CASE WHEN LogState = 'U' THEN 'UPDATE' ELSE 'DELETE' END AS [Kind of change], convert(varchar(20), LogDate, 120) AS [Date of change],  " +
                    "LogUser AS [Responsible user], LogID  " +
                    "FROM CollectionEventLocalisation_Log INNER JOIN " +
                    "LocalisationSystem ON CollectionEventLocalisation_Log.LocalisationSystemID = LocalisationSystem.LocalisationSystemID " +
                    "WHERE CollectionEventLocalisation_Log.CollectionEventID = " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].ToString();
                try
                {
                    System.Data.SqlClient.SqlDataAdapter a = new System.Data.SqlClient.SqlDataAdapter(SqlCurrent, DiversityWorkbench.Settings.ConnectionString);
                    a.Fill(dtCollectionEventLocalisation_Log);
                    a.SelectCommand.CommandText = SQL;
                    a.Fill(dtCollectionEventLocalisation_Log);
                }

                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
                return dtCollectionEventLocalisation_Log;
            }
        }

        private System.Data.DataTable dtCollectionAgentHistory
        {
            get
            {
                System.Data.DataTable dtCollectionAgent_Log = new DataTable("CollectionAgent");
                string SqlCurrent = "SELECT CollectionSpecimen.Version, CollectorsName AS Collector, CollectorsAgentURI AS [Collectors URI], " +
                    "CollectorsSequence AS [Sequence], CollectorsNumber AS [Collectors number], Notes, " +
                    "CollectionAgent.DataWithholdingReason AS [Datawithholding reason], " +
                    "'current version' AS [Kind of change], CollectionAgent.LogUpdatedWhen AS [Date of change], " +
                    "CollectionAgent.LogUpdatedBy AS [Responsible user], NULL AS LogID " +
                    "FROM CollectionAgent INNER JOIN " +
                    "CollectionSpecimen ON CollectionAgent.CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID " +
                    "WHERE CollectionAgent.CollectionSpecimenID =  " + this.SpecimenID.ToString();
                string SQL = "SELECT LogVersion AS Version, CollectorsName AS Collector, CollectorsAgentURI AS [Collectors URI], " +
                    "CollectorsSequence AS [Sequence], CollectorsNumber AS [Collectors number], Notes, " +
                    "CollectionAgent_log.DataWithholdingReason AS [Datawithholding reason], " +
                    "CASE WHEN LogState = 'U' THEN 'UPDATE' ELSE 'DELETE' END AS [Kind of change], LogDate AS [Date of change], " +
                    "LogUser AS [Responsible user], LogID  " +
                    "FROM  CollectionAgent_log " +
                    "WHERE CollectionSpecimenID = " + this.SpecimenID.ToString() +
                    " ORDER BY LogVersion DESC, LogID DESC";
                try
                {
                    System.Data.SqlClient.SqlDataAdapter a = new System.Data.SqlClient.SqlDataAdapter(SqlCurrent, DiversityWorkbench.Settings.ConnectionString);
                    a.Fill(dtCollectionAgent_Log);
                    a.SelectCommand.CommandText = SQL;
                    a.Fill(dtCollectionAgent_Log);
                }

                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
                return dtCollectionAgent_Log;
            }
        }

        private System.Data.DataTable dtCollectionEventHistory
        {
            get
            {
                System.Data.DataTable dtCollectionEvent_Log = new DataTable("CollectionEvent");
                if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].Equals(System.DBNull.Value))
                {
                    string SqlCurrent = "SELECT CollectionEvent.Version, CollectionEventSeries.Description AS CollectionEventSeries, CollectionEvent.CollectorsEventNumber AS [Event number],  " +
                        "CollectionEvent.CollectionDate AS [Collection date], CollectionEvent.CollectionDay AS [Collection day],  " +
                        "CollectionEvent.CollectionMonth AS [Collection month], CollectionEvent.CollectionYear AS [Collection year],  " +
                        "CollectionEvent.CollectionDateSupplement AS [Date supplement], CollectionEvent.CollectionDateCategory AS [Date category],  " +
                        "CollectionEvent.CollectionTime AS [Collection time], CollectionEvent.CollectionTimeSpan AS [Collection time span],  " +
                        "CollectionEvent.LocalityDescription AS [Locality description], CollectionEvent.HabitatDescription AS [Habitat description],  " +
                        "CollectionEvent.ReferenceTitle AS [Reference title], CollectionEvent.ReferenceURI AS [Reference URI],  " +
                        "CollectionEvent.CollectingMethod AS [Collecting method], CollectionEvent.Notes, CollectionEvent.CountryCache AS Country,  " +
                        "CollectionEvent.DataWithholdingReason, CollectionEvent.DataWithholdingReasonDate," +
                        "'current version' AS [Kind of change], convert(varchar(20), CollectionEvent.LogUpdatedWhen, 120) AS [Date of change], CollectionEvent.LogUpdatedBy AS [Responsible user], NULL AS LogID " +
                        "FROM CollectionEvent LEFT OUTER JOIN " +
                        "CollectionEventSeries ON CollectionEvent.SeriesID = CollectionEventSeries.SeriesID " +
                        "WHERE (CollectionEvent.CollectionEventID = " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].ToString() + ") ";
                    string SQL = "SELECT CollectionEvent_log.Version, CollectionEventSeries.Description AS CollectionEventSeries, CollectionEvent_log.CollectorsEventNumber AS [Event number],  " +
                        "CollectionEvent_log.CollectionDate AS [Collection date], CollectionEvent_log.CollectionDay AS [Collection day],  " +
                        "CollectionEvent_log.CollectionMonth AS [Collection month], CollectionEvent_log.CollectionYear AS [Collection year],  " +
                        "CollectionEvent_log.CollectionDateSupplement AS [Date supplement], CollectionEvent_log.CollectionDateCategory AS [Date category],  " +
                        "CollectionEvent_log.CollectionTime AS [Collection time], CollectionEvent_log.CollectionTimeSpan AS [Collection time span],  " +
                        "CollectionEvent_log.LocalityDescription AS [Locality description], CollectionEvent_log.HabitatDescription AS [Habitat description],  " +
                        "CollectionEvent_log.ReferenceTitle AS [Reference title], CollectionEvent_log.ReferenceURI AS [Reference URI],  " +
                        "CollectionEvent_log.CollectingMethod AS [Collecting method], CollectionEvent_log.Notes, CollectionEvent_log.CountryCache AS Country,  " +
                        "CollectionEvent_log.DataWithholdingReason, CollectionEvent_log.DataWithholdingReasonDate, " +
                        "CASE WHEN LogState = 'U' THEN 'UPDATE' ELSE 'DELETE' END AS [Kind of change], convert(varchar(20), LogDate, 120), LogUser, LogID  " +
                        "FROM CollectionEvent_log LEFT OUTER JOIN " +
                        "CollectionEventSeries ON CollectionEvent_log.SeriesID = CollectionEventSeries.SeriesID " +
                        "WHERE (CollectionEvent_log.CollectionEventID = " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].ToString() + ") " +
                        " ORDER BY Version DESC, LogID DESC";
                    try
                    {
                        System.Data.SqlClient.SqlDataAdapter a = new System.Data.SqlClient.SqlDataAdapter(SqlCurrent, DiversityWorkbench.Settings.ConnectionString);
                        a.Fill(dtCollectionEvent_Log);
                        a.SelectCommand.CommandText = SQL;
                        a.Fill(dtCollectionEvent_Log);
                    }

                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                }
                return dtCollectionEvent_Log;
            }
        }

        private System.Data.DataTable dtCollectionEventImageHistory
        {
            get
            {
                System.Data.DataTable dtCollectionEventImage_Log = new DataTable("CollectionEventImage");
                string SqlCurrent = "SELECT URI, ResourceURI AS [Resource URI], ImageType AS [Image type], Notes, " +
                    "'current version' AS [Kind of change], convert(varchar(20), LogUpdatedWhen, 120) AS [Date of change], LogUpdatedBy AS [Responsible user], NULL AS LogID " +
                    "FROM CollectionEventImage WHERE CollectionEventID = " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].ToString() + " ";
                string SQL = "SELECT URI, ResourceURI AS [Resource URI], ImageType AS [Image type], Notes, " +
                    "CASE WHEN LogState = 'U' THEN 'UPDATE' ELSE 'DELETE' END AS [Kind of change], convert(varchar(20), LogDate, 120) AS [Date of change], LogUser  AS [Responsible user], LogID  " +
                    "FROM CollectionEventImage_Log WHERE CollectionEventID = " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].ToString() + " " +
                    " ORDER BY LogID DESC ";
                try
                {
                    System.Data.SqlClient.SqlDataAdapter a = new System.Data.SqlClient.SqlDataAdapter(SqlCurrent, DiversityWorkbench.Settings.ConnectionString);
                    a.Fill(dtCollectionEventImage_Log);
                    a.SelectCommand.CommandText = SQL;
                    a.Fill(dtCollectionEventImage_Log);
                }

                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
                return dtCollectionEventImage_Log;
            }
        }

        private System.Data.DataTable dtCollectionEventSeriesHistory
        {
            get
            {
                System.Data.DataTable dtCollectionEventSeries_Log = new DataTable("CollectionEventSeries");
                string SqlCurrent = "SELECT Description, SeriesCode, Notes, " +
                    "'current version' AS [Kind of change], convert(varchar(20), LogUpdatedWhen, 120) AS [Date of change], LogUpdatedBy AS [Responsible user], NULL AS LogID " +
                    "FROM CollectionEventSeries WHERE SeriesID = " + this.dataSetCollectionSpecimen.CollectionEventSeries.Rows[0]["SeriesID"].ToString() + " ";
                string SQL = "SELECT Description, SeriesCode, Notes, " +
                    "CASE WHEN LogState = 'U' THEN 'UPDATE' ELSE 'DELETE' END AS [Kind of change], convert(varchar(20), LogDate, 120) AS [Date of change], LogUser  AS [Responsible user], LogID  " +
                    "FROM CollectionEventSeries_Log WHERE SeriesID = " + this.dataSetCollectionSpecimen.CollectionEventSeries.Rows[0]["SeriesID"].ToString() + " " +
                    " ORDER BY LogID DESC ";
                try
                {
                    System.Data.SqlClient.SqlDataAdapter a = new System.Data.SqlClient.SqlDataAdapter(SqlCurrent, DiversityWorkbench.Settings.ConnectionString);
                    a.Fill(dtCollectionEventSeries_Log);
                    a.SelectCommand.CommandText = SQL;
                    a.Fill(dtCollectionEventSeries_Log);
                }

                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
                return dtCollectionEventSeries_Log;
            }
        }
        
        private System.Data.DataTable dtCollectionEventSeriesImageHistory
        {
            get
            {
                System.Data.DataTable dtCollectionEventSeriesImage_Log = new DataTable("CollectionEventSeriesImage");
                if (this.dataSetCollectionSpecimen.CollectionEventSeries.Rows.Count == 0)
                {
                    return dtCollectionEventSeriesImage_Log;
                }
                try
                {
                    string SqlCurrent = "SELECT URI, ResourceURI AS [Resource URI], ImageType AS [Image type], Notes, " +
                        "'current version' AS [Kind of change], LogUpdatedWhen AS [Date of change], LogUpdatedBy AS [Responsible user], NULL AS LogID " +
                        "FROM CollectionEventSeriesImage WHERE SeriesID = " + this.dataSetCollectionSpecimen.CollectionEventSeries.Rows[0]["SeriesID"].ToString() + " ";
                    string SQL = "SELECT URI, ResourceURI AS [Resource URI], ImageType AS [Image type], Notes, " +
                        "CASE WHEN LogState = 'U' THEN 'UPDATE' ELSE 'DELETE' END AS [Kind of change], LogDate AS [Date of change], LogUser  AS [Responsible user], LogID  " +
                        "FROM CollectionEventSeriesImage_Log WHERE SeriesID = " + this.dataSetCollectionSpecimen.CollectionEventSeries.Rows[0]["SeriesID"].ToString() + " " +
                        " ORDER BY LogID DESC ";
                    System.Data.SqlClient.SqlDataAdapter a = new System.Data.SqlClient.SqlDataAdapter(SqlCurrent, DiversityWorkbench.Settings.ConnectionString);
                    a.Fill(dtCollectionEventSeriesImage_Log);
                    a.SelectCommand.CommandText = SQL;
                    a.Fill(dtCollectionEventSeriesImage_Log);
                }

                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
                return dtCollectionEventSeriesImage_Log;
            }
        }

        #endregion

        #region Auxilliary functions

        private void setNodeImageTaxon(ref DiversityCollection.HierarchyNode Node, string TaxonomicGroup)
        {
            System.Windows.Forms.TreeNode N = (System.Windows.Forms.TreeNode)Node;
            this.setNodeImageTaxon(ref N, TaxonomicGroup);
        }

        private void setNodeImageTaxon(ref System.Windows.Forms.TreeNode Node, string TaxonomicGroup)
        {
            switch (TaxonomicGroup)
            {
                case "Expedition":
                    Node.ImageIndex = 0;
                    break;
                case "Event":
                    Node.ImageIndex = 1;
                    break;
                case "Specimen":
                    Node.ImageIndex = 2;
                    break;
                case "virus":
                    Node.ImageIndex = 4;
                    break;
                case "bacteria":
                    Node.ImageIndex = 5;
                    break;
                case "diatom":
                    Node.ImageIndex = 6;
                    break;
                case "moss":
                    Node.ImageIndex = 7;
                    break;
                case "fern":
                    Node.ImageIndex = 8;
                    break;
                case "plant":
                    Node.ImageIndex = 9;
                    break;
                case "lichen":
                    Node.ImageIndex = 10;
                    break;
                case "fungus":
                    Node.ImageIndex = 11;
                    break;
                case "myxomycete":
                    Node.ImageIndex = 12;
                    break;
                case "animal":
                    Node.ImageIndex = 13;
                    break;
                case "insect":
                    Node.ImageIndex = 14;
                    break;
                case "fish":
                    Node.ImageIndex = 15;
                    break;
                case "mammal":
                    Node.ImageIndex = 16;
                    break;
                case "soil":
                    Node.ImageIndex = 17;
                    break;
                case "other":
                    Node.ImageIndex = 18;
                    break;
                default:
                    Node.ImageIndex = 3;
                    break;
            }
            Node.SelectedImageIndex = Node.ImageIndex;
        }

        #endregion

        #region Overview

        #region Hierarchy

        #region Building the Hierarchies

        #region Common

        private void buildOverviewHierarchy()
        {
            this.setToolStripOverviewHierarchyDisplayVisibility();
            this.setToolStripOverviewHierarchyDisplayStorageVisibility();

            this.treeViewOverviewHierarchy.SuspendLayout();
            this.buildOverviewHierarchyUnits();
            this.setToolStripOverviewHierarchyEditVisibility("");
            this.treeViewOverviewHierarchy.ResumeLayout();

            this.treeViewOverviewHierarchyStorage.SuspendLayout();
            this.buildOverviewHierarchyParts();
            this.setToolStripOverviewHierarchyStorageEditVisibility("");
            this.treeViewOverviewHierarchyStorage.ResumeLayout();

            this.setOverviewDataVisibility("");
            this.setImageVisibility("");
        }

        private bool moveToHierarchyNode(System.Data.DataRow DataRow, System.Windows.Forms.TreeView TreeView)
        {
            System.Windows.Forms.TreeNode Node = null;
            foreach (System.Windows.Forms.TreeNode MainNode in TreeView.Nodes)
            {
                Node = this.getTreeNodeOfDataRow(TreeView, MainNode, DataRow);
                if (Node != null)
                {
                    Node.TreeView.SelectedNode = Node;
                    break;
                }
            }
            if (Node == null)
            {
                foreach (System.Windows.Forms.TreeNode MainNode in TreeView.Nodes)
                {
                    Node = this.getTreeNodeWithEqualDataRowValues(TreeView, MainNode, DataRow);
                    if (Node != null)
                    {
                        Node.TreeView.SelectedNode = Node;
                        break;
                    }
                }
            }
            if (Node == null) return false; 
            return true;
        }

        private System.Windows.Forms.TreeNode getTreeNodeOfDataRow(System.Windows.Forms.TreeView TreeView, System.Windows.Forms.TreeNode TreeNode, System.Data.DataRow DataRow)
        {
            if (TreeNode == null && TreeView.Nodes.Count > 0) TreeNode = TreeView.Nodes[0];
            System.Windows.Forms.TreeNode NodeOfDatarow = null;
            if (TreeNode != null && (System.Data.DataRow)TreeNode.Tag == DataRow)
                return TreeNode;
            else if (TreeNode != null)
            {
                foreach (System.Windows.Forms.TreeNode ChildNode in TreeNode.Nodes)
                {
                    if (DataRow == (System.Data.DataRow)ChildNode.Tag)
                        return ChildNode;
                }
                foreach (System.Windows.Forms.TreeNode ChildNode in TreeNode.Nodes)
                {
                    NodeOfDatarow = this.getTreeNodeOfDataRow(TreeView, ChildNode, DataRow);
                    if (NodeOfDatarow != null) 
                        return NodeOfDatarow;
                }
            }
            return NodeOfDatarow;
        }

        private System.Windows.Forms.TreeNode getTreeNodeWithEqualDataRowValues(System.Windows.Forms.TreeView TreeView, System.Windows.Forms.TreeNode TreeNode, System.Data.DataRow DataRow)
        {
            if (TreeNode == null && TreeView.Nodes.Count > 0) TreeNode = TreeView.Nodes[0];
            System.Windows.Forms.TreeNode NodeOfDatarow = null;
            if (TreeNode != null && (System.Data.DataRow)TreeNode.Tag == DataRow)
                return TreeNode;
            else if (TreeNode != null)
            {
                foreach (System.Windows.Forms.TreeNode ChildNode in TreeNode.Nodes)
                {
                    bool OK = true;
                    try
                    {
                        System.Data.DataRow NodeDataRow = (System.Data.DataRow)ChildNode.Tag;
                        foreach (System.Data.DataColumn C in DataRow.Table.Columns)
                        {
                            if (DataRow.RowState == DataRowState.Deleted ||
                                DataRow.RowState == DataRowState.Detached ||
                                DataRow.RowState == DataRowState.Modified ||
                                NodeDataRow.RowState == DataRowState.Deleted ||
                                NodeDataRow.RowState == DataRowState.Detached ||
                                NodeDataRow.RowState == DataRowState.Modified)
                            {
                                OK = false;
                                break;
                            }
                            if (!NodeDataRow.Table.Columns.Contains(C.ColumnName))
                            {
                                OK = false;
                                break;
                            }
                            if (DataRow[C.ColumnName].ToString() != NodeDataRow[C.ColumnName].ToString())
                            {
                                OK = false;
                                break;
                            }
                        }
                        if (OK)
                            return ChildNode;
                    }
                    catch { return null; }
                }
                foreach (System.Windows.Forms.TreeNode ChildNode in TreeNode.Nodes)
                {
                    NodeOfDatarow = this.getTreeNodeWithEqualDataRowValues(TreeView, ChildNode, DataRow);
                    if (NodeOfDatarow != null)
                        return NodeOfDatarow;
                }
            }
            return NodeOfDatarow;
        }

        private void AddOverviewHierarchyAnnotation(System.Windows.Forms.TreeNode N)
        {
        }
        
        #endregion

        #region Identifier

        private enum IdentifierTarget { All, Units, Parts }

        private void addOverviewHierarchyIdentifier(IdentifierTarget Target)
        {
            if (this.ShowIdentifier)
            {
                if (this.dataSetCollectionSpecimen.ExternalIdentifier.Rows.Count == 0)
                    return;
                try
                {
                    if (Target == IdentifierTarget.All || Target == IdentifierTarget.Units)
                    {
                        // Event
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "CollectionEvent", this.treeViewOverviewHierarchy, ref Nodes);
                        if (Nodes.Count > 0)
                        {
                            foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.ExternalIdentifier.Rows)
                            {
                                if (R.RowState != DataRowState.Deleted && R.RowState != DataRowState.Detached && R["ReferencedTable"].ToString() == "CollectionEvent" && R["ReferencedID"].ToString() == this.EventID.ToString())
                                {
                                    DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                                    Nodes[0].Nodes.Add(NA);
                                }
                            }
                        }

                        // Specimen
                        Nodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref Nodes);
                        foreach (System.Windows.Forms.TreeNode N in Nodes)
                        {
                            System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.ExternalIdentifier.Select("ReferencedTable = 'CollectionSpecimen'", "ID");
                            foreach (System.Data.DataRow R in RR)
                            {
                                DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                                N.Nodes.Add(NA);
                            }
                            break;
                        }

                        // Unit
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> UnitNodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "IdentificationUnit", this.treeViewOverviewHierarchy, ref UnitNodes);
                        foreach (System.Windows.Forms.TreeNode N in UnitNodes)
                        {
                            System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                            int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
                            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.ExternalIdentifier.Select("ReferencedTable = 'IdentificationUnit' AND ReferencedID = " + UnitID.ToString(), "", System.Data.DataViewRowState.CurrentRows);
                            if (rr.Length > 0)
                            {
                                for (int i = 0; i < rr.Length; i++)
                                {
                                    try
                                    {
                                        DiversityCollection.HierarchyNode NI = new HierarchyNode(rr[i], false);
                                        N.Nodes.Add(NI);
                                    }
                                    catch (System.Exception ex) { }
                                }
                            }
                            N.Expand();
                        }

                        // Reference
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> ReferenceNodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "CollectionSpecimenReference", this.treeViewOverviewHierarchy, ref ReferenceNodes);
                        foreach (System.Windows.Forms.TreeNode N in ReferenceNodes)
                        {
                            System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                            int ReferenceID = int.Parse(R["ReferenceID"].ToString());
                            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.ExternalIdentifier.Select("ReferencedTable = 'CollectionSpecimenReference' AND ReferencedID = " + ReferenceID.ToString(), "", System.Data.DataViewRowState.CurrentRows);
                            if (rr.Length > 0)
                            {
                                for (int i = 0; i < rr.Length; i++)
                                {
                                    try
                                    {
                                        DiversityCollection.HierarchyNode NI = new HierarchyNode(rr[i], false);
                                        N.Nodes.Add(NI);
                                    }
                                    catch (System.Exception ex) { }
                                }
                            }
                            N.Expand();
                        }

                    }
                    if (Target == IdentifierTarget.All || Target == IdentifierTarget.Parts)
                    {
                        // Part
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> PartNodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "CollectionSpecimenPart", this.treeViewOverviewHierarchyStorage, ref PartNodes);
                        foreach (System.Windows.Forms.TreeNode N in PartNodes)
                        {
                            System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                            if (R.RowState == DataRowState.Deleted || R.RowState == DataRowState.Detached)
                                continue;
                            int PartID = int.Parse(R["SpecimenPartID"].ToString());
                            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.ExternalIdentifier.Select("ReferencedTable = 'CollectionSpecimenPart' AND ReferencedID = " + PartID.ToString(), "", System.Data.DataViewRowState.CurrentRows);
                            if (rr.Length > 0)
                            {
                                for (int i = 0; i < rr.Length; i++)
                                {
                                    try
                                    {
                                        DiversityCollection.HierarchyNode NI = new HierarchyNode(rr[i], false);
                                        N.Nodes.Add(NI);
                                    }
                                    catch (System.Exception ex) { }
                                }
                            }
                            N.Expand();
                        }

                        // Reference
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> ReferenceNodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "CollectionSpecimenReference", this.treeViewOverviewHierarchyStorage, ref ReferenceNodes);
                        foreach (System.Windows.Forms.TreeNode N in ReferenceNodes)
                        {
                            System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                            int ReferenceID = int.Parse(R["ReferenceID"].ToString());
                            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.ExternalIdentifier.Select("ReferencedTable = 'CollectionSpecimenReference' AND ReferencedID = " + ReferenceID.ToString(), "", System.Data.DataViewRowState.CurrentRows);
                            if (rr.Length > 0)
                            {
                                for (int i = 0; i < rr.Length; i++)
                                {
                                    try
                                    {
                                        DiversityCollection.HierarchyNode NI = new HierarchyNode(rr[i], false);
                                        N.Nodes.Add(NI);
                                    }
                                    catch (System.Exception ex) { }
                                }
                            }
                            N.Expand();
                        }


                    }
                }
                catch (System.Exception ex)
                {
                }
            }
        }

        private void addOverviewHierarchyIdentifier(string ReferencedTable, int ReferencedID)
        {
            if (this.ShowIdentifier)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                switch (ReferencedTable)
                {
                    case "CollectionEvent":
                        Nodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "CollectionEvent", this.treeViewOverviewHierarchy, ref Nodes);
                        if (Nodes.Count > 0)
                        {
                            System.Collections.Generic.List<System.Windows.Forms.TreeNode> NodesSpecimen = new List<TreeNode>();
                            this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref NodesSpecimen);
                            Nodes[0].Nodes.Remove(NodesSpecimen[0]);
                            foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.ExternalIdentifier.Rows)
                            {
                                if (R.RowState != DataRowState.Deleted
                                    && R.RowState != DataRowState.Detached
                                    && R["ReferencedTable"].ToString() == "CollectionEvent"
                                    && R["ReferencedID"].ToString() == ReferencedID.ToString())
                                {
                                    DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                                    Nodes[0].Nodes.Add(NA);
                                }
                            }
                            Nodes[0].Nodes.Add(NodesSpecimen[0]);
                        }
                        break;
                    case "CollectionSpecimen":
                        this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref Nodes);
                        foreach (System.Windows.Forms.TreeNode N in Nodes)
                        {
                            System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.ExternalIdentifier.Select("ReferencedTable = 'CollectionSpecimen'", "ID");
                            foreach (System.Data.DataRow R in RR)
                            {
                                DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                                N.Nodes.Add(NA);
                            }
                            break;
                        }
                        break;
                    case "IdentificationUnit":
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> UnitNodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "IdentificationUnit", this.treeViewOverviewHierarchy, ref UnitNodes);
                        foreach (System.Windows.Forms.TreeNode N in UnitNodes)
                        {
                            System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                            int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
                            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.ExternalIdentifier.Select("ReferencedTable = 'IdentificationUnit' AND ReferencedID = " + UnitID.ToString(), "", System.Data.DataViewRowState.CurrentRows);
                            if (rr.Length > 0)
                            {
                                for (int i = 0; i < rr.Length; i++)
                                {
                                    try
                                    {
                                        DiversityCollection.HierarchyNode NI = new HierarchyNode(rr[i], false);
                                        N.Nodes.Add(NI);
                                    }
                                    catch (System.Exception ex) { }
                                }
                            }
                            N.Expand();
                        }
                        break;
                    case "CollectionSpecimenPart":
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> PartNodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "CollectionSpecimenPart", this.treeViewOverviewHierarchyStorage, ref PartNodes);
                        foreach (System.Windows.Forms.TreeNode N in PartNodes)
                        {
                            System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                            foreach (System.Data.DataRow rP in this.dataSetCollectionSpecimen.ExternalIdentifier.Rows)
                            {
                                if (rP["ReferencedTable"].ToString() == "CollectionSpecimenPart" && rP["ReferencedID"].ToString() == R["SpecimenPartID"].ToString())
                                {
                                    DiversityCollection.HierarchyNode NI = new HierarchyNode(rP, false);
                                    N.Nodes.Add(NI);
                                }
                            }
                        }
                        break;

                }
            }
        }

        private void addOverviewHierarchyIdentifier(System.Windows.Forms.TreeNode Node, string ReferencedTable, int ReferencedID)
        {
            if (this.ShowIdentifier)
            {
                switch (ReferencedTable)
                {
                    case "CollectionEvent":
                        foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.ExternalIdentifier.Rows)
                        {
                            if (R.RowState != DataRowState.Deleted
                                && R.RowState != DataRowState.Detached
                                && R["ReferencedTable"].ToString() == "CollectionEvent"
                                && R["ReferencedID"].ToString() == ReferencedID.ToString())
                            {
                                DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                                Node.Nodes.Add(NA);
                            }
                        }
                        break;
                    case "CollectionSpecimen":
                        System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.ExternalIdentifier.Select("ReferencedTable = 'CollectionSpecimen' AND ReferencedID = " + ReferencedID.ToString(), "ID");
                        foreach (System.Data.DataRow R in RR)
                        {
                            DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                            Node.Nodes.Add(NA);
                        }
                        break;
                    case "IdentificationUnit":
                        System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.ExternalIdentifier.Select("ReferencedTable = 'IdentificationUnit' AND ReferencedID = " + ReferencedID.ToString(), "", System.Data.DataViewRowState.CurrentRows);
                        if (rr.Length > 0)
                        {
                            for (int i = 0; i < rr.Length; i++)
                            {
                                try
                                {
                                    DiversityCollection.HierarchyNode NI = new HierarchyNode(rr[i], false);
                                    Node.Nodes.Add(NI);
                                }
                                catch (System.Exception ex) { }
                            }
                        }
                        Node.Expand();
                        break;
                    case "CollectionSpecimenPart":
                        foreach (System.Data.DataRow rP in this.dataSetCollectionSpecimen.ExternalIdentifier.Rows)
                        {
                            if (rP["ReferencedTable"].ToString() == "CollectionSpecimenPart" && rP["ReferencedID"].ToString() == ReferencedID.ToString())
                            {
                                DiversityCollection.HierarchyNode NI = new HierarchyNode(rP, false);
                                Node.Nodes.Add(NI);
                            }
                        }
                        break;
                    case "CollectionSpecimenReference":
                        foreach (System.Data.DataRow rP in this.dataSetCollectionSpecimen.ExternalIdentifier.Rows)
                        {
                            if (rP["ReferencedTable"].ToString() == "CollectionSpecimenReference" && rP["ReferencedID"].ToString() == ReferencedID.ToString())
                            {
                                DiversityCollection.HierarchyNode NI = new HierarchyNode(rP, false);
                                Node.Nodes.Add(NI);
                            }
                        }
                        break;
                }
            }
        }

        #endregion

        #region Annotation

        private enum AnnotationTarget { All, Units, Parts }

        private void addOverviewHierarchyAnnotations(AnnotationTarget Target)
        {
            if (this.ShowAnnotation)
            {
                if (this.dataSetCollectionSpecimen.Annotation.Rows.Count == 0)
                    return;
                try
                {
                    if (Target == AnnotationTarget.All || Target == AnnotationTarget.Units)
                    {
                        // Event
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "CollectionEvent", this.treeViewOverviewHierarchy, ref Nodes);
                        if (Nodes.Count > 0)
                        {
                            foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.Annotation.Rows)
                            {
                                if (R.RowState != DataRowState.Deleted && R.RowState != DataRowState.Detached && R["ReferencedTable"].ToString() == "CollectionEvent" && R["ReferencedAnnotationID"].Equals(System.DBNull.Value))
                                {
                                    DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                                    Nodes[0].Nodes.Add(NA);
                                    this.addOverviewHierarchyAnnotationChildren(NA);
                                }
                            }
                        }

                        // Specimen
                        Nodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref Nodes);
                        foreach (System.Windows.Forms.TreeNode N in Nodes)
                        {
                            System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.Annotation.Select("ReferencedTable = 'CollectionSpecimen' AND ReferencedAnnotationID IS NULL", "AnnotationID");
                            foreach (System.Data.DataRow R in RR)
                            {
                                DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                                N.Nodes.Add(NA);
                                this.addOverviewHierarchyAnnotationChildren(NA);
                            }
                            break;
                        }

                        // Unit
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> UnitNodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "IdentificationUnit", this.treeViewOverviewHierarchy, ref UnitNodes);
                        foreach (System.Windows.Forms.TreeNode N in UnitNodes)
                        {
                            System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                            int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
                            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.Annotation.Select("ReferencedTable = 'IdentificationUnit' AND ReferencedAnnotationID IS NULL AND ReferencedID = " + UnitID.ToString(), "", System.Data.DataViewRowState.CurrentRows);
                            if (rr.Length > 0)
                            {
                                for (int i = 0; i < rr.Length; i++)
                                {
                                    try
                                    {
                                        DiversityCollection.HierarchyNode NI = new HierarchyNode(rr[i], false);
                                        N.Nodes.Add(NI);
                                        this.addOverviewHierarchyAnnotationChildren(NI);
                                   }
                                    catch (System.Exception ex) { }
                                }
                            }
                            N.Expand();
                        }
                    }
                    if (Target == AnnotationTarget.All || Target == AnnotationTarget.Parts)
                    {
                        // Part
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> PartNodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "CollectionSpecimenPart", this.treeViewOverviewHierarchyStorage, ref PartNodes);
                        foreach (System.Windows.Forms.TreeNode N in PartNodes)
                        {
                            System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                            if (R.RowState == DataRowState.Deleted || R.RowState == DataRowState.Detached)
                                continue;
                            int PartID = int.Parse(R["SpecimenPartID"].ToString());
                            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.Annotation.Select("ReferencedTable = 'CollectionSpecimenPart' AND ReferencedAnnotationID IS NULL AND ReferencedID = " + PartID.ToString(), "", System.Data.DataViewRowState.CurrentRows);
                            if (rr.Length > 0)
                            {
                                for (int i = 0; i < rr.Length; i++)
                                {
                                    try
                                    {
                                        DiversityCollection.HierarchyNode NI = new HierarchyNode(rr[i], false);
                                        N.Nodes.Add(NI);
                                        this.addOverviewHierarchyAnnotationChildren(NI);
                                    }
                                    catch (System.Exception ex) { }
                                }
                            }
                            N.Expand();
                        }
                    }
                }
                catch (System.Exception ex)
                {
                }
            }
        }

        private void addOverviewHierarchyAnnotations(string ReferencedTable, int ReferencedID)
        {
            if (this.ShowAnnotation)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                switch (ReferencedTable)
                {
                    case "CollectionEvent":
                        Nodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "CollectionEvent", this.treeViewOverviewHierarchy, ref Nodes);
                        if (Nodes.Count > 0)
                        {
                            System.Collections.Generic.List<System.Windows.Forms.TreeNode> NodesSpecimen = new List<TreeNode>();
                            this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref NodesSpecimen);
                            Nodes[0].Nodes.Remove(NodesSpecimen[0]);
                            foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.Annotation.Rows)
                            {
                                if (R.RowState != DataRowState.Deleted
                                    && R.RowState != DataRowState.Detached
                                    && R["ReferencedTable"].ToString() == "CollectionEvent"
                                    && R["ReferencedID"].ToString() == ReferencedID.ToString())
                                {
                                    DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                                    Nodes[0].Nodes.Add(NA);
                                }
                            }
                            Nodes[0].Nodes.Add(NodesSpecimen[0]);
                        }
                        break;
                    case "CollectionSpecimen":
                        this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref Nodes);
                        foreach (System.Windows.Forms.TreeNode N in Nodes)
                        {
                            System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.Annotation.Select("ReferencedTable = 'CollectionSpecimen'", "AnnotationID");
                            foreach (System.Data.DataRow R in RR)
                            {
                                DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                                N.Nodes.Add(NA);
                            }
                            break;
                        }
                        break;
                    case "IdentificationUnit":
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> UnitNodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "IdentificationUnit", this.treeViewOverviewHierarchy, ref UnitNodes);
                        foreach (System.Windows.Forms.TreeNode N in UnitNodes)
                        {
                            System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                            int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
                            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.Annotation.Select("ReferencedTable = 'IdentificationUnit' AND ReferencedID = " + UnitID.ToString(), "", System.Data.DataViewRowState.CurrentRows);
                            if (rr.Length > 0)
                            {
                                for (int i = 0; i < rr.Length; i++)
                                {
                                    try
                                    {
                                        DiversityCollection.HierarchyNode NI = new HierarchyNode(rr[i], false);
                                        N.Nodes.Add(NI);
                                    }
                                    catch (System.Exception ex) { }
                                }
                            }
                            N.Expand();
                        }
                        break;
                    case "CollectionSpecimenPart":
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> PartNodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "CollectionSpecimenPart", this.treeViewOverviewHierarchyStorage, ref PartNodes);
                        foreach (System.Windows.Forms.TreeNode N in PartNodes)
                        {
                            System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                            foreach (System.Data.DataRow rP in this.dataSetCollectionSpecimen.Annotation.Rows)
                            {
                                if (rP["ReferencedTable"].ToString() == "CollectionSpecimenPart" && rP["ReferencedID"].ToString() == R["SpecimenPartID"].ToString())
                                {
                                    DiversityCollection.HierarchyNode NI = new HierarchyNode(rP, false);
                                    N.Nodes.Add(NI);
                                }
                            }
                        }
                        break;

                }
            }
        }

        private void addOverviewHierarchyAnnotations(System.Windows.Forms.TreeNode Node, string ReferencedTable, int ReferencedID)
        {
            if (this.ShowAnnotation)
            {
                switch (ReferencedTable)
                {
                    case "CollectionEvent":
                        foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.Annotation.Rows)
                        {
                            if (R.RowState != DataRowState.Deleted
                                && R.RowState != DataRowState.Detached
                                && R["ReferencedTable"].ToString() == "CollectionEvent"
                                && R["ReferencedID"].ToString() == ReferencedID.ToString())
                            {
                                DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                                Node.Nodes.Add(NA);
                            }
                        }
                        break;
                    case "CollectionSpecimen":
                        System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.Annotation.Select("ReferencedTable = 'CollectionSpecimen' AND ReferencedID = " + ReferencedID.ToString(), "AnnotationID");
                        foreach (System.Data.DataRow R in RR)
                        {
                            DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                            Node.Nodes.Add(NA);
                        }
                        break;
                    case "IdentificationUnit":
                        System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.Annotation.Select("ReferencedTable = 'IdentificationUnit' AND ReferencedID = " + ReferencedID.ToString(), "", System.Data.DataViewRowState.CurrentRows);
                        if (rr.Length > 0)
                        {
                            for (int i = 0; i < rr.Length; i++)
                            {
                                try
                                {
                                    DiversityCollection.HierarchyNode NI = new HierarchyNode(rr[i], false);
                                    Node.Nodes.Add(NI);
                                }
                                catch (System.Exception ex) { }
                            }
                        }
                        Node.Expand();
                        break;
                    case "CollectionSpecimenPart":
                        foreach (System.Data.DataRow rP in this.dataSetCollectionSpecimen.Annotation.Rows)
                        {
                            if (rP["ReferencedTable"].ToString() == "CollectionSpecimenPart" && rP["ReferencedID"].ToString() == ReferencedID.ToString())
                            {
                                DiversityCollection.HierarchyNode NI = new HierarchyNode(rP, false);
                                Node.Nodes.Add(NI);
                            }
                        }
                        break;
                }
            }
        }

        private void addOverviewHierarchyAnnotationChildren(System.Windows.Forms.TreeNode Node)
        {
            System.Data.DataRow R = (System.Data.DataRow)Node.Tag;
            string ReferencedTable = R["ReferencedTable"].ToString();
            int ReferencedID = int.Parse(R["ReferencedID"].ToString());
            int AnnotationID = int.Parse(R["AnnotationID"].ToString());
            System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.Annotation.Select("ReferencedTable = '" + ReferencedTable + "' AND ReferencedID = " + ReferencedID.ToString() + " AND ReferencedAnnotationID = " + AnnotationID.ToString(), "AnnotationID");
            foreach (System.Data.DataRow RC in RR)
            {
                DiversityCollection.HierarchyNode N = new HierarchyNode(RC, false);
                Node.Nodes.Add(N);
                this.addOverviewHierarchyAnnotationChildren(N);
            }
        }
        
        #endregion

        #region Units

        #region Common

        private void buildOverviewHierarchyUnits()
        {
            this.treeViewOverviewHierarchy.Visible = false;
            this.treeViewOverviewHierarchy.Nodes.Clear();
            try
            {
                if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count > 0)
                {
                    if (
                        (!this.ShowEventSeries && !this.ShowEventSeriesHierarchy && !this.ShowSamplingPlots && !this.ShowSamplingPlotsHierarchy) 
                        ||
                        (this.dataSetCollectionEventSeries.CollectionEventSeries.Rows.Count == 0 &&
                        (this._DataSetSamplingPlotList == null || this._DataSetSamplingPlotList.SamplingPlot.Rows.Count == 0))) 
                    { 
                        System.Windows.Forms.TreeNode SpecimenNode;
                        System.Windows.Forms.TreeNode EventNode;
                        if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].Equals(System.DBNull.Value))
                        {
                            SpecimenNode = this.OverviewHierarchySpecimenNode;
                            this.treeViewOverviewHierarchy.Nodes.Add(SpecimenNode);
                        }
                        else
                        {
                            EventNode = this.OverviewHierarchyEventNode;
                            this.treeViewOverviewHierarchy.Nodes.Add(EventNode);
                            SpecimenNode = this.OverviewHierarchySpecimenNode;
                            EventNode.Nodes.Add(SpecimenNode);
                            EventNode.Expand();
                            SpecimenNode.Expand();
                            if (this.ShowEventSeriesHierarchy && this.dataSetCollectionEventSeries.CollectionSpecimenList.Rows.Count > 1)
                            {
                                this.getEventSeriesEventSpecimen(EventNode, SpecimenID);
                            }
                        }
                    }
                    else
                    {
                        if (this.ShowEventSeriesHierarchy)
                        {
                            try
                            {
                                if (this.dataSetCollectionEventSeries.CollectionEventSeries.Rows.Count > 0)
                                {
                                    this.addEventSeries();
                                }
                                else if (this.dataSetCollectionEventSeries.CollectionEventList.Rows.Count > 0)
                                {
                                    System.Windows.Forms.TreeNode SpecimenNode;
                                    System.Windows.Forms.TreeNode EventNode;
                                    EventNode = this.OverviewHierarchyEventNode;
                                    this.treeViewOverviewHierarchy.Nodes.Add(EventNode);
                                    int SpecimenID = int.Parse(this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionSpecimenID"].ToString());
                                    this.getEventSeriesEventSpecimen(EventNode, SpecimenID);
                                    SpecimenNode = this.OverviewHierarchySpecimenNode;
                                    EventNode.Nodes.Add(SpecimenNode);
                                    EventNode.Expand();
                                    SpecimenNode.Expand();

                                    //this.getEventSeriesEvents(null);
                                }
                            }
                            catch (Exception ex)
                            {
                                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                            }
                        }
                        else if (this.ShowEventSeries)
                        {
                            if (this.dataSetCollectionSpecimen.CollectionEventSeries.Rows.Count > 0)
                            {
                                System.Windows.Forms.TreeNode N = this.addEventSeriesSuperiorList();
                                System.Windows.Forms.TreeNode EventNode = this.OverviewHierarchyEventNode;
                                N.Nodes.Add(EventNode);
                                System.Windows.Forms.TreeNode SpecimenNode = this.OverviewHierarchySpecimenNode;
                                EventNode.Nodes.Add(SpecimenNode);
                            }
                        }
                        else if ((this.ShowSamplingPlots || this.ShowSamplingPlotsHierarchy) &&
                            this._DataSetSamplingPlotList.SamplingPlot.Rows.Count > 0)
                        {
                            try
                            {
                                if (this.DisplayStyleSamplingPlots == HierachyDisplayStyle.Hierarchy)
                                    this.addSamplingPlot();
                                else
                                    if (this._DataSetSamplingPlotList.SamplingPlot.Rows.Count > 0)
                                    {
                                        System.Windows.Forms.TreeNode N = this.addPlotSuperiorList();
                                        System.Windows.Forms.TreeNode EventNode = this.OverviewHierarchyEventNode;
                                        N.Nodes.Add(EventNode);
                                        System.Windows.Forms.TreeNode SpecimenNode = this.OverviewHierarchySpecimenNode;
                                        EventNode.Nodes.Add(SpecimenNode);
                                    }
                            }
                            catch (Exception ex)
                            {
                                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                            }

                        }
                        else
                        {
                            System.Windows.Forms.TreeNode SpecimenNode;
                            System.Windows.Forms.TreeNode EventNode;
                            if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].Equals(System.DBNull.Value))
                            {
                                SpecimenNode = this.OverviewHierarchySpecimenNode;
                                this.treeViewOverviewHierarchy.Nodes.Add(SpecimenNode);
                            }
                            else
                            {
                                EventNode = this.OverviewHierarchyEventNode;
                                this.treeViewOverviewHierarchy.Nodes.Add(EventNode);
                                SpecimenNode = this.OverviewHierarchySpecimenNode;
                                EventNode.Nodes.Add(SpecimenNode);
                                EventNode.Expand();
                                SpecimenNode.Expand();
                            }
                        }
                    }
                    this.addOverviewHierarchyDependentData();
                    this.OverviewHierarchySpecimenNodeToEnd();
                    this.OverviewHierarchyUnitNodesToEnd();
                    this.addOverviewHierarchyIdentifier(IdentifierTarget.Units);
                    this.addOverviewHierarchyAnnotations(AnnotationTarget.Units);
                    this.treeViewOverviewHierarchy.ExpandAll();
                }
                if (this.ShowEventSeriesHierarchy || this.ShowSamplingPlotsHierarchy)
                    this.SpecimenCurrentUnitTreeNode(null).EnsureVisible();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.treeViewOverviewHierarchy.Visible = true;
            }
        }

        private void addOverviewHierarchyDependentData()
        {
            this.addOverviewHierarchyEventLocalisation();
            this.addOverviewHierarchyEventProperty();
            this.addOverviewHierarchyEventRegulation();
            //this.addOverviewHierarchyProjectRegulation();
            this.addOverviewHierarchyUnits();
            this.addOverviewHierarchyAgents();
            this.addOverviewHierarchyReferences();
            this.addOverviewHierarchyRelations();
        }

        private void hideOverviewHierarchyNodes(string Table)
        {
            System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
            this.getOverviewHierarchyNodes(null, Table, this.treeViewOverviewHierarchy, ref Nodes);
            foreach (System.Windows.Forms.TreeNode N in Nodes)
                N.Remove();
        }

        #endregion

        #region Event Series

        /// <summary>
        /// Adding the superior event series nodes 
        /// </summary>
        /// <returns>The node of the uppermost event series</returns>
        private System.Windows.Forms.TreeNode addEventSeriesSuperiorList()
        {
            System.Windows.Forms.TreeNode ParentNode = new TreeNode();
            try
            {
                if (this.NoLoopInEventSeries())
                {
                    foreach (System.Data.DataRow r in this.dataSetCollectionSpecimen.CollectionEventSeries.Rows)
                    {
                        if (r["SeriesParentID"].Equals(System.DBNull.Value)/* || r["SeriesParentID"].ToString() == r["SeriesID"].ToString()*/)
                        {
                            DiversityCollection.HierarchyNode N = new HierarchyNode(this.CollectionEventSeriesDataRowFromEventDataset(r), false);
                            ParentNode = N;
                            this.treeViewOverviewHierarchy.Nodes.Add(N);
                            this.getEventSeriesSuperiorChilds(N, ref ParentNode);
                        }
                    }
                }
                else
                {
                    string SeriesID = this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"].ToString();
                    System.Data.DataRow[] rr = this.dataSetCollectionEventSeries.CollectionEventSeries.Select("SeriesID = " + SeriesID);
                    ParentNode = new HierarchyNode(this.CollectionEventSeriesDataRowFromEventDataset(rr[0]), false);
                    System.Windows.Forms.MessageBox.Show("The event series contains a loop. Please set the series for the collection event");
                    this.treeViewOverviewHierarchy.Nodes.Add(ParentNode);
                }
            }
            catch { }

            return ParentNode;
        }

        private System.Data.DataRow CollectionEventSeriesDataRowFromEventDataset(System.Data.DataRow DataRowFromSpecimenDataset)
        {
            System.Data.DataRow Rseries = this.dataSetCollectionEventSeries.CollectionEventSeries.Rows[0];
            try
            {
                foreach (System.Data.DataRow R in this.dataSetCollectionEventSeries.CollectionEventSeries.Rows)
                {
                    if (R["SeriesID"].ToString() == DataRowFromSpecimenDataset["SeriesID"].ToString())
                    {
                        Rseries = R;
                        break;
                    }
                }
            }
            catch { }
            return Rseries;
        }

        /// <summary>
        /// getting the child nodes of an event series
        /// </summary>
        /// <param name="Node">the current</param>
        /// <param name="ParentNode">the node lowest to which the collection event will be added</param>
        private void getEventSeriesSuperiorChilds(System.Windows.Forms.TreeNode Node, ref System.Windows.Forms.TreeNode ParentNode)
        {
            try
            {
                System.Data.DataRow rParent = (System.Data.DataRow)Node.Tag;
                string SeriesParentID = rParent["SeriesID"].ToString();
                // all rows that are a child to the parent node
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionEventSeries.Select("SeriesParentID = " + rParent["SeriesID"].ToString(), "DateStart");
                foreach (System.Data.DataRow rO in rr)
                {
                    // for every row in the dataset with the same SeriesID for one of the found rows
                    foreach (System.Data.DataRow r in this.dataSetCollectionSpecimen.CollectionEventSeries.Rows)
                    {
                        if (rO["SeriesID"].ToString() == r["SeriesID"].ToString()
                            && !rO["SeriesParentID"].Equals(System.DBNull.Value)
                            && !r["SeriesParentID"].Equals(System.DBNull.Value))
                        {
                            //DiversityCollection.HierarchyNode N = new HierarchyNode(this.CollectionEventSeriesDataRowFromEventDataset(r), false);
                            DiversityCollection.HierarchyNode N = new HierarchyNode(r, false);
                            Node.Nodes.Add(N);
                            ParentNode = N;
                            this.getEventSeriesSuperiorChilds(N, ref ParentNode);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        ///// <summary>
        ///// getting the child nodes of an event series
        ///// </summary>
        ///// <param name="Node"></param>
        ///// <param name="ParentNode"></param>
        //private void getEventSeriesSuperiorChilds(System.Windows.Forms.TreeNode Node)
        //{
        //    try
        //    {
        //        // the data row of the parent node
        //        System.Data.DataRow rParent = (System.Data.DataRow)Node.Tag;
        //        string SeriesParentID = rParent["SeriesID"].ToString();
        //        // all rows that are a child to the parent node
        //        System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionEventSeries.Select("SeriesParentID = " + rParent["SeriesID"].ToString(), "DateStart");
        //        foreach (System.Data.DataRow rO in rr)
        //        {
        //            // for every row in the dataset with the same SeriesID for one of the found rows
        //            foreach (System.Data.DataRow r in this.dataSetCollectionSpecimen.CollectionEventSeries.Rows)
        //            {
        //                if (rO["SeriesID"].ToString() == r["SeriesID"].ToString()
        //                    && !rO["SeriesParentID"].Equals(System.DBNull.Value)
        //                    && !r["SeriesParentID"].Equals(System.DBNull.Value))
        //                {
        //                    //DiversityCollection.HierarchyNode N = new HierarchyNode(this.CollectionEventSeriesDataRowFromEventDataset(r), false);
        //                    DiversityCollection.HierarchyNode N = new HierarchyNode(r, false);
        //                    Node.Nodes.Add(N);
        //                    this.getEventSeriesSuperiorChilds(N);
        //                    //ParentNode = N;
        //                }
        //            }
        //        }
        //    }
        //    catch (Exception ex)
        //    {
        //        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
        //    }
        //}

        private void addEventSeries()
        {
            foreach (System.Data.DataRow r in this.dataSetCollectionEventSeries.CollectionEventSeries.Rows)
            {
                if (r["SeriesParentID"].Equals(System.DBNull.Value))
                {
                    DiversityCollection.HierarchyNode N = new HierarchyNode(r, false);
                    this.treeViewOverviewHierarchy.Nodes.Add(N);
                    this.getEventSeriesChilds(N);
                    this.getEventSeriesEvents(N);
                }
            }
            if (this.treeViewOverviewHierarchy.Nodes.Count == 0)
            {
                this.addEventSeriesSuperiorList();
                System.Windows.Forms.TreeNode EventNode = this.OverviewHierarchyEventNode;
                this.treeViewOverviewHierarchy.Nodes[0].Nodes.Add(EventNode);
                System.Windows.Forms.TreeNode SpecimenNode = this.OverviewHierarchySpecimenNode;
                EventNode.Nodes.Add(SpecimenNode);
            }
            this.replaceEventListNode();
        }

        private void getEventSeriesChilds(System.Windows.Forms.TreeNode Node)
        {
            try
            {
                System.Data.DataRow rParent = (System.Data.DataRow)Node.Tag;
                string SeriesParentID = rParent["SeriesID"].ToString();
                System.Data.DataRow[] rr = this.dataSetCollectionEventSeries.CollectionEventSeries.Select("SeriesParentID = " + rParent["SeriesID"].ToString(), "DateStart");
                foreach (System.Data.DataRow rO in rr)
                {
                    foreach (System.Data.DataRow r in this.dataSetCollectionEventSeries.CollectionEventSeries.Rows)
                    {
                        if (rO["SeriesID"].ToString() == r["SeriesID"].ToString())
                        {
                            DiversityCollection.HierarchyNode N = new HierarchyNode(r, false);
                            Node.Nodes.Add(N);
                            this.getEventSeriesChilds(N);
                            this.getEventSeriesEvents(N);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void getEventSeriesEvents(System.Windows.Forms.TreeNode Node)
        {
            try
            {
                if (Node != null)
                {
                    System.Data.DataRow rParent = (System.Data.DataRow)Node.Tag;
                    string SeriesID = rParent["SeriesID"].ToString();
                    foreach (System.Data.DataRow r in this.dataSetCollectionEventSeries.CollectionEventList.Rows)
                    {
                        if (r["SeriesID"].ToString() == SeriesID)
                        {
                            DiversityCollection.HierarchyNode N = new HierarchyNode(r, true);
                            Node.Nodes.Add(N);
                            this.getEventSeriesEventSpecimen(N);
                        }
                    }
                }
                else
                {
                    System.Data.DataRow rEvent = this.dataSetCollectionEventSeries.CollectionEventList.Rows[0];
                    DiversityCollection.HierarchyNode N = new HierarchyNode(rEvent, true);
                    this.treeViewOverviewHierarchy.Nodes.Add(N);
                    this.getEventSeriesEventSpecimen(N);
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void getEventSeriesEventSpecimen(System.Windows.Forms.TreeNode Node)
        {
            try
            {
                System.Data.DataRow rParent = (System.Data.DataRow)Node.Tag;
                string CollectionEventID = rParent["CollectionEventID"].ToString();
                foreach (System.Data.DataRow r in this.dataSetCollectionEventSeries.CollectionSpecimenList.Rows)
                {
                    if (r["CollectionEventID"].ToString() == CollectionEventID)
                    {
                        DiversityCollection.HierarchyNode N = new HierarchyNode(r, false);
                        Node.Nodes.Add(N);
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void getEventSeriesEventSpecimen(System.Windows.Forms.TreeNode Node, int MainSpecimenID)
        {
            try
            {
                System.Data.DataRow rParent = (System.Data.DataRow)Node.Tag;
                string CollectionEventID = rParent["CollectionEventID"].ToString();
                foreach (System.Data.DataRow r in this.dataSetCollectionEventSeries.CollectionSpecimenList.Rows)
                {
                    if (r["CollectionEventID"].ToString() == CollectionEventID && r["CollectionSpecimenID"].ToString() != MainSpecimenID.ToString())
                    {
                        DiversityCollection.HierarchyNode N = new HierarchyNode(r, false);
                        Node.Nodes.Add(N);
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void getEventSeriesEventSpecimenUnits(System.Windows.Forms.TreeNode Node)
        {
            if (!this.ShowUnit) return;
            try
            {
                if (Node.Nodes.Count > 0)
                {
                    foreach (System.Windows.Forms.TreeNode NChild in Node.Nodes)
                    {
                        System.Data.DataRow RChildNode = (System.Data.DataRow)NChild.Tag;
                        if (RChildNode.Table.TableName == "IdentificationUnitList")
                        {
                            this.getEventSeriesEventSpecimenUnitChilds(NChild);
                            return;
                        }
                    }
                }

                System.Data.DataRow rParent = (System.Data.DataRow)Node.Tag;
                string CollectionSpecimenID = rParent["CollectionSpecimenID"].ToString();
                foreach (System.Data.DataRow r in this.dataSetCollectionEventSeries.IdentificationUnitList.Rows)
                {
                    if (r["CollectionSpecimenID"].ToString() == CollectionSpecimenID
                        && r["RelatedUnitID"].Equals(System.DBNull.Value))
                    {
                        //// Check if there is already a unit node
                        //if (Node.Nodes.Count > 0)
                        //{
                        //    foreach (System.Windows.Forms.TreeNode NChild in Node.Nodes)
                        //    {
                        //        System.Data.DataRow RChildNode = (System.Data.DataRow)NChild.Tag;
                        //        if (r["IdentificationUnitID"].ToString() == RChildNode["IdentificationUnitID"].ToString()
                        //            && NChild.Nodes.Count == 0)
                        //        {
                        //            this.getEventSeriesEventSpecimenUnitChilds(NChild);
                        //            return;
                        //        }
                        //    }
                        //}

                        //System.Collections.Generic.List<System.Windows.Forms.TreeNode> UnitListNodes = new List<TreeNode>();
                        //this.getOverviewHierarchyNodes(null, "IdentificationUnitList", this.treeViewOverviewHierarchy, ref UnitListNodes);
                        //if (UnitListNodes.Count > 0 && !BaseNodeMissing)
                        //{
                        //    foreach (System.Windows.Forms.TreeNode TN in UnitListNodes)
                        //    {
                        //        System.Data.DataRow RNode = (System.Data.DataRow)TN.Tag;
                        //        if (r["IdentificationUnitID"].ToString() == RNode["IdentificationUnitID"].ToString())
                        //        {
                        //            this.getEventSeriesEventSpecimenUnitChilds(TN);
                        //            return;
                        //        }
                        //    }
                        //}
                        DiversityCollection.HierarchyNode N = new HierarchyNode(r, true);
                        Node.Nodes.Add(N);
                        this.getEventSeriesEventSpecimenUnitChilds(N);
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void getEventSeriesEventSpecimenUnitChilds(System.Windows.Forms.TreeNode Node)
        {
            if (!this.ShowUnit) return;
            try
            {
                System.Data.DataRow rParent = (System.Data.DataRow)Node.Tag;
                string CollectionSpecimenID = rParent["CollectionSpecimenID"].ToString();
                string SubstrateID = rParent["IdentificationUnitID"].ToString();
                foreach (System.Data.DataRow r in this.dataSetCollectionEventSeries.IdentificationUnitList.Rows)
                {
                    if (r["CollectionSpecimenID"].ToString() == CollectionSpecimenID && r["RelatedUnitID"].ToString() == SubstrateID && SubstrateID != null)
                    {
                        DiversityCollection.HierarchyNode N = new HierarchyNode(r, true);
                        Node.Nodes.Add(N);
                        this.getEventSeriesEventSpecimenUnitChilds(N);
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void replaceEventListNode()
        {
            System.Collections.Generic.List<System.Windows.Forms.TreeNode> EventNodes = new List<TreeNode>();
            this.getOverviewHierarchyNodes(null, "CollectionEventList", this.treeViewOverviewHierarchy, ref EventNodes);
            this.treeViewOverviewHierarchy.CollapseAll();
            foreach (System.Windows.Forms.TreeNode N in EventNodes)
            {
                System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                if (R["CollectionEventID"].ToString() == this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].ToString())
                {
                    System.Windows.Forms.TreeNode ParentNode = N.Parent;
                    N.Remove();
                    System.Windows.Forms.TreeNode EventNode = this.OverviewHierarchyEventNode;
                    ParentNode.Nodes.Add(EventNode);
                    System.Windows.Forms.TreeNode SpecimenNode = this.OverviewHierarchySpecimenNode;
                    int CollectionSpecimenID = int.Parse(this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionSpecimenID"].ToString());
                    this.getEventSeriesEventSpecimen(EventNode, CollectionSpecimenID);
                    EventNode.Nodes.Add(SpecimenNode);
                    SpecimenNode.Expand();
                    this.treeViewOverviewHierarchy.SelectedNode = SpecimenNode;
                    this.treeViewOverviewHierarchy.SelectedNode = null;
                    EventNode.ExpandAll();
                    //ParentNode.ExpandAll();
                    return;
                }
            }
        }

        private void addOverviewHierarchyEventSeriesHierarchy()
        {
            if (this.ShowEventSeries)
            {
                //System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                //this.getOverviewHierarchyNodes(null, "CollectionEvent", this.treeViewOverviewHierarchy, ref Nodes);
                //foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionEventProperty.Rows)
                //{
                //    DiversityCollection.HierarchyNode NA = new HierarchyNode(R);
                //    NA.ImageIndex = (int)DiversityCollection.Specimen.OverviewImage.EventProperty;
                //    NA.SelectedImageIndex = (int)DiversityCollection.Specimen.OverviewImage.EventProperty;
                //    NA.ForeColor = System.Drawing.Color.Green;
                //    Nodes[0].Nodes.Add(NA);
                //}
            }
        }

        private void addOverviewHierarchyEventSeries()
        {
            if (this.ShowEventSeries)
            {
                //System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                //this.getOverviewHierarchyNodes(null, "CollectionEvent", this.treeViewOverviewHierarchy, ref Nodes);
                //foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionEventProperty.Rows)
                //{
                //    DiversityCollection.HierarchyNode NA = new HierarchyNode(R);
                //    NA.ImageIndex = (int)DiversityCollection.Specimen.OverviewImage.EventProperty;
                //    NA.SelectedImageIndex = (int)DiversityCollection.Specimen.OverviewImage.EventProperty;
                //    NA.ForeColor = System.Drawing.Color.Green;
                //    Nodes[0].Nodes.Add(NA);
                //}
            }
        }

        private void buttonEventSeriesSetGeo_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRowView RA
                    = (System.Data.DataRowView)this.collectionEventSeriesBindingSource.Current;
                if (this.dataSetCollectionSpecimen.CollectionEventSeriesGeo.Rows.Count == 0)
                {
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventSeriesGeoRow R = this.dataSetCollectionSpecimen.CollectionEventSeriesGeo.NewCollectionEventSeriesGeoRow();
                    R.SeriesID = (int)this.SeriesID;
                    this.dataSetCollectionSpecimen.CollectionEventSeriesGeo.Rows.Add(R);
                }
                if (this.dataSetCollectionSpecimen.CollectionEventSeriesGeo.Rows.Count == 1)
                {
                    if (!this.dataSetCollectionSpecimen.CollectionEventSeriesGeo.Rows[0]["GeographyAsString"].Equals(System.DBNull.Value))
                    {
                        string Geography = this.dataSetCollectionSpecimen.CollectionEventSeriesGeo.Rows[0]["GeographyAsString"].ToString();
                        GeoObject GO = new GeoObject();
                        GO.GeometryData = Geography;
                        GO.FillBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(255, 1, 1));
                        GO.FillTransparency = 50;
                        GO.Identifier = "X";
                        GO.PointSymbolSize = 1;
                        GO.StrokeBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(255, 1, 1));
                        GO.StrokeThickness = 1;
                        GO.StrokeTransparency = 255;
                        GO.DisplayText = "X";
                        System.Collections.Generic.List<GeoObject> L = new List<GeoObject>();
                        L.Add(GO);
                        DiversityWorkbench.FormGeography f = new DiversityWorkbench.FormGeography(L);
                        f.ShowDialog();
                        if (f.DialogResult == DialogResult.OK && f.Geography.Length > 0)
                        {
                            string SQL = "Update CollectionEventSeries SET Geography = geography::STGeomFromText('" + f.Geography + "', 4326)"
                               + " WHERE SeriesID = " + this.SeriesID.ToString();
                            string Message = "";
                            DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL, ref Message);
                            if (Message.Length > 0)
                            {
                                System.Windows.Forms.MessageBox.Show(Message);
                                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile("buttonEventSeriesSetGeo_Click(sender, e)", SQL, Message);
                            }
                            this.updateSpecimen();
                        }
                    }
                    else
                    {
                        DiversityWorkbench.FormGeography f = new DiversityWorkbench.FormGeography();
                        f.ShowDialog();
                        if (f.DialogResult == DialogResult.OK && f.Geography.Length > 0)
                        {
                            string SQL = "Update CollectionEventSeries SET Geography = geography::STGeomFromText('" + f.Geography + "', 4326)"
                                + " WHERE SeriesID = " + this.SeriesID.ToString();
                            string Message = "";
                            DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL, ref Message);
                            if (Message.Length > 0)
                            {
                                System.Windows.Forms.MessageBox.Show(Message);
                                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile("buttonEventSeriesSetGeo_Click(sender, e)", SQL, Message);
                            }
                            this.updateSpecimen();
                        }
                    }
                }
            }
            catch { }
        }

        #region Hiding

        private void hideOverviewHierarchyEventSeriesHierarchy()
        {
            this.hideOverviewHierarchyNodes("CollectionEventSeries");
            this.hideOverviewHierarchyNodes("CollectionEventSeries");
            this.hideOverviewHierarchyNodes("CollectionEventSeries");
            this.hideOverviewHierarchyNodes("CollectionEventSeries");
        }

        private void hideOverviewHierarchyEventSeries()
        {
            this.hideOverviewHierarchyNodes("CollectionEventSeries");
        }

        #endregion

        #endregion

        #region Sampling plots

        private System.Windows.Forms.TreeNode addPlotSuperiorList()
        {
            System.Windows.Forms.TreeNode ParentNode = new TreeNode();
            try
            {
                //if (this.NoLoopInEventSeries())
                //{
                    foreach (System.Data.DataRow r in this._DataSetSamplingPlotList.SamplingPlot.Rows)
                    {
                        if (r["PlotID"].ToString() == this._CurrentPlotID) /* || r["SeriesParentID"].ToString() == r["SeriesID"].ToString()*/
                        {
                            DiversityCollection.HierarchyNode N = new HierarchyNode(this.SamplingPlotDataRowFromEventDataset(r), false);
                            ParentNode = N;
                            System.Collections.Generic.List<DiversityCollection.HierarchyNode> Nodes = new List<HierarchyNode>();
                            Nodes.Add(N);
                            this.getPlotSuperiorList(N, ref ParentNode, ref Nodes);
                            this.treeViewOverviewHierarchy.Nodes.Add(ParentNode);
                            for (int i = Nodes.Count - 2; i > -1; i--)
                            {
                                ParentNode.Nodes.Add(Nodes[i]);
                                ParentNode = Nodes[i];
                            }
                            //foreach (DiversityCollection.HierarchyNode H in Nodes)
                            //{
                            //    ParentNode.Nodes.Add(H);
                            //    ParentNode = H;
                            //}
                            //this.treeViewOverviewHierarchy.Nodes.Add(N);
                        }
                    }
                //}
                //else
                //{
                //    string SeriesID = this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"].ToString();
                //    System.Data.DataRow[] rr = this.dataSetCollectionEventSeries.CollectionEventSeries.Select("SeriesID = " + SeriesID);
                //    ParentNode = new HierarchyNode(this.CollectionEventSeriesDataRowFromEventDataset(rr[0]), false);
                //    System.Windows.Forms.MessageBox.Show("The event series contains a loop. Please set the series for the collection event");
                //    this.treeViewOverviewHierarchy.Nodes.Add(ParentNode);
                //}
            }
            catch { }

            return ParentNode;
        }

        private void getPlotSuperiorList(System.Windows.Forms.TreeNode Node, ref System.Windows.Forms.TreeNode ParentNode, ref System.Collections.Generic.List<DiversityCollection.HierarchyNode> Nodes)
        {
            try
            {
                System.Data.DataRow rParent = (System.Data.DataRow)Node.Tag;
                string PartOfPlotID = rParent["PlotID"].ToString();
                // all rows that are a child to the parent node
                System.Data.DataRow[] rr = this._DataSetSamplingPlotList.SamplingPlot.Select("PlotID = '" + rParent["PartOfPlotID"].ToString() + "'");
                foreach (System.Data.DataRow rO in rr)
                {
                    // for every row in the dataset with the same SeriesID for one of the found rows
                    foreach (System.Data.DataRow r in this._DataSetSamplingPlotList.SamplingPlot.Rows)
                    {
                        if (rO["PlotID"].ToString() == r["PlotID"].ToString()
                            && !rO["PartOfPlotID"].Equals(System.DBNull.Value)
                            && !r["PartOfPlotID"].Equals(System.DBNull.Value))
                        {
                            DiversityCollection.HierarchyNode N = new HierarchyNode(r, false);
                            Nodes.Add(N);
                            //Node.Nodes.Add(N);
                            ParentNode = N;
                            this.getPlotSuperiorList(N, ref ParentNode, ref Nodes);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private System.Data.DataRow SamplingPlotDataRowFromEventDataset(System.Data.DataRow DataRowFromSpecimenDataset)
        {
            System.Data.DataRow RPlot = this._DataSetSamplingPlotList.SamplingPlot.Rows[0];
            try
            {
                foreach (System.Data.DataRow R in this._DataSetSamplingPlotList.SamplingPlot.Rows)
                {
                    if (R["PlotID"].ToString() == DataRowFromSpecimenDataset["PlotID"].ToString())
                    {
                        RPlot = R;
                        break;
                    }
                }
            }
            catch { }
            return RPlot;
        }

        private void addSamplingPlot()
        {
            foreach (System.Data.DataRow r in this._DataSetSamplingPlotList.SamplingPlot.Rows)
            {
                if (r["PartOfPlotID"].Equals(System.DBNull.Value) || r["PartOfPlotID"].ToString().Length == 0)
                {
                    DiversityCollection.HierarchyNode N = new HierarchyNode(r, false);
                    this.treeViewOverviewHierarchy.Nodes.Add(N);
                    this.getPlotChilds(N);
                    this.getPlotEvents(N);
                }
            }
            if (this.treeViewOverviewHierarchy.Nodes.Count == 0)
            {
                this.addEventSeriesSuperiorList();
                System.Windows.Forms.TreeNode EventNode = this.OverviewHierarchyEventNode;
                this.treeViewOverviewHierarchy.Nodes[0].Nodes.Add(EventNode);
                System.Windows.Forms.TreeNode SpecimenNode = this.OverviewHierarchySpecimenNode;
                EventNode.Nodes.Add(SpecimenNode);
            }
            this.replaceEventListNode();
        }

        private void getPlotChilds(System.Windows.Forms.TreeNode Node)
        {
            try
            {
                System.Data.DataRow rParent = (System.Data.DataRow)Node.Tag;
                string SeriesParentID = rParent["PlotID"].ToString();
                System.Data.DataRow[] rr = this._DataSetSamplingPlotList.SamplingPlot.Select("PartOfPlotID = '" + rParent["PlotID"].ToString() + "'");
                foreach (System.Data.DataRow rO in rr)
                {
                    foreach (System.Data.DataRow r in this._DataSetSamplingPlotList.SamplingPlot.Rows)
                    {
                        if (rO["PlotID"].ToString() == r["PlotID"].ToString())
                        {
                            DiversityCollection.HierarchyNode N = new HierarchyNode(r, false);
                            Node.Nodes.Add(N);
                            this.getPlotChilds(N);
                            this.getPlotEvents(N);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void getPlotEvents(System.Windows.Forms.TreeNode Node)
        {
            try
            {
                if (Node != null)
                {
                    System.Data.DataRow rParent = (System.Data.DataRow)Node.Tag;
                    string SeriesID = rParent["PlotID"].ToString();
                    foreach (System.Data.DataRow r in this._DataSetSamplingPlotList.CollectionEventList.Rows)
                    {
                        if (r["PlotID"].ToString() == SeriesID)
                        {
                            DiversityCollection.HierarchyNode N = new HierarchyNode(r, true);
                            Node.Nodes.Add(N);
                            this.getPlotEventSpecimen(N);
                        }
                    }
                }
                else
                {
                    System.Data.DataRow rEvent = this._DataSetSamplingPlotList.CollectionEventList.Rows[0];
                    DiversityCollection.HierarchyNode N = new HierarchyNode(rEvent, true);
                    this.treeViewOverviewHierarchy.Nodes.Add(N);
                    this.getPlotEventSpecimen(N);
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void getPlotEventSpecimen(System.Windows.Forms.TreeNode Node)
        {
            try
            {
                System.Data.DataRow rParent = (System.Data.DataRow)Node.Tag;
                string CollectionEventID = rParent["CollectionEventID"].ToString();
                foreach (System.Data.DataRow r in this._DataSetSamplingPlotList.CollectionSpecimenList.Rows)
                {
                    if (r["CollectionEventID"].ToString() == CollectionEventID)
                    {
                        DiversityCollection.HierarchyNode N = new HierarchyNode(r, false);
                        Node.Nodes.Add(N);
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void getPlotEventSpecimen(System.Windows.Forms.TreeNode Node, int MainSpecimenID)
        {
            try
            {
                System.Data.DataRow rParent = (System.Data.DataRow)Node.Tag;
                string CollectionEventID = rParent["CollectionEventID"].ToString();
                foreach (System.Data.DataRow r in this._DataSetSamplingPlotList.CollectionSpecimenList.Rows)
                {
                    if (r["CollectionEventID"].ToString() == CollectionEventID && r["CollectionSpecimenID"].ToString() != MainSpecimenID.ToString())
                    {
                        DiversityCollection.HierarchyNode N = new HierarchyNode(r, false);
                        Node.Nodes.Add(N);
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void getPlotEventSpecimenUnits(System.Windows.Forms.TreeNode Node)
        {
            if (!this.ShowUnit) return;
            try
            {
                if (Node.Nodes.Count > 0)
                {
                    foreach (System.Windows.Forms.TreeNode NChild in Node.Nodes)
                    {
                        System.Data.DataRow RChildNode = (System.Data.DataRow)NChild.Tag;
                        if (RChildNode.Table.TableName == "IdentificationUnitList")
                        {
                            this.getPlotEventSpecimenUnitChilds(NChild);
                            return;
                        }
                    }
                }

                System.Data.DataRow rParent = (System.Data.DataRow)Node.Tag;
                string CollectionSpecimenID = rParent["CollectionSpecimenID"].ToString();
                foreach (System.Data.DataRow r in this._DataSetSamplingPlotList.IdentificationUnitList.Rows)
                {
                    if (r["CollectionSpecimenID"].ToString() == CollectionSpecimenID
                        && r["RelatedUnitID"].Equals(System.DBNull.Value))
                    {
                        DiversityCollection.HierarchyNode N = new HierarchyNode(r, true);
                        Node.Nodes.Add(N);
                        this.getPlotEventSpecimenUnitChilds(N);
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void getPlotEventSpecimenUnitChilds(System.Windows.Forms.TreeNode Node)
        {
            if (!this.ShowUnit) return;
            try
            {
                System.Data.DataRow rParent = (System.Data.DataRow)Node.Tag;
                string CollectionSpecimenID = rParent["CollectionSpecimenID"].ToString();
                string SubstrateID = rParent["IdentificationUnitID"].ToString();
                foreach (System.Data.DataRow r in this._DataSetSamplingPlotList.IdentificationUnitList.Rows)
                {
                    if (r["CollectionSpecimenID"].ToString() == CollectionSpecimenID && r["RelatedUnitID"].ToString() == SubstrateID && SubstrateID != null)
                    {
                        DiversityCollection.HierarchyNode N = new HierarchyNode(r, true);
                        Node.Nodes.Add(N);
                        this.getPlotEventSpecimenUnitChilds(N);
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }
       
        #endregion

        #region Event

        private System.Windows.Forms.TreeNode OverviewHierarchyEventNode
        {
            get
            {
                if (this.dataSetCollectionSpecimen.CollectionEvent.Rows.Count > 0)
                {
                    DiversityCollection.HierarchyNode N = new HierarchyNode(this.dataSetCollectionSpecimen.CollectionEvent.Rows[0], false);
                    return N;
                }
                else
                {
                    System.Windows.Forms.TreeNode N = new System.Windows.Forms.TreeNode("?");
                    N.ImageIndex = (int)DiversityCollection.Specimen.OverviewImage.Event;
                    N.SelectedImageIndex = (int)DiversityCollection.Specimen.OverviewImage.Event;
                    return N;
                }
            }
        }

        private void refreshHierarchyUnitEventNode(System.Windows.Forms.TreeNode Node)
        {
            System.Windows.Forms.TreeNode NodeToRefresh;
            System.Data.DataRow R = (System.Data.DataRow)Node.Tag;
            int EventID = int.Parse(R["CollectionEventID"].ToString());
            if (R.Table.TableName == "CollectionEvent") NodeToRefresh = Node;
            else if (R.Table.TableName == "CollectionEventLocalisation" ||
                R.Table.TableName == "CollectionEventProperty") NodeToRefresh = Node.Parent;
            else return;
            if (NodeToRefresh != null)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> DependentNodes = new List<TreeNode>();
                foreach (System.Windows.Forms.TreeNode N in NodeToRefresh.Nodes)
                {
                    System.Data.DataRow Rdep = (System.Data.DataRow)N.Tag;
                    if (Rdep.Table.TableName == "CollectionEventLocalisation"
                        || Rdep.Table.TableName == "CollectionEventProperty")
                        DependentNodes.Add(N);
                }
                foreach (System.Windows.Forms.TreeNode ND in DependentNodes)
                    ND.Remove();
                this.addOverviewHierarchyEventLocalisation();
                this.addOverviewHierarchyEventProperty();
                //this.addOverviewHierarchyEventRegulation();
                ///TODO: freischalten wenns klappt
                //this.addOverviewHierarchyAnnotations();
                this.OverviewHierarchySpecimenNodeToEnd();
            }
        }

        #endregion

        #region EventLocalisation

        private void addOverviewHierarchyEventLocalisation()
        {
            if (this.ShowEventLocalisation)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionEvent", this.treeViewOverviewHierarchy, ref Nodes);
                if (Nodes.Count > 0)
                {
                    System.Collections.Generic.List<System.Windows.Forms.TreeNode> NodesSpecimen = new List<TreeNode>();
                    this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref NodesSpecimen);
                    Nodes[0].Nodes.Remove(NodesSpecimen[0]);
                    foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows)
                    {
                        if (R.RowState != DataRowState.Deleted && R.RowState != DataRowState.Detached)
                        {
                            DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                            Nodes[0].Nodes.Add(NA);
                        }
                    }
                    Nodes[0].Nodes.Add(NodesSpecimen[0]);
                }
            }
        }

        private void hideOverviewHierarchyEventLocalisation()
        {
            this.hideOverviewHierarchyNodes("CollectionEventLocalisation");
        }

        #endregion

        #region EventProperty

        private void addOverviewHierarchyEventProperty()
        {
            if (this.ShowEventProperty)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionEvent", this.treeViewOverviewHierarchy, ref Nodes);
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> NodesSpecimen = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref NodesSpecimen);
                if (Nodes.Count > 0)
                {
                    Nodes[0].Nodes.Remove(NodesSpecimen[0]);
                    foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionEventProperty.Rows)
                    {
                        if (R.RowState != DataRowState.Detached && R.RowState != DataRowState.Deleted)
                        {
                            DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                            Nodes[0].Nodes.Add(NA);
                        }
                    }
                    Nodes[0].Nodes.Add(NodesSpecimen[0]);
                }
            }
        }

        private void hideOverviewHierarchyEventProperty()
        {
            this.hideOverviewHierarchyNodes("CollectionEventProperty");
        }

        #endregion

        #region EventRegulation

        private void addOverviewHierarchyEventRegulation()
        {
           // return;


            //if (this.ShowEventRegulation)
            //{
            try
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionEvent", this.treeViewOverviewHierarchy, ref Nodes);
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> NodesSpecimen = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref NodesSpecimen);
                if (Nodes.Count > 0)
                {
                    Nodes[0].Nodes.Remove(NodesSpecimen[0]);
                    foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionEventRegulation.Rows)
                    {
                        if (R.RowState != DataRowState.Detached && R.RowState != DataRowState.Deleted)
                        {
                            DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                            Nodes[0].Nodes.Add(NA);
                        }
                    }
                    Nodes[0].Nodes.Add(NodesSpecimen[0]);
                }
            }
            catch (System.Exception ex)
            {
            }
            //}
        }

        //private void hideOverviewHierarchyEventRegulation()
        //{
        //    this.hideOverviewHierarchyNodes("CollectionEventRegulation");
        //}

        #endregion

        #region Specimen

        private System.Windows.Forms.TreeNode OverviewHierarchySpecimenNode
        {
            get
            {
                System.Drawing.Font F = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)10);//, System.Drawing.FontStyle.Bold | System.Drawing.FontStyle.Underline);//  
                if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count > 0)
                {
                    DiversityCollection.HierarchyNode SpecimenNode = new HierarchyNode(this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0], false);//, F);
                    SpecimenNode.Expand();
                    return SpecimenNode;
                }
                return null;
            }
        }

        private void OverviewHierarchySpecimenNodeToEnd()
        {
            System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
            this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref Nodes);
            foreach (System.Windows.Forms.TreeNode N in Nodes)
            {
                if (N.Parent != null)
                {
                    System.Windows.Forms.TreeNode NP = N.Parent;
                    N.Remove();
                    NP.Nodes.Add(N);
                }
            }
        }

        private void refreshHierarchyUnitSpecimenNode(System.Windows.Forms.TreeNode Node)
        {
            System.Windows.Forms.TreeNode NodeToRefresh;
            System.Data.DataRow R = (System.Data.DataRow)Node.Tag;
            int SpecimenID = int.Parse(R["CollectionSpecimenID"].ToString());
            if (R.Table.TableName == "CollectionSpecimen") NodeToRefresh = Node;
            else if (R.Table.TableName == "IdentificationUnit" ||
                R.Table.TableName == "CollectionAgent" ||
                R.Table.TableName == "CollectionSpecimenRelation" ||
                R.Table.TableName == "CollectionSpecimenReference") NodeToRefresh = Node.Parent;
            else return;
            if (NodeToRefresh != null)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> DependentNodes = new List<TreeNode>();
                foreach (System.Windows.Forms.TreeNode N in NodeToRefresh.Nodes)
                    DependentNodes.Add(N);
                foreach (System.Windows.Forms.TreeNode ND in DependentNodes)
                    ND.Remove();
                this.addOverviewHierarchyUnits();
                this.addOverviewHierarchyAgents();
                this.addOverviewHierarchyReferences();
                this.addOverviewHierarchyRelations();
                //this.addOverviewHierarchyProjectRegulation();
                ///TODO: freischalten wenns klappt
                //this.addOverviewHierarchyAnnotations();

            }
        }

        #endregion

        #region ProjectRegulation

        private void addOverviewHierarchyProjectRegulation()
        {
            return;

            try
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref Nodes);
                if (Nodes.Count > 0)
                {
                    foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionProject.Rows)
                    {
                        if (R.RowState != DataRowState.Detached && R.RowState != DataRowState.Deleted)
                        {
                            string SQL = "SELECT P.ProjectURI " +
                                " FROM CollectionProject AS C INNER JOIN " +
                                " ProjectProxy AS P ON C.ProjectID = P.ProjectID " +
                                " WHERE C.CollectionSpecimenID = " + R["CollectionSpecimenID"].ToString() +
                                " AND C.ProjectID = " + R["ProjectID"].ToString();
                            System.Data.DataTable dtProjectRegulation = new DataTable();
                            System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                            ad.Fill(dtProjectRegulation);
                            foreach (System.Data.DataRow Rreg in dtProjectRegulation.Rows)
                            {
                                try
                                {
                                    System.Uri U = new Uri(Rreg[0].ToString());
                                    DiversityWorkbench.Regulation.Regulation Reg = new DiversityWorkbench.Regulation.Regulation(U);
                                    foreach (string ProReg in Reg.RegulationList())
                                    {
                                        System.Data.DataRow R_ProReg = Reg.RegulationRow(ProReg);
                                        if (R_ProReg != null)
                                        {
                                            DiversityCollection.HierarchyNode Nreg = new HierarchyNode(R_ProReg, false);
                                            Nodes[0].Nodes.Add(Nreg);
                                        }
                                    }
                                }
                                catch (System.Exception ex)
                                {
                                }
                            }
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        #endregion

        #region IdentificationUnit

        private void addOverviewHierarchyUnits()
        {
            if (this.ShowUnit)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref Nodes);
                if (Nodes.Count > 0)
                {
                    foreach (System.Data.DataRow r in this.dataSetCollectionSpecimen.Tables["IdentificationUnit"].Rows)
                    {
                        try
                        {
                            if (r.RowState != System.Data.DataRowState.Deleted)
                            {
                                if (r["RelatedUnitID"].Equals(System.DBNull.Value)) // starting points for the hierarchy
                                {
                                    int UnitID = System.Int32.Parse(r["IdentificationUnitID"].ToString());
                                    System.Drawing.Font FNode;// = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Bold | System.Drawing.FontStyle.Underline);
                                    if (r["DisplayOrder"].ToString() == "1") FNode = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Bold | System.Drawing.FontStyle.Underline);
                                    else FNode = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Bold);
                                    DiversityCollection.HierarchyNode Node;
                                    if (r["DisplayOrder"].ToString() == "0" || r["OnlyObserved"].ToString() == "True")
                                        Node = new HierarchyNode(r, true, FNode);
                                    else
                                        Node = new HierarchyNode(r, false, FNode);

                                    Nodes[0].Nodes.Add(Node);
                                    this.addOverviewHierarchyIdentifications(Node, UnitID);
                                    this.addOverviewHierarchyGeoAnalysis(Node, UnitID);
                                    this.addOverviewHierarchyAnalysis(Node, UnitID);
                                    ///TODO: freischalten wenns klappt
                                    //this.addOverviewHierarchyAnnotations(Node, "IdentificationUnit", UnitID);
                                    this.addOverviewHierarchyUnits(Node, UnitID);
                                    Nodes[0].Expand();
                                    Node.Expand();
                                }
                                else
                                {
                                    int RelatedUnitID = int.Parse(r["RelatedUnitID"].ToString());
                                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnit.Select("IdentificationUnitID = " + RelatedUnitID.ToString());
                                    if (rr.Length == 0)
                                    {
                                        System.Data.DataRow[] rrS = this.dataSetCollectionEventSeries.IdentificationUnitList.Select("IdentificationUnitID = " + RelatedUnitID.ToString());
                                        if (rrS.Length > 0)
                                        {
                                            string SpecimenID = rrS[0]["CollectionSpecimenID"].ToString();
                                            System.Data.DataRow[] rrC = this.dataSetCollectionEventSeries.CollectionSpecimenList.Select("CollectionSpecimenID = " + SpecimenID);
                                            if (rrC.Length > 0)
                                            {
                                                DiversityCollection.HierarchyNode NSpecimen = new HierarchyNode(rrC[0], true);
                                                Nodes[0].Nodes.Add(NSpecimen);
                                                DiversityCollection.HierarchyNode NUnit = new HierarchyNode(rrS[0], true);
                                                NSpecimen.Nodes.Add(NUnit);
                                                this.addOverviewHierarchyUnits(NUnit, RelatedUnitID);
                                            }
                                            else
                                            {
                                                int UnitID = System.Int32.Parse(r["IdentificationUnitID"].ToString());
                                                DiversityCollection.HierarchyNode NUnit;
                                                if (r["DisplayOrder"].ToString() == "0")
                                                    NUnit = new HierarchyNode(r, true);
                                                else
                                                    NUnit = new HierarchyNode(r, false);
                                                Nodes[0].Nodes.Add(NUnit);
                                                this.addOverviewHierarchyIdentifications(NUnit, UnitID);
                                                this.addOverviewHierarchyGeoAnalysis(NUnit, UnitID);
                                                this.addOverviewHierarchyAnalysis(NUnit, UnitID);
                                                ///TODO: freischalten wenns klappt
                                                //this.addOverviewHierarchyAnnotations(NUnit, "IdentificationUnit", UnitID);
                                                this.addOverviewHierarchyUnits(NUnit, UnitID);
                                            }
                                        }
                                        else
                                        {
                                            int UnitID = System.Int32.Parse(r["IdentificationUnitID"].ToString());
                                            DiversityCollection.HierarchyNode NUnit;
                                            if (r["DisplayOrder"].ToString() == "0")
                                                NUnit = new HierarchyNode(r, true);
                                            else
                                                NUnit = new HierarchyNode(r, false);
                                            Nodes[0].Nodes.Add(NUnit);
                                            this.addOverviewHierarchyIdentifications(NUnit, UnitID);
                                            this.addOverviewHierarchyGeoAnalysis(NUnit, UnitID);
                                            this.addOverviewHierarchyAnalysis(NUnit, UnitID);
                                            ///TODO: freischalten wenns klappt
                                            //this.addOverviewHierarchyAnnotations(NUnit, "IdentificationUnit", UnitID);
                                            this.addOverviewHierarchyUnits(NUnit, UnitID);
                                        }
                                    }
                                }
                            }
                        }
                        catch (Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        }
                    }
                }
                Nodes.Clear();
                this.getOverviewHierarchyNodes(null, "CollectionSpecimenList", this.treeViewOverviewHierarchy, ref Nodes);
                if (Nodes.Count > 0)
                {
                    foreach (System.Windows.Forms.TreeNode N in Nodes)
                    {
                        this.getEventSeriesEventSpecimenUnits(N);
                    }
                }
                this.OverviewHierarchyUnitNodesToEnd();
            }
        }

        private void addOverviewHierarchyUnits(System.Windows.Forms.TreeNode pNode, int SubstrateID)
        {
            if (this.ShowUnit)
            {
                try
                {
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.Tables["IdentificationUnit"].Select("RelatedUnitID = " + SubstrateID.ToString());
                    foreach (System.Data.DataRow r in rr)
                    {
                        bool GreyImage = false;
                        if (r["DisplayOrder"].ToString() == "0" || r["OnlyObserved"].ToString() == "True")
                        {
                            //string x = r["OnlyObserved"].ToString();
                            GreyImage = true;
                        }
                        System.Drawing.Font FNode;
                        if (r["DisplayOrder"].ToString() == "1") 
                            FNode = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Bold | System.Drawing.FontStyle.Underline);
                        else 
                            FNode = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Bold);
                        DiversityCollection.HierarchyNode Node = new HierarchyNode(r, GreyImage, FNode);

                        pNode.Nodes.Add(Node);

                        int UnitID = System.Int32.Parse(r["IdentificationUnitID"].ToString());
                        this.addOverviewHierarchyIdentifications(Node, UnitID);
                        this.addOverviewHierarchyGeoAnalysis(Node, UnitID);
                        this.addOverviewHierarchyAnalysis(Node, UnitID);
                        ///TODO: freischalten wenns klappt
                        //this.addOverviewHierarchyAnnotations(Node, "IdentificationUnit", UnitID);
                        this.addOverviewHierarchyUnits(Node, UnitID);
                    }
                    System.Data.DataRow[] pp = this.dataSetCollectionSpecimen.Tables["IdentificationUnit"].Select("ParentUnitID = " + SubstrateID.ToString());
                    foreach (System.Data.DataRow p in pp)
                    {
                        bool GreyImage = false;
                        if (p["DisplayOrder"].ToString() == "0" || p["OnlyObserved"].ToString() == "True")
                        {
                            GreyImage = true;
                        }
                        //System.Drawing.Font FNode;
                        //FNode = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Regular);
                        DiversityCollection.HierarchyNode Node = new HierarchyNode(true, p, (int)DiversityCollection.Specimen.OverviewImageTableOrField.Parent, GreyImage);
                        pNode.Nodes.Add(Node);
                    }
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void OverviewHierarchyUnitNodesToEnd()
        {
            System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
            this.getOverviewHierarchyNodes(null, "IdentificationUnit", this.treeViewOverviewHierarchy, ref Nodes);
            foreach (System.Windows.Forms.TreeNode N in Nodes)
            {
                System.Windows.Forms.TreeNode NP = N.Parent;
                N.Remove();
                NP.Nodes.Add(N);
            }
            Nodes.Clear();
            this.getOverviewHierarchyNodes(null, "CollectionAgent", this.treeViewOverviewHierarchy, ref Nodes);
            foreach (System.Windows.Forms.TreeNode N in Nodes)
            {
                System.Windows.Forms.TreeNode NP = N.Parent;
                N.Remove();
                NP.Nodes.Add(N);
            }
            Nodes.Clear();
            this.getOverviewHierarchyNodes(null, "CollectionSpecimenReference", this.treeViewOverviewHierarchy, ref Nodes);
            foreach (System.Windows.Forms.TreeNode N in Nodes)
            {
                System.Windows.Forms.TreeNode NP = N.Parent;
                N.Remove();
                NP.Nodes.Add(N);
            }
            Nodes.Clear();
            this.getOverviewHierarchyNodes(null, "CollectionSpecimenRelation", this.treeViewOverviewHierarchy, ref Nodes);
            foreach (System.Windows.Forms.TreeNode N in Nodes)
            {
                System.Windows.Forms.TreeNode NP = N.Parent;
                N.Remove();
                NP.Nodes.Add(N);
            }
            Nodes.Clear();
            this.getOverviewHierarchyNodes(null, "CollectionSpecimenRelationInvers", this.treeViewOverviewHierarchy, ref Nodes);
            foreach (System.Windows.Forms.TreeNode N in Nodes)
            {
                System.Windows.Forms.TreeNode NP = N.Parent;
                N.Remove();
                NP.Nodes.Add(N);
            }
        }

        private void hideOverviewHierarchyUnits()
        {
            this.hideOverviewHierarchyNodes("IdentificationUnit");
            this.hideOverviewHierarchyNodes("IdentificationUnitList");
        }

        private void refreshHierarchyUnitUnitNodes(System.Windows.Forms.TreeNode Node)
        {
            System.Windows.Forms.TreeNode NodeToRefresh;
            System.Data.DataRow R = (System.Data.DataRow)Node.Tag;
            int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
            if (R.Table.TableName == "IdentificationUnit") NodeToRefresh = Node;
            else if (R.Table.TableName == "IdentificationUnitAnalysis" ||
                R.Table.TableName == "Identification") NodeToRefresh = Node.Parent;
            else return;
            if (NodeToRefresh != null)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> UnitNodes = new List<TreeNode>();
                foreach (System.Windows.Forms.TreeNode N in NodeToRefresh.Nodes)
                    UnitNodes.Add(N);
                foreach (System.Windows.Forms.TreeNode ND in UnitNodes)
                    ND.Remove();
                this.addOverviewHierarchyIdentifications(NodeToRefresh, UnitID);
                this.addOverviewHierarchyGeoAnalysis(NodeToRefresh, UnitID);
                this.addOverviewHierarchyAnalysis(NodeToRefresh, UnitID);
                ///TODO: freischalten wenns klappt
                //this.addOverviewHierarchyAnnotations(NodeToRefresh, "IdentificationUnit", UnitID);
                this.addOverviewHierarchyUnits(NodeToRefresh, UnitID);
                this.treeViewOverviewHierarchy.ExpandAll();
            }
        }

        #endregion

        #region Identification

        private void addOverviewHierarchyIdentifications(bool ExpandNode)
        {
            if (this.ShowIdentification)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> UnitNodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "IdentificationUnit", this.treeViewOverviewHierarchy, ref UnitNodes);
                foreach (System.Windows.Forms.TreeNode N in UnitNodes)
                {
                    System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                    int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
                    this.addOverviewHierarchyIdentifications(N, UnitID);
                    if (ExpandNode) N.Expand();
                }
            }
            this.OverviewHierarchyUnitNodesToEnd();
        }

        private void addOverviewHierarchyIdentifications(System.Windows.Forms.TreeNode N, int UnitID)
        {
            if (this.ShowIdentification)
            {
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.Identification.Select("IdentificationUnitID = " + UnitID.ToString(), "IdentificationSequence DESC", System.Data.DataViewRowState.CurrentRows);
                if (rr.Length > 0)
                {
                    for (int i = 0; i < rr.Length; i++)
                    {
                        try
                        {
                            DiversityCollection.HierarchyNode NI = new HierarchyNode(rr[i], false);
                            N.Nodes.Add(NI);
                        }
                        catch (System.Exception ex) { }
                    }
                }
            }
        }

        private void hideOverviewHierarchyIdentifications()
        {
            this.hideOverviewHierarchyNodes("Identification");
        }

        #endregion

        #region Analysis

        private void buildOverviewHierarchyAnalysis()
        {
            AnalysisDisplayStyle S = (AnalysisDisplayStyle)this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Tag;
            switch (S)
            {
                case AnalysisDisplayStyle.Hidden:
                    this.hideOverviewHierarchyNodes("IdentificationUnitAnalysis");
                    break;
                case AnalysisDisplayStyle.HierarchyTypeDate:
                case AnalysisDisplayStyle.HierarchyType:
                case AnalysisDisplayStyle.HierarchyDateType:
                case AnalysisDisplayStyle.HierarchyDate:
                    this.addOverviewHierarchyAnalysis(true, S);
                    break;
                case AnalysisDisplayStyle.ListByName:
                case AnalysisDisplayStyle.ListByNumber:
                case AnalysisDisplayStyle.NoHierarchy:
                    this.addOverviewHierarchyAnalysis(true, S);
                    break;
                default:
                    this.addOverviewHierarchyAnalysis(true, S);
                    break;
            }
        }

        private void addOverviewHierarchyAnalysis(bool ExpandNode, AnalysisDisplayStyle Style)
        {
            if (Style != AnalysisDisplayStyle.Hidden)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "IdentificationUnit", this.treeViewOverviewHierarchy, ref Nodes);
                //if (this.ShowAnalysisAsHierarchy) 
                this.hideOverviewHierarchyAnalysis();
                foreach (System.Windows.Forms.TreeNode N in Nodes)
                {
                    System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                    int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
                    this.addOverviewHierarchyAnalysis(N, UnitID, Style);
                    if (ExpandNode) N.Expand();
                }
            }
            this.OverviewHierarchyUnitNodesToEnd();
        }

        private void addOverviewHierarchyAnalysis(System.Windows.Forms.TreeNode N, int UnitID, AnalysisDisplayStyle Style)
        {
            if (Style != AnalysisDisplayStyle.Hidden)
            {
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select("IdentificationUnitID = " + UnitID.ToString(), "", System.Data.DataViewRowState.CurrentRows);
                if (rr.Length > 0)
                {
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisDataTable dtUnitAnalysis = new DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisDataTable();
                    switch (Style)
                    {
                        case AnalysisDisplayStyle.HierarchyDate:
                        case AnalysisDisplayStyle.HierarchyDateType:
                            System.Collections.Generic.List<string> AnalysisDates = new List<string>();
                            System.Data.DataRow[] rrDate = dtUnitAnalysis.Select("", "AnalysisDate");
                            for (int i = 0; i < rr.Length; i++)
                            {
                                if (!AnalysisDates.Contains(rr[i]["AnalysisDate"].ToString()))
                                    AnalysisDates.Add(rr[i]["AnalysisDate"].ToString());
                            }
                            AnalysisDates.Sort();
                            foreach (string Date in AnalysisDates)
                            {
                                DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisRow R = dtUnitAnalysis.NewIdentificationUnitAnalysisRow();
                                R.AnalysisID = -1;
                                R.CollectionSpecimenID = this.SpecimenID;
                                R.IdentificationUnitID = UnitID;
                                if (Date.Length > 0)
                                    R.AnalysisDate = Date;
                                else
                                    R.AnalysisDate = "?";
                                DiversityCollection.HierarchyNode NAparent = new HierarchyNode(R, false);
                                N.Nodes.Add(NAparent);
                                this.addOverviewHierarchyAnalysisChilds(NAparent, Style);
                            }
                            //if (dtUnitAnalysis.Rows.Count > 0)
                            //{
                            //    foreach (DiversityCollection.DataSetCollectionSpecimen.IdentificationUnitAnalysisRow R in dtUnitAnalysis.Rows)
                            //    {
                            //        DiversityCollection.HierarchyNode NAparent = new HierarchyNode(R, false);
                            //        N.Nodes.Add(NAparent);
                            //        this.addOverviewHierarchyAnalysisChilds(NAparent, UnitID, R.AnalysisID);
                            //    }
                            //}
                            break;
                        case AnalysisDisplayStyle.HierarchyType:
                        case AnalysisDisplayStyle.HierarchyTypeDate:
                            for (int i = 0; i < rr.Length; i++)
                            {
                                System.Data.DataRow[] rrA = dtUnitAnalysis.Select("AnalysisID = " + rr[i]["AnalysisID"].ToString());
                                if (rrA.Length == 0)
                                {
                                    DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisRow R = dtUnitAnalysis.NewIdentificationUnitAnalysisRow();
                                    R.AnalysisID = int.Parse(rr[i]["AnalysisID"].ToString());
                                    R.CollectionSpecimenID = this.SpecimenID;
                                    R.IdentificationUnitID = UnitID;
                                    R.AnalysisNumber = "";
                                    dtUnitAnalysis.Rows.Add(R);
                                }
                            }
                            if (dtUnitAnalysis.Rows.Count > 0)
                            {
                                foreach (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisRow R in dtUnitAnalysis.Rows)
                                {
                                    DiversityCollection.HierarchyNode NAparent = new HierarchyNode(R, false);
                                    N.Nodes.Add(NAparent);
                                    this.addOverviewHierarchyAnalysisChilds(NAparent, UnitID, R.AnalysisID);
                                }
                            }
                            break;
                        case AnalysisDisplayStyle.HierarchyOfAnalysis:
                            for (int i = 0; i < rr.Length; i++)
                            {
                                System.Data.DataRow[] rrA = dtUnitAnalysis.Select("AnalysisID = " + rr[i]["AnalysisID"].ToString());
                                if (rrA.Length == 0)
                                {
                                    DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisRow R = dtUnitAnalysis.NewIdentificationUnitAnalysisRow();
                                    R.AnalysisID = int.Parse(rr[i]["AnalysisID"].ToString());
                                    R.CollectionSpecimenID = this.SpecimenID;
                                    R.IdentificationUnitID = UnitID;
                                    R.AnalysisNumber = "";
                                    dtUnitAnalysis.Rows.Add(R);
                                }
                            }
                            if (dtUnitAnalysis.Rows.Count > 0)
                            {
                                foreach (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisRow R in dtUnitAnalysis.Rows)
                                {
                                    DiversityCollection.HierarchyNode NAparent = new HierarchyNode(R, false);
                                    N.Nodes.Add(NAparent);
                                    this.addOverviewHierarchyAnalysisChilds(NAparent, UnitID, R.AnalysisID);
                                }
                            }
                            break;
                        case AnalysisDisplayStyle.ListByName:
                            this.addOverviewHierarchyAnalysisChilds(N, Style);
                            break;
                        default:
                            this.addOverviewHierarchyAnalysisChilds(N, Style);

                            //this.addOverviewHierarchyAnalysis(true);
                            break;
                    }
                    //if (this.ShowAnalysisAsHierarchy)
                    //{
                    //}
                    //else
                    //{
                    //    for (int i = 0; i < rr.Length; i++)
                    //    {
                    //        DiversityCollection.HierarchyNode NA = new HierarchyNode(rr[i], false);
                    //        N.Nodes.Add(NA);
                    //    }
                    //}
                }
            }
        }

        private void addOverviewHierarchyAnalysisChilds(System.Windows.Forms.TreeNode N, AnalysisDisplayStyle Style)
        {
            if (Style != AnalysisDisplayStyle.Hidden)
            {
                if (typeof(DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisRow) == N.Tag.GetType())
                {
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisRow R = (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisRow)N.Tag;
                    switch (Style)
                    {
                        case AnalysisDisplayStyle.HierarchyDate:
                            string FilterString = "IdentificationUnitID = " + R.IdentificationUnitID.ToString();
                            if (R.AnalysisDate.Equals(System.DBNull.Value) || R.AnalysisDate == "?") FilterString += " AND (AnalysisDate = '' OR AnalysisDate IS NULL)";
                            else FilterString += " AND AnalysisDate = '" + R.AnalysisDate.ToString() + "'";
                            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select(FilterString, "", System.Data.DataViewRowState.CurrentRows);
                            if (rr.Length > 0)
                            {
                                for (int i = 0; i < rr.Length; i++)
                                {
                                    DiversityCollection.HierarchyNode NA = new HierarchyNode(rr[i]);
                                    N.Nodes.Add(NA);
                                }
                            }
                            break;
                        default:
                            break;
                    }
                }
                else if (typeof(DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitRow) == N.Tag.GetType())
                {
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitRow R = (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitRow)N.Tag;
                    string FilterString = "IdentificationUnitID = " + R.IdentificationUnitID.ToString();
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select(FilterString, "", System.Data.DataViewRowState.CurrentRows);
                    if (rr.Length > 0)
                    {
                        switch(Style)
                        {
                            case AnalysisDisplayStyle.ListByName:
                                System.Collections.Generic.SortedDictionary<string, DiversityCollection.HierarchyNode> Nodes = new SortedDictionary<string, HierarchyNode>();
                                for (int i = 0; i < rr.Length; i++)
                                {
                                    try
                                    {
                                        DiversityCollection.HierarchyNode NA = new HierarchyNode(rr[i]);
                                        if (Nodes.ContainsKey(NA.Text))
                                            Nodes.Add(NA.Text + " {" + i.ToString() + "}", NA);
                                        else
                                            Nodes.Add(NA.Text, NA);
                                    }
                                    catch (System.Exception ex) { }
                                }
                                foreach (System.Collections.Generic.KeyValuePair<string, DiversityCollection.HierarchyNode> KV in Nodes)
                                {
                                    N.Nodes.Add(KV.Value);
                                }
                                break;
                            case AnalysisDisplayStyle.ListByNumber:
                                System.Collections.Generic.SortedDictionary<string, DiversityCollection.HierarchyNode> NodesByNumber = new SortedDictionary<string, HierarchyNode>();
                                for (int i = 0; i < rr.Length; i++)
                                {
                                    try
                                    {
                                        DiversityCollection.HierarchyNode NA = new HierarchyNode(rr[i]);
                                        System.Data.DataRow RA = (System.Data.DataRow)NA.Tag;
                                        string AnalysisNumber = RA["AnalysisNumber"].ToString();
                                        if (NodesByNumber.ContainsKey(AnalysisNumber))
                                            NodesByNumber.Add(AnalysisNumber + " {" + i.ToString() + "}", NA);
                                        else
                                            NodesByNumber.Add(AnalysisNumber, NA);
                                    }
                                    catch (System.Exception ex) { }
                                }
                                foreach (System.Collections.Generic.KeyValuePair<string, DiversityCollection.HierarchyNode> KV in NodesByNumber)
                                {
                                    N.Nodes.Add(KV.Value);
                                }
                                break;
                            default:
                                for (int i = 0; i < rr.Length; i++)
                                {
                                    DiversityCollection.HierarchyNode NA = new HierarchyNode(rr[i]);
                                    N.Nodes.Add(NA);
                                }
                                break;
                        }
                    }
                }
            }
        }


        #region Alte versionen

        private void addOverviewHierarchyAnalysis(bool ExpandNode)
        {
            if (this.ShowAnalysis)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "IdentificationUnit", this.treeViewOverviewHierarchy, ref Nodes);
                if (this.ShowAnalysisAsHierarchy) this.hideOverviewHierarchyAnalysis();
                foreach (System.Windows.Forms.TreeNode N in Nodes)
                {
                    System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                    int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
                    this.addOverviewHierarchyAnalysis(N, UnitID);
                    if (ExpandNode) N.Expand();
                }
            }
            this.OverviewHierarchyUnitNodesToEnd();
        }

        private void addOverviewHierarchyAnalysis(System.Windows.Forms.TreeNode N, int UnitID)
        {
            if (this.ShowAnalysis)
            {
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select("IdentificationUnitID = " + UnitID.ToString() + " AND SpecimenPartID IS NULL", "", System.Data.DataViewRowState.CurrentRows);
                if (rr.Length > 0)
                {
                    if (this.ShowAnalysisAsHierarchy)
                    {
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisDataTable dtUnitAnalysis = new DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisDataTable();
                        for (int i = 0; i < rr.Length; i++)
                        {
                            System.Data.DataRow[] rrA = dtUnitAnalysis.Select("AnalysisID = " + rr[i]["AnalysisID"].ToString());
                            if (rrA.Length == 0)
                            {
                                DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisRow R = dtUnitAnalysis.NewIdentificationUnitAnalysisRow();
                                R.AnalysisID = int.Parse(rr[i]["AnalysisID"].ToString());
                                R.CollectionSpecimenID = this.SpecimenID;
                                R.IdentificationUnitID = UnitID;
                                R.AnalysisNumber = "";
                                dtUnitAnalysis.Rows.Add(R);
                            }
                        }
                        if (dtUnitAnalysis.Rows.Count > 0)
                        {
                            foreach (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisRow R in dtUnitAnalysis.Rows)
                            {
                                DiversityCollection.HierarchyNode NAparent = new HierarchyNode(R, false);
                                N.Nodes.Add(NAparent);
                                this.addOverviewHierarchyAnalysisChilds(NAparent, UnitID, R.AnalysisID);
                            }
                        }
                    }
                    else
                    {
                        for (int i = 0; i < rr.Length; i++)
                        {
                            DiversityCollection.HierarchyNode NA = new HierarchyNode(rr[i], false);
                            N.Nodes.Add(NA);
                        }
                    }
                }
            }
        }

        private void addOverviewHierarchyAnalysisChilds(System.Windows.Forms.TreeNode N, int UnitID, int AnalysisID)
        {
            if (this.ShowAnalysis)
            {
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select("IdentificationUnitID = " + UnitID.ToString() + " AND AnalysisID = " + AnalysisID.ToString(), "", System.Data.DataViewRowState.CurrentRows);
                if (rr.Length > 0)
                {
                    for (int i = 0; i < rr.Length; i++)
                    {
                        DiversityCollection.HierarchyNode NA = new HierarchyNode(rr[i]);
                        N.Nodes.Add(NA);
                    }
                }
            }
        }
        
        #endregion

        private void hideOverviewHierarchyAnalysis()
        {
            this.hideOverviewHierarchyNodes("IdentificationUnitAnalysis");
        }

        #endregion

        #region GeoAnalysis

        private void addOverviewHierarchyGeoAnalysis(bool ExpandNode)
        {
            if (this.ShowGeoAnalysis)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> UnitNodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "IdentificationUnit", this.treeViewOverviewHierarchy, ref UnitNodes);
                foreach (System.Windows.Forms.TreeNode N in UnitNodes)
                {
                    System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                    int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
                    this.addOverviewHierarchyGeoAnalysis(N, UnitID);
                    if (ExpandNode) N.Expand();
                }
            }
            this.OverviewHierarchyUnitNodesToEnd();
        }

        private void addOverviewHierarchyGeoAnalysis(System.Windows.Forms.TreeNode N, int UnitID)
        {
            if (this.ShowGeoAnalysis)
            {
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysis.Select("IdentificationUnitID = " + UnitID.ToString(), "AnalysisDate DESC", System.Data.DataViewRowState.CurrentRows);
                if (rr.Length > 0)
                {
                    for (int i = 0; i < rr.Length; i++)
                    {
                        DiversityCollection.HierarchyNode NI = new HierarchyNode(rr[i], false);
                        N.Nodes.Add(NI);
                    }
                }
            }
        }

        private void hideOverviewHierarchyGeoAnalysis()
        {
            this.hideOverviewHierarchyNodes("IdentificationUnitGeoAnalysis");
        }

        #endregion

        #region Agent

        private void addOverviewHierarchyAgents()
        {
            if (this.ShowCollector)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref Nodes);
                foreach (System.Windows.Forms.TreeNode N in Nodes)
                {
                    System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.CollectionAgent.Select("", "CollectorsSequence");
                    foreach (System.Data.DataRow R in RR)
                    {
                        DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                        //DiversityCollection.HierarchyNode NA = new HierarchyNode(R);
                        //NA.ImageIndex = (int)DiversityCollection.Specimen.OverviewImage.Agent;
                        //NA.SelectedImageIndex = (int)DiversityCollection.Specimen.OverviewImage.Agent;
                        N.Nodes.Add(NA);
                    }
                    break;
                }
            }
        }

        private void hideOverviewHierarchyAgent()
        {
            this.hideOverviewHierarchyNodes("CollectionAgent");
        }

        #endregion

        #region References

        private void addOverviewHierarchyReferences()
        {
            //if (this.ShowRelation)
            //{
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref Nodes);
                foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenReference.Rows)
                {
                    if (R.RowState == DataRowState.Deleted) continue;

                    // show these relations in other positions
                    if (!R["IdentificationUnitID"].Equals(System.DBNull.Value)) continue;
                    if (!R["SpecimenPartID"].Equals(System.DBNull.Value)) continue;

                    DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                    if (Nodes.Count > 0)
                    {
                        Nodes[0].Nodes.Add(NA);
                    }
                }

                // show References refering to units
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> UnitNodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "IdentificationUnit", this.treeViewOverviewHierarchy, ref UnitNodes);
                if (UnitNodes.Count > 0)
                {
                    foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenReference.Rows)
                    {
                        if (R.RowState == DataRowState.Deleted) continue;
                        if (R["IdentificationUnitID"].Equals(System.DBNull.Value)) continue;
                        if (!R["SpecimenPartID"].Equals(System.DBNull.Value)) continue;
                        int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
                        foreach (System.Windows.Forms.TreeNode TN in UnitNodes)
                        {
                            System.Data.DataRow RUnit = (System.Data.DataRow)TN.Tag;
                            if (RUnit["IdentificationUnitID"].ToString() == UnitID.ToString())
                            {
                                DiversityCollection.HierarchyNode NUR = new HierarchyNode(R, false);
                                TN.Nodes.Add(NUR);
                            }
                        }
                    }
                }

                if (Nodes.Count > 0)
                    Nodes[0].Expand();
            //}
        }

        #endregion

        #region Relations

        private void addOverviewHierarchyRelations()
        {
            if (this.ShowRelation)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref Nodes);
                foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows)
                {
                    if (R.RowState == DataRowState.Deleted) continue;

                    // show these relations in other positions
                    if (!R["IdentificationUnitID"].Equals(System.DBNull.Value)) continue;
                    if (!R["SpecimenPartID"].Equals(System.DBNull.Value)) continue;

                    DiversityCollection.HierarchyNode NA = new HierarchyNode(R, false);
                    if (Nodes.Count > 0)
                    {
                        Nodes[0].Nodes.Add(NA);
                        if (R["IsInternalRelationCache"].ToString() == "True" && this.ShowRelationDetails)
                            this.addOverviewHierarchyRelationsInfo(NA);
                    }
                }
                foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenRelationInvers.Rows)
                {
                    if (R.RowState == DataRowState.Deleted) continue;
                    DiversityCollection.HierarchyNode NA = new HierarchyNode(R, true);
                    if (Nodes.Count > 0)
                    {
                        Nodes[0].Nodes.Add(NA);
                        if (R["IsInternalRelationCache"].ToString() == "True" && this.ShowRelationDetails)
                            this.addOverviewHierarchyRelationsInfo(NA);
                    }
                }

                // show relations refering to units
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> UnitNodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "IdentificationUnit", this.treeViewOverviewHierarchy, ref UnitNodes);
                if (UnitNodes.Count > 0)
                {
                    foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows)
                    {
                        if (R.RowState == DataRowState.Deleted) continue;
                        if (R["IdentificationUnitID"].Equals(System.DBNull.Value)) continue;
                        if (!R["SpecimenPartID"].Equals(System.DBNull.Value)) continue;
                        int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
                        foreach (System.Windows.Forms.TreeNode TN in UnitNodes)
                        {
                            System.Data.DataRow RUnit = (System.Data.DataRow)TN.Tag;
                            if (RUnit["IdentificationUnitID"].ToString() == UnitID.ToString())
                            {
                                DiversityCollection.HierarchyNode NUR = new HierarchyNode(R, false);
                                TN.Nodes.Add(NUR);
                                if (R["IsInternalRelationCache"].ToString() == "True" && this.ShowRelationDetails)
                                    this.addOverviewHierarchyRelationsInfo(NUR);
                            }
                        }
                    }
                }

                if (Nodes.Count > 0)
                    Nodes[0].Expand();
            }
        }

        private void addOverviewHierarchyRelationsInfo(System.Windows.Forms.TreeNode pNode)
        {
            if (this.ShowRelation && this.ShowRelationDetails)
            {
                try
                {
                    DiversityCollection.Datasets.DataSetCollectionSpecimen DS = new Datasets.DataSetCollectionSpecimen();
                    System.Data.DataRow R = (System.Data.DataRow)pNode.Tag;
                    string CollectionSpecimenID = DiversityWorkbench.CollectionSpecimen.getIDFromURI(R["RelatedSpecimenURI"].ToString());
                    string BaseURL = DiversityWorkbench.CollectionSpecimen.getBaseURIfromURI(R["RelatedSpecimenURI"].ToString());
                    if ((CollectionSpecimenID.Length == 0 || BaseURL.Length == 0) && R["RelatedSpecimenURI"].ToString().Length > 0)
                    {
                        DiversityCollection.HierarchyNode NRelNon = new HierarchyNode(true, R);
                        NRelNon.Text = "No connection to " + R["RelatedSpecimenURI"].ToString();
                        pNode.Nodes.Add(NRelNon);
                        return;
                    }
                    string WhereClause = " WHERE CollectionSpecimenID = " + CollectionSpecimenID;
                    string SQL = DiversityCollection.CollectionSpecimen.SqlSpecimen + WhereClause;
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(DS.CollectionSpecimen);
                    if (DS.CollectionSpecimen.Rows.Count > 0)
                    {
                        if (!DS.CollectionSpecimen.Rows[0]["CollectionEventID"].Equals(System.DBNull.Value))
                        {
                            string CollectionEventID = DS.CollectionSpecimen.Rows[0]["CollectionEventID"].ToString();
                            ad.SelectCommand.CommandText = DiversityCollection.CollectionSpecimen.SqlEvent + " WHERE CollectionEventID = " + CollectionEventID;
                            ad.Fill(DS.CollectionEvent);
                            if (DS.CollectionEvent.Rows.Count > 0)
                            {
                                DiversityCollection.HierarchyNode NRelEvent = new HierarchyNode(true, DS.CollectionEvent.Rows[0]);
                                    pNode.Nodes.Add(NRelEvent);
                                    ad.SelectCommand.CommandText = DiversityCollection.CollectionSpecimen.SqlEventLocalisation + " WHERE CollectionEventID = " + CollectionEventID;
                                    ad.Fill(DS.CollectionEventLocalisation);
                                    if (DS.CollectionEventLocalisation.Rows.Count > 0)
                                    {
                                        foreach (System.Data.DataRow RLoc in DS.CollectionEventLocalisation.Rows)
                                        {
                                            DiversityCollection.HierarchyNode NRelLoc = new HierarchyNode(true, RLoc);
                                            NRelEvent.Nodes.Add(NRelLoc);
                                        }
                                    }
                                    ad.SelectCommand.CommandText = DiversityCollection.CollectionSpecimen.SqlEventProperty + " WHERE CollectionEventID = " + CollectionEventID;
                                    ad.Fill(DS.CollectionEventProperty);
                                    if (DS.CollectionEventProperty.Rows.Count > 0)
                                    {
                                        foreach (System.Data.DataRow RProp in DS.CollectionEventProperty.Rows)
                                        {
                                            DiversityCollection.HierarchyNode NRelProp = new HierarchyNode(true, RProp);
                                            NRelEvent.Nodes.Add(NRelProp);
                                        }
                                    }
                            }
                        }
                        ad.SelectCommand.CommandText = DiversityCollection.CollectionSpecimen.SqlUnit + WhereClause;
                        ad.Fill(DS.IdentificationUnit);
                        if (DS.IdentificationUnit.Rows.Count > 0)
                        {
                            DiversityCollection.HierarchyNode NSpecimen = new HierarchyNode(true, DS.CollectionSpecimen.Rows[0]);
                            pNode.Nodes.Add(NSpecimen);
                            foreach (System.Data.DataRow RUnit in DS.IdentificationUnit.Rows)
                            {
                                DiversityCollection.HierarchyNode NRelUnit = new HierarchyNode(true, RUnit);
                                NSpecimen.Nodes.Add(NRelUnit);
                            }
                        }
                        ad.SelectCommand.CommandText = DiversityCollection.CollectionSpecimen.SqlAgent + WhereClause;
                        ad.Fill(DS.CollectionAgent);
                        if (DS.CollectionAgent.Rows.Count > 0)
                        {
                            foreach (System.Data.DataRow RAgent in DS.CollectionAgent.Rows)
                            {
                                DiversityCollection.HierarchyNode NRelAgent = new HierarchyNode(true, RAgent);
                                pNode.Nodes.Add(NRelAgent);
                            }
                        }
                        ad.SelectCommand.CommandText = DiversityCollection.CollectionSpecimen.SqlRelation + WhereClause + " AND IsInternalRelationCache = 0";
                        ad.Fill(DS.CollectionSpecimenRelation);
                        if (DS.CollectionSpecimenRelation.Rows.Count > 0)
                        {
                            foreach (System.Data.DataRow RRelRel in DS.CollectionSpecimenRelation.Rows)
                            {
                                DiversityCollection.HierarchyNode NRelRel = new HierarchyNode(true, RRelRel);
                                pNode.Nodes.Add(NRelRel);
                            }
                        }

                    }
                }
                catch (Exception ex)
                {
                }
            }
        }

        private void hideOverviewHierarchyRelations()
        {
            this.hideOverviewHierarchyNodes("CollectionSpecimenRelation");
            this.hideOverviewHierarchyNodes("CollectionSpecimenRelationInvers");
        }

        #endregion

        #endregion

        #region Parts

        #region Common

        private void buildOverviewHierarchyParts()
        {
            LookupTable.DtIdentificationUnit = this.dataSetCollectionSpecimen.IdentificationUnit.Copy();
            this.treeViewOverviewHierarchyStorage.Visible = false;
            this.treeViewOverviewHierarchyStorage.Nodes.Clear();
            try
            {
                // Tree as Collection tree
                if (this.ShowCollection && this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count > 0)
                {
                    this.treeViewOverviewHierarchyStorage.LineColor = System.Drawing.Color.DarkOrange;
                    // init the collections table and get the collections
                    string SQL = DiversityCollection.CollectionSpecimen.SqlCollection + " WHERE CollectionID = -2";
                    if (this.dataSetCollectionSpecimen.Collection.Rows.Count == 0)
                    {
                        this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterCollection, SQL, this.dataSetCollectionSpecimen.Collection);
                        this.dataSetCollectionSpecimen.Collection.Clear();
                        SQL = "SELECT * FROM dbo.CollectionHierarchyMulti('";
                        foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows)
                        {
                            if (!R["CollectionID"].Equals(System.DBNull.Value))
                                SQL += " " + R["CollectionID"].ToString();
                        }


                        // obsolet - dieses Feld soll nicht verwendet werden
                        //if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionID"].Equals(System.DBNull.Value))
                        //{
                        //    SQL += " " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionID"].ToString();
                        //}


                        SQL += "')";
                    }
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(this.dataSetCollectionSpecimen.Collection);
                    foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.Collection.Rows)
                    {
                        if (R["CollectionParentID"].Equals(System.DBNull.Value))
                        {
                            System.Drawing.Font F = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25);//, System.Drawing.FontStyle.Underline);//  
                            DiversityCollection.HierarchyNode Node = new HierarchyNode(R, false);//, F);
                            Node.Tag = R;
                            this.treeViewOverviewHierarchyStorage.Nodes.Add(Node);
                            this.addPartHierarchyChildCollectionNodes(Node, this.dataSetCollectionSpecimen.Collection);
                            this.addOverviewHierarchyPartDependentData(Node);
                        }
                    }


                    // obsolet - dieses Feld soll nicht verwendet werden
                    // if the collection specimen has a CollectinID
                    //if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionID"].Equals(System.DBNull.Value))
                    //{
                    //    System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<System.Windows.Forms.TreeNode>();
                    //    this.getOverviewHierarchyNodes(null, "Collection", this.treeViewOverviewHierarchyStorage, ref Nodes);
                    //    foreach (System.Windows.Forms.TreeNode N in Nodes)
                    //    {
                    //        System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                    //        if (R["CollectionID"].ToString() == this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionID"].ToString())
                    //        {
                    //            System.Drawing.Font F = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Underline);//  
                    //            DiversityCollection.HierarchyNode Node = new HierarchyNode(this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0], false, F);
                    //            N.Nodes.Add(Node);
                    //            break;
                    //        }
                    //    }
                    //}


                    this.OverviewHierarchyCollectionNodeToEnd();
                }
                else // Tree as Specimen tree
                {
                    this.treeViewOverviewHierarchyStorage.LineColor = System.Drawing.SystemColors.WindowText;
                    System.Windows.Forms.TreeNode SpecimenNode = this.OverviewHierarchySpecimenNode;
                    if (SpecimenNode != null)
                    {
                        this.treeViewOverviewHierarchyStorage.Nodes.Add(SpecimenNode);
                        this.addOverviewHierarchyPartDependentData(SpecimenNode);
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.treeViewOverviewHierarchyStorage.Visible = true;
            }
            this.OverviewHierarchyPartNodesToEnd();
            this.addOverviewHierarchyIdentifier(IdentifierTarget.Parts);
            this.addOverviewHierarchyAnnotations(AnnotationTarget.Parts);
            this.treeViewOverviewHierarchyStorage.ExpandAll();
            this.setToolStripOverviewHierarchyStorageEditVisibility("");
            if (this.ShowCollection) this.OverviewHierarchyCollectionNodeToEnd();
        }

        private void addPartHierarchyDataNodes(System.Windows.Forms.TreeNode Node)
        {
            if (Node.Tag != null)
            {
                try
                {
                    System.Data.DataRow R = (System.Data.DataRow)Node.Tag;
                    System.Drawing.Font F = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Bold);
                    foreach (System.Data.DataRow rCS in this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows)
                    {
                        if (R["CollectionID"].ToString() == rCS["CollectionID"].ToString())
                        {
                            DiversityCollection.HierarchyNode nCS = new HierarchyNode(rCS, false, F);
                            Node.Nodes.Add(nCS);
                        }
                    }

                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void setPartNodeImage(ref DiversityCollection.HierarchyNode Node, string MaterialCategory)
        {
            MaterialCategory = MaterialCategory.ToLower();
            Node.ImageIndex = DiversityCollection.Specimen.MaterialCategoryImage(MaterialCategory, false);
            //switch (MaterialCategory)
            //{
            //    case "collection":
            //        Node.ImageIndex = (int)DiversityCollection.Specimen.OverviewImage.Collection;
            //        break;
            //    case "processing":
            //        Node.ImageIndex = (int)DiversityCollection.Specimen.OverviewImage.Processing;
            //        break;
            //    case "specimen":
            //        Node.ImageIndex = (int)DiversityCollection.Specimen.OverviewImageStorage.Specimen;
            //        break;
            //    case "herbarium sheets":
            //        Node.ImageIndex = (int)DiversityCollection.Specimen.OverviewImageStorage.HerbariumSheet;
            //        break;
            //    case "sem table":
            //        Node.ImageIndex = (int)DiversityCollection.Specimen.OverviewImageStorage.SemTable;
            //        break;
            //    case "cultures":
            //        Node.ImageIndex = (int)DiversityCollection.Specimen.OverviewImageStorage.Culture;
            //        break;
            //    case "micr. slide":
            //        Node.ImageIndex = (int)DiversityCollection.Specimen.OverviewImageStorage.Slide;
            //        break;
            //    case "icones":
            //        Node.ImageIndex = (int)DiversityCollection.Specimen.OverviewImageStorage.Icones;
            //        break;
            //    case "drawing":
            //        Node.ImageIndex = (int)DiversityCollection.Specimen.OverviewImageStorage.Drawing;
            //        break;
            //    case "bones":
            //        Node.ImageIndex = (int)DiversityCollection.Specimen.OverviewImageStorage.Bones;
            //        break;
            //    case "dna sample":
            //        Node.ImageIndex = (int)DiversityCollection.Specimen.OverviewImageStorage.DNA;
            //        break;
            //    default:
            //        Node.ImageIndex = (int)DiversityCollection.Specimen.OverviewImage.Collection;
            //        break;
            //}
            Node.SelectedImageIndex = Node.ImageIndex;
        }

        private void fillPartHierarchyTable(DataRow[] RR,
            ref DataTable DtData, DataTable DtLookup,
            string ColumnID, string ColumnParentID, string ColumnName, string ColumnSecondName)
        {
            foreach (System.Data.DataRow R in RR)
            {
                try
                {
                    System.Data.DataRow[] rCC = DtData.Select(ColumnID + " = " + R[ColumnID].ToString());
                    if (rCC.Length == 0)
                    {
                        foreach (System.Data.DataRow rL in DtLookup.Rows)
                        {
                            if (R[ColumnID].ToString() == rL[ColumnID].ToString())
                            {
                                System.Data.DataRow rn = DtData.NewRow();
                                rn[ColumnID] = R[ColumnID];
                                System.Data.DataRow[] rr = DtLookup.Select(ColumnID + " = " + R[ColumnID].ToString());
                                rn[ColumnName] = rr[0][ColumnName];
                                rn[ColumnParentID] = rr[0][ColumnParentID];
                                if (ColumnSecondName != null)
                                    rn[ColumnSecondName] = rr[0][ColumnSecondName];
                                try { DtData.Rows.Add(rn); }
                                catch { }
                                if (!rn[ColumnParentID].Equals(System.DBNull.Value))
                                {
                                    DataRow[] rrP = DtLookup.Select(ColumnID + " = " + rn[ColumnParentID].ToString());
                                    this.fillHierarchyTable(rrP, ref DtData, DtLookup, ColumnID, ColumnParentID, ColumnName, ColumnSecondName);
                                }
                            }
                        }
                    }

                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void OverviewHierarchyCollectionNodeToEnd()
        {
            System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
            this.getOverviewHierarchyNodes(null, "Collection", this.treeViewOverviewHierarchyStorage, ref Nodes);
            foreach (System.Windows.Forms.TreeNode N in Nodes)
            {
                if (N.Parent != null)
                {
                    System.Windows.Forms.TreeNode NP = N.Parent;
                    N.Remove();
                    NP.Nodes.Add(N);
                }
            }
        }

        private void addOverviewHierarchyPartDependentData()
        {
            this.addOverviewHierarchyParts();
            this.addOverviewHierarchyUnitsInPart();
            this.addOverviewHierarchyAnalysisOfPart(true);
            this.addOverviewHierarchyProcessing();
            //this.addOverviewHierarchyPartRegulation();
            //this.addOverviewHierarchyLoan();
            this.addOverviewHierarchyTransaction();
        }

        private void addOverviewHierarchyPartDependentData(System.Windows.Forms.TreeNode Node)
        {
            int PartID = 0;
            System.Data.DataRow R = (System.Data.DataRow)Node.Tag;
            string Table = R.Table.TableName;
            switch (Table)
            {
                case "Collection":
                    try
                    {
                        System.Drawing.Font F = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Bold);
                        foreach (System.Data.DataRow rCS in this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows)
                        {
                            if (R["CollectionID"].ToString() == rCS["CollectionID"].ToString())
                            {
                                DiversityCollection.HierarchyNode nCS = new HierarchyNode(rCS, false, F);
                                Node.Nodes.Add(nCS);
                                this.addOverviewHierarchyPartDependentData(nCS);
                            }
                        }

                    }
                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                    break;
                case "CollectionSpecimen":
                    foreach (System.Data.DataRow r in this.dataSetCollectionSpecimen.Tables["CollectionSpecimenPart"].Rows)
                    {
                        try
                        {
                            if (r.RowState != System.Data.DataRowState.Deleted)
                            {
                                if (r["DerivedFromSpecimenPartID"].Equals(System.DBNull.Value))
                                {
                                    PartID = System.Int32.Parse(r["SpecimenPartID"].ToString());
                                    bool StockIs0 = false;
                                    try
                                    {
                                        int Stock = 1;
                                        if (int.TryParse(r["Stock"].ToString(), out Stock))
                                        {
                                            if (Stock == 0) StockIs0 = true;
                                        }
                                    }
                                    catch { }
                                    System.Drawing.Font F = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Bold);//
                                    DiversityCollection.HierarchyNode PartNode = new HierarchyNode(r, StockIs0, F);
                                    //DiversityCollection.HierarchyNode PartNode = new HierarchyNode(r);
                                    //this.setPartNodeImage(ref PartNode, r["MaterialCategory"].ToString());
                                    //PartNode.NodeFont = F;
                                    Node.Nodes.Add(PartNode);
                                    this.addOverviewHierarchyPartDependentData(PartNode);
                                }
                            }
                        }
                        catch (Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        }
                    }
                    this.addOverviewHierarchyProcessing(Node);
                    //foreach (System.Data.DataRow r in this.dataSetCollectionSpecimen.Tables["CollectionSpecimenProcessing"].Rows)
                    //{
                    //    try
                    //    {
                    //        if (r.RowState != System.Data.DataRowState.Deleted)
                    //        {
                    //            if (r["SpecimenPartID"].Equals(System.DBNull.Value))
                    //            {
                    //                string x = "";
                    //                this.addOverviewHierarchyProcessing(Node);
                    //            }
                    //        }
                    //    }
                    //    catch (Exception ex)
                    //    {
                    //        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    //    }
                    //}
                    break;
                case "CollectionSpecimenPart":
                    PartID = System.Int32.Parse(R["SpecimenPartID"].ToString());
                    this.addOverviewHierarchyUnitsInPart(Node, PartID);
                    this.addOverviewHierarchyProcessing(Node);
                    //this.addOverviewHierarchyLoan(Node);
                    this.addOverviewHierarchyTransaction(Node, PartID);
                    this.addOverviewHierarchyReferencesInPart(Node, PartID);
                    this.addOverviewHierarchyRelationsInPart(Node, PartID);
                    //this.addOverviewHierarchyPartRegulation(Node);
                    //this.addOverviewHierarchyPartDependentData(Node);
                    if (!this.ShowCollection)
                    {
                        try
                        {
                            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.Tables["CollectionSpecimenPart"].Select("DerivedFromSpecimenPartID = " + PartID.ToString());
                            foreach (System.Data.DataRow r in rr)
                            {
                                bool StockIs0 = false;
                                try
                                {
                                    int Stock = 1;
                                    if (int.TryParse(r["Stock"].ToString(), out Stock))
                                    {
                                        if (Stock == 0) StockIs0 = true;
                                    }
                                }
                                catch { }
                                PartID = System.Int32.Parse(r["SpecimenPartID"].ToString());
                                System.Drawing.Font F = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Bold);
                                DiversityCollection.HierarchyNode ChildNode = new HierarchyNode(r, StockIs0, F);
                                //DiversityCollection.HierarchyNode ChildNode = new HierarchyNode(r);
                                //this.setPartNodeImage(ref ChildNode, r["MaterialCategory"].ToString());
                                //ChildNode.NodeFont = F;
                                Node.Nodes.Add(ChildNode);
                                this.addOverviewHierarchyPartDependentData(ChildNode);
                            }
                        }
                        catch (Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        }
                    }
                    break;
            }
        }

        private void addOverviewHierarchyPartDependentData(System.Windows.Forms.TreeNode Node, int PartID)
        {
            this.addOverviewHierarchyUnitsInPart(Node, PartID);
            this.addOverviewHierarchyProcessing(Node);
            //this.addOverviewHierarchyLoan(Node);
            this.addOverviewHierarchyTransaction(Node, PartID);
            ///TODO: freischalten wenns klappt
            //this.addOverviewHierarchyAnnotations(Node, "CollectionSpecimenPart", PartID);
            this.addOverviewHierarchyParts(Node, PartID);
        }

        #region Hiding the nodes

        private void hideOverviewHierarchyStorageNodes(string Table)
        {
            System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
            this.getOverviewHierarchyNodes(null, Table, this.treeViewOverviewHierarchyStorage, ref Nodes);
            foreach (System.Windows.Forms.TreeNode N in Nodes)
                N.Remove();
        }

        private void hideOverviewHierarchyStorageNodes(string Table, string ConditionColumn, string Condition)
        {
            System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
            this.getOverviewHierarchyNodes(null, Table, this.treeViewOverviewHierarchyStorage, ref Nodes);
            foreach (System.Windows.Forms.TreeNode N in Nodes)
            {
                System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                if (R[ConditionColumn].ToString() == Condition)
                    N.Remove();
            }
        }

        #endregion

        #endregion

        #region Collection

        private void addPartHierarchyChildCollectionNodes(System.Windows.Forms.TreeNode Node, DataTable DtCollections)
        {
            if (Node.Tag != null)
            {
                System.Data.DataRow RN = (System.Data.DataRow)Node.Tag;
                foreach (System.Data.DataRow R in DtCollections.Rows)
                {
                    try
                    {
                        if (R["CollectionParentID"].ToString() == RN["CollectionID"].ToString())
                        {
                            DiversityCollection.HierarchyNode N = new HierarchyNode(R, false);
                            Node.Nodes.Add(N);
                            this.addPartHierarchyChildCollectionNodes(N, DtCollections);
                            this.addOverviewHierarchyPartDependentData(N);
                            this.addOverviewHierarchySubcollectionContent(N);
                        }

                    }
                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                }
            }
        }

        #endregion

        #region SubcollectionContent

        private void addOverviewHierarchySubcollectionContent(System.Windows.Forms.TreeNode N)
        {
            if (this.ShowSubCollectionContent && this.ShowCollection)
            {
                try
                {
                    int CollectionID;
                    System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                    if (int.TryParse(R["CollectionID"].ToString(), out CollectionID))
                    {
                        System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenPart.Select("CollectionID = " + CollectionID.ToString(), "");
                        if (rr.Length > 0)
                        {
                            string SQL = "SELECT P.MaterialCategory, ";
                            if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.SubCollectionContentDisplayText.Contains(DiversityCollection.FormCustomizeDisplay.SubcollectionContentDisplayText.AccessionNumber.ToString()))
                                SQL += "case when S.AccessionNumber is null then '' else s.AccessionNumber + '; ' end + ";
                            if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.SubCollectionContentDisplayText.Contains(DiversityCollection.FormCustomizeDisplay.SubcollectionContentDisplayText.PartNumber.ToString()))
                                SQL += "case when p.AccessionNumber is null then '' else p.AccessionNumber + '; ' end + ";
                            if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.SubCollectionContentDisplayText.Contains(DiversityCollection.FormCustomizeDisplay.SubcollectionContentDisplayText.Identification.ToString()))
                                SQL += "case when MIN(U.LastIdentificationCache) is null then '' else MIN(U.LastIdentificationCache) + '; ' end + ";
                            if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.SubCollectionContentDisplayText.Contains(DiversityCollection.FormCustomizeDisplay.SubcollectionContentDisplayText.StorageLocation.ToString()))
                                SQL += "case when P.StorageLocation is null then '' else P.StorageLocation + '; ' end + ";
                            if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.SubCollectionContentDisplayText.Contains(DiversityCollection.FormCustomizeDisplay.SubcollectionContentDisplayText.Locality.ToString()))
                                SQL += "CASE WHEN E.LocalityDescription IS NULL  THEN '' ELSE E.LocalityDescription + '; ' END + ";
                            if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.SubCollectionContentDisplayText.Contains(DiversityCollection.FormCustomizeDisplay.SubcollectionContentDisplayText.CollectionDate.ToString()))
                                SQL += "CASE WHEN E.CollectionDate IS NULL THEN '' ELSE CONVERT(nvarchar(50), E.CollectionDate, 111) + '; ' END +  ";
                            SQL += " '' AS DisplayText " +
                            "FROM CollectionSpecimenPart AS P INNER JOIN " +
                            "CollectionSpecimen AS S ON P.CollectionSpecimenID = S.CollectionSpecimenID LEFT OUTER JOIN " +
                            "CollectionEvent AS E ON S.CollectionEventID = E.CollectionEventID LEFT OUTER JOIN " +
                            "IdentificationUnit AS U ON S.CollectionSpecimenID = U.CollectionSpecimenID " +
                            "WHERE P.CollectionID = " + CollectionID.ToString() +
                            " GROUP BY P.MaterialCategory, S.AccessionNumber, P.AccessionNumber, P.StorageLocation, E.LocalityDescription, E.CollectionDate, P.SpecimenPartID";
                            System.Data.DataTable DtSubcollectionContent = new DataTable("SubcollectionContent");
                            System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                            ad.Fill(DtSubcollectionContent);
                            foreach (System.Data.DataRow Rsc in DtSubcollectionContent.Rows)
                            {
                                DiversityCollection.HierarchyNode Nsc = new HierarchyNode(true, Rsc);
                                N.Nodes.Add(Nsc);
                            }
                        }
                    }
                }
                catch (System.Exception ex)
                {
                }
            }
        }

        private void hideOverviewHierarchySubcollectionContent()
        {
            this.hideOverviewHierarchyStorageNodes("SubcollectionContent");
        }
        
        #endregion

        #region Part nodes

        private void OverviewHierarchyPartNodesToEnd()
        {
            System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
            this.getOverviewHierarchyNodes(null, "CollectionSpecimenPart", this.treeViewOverviewHierarchyStorage, ref Nodes);
            foreach (System.Windows.Forms.TreeNode N in Nodes)
            {
                System.Windows.Forms.TreeNode NP = N.Parent;
                N.Remove();
                NP.Nodes.Add(N);
            }
        }

        private void addOverviewHierarchyParts()
        {
            System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
            this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchyStorage, ref Nodes);
            if (Nodes.Count > 0)
            {
                foreach (System.Data.DataRow r in this.dataSetCollectionSpecimen.Tables["CollectionSpecimenPart"].Rows)
                {
                    try
                    {
                        if (r.RowState != System.Data.DataRowState.Deleted)
                        {
                            if (r["DerivedFromSpecimenPartID"].Equals(System.DBNull.Value))
                            {
                                int PartID = System.Int32.Parse(r["SpecimenPartID"].ToString());
                                System.Drawing.Font F = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Bold);//
                                bool StockIs0 = false;
                                try
                                {
                                    int Stock = 1;
                                    if (int.TryParse(r["Stock"].ToString(), out Stock))
                                    {
                                        if (Stock == 0) StockIs0 = true;
                                    }
                                }
                                catch { }
                                DiversityCollection.HierarchyNode Node = new HierarchyNode(r, StockIs0, F);
                                //DiversityCollection.HierarchyNode Node = new HierarchyNode(r);
                                //this.setPartNodeImage(ref Node, r["MaterialCategory"].ToString());
                                //Node.NodeFont = F;
                                Nodes[0].Nodes.Add(Node);
                                this.addOverviewHierarchyPartDependentData(Node, PartID);
                                //this.addOverviewHierarchyParts(Node, PartID);
                                //Nodes[0].Expand();
                                //Node.Expand();
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                }
            }
            //this.addOverviewHierarchyUnitsInPart();
            //this.addOverviewHierarchyProcessing();
            //this.addOverviewHierarchyTransaction();
        }

        //private void addOverviewHierarchyParts(System.Windows.Forms.TreeNode Node)
        //{
        //    System.Data.DataRow R = (System.Data.DataRow)Node.Tag;
        //    string Table = R.Table.TableName;
        //    foreach (System.Data.DataRow r in this.dataSetCollectionSpecimen.Tables["CollectionSpecimenPart"].Rows)
        //    {
        //        try
        //        {
        //            if (r.RowState != System.Data.DataRowState.Deleted)
        //            {
        //                switch (Table)
        //                {
        //                    case "CollectionSpecimenPart":
        //                        break;
        //                    case "CollectionSpecimenPart":
        //                        break;
        //                    case "CollectionSpecimenPart":
        //                        break;
        //                }
        //                if (r["DerivedFromSpecimenPartID"].Equals(System.DBNull.Value))
        //                {
        //                    int PartID = System.Int32.Parse(r["SpecimenPartID"].ToString());
        //                    System.Drawing.Font F = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Bold);//
        //                    DiversityCollection.HierarchyNode Node = new HierarchyNode(r);
        //                    this.setPartNodeImage(ref Node, r["MaterialCategory"].ToString());
        //                    Node.NodeFont = F;
        //                    Nodes[0].Nodes.Add(Node);
        //                    this.addOverviewHierarchyPartDependentData(Node, PartID);
        //                }
        //            }
        //        }
        //        catch (Exception ex)
        //        {
        //            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
        //        }
        //    }
        //}

        private void addOverviewHierarchyParts(System.Windows.Forms.TreeNode pNode, int SpecimenPartID)
        {
            try
            {
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.Tables["CollectionSpecimenPart"].Select("DerivedFromSpecimenPartID = " + SpecimenPartID.ToString());
                foreach (System.Data.DataRow r in rr)
                {
                    int PartID = System.Int32.Parse(r["SpecimenPartID"].ToString());
                    System.Drawing.Font F = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Bold);
                    DiversityCollection.HierarchyNode Node = new HierarchyNode(r, false, F);
                    //DiversityCollection.HierarchyNode Node = new HierarchyNode(r);
                    //this.setPartNodeImage(ref Node, r["MaterialCategory"].ToString());
                    //Node.NodeFont = F;
                    pNode.Nodes.Add(Node);
                    this.addOverviewHierarchyPartDependentData(Node, PartID);
                    //this.addOverviewHierarchyUnitsInPart(Node, PartID);
                    //this.addOverviewHierarchyLoan(Node);
                    //this.addOverviewHierarchyTransaction(Node, PartID);
                    //this.addOverviewHierarchyProcessing(Node);
                    //this.addOverviewHierarchyParts(Node, PartID);
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void refreshHierarchyPartUnitNodes(System.Windows.Forms.TreeNode Node, string Table)
        {
            try
            {
                if (Node == null) return;
                this.treeViewOverviewHierarchyStorage.Visible = false;
                System.Windows.Forms.TreeNode NodeToRefresh;
                //System.Data.DataRow R = (System.Data.DataRow)Node.Tag;
                //string TableOfNode = R.Table.TableName;
                //int PartID = int.Parse(R["SpecimenPartID"].ToString());
                switch (Table)
                {
                    case "CollectionSpecimenPart":
                        NodeToRefresh = Node;
                        break;
                    case "CollectionSpecimenProcessing":
                    case "CollectionSpecimenTransaction":
                    case "IdentificationUnitInPart":
                        NodeToRefresh = Node.Parent;
                        break;
                    default:
                        return;
                }
                //if (R.Table.TableName == "CollectionSpecimenPart") NodeToRefresh = Node;
                //else if (R.Table.TableName == "IdentificationUnitInPart") NodeToRefresh = Node.Parent;
                //else return;
                if (NodeToRefresh != null)
                {
                    System.Collections.Generic.List<System.Windows.Forms.TreeNode> UnitNodes = new List<TreeNode>();
                    foreach (System.Windows.Forms.TreeNode N in NodeToRefresh.Nodes)
                        UnitNodes.Add(N);
                    foreach (System.Windows.Forms.TreeNode ND in UnitNodes)
                        ND.Remove();
                    this.addOverviewHierarchyPartDependentData(NodeToRefresh);
                    this.treeViewOverviewHierarchyStorage.SelectedNode = NodeToRefresh;
                    this.treeViewOverviewHierarchyStorage.ExpandAll();
                    //if (R.Table.TableName == Table)
                    //    this.treeViewOverviewHierarchyStorage.SelectedNode = NodeToRefresh;
                    //else
                    //{
                    //    foreach (System.Windows.Forms.TreeNode NChild in NodeToRefresh.Nodes)
                    //    {
                    //        if (NChild.Tag != null)
                    //        {
                    //            System.Data.DataRow RChild = (System.Data.DataRow)NChild.Tag;
                    //            if (RChild.Table.TableName == Table)
                    //            {
                    //                this.treeViewOverviewHierarchyStorage.SelectedNode = NChild;
                    //                break;
                    //            }
                    //        }
                    //    }
                    //}
                    //this.addOverviewHierarchyPartDependentData(NodeToRefresh, PartID);
                    //this.addOverviewHierarchyUnitsInPart(NodeToRefresh, PartID);
                    //this.addOverviewHierarchyLoan(NodeToRefresh);
                    //this.addOverviewHierarchyTransaction(NodeToRefresh, PartID);
                    //this.addOverviewHierarchyProcessing(NodeToRefresh);
                    //this.addOverviewHierarchyParts(NodeToRefresh, PartID);
                }
            }
            catch { }
            finally { this.treeViewOverviewHierarchyStorage.Visible = true; }
        }

        #endregion

        #region Units in part

        private void addOverviewHierarchyUnitsInPart()
        {
            if (this.ShowUnitsInPart)
            {
                LookupTable.DtIdentificationUnit = this.dataSetCollectionSpecimen.IdentificationUnit.Copy();
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> PartNodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionSpecimenPart", this.treeViewOverviewHierarchyStorage, ref PartNodes);
                foreach (System.Windows.Forms.TreeNode N in PartNodes)
                {
                    System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                    int PartID = int.Parse(R["SpecimenPartID"].ToString());
                    this.addOverviewHierarchyUnitsInPart(N, PartID);
                }
            }
            this.OverviewHierarchyPartNodesToEnd();
        }

        private void addOverviewHierarchyUnitsInPart(System.Windows.Forms.TreeNode N, int PartID)
        {
            if (this.ShowUnitsInPart)
            {
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitInPart.Select("SpecimenPartID = " + PartID.ToString(), "DisplayOrder", System.Data.DataViewRowState.CurrentRows);
                if (rr.Length > 0)
                {
                    for (int i = 0; i < rr.Length; i++)
                    {
                        if (!rr[i]["DisplayOrder"].Equals(System.DBNull.Value) && rr[i]["DisplayOrder"].ToString() != "0")
                        {
                            int ImageIndex = 0;
                            foreach (System.Data.DataRow R in DiversityCollection.LookupTable.DtIdentificationUnit.Rows)
                            {
                                if (rr[i]["IdentificationUnitID"].ToString() == R["IdentificationUnitID"].ToString())
                                {
                                    string TaxonomicGroup = R["TaxonomicGroup"].ToString();
                                    string UnitDescription = R["UnitDescription"].ToString();
                                    ImageIndex = DiversityCollection.Specimen.TaxonImageIndex(TaxonomicGroup, UnitDescription, false);
                                    break;
                                }
                            }
                            DiversityCollection.HierarchyNode NI = new HierarchyNode(rr[i], ImageIndex, false, null);
                            N.Nodes.Add(NI);
                            int UnitID = 0;
                            if (int.TryParse(rr[i]["IdentificationUnitID"].ToString(), out UnitID))
                            {
                                this.addOverviewHierarchyAnalysisOfPart(NI, UnitID, PartID);
                                this.addOverviewHierarchyReferencesInPart(NI, UnitID, PartID);
                                this.addOverviewHierarchyRelationsInPart(NI, PartID, UnitID);
                            }
                        }
                    }
                    for (int i = 0; i < rr.Length; i++)
                    {
                        if (rr[i]["DisplayOrder"].Equals(System.DBNull.Value) || rr[i]["DisplayOrder"].ToString() == "0")
                        {
                            int ImageIndex = 0;
                            foreach (System.Data.DataRow R in DiversityCollection.LookupTable.DtIdentificationUnit.Rows)
                            {
                                if (rr[i]["IdentificationUnitID"].ToString() == R["IdentificationUnitID"].ToString())
                                {
                                    string TaxonomicGroup = R["TaxonomicGroup"].ToString();
                                    string UnitDescription = R["UnitDescription"].ToString();
                                    ImageIndex = DiversityCollection.Specimen.TaxonImageIndex(TaxonomicGroup, UnitDescription, false);
                                    break;
                                }
                            }
                            DiversityCollection.HierarchyNode NI = new HierarchyNode(rr[i], ImageIndex, true, null);
                            N.Nodes.Add(NI);
                            int UnitID = 0;
                            if (int.TryParse(rr[i]["IdentificationUnitID"].ToString(), out UnitID))
                            {
                                this.addOverviewHierarchyAnalysisOfPart(NI, UnitID, PartID);
                            }
                        }
                    }
                }
            }
        }

        private void hideOverviewHierarchyUnitsInPart()
        {
            this.hideOverviewHierarchyStorageNodes("IdentificationUnitInPart");
        }

        #endregion

        #region Analysis of part

        private void addOverviewHierarchyAnalysisOfPart(bool ExpandNode)
        {
            if (this.ShowAnalysisOfPart)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "IdentificationUnitInPart", this.treeViewOverviewHierarchyStorage, ref Nodes);
                foreach (System.Windows.Forms.TreeNode N in Nodes)
                {
                    System.Data.DataRow RP = (System.Data.DataRow)N.Parent.Tag;
                    int PartID = int.Parse(RP["SpecimenPartID"].ToString());
                    System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                    int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
                    this.addOverviewHierarchyAnalysisOfPart(N, UnitID, PartID);
                    if (ExpandNode) N.Expand();
                }
            }
            //this.OverviewHierarchyUnitNodesToEnd();
        }

        private void addOverviewHierarchyAnalysisOfPart(System.Windows.Forms.TreeNode N, int UnitID, int PartID)
        {
            if (this.ShowAnalysis)
            {
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select("IdentificationUnitID = " + UnitID.ToString() + " AND SpecimenPartID = " + PartID.ToString(), "", System.Data.DataViewRowState.CurrentRows);
                if (rr.Length > 0)
                {
                    for (int i = 0; i < rr.Length; i++)
                    {
                        DiversityCollection.HierarchyNode NA = new HierarchyNode(rr[i], false);
                        //DiversityCollection.HierarchyNode NA = new HierarchyNode(rr[i]);
                        //NA.ImageIndex = (int)DiversityCollection.Specimen.OverviewImage.Analysis;
                        //NA.SelectedImageIndex = (int)DiversityCollection.Specimen.OverviewImage.Analysis;
                        N.Nodes.Add(NA);
                    }
                }
            }
        }

        private void hideOverviewHierarchyAnalysisOfPart()
        {
            this.hideOverviewHierarchyStorageNodes("IdentificationUnitAnalysis");
        }

        #endregion

        #region Processing

        private void addOverviewHierarchyProcessing()
        {
            if (this.ShowProcessing)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> PartNodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionSpecimenPart", this.treeViewOverviewHierarchyStorage, ref PartNodes);
                foreach (System.Windows.Forms.TreeNode N in PartNodes)
                {
                    //System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                    //int PartID = int.Parse(R["SpecimenPartID"].ToString());
                    this.addOverviewHierarchyProcessing(N);
                }
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> SpecimenNodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchyStorage, ref SpecimenNodes);
                if (SpecimenNodes.Count > 0)
                {
                    foreach (System.Data.DataRow rP in this.dataSetCollectionSpecimen.CollectionSpecimenProcessing.Rows)
                    {
                        if (rP["SpecimenPartID"].Equals(System.DBNull.Value))
                        {
                            DiversityCollection.HierarchyNode NI = new HierarchyNode(rP, false);
                            //DiversityCollection.HierarchyNode NI = new HierarchyNode(rP);
                            //NI.ImageIndex = (int)DiversityCollection.Specimen.OverviewImage.Processing;
                            //NI.SelectedImageIndex = (int)DiversityCollection.Specimen.OverviewImage.Processing;
                            SpecimenNodes[0].Nodes.Add(NI);
                        }
                    }
                }
            }
            this.OverviewHierarchyPartNodesToEnd();
        }

        private void addOverviewHierarchyProcessing(System.Windows.Forms.TreeNode N)
        {
            if (this.ShowProcessing)
            {
                try
                {
                    System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                    if (R.RowState != DataRowState.Deleted)
                    {
                        foreach (System.Data.DataRow rP in this.dataSetCollectionSpecimen.CollectionSpecimenProcessing.Rows)
                        {
                            if (rP.RowState != DataRowState.Deleted)
                            {
                                if (rP.RowState != DataRowState.Deleted && !rP["SpecimenPartID"].Equals(System.DBNull.Value) && R.Table.TableName == "CollectionSpecimenPart")
                                {
                                    if (rP["SpecimenPartID"].ToString() == R["SpecimenPartID"].ToString())
                                    {
                                        DiversityCollection.HierarchyNode NI = new HierarchyNode(rP, false);
                                        N.Nodes.Add(NI);
                                    }
                                }
                                else if (rP["SpecimenPartID"].Equals(System.DBNull.Value) && R.Table.TableName == "CollectionSpecimen")
                                {
                                    DiversityCollection.HierarchyNode NPro = new HierarchyNode(rP, false);
                                    N.Nodes.Add(NPro);
                                }
                            }
                        }
                    }
                }
                catch (System.Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void hideOverviewHierarchyProcessing()
        {
            this.hideOverviewHierarchyStorageNodes("CollectionSpecimenProcessing");
        }

        #endregion

        #region Regulation

        private void addOverviewHierarchyPartRegulation()
        {
            return;

            System.Collections.Generic.List<System.Windows.Forms.TreeNode> PartNodes = new List<TreeNode>();
            this.getOverviewHierarchyNodes(null, "CollectionSpecimenPart", this.treeViewOverviewHierarchyStorage, ref PartNodes);
            foreach (System.Windows.Forms.TreeNode N in PartNodes)
            {
                this.addOverviewHierarchyPartRegulation(N);
            }
            System.Collections.Generic.List<System.Windows.Forms.TreeNode> SpecimenNodes = new List<TreeNode>();
            this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchyStorage, ref SpecimenNodes);
            if (SpecimenNodes.Count > 0)
            {
                foreach (System.Data.DataRow rP in this.dataSetCollectionSpecimen.CollectionSpecimenPartRegulation.Rows)
                {
                    if (rP["SpecimenPartID"].Equals(System.DBNull.Value))
                    {
                        DiversityCollection.HierarchyNode NI = new HierarchyNode(rP, false);
                        SpecimenNodes[0].Nodes.Add(NI);
                    }
                }
            }
            this.OverviewHierarchyPartNodesToEnd();
        }

        private void addOverviewHierarchyPartRegulation(System.Windows.Forms.TreeNode N)
        {
            return;

            try
            {
                System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                if (R.RowState != DataRowState.Deleted)
                {
                    foreach (System.Data.DataRow rR in this.dataSetCollectionSpecimen.CollectionSpecimenPartRegulation.Rows)
                    {
                        if (rR.RowState != DataRowState.Deleted)
                        {
                            if (rR.RowState != DataRowState.Deleted && !rR["SpecimenPartID"].Equals(System.DBNull.Value) && R.Table.TableName == "CollectionSpecimenPart")
                            {
                                if (rR["SpecimenPartID"].ToString() == R["SpecimenPartID"].ToString())
                                {
                                    DiversityCollection.HierarchyNode NI = new HierarchyNode(rR, false);
                                    N.Nodes.Add(NI);
                                }
                            }
                            else if (rR["SpecimenPartID"].Equals(System.DBNull.Value) && R.Table.TableName == "CollectionSpecimen")
                            {
                                DiversityCollection.HierarchyNode NReg = new HierarchyNode(rR, false);
                                N.Nodes.Add(NReg);
                            }
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #region Transaction

        private void addOverviewHierarchyLoan()
        {
            //if (this.ShowLoan || this.ShowTransaction)
            //{
            //    System.Collections.Generic.List<System.Windows.Forms.TreeNode> PartNodes = new List<TreeNode>();
            //    this.getOverviewHierarchyNodes(null, "CollectionSpecimenPart", this.treeViewOverviewHierarchyStorage, ref PartNodes);
            //    foreach (System.Windows.Forms.TreeNode N in PartNodes)
            //    {
            //        System.Data.DataRow R = (System.Data.DataRow)N.Tag;
            //        this.addOverviewHierarchyLoan(N);
            //    }
            //}
            //this.OverviewHierarchyPartNodesToEnd();
        }

        private void addOverviewHierarchyLoan(System.Windows.Forms.TreeNode N)
        {
            //if (this.ShowLoan || this.ShowTransaction)
            //{
            //    System.Data.DataRow R = (System.Data.DataRow)N.Tag;
            //    foreach (System.Data.DataRow rP in this.dataSetCollectionSpecimen.CollectionSpecimenTransaction.Rows)
            //    {
            //        if (rP.RowState != DataRowState.Deleted && rP.RowState != DataRowState.Detached)
            //        {
            //            string TransactionType = DiversityCollection.LookupTable.TransactionType(int.Parse(rP["TransactionID"].ToString()));
            //            if (((TransactionType == "loan" || TransactionType == "forwarding") && !this.ShowLoan) || TransactionType == "return") 
            //                continue;
            //            if ((rP["TransactionReturnID"].Equals(System.DBNull.Value)) && rP["SpecimenPartID"].ToString() == R["SpecimenPartID"].ToString())
            //            {
            //                DiversityCollection.HierarchyNode NI = new HierarchyNode(rP, false);
            //                N.Nodes.Add(NI);
            //            }
            //        }
            //    }
            //}
        }

        private void addOverviewHierarchyTransaction()
        {
            //if (!this.ShowLoan) this.addOverviewHierarchyLoan();
            if (this.ShowTransaction)
            {
                try
                {
                    System.Collections.Generic.List<System.Windows.Forms.TreeNode> PartNodes = new List<TreeNode>();
                    this.getOverviewHierarchyNodes(null, "CollectionSpecimenPart", this.treeViewOverviewHierarchyStorage, ref PartNodes);
                    foreach (System.Windows.Forms.TreeNode N in PartNodes)
                    {
                        System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                        this.addOverviewHierarchyTransaction(N, 1);
                    }
                }
                catch (System.Exception ex)
                {
                }
            }
            this.OverviewHierarchyPartNodesToEnd();
        }

        private void addOverviewHierarchyTransaction(System.Windows.Forms.TreeNode N, int PartID)
        {
            if (this.ShowTransaction)
            {
                try
                {
                    // the Row where the TransactionNodes should be attached
                    System.Data.DataRow R = (System.Data.DataRow)N.Tag;

                    // Getting all rows related to the part and their transaction types
                    System.Collections.Generic.Dictionary<System.Data.DataRow, string> TransactionRows = new Dictionary<DataRow, string>();
                    foreach (System.Data.DataRow rT in this.dataSetCollectionSpecimen.CollectionSpecimenTransaction.Rows)
                    {
                        if (rT.RowState != DataRowState.Detached
                            && rT.RowState != DataRowState.Deleted
                            && rT["SpecimenPartID"].ToString() == R["SpecimenPartID"].ToString())
                        {
                            string TransactionType = DiversityCollection.LookupTable.TransactionType(int.Parse(rT["TransactionID"].ToString()));
                            if (!TransactionRows.ContainsKey(rT))
                                TransactionRows.Add(rT, TransactionType);
                            else
                            {
                            }
                        }
                    }

                    // walking through the sequence of the display order of the transaction
                    foreach (System.Collections.Generic.KeyValuePair<string, DiversityCollection.LookupTable.TransactionDisplaySorter> TS in DiversityCollection.LookupTable.TransactionDisplaySorting())
                    {
                        System.Collections.Generic.SortedList<string, System.Data.DataRow> CurrentRows = new SortedList<string, DataRow>();
                        foreach (System.Collections.Generic.KeyValuePair<System.Data.DataRow, string> KV in TransactionRows)
                        {
                            if (KV.Value.ToLower() == TS.Key.ToLower())
                            {
                                int TransactionID = int.Parse(KV.Key["TransactionID"].ToString());
                                string Date = DiversityCollection.LookupTable.TransactionDateAsString(TransactionID, "BeginDate", false);
                                if (Date.Length == 0)
                                    Date = "- " + DiversityCollection.LookupTable.TransactionDateAsString(TransactionID, "AgreedEndDate", false);
                                switch (TS.Value)
                                {
                                    case LookupTable.TransactionDisplaySorter.AccessionNumber:
                                        if (!CurrentRows.ContainsKey(KV.Key["AccessionNumber"].ToString()))
                                            CurrentRows.Add(KV.Key["AccessionNumber"].ToString() + Date, KV.Key);
                                        else
                                            CurrentRows.Add(KV.Key["AccessionNumber"].ToString() + Date + " " + CurrentRows.Count.ToString(), KV.Key);
                                        break;
                                    case LookupTable.TransactionDisplaySorter.BeginDate:
                                        if (!CurrentRows.ContainsKey(Date))
                                            CurrentRows.Add(Date, KV.Key);
                                        else
                                            CurrentRows.Add(Date + " " + CurrentRows.Count.ToString(), KV.Key);
                                        break;
                                    case LookupTable.TransactionDisplaySorter.TransactionTitle:
                                        if (!CurrentRows.ContainsKey(DiversityCollection.LookupTable.TransactionTitle(TransactionID) + Date))
                                            CurrentRows.Add(DiversityCollection.LookupTable.TransactionTitle(TransactionID) + Date, KV.Key);
                                        else
                                            CurrentRows.Add(DiversityCollection.LookupTable.TransactionTitle(TransactionID) + Date + " " + CurrentRows.Count.ToString(), KV.Key);
                                        break;
                                }
                            }
                        }
                        foreach (System.Collections.Generic.KeyValuePair<string, System.Data.DataRow> KV in CurrentRows)
                        {
                            bool Inactive = false;
                            string Type = DiversityCollection.LookupTable.TransactionType(int.Parse(KV.Value["TransactionID"].ToString()));
                            switch (Type)
                            {
                                case "embargo":
                                //case "regulation":
                                case "permit":
                                    Inactive = !DiversityCollection.LookupTable.TransactionInActivePeriod(int.Parse(KV.Value["TransactionID"].ToString()));
                                    break;
                                case "loan":
                                case "forwarding":
                                case "borrow":
                                    if (!KV.Value["TransactionReturnID"].Equals(System.DBNull.Value))
                                        Inactive = true;
                                    break;
                            }
                            DiversityCollection.HierarchyNode NI = new HierarchyNode(KV.Value, Inactive);
                            N.Nodes.Add(NI);
                            this.addOverviewHierarchyTransactionChildren(NI, PartID);
                        }
                    }
                }
                catch (System.Exception ex)
                {
                }
            }
            else
            {
                // Permits and regultions
                try
                {
                    // the Row where the TransactionNodes should be attached
                    System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                    // permits
                    string SQL = "SELECT P.TransactionTitle, P.TransactionID, T.CollectionSpecimenID, T.SpecimenPartID " +
                        "FROM TransactionPermit AS P INNER JOIN " +
                        "CollectionSpecimenTransaction AS T ON P.TransactionID = T.TransactionID " +
                        "WHERE T.SpecimenPartID = " + R["SpecimenPartID"].ToString();
                    System.Data.DataTable dtPermit = new DataTable("CollectionSpecimenTransaction");
                    string Message = "";
                    DiversityWorkbench.FormFunctions.SqlFillTable(SQL, ref dtPermit, ref Message);
                    if (dtPermit.Rows.Count > 0)
                    {
                        foreach (System.Data.DataRow Rpermit in dtPermit.Rows)
                        {
                            bool Inactive = DiversityCollection.LookupTable.TransactionInActivePeriod(int.Parse(Rpermit["TransactionID"].ToString()));
                            DiversityCollection.HierarchyNode NI = new HierarchyNode(Rpermit, Inactive);
                            N.Nodes.Add(NI);
                        }
                    }

                    // regulations
                    SQL = "SELECT R.TransactionTitle, T.TransactionID " +
                        "FROM TransactionRegulation AS R INNER JOIN " +
                        "CollectionSpecimenTransaction AS T ON R.TransactionID = T.TransactionID " +
                        "WHERE T.SpecimenPartID = " + R["SpecimenPartID"].ToString();
                    System.Data.DataTable dtRegulation = new DataTable("CollectionSpecimenTransaction");
                    DiversityWorkbench.FormFunctions.SqlFillTable(SQL, ref dtRegulation, ref Message);
                    if (dtRegulation.Rows.Count > 0)
                    {
                        foreach (System.Data.DataRow Rreg in dtRegulation.Rows)
                        {
                            DiversityCollection.HierarchyNode NI = new HierarchyNode(Rreg, false);
                            N.Nodes.Add(NI);
                        }
                    }

                }
                catch (System.Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void addOverviewHierarchyTransactionChildren(System.Windows.Forms.TreeNode N, int PartID)
        {
            if (this.ShowTransaction)
            {
                try
                {
                    // the Row where the TransactionNodes should be attached
                    System.Data.DataRow R = (System.Data.DataRow)N.Tag;

                    // Getting the parentTransactionID
                    int ParentTransactionID = int.Parse(R["TransactionID"].ToString());

                    // Getting all rows related to the part and the parent transaction
                    System.Collections.Generic.Dictionary<System.Data.DataRow, string> TransactionRows = new Dictionary<DataRow, string>();
                    System.Data.DataRow[] rrChildren = DiversityCollection.LookupTable.DtTransactionHierarchy.Select("ParentTransactionID = " + ParentTransactionID.ToString());
                    if (rrChildren.Length > 0)
                    {
                        System.Collections.Generic.List<string> ChildTransactionIDs = new List<string>();
                        foreach (System.Data.DataRow rC in rrChildren)
                        {
                            ChildTransactionIDs.Add(rC["TransactionID"].ToString());
                        }
                        foreach (System.Data.DataRow rT in this.dataSetCollectionSpecimen.CollectionSpecimenTransaction.Rows)
                        {
                            if (rT.RowState != DataRowState.Detached
                                && rT.RowState != DataRowState.Deleted
                                && rT["SpecimenPartID"].ToString() == R["SpecimenPartID"].ToString()
                                && ChildTransactionIDs.Contains(rT["TransactionID"].ToString()))
                            {
                                string TransactionType = DiversityCollection.LookupTable.TransactionType(int.Parse(rT["TransactionID"].ToString()));
                                TransactionRows.Add(rT, TransactionType);
                            }
                        }
                    }

                    // walking through the children
                    foreach (System.Collections.Generic.KeyValuePair<System.Data.DataRow, string> KV in TransactionRows)
                    {
                        bool Inactive = false;
                        switch (KV.Value.ToLower())
                        {
                            case "embargo":
                            //case "regulation":
                            case "permit":
                                Inactive = DiversityCollection.LookupTable.TransactionInActivePeriod(int.Parse(KV.Key["TransactionID"].ToString()));
                                break;
                            case "loan":
                            case "forwarding":
                            case "borrow":
                                if (!KV.Key["TransactionReturnID"].Equals(System.DBNull.Value))
                                    Inactive = true;
                                break;
                            case "return":
                                Inactive = true;
                                break;
                        }
                        bool WrongAssignment = false;
                        if (!R["TransactionReturnID"].Equals(System.DBNull.Value) && R["TransactionReturnID"].ToString() != KV.Key["TransactionID"].ToString())
                        {
                            WrongAssignment = true;
                        }
                        DiversityCollection.HierarchyNode NI = new HierarchyNode(KV.Key, Inactive);
                        if (WrongAssignment)
                        {
                            string Title = DiversityCollection.LookupTable.TransactionTitle(int.Parse(KV.Key["TransactionID"].ToString()));
                            string Message = "Wrong assignment:\r\nThe superior transaction of the " + KV.Value + " " + Title + " is assigned to a different transaction.\r\nPlease examine if the " + KV.Value + " " + Title + " must be removed";
                            System.Windows.Forms.MessageBox.Show(Message, "Wrong assignement", MessageBoxButtons.OK, MessageBoxIcon.Error);
                            NI.BackColor = System.Drawing.Color.Pink;
                            NI.ToolTipText = Message;
                        }
                        N.Nodes.Add(NI);
                        this.addOverviewHierarchyTransactionChildren(NI, PartID);
                    }
                }
                catch (System.Exception ex)
                {
                }
            }
        }

        private void hideOverviewHierarchyLoans()
        {
            //this.hideOverviewHierarchyStorageNodes("CollectionSpecimenTransaction", "IsOnLoan", "True");
        }

        private void hideOverviewHierarchyTransactions()
        {
            this.hideOverviewHierarchyStorageNodes("CollectionSpecimenTransaction");
            //this.addOverviewHierarchyLoan();
        }

        #endregion

        #region References

        private void addOverviewHierarchyReferencesInPart(System.Windows.Forms.TreeNode N, int PartID)
        {
            //if (this.ShowRelation)
            //{
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> PartNodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionSpecimenPart", this.treeViewOverviewHierarchyStorage, ref PartNodes);
                foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenReference.Rows)
                {
                    if (R.RowState == DataRowState.Deleted) continue;
                    if (R["SpecimenPartID"].Equals(System.DBNull.Value)) continue;
                    if (!R["IdentificationUnitID"].Equals(System.DBNull.Value)) continue;
                    System.Data.DataRow RPart = (System.Data.DataRow)N.Tag;
                    if (RPart["SpecimenPartID"].ToString() == R["SpecimenPartID"].ToString())
                    {
                        DiversityCollection.HierarchyNode NRer = new HierarchyNode(R, false);
                        N.Nodes.Add(NRer);
                    }
                }
            //}
        }

        private void addOverviewHierarchyReferencesInPart(System.Windows.Forms.TreeNode N, int PartID, int UnitID)
        {
            //if (this.ShowRelation)
            //{
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> PartNodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "IdentificationUnitInPart", this.treeViewOverviewHierarchyStorage, ref PartNodes);
                foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenReference.Rows)
                {
                    if (R.RowState == DataRowState.Deleted) continue;
                    if (R["SpecimenPartID"].Equals(System.DBNull.Value)) continue;
                    if (R["IdentificationUnitID"].Equals(System.DBNull.Value)) continue;
                    System.Data.DataRow RPart = (System.Data.DataRow)N.Tag;
                    if (RPart["SpecimenPartID"].ToString() == R["SpecimenPartID"].ToString() &&
                        RPart["IdentificationUnitID"].ToString() == R["IdentificationUnitID"].ToString())
                    {
                        DiversityCollection.HierarchyNode NRef = new HierarchyNode(R, false);
                        N.Nodes.Add(NRef);
                    }
                }
            //}
        }

        #endregion

        #region Relations

        private void addOverviewHierarchyRelationsInPart(System.Windows.Forms.TreeNode N, int PartID)
        {
            if (this.ShowRelation)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> PartNodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionSpecimenPart", this.treeViewOverviewHierarchyStorage, ref PartNodes);
                foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows)
                {
                    if (R.RowState == DataRowState.Deleted) continue;
                    if (R["SpecimenPartID"].Equals(System.DBNull.Value)) continue;
                    if (!R["IdentificationUnitID"].Equals(System.DBNull.Value)) continue;
                    System.Data.DataRow RPart = (System.Data.DataRow)N.Tag;
                    if (RPart["SpecimenPartID"].ToString() == R["SpecimenPartID"].ToString())
                    {
                        DiversityCollection.HierarchyNode NRel = new HierarchyNode(R, false);
                        N.Nodes.Add(NRel);
                        if (R["IsInternalRelationCache"].ToString() == "True")
                            this.addOverviewHierarchyRelationsInfo(NRel);
                    }
                }
            }
        }

        private void addOverviewHierarchyRelationsInPart(System.Windows.Forms.TreeNode N, int PartID, int UnitID)
        {
            if (this.ShowRelation)
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> PartNodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "IdentificationUnitInPart", this.treeViewOverviewHierarchyStorage, ref PartNodes);
                foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows)
                {
                    if (R.RowState == DataRowState.Deleted) continue;
                    if (R["SpecimenPartID"].Equals(System.DBNull.Value)) continue;
                    if (R["IdentificationUnitID"].Equals(System.DBNull.Value)) continue;
                    System.Data.DataRow RPart = (System.Data.DataRow)N.Tag;
                    if (RPart["SpecimenPartID"].ToString() == R["SpecimenPartID"].ToString() &&
                        RPart["IdentificationUnitID"].ToString() == R["IdentificationUnitID"].ToString())
                    {
                        DiversityCollection.HierarchyNode NRel = new HierarchyNode(R, false);
                        N.Nodes.Add(NRel);
                        if (R["IsInternalRelationCache"].ToString() == "True")
                            this.addOverviewHierarchyRelationsInfo(NRel);
                    }
                }
            }
        }

        #endregion

        #endregion

        #endregion

        #region Properties - Show items in the hierarchies

        private HierachyDisplayStyle DisplayStyleSamplingPlots
        {
            get
            {
                try
                {
                    if (this.toolStripDropDownButtonOverviewHierarchyShowPlot.Tag == null)
                        return HierachyDisplayStyle.Hidden;
                    else
                        return (HierachyDisplayStyle)this.toolStripDropDownButtonOverviewHierarchyShowPlot.Tag;
                }
                catch { return HierachyDisplayStyle.Hidden; }
            }
        }

        private bool ShowSamplingPlots
        {
            get
            {
                if (this.DisplayStyleSamplingPlots == HierachyDisplayStyle.Hidden) return false;
                else return true;
                //if (this.toolStripDropDownButtonOverviewHierarchyShowPlot.Tag == null) return true;
                //if (this.toolStripDropDownButtonOverviewHierarchyShowPlot.Tag.ToString() != HierachyDisplayStyle.Hidden.ToString()) return true;
                //else return false;
            }
        }

        private bool ShowSamplingPlotsHierarchy
        {
            get
            {
                if (this.DisplayStyleSamplingPlots == HierachyDisplayStyle.Hierarchy) return true;
                else return false;
                //if (this.toolStripDropDownButtonOverviewHierarchyShowPlot.Tag == null) return false;
                //if (this.toolStripDropDownButtonOverviewHierarchyShowPlot.Tag.ToString() == HierachyDisplayStyle.Hierarchy.ToString())
                //    return true;
                //else return false;
            }
        }

        private HierachyDisplayStyle DisplayStyleEventSeries
        {
            get
            {
                try
                {
                    if (this.toolStripDropDownButtonOverviewHierarchyShowSeries.Tag == null)
                        return HierachyDisplayStyle.Hidden;
                    else
                        return (HierachyDisplayStyle)this.toolStripDropDownButtonOverviewHierarchyShowSeries.Tag;
                }
                catch { return HierachyDisplayStyle.Hidden; }
            }
        }

        private bool ShowEventSeriesHierarchy
        {
            get
            {
                if (DisplayStyleEventSeries == HierachyDisplayStyle.Hierarchy) return true;
                else return false;
            }
        }

        private bool ShowEventSeries
        {
            get
            {
                if (this.DisplayStyleEventSeries == HierachyDisplayStyle.Hidden) return false;
                else return true;
            }
        }

        private bool ShowEventLocalisation
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyShowEventLocalisation.Tag == null) return true;
                else
                {
                    if (this.toolStripButtonOverviewHierarchyShowEventLocalisation.Tag.ToString() == "Show") return true;
                    else return false;
                }
            }
        }

        private bool ShowUnit
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyShowUnits.Tag == null) return true;
                else
                {
                    if (this.toolStripButtonOverviewHierarchyShowUnits.Tag.ToString() == "Show") return true;
                    else return false;
                }
            }
        }

        private bool ShowIdentification
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyShowIdentifications.Tag == null) return true;
                else
                {
                    if (this.toolStripButtonOverviewHierarchyShowIdentifications.Tag.ToString() == "Show") return true;
                    else return false;
                }
            }
        }

        private bool ShowGeoAnalysis
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyShowGeoAnalysis.Tag == null) return true;
                else
                {
                    if (this.toolStripButtonOverviewHierarchyShowGeoAnalysis.Tag.ToString() == "Show") return true;
                    else return false;
                }
            }
        }

        private bool ShowTransaction
        {
            get
            {
                if (!(bool)DiversityCollection.FormCollectionSpecimen.HasTransactionAccess)
                    return false;
                else
                {
                    if (this.toolStripButtonOverviewHierarchyDisplayShowTransactions.Tag == null) return true;
                    else
                    {
                        if (this.toolStripButtonOverviewHierarchyDisplayShowTransactions.Tag.ToString() == "Show") return true;
                        else return false;
                    }
                }
            }
        }

        private bool ShowLoan
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyDisplayShowOnLoan.Tag == null) return true;
                else
                {
                    if (this.toolStripButtonOverviewHierarchyDisplayShowOnLoan.Tag.ToString() == "Show") return true;
                    else return false;
                }
            }
        }

        private bool ShowAnalysis
        {
            get
            {
                if (this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Tag == null) return true;
                if (this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Tag.ToString() != AnalysisDisplayStyle.Hidden.ToString()) return true;
                else return false;
                //if (this.toolStripButtonOverviewHierarchyShowAnalysis.Tag == null) return true;
                //else
                //{
                //    if (this.toolStripButtonOverviewHierarchyShowAnalysis.Tag.ToString() == "Show" ||
                //        this.toolStripButtonOverviewHierarchyShowAnalysis.Tag.ToString() == "Hierarchy") return true;
                //    else return false;
                //}
            }
        }

        //private AnalysisDisplayStyle ShowAnalysisAs
        //{
        //    get
        //    {
        //        AnalysisDisplayStyle Style = AnalysisDisplayStyle.NoHierarchy;
        //        return Style;
        //    }
        //}

        private bool ShowAnalysisAsHierarchy
        {
            get
            {
                if (this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Tag == null) return false;
                if (this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Tag.ToString() == AnalysisDisplayStyle.HierarchyDate.ToString()
                    || this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Tag.ToString() == AnalysisDisplayStyle.HierarchyDateType.ToString()
                    || this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Tag.ToString() == AnalysisDisplayStyle.HierarchyType.ToString()
                    || this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Tag.ToString() == AnalysisDisplayStyle.HierarchyOfAnalysis.ToString()
                    || this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Tag.ToString() == AnalysisDisplayStyle.HierarchyTypeDate.ToString())
                    return true;
                else return false;
                //if (this.toolStripButtonOverviewHierarchyShowAnalysis.Tag == null) return false;
                //else
                //{
                //    if (this.toolStripButtonOverviewHierarchyShowAnalysis.Tag.ToString() == "Hierarchy") return true;
                //    else return false;
                //}
            }
        }

        private bool ShowUnitsInPart
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyDisplayShowUnitsInPart.Tag == null) return true;
                else
                {
                    if (this.toolStripButtonOverviewHierarchyDisplayShowUnitsInPart.Tag.ToString() == "Show") return true;
                    else return false;
                }
            }
        }

        private bool ShowAnalysisOfPart
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyDisplayShowAnalysisOfPart.Tag == null) return true;
                else
                {
                    if (this.toolStripButtonOverviewHierarchyDisplayShowAnalysisOfPart.Tag.ToString() == "Show") return true;
                    else return false;
                }
            }
        }

        private bool ShowPartReference
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyDisplayShowReference.Tag == null) return true;
                else
                {
                    if (this.toolStripButtonOverviewHierarchyDisplayShowReference.Tag.ToString() == "Show") return true;
                    else return false;
                }
            }
        }

        private bool ShowPartID
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyDisplayShowID.Tag == null) return true;
                else
                {
                    if (this.toolStripButtonOverviewHierarchyDisplayShowID.Tag.ToString() == "Show") return true;
                    else return false;
                }
            }
        }

        private bool ShowProcessing
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyDisplayShowProcessing.Tag == null) return true;
                else
                {
                    if (this.toolStripButtonOverviewHierarchyDisplayShowProcessing.Tag.ToString() == "Show") return true;
                    else return false;
                }
            }
        }

        private bool ShowEventProperty
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyShowEventProperty.Tag == null) return true;
                else
                {
                    if (this.toolStripButtonOverviewHierarchyShowEventProperty.Tag.ToString() == "Show") return true;
                    else return false;
                }
            }
        }

        private bool ShowRelation
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyShowRelations.Tag == null) return true;
                else
                {
                    if (this.toolStripButtonOverviewHierarchyShowRelations.Tag.ToString() == "Show") return true;
                    else return false;
                }
            }
        }

        private bool ShowRelationDetails
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyShowRelationDetails.Tag == null) return true;
                else
                {
                    if (this.toolStripButtonOverviewHierarchyShowRelationDetails.Tag.ToString() == "Show") return true;
                    else return false;
                }
            }
        }

        private bool ShowCollector
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyShowAgents.Tag == null) return true;
                else
                {
                    if (this.toolStripButtonOverviewHierarchyShowAgents.Tag.ToString() == "Show") return true;
                    else return false;
                }
            }
        }

        private bool ShowCollection
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyDisplayCollection.Tag.ToString() == "Show") return true;
                else return false;
            }
        }

        private bool ShowSubCollectionContent
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyDisplayShowSubcollectionContent.Tag.ToString() == "Show") return true;
                else return false;
            }
        }

        private bool ShowIdentifier
        {
            get
            {
                return true;
            }
        }

        private bool ShowAnnotation
        {
            get
            {
                if (this.toolStripButtonOverviewHierarchyShowAnnotation.Tag == "Show") return true;
                else return false;

                //if (this.toolStripButtonOverviewHierarchyShowIdentifications.Tag == null) return true;
                //else
                //{
                //    if (this.toolStripButtonOverviewHierarchyShowIdentifications.Tag.ToString() == "Show") return true;
                //    else return false;
                //}
                return false;
            }
        }

        #endregion

        #region ToolStrips

        #region Display - showing or hiding the nodes in the trees

        private void toolStripButtonOverviewHierarchyShowAnnotation_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyShowAnnotation,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImageTableOrField.Annotation],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImageTableOrField.AnnotationAdd]);
            if (!this.ShowAnnotation)
            {
                this.hideOverviewHierarchyNodes("Annotation");
                this.hideOverviewHierarchyStorageNodes("Annotation");
            }
            else
                this.addOverviewHierarchyAnnotations(AnnotationTarget.All);
        }

        #region for Units

        private void toolStripButtonOverviewHierarchyShowEventSeriesHierarchy_Click(object sender, EventArgs e)
        {
            // durch DropDown ersetzt

            //this.setToolStripButtonOverviewHierarchyState(
            //    this.toolStripButtonOverviewHierarchyShowEventSeriesHierarchy,
            //    DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeriesHierarchy],
            //    DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeriesHierarchyGrey]);
            //if (this.ShowEventSeries) this.setToolStripButtonOverviewHierarchyState(
            //     this.toolStripButtonOverviewHierarchyShowEventSeries,
            //     DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeries],
            //     DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeriesGrey]);
            //if (this.DisplayStyleSamplingPlots != HierachyDisplayStyle.Hidden)
            //    this.toolStripMenuItemOverviewHierarchyShowPlotNone_Click(this.toolStripMenuItemOverviewHierarchyShowPlotNone, null);
            //this.buildOverviewHierarchyUnits();
        }

        private void toolStripButtonOverviewHierarchyShowEventSeries_Click(object sender, EventArgs e)
        {
            // durch DropDown ersetzt

            //this.setToolStripButtonOverviewHierarchyState(
            //    this.toolStripButtonOverviewHierarchyShowEventSeries,
            //    DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeries],
            //    DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeriesGrey]);
            //if (this.ShowEventSeriesHierarchy) this.setToolStripButtonOverviewHierarchyState(
            //     this.toolStripButtonOverviewHierarchyShowEventSeriesHierarchy,
            //     DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeriesHierarchy],
            //     DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeriesHierarchyGrey]);
            //if (this.DisplayStyleSamplingPlots != HierachyDisplayStyle.Hidden)
            //    this.toolStripMenuItemOverviewHierarchyShowPlotNone_Click(this.toolStripMenuItemOverviewHierarchyShowPlotNone, null);
            //this.buildOverviewHierarchyUnits();
        }

        private void toolStripButtonOverviewHierarchyShowEventLocalisation_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyShowEventLocalisation,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.Localisation],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.LocalisationGrey]);
            if (!this.ShowEventLocalisation) this.hideOverviewHierarchyEventLocalisation();
            else
                this.addOverviewHierarchyEventLocalisation();
        }

        private void toolStripButtonOverviewHierarchyShowEventProperty_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyShowEventProperty,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventProperty],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventPropertyGrey]);
            if (!this.ShowEventProperty) this.hideOverviewHierarchyEventProperty();
            else
                this.addOverviewHierarchyEventProperty();
        }

        private void toolStripButtonOverviewHierarchyShowUnits_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyShowUnits,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImageTaxon.Plant],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImageTaxon.PlantGrey]);
            if (!this.ShowUnit) this.hideOverviewHierarchyUnits();
            else
                this.addOverviewHierarchyUnits();
        }

        private void toolStripButtonOverviewHierarchyShowIdentifications_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyShowIdentifications,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.Identification],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.IdentificationGrey]);
            if (!this.ShowIdentification) this.hideOverviewHierarchyIdentifications();
            else
                this.addOverviewHierarchyIdentifications(true);
        }

        private void toolStripButtonOverviewHierarchyShowAnalysis_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyShowAnalysis,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.Analysis],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.AnalysisGrey],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.AnalysisHierarchy]);
            if (!this.ShowAnalysis) this.hideOverviewHierarchyAnalysis();
            else
                this.addOverviewHierarchyAnalysis(true);
        }

        private void toolStripButtonOverviewHierarchyShowGeoAnalysis_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyShowGeoAnalysis,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.GeoAnalysis],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.GeoAnalysisGrey]);
            if (!this.ShowGeoAnalysis) this.hideOverviewHierarchyGeoAnalysis();
            else
                this.addOverviewHierarchyGeoAnalysis(true);
        }

        private void toolStripButtonOverviewHierarchyShowAgents_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyShowAgents,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.Agent],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.AgentGrey]);
            if (!this.ShowCollector) this.hideOverviewHierarchyAgent();
            else
                this.addOverviewHierarchyAgents();
        }

        private void toolStripButtonOverviewHierarchyShowRelations_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyShowRelations,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.Relation],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.RelationGrey]);
            if (!this.ShowRelation) this.hideOverviewHierarchyRelations();
            else
                this.addOverviewHierarchyRelations();
        }

        private void toolStripButtonOverviewHierarchyShowRelationDetails_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyShowRelationDetails,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.RelationInversGrey],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.RelationInversGrey]);
            if (this.ShowRelation)
            {
                this.hideOverviewHierarchyRelations();
                this.addOverviewHierarchyRelations();
                this.treeViewOverviewHierarchy.ExpandAll();
            }
        }

        private void toolStripButtonOverviewHierarchyShowID_Click(object sender, EventArgs e)
        {

        }

        private void toolStripButtonOverviewHierarchyShowReference_Click(object sender, EventArgs e)
        {

        }

        private AnalysisDisplayStyle DisplayStyleAnalysis
        {
            get
            {
                try
                {
                    if (this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Tag == null)
                        return AnalysisDisplayStyle.NoHierarchy;
                    else
                        return (AnalysisDisplayStyle)this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Tag;
                }
                catch { return AnalysisDisplayStyle.NoHierarchy; }
            }
        }

        #endregion

        #region for Parts

        private void toolStripButtonOverviewHierarchyDisplayShowUnits_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyDisplayShowUnitsInPart,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImageTaxon.Plant],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImageTaxon.PlantGrey]);
            if (!this.ShowUnitsInPart) this.hideOverviewHierarchyUnitsInPart();
            else
                this.addOverviewHierarchyUnitsInPart();
        }

        private void toolStripButtonOverviewHierarchyDisplayShowAnalysisOfPart_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyDisplayShowAnalysisOfPart,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.Analysis],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.AnalysisGrey]);
            if (!this.ShowAnalysisOfPart) this.hideOverviewHierarchyAnalysisOfPart();
            else
                this.addOverviewHierarchyAnalysisOfPart(true);
        }


        private void toolStripButtonOverviewHierarchyDisplayShowProcessing_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyDisplayShowProcessing,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.Processing],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.ProcessingGrey]);
            if (!this.ShowProcessing) this.hideOverviewHierarchyProcessing();
            else
                this.addOverviewHierarchyProcessing();
        }

        private void toolStripButtonOverviewHierarchyDisplayShowTransactions_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyDisplayShowTransactions,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.Transaction],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.TransactionGrey]);
            if (!this.ShowTransaction) this.hideOverviewHierarchyTransactions();
            else
                this.addOverviewHierarchyTransaction();
        }

        private void toolStripButtonOverviewHierarchyDisplayShowOnLoan_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyDisplayShowOnLoan,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.Loan],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.LoanGrey]);
            //if (!this.ShowLoan) this.hideOverviewHierarchyLoans();
            //else
            //    this.addOverviewHierarchyLoan();
        }

        private void toolStripButtonOverviewHierarchyDisplayCollection_Click(object sender, EventArgs e)
        {
            if (!this.ShowCollection)
            {
                this.setToolStripButtonOverviewHierarchyState(
                    this.toolStripButtonOverviewHierarchyDisplaySpecimen,
                    DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.Specimen],
                    DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.SpecimenGrey]);
                this.setToolStripButtonOverviewHierarchyState(
                    this.toolStripButtonOverviewHierarchyDisplayCollection,
                    DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.Collection],
                    DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.CollectionGrey]);
                this.buildOverviewHierarchyParts();
            }
            this.toolStripButtonOverviewHierarchyDisplayShowSubcollectionContent.Enabled = this.ShowCollection;
        }

        private void toolStripButtonOverviewHierarchyDisplayShowSubcollectionContent_Click(object sender, EventArgs e)
        {
            this.setToolStripButtonOverviewHierarchyState(
                this.toolStripButtonOverviewHierarchyDisplayShowSubcollectionContent,
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImageTableOrField.Subcollection],
                DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImageTableOrField.SubcollectionGray]);
            //if (!this.ShowSubCollectionContent)
            //{
            this.buildOverviewHierarchyParts();
            //}
        }

        private void toolStripButtonOverviewHierarchyDisplaySpecimen_Click(object sender, EventArgs e)
        {
            if (this.ShowCollection)
            {
                this.setToolStripButtonOverviewHierarchyState(
                    this.toolStripButtonOverviewHierarchyDisplaySpecimen,
                    DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.Specimen],
                    DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.SpecimenGrey]);
                this.setToolStripButtonOverviewHierarchyState(
                    this.toolStripButtonOverviewHierarchyDisplayCollection,
                    DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.Collection],
                    DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.CollectionGrey]);
                this.buildOverviewHierarchyParts();
            }
            this.toolStripButtonOverviewHierarchyDisplayShowSubcollectionContent.Enabled = this.ShowCollection;
        }

        private void toolStripButtonOverviewHierarchyDisplayShowReference_Click(object sender, EventArgs e)
        {
            //this.setToolStripButtonOverviewHierarchyState(
            //    this.toolStripButtonOverviewHierarchyDisplayShowReference,
            //    DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImageTableOrField.Reference],
            //    DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImageTableOrField.ReferenceGrey]);
            //if (!this.ShowPartReference) this.hideOverviewHierarchyProcessing();
            //else
            //    this.addOverviewHierarchyProcessing();
        }

        private void toolStripButtonOverviewHierarchyDisplayShowID_Click(object sender, EventArgs e)
        {

        }

        #endregion

        #endregion

        #region Setting the Visibility of the toolStripButtons for editing

        #region Unit tree

        private void setToolStripOverviewHierarchyEditVisibility(string Table)
        {
            try
            {
                this.toolStripButtonnOverviewHierarchyNewSpecimen.Visible = false;
                this.toolStripButtonOverviewHierarchyAssignEvent.Visible = false;
                this.toolStripButtonOverviewHierarchyAssignEventSeries.Visible = false;
                this.toolStripButtonOverviewHierarchyNewAgent.Visible = false;
                this.toolStripButtonOverviewHierarchyAgentDown.Visible = false;
                this.toolStripButtonOverviewHierarchyAgentUp.Visible = false;
                this.toolStripButtonOverviewHierarchyNewConfirmation.Visible = false;
                this.toolStripButtonOverviewHierarchyIdentificationToTop.Visible = false;
                this.toolStripButtonOverviewHierarchyIdentificationToBase.Visible = false;
                this.toolStripButtonOverviewHierarchyNewEvent.Visible = false;
                this.toolStripButtonOverviewHierarchyNewEventSeries.Visible = false;
                this.toolStripButtonOverviewHierarchyNewIdentAtBase.Visible = false;
                this.toolStripButtonOverviewHierarchyNewIdentification.Visible = false;
                this.toolStripButtonOverviewHierarchyNewRelation.Visible = false;
                this.toolStripButtonOverviewHierarchyNewRelationExtern.Visible = false;
                this.toolStripButtonOverviewHierarchyNewReference.Visible = false;
                this.toolStripButtonOverviewHierarchyFind.Visible = false;

                this.toolStripButtonOverviewHierarchyTaxonList.Visible = false;
                this.toolStripButtonOverviewHierarchySamplingPlot.Visible = false;
                this.toolStripButtonOverviewHierarchyTaxonEdit.Visible = false;

                this.toolStripDropDownButtonOverviewHierarchyNewUnit.Visible = false;
                this.toolStripDropDownButtonOverviewHierarchyNewEventLocalisation.Visible = false;
                this.toolStripDropDownButtonOverviewHierarchyNewEventProperty.Visible = false;
                this.toolStripDropDownButtonOverviewHierarchyNewAnalysis.Visible = false;

                this.toolStripButtonOverviewHierarchyPrintSpecimen.Visible = false;
                this.toolStripSeparatorOverviewHierarchyPrintSpecimen.Visible = false;
                this.toolStripButtonOverviewHierarchyNewUnitGeoObject.Visible = false;

                this.toolStripButtonOverviewHierarchyNewID.Visible = false;
                this.toolStripButtonOverviewHierarchyNewRegulation.Visible = false;

                this.toolStripButtonpOverviewHierarchyAnnotationEdit.Visible = false;
                this.toolStripButtonpOverviewHierarchyAnnotationAdd.Visible = false;


                if (Table.Length > 0)
                    this.toolStripButtonLabelMulti.Visible = false;

                bool CanDeleteFromTable = this.FormFunctions.getObjectPermissions(Table, "DELETE");
                bool CanUpdateTable = this.FormFunctions.getObjectPermissions(Table, "UPDATE");
                bool CanInsertTable = this.FormFunctions.getObjectPermissions(Table, "INSERT");
                this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;

                switch (Table)
                {
                    case "CollectionEventSeries":
                        this.toolStripButtonOverviewHierarchyNewEventSeries.Visible = CanInsertTable;
                        this.toolStripButtonOverviewHierarchyAssignEventSeries.Visible = true;
                        this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
                        this.toolStripButtonOverviewHierarchyTaxonList.Visible = true;
                        this.toolStripButtonOverviewHierarchyTaxonEdit.Visible = true;
                        break;
                    case "SamplingPlot":
                        this.toolStripButtonOverviewHierarchyTaxonList.Visible = true;
                        this.toolStripButtonOverviewHierarchyTaxonEdit.Visible = true;
                        this.toolStripButtonOverviewHierarchySamplingPlot.Visible = true;
                        try
                        {
                            System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                            string URI = R[0].ToString();
                            this.toolStripButtonOverviewHierarchySamplingPlot.Tag = URI;
                        }
                        catch
                        {
                            this.toolStripButtonOverviewHierarchySamplingPlot.Tag = null;
                        }
                        break;
                    case "CollectionEvent":
                        if (this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"].Equals(System.DBNull.Value))
                        {
                            this.toolStripButtonOverviewHierarchyNewEventSeries.Visible = CanInsertTable;
                        }
                        else
                        {
                            this.toolStripButtonOverviewHierarchyNewEventSeries.Visible = false;
                        }
                        this.toolStripButtonOverviewHierarchyAssignEventSeries.Visible = true;
                        this.toolStripDropDownButtonOverviewHierarchyNewEventLocalisation.Visible = this.FormFunctions.getObjectPermissions("CollectionEventLocalisation", "INSERT");
                        this.toolStripDropDownButtonOverviewHierarchyNewEventProperty.Visible = this.FormFunctions.getObjectPermissions("CollectionEventProperty", "INSERT");
                        this.toolStripButtonnOverviewHierarchyNewSpecimen.Visible = this.FormFunctions.getObjectPermissions("CollectionSpecimen", "INSERT");
                        // Inclusion of delete button for events
                        this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
//#if DEBUG
//#else
//                        if (this.treeViewOverviewHierarchy.SelectedNode.Nodes.Count == 0)
//                            this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
//                        else
//                            this.toolStripButtonOverviewHierarchyDelete.Visible = false;
//#endif
                        this.toolStripButtonOverviewHierarchyTaxonList.Visible = true;
                        this.toolStripButtonOverviewHierarchyTaxonEdit.Visible = true;
                        this.toolStripButtonOverviewHierarchyNewRegulation.Visible = this.FormFunctions.getObjectPermissions("CollectionEventRegulation", "INSERT");;
                        break;
                    case "CollectionEventList":
                        if (this.treeViewOverviewHierarchy.SelectedNode.Nodes.Count == 0)
                            this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
                        else
                            this.toolStripButtonOverviewHierarchyDelete.Visible = false;
                        this.toolStripButtonOverviewHierarchyTaxonList.Visible = true;
                        this.toolStripButtonOverviewHierarchyTaxonEdit.Visible = true;
                        break;
                    case "CollectionEventLocalisation":
                        this.toolStripDropDownButtonOverviewHierarchyNewEventLocalisation.Visible = CanInsertTable;
                        this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
                        break;
                    case "CollectionEventProperty":
                        this.toolStripDropDownButtonOverviewHierarchyNewEventProperty.Visible = CanInsertTable;
                        this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
                        this.setLocalListForScientificTerm();
                        break;
                    case "CollectionEventRegulation":
                        // TODO Regulation - wieder einbauen wenn D. Neumann getestet hat
                        //this.toolStripButtonOverviewHierarchyDelete.Visible = false;// CanDeleteFromTable;
                        this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
#if NAGOYA_TEST
                        this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
#endif
                        break;
                    case "CollectionSpecimenList":
                    case "IdentificationUnitList":
                        this.toolStripButtonOverviewHierarchyFind.Visible = true;
                        break;
                    case "CollectionSpecimen":
                        if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].Equals(System.DBNull.Value))
                        {
                            this.toolStripButtonOverviewHierarchyNewEvent.Visible = CanUpdateTable;
                        }
                        this.toolStripButtonOverviewHierarchyAssignEvent.Visible = CanUpdateTable;

                        this.toolStripButtonOverviewHierarchyNewRelationExtern.Visible = this.FormFunctions.getObjectPermissions("CollectionSpecimenRelation", "INSERT");
                        this.toolStripButtonOverviewHierarchyNewRelation.Visible = this.FormFunctions.getObjectPermissions("CollectionSpecimenRelation", "INSERT");
                        this.toolStripButtonOverviewHierarchyNewReference.Visible = this.FormFunctions.getObjectPermissions("CollectionSpecimenReference", "INSERT");
                        this.toolStripButtonOverviewHierarchyNewAgent.Visible = this.FormFunctions.getObjectPermissions("CollectionAgent", "INSERT");
                        this.toolStripDropDownButtonOverviewHierarchyNewUnit.Visible = this.FormFunctions.getObjectPermissions("IdentificationUnit", "INSERT");
                        this.toolStripButtonOverviewHierarchyDelete.Visible = false;

                        this.toolStripButtonLabelPreview.Visible = true;

                        this.toolStripButtonLabelMulti.Visible = true;
                        //this.toolStripButtonLabelMulti.Visible = false;

                        this.toolStripButtonOverviewHierarchyPrintSpecimen.Visible = true;
                        this.toolStripSeparatorOverviewHierarchyPrintSpecimen.Visible = true;
                        this.checkBoxPrintRestrictToCollection.Visible = false;
                        this.checkBoxPrintRestrictToMaterial.Visible = false;
                        this.pictureBoxPrintRestrictToMaterial.Visible = false;
                        this.tableLayoutPanelLabel.Height = (int)(46 * DiversityWorkbench.FormFunctions.DisplayZoomFactor);
                        //this.checkBoxLabelRestrictToCollection.Visible = false;
                        //this.checkBoxLabelRestrictToMaterial.Visible = false;
                        this.toolStripButtonOverviewHierarchyTaxonList.Visible = true;
                        this.toolStripButtonOverviewHierarchyTaxonEdit.Visible = true;
                        break;
                    case "Identification":
                        this.toolStripButtonOverviewHierarchyNewConfirmation.Visible = CanInsertTable;
                        this.toolStripButtonOverviewHierarchyIdentificationToBase.Visible = CanUpdateTable;
                        this.toolStripButtonOverviewHierarchyIdentificationToTop.Visible = CanUpdateTable;
                        this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
                        this.MoveUnitBindingIfWrongDataset();
                        break;
                    case "IdentificationUnit":
                        this.toolStripDropDownButtonOverviewHierarchyNewUnit.Visible = CanInsertTable;
                        bool IsPartOf = false;
                        try
                        {
                            System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                            if (!R["RelatedUnitID"].Equals(System.DBNull.Value) && R["RelationType"].ToString() == "Part of")
                                IsPartOf = true;
                        }
                        catch { }
                        this.toolStripButtonOverviewHierarchyNewIdentification.Visible = !IsPartOf;
                        this.toolStripButtonOverviewHierarchyNewIdentAtBase.Visible = !IsPartOf;
                        this.toolStripButtonOverviewHierarchyNewUnitGeoObject.Visible = CanInsertTable;
                        this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
                        this.toolStripButtonOverviewHierarchyNewRelation.Visible = this.FormFunctions.getObjectPermissions("CollectionSpecimenRelation", "INSERT");
                        this.toolStripButtonOverviewHierarchyNewRelationExtern.Visible = this.FormFunctions.getObjectPermissions("CollectionSpecimenRelation", "INSERT");
                        this.toolStripButtonOverviewHierarchyNewReference.Visible = this.FormFunctions.getObjectPermissions("CollectionSpecimenReference", "INSERT");
                        this.prepareToolStripDropDownButtonsAnalysis(this.treeViewOverviewHierarchy.SelectedNode);
                        break;
                    case "IdentificationUnitAnalysis":
                        this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
                        //this.toolStripButtonOverviewHierarchyNewAnalysis.Visible = true;
                        this.prepareToolStripDropDownButtonsAnalysis(this.treeViewOverviewHierarchy.SelectedNode);
                        this.setAnalysisPartList();
                        this.MoveUnitBindingIfWrongDataset();
                        break;
                    case "IdentificationUnitGeoAnalysis":
                        this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
                        this.toolStripButtonOverviewHierarchyNewUnitGeoObject.Visible = CanInsertTable;
                        this.MoveUnitBindingIfWrongDataset();
                        break;
                    case "CollectionAgent":
                        this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
                        this.toolStripButtonOverviewHierarchyAgentDown.Visible = CanUpdateTable;
                        this.toolStripButtonOverviewHierarchyAgentUp.Visible = CanUpdateTable;
                        this.toolStripButtonOverviewHierarchyNewAgent.Visible = CanInsertTable;
                        this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
                        break;
                    case "CollectionSpecimenReference":
                        this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
                        //this.toolStripButtonOverviewHierarchyNewReference.Visible = CanInsertTable;
                        //this.toolStripButtonOverviewHierarchyPartNewReference.Visible = CanInsertTable;
                        break;
                    case "CollectionSpecimenRelation":
                        this.toolStripButtonOverviewHierarchyNewRelationExtern.Visible = CanInsertTable;
                        this.toolStripButtonOverviewHierarchyNewRelation.Visible = CanInsertTable;
                        this.toolStripButtonOverviewHierarchyDelete.Visible = CanDeleteFromTable;
                        System.Data.DataRowView rv = (System.Data.DataRowView)this.collectionSpecimenRelationBindingSource.Current;
                        if (rv["IsInternalRelationCache"].ToString().ToUpper() == "TRUE")
                            this.toolStripButtonOverviewHierarchyFind.Visible = true;
                        else
                            this.toolStripButtonOverviewHierarchyFind.Visible = false;
                        break;
                    case "CollectionSpecimenRelationInvers":
                        this.toolStripButtonOverviewHierarchyNewRelationExtern.Visible = CanInsertTable;
                        this.toolStripButtonOverviewHierarchyNewRelation.Visible = CanInsertTable;
                        this.toolStripButtonOverviewHierarchyDelete.Visible = false;
                        this.toolStripButtonOverviewHierarchyFind.Visible = true;
                        break;
                    default:
                        this.toolStripButtonOverviewHierarchyDelete.Visible = false;
                        break;
                }
                this.setContextMenuTreeUnit();


                this.toolStripButtonOverviewHierarchyNewID.Visible = false;
                //this.toolStripButtonOverviewHierarchyNewRegulation.Visible = false;

                this.toolStripButtonpOverviewHierarchyAnnotationEdit.Visible = false;
                this.toolStripButtonpOverviewHierarchyAnnotationAdd.Visible = false;


            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            } 
            
            if (this.treeViewOverviewHierarchy.SelectedNode != null &&
                this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
            {
                try
                {
                    System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                    this.setToolStripOverviewHierarchyAnnotationVisibility(R);
                }
                catch (System.Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                } 
            }
        }

        private void setToolStripOverviewHierarchyAnnotationVisibility(DataRow R)
        {
            if (R != null)
            {
                System.Data.DataRow[] RR;
                bool ShowNewID = this.FormFunctions.getObjectPermissions("ExternalIdentifier", "DELETE");
                //bool ShowNewRegulation = this.FormFunctions.getObjectPermissions("Regulation", "SELECT");
                switch (R.Table.TableName)
                {
                    //case "CollectionEventSeries":
                    //    RR = this.dataSetCollectionSpecimen.Annotation.Select("ReferencedID = " + R["SeriesID"].ToString() + " AND ReferencedTable = '" + R.Table.TableName + "'");
                    //    if (RR.Length > 0)
                    //        this.toolStripButtonpOverviewHierarchyAnnotationEdit.Visible = true;
                    //    else
                    //        this.toolStripButtonpOverviewHierarchyAnnotationAdd.Visible = true;
                    //    break;
                    case "CollectionEvent":
                        RR = this.dataSetCollectionSpecimen.Annotation.Select("ReferencedID = " + R["CollectionEventID"].ToString() + " AND ReferencedTable = '" + R.Table.TableName + "'");
                        if (RR.Length > 0)
                            this.toolStripButtonpOverviewHierarchyAnnotationEdit.Visible = true;
                        else
                            this.toolStripButtonpOverviewHierarchyAnnotationAdd.Visible = true;
                        this.toolStripButtonOverviewHierarchyNewID.Visible = ShowNewID;
                        // TODO Regulation - wieder einbauen wenn D. Neumann getestet hat
                        //this.toolStripButtonOverviewHierarchyNewRegulation.Visible = false;// ShowNewRegulation;
//#if NAGOYA_TEST
//                        this.toolStripButtonOverviewHierarchyNewRegulation.Visible = ShowNewRegulation;
//#endif
                        break;
                    case "CollectionSpecimen":
                        RR = this.dataSetCollectionSpecimen.Annotation.Select("ReferencedID = " + this.ID.ToString() + " AND ReferencedTable = '" + R.Table.TableName + "'");
                        if (RR.Length > 0)
                            this.toolStripButtonpOverviewHierarchyAnnotationEdit.Visible = true;
                        else
                            this.toolStripButtonpOverviewHierarchyAnnotationAdd.Visible = true;
                        this.toolStripButtonOverviewHierarchyNewID.Visible = ShowNewID;
                        this.toolStripButtonOverviewHierarchyNewRegulation.Visible = false;
                        break;
                    case "CollectionSpecimenPart":
                        RR = this.dataSetCollectionSpecimen.Annotation.Select("ReferencedID = " + R["SpecimenPartID"].ToString() + " AND ReferencedTable = '" + R.Table.TableName + "'");
                        if (RR.Length > 0)
                            this.toolStripButtonOverviewHierarchyPartAnnotationEdit.Visible = true;
                        else
                            this.toolStripButtonOverviewHierarchyPartAnnotationAdd.Visible = true;
                        this.toolStripButtonOverviewHierarchyPartNewID.Visible = ShowNewID;
                        // TODO Regulation - wieder einbauen wenn D. Neumann getestet hat
                        this.toolStripButtonOverviewHierarchyPartNewRegulation.Visible = false;// ShowNewRegulation;
                        this.toolStripButtonOverviewHierarchyNewPermit.Visible = false;
//#if NAGOYA_TEST
//                        this.toolStripButtonOverviewHierarchyPartNewRegulation.Visible = ShowNewRegulation;
//#endif
                        break;
                    case "IdentificationUnit":
                        RR = this.dataSetCollectionSpecimen.Annotation.Select("ReferencedID = " + R["IdentificationUnitID"].ToString() + " AND ReferencedTable = '" + R.Table.TableName + "'");
                        if (RR.Length > 0)
                            this.toolStripButtonpOverviewHierarchyAnnotationEdit.Visible = true;
                        else
                            this.toolStripButtonpOverviewHierarchyAnnotationAdd.Visible = true;
                        this.toolStripButtonOverviewHierarchyNewID.Visible = ShowNewID;
                        this.toolStripButtonOverviewHierarchyNewRegulation.Visible = false;
                        break;
                    case "CollectionSpecimenReference":
                        this.toolStripButtonOverviewHierarchyPartNewID.Visible = ShowNewID;
                        this.toolStripButtonOverviewHierarchyNewID.Visible = ShowNewID;
                        break;
                }
            }
        }

        private void setContextMenuTreeUnit()
        {
            return;
            ///TODO: integration der Hierarchie bei DropDownlisten und Aufruf der Events klappt nicht
            try
            {
                this.contextMenuStripTreeUnit.Items.Clear();
                foreach (System.Windows.Forms.ToolStripItem M in this.toolStripOverviewHierarchyEdit.Items)
                {
                    if (!M.Visible) 
                        continue;
                    string x = M.GetType().ToString();
                    if (M.GetType() == typeof(System.Windows.Forms.ToolStripMenuItem))
                    {
                        System.Windows.Forms.ToolStripMenuItem T = new ToolStripMenuItem(M.ToolTipText, M.Image);
                        this.contextMenuStripTreeUnit.Items.Add(T);
                    }
                    else if (M.GetType() == typeof(System.Windows.Forms.ToolStripButton))
                    {
                        System.Windows.Forms.ToolStripMenuItem T = new ToolStripMenuItem(M.ToolTipText, M.Image);
                        T.TextImageRelation = TextImageRelation.ImageBeforeText;
                        T.ImageScaling = ToolStripItemImageScaling.None;
                        T.Tag = M;
                        this.contextMenuStripTreeUnit.Items.Add(T);
                    }
                    else if (M.GetType() == typeof(System.Windows.Forms.ToolStripDropDownButton))
                    {
                        System.Windows.Forms.ToolStripMenuItem T = new ToolStripMenuItem(M.ToolTipText, M.Image);
                        T.ImageScaling = ToolStripItemImageScaling.None;
                        T.Tag = M;
                        //this.setContextMenuTreeEventHandler(M, T);
                        this.setContextMenuTreeUnitDropDownItems(T);
                        this.contextMenuStripTreeUnit.Items.Add(T);
                    }
                }
            }
            catch (System.Exception ex) { }
        }

        private void setContextMenuTreeUnitDropDownItems(System.Windows.Forms.ToolStripMenuItem T)
        {
            try
            {
                string Type = T.Tag.GetType().ToString();
                switch (Type)
                {
                    case "System.Windows.Forms.ToolStripDropDownButton":
                        System.Windows.Forms.ToolStripDropDownButton DD = (System.Windows.Forms.ToolStripDropDownButton)T.Tag;
                        foreach (System.Windows.Forms.ToolStripMenuItem B in DD.DropDownItems)
                        {
                            string Title = B.Text;
                            if (B.ToolTipText != null && B.ToolTipText.Length > 0) Title = B.ToolTipText;
                            System.Windows.Forms.ToolStripMenuItem C = new ToolStripMenuItem(Title, B.Image);
                            C.ImageScaling = ToolStripItemImageScaling.None;
                            C.Tag = B;
                            //C.Click +=
                            this.setContextMenuTreeUnitDropDownItems(C);
                            B.DropDownItems.Add(C);
                        }
                        break;
                    case "System.Windows.Forms.ToolStripMenuItem":
                        System.Windows.Forms.ToolStripMenuItem M = (System.Windows.Forms.ToolStripMenuItem)T.Tag;
                        foreach (System.Windows.Forms.ToolStripMenuItem B in M.DropDownItems)
                        {
                            string Title = B.Text;
                            if (B.ToolTipText != null && B.ToolTipText.Length > 0) Title = B.ToolTipText;
                            System.Windows.Forms.ToolStripMenuItem C = new ToolStripMenuItem(Title, B.Image);
                            C.ImageScaling = ToolStripItemImageScaling.None;
                            C.Tag = B;
                            //C.Click +=
                            this.setContextMenuTreeUnitDropDownItems(C);
                            B.DropDownItems.Add(C);
                        }
                        break;
                }
            }
            catch (System.Exception ex) { }
        }

        private void contextMenuStripTreeUnit_ItemClicked(object sender, ToolStripItemClickedEventArgs e)
        {
            try
            {
                System.Windows.Forms.ToolStripMenuItem T = (System.Windows.Forms.ToolStripMenuItem)e.ClickedItem;
                if (T.Tag == null)
                    return;
                string Type = T.Tag.GetType().ToString();
                switch (Type)
                {
                    case "System.Windows.Forms.ToolStripDropDownButton":
                        System.Windows.Forms.ToolStripDropDownButton M = (System.Windows.Forms.ToolStripDropDownButton)T.Tag;
                        System.Reflection.EventInfo eventInfo = M.GetType().GetEvent("Click");
                        System.Reflection.MethodInfo rm = eventInfo.GetRaiseMethod();
                        if (rm != null)
                            rm.Invoke(M, new object[] { null, null });
                        break;
                }
                //if (T.Tag.GetType() == typeof(System.Windows.Forms.ToolStripButton))
                //{
                //    System.Windows.Forms.ToolStripButton M = (System.Windows.Forms.ToolStripButton)T.Tag;
                //    //System.Reflection.MethodInfo method = M.GetType().GetMethod("Click");
                //    //Type currentType = M.GetType();
                //    //System.Reflection.FieldInfo fieldInfo = currentType.GetField("Click", System.Reflection.BindingFlags.Instance | System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.GetField);
                //    //System.Reflection.FieldInfo field = M.
                //    //System.Reflection.MethodInfo eventInvoker = DiversityWorkbench.Functions.GetEventInvoker(M, "Click");
                //    ////System.Reflection.MethodInfo eventInvoker = M.GetType().GetMethod("Click");
                //    //eventInvoker.Invoke(M, new object[] { null, null });

                //    //System.Reflection.EventInfo[] eventInfos = M.GetType().GetEvents();
                //    System.Reflection.EventInfo eventInfo = M.GetType().GetEvent("Click");
                //    //Object o = Activator.CreateInstance(Act...);
                //    System.Reflection.MethodInfo rm = eventInfo.GetRaiseMethod();
                //    if (rm != null)
                //        rm.Invoke(M, new object[] { null, null });
                //}
                //eventInfo.GetRaiseMethod().Invoke(M, new object[] { null, null });
            }
            catch (System.Exception ex) { }
        }

        private void MoveUnitBindingIfWrongDataset()
        {
            System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
            int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
            System.Data.DataRowView RU = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
            int CurrUnitID = int.Parse(RU["IdentificationUnitID"].ToString());
            if (CurrUnitID != UnitID)
            {
                int Position = 0;
                foreach (System.Data.DataRow rr in this.dataSetCollectionSpecimen.IdentificationUnit.Rows)
                {
                    if (rr["IdentificationUnitID"].ToString() == UnitID.ToString())
                        break;
                    Position++;
                }
                this.identificationUnitBindingSource.Position = Position;
            }
        }

        private void setToolStripOverviewHierarchyDisplayVisibility()
        {
            if (this.dataSetCollectionSpecimen.CollectionEvent.Rows.Count > 0)
            {
                if (this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"].Equals(System.DBNull.Value))
                {
                    //this.toolStripButtonOverviewHierarchyShowEventSeries.Visible = false;
                    //this.toolStripMenuItemOverviewHierarchyShowSeriesParents.Visible = false;
                    this.toolStripDropDownButtonOverviewHierarchyShowSeries.Visible = false;
                    if (this.DisplayStyleEventSeries != HierachyDisplayStyle.Hidden && this.dataSetCollectionEventSeries.CollectionSpecimenList.Rows.Count < 2)
                        this.toolStripDropDownButtonOverviewHierarchyShowSeries.Tag = HierachyDisplayStyle.Hidden;
                    if (this.dataSetCollectionEventSeries.CollectionSpecimenList.Rows.Count > 1)
                    {
                        // enable display of other specimen within event
                        this.toolStripDropDownButtonOverviewHierarchyShowSeries.Visible = true;
                        if (this.DisplayStyleEventSeries == HierachyDisplayStyle.Parents)
                            this.setEventSeriesDisplayMode(this.toolStripMenuItemOverviewHierarchyShowSeriesNone);
                        this.toolStripMenuItemOverviewHierarchyShowSeriesHierarchy.Visible = true;
                        this.toolStripMenuItemOverviewHierarchyShowSeriesNone.Visible = true;
                        this.toolStripMenuItemOverviewHierarchyShowSeriesParents.Visible = false;
                        //this.toolStripButtonOverviewHierarchyShowEventSeriesHierarchy.Visible = true;
                    }
                    else
                    {
                        this.toolStripMenuItemOverviewHierarchyShowSeriesHierarchy.Visible = false;
                        this.toolStripMenuItemOverviewHierarchyShowSeriesNone.Visible = false;
                        //this.toolStripButtonOverviewHierarchyShowEventSeriesHierarchy.Visible = false;
                    }
                }
                else
                {
                    //this.toolStripButtonOverviewHierarchyShowEventSeries.Visible = true;
                    //this.toolStripButtonOverviewHierarchyShowEventSeriesHierarchy.Visible = true;
                    this.toolStripDropDownButtonOverviewHierarchyShowSeries.Visible = true;
                    this.toolStripMenuItemOverviewHierarchyShowSeriesParents.Visible = true;
                    this.toolStripMenuItemOverviewHierarchyShowSeriesHierarchy.Visible = true;
                    this.toolStripMenuItemOverviewHierarchyShowSeriesNone.Visible = true;
                }
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionEventLocalisation.Select("LocalisationSystemID = 13 AND Location2 like 'http:%'");
                if (rr.Length > 0) this.toolStripDropDownButtonOverviewHierarchyShowPlot.Visible = true;
                else this.toolStripDropDownButtonOverviewHierarchyShowPlot.Visible = false;
            }
            else
            {
                //this.toolStripButtonOverviewHierarchyShowEventSeries.Visible = false;
                //this.toolStripButtonOverviewHierarchyShowEventSeriesHierarchy.Visible = false;
                this.toolStripDropDownButtonOverviewHierarchyShowSeries.Visible = false;
                if (this.DisplayStyleEventSeries != HierachyDisplayStyle.Hidden && this.dataSetCollectionEventSeries.CollectionSpecimenList.Rows.Count < 2)
                {
                    this.toolStripDropDownButtonOverviewHierarchyShowSeries.Tag = HierachyDisplayStyle.Hidden;
                    this.setEventSeriesDisplayMode(null);
                }
                this.toolStripDropDownButtonOverviewHierarchyShowPlot.Visible = false;
            }

            if (this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows.Count > 0)
                this.toolStripButtonOverviewHierarchyShowEventLocalisation.Visible = true;
            else this.toolStripButtonOverviewHierarchyShowEventLocalisation.Visible = false;
            if (this.dataSetCollectionSpecimen.CollectionEventProperty.Rows.Count > 0)
                this.toolStripButtonOverviewHierarchyShowEventProperty.Visible = true;
            else this.toolStripButtonOverviewHierarchyShowEventProperty.Visible = false;

            if (this.dataSetCollectionSpecimen.IdentificationUnit.Rows.Count > 0)
                this.toolStripButtonOverviewHierarchyShowUnits.Visible = true;
            else this.toolStripButtonOverviewHierarchyShowUnits.Visible = false;
            if (this.dataSetCollectionSpecimen.Identification.Rows.Count > 0)
                this.toolStripButtonOverviewHierarchyShowIdentifications.Visible = true;
            else this.toolStripButtonOverviewHierarchyShowIdentifications.Visible = false;

            if (this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Rows.Count > 0)
                this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Visible = true;
            else
                this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Visible = false;

            if (this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysis.Rows.Count > 0)
                this.toolStripButtonOverviewHierarchyShowGeoAnalysis.Visible = true;
            else this.toolStripButtonOverviewHierarchyShowGeoAnalysis.Visible = false;

            /// TODO: sobald benoetigt bzw. funktionell freischalten
            //if (this.dataSetCollectionSpecimen.CollectionSpecimenReference.Rows.Count > 0)
            //    this.toolStripButtonOverviewHierarchyShowReference.Visible = true;
            //else this.toolStripButtonOverviewHierarchyShowReference.Visible = false;

            if (this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows.Count > 0 ||
                this.dataSetCollectionSpecimen.CollectionSpecimenRelationInvers.Rows.Count > 0)
            {
                this.toolStripButtonOverviewHierarchyShowRelations.Visible = true;
                this.toolStripButtonOverviewHierarchyShowRelationDetails.Visible = true;
            }
            else
            {
                this.toolStripButtonOverviewHierarchyShowRelations.Visible = false;
                this.toolStripButtonOverviewHierarchyShowRelationDetails.Visible = false;
            }

            if (this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count > 0)
                this.toolStripButtonOverviewHierarchyShowAgents.Visible = true;
            else this.toolStripButtonOverviewHierarchyShowAgents.Visible = false;
        }

        #endregion

        #region Part tree

        private void setToolStripOverviewHierarchyStorageEditVisibility(string Table)
        {
            this.toolStripButtonOverviewHierarchyPrintPart.Visible = false;
            this.toolStripSeparatorOverviewHierarchyPrintPart.Visible = false;
            this.toolStripButtonOverviewHierarchyNewCollection.Visible = false;
            this.toolStripButtonOverviewHierarchyNewTransaction.Visible = false;
            this.toolStripButtonOverviewHierarchyDeletePart.Visible = false;
            this.toolStripDropDownButtonOverviewHierarchyNewPart.Visible = false;
            this.toolStripDropDownButtonOverviewHierarchyNewProcessing.Visible = false;
            this.toolStripDropDownButtonOverviewHierarchyNewAnalysisForParts.Visible = false;
            this.toolStripButtonOverviewHierarchyCopyPart.Visible = false;

            this.toolStripButtonOverviewHierarchyNewRelationPart.Visible = false;
            this.toolStripButtonOverviewHierarchyNewRelationPartExtern.Visible = false;
            this.toolStripButtonOverviewHierarchyPartNewReference.Visible = false;
            this.toolStripButtonOverviewHierarchyPartFind.Visible = false;

            this.toolStripButtonOverviewHierarchyPartNewID.Visible = false;
            this.toolStripButtonOverviewHierarchyPartNewRegulation.Visible = false;
            this.toolStripButtonOverviewHierarchyNewPermit.Visible = false;

            this.toolStripButtonOverviewHierarchyPartAnnotationEdit.Visible = false;
            this.toolStripButtonOverviewHierarchyPartAnnotationAdd.Visible = false;

            //this.toolStripButtonOverviewHierarchyPartAnnotationAdd.Visible = false;
            //this.toolStripButtonOverviewHierarchyPartAnnotationEdit.Visible = false;

            //System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.Annotation.Select("CollectionSpecimenID = " + this.ID.ToString());
            //if (RR.Length > 0)
            //    this.toolStripButtonOverviewHierarchyPartAnnotationEdit.Visible = true;
            //else
            //    this.toolStripButtonOverviewHierarchyPartAnnotationAdd.Visible = true;

            if (Table.Length > 0)
            {
                this.toolStripButtonLabelMulti.Visible = false;
                this.toolStripButtonLabelPreview.Visible = false;
            }
            bool CanDeleteFromTable = this.FormFunctions.getObjectPermissions(Table, "DELETE");
            bool CanUpdateTable = this.FormFunctions.getObjectPermissions(Table, "UPDATE");
            bool CanInsertTable = this.FormFunctions.getObjectPermissions(Table, "INSERT");
            if(Table != "ExternalIdentifier" && Table != "Annotation")
                this.toolStripButtonOverviewHierarchyDeletePart.Visible = CanDeleteFromTable;
            switch (Table)
            {
                case "Collection":
                    this.toolStripDropDownButtonOverviewHierarchyNewPart.Visible = true;
                    //this.toolStripButtonOverviewHierarchyNewCollection.Visible = true;
                    this.toolStripButtonOverviewHierarchyDeletePart.Visible = false;
                    break;
                case "CollectionSpecimen":
                    this.toolStripDropDownButtonOverviewHierarchyNewPart.Visible = this.FormFunctions.getObjectPermissions("CollectionSpecimenPart", "INSERT");
                    this.toolStripButtonOverviewHierarchyDeletePart.Visible = false;
                    //this.prepareToolStripDropDownButtonsProcessing(this.treeViewOverviewHierarchyStorage.SelectedNode);
                    this.toolStripButtonLabelMulti.Visible = true;
                    this.toolStripButtonLabelPreview.Visible = true;
                    //this.toolStripButtonLabelMulti.Visible = false;
                    //this.toolStripButtonLabelPreview.Visible = false;
                    break;
                case "CollectionSpecimenPart":
                    this.toolStripButtonOverviewHierarchyPrintPart.Visible = true;
                    this.toolStripSeparatorOverviewHierarchyPrintPart.Visible = true;
                    this.toolStripDropDownButtonOverviewHierarchyNewPart.Visible = CanInsertTable;
                    this.toolStripButtonOverviewHierarchyDeletePart.Visible = CanDeleteFromTable;
                    this.toolStripButtonOverviewHierarchyCopyPart.Visible = CanInsertTable;
                    this.toolStripButtonOverviewHierarchyNewRelationPart.Visible =  this.FormFunctions.getObjectPermissions("CollectionSpecimenRelation", "INSERT");
                    this.toolStripButtonOverviewHierarchyNewRelationPartExtern.Visible =  this.FormFunctions.getObjectPermissions("CollectionSpecimenRelation", "INSERT");
                    this.toolStripButtonOverviewHierarchyPartNewReference.Visible = this.FormFunctions.getObjectPermissions("CollectionSpecimenReference", "INSERT");
                    this.toolStripButtonOverviewHierarchyPartNewID.Visible = this.FormFunctions.getObjectPermissions("ExternalIdentifier", "INSERT");
                    // TODO Regulation - wieder einbauen wenn D. Neumann getestet hat
                    bool Visible = this.FormFunctions.getObjectPermissions("CollectionSpecimenTransaction", "INSERT");
                    this.toolStripButtonOverviewHierarchyPartNewRegulation.Visible = Visible;
                    this.toolStripButtonOverviewHierarchyNewPermit.Visible = Visible;

//                    this.toolStripButtonOverviewHierarchyPartNewRegulation.Visible = false;// this.FormFunctions.getObjectPermissions("CollectionSpecimenPartRegulation", "INSERT"); ;
//#if NAGOYA_TEST
//                    this.toolStripButtonOverviewHierarchyPartNewRegulation.Visible = this.FormFunctions.getObjectPermissions("CollectionSpecimenPartRegulation", "INSERT"); ;
//#endif
                    bool IsManager = this.FormFunctions.getObjectPermissions("ManagerCollectionList", DiversityWorkbench.FormFunctions.DatabaseGrant.Select);
                    if (IsManager)
                        this.toolStripButtonOverviewHierarchyNewTransaction.Visible = this.FormFunctions.getObjectPermissions("CollectionSpecimenTransaction", DiversityWorkbench.FormFunctions.DatabaseGrant.Insert);
                    else
                        this.toolStripButtonOverviewHierarchyNewTransaction.Visible = false;
                    //this.toolStripButtonOverviewHierarchyNewTransaction.Visible = this.FormFunctions.getObjectPermissions("CollectionSpecimenTransaction", "INSERT");
                    this.prepareToolStripDropDownButtonsProcessing(this.treeViewOverviewHierarchyStorage.SelectedNode);
                    this.toolStripButtonLabelMulti.Visible = true;
                    this.toolStripButtonLabelPreview.Visible = true;
                    this.checkBoxPrintRestrictToMaterial.Visible = true;
                    this.checkBoxPrintRestrictToCollection.Visible = true;
                    this.pictureBoxPrintRestrictToMaterial.Visible = true;
                    this.tableLayoutPanelLabel.Height = (int)(66 * DiversityWorkbench.FormFunctions.DisplayZoomFactor);
                    //this.checkBoxLabelRestrictToMaterial.Visible = true;
                    //this.checkBoxLabelRestrictToCollection.Visible = true;
                    this.setMultiPrintRestrictionText();
                    break;
                case "CollectionSpecimenPartRegulation":
                    //this.toolStripButtonOverviewHierarchyDeletePart.Visible = CanDeleteFromTable;
                    break;
                case "CollectionSpecimenTransaction":
                    IsManager = this.FormFunctions.getObjectPermissions("ManagerCollectionList", DiversityWorkbench.FormFunctions.DatabaseGrant.Select);
                    bool IsManagerOfCurrentTransaction = false;
                    try
                    {
                        System.Data.DataRowView TR = (System.Data.DataRowView)this.collectionSpecimenTransactionBindingSource.Current;
                        string SQL = "SELECT TransactionID FROM [TransactionList] where TransactionID = " + TR["TransactionID"].ToString();
                        System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                        System.Data.DataTable dt = new DataTable();
                        ad.Fill(dt);
                        if (dt.Rows.Count > 0) 
                            IsManagerOfCurrentTransaction = true;
                        //SQL = "SELECT TransactionID FROM [TransactionPermit] where TransactionID = " + TR["TransactionID"].ToString();
                        //dt.Rows.Clear();
                        //string Message = "";
                        //DiversityWorkbench.FormFunctions.SqlFillTable(SQL, ref dt, ref Message);
                        //if (dt.Rows.Count > 0)
                        //{
                        //    DiversityCollection.UserControls.UserControlTransaction UT = new UserControls.UserControlTransaction();
                        //    UT.setTransaction(int.Parse(TR["TransactionID"].ToString()));
                        //    this.splitContainerUserContols.Panel2.Controls.Clear();
                        //    this.splitContainerUserContols.Panel2.Controls.Add(UT);
                        //    UT.Dock = DockStyle.Fill;
                        //    this.splitContainerUserContols.Orientation = Orientation.Horizontal;
                        //    this.splitContainerUserContols.Panel2Collapsed = false;
                        //}
                    }
                    catch { }
                    if (IsManager)
                    {
                        this.toolStripButtonOverviewHierarchyNewTransaction.Visible = IsManagerOfCurrentTransaction;
                        this.toolStripButtonOverviewHierarchyDeletePart.Visible = IsManagerOfCurrentTransaction;
                        this.buttonOpenTransaction.Visible = IsManagerOfCurrentTransaction;
                    }
                    else
                    {
                        this.toolStripButtonOverviewHierarchyNewTransaction.Visible = false;
                        this.toolStripButtonOverviewHierarchyDeletePart.Visible = false;
                        this.buttonOpenTransaction.Visible = false;
                    }
                    this.setTransactionTitle();

                    break;
                case "IdentificationUnitInPart":
                    this.toolStripButtonOverviewHierarchyDeletePart.Visible = CanDeleteFromTable;
                    this.toolStripButtonLabelMulti.Visible = true;
                    this.toolStripButtonLabelPreview.Visible = true;
                    this.prepareToolStripDropDownButtonsAnalysisForParts(this.treeViewOverviewHierarchyStorage.SelectedNode);
                    this.setAnalysisPartList();
                    break;
                case "IdentificationUnitAnalysis":
                    this.setAnalysisPartList();
                    break;
                case "CollectionSpecimenProcessing":
                    this.toolStripButtonOverviewHierarchyDeletePart.Visible = CanDeleteFromTable;
                    this.prepareToolStripDropDownButtonsProcessing(this.treeViewOverviewHierarchyStorage.SelectedNode);
                    break;
                case "CollectionSpecimenRelation":
                    this.toolStripButtonOverviewHierarchyPartFind.Visible = true;
                    this.toolStripButtonOverviewHierarchyDeletePart.Visible = CanDeleteFromTable;
                    break;
                case "CollectionSpecimenReference":
                    this.toolStripButtonOverviewHierarchyDeletePart.Visible = CanDeleteFromTable;
                    this.toolStripButtonOverviewHierarchyPartNewID.Visible = this.FormFunctions.getObjectPermissions("ExternalIdentifier", "INSERT");
                    break;
                //case "Annotation":
                //    this.toolStripButtonOverviewHierarchyDeletePart.Visible = CanDeleteFromTable;
                //    break;
                case "":
                    break;
                default:
                    break;
            }

            //this.toolStripButtonOverviewHierarchyPartNewID.Visible = false;

            this.toolStripButtonOverviewHierarchyPartAnnotationEdit.Visible = false;
            this.toolStripButtonOverviewHierarchyPartAnnotationAdd.Visible = false;

            if (this.treeViewOverviewHierarchyStorage.SelectedNode != null &&
                this.treeViewOverviewHierarchyStorage.SelectedNode.Tag != null &&
                Table.Length > 0)
            {
                try
                {
                    System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                    this.setToolStripOverviewHierarchyPartAnnotationVisibility(R);
                }
                catch { }
            }
        }

        private void setToolStripOverviewHierarchyPartExternalIdentifierVisibility(DataRow R)
        {
//            if (R != null)
//            {
//                System.Data.DataRow[] RR;
//                switch (R.Table.TableName)
//                {
//                    case "CollectionSpecimenPart":
//                        this.toolStripButtonOverviewHierarchyPartNewID.Visible = this.FormFunctions.getObjectPermissions("ExternalIdentifier", "DELETE");
//                        // TODO Regulation - wieder einbauen wenn D. Neumann getestet hat
//                        this.toolStripButtonOverviewHierarchyPartNewRegulation.Visible = false; //this.FormFunctions.getObjectPermissions("Regulation", "SELECT");
//#if NAGOYA_TEST
//                        this.toolStripButtonOverviewHierarchyPartNewRegulation.Visible = this.FormFunctions.getObjectPermissions("Regulation", "SELECT");
//#endif
//                        break;
//                }
//            }
        }

        private void setToolStripOverviewHierarchyPartAnnotationVisibility(DataRow R)
        {
            if (R != null)
            {
                System.Data.DataRow[] RR;
                switch (R.Table.TableName)
                {
                    case "CollectionSpecimenPart":
                        RR = this.dataSetCollectionSpecimen.Annotation.Select("ReferencedID = " + R["SpecimenPartID"].ToString() + " AND ReferencedTable = '" + R.Table.TableName + "'");
                        if (RR.Length > 0)
                            this.toolStripButtonOverviewHierarchyPartAnnotationEdit.Visible = true;
                        else
                            this.toolStripButtonOverviewHierarchyPartAnnotationAdd.Visible = true;

                        break;
                }
            }
        }

        private void setToolStripOverviewHierarchyDisplayStorageVisibility()
        {
            if (this.dataSetCollectionSpecimen.CollectionSpecimenProcessing.Rows.Count > 0)
                this.toolStripButtonOverviewHierarchyDisplayShowProcessing.Visible = true;
            else this.toolStripButtonOverviewHierarchyDisplayShowProcessing.Visible = false;
            if (this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows.Count > 0)
                this.toolStripButtonOverviewHierarchyDisplayShowUnitsInPart.Visible = true;
            else this.toolStripButtonOverviewHierarchyDisplayShowUnitsInPart.Visible = false;
            if (this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Rows.Count > 0)
            {
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select("NOT SpecimenPartID IS NULL");
                if (rr.Length > 0)
                    this.toolStripButtonOverviewHierarchyDisplayShowAnalysisOfPart.Visible = true;
                else
                    this.toolStripButtonOverviewHierarchyDisplayShowAnalysisOfPart.Visible = false;
            }
            else
            {
                this.toolStripButtonOverviewHierarchyDisplayShowAnalysisOfPart.Visible = false;
            }
            if (this.dataSetCollectionSpecimen.CollectionSpecimenTransaction.Rows.Count > 0)
            {
                this.toolStripButtonOverviewHierarchyDisplayShowTransactions.Visible = true;
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenTransaction.Select("IsOnLoan = 1");
                if (rr.Length > 0)
                    this.toolStripButtonOverviewHierarchyDisplayShowOnLoan.Visible = false;//true;
                else
                    this.toolStripButtonOverviewHierarchyDisplayShowOnLoan.Visible = false;
            }
            else
            {
                this.toolStripButtonOverviewHierarchyDisplayShowTransactions.Visible = false;
                this.toolStripButtonOverviewHierarchyDisplayShowOnLoan.Visible = false;
            }
        }

        #endregion

        #endregion

        #region Event series
        
        private void toolStripMenuItemOverviewHierarchyShowSeriesParents_Click(object sender, EventArgs e)
        {
            this.setEventSeriesDisplayMode(sender);
        }

        private void toolStripMenuItemOverviewHierarchyShowSeriesHierarchy_Click(object sender, EventArgs e)
        {
            this.setEventSeriesDisplayMode(sender);
        }

        private void toolStripMenuItemOverviewHierarchyShowSeriesNone_Click(object sender, EventArgs e)
        {
            this.setEventSeriesDisplayMode(sender);
        }

        private void setEventSeriesDisplayMode(object sender)
        {
            if (sender == null)
            {
                // call from alternative hierarchy
                this.toolStripDropDownButtonOverviewHierarchyShowSeries.Tag = HierachyDisplayStyle.Hidden;
                this.toolStripDropDownButtonOverviewHierarchyShowSeries.Image = DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeriesHierarchyGrey];
                this.toolStripDropDownButtonOverviewHierarchyShowSeries.BackColor = System.Drawing.Color.Yellow;
                this.toolStripDropDownButtonOverviewHierarchyShowSeries.Text = "";
            }
            else
            {
                System.Windows.Forms.ToolStripMenuItem M = (System.Windows.Forms.ToolStripMenuItem)sender;
                this.toolStripDropDownButtonOverviewHierarchyShowSeries.Tag = M.Tag;
                this.toolStripDropDownButtonOverviewHierarchyShowSeries.Image = M.Image;
                this.toolStripDropDownButtonOverviewHierarchyShowSeries.BackColor = M.BackColor;
                this.toolStripDropDownButtonOverviewHierarchyShowSeries.Text = M.Text;

                // Hiding the sampling plots as alternative Hierarchy
                if (this.DisplayStyleSamplingPlots != HierachyDisplayStyle.Hidden)
                    this.setSamplingPlotDisplayMode(null);
                //{
                //    if (this.ShowEventSeries)
                //    {
                //        this.setToolStripButtonOverviewHierarchyState(
                //         this.toolStripButtonOverviewHierarchyShowEventSeries,
                //         DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeries],
                //         DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeriesGrey]);
                //    }

                //    if (this.ShowEventSeriesHierarchy) this.setToolStripButtonOverviewHierarchyState(
                //         this.toolStripButtonOverviewHierarchyShowEventSeriesHierarchy,
                //         DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeriesHierarchy],
                //         DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeriesHierarchyGrey]);
                //}
                this.buildOverviewHierarchyUnits();
            }
        }

        private void initEventSeriesDisplayMode()
        {
            try
            {
                this.toolStripMenuItemOverviewHierarchyShowSeriesHierarchy.Tag = HierachyDisplayStyle.Hierarchy;
                this.toolStripMenuItemOverviewHierarchyShowSeriesNone.Tag = HierachyDisplayStyle.Hidden;
                this.toolStripMenuItemOverviewHierarchyShowSeriesParents.Tag = HierachyDisplayStyle.Parents;
                this.toolStripDropDownButtonOverviewHierarchyShowSeries.Tag = HierachyDisplayStyle.Parents;
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }
        

        
        #endregion

        #region Sampling plots

        private void toolStripMenuItemOverviewHierarchyShowPlotParent_Click(object sender, EventArgs e)
        {
            this.setSamplingPlotDisplayMode(sender);
        }

        private void toolStripMenuItemOverviewHierarchyShowPlotHierarchy_Click(object sender, EventArgs e)
        {
            this.setSamplingPlotDisplayMode(sender);
        }

        private void toolStripMenuItemOverviewHierarchyShowPlotNone_Click(object sender, EventArgs e)
        {
            this.setSamplingPlotDisplayMode(sender);
        }

        private void setSamplingPlotDisplayMode(object sender)
        {
            if (sender == null)
            {
                // call from alternative hierarchy
                this.toolStripDropDownButtonOverviewHierarchyShowPlot.Tag = HierachyDisplayStyle.Hidden;
                this.toolStripDropDownButtonOverviewHierarchyShowPlot.Image = DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.SamplingPlotHierarchyGray];
                this.toolStripDropDownButtonOverviewHierarchyShowPlot.BackColor = System.Drawing.Color.Yellow;
                this.toolStripDropDownButtonOverviewHierarchyShowPlot.Text = "";
            }
            else
            {
                System.Windows.Forms.ToolStripMenuItem M = (System.Windows.Forms.ToolStripMenuItem)sender;
                this.toolStripDropDownButtonOverviewHierarchyShowPlot.Tag = M.Tag;
                this.toolStripDropDownButtonOverviewHierarchyShowPlot.Image = M.Image;
                this.toolStripDropDownButtonOverviewHierarchyShowPlot.BackColor = M.BackColor;
                this.toolStripDropDownButtonOverviewHierarchyShowPlot.Text = M.Text;
                this.setSpecimen(this.ID);

                // Hiding the event series as alternative Hierarchy
                if (this.DisplayStyleSamplingPlots != HierachyDisplayStyle.Hidden)
                    this.setEventSeriesDisplayMode(null);
                //{
                //    if (this.ShowEventSeries)
                //    {
                //        this.setToolStripButtonOverviewHierarchyState(
                //         this.toolStripButtonOverviewHierarchyShowEventSeries,
                //         DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeries],
                //         DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeriesGrey]);
                //    }

                //    if (this.ShowEventSeriesHierarchy) this.setToolStripButtonOverviewHierarchyState(
                //         this.toolStripButtonOverviewHierarchyShowEventSeriesHierarchy,
                //         DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeriesHierarchy],
                //         DiversityCollection.Specimen.ImageList.Images[(int)DiversityCollection.Specimen.OverviewImage.EventSeriesHierarchyGrey]);
                //}
                this.buildOverviewHierarchyUnits();
            }
        }

        private void initSamplingPlotDisplayMode()
        {
            try
            {
                this.toolStripMenuItemOverviewHierarchyShowPlotHierarchy.Tag = HierachyDisplayStyle.Hierarchy;
                this.toolStripMenuItemOverviewHierarchyShowPlotNone.Tag = HierachyDisplayStyle.Hidden;
                this.toolStripMenuItemOverviewHierarchyShowPlotParent.Tag = HierachyDisplayStyle.Parents;
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }

        }
        
        #endregion

        #region Analysis

        private void listAnalysisToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.setAnalysisDisplayMode(sender);
        }

        private void listAnalysisByNameToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.setAnalysisDisplayMode(sender);
        }

        private void listAnalysisByNumberToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.setAnalysisDisplayMode(sender);
        }

        private void hideAnalysisToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.setAnalysisDisplayMode(sender);
        }

        private void sortByTypeToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.setAnalysisDisplayMode(sender);
        }

        private void sortByTypeAndDateToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.setAnalysisDisplayMode(sender);
        }

        private void sortByDateToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.setAnalysisDisplayMode(sender);
        }

        private void sortByDateAndTypeToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.setAnalysisDisplayMode(sender);
        }

        private void sortByAnalysisHierarchyToolStripMenuItem_Click(object sender, EventArgs e)
        {
            this.setAnalysisDisplayMode(sender);
        }

        private void setAnalysisDisplayMode(object sender)
        {
            System.Windows.Forms.ToolStripMenuItem M = (System.Windows.Forms.ToolStripMenuItem)sender;
            this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Tag = M.Tag;
            this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Image = M.Image;
            this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.BackColor = M.BackColor;
            this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Text = M.Text;
            this.buildOverviewHierarchyAnalysis();
        }

        private void initAnalysisDisplayMode()
        {
            try
            {
                this.sortByDateAndTypeToolStripMenuItem.Tag = AnalysisDisplayStyle.HierarchyDateType;
                this.sortByAnalysisHierarchyToolStripMenuItem.Tag = AnalysisDisplayStyle.HierarchyOfAnalysis;
                this.sortByDateToolStripMenuItem.Tag = AnalysisDisplayStyle.HierarchyDate;
                this.sortByTypeAndDateToolStripMenuItem.Tag = AnalysisDisplayStyle.HierarchyTypeDate;
                this.sortByTypeToolStripMenuItem.Tag = AnalysisDisplayStyle.HierarchyType;
                this.hideAnalysisToolStripMenuItem.Tag = AnalysisDisplayStyle.Hidden;
                this.listAnalysisToolStripMenuItem.Tag = AnalysisDisplayStyle.NoHierarchy;
                this.listAnalysisByNameToolStripMenuItem.Tag = AnalysisDisplayStyle.ListByName;
                this.listAnalysisByNumberToolStripMenuItem.Tag = AnalysisDisplayStyle.ListByNumber;
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #endregion

        #region Drag & Drop

        #region Unit tree

        private void treeViewOverviewHierarchy_DragDrop(object sender, DragEventArgs e)
        {
            try
            {
                if (e.Data.GetDataPresent("DiversityCollection.HierarchyNode", false))
                {
                    Point pt = this.treeViewOverviewHierarchy.PointToClient(new Point(e.X, e.Y));
                    TreeNode ParentNode = this.treeViewOverviewHierarchy.GetNodeAt(pt);
                    TreeNode ChildNode = (TreeNode)e.Data.GetData("DiversityCollection.HierarchyNode");
                    System.Data.DataRow rChild = (System.Data.DataRow)ChildNode.Tag;
                    System.Data.DataRow rParent = (System.Data.DataRow)ParentNode.Tag;
                    string ChildTable = rChild.Table.TableName;
                    string ParentTable = rParent.Table.TableName;
                    string SQL = "";
                    System.Data.SqlClient.SqlConnection c = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                    System.Data.SqlClient.SqlCommand cmd = new System.Data.SqlClient.SqlCommand(SQL, c);
                    switch (ChildTable)
                    {
                        case "CollectionEventSeries":
                            if (ParentTable == "CollectionEventSeries")
                            {
                                if (this.NoLoopInEventSeries(rChild, rParent))
                                {
                                    rChild["SeriesParentID"] = rParent["SeriesID"];
                                    this.buildOverviewHierarchyUnits();
                                }
                                else
                                    System.Windows.Forms.MessageBox.Show("This would create a loop in the event series", "Loop", MessageBoxButtons.OK, MessageBoxIcon.Error);
                            }
                            else
                            {
                                System.Windows.Forms.MessageBox.Show("Event series can only be placed within other event series");
                                return;
                            }
                            break;
                        case "CollectionSpecimen":
                            if (ParentTable == "CollectionEvent")
                            {
                                rChild["CollectionEventID"] = rParent["CollectionEventID"];
                                this.setSpecimen(this.ID);
                            }
                            else
                            {
                                System.Windows.Forms.MessageBox.Show("Specimens can only be placed within collection events");
                                return;
                            }
                            break;
                        case "CollectionSpecimenList":
                            if (ParentTable == "CollectionEvent")
                            {
                                SQL = "UPDATE CollectionSpecimen SET CollectionEventID  = " + rParent["CollectionEventID"].ToString() + " WHERE CollectionSpecimenID = " + rChild["CollectionSpecimenID"].ToString();
                                cmd.CommandText = SQL;
                                c.Open();
                                cmd.ExecuteNonQuery();
                                c.Close();
                                this.setSpecimen(this.ID);
                            }
                            else
                            {
                                System.Windows.Forms.MessageBox.Show("Specimens can only be placed within collection events");
                                return;
                            }
                            break;
                        case "CollectionEvent":
                            if (ParentTable == "CollectionEventSeries")
                            {
                                rChild["SeriesID"] = rParent["SeriesID"];
                                this.setSpecimen(this.ID);
                            }
                            else
                            {
                                System.Windows.Forms.MessageBox.Show("Collection events can only be placed within event series");
                                return;
                            }
                            break;
                        case "IdentificationUnit":
                            int ChildID;
                            int oldChildSubstrateID;
                            int ParentID;
                            if (ParentTable == "IdentificationUnit")
                            {
                                if (!ParentNode.Equals(ChildNode))
                                {
                                    rChild = (System.Data.DataRow)ChildNode.Tag;
                                    ChildID = System.Int32.Parse(rChild["IdentificationUnitID"].ToString());
                                    if (rChild["RelatedUnitID"].Equals(System.DBNull.Value)) oldChildSubstrateID = -1;
                                    else oldChildSubstrateID = System.Int32.Parse(rChild["RelatedUnitID"].ToString());
                                    if (ParentNode.Tag != null)
                                    {
                                        rParent = (System.Data.DataRow)ParentNode.Tag;
                                        ParentID = System.Int32.Parse(rParent["IdentificationUnitID"].ToString());
                                        rChild["RelatedUnitID"] = ParentID;
                                    }
                                    else rChild["RelatedUnitID"] = System.DBNull.Value;
                                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.Tables["IdentificationUnit"].Select("RelatedUnitID = " + ChildID.ToString());
                                    foreach (System.Data.DataRow r in rr)
                                    {
                                        if (oldChildSubstrateID > -1) r["RelatedUnitID"] = oldChildSubstrateID;
                                        else r["RelatedUnitID"] = System.DBNull.Value;
                                    }
                                    //this.buildUnitHierarchy();
                                }
                            }
                            else if (ParentTable == "IdentificationUnitList")
                            {
                                if (!ParentNode.Equals(ChildNode))
                                {
                                    rChild = (System.Data.DataRow)ChildNode.Tag;
                                    ChildID = System.Int32.Parse(rChild["IdentificationUnitID"].ToString());
                                    if (rChild["RelatedUnitID"].Equals(System.DBNull.Value)) oldChildSubstrateID = -1;
                                    else oldChildSubstrateID = System.Int32.Parse(rChild["RelatedUnitID"].ToString());
                                    if (ParentNode.Tag != null)
                                    {
                                        rParent = (System.Data.DataRow)ParentNode.Tag;
                                        ParentID = System.Int32.Parse(rParent["IdentificationUnitID"].ToString());
                                        rChild["RelatedUnitID"] = ParentID;
                                    }
                                    else rChild["RelatedUnitID"] = System.DBNull.Value;
                                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.Tables["IdentificationUnit"].Select("RelatedUnitID = " + ChildID.ToString());
                                    foreach (System.Data.DataRow r in rr)
                                    {
                                        if (oldChildSubstrateID > -1) r["RelatedUnitID"] = oldChildSubstrateID;
                                        else r["RelatedUnitID"] = System.DBNull.Value;
                                    }
                                    //this.buildUnitHierarchy();
                                }
                            }
                            else if (ParentTable == "CollectionSpecimen")
                            {
                                rChild = (System.Data.DataRow)ChildNode.Tag;
                                rChild["RelatedUnitID"] = System.DBNull.Value;
                            }
                            else if (ParentTable == "CollectionSpecimenList")
                            {
                                rChild = (System.Data.DataRow)ChildNode.Tag;
                                if (ParentNode.Tag != null)
                                {
                                    rParent = (System.Data.DataRow)ParentNode.Tag;
                                    ParentID = System.Int32.Parse(rParent["CollectionSpecimenID"].ToString());
                                    rChild["CollectionSpecimenID"] = ParentID;
                                    this.setSpecimen(this.ID);
                                }
                            }
                            break;
                        case "CollectionSpecimenRelation":
                            int UnitID;
                            if (ParentTable == "IdentificationUnit")
                            {
                                if (!ParentNode.Equals(ChildNode))
                                {
                                    rChild = (System.Data.DataRow)ChildNode.Tag;
                                    if (ParentNode.Tag != null)
                                    {
                                        bool RedrawPartTree = false;
                                        if (!rChild["SpecimenPartID"].Equals(System.DBNull.Value))
                                            RedrawPartTree = true;
                                        rParent = (System.Data.DataRow)ParentNode.Tag;
                                        ParentID = System.Int32.Parse(rParent["IdentificationUnitID"].ToString());
                                        rChild["IdentificationUnitID"] = ParentID;
                                        rChild["SpecimenPartID"] = System.DBNull.Value;
                                        if (RedrawPartTree)
                                            this.buildOverviewHierarchyParts();
                                    }
                                }
                            }
                            else if (ParentTable == "CollectionSpecimen")
                            {
                                bool RedrawPartTree = false;
                                if (!rChild["SpecimenPartID"].Equals(System.DBNull.Value)) 
                                    RedrawPartTree = true;
                                rChild = (System.Data.DataRow)ChildNode.Tag;
                                rChild["IdentificationUnitID"] = System.DBNull.Value;
                                rChild["SpecimenPartID"] = System.DBNull.Value;
                                if (RedrawPartTree)
                                    this.buildOverviewHierarchyParts();
                            }
                            else
                            {
                                System.Windows.Forms.MessageBox.Show("Relations can only be placed within specimen or units");
                                return;
                            }
                            break;
                        default:
                            System.Windows.Forms.MessageBox.Show("Only event series, collection events, collection speciman and identification units can moved here");
                            //this.buildEventSeriesHierarchy();
                            //return;
                            break;
                    }
                    this.buildOverviewHierarchyUnits();
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private bool NoLoopInEventSeries()
        {
            bool NoLoop = true;
            System.Data.DataRow RParent;
            System.Data.DataRow RChild;
            if (this.dataSetCollectionEventSeries.CollectionEventSeries.Rows.Count > 0)
            {
                System.Data.DataRow[] RR = this.dataSetCollectionEventSeries.CollectionEventSeries.Select("SeriesParentID IS NULL");
                if (RR.Length > 0)
                {
                    RParent = RR[0];
                    return true;
                }
                else
                {
                    RParent = this.dataSetCollectionEventSeries.CollectionEventSeries.Rows[0];
                }
                if (this.dataSetCollectionEventSeries.CollectionEventSeries.Rows.Count > 1)
                {
                    if (RR.Length > 0)
                    {
                        System.Data.DataRow[] RRChild = this.dataSetCollectionEventSeries.CollectionEventSeries.Select("NOT SeriesParentID IS NULL");
                        if (RRChild.Length > 0)
                            RChild = RRChild[0];
                        else
                            RChild = this.dataSetCollectionEventSeries.CollectionEventSeries.Rows[0];
                    }
                    else
                        RChild = this.dataSetCollectionEventSeries.CollectionEventSeries.Rows[1];
                }
                else
                    RChild = this.dataSetCollectionEventSeries.CollectionEventSeries.Rows[0];
                if (RChild != null && RParent != null)
                    NoLoop = this.NoLoopInEventSeries(RChild, RParent);
            }
            return NoLoop;
        }

        private bool NoLoopInEventSeries(System.Data.DataRow rChild, System.Data.DataRow rParent)
        {
            bool NoLoop = true;
            try
            {
                int ChildID = int.Parse(rChild["SeriesID"].ToString());
                int ParentID = int.Parse(rParent["SeriesID"].ToString());
                if (ChildID == ParentID)
                    return false;
                int? ParentOfParentID = null;
                int iPP = 0;
                if (int.TryParse(rParent["SeriesParentID"].ToString(), out iPP))
                    ParentOfParentID = iPP;
                System.Data.DataRow[] rr = this.dataSetCollectionEventSeries.CollectionEventSeries.Select("SeriesID = " + ParentID);
                if (rr.Length > 0)
                {
                    if (!rr[0]["SeriesParentID"].Equals(System.DBNull.Value))
                    {
                        while (ParentOfParentID != null)
                        {
                            if (ParentOfParentID == ChildID)
                            {
                                NoLoop = false;
                                break;
                            }
                            System.Data.DataRow[] RR = this.dataSetCollectionEventSeries.CollectionEventSeries.Select("SeriesID = " + ParentOfParentID);
                            if (RR.Length > 0)
                            {
                                if (RR[0]["SeriesParentID"].Equals(System.DBNull.Value))
                                    break;
                                else
                                {
                                    ParentOfParentID = int.Parse(RR[0]["SeriesParentID"].ToString());
                                }
                            }
                            else break;
                        }
                    }
                }
            }
            catch { }
            return NoLoop;
        }

        private void treeViewOverviewHierarchy_DragOver(object sender, DragEventArgs e)
        {
            try
            {
                System.Windows.Forms.TreeNode tn;
                e.Effect = DragDropEffects.Move;
                TreeView tv = sender as TreeView;
                Point pt = tv.PointToClient(new Point(e.X, e.Y));
                int delta = tv.Height - pt.Y;
                if ((delta < tv.Height / 2) && (delta > 0))
                {
                    tn = tv.GetNodeAt(pt.X, pt.Y);
                    if (tn != null)
                    {
                        if (tn.NextVisibleNode != null)
                            tn.NextVisibleNode.EnsureVisible();
                    }
                }
                if ((delta > tv.Height / 2) && (delta < tv.Height))
                {
                    tn = tv.GetNodeAt(pt.X, pt.Y);
                    if (tn.PrevVisibleNode != null)
                        tn.PrevVisibleNode.EnsureVisible();
                }

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void treeViewOverviewHierarchy_ItemDrag(object sender, ItemDragEventArgs e)
        {
            System.Windows.Forms.TreeNode N = (System.Windows.Forms.TreeNode)e.Item;
            System.Data.DataRow R = (System.Data.DataRow)N.Tag;
            if (R == null)
                return;
            string Table = R.Table.TableName;
            switch (Table)
            {
                case "CollectionEvent":
                case "CollectionEventSeries":
                case "CollectionSpecimenList":
                case "IdentificationUnit":
                case "CollectionSpecimenRelation":
                    this.treeViewOverviewHierarchy.DoDragDrop(e.Item, System.Windows.Forms.DragDropEffects.Move);
                    break;
            }
        }

        #endregion

        #region Part tree

        private void treeViewOverviewHierarchyStorage_DragDrop(object sender, DragEventArgs e)
        {
            TreeNode ChildNode;
            TreeNode ParentNode;
            int ChildID;
            int oldChildSubstrateID;
            int ParentID;
            System.Drawing.Point pt;
            try
            {
                if (e.Data.GetDataPresent("DiversityCollection.HierarchyNode", false))
                {
                    pt = this.treeViewOverviewHierarchyStorage.PointToClient(new System.Drawing.Point(e.X, e.Y));
                    ParentNode = this.treeViewOverviewHierarchyStorage.GetNodeAt(pt);
                    ChildNode = (TreeNode)e.Data.GetData("DiversityCollection.HierarchyNode");
                    System.Data.DataRow Rchild = (System.Data.DataRow)ChildNode.Tag;
                    System.Data.DataRow Rparent = (System.Data.DataRow)ParentNode.Tag;
                    string TableChild = Rchild.Table.TableName;
                    string TableParent = Rparent.Table.TableName;
                    switch (TableChild)
                    {
                        case "CollectionSpecimenPart":
                            if (TableParent == "CollectionSpecimenPart")
                            {
                                bool NoLoop = true;
                                int ChildPartID = int.Parse(Rchild["SpecimenPartID"].ToString());
                                int ParentPartID = int.Parse(Rparent["SpecimenPartID"].ToString());
                                if (ChildPartID == ParentPartID)
                                    NoLoop = false;
                                else
                                {
                                    int? ParentOfParentID = null;
                                    int iPP = 0;
                                    if (int.TryParse(Rparent["DerivedFromSpecimenPartID"].ToString(), out iPP))
                                        ParentOfParentID = iPP;
                                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenPart.Select("SpecimenPartID = " + ParentPartID);
                                    if (rr.Length > 0)
                                    {
                                        if (!rr[0]["DerivedFromSpecimenPartID"].Equals(System.DBNull.Value))
                                        {
                                            while (ParentOfParentID != null)
                                            {
                                                if (ParentOfParentID == ChildPartID)
                                                {
                                                    NoLoop = false;
                                                    //System.Windows.Forms.MessageBox.Show("This would create a loop");
                                                    break;
                                                }
                                                System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.CollectionSpecimenPart.Select("SpecimenPartID = " + ParentOfParentID);
                                                if (RR.Length > 0)
                                                {
                                                    if (RR[0]["DerivedFromSpecimenPartID"].Equals(System.DBNull.Value))
                                                        break;
                                                    else
                                                    {
                                                        ParentOfParentID = int.Parse(RR[0]["DerivedFromSpecimenPartID"].ToString());
                                                    }
                                                }
                                                else break;
                                            }
                                        }
                                    }
                                }
                                if (NoLoop)
                                    Rchild["DerivedFromSpecimenPartID"] = int.Parse(Rparent["SpecimenPartID"].ToString());
                                else
                                    System.Windows.Forms.MessageBox.Show("This would create a loop in the specimen parts", "Loop", MessageBoxButtons.OK, MessageBoxIcon.Error);
                            }
                            else if (TableParent == "Collection")
                                Rchild["CollectionID"] = int.Parse(Rparent["CollectionID"].ToString());
                            else if (TableParent == "CollectionSpecimen")
                                Rchild["DerivedFromSpecimenPartID"] = System.DBNull.Value;
                            break;
                        case "CollectionSpecimenProcessing":
                            if (TableParent == "CollectionSpecimenPart")
                            {
                                Rchild["SpecimenPartID"] = Rparent["SpecimenPartID"];
                            }
                            else if (TableParent == "CollectionSpecimen")
                                Rchild["SpecimenPartID"] = System.DBNull.Value;
                            break;
                        case "CollectionSpecimenRelation":
                            int UnitID;
                            int PartID;
                            if (TableParent == "IdentificationUnit")
                            {
                                if (!ParentNode.Equals(ChildNode))
                                {
                                    Rchild = (System.Data.DataRow)ChildNode.Tag;
                                    UnitID = System.Int32.Parse(Rchild["IdentificationUnitID"].ToString());
                                    if (ParentNode.Tag != null)
                                    {
                                        Rparent = (System.Data.DataRow)ParentNode.Tag;
                                        ParentID = System.Int32.Parse(Rparent["IdentificationUnitID"].ToString());
                                        Rchild["IdentificationUnitID"] = ParentID;
                                    }
                                }
                            }
                            else if (TableParent == "CollectionSpecimenPart")
                            {
                                bool RedrawUnitTree = false;
                                if (Rchild["SpecimenPartID"].Equals(System.DBNull.Value))
                                    RedrawUnitTree = true;
                                Rparent = (System.Data.DataRow)ParentNode.Tag;
                                ParentID = System.Int32.Parse(Rparent["SpecimenPartID"].ToString());
                                Rchild = (System.Data.DataRow)ChildNode.Tag;
                                Rchild["SpecimenPartID"] = ParentID;
                                Rchild["IdentificationUnitID"] = System.DBNull.Value;
                                if (RedrawUnitTree)
                                    this.buildOverviewHierarchyUnits();
                            }
                            else if (TableParent == "IdentificationUnitInPart")
                            {
                                bool RedrawUnitTree = false;
                                if (Rchild["SpecimenPartID"].Equals(System.DBNull.Value))
                                    RedrawUnitTree = true;
                                Rparent = (System.Data.DataRow)ParentNode.Tag;
                                int ParentPartID = System.Int32.Parse(Rparent["SpecimenPartID"].ToString());
                                int ParentUnitID = System.Int32.Parse(Rparent["IdentificationUnitID"].ToString());
                                Rchild = (System.Data.DataRow)ChildNode.Tag;
                                Rchild["SpecimenPartID"] = ParentPartID;
                                Rchild["IdentificationUnitID"] = ParentUnitID;
                                if (RedrawUnitTree)
                                    this.buildOverviewHierarchyUnits();
                            }
                            else if (TableParent == "CollectionSpecimen")
                            {
                                Rchild = (System.Data.DataRow)ChildNode.Tag;
                                Rchild["IdentificationUnitID"] = System.DBNull.Value;
                                Rchild["SpecimenPartID"] = System.DBNull.Value;
                            }
                            else
                            {
                                System.Windows.Forms.MessageBox.Show("Relations can only be placed within specimen or units");
                                return;
                            }
                            break;
                    }
                    this.buildOverviewHierarchyParts();
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void treeViewOverviewHierarchyStorage_DragOver(object sender, DragEventArgs e)
        {
            try
            {
                e.Effect = DragDropEffects.Move;
                TreeView tv = sender as TreeView;
                System.Drawing.Point pt = tv.PointToClient(new System.Drawing.Point(e.X, e.Y));
                int delta = tv.Height - pt.Y;
                if ((delta < tv.Height / 2) && (delta > 0))
                {
                    TreeNode tn = tv.GetNodeAt(pt.X, pt.Y);
                    if (tn.NextVisibleNode != null)
                        tn.NextVisibleNode.EnsureVisible();
                }
                if ((delta > tv.Height / 2) && (delta < tv.Height))
                {
                    TreeNode tn = tv.GetNodeAt(pt.X, pt.Y);
                    if (tn.PrevVisibleNode != null)
                        tn.PrevVisibleNode.EnsureVisible();
                }
            }
            catch { }
        }

        private void treeViewOverviewHierarchyStorage_ItemDrag(object sender, ItemDragEventArgs e)
        {
            //this.treeViewOverviewHierarchyStorage.DoDragDrop(e.Item, System.Windows.Forms.DragDropEffects.Move);
            System.Windows.Forms.TreeNode N = (System.Windows.Forms.TreeNode)e.Item;
            System.Data.DataRow R = (System.Data.DataRow)N.Tag;
            if (R == null)
                return;
            string Table = R.Table.TableName;
            switch (Table)
            {
                case "CollectionSpecimenPart":
                case "CollectionSpecimenRelation":
                    this.treeViewOverviewHierarchy.DoDragDrop(e.Item, System.Windows.Forms.DragDropEffects.Move);
                    break;
            }
        }


        #endregion

        #endregion

        #region Auxillary

        private enum StateButtonOverviewHierarchy { Show, Hide, Hierarchy }

        private void getOverviewHierarchyNodes(System.Windows.Forms.TreeNode Node, string Table,
            System.Windows.Forms.TreeView Treeview,
            ref System.Collections.Generic.List<System.Windows.Forms.TreeNode> TreeNodes)
        {
            if (TreeNodes == null) TreeNodes = new List<TreeNode>();
            if (Node == null)
            {
                foreach (System.Windows.Forms.TreeNode N in Treeview.Nodes)
                {
                    if (N.Tag != null)
                    {
                        try
                        {
                            System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                            if (R.Table.TableName == Table)
                                TreeNodes.Add(N);
                            this.getOverviewHierarchyNodes(N, Table, Treeview, ref TreeNodes);
                        }
                        catch { }
                    }
                }
            }
            else
            {
                foreach (System.Windows.Forms.TreeNode N in Node.Nodes)
                {
                    if (N.Tag != null)
                    {
                        try
                        {
                            System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                            if (R.Table.TableName == Table) 
                                TreeNodes.Add(N);
                            this.getOverviewHierarchyNodes(N, Table, Treeview, ref TreeNodes);
                        }
                        catch { }
                    }
                }
            }
        }

        private void setToolStripButtonOverviewHierarchyState(
            System.Windows.Forms.ToolStripButton Button,
            System.Drawing.Image ImageShow,
            System.Drawing.Image ImageHide)
        {
            if (Button.Tag == null)
                Button.Tag = "Hide";
            else
            {
                if (Button.Tag.ToString() == "Hide")
                    Button.Tag = "Show";
                else
                    Button.Tag = "Hide";
            }
            if (Button.Tag.ToString() == "Hide")
            {
                Button.Image = ImageHide;
                Button.BackColor = System.Drawing.Color.Yellow;
            }
            else
            {
                Button.Image = ImageShow;
                Button.BackColor = System.Drawing.SystemColors.Control;
                //Button.BackColor = System.Drawing.SystemColors.Highlight;
            }
        }

        private void setToolStripButtonOverviewHierarchyState(
            System.Windows.Forms.ToolStripButton Button,
            System.Drawing.Image ImageShow,
            System.Drawing.Image ImageHide,
            System.Drawing.Image ImageHierarchy)
        {
            string CurrentState = "Hide";
            if (Button.Tag == null) CurrentState = "Show";
            else CurrentState = Button.Tag.ToString();
            switch (CurrentState)
            {
                case "Show":
                    Button.Tag = "Hierarchy";
                    Button.Image = ImageHierarchy;
                    Button.BackColor = System.Drawing.SystemColors.Control;
                    break;
                case "Hierarchy":
                    Button.Tag = "Hide";
                    Button.Image = ImageHide;
                    Button.BackColor = System.Drawing.Color.Yellow;
                    break;
                case "Hide":
                    Button.Tag = "Show";
                    Button.Image = ImageShow;
                    Button.BackColor = System.Drawing.SystemColors.Control;
                    break;
            }
        }

        private void markSelectedNode(System.Windows.Forms.TreeNode Node, System.Windows.Forms.TreeView TreeView)
        {
            System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
            foreach (System.Windows.Forms.TreeNode N in TreeView.Nodes)
            {
                Nodes.Add(N);
                this.getChildNodes(N, ref Nodes);
            }
            foreach (System.Windows.Forms.TreeNode N in Nodes)
            {
                if (N.ForeColor != System.Drawing.Color.White)
                    N.BackColor = System.Drawing.SystemColors.Window;
                if (N.Tag != null)
                {
                    try
                    {
                        System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                        if (R.Table.TableName == "IdentificationUnit" && R.RowState != DataRowState.Detached && R.RowState != DataRowState.Deleted)
                        {
                            if (R["RelationType"].ToString() == "Part of" && !R["RelatedUnitID"].Equals(System.DBNull.Value))
                                N.BackColor = System.Drawing.SystemColors.Control;
                        }
                        if (R.Table.TableName == "IdentificationUnitInPart" 
                            && R.RowState != DataRowState.Detached
                            && R.RowState != DataRowState.Deleted)
                        {
                            string UnitID = R["IdentificationUnitID"].ToString();
                            foreach (System.Data.DataRow RU in this.dataSetCollectionSpecimen.IdentificationUnit.Rows)
                            {
                                if (RU.RowState == DataRowState.Detached || RU.RowState == DataRowState.Deleted) continue;
                                if (RU["IdentificationUnitID"].ToString() == UnitID)
                                {
                                    if (RU["RelationType"].ToString() == "Part of" && !RU["RelatedUnitID"].Equals(System.DBNull.Value))
                                        N.BackColor = System.Drawing.SystemColors.Control;
                                    break;
                                }
                            }
                        }
                    }
                    catch { }
                }
            }
            if (Node != null && Node.ForeColor != System.Drawing.Color.White)
                Node.BackColor = System.Drawing.Color.Yellow;
        }

        private void getChildNodes(System.Windows.Forms.TreeNode Node, ref System.Collections.Generic.List<System.Windows.Forms.TreeNode> NodeList)
        {
            foreach (System.Windows.Forms.TreeNode N in Node.Nodes)
            {
                NodeList.Add(N);
                this.getChildNodes(N, ref NodeList);
            }
        }

        private System.Windows.Forms.TreeNode SpecimenCurrentUnitTreeNode (System.Windows.Forms.TreeNode ParentNode)
        {
            System.Windows.Forms.TreeNode N;
            if (ParentNode == null)
                N = this.treeViewOverviewHierarchy.Nodes[0];
            else
                N = ParentNode;
            foreach (System.Windows.Forms.TreeNode Nchild in N.Nodes)
            {
                if (Nchild.Tag != null)
                {
                    try
                    {
                        System.Data.DataRow R = (System.Data.DataRow)Nchild.Tag;
                        if (R.Table.TableName == "CollectionSpecimen" &&
                            R["CollectionSpecimenID"].ToString() == this.SpecimenID.ToString())
                            return Nchild;
                    }
                    catch { }
                }
                foreach (System.Windows.Forms.TreeNode Ncc in Nchild.Nodes)
                {
                    System.Windows.Forms.TreeNode Nspecimen = this.SpecimenCurrentUnitTreeNode(Ncc);
                    if (Nspecimen != null) 
                        return Nspecimen;
                }
            }
            return null;
        }

        #endregion
        
        #endregion

        #region Selecting the nodes

        //private string _PreviousSelectedTable = "";
        //private System.Windows.Forms.TreeView _PreviousSelectedTreeView = null;
        //private System.Data.DataTable _PreviousSelectedDataTable = null; 

        private void treeViewOverviewHierarchy_AfterSelect(object sender, TreeViewEventArgs e)
        {
            string Table = "";
            try
            {
                //this._PreviousSelectedNode = this.treeViewOverviewHierarchy.SelectedNode;

                if (this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
                {
                    System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                    Table = R.Table.TableName;

                    //this._PreviousSelectedTable = Table;
                    //this._PreviousSelectedTreeView = this.treeViewOverviewHierarchy;
                    //this._PreviousSelectedDataTable = R.Table;

                    this.setBindingContext(R);
                    this.EnableRestrictImageToUnitButton(R);
                }
                this.setToolStripOverviewHierarchyEditVisibility(Table);
                this.setUserControlModuleRelatedEntrySources(Table);

                this.setToolStripOverviewHierarchyStorageEditVisibility("");
                this.treeViewOverviewHierarchyStorage.SelectedNode = null;
                this.setOverviewDataVisibility(Table);
                this.setImageVisibility(Table);
                this.markSelectedNode(this.treeViewOverviewHierarchy.SelectedNode, this.treeViewOverviewHierarchy);
                this.markSelectedNode(null, this.treeViewOverviewHierarchyStorage);
                this.textBoxFamilyCache.ReadOnly = true;
                this.textBoxOrderCache.ReadOnly = true;

                if (e.Action == TreeViewAction.ByMouse)
                {
                    switch (Table)
                    {
                        case "ExternalIdentifier":
                            bool OK = this.FormFunctions.getObjectPermissions("ExternalIdentifier", DiversityWorkbench.FormFunctions.DatabaseGrant.Update);
                            if (!OK)
                                return;
                            System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                            string WorkbenchUnit = "";
                            DiversityWorkbench.ReferencingTable.IdentifierType TypeOfIdentifier = DiversityWorkbench.ReferencingTable.IdentifierType.ID;

                            DiversityCollection.Forms.FormExternalIdentifier f = new Forms.FormExternalIdentifier(R["Identifier"].ToString(), R["Type"].ToString(), R["URL"].ToString(), R["Notes"].ToString(), WorkbenchUnit, TypeOfIdentifier);
                            f.ShowDialog();
                            if (f.IsDeleted())
                            {
                                R.BeginEdit();
                                R.Delete();
                                R.EndEdit();
                                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "ExternalIdentifier", this.sqlDataAdapterIdentifier, this.BindingContext);
                            }
                            else if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                            {
                                if (f.Identifier().Length == 0)
                                    System.Windows.Forms.MessageBox.Show("The identifier is missing");
                                else
                                {
                                    R.BeginEdit();
                                    R["Identifier"] = f.Identifier();
                                    R["Type"] = f.IdentifierType();
                                    R["URL"] = f.URL();
                                    R["Notes"] = f.Notes();
                                    R.EndEdit();
                                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "ExternalIdentifier", this.sqlDataAdapterIdentifier, this.BindingContext);
                                }
                            }
                            this.buildOverviewHierarchyUnits();
                            break;
                        case "Annotation":
                            this.DisplayAnnotation(this.treeViewOverviewHierarchy.SelectedNode, this.treeViewOverviewHierarchy);
                            this.buildOverviewHierarchyUnits();
                            break;
                        //case "CollectionEventRegulation":
                        //case "CollectionSpecimenPartRegulation":
                        //    break;
                    }
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        private void treeViewOverviewHierarchyStorage_AfterSelect(object sender, TreeViewEventArgs e)
        {
            string Table = "";
            try
            {
                if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                {
                    if (this.treeViewOverviewHierarchyStorage.SelectedNode.Tag != null)
                    {
                        System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        if (R.RowState == DataRowState.Deleted || R.RowState == DataRowState.Detached)
                        {
                            if (this.treeViewOverviewHierarchyStorage.SelectedNode.Parent != null)
                            {
                                System.Data.DataRow RParent = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Parent.Tag;
                                Table = RParent.Table.TableName;
                                this.setBindingContext(RParent);
                                this.EnableRestrictImageToPartButton(RParent);
                            }
                        }
                        else
                        {
                            Table = R.Table.TableName;
                            this.setBindingContext(R);
                            this.EnableRestrictImageToPartButton(R);
                        }
                    }
                }
                this.setToolStripOverviewHierarchyStorageEditVisibility(Table);
                this.setToolStripOverviewHierarchyEditVisibility("");
                this.treeViewOverviewHierarchy.SelectedNode = null;
                this.setOverviewDataVisibility(Table);
                this.setImageVisibility(Table);
                this.markSelectedNode(this.treeViewOverviewHierarchyStorage.SelectedNode, this.treeViewOverviewHierarchyStorage);
                this.markSelectedNode(null, this.treeViewOverviewHierarchy);

                if (e.Action == TreeViewAction.ByMouse)
                {
                    System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                    if (Table == "ExternalIdentifier")
                    {
                        bool OK = this.FormFunctions.getObjectPermissions("ExternalIdentifier", DiversityWorkbench.FormFunctions.DatabaseGrant.Update);
                        if (!OK)
                            return;
                        DiversityWorkbench.ReferencingTable.IdentifierType TypeOfID = DiversityWorkbench.ReferencingTable.IdentifierType.ID;
                        //if (DiversityWorkbench.ReferencingTable.Regulations().Contains(R["Type"].ToString()))
                        //    TypeOfID = DiversityWorkbench.ReferencingTable.IdentifierType.Regulation;
                        DiversityCollection.Forms.FormExternalIdentifier f = new Forms.FormExternalIdentifier(R["Identifier"].ToString(), R["Type"].ToString(), R["URL"].ToString(), R["Notes"].ToString(), "", TypeOfID);
                        f.setHelpProvider(this.helpProviderDiversityCollection.HelpNamespace, "External identifier");
                        f.ShowDialog();
                        if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                        {
                            R.BeginEdit();
                            R["Identifier"] = f.Identifier();
                            R["Type"] = f.IdentifierType();
                            R["URL"] = f.URL();
                            R["Notes"] = f.Notes();
                            R.EndEdit();
                            this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "ExternalIdentifier", this.sqlDataAdapterIdentifier, this.BindingContext);
                            this.buildOverviewHierarchyParts();
                        }
                        else if (f.IsDeleted())
                        {
                            R.BeginEdit();
                            R.Delete();
                            R.EndEdit();
                            this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "ExternalIdentifier", this.sqlDataAdapterIdentifier, this.BindingContext);
                            this.buildOverviewHierarchyParts();
                        }
                    }
                    else if (Table == "Annotation")
                    {
                        this.DisplayAnnotation(this.treeViewOverviewHierarchyStorage.SelectedNode, this.treeViewOverviewHierarchyStorage);
                        this.buildOverviewHierarchyParts();
                    }
                    else if (Table == "CollectionSpecimenPart" || Table == "IdentificationUnitInPart")
                    {
                        if (this._DvPartDescription == null)
                            this._DvPartDescription = new System.Data.DataView(this.dataSetCollectionSpecimen.CollectionSpecimenPartDescription, "SpecimenPartID = " + R["SpecimenPartID"].ToString(), "PartDescriptionID", System.Data.DataViewRowState.CurrentRows);
                        else this._DvPartDescription.RowFilter = "SpecimenPartID = " + R["SpecimenPartID"].ToString();
                        this.listBoxPartDescription.DataSource = this._DvPartDescription;
                        this.listBoxPartDescription.DisplayMember = "Description";
                        this.listBoxPartDescription.ValueMember = "PartDescriptionID";
                        //bool EnablePartDescription = false;
                        //if (this._DvPartDescription.Count > 0)
                        //    EnablePartDescription = true;
                        //this.listBoxPartDescription.Enabled = EnablePartDescription;
                        //this.textBoxPartDescriptionNotes.Enabled = EnablePartDescription;
                        //this.userControlModuleRelatedEntryPartDescription.Enabled = EnablePartDescription;
                        //this.toolStripButtonPartDescriptionDelete.Enabled = EnablePartDescription;
                        this.setPartDescriptionSourcePosition();
                    }
                    else if (Table == "CollectionSpecimenPartRegulation")
                    {
                        //DiversityCollection.Forms.FormRegulation f = new Forms.FormRegulation(R["Regulation"].ToString(), false);
                        //f.ShowDialog();
                    }
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        #endregion

        #region Data

        #region Visibility of split containers and binding of data

        private void setOverviewDataVisibility(string Table)
        {
            try
            {
                System.Drawing.Color ColorOfActivatedPanel = System.Drawing.SystemColors.ControlLightLight;
                int Height = 0;
                System.Data.DataRow R;

                #region setting the Background

                this.setBackgroudColorForPanel(this.splitContainerOverviewAgentRelation.Panel1, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewEventData.Panel1, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewEventDescriptions.Panel1, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewEventDescriptions.Panel2, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewEventLocProp.Panel1, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewEventLocProp.Panel2, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewEventSeries.Panel1, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewIdentificationAnalysis.Panel1, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewIdentificationAnalysis.Panel2, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewLabel.Panel1, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewLabel.Panel2, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewPart.Panel1, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewPrintCollection.Panel1, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewPrintCollection.Panel2, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewProcessingTransaction.Panel1, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewProcessingTransaction.Panel2, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewProject.Panel1, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewProject.Panel2, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewRelation.Panel1, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewRelation.Panel2, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewSpecimenData.Panel1, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewUnitData.Panel1, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewUnitData.Panel2, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewUnit.Panel1, System.Drawing.SystemColors.Control);
                this.setBackgroudColorForPanel(this.splitContainerOverviewUnit.Panel2, System.Drawing.SystemColors.Control);

                #endregion

                this.tableLayoutPanelIdentificationUnitPart.Visible = false;

                int HeightMax = this.splitContainerOverviewData.Height;
                int HeightOfParentData = 0;
                int HeightMin = 0;

                //this.splitContainerImages.Panel1.Enabled = false;

                this.splitContainerUserContols.Panel1Collapsed = false;
                this.splitContainerUserContols.Panel2Collapsed = true;

                switch (Table)
                {
                    #region Event etc.

                    case "CollectionEventSeries":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewData.Panel2Collapsed = true;
                        this.splitContainerOverviewData.Panel1Collapsed = false;
                        this.splitContainerOverviewEventSeries.Panel1Collapsed = false;
                        this.splitContainerOverviewEventSeries.Panel2Collapsed = true;
                        this.fillEventSeriesImages();
                        this.setBackgroudColorForPanel(this.splitContainerOverviewEventSeries.Panel1, ColorOfActivatedPanel);
                        if (this.userControlGIS.SelectedGISObject != DiversityCollection.UserControls.UserControlGIS.SelectedGisObject.Distribution)
                            this.userControlGIS.SelectedGISObject = DiversityCollection.UserControls.UserControlGIS.SelectedGisObject.Series;
                        this.splitContainerOverviewData.Visible = true;
                        break;
                    case "CollectionEvent":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewData.Panel2Collapsed = true;
                        this.splitContainerOverviewData.Panel1Collapsed = false;
                        this.splitContainerOverviewEventSeries.Panel1Collapsed = true;
                        this.splitContainerOverviewEventSeries.Panel2Collapsed = false;
                        this.splitContainerOverviewEvent.Panel1Collapsed = false;
                        this.splitContainerOverviewEvent.Panel2Collapsed = true;
                        this.splitContainerOverviewEventData.Panel1Collapsed = false;
                        this.splitContainerOverviewEventData.Panel2Collapsed = false;
                        this.splitContainerOverviewEventDescriptions.Panel1Collapsed = false;
                        this.splitContainerOverviewEventDescriptions.Panel2Collapsed = false;
                        this.splitContainerOverviewEventDescriptions.Panel2Collapsed = false;
                        this.splitContainerOverviewEventDescriptions.Panel2Collapsed = false;
                        //this.splitContainerOverviewEventData.Panel1.BackColor = ColorOfActivatedPanel;
                        this.setBackgroudColorForPanel(this.splitContainerOverviewEventData.Panel1, ColorOfActivatedPanel);
                        this.groupBoxCollectionEventMethods.Visible = true;
                        if (this.dataSetCollectionSpecimen.Tables["CollectionEventMethod"].Rows.Count > 0)
                        {
                            int MaxHeight = this.groupBoxEvent.Height - 220 - 66;
                            if (MaxHeight < 0) MaxHeight = 0;
                            this.splitContainerOverviewEventData.SplitterDistance = (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * (220 + MaxHeight/2));
                            this.groupBoxCollectionEventMethods.Height = (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * (66 + this.dataSetCollectionSpecimen.Tables["CollectionEventMethod"].Rows.Count * 4));// + MaxHeight/2));
                        }
                        else
                        {
                            this.splitContainerOverviewEventData.SplitterDistance = (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 220);
                            this.groupBoxCollectionEventMethods.Height = (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 66);
                        }
                        this.splitContainerOverviewData.Visible = true;
                        this.splitContainerImages.Panel1.Enabled = true;
                        break;
                    case "CollectionEventLocalisation":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewEventLocProp.Panel1Collapsed = false;
                        this.splitContainerOverviewEventLocProp.Panel2Collapsed = true;
                        this.splitContainerOverviewEventDescriptions.Panel1Collapsed = false;
                        this.splitContainerOverviewEventDescriptions.Panel2Collapsed = true;
                        this.splitContainerOverviewEventData.Panel1Collapsed = false;
                        this.splitContainerOverviewEventData.Panel2Collapsed = false;
                        this.splitContainerOverviewEvent.Panel1Collapsed = false;
                        this.splitContainerOverviewEvent.Panel2Collapsed = false;
                        this.splitContainerOverviewEventSeries.Panel1Collapsed = true;
                        this.splitContainerOverviewEventSeries.Panel2Collapsed = false;
                        this.splitContainerOverviewData.Panel2Collapsed = true;
                        this.splitContainerOverviewData.Panel1Collapsed = false;
                        R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        this.setEventLocalisationControls(R);

                        this.groupBoxCollectionEventMethods.Visible = false;

                        HeightOfParentData = this.groupBoxEvent.MinimumSize.Height;
                        HeightMin = this.groupBoxEventLocalisation.MinimumSize.Height;
                        Height = HeightMax - HeightOfParentData;
                        if (Height < HeightMin)
                            Height = HeightMin;
                        this.splitContainerOverviewEvent.SplitterDistance = this.splitContainerOverviewEvent.Height - Height + 20;//
                        this.splitContainerOverviewEventData.SplitterDistance = this.splitContainerOverviewEventData.Height - 20 - (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 34);


                        //Height = this.groupBoxEventLocalisation.MinimumSize.Height + 28;
                        //if (Height < this.splitContainerOverviewEvent.Height)
                        //    this.splitContainerOverviewEvent.SplitterDistance = this.splitContainerOverviewEvent.Height - Height;
                        //this.splitContainerOverviewEventData.SplitterDistance = 140;


                        this.setBackgroudColorForPanel(this.splitContainerOverviewEventLocProp.Panel1, ColorOfActivatedPanel);
                        //this.splitContainerOverviewEventLocProp.Panel1.BackColor = ColorOfActivatedPanel;
                        this.splitContainerOverviewData.Visible = true;
                        string LocSystemDescription = "";
                        //string Entity = "";
                        System.Collections.Generic.Dictionary<string, string> Entity = new Dictionary<string, string>(); ;
                        if (this.collectionEventLocalisationBindingSource.Current != null)
                        {
                            System.Data.DataRowView rLoc = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                            string LocSysID = rLoc["LocalisationSystemID"].ToString();
                            int LocalisationSystemID;
                            if (int.TryParse(LocSysID, out LocalisationSystemID))
                            {
                                this.splitContainerImages.Panel1.Enabled = DiversityCollection.LookupTable.LocalisationHasCoordinates(LocalisationSystemID);
                            }
                            System.Data.DataRow[] rrLoc = DiversityCollection.LookupTable.DtLocalisationSystem.Select("LocalisationSystemID = " + LocSysID);
                            if (rrLoc.Length > 0)
                            {
                                LocSystemDescription = rrLoc[0]["Description"].ToString();
                                System.Data.DataRow[] rrLocGeo = this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Select("LocalisationSystemID = " + rLoc["LocalisationSystemID"].ToString());
                                if (rrLocGeo.Length > 0
                                    && !rrLocGeo[0]["GeographyAsString"].Equals(System.DBNull.Value)
                                    && rrLocGeo[0]["GeographyAsString"].ToString().Length > 0
                                    && this.userControlGIS.SelectedGISObject != DiversityCollection.UserControls.UserControlGIS.SelectedGisObject.Distribution
                                    && this.ShowImagesMaps)
                                {
                                    this.userControlGIS.SelectedGISObject = DiversityCollection.UserControls.UserControlGIS.SelectedGisObject.Event;
                                    this.textBoxGeography.Text = rrLocGeo[0]["GeographyAsString"].ToString();
                                    this.textBoxGeography.Visible = true;
                                    this.textBoxGeography.ReadOnly = true;
                                }
                                else
                                {
                                    if (this.textBoxGeography.Text.Length == 0)
                                        this.textBoxGeography.Visible = false;
                                    else
                                    {
                                        this.textBoxGeography.Visible = true;
                                        this.textBoxGeography.ReadOnly = true;
                                    }
                                }
                                try
                                {
                                    if (this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
                                    {
                                        R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                                        bool RowDoesExist = false;
                                        foreach (System.Data.DataRow RGeo in this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Rows)
                                        {
                                            if (RGeo["LocalisationSystemID"].ToString() == R["LocalisationSystemID"].ToString())// &&!RGeo[3].Equals(System.DBNull.Value))
                                            {
                                                RowDoesExist = true;
                                                this.userControlGIS.DataRowCollectionEventLocalisationGeo = RGeo;
                                                if (this.userControlGIS.SelectedGISObject != DiversityCollection.UserControls.UserControlGIS.SelectedGisObject.Distribution &&
                                                     this.ShowImagesMaps)
                                                {
                                                    this.userControlGIS.SelectedGISObject = DiversityCollection.UserControls.UserControlGIS.SelectedGisObject.Event;
                                                }
                                            }
                                        }
                                        if (!RowDoesExist)
                                        {
                                            DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventLocalisationGeoRow RNew = this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.NewCollectionEventLocalisationGeoRow();
                                            RNew.LocalisationSystemID = int.Parse(R["LocalisationSystemID"].ToString());
                                            RNew.CollectionEventID = int.Parse(R["CollectionEventID"].ToString());
                                            this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Rows.Add(RNew);
                                            if (this.userControlGIS.SelectedGISObject != DiversityCollection.UserControls.UserControlGIS.SelectedGisObject.Distribution)
                                            {
                                                this.userControlGIS.SelectedGISObject = DiversityCollection.UserControls.UserControlGIS.SelectedGisObject.Event;
                                                this.userControlGIS.DataRowCollectionEventLocalisationGeo = RNew;
                                            }
                                            try
                                            {
                                                //System.Data.DataRowView RL = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                                                int iLocSyst;
                                                if (int.TryParse(R[1].ToString(), out iLocSyst))
                                                {
                                                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Select("LocalisationSystemID = " + iLocSyst.ToString());
                                                    if (rr.Length > 0)
                                                    {
                                                        for (int ii = 0; ii < this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Rows.Count; ii++)
                                                        {
                                                            if (this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Rows[ii]["LocalisationSystemID"].ToString() == iLocSyst.ToString())
                                                            {
                                                                this.CollectionEventLocalisationGeoBindingSource.Position = ii;
                                                                break;
                                                            }
                                                        }

                                                    }
                                                }
                                            }
                                            catch
                                            {
                                            }
                                        }
                                    }
                                    else
                                    {
                                    }
                                }
                                catch (System.Exception ex) { }




                            }
                            else
                            {
                            }
                            Entity = DiversityWorkbench.Entity.EntityInformation("LocalisationSystem.LocalisationSystemID." + LocSysID);
                        }
                        if (Entity["DisplayTextOK"] == "True")
                        {
                            this.groupBoxEventLocalisation.Text = Entity["DisplayText"];
                        }
                        else
                        {
                            if (LocSystemDescription.Length > 0)
                            {
                                //Cutting the Description to the last point as long as the length is below 100
                                if (LocSystemDescription.Length > 100)
                                {
                                    string[] LocLoc = LocSystemDescription.Split(new char[] { '.' });
                                    string LocShort = LocLoc[0];
                                    int i = 1;
                                    while (i > LocLoc.Length
                                        && LocShort.Length + LocLoc[i].Length < 100)
                                        LocShort += "." + LocLoc[i];
                                    LocSystemDescription = LocShort;
                                }
                                this.groupBoxEventLocalisation.Text = LocSystemDescription;
                            }
                            else
                                this.groupBoxEventLocalisation.Text = DiversityWorkbench.Entity.EntityInformation("CollectionEventLocalisation")["DisplayText"]; // "Localisation of the collection event";
                        }
                        break;
                    case "CollectionEventProperty":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewData.Panel2Collapsed = true;
                        this.splitContainerOverviewData.Panel1Collapsed = false;
                        this.splitContainerOverviewEventSeries.Panel1Collapsed = true;
                        this.splitContainerOverviewEventSeries.Panel2Collapsed = false;
                        this.splitContainerOverviewEvent.Panel1Collapsed = false;
                        this.splitContainerOverviewEvent.Panel2Collapsed = false;
                        this.splitContainerOverviewEventData.Panel1Collapsed = false;
                        this.splitContainerOverviewEventData.Panel2Collapsed = false;
                        this.splitContainerOverviewEventDescriptions.Panel1Collapsed = true;
                        this.splitContainerOverviewEventDescriptions.Panel2Collapsed = false;
                        this.splitContainerOverviewEventLocProp.Panel1Collapsed = true;
                        this.splitContainerOverviewEventLocProp.Panel2Collapsed = false;
                        R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        this.setEventPropertyControls(R);

                        this.groupBoxCollectionEventMethods.Visible = false;

                        HeightOfParentData = this.groupBoxEvent.MinimumSize.Height;
                        HeightMin = this.groupBoxEventProperty.MinimumSize.Height;
                        Height = HeightMax - HeightOfParentData;
                        if (Height < HeightMin)
                            Height = HeightMin;
                        this.splitContainerOverviewEvent.SplitterDistance = this.splitContainerOverviewEvent.Height - Height;
                        this.splitContainerOverviewEventData.SplitterDistance = this.splitContainerOverviewEventData.Height - (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 34);



                        //Height = this.groupBoxEventProperty.MinimumSize.Height + 5;
                        //if (Height < this.splitContainerOverviewEvent.Height)
                        //    this.splitContainerOverviewEvent.SplitterDistance = this.splitContainerOverviewEvent.Height - Height;
                        //this.splitContainerOverviewEventData.SplitterDistance = 140;


                        //this.splitContainerOverviewEventLocProp.Panel2.BackColor = ColorOfActivatedPanel;
                        this.setBackgroudColorForPanel(this.splitContainerOverviewEventLocProp.Panel2, ColorOfActivatedPanel);
                        this.splitContainerOverviewData.Visible = true;
                        break;
                    #endregion

                    #region Specimen 

                    case "CollectionSpecimen":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewData.Panel1Collapsed = true;
                        this.splitContainerOverviewData.Panel2Collapsed = false;

                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = true;

                        this.splitContainerOverviewSpecimenData.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenData.Panel2Collapsed = false;

                        this.splitContainerOverviewProject.Panel1Collapsed = false;
                        this.splitContainerOverviewProject.Panel2Collapsed = false;

                        this.splitContainerOverviewSpecimen.Panel1Collapsed = false;
                        if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.ShowExsiccata)
                        {
                            this.splitContainerOverviewSpecimen.Panel2Collapsed = false;
                            this.splitContainerOverviewSpecimenDependent.Panel1Collapsed = true;
                            this.splitContainerOverviewSpecimenDependent.Panel2Collapsed = false;
                            this.splitContainerOverviewUnitPart.Panel1Collapsed = false;
                            this.splitContainerOverviewUnitPart.Panel2Collapsed = true;
                            this.splitContainerOverviewUnit.Panel1Collapsed = false;
                            this.splitContainerOverviewUnit.Panel2Collapsed = true;
                            this.splitContainerOverviewUnitData.Panel1Collapsed = true;
                            if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.ShowExsiccata)
                                this.splitContainerOverviewUnitData.Panel2Collapsed = false;
                            else this.splitContainerOverviewUnitData.Panel2Collapsed = true;
                        }
                        else
                        {
                            this.splitContainerOverviewSpecimen.Panel2Collapsed = true;
                        }
                        this.tableLayoutPanelExsiccata.Visible = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.ShowExsiccata;
                        this.tableLayoutPanelExsiccataSeries.Visible = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.ShowExsiccata;
                        this.tableLayoutPanelExsiccataUnit.Visible = false;
                        this.labelExsiccataAbbreviation.Visible = false;
                        this.pictureBoxUnit.Image = null;
                        this.groupBoxUnit.Text = DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("CollectionSpecimen.ExsiccataAbbreviation"));
                        if (this.groupBoxUnit.Text.Length == 0)
                        {
                            System.Collections.Generic.Dictionary<string, string> dict = DiversityWorkbench.Entity.EntityInformation("CollectionEventSeries");
                            this.groupBoxUnit.Text = DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, dict);
                            //this.groupBoxUnit.Text = "Exsiccatal series";
                        }

                        Height = 80;
                        if (Height < this.splitContainerOverviewSpecimen.Height)
                            this.splitContainerOverviewSpecimen.SplitterDistance = this.splitContainerOverviewSpecimen.Height - Height;
                        int AddToSplitContainerOverviewSpecimenDataHeight = 15;
                        if (!DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.ShowExsiccata) AddToSplitContainerOverviewSpecimenDataHeight += 10;
                        this.splitContainerOverviewSpecimenData.SplitterDistance = this.groupBoxAccession.MinimumSize.Height + AddToSplitContainerOverviewSpecimenDataHeight;
                        this.splitContainerOverviewSpecimen.SplitterDistance = this.splitContainerOverviewData.Height - 45;

                        this.setBackgroudColorForPanel(this.splitContainerOverviewSpecimenData.Panel1, ColorOfActivatedPanel);
                        this.setBackgroudColorForPanel(this.splitContainerOverviewProject.Panel1, ColorOfActivatedPanel);
                        this.setBackgroudColorForPanel(this.splitContainerOverviewProject.Panel2, ColorOfActivatedPanel);
                        this.setBackgroudColorForPanel(this.splitContainerOverviewUnitData.Panel2, ColorOfActivatedPanel);
                        this.setBackgroudColorForPanel(this.splitContainerOverviewNotesExternal.Panel1, ColorOfActivatedPanel);
                        this.setBackgroudColorForPanel(this.splitContainerOverviewNotesExternal.Panel2, ColorOfActivatedPanel);
                        this.splitContainerOverviewData.Visible = true;

                        try
                        {
                            this.splitContainerUserContols.Panel2Collapsed = false;
                            DiversityWorkbench.UserControls.UserControlModuleLinks UML = new DiversityWorkbench.UserControls.UserControlModuleLinks();
                            UML.SetModuleParameter(DiversityWorkbench.WorkbenchUnit.ModuleType.Descriptions, this, "DescriptionScope", "dwbURI");
                            UML.SearchForModuleLinks(this.ID.ToString());
                            foreach (System.Windows.Forms.Control C in this.splitContainerUserContols.Panel2.Controls)
                                C.Dispose();
                            this.splitContainerUserContols.Panel2.Controls.Clear();
                            this.splitContainerUserContols.Panel2.Controls.Add(UML);
                            this.splitContainerUserContols.Orientation = Orientation.Horizontal;
                            UML.Dock = DockStyle.Fill;
                            UML.setHeight();
                            //this.splitContainerUserContols.SplitterDistance = this.splitContainerUserContols.Height - (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 260); ;// (int)this.Height / 2;
                            //this.splitContainerOverviewPart.SplitterDistance = (int)this.splitContainerOverviewPart.Height - (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 120);
                        }
                        catch (Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        }
                        break;

                    #endregion

                    #region Relation
                    
                    case "CollectionSpecimenRelation":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewRelation.Panel1Collapsed = false;
                        this.splitContainerOverviewRelation.Panel2Collapsed = true;
                        this.splitContainerOverviewAgentRelation.Panel1Collapsed = true;
                        this.splitContainerOverviewAgentRelation.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenDependent.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenDependent.Panel2Collapsed = true;
                        this.splitContainerOverviewSpecimen.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimen.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenData.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenData.Panel2Collapsed = true;
                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = true;
                        this.splitContainerOverviewData.Panel1Collapsed = true;
                        this.splitContainerOverviewData.Panel2Collapsed = false;
                        if (this.treeViewOverviewHierarchy.SelectedNode != null)
                            this.pictureBoxSpecimenRelation.Image = DiversityCollection.Specimen.ImageList.Images[this.treeViewOverviewHierarchy.SelectedNode.ImageIndex];
                        else if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                            this.pictureBoxSpecimenRelation.Image = DiversityCollection.Specimen.ImageList.Images[this.treeViewOverviewHierarchyStorage.SelectedNode.ImageIndex];

                        HeightOfParentData = this.groupBoxAccession.MinimumSize.Height + (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 24);
                        HeightMin = this.groupBoxSpecimenRelation.MinimumSize.Height;
                        Height = HeightMax - HeightOfParentData;
                        if (Height < HeightMin)
                            Height = HeightMin;
                        this.splitContainerOverviewSpecimen.SplitterDistance = this.splitContainerOverviewSpecimen.Height - Height;


                        //Height = this.groupBoxSpecimenRelation.MinimumSize.Height + 5;
                        //if (Height < this.splitContainerOverviewSpecimen.Height)
                        //    this.splitContainerOverviewSpecimen.SplitterDistance = this.splitContainerOverviewSpecimen.Height - Height;
                        //else
                        //{
                        //    Height = (int)splitContainerOverviewSpecimen.Height / 2;
                        //    this.splitContainerOverviewSpecimen.SplitterDistance = Height;
                        //}
                        this.setRelatedSpecimenControls();
                        this.setBackgroudColorForPanel(this.splitContainerOverviewRelation.Panel1, ColorOfActivatedPanel);
                        //this.splitContainerOverviewRelation.Panel1.BackColor = ColorOfActivatedPanel;
                        this.splitContainerOverviewData.Visible = true;
                        break;
                    case "CollectionSpecimenRelationInvers":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewRelation.Panel1Collapsed = true;
                        this.splitContainerOverviewRelation.Panel2Collapsed = false;
                        this.splitContainerOverviewAgentRelation.Panel1Collapsed = true;
                        this.splitContainerOverviewAgentRelation.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenDependent.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenDependent.Panel2Collapsed = true;
                        this.splitContainerOverviewSpecimen.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimen.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenData.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenData.Panel2Collapsed = true;
                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = true;
                        this.splitContainerOverviewData.Panel1Collapsed = true;
                        this.splitContainerOverviewData.Panel2Collapsed = false;
                        Height = this.groupBoxSpecimenRelationInvers.MinimumSize.Height + (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 5);
                        if (Height < this.splitContainerOverviewSpecimen.Height)
                            this.splitContainerOverviewSpecimen.SplitterDistance = this.splitContainerOverviewSpecimen.Height - Height;
                        else
                        {
                            Height = (int)splitContainerOverviewSpecimen.Height / 2;
                            this.splitContainerOverviewSpecimen.SplitterDistance = Height;
                        }
                        this.setBackgroudColorForPanel(this.splitContainerOverviewRelation.Panel2, ColorOfActivatedPanel);
                        //this.splitContainerOverviewRelation.Panel2.BackColor = ColorOfActivatedPanel;
                        this.splitContainerOverviewData.Visible = true;
                        break;
                    
                    #endregion

                    #region Reference

                    case "CollectionSpecimenReference":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewAgentReference.Panel1Collapsed = true;
                        this.splitContainerOverviewAgentReference.Panel2Collapsed = false;
                        this.splitContainerOverviewAgentRelation.Panel1Collapsed = false;
                        this.splitContainerOverviewAgentRelation.Panel2Collapsed = true;
                        this.splitContainerOverviewSpecimenDependent.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenDependent.Panel2Collapsed = true;
                        this.splitContainerOverviewSpecimenData.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenData.Panel2Collapsed = true;
                        this.splitContainerOverviewSpecimen.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimen.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = true;
                        this.splitContainerOverviewData.Panel1Collapsed = true;
                        this.splitContainerOverviewData.Panel2Collapsed = false;
                        HeightOfParentData = this.groupBoxAccession.MinimumSize.Height + (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 24);
                        HeightMin = this.groupBoxReference.MinimumSize.Height;
                        Height = HeightMax - HeightOfParentData;
                        if (Height < HeightMin)
                            Height = HeightMin;
                        this.splitContainerOverviewSpecimen.SplitterDistance = this.splitContainerOverviewSpecimen.Height - Height;
                        this.setBackgroudColorForPanel(this.splitContainerOverviewAgentReference.Panel2, ColorOfActivatedPanel);
                        this.splitContainerOverviewData.Visible = true;
                        break;

                    #endregion

                    #region Agent

                    case "CollectionAgent":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewAgentReference.Panel1Collapsed = false;
                        this.splitContainerOverviewAgentReference.Panel2Collapsed = true;
                        this.splitContainerOverviewAgentRelation.Panel1Collapsed = false;
                        this.splitContainerOverviewAgentRelation.Panel2Collapsed = true;
                        this.splitContainerOverviewSpecimenDependent.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenDependent.Panel2Collapsed = true;
                        this.splitContainerOverviewSpecimenData.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenData.Panel2Collapsed = true;
                        this.splitContainerOverviewSpecimen.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimen.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = true;
                        this.splitContainerOverviewData.Panel1Collapsed = true;
                        this.splitContainerOverviewData.Panel2Collapsed = false;
                        //Height = this.MinHeightOfControl(this.splitContainerOverviewAgentRelation.Panel1);

                        HeightOfParentData = this.groupBoxAccession.MinimumSize.Height + (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 24);
                        HeightMin = this.groupBoxCollector.MinimumSize.Height;
                        Height = HeightMax - HeightOfParentData;
                        if (Height < HeightMin)
                            Height = HeightMin;
                        this.splitContainerOverviewSpecimen.SplitterDistance = this.splitContainerOverviewSpecimen.Height - Height;


                        //Height = 140;
                        //if (Height < this.splitContainerOverviewSpecimen.Height)
                        //    this.splitContainerOverviewSpecimen.SplitterDistance = this.splitContainerOverviewSpecimen.Height - Height;
                        //this.pictureBoxCollectionAgent.Left = this.groupBoxCollector.Width;
                        this.setBackgroudColorForPanel(this.splitContainerOverviewAgentRelation.Panel1, ColorOfActivatedPanel);
                        //this.splitContainerOverviewAgentRelation.Panel1.BackColor = ColorOfActivatedPanel;
                        this.splitContainerOverviewData.Visible = true;
                        break;

                    #endregion

                    #region Part etc.

                    case "IdentificationUnitInPart":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewData.Panel1Collapsed = true;
                        this.splitContainerOverviewData.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimen.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimen.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenDependent.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimenDependent.Panel2Collapsed = false;
                        this.splitContainerOverviewUnitPart.Panel1Collapsed = true;
                        this.splitContainerOverviewUnitPart.Panel2Collapsed = false;
                        this.splitContainerOverviewPart.Panel1Collapsed = false;
                        this.splitContainerOverviewPart.Panel2Collapsed = true;
                        this.splitContainerOverviewPrint.Panel1Collapsed = true;
                        this.splitContainerOverviewPrint.Panel2Collapsed = false;
                        this.splitContainerOverviewLabel.Panel1Collapsed = true;
                        this.splitContainerOverviewLabel.Panel2Collapsed = false;
                        this.tableLayoutPanelIdentificationUnitPart.Visible = true;

                        HeightOfParentData = this.groupBoxPart.MinimumSize.Height + 90;
                        HeightMin = this.groupBoxDisplayOrderPart.MinimumSize.Height;
                        Height = HeightMax - HeightOfParentData;
                        if (Height < HeightMin)
                            Height = HeightMin;
                        this.splitContainerOverviewSpecimenPrint.SplitterDistance = this.splitContainerOverviewSpecimenPrint.Height - Height;

                        if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                        {
                            this.fillPartDisplayLists(this.treeViewOverviewHierarchyStorage.SelectedNode);
                            this.pictureBoxSpecimenPart.Image = DiversityCollection.Specimen.ImageList.Images[this.treeViewOverviewHierarchyStorage.SelectedNode.Parent.ImageIndex];
                        }
                        this.setBackgroudColorForPanel(this.splitContainerOverviewLabel.Panel2, ColorOfActivatedPanel);

                        R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        int p = 0;
                        for (int i = 0; i < this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows.Count; i++)
                        {
                            if (this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows[i]["IdentificationUnitID"].ToString() == R["IdentificationUnitID"].ToString() &&
                                this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows[i]["SpecimenPartID"].ToString() == R["SpecimenPartID"].ToString())
                                break;
                            p++;
                        }
                        this.identificationUnitInPartBindingSource.Position = p;
                        this.splitContainerOverviewLabel.Panel2.BackColor = ColorOfActivatedPanel;
                        this.splitContainerOverviewData.Visible = true;
                        break;
                    case "CollectionSpecimenPart":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewData.Panel1Collapsed = true;
                        this.splitContainerOverviewData.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimen.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimen.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenDependent.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimenDependent.Panel2Collapsed = false;
                        this.splitContainerOverviewUnitPart.Panel1Collapsed = true;
                        this.splitContainerOverviewUnitPart.Panel2Collapsed = false;
                        this.splitContainerOverviewPart.Panel1Collapsed = false;
                        this.splitContainerOverviewPart.Panel2Collapsed = true;
                        this.splitContainerOverviewLabel.Panel1Collapsed = true;
                        this.splitContainerOverviewLabel.Panel2Collapsed = false;
                        this.splitContainerOverviewPrintCollection.Panel1Collapsed = false;
                        this.splitContainerOverviewPrintCollection.Panel2Collapsed = true;
                        this.splitContainerOverviewPrint.Panel1Collapsed = true;

                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = false; // war true
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = false;
                        this.splitContainerOverviewPrint.Panel1Collapsed = true;// war false
                        this.splitContainerOverviewPrint.Panel2Collapsed = false;
                        this.splitContainerOverviewLabel.Panel1Collapsed = false;
                        this.splitContainerOverviewLabel.Panel2Collapsed = false;
                        this.splitContainerOverviewLabel.Orientation = Orientation.Horizontal;
                        this.splitContainerOverviewLabel.SplitterDistance = (this.splitContainerOverviewLabel.Height / 2);
                        if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count > 0)
                        {
                            if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].Equals(System.DBNull.Value))
                                this.groupBoxDisplayOrder.Text = this.Message("Display_order_for") + " " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString();
                            else
                            {
                                if (DiversityWorkbench.Settings.Language == "en-US")
                                    this.groupBoxDisplayOrder.Text = this.Message("Display_order_for") + " " + DiversityWorkbench.Entity.EntityInformation("CollectionSpecimen")["Abbreviation"].ToLower();
                                else
                                    this.groupBoxDisplayOrder.Text = this.Message("Display_order_for") + " " + DiversityWorkbench.Entity.EntityInformation("CollectionSpecimen")["Abbreviation"];
                            }// "Display order for specimen";
                            string Header = this.Message("Display_order_for") + " ";// "Display order for ";
                            if (this.collectionSpecimenPartBindingSource != null)
                            {
                                string Material = "";
                                System.Data.DataRowView RV = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
                                if (!RV["MaterialCategory"].Equals(System.DBNull.Value) && RV["MaterialCategory"].ToString().Length > 0)
                                {
                                    Material = DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.Abbreviation, DiversityWorkbench.Entity.EntityInformation("CollMaterialCategory_Enum.Code." + RV["MaterialCategory"].ToString()));
                                    if (Material.Length > 0) Header += Material;
                                    else Header += RV["MaterialCategory"].ToString();
                                }
                                if (!RV["StorageLocation"].Equals(System.DBNull.Value) && RV["StorageLocation"].ToString().Length > 0)
                                    Header += " " + this.Message("of") + " " + RV["StorageLocation"].ToString();
                            }
                            else Header += DiversityWorkbench.Entity.EntityInformation("CollectionSpecimenPart")["DisplayText"]; // "specimen part";
                            this.groupBoxDisplayOrderPart.Text = Header;
                        }
                        this.splitContainerOverviewPrint.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.SplitterDistance = this.groupBoxPart.MinimumSize.Height + 80 - (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 14);
                        if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                        {
                            this.fillPartDisplayLists(this.treeViewOverviewHierarchyStorage.SelectedNode);
                            this.pictureBoxSpecimenPart.Image = DiversityCollection.Specimen.ImageList.Images[this.treeViewOverviewHierarchyStorage.SelectedNode.ImageIndex];
                            this.pictureBoxSpecimenPart.Left = this.groupBoxPart.Width - (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 20);
                        }
                        this.setBackgroudColorForPanel(this.splitContainerOverviewPart.Panel1, ColorOfActivatedPanel);
                        //this.splitContainerOverviewPart.Panel1.BackColor = ColorOfActivatedPanel;
                        this.splitContainerOverviewData.Visible = true;
                        break;
                    case "CollectionSpecimenProcessing":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = true;
                        this.splitContainerOverviewData.Panel1Collapsed = true;
                        this.splitContainerOverviewData.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenDependent.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimenDependent.Panel2Collapsed = false;
                        this.splitContainerOverviewUnitPart.Panel1Collapsed = true;
                        this.splitContainerOverviewUnitPart.Panel2Collapsed = false;
                        this.splitContainerOverviewPart.Panel1Collapsed = false;
                        this.splitContainerOverviewPart.Panel2Collapsed = false;
                        this.splitContainerOverviewProcessingTransaction.Panel1Collapsed = false;
                        this.splitContainerOverviewProcessingTransaction.Panel2Collapsed = true;
                        R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        if (R.RowState != DataRowState.Deleted && R.RowState != DataRowState.Detached)
                        {
                            if (R["SpecimenPartID"].Equals(System.DBNull.Value))
                            {
                                this.splitContainerOverviewSpecimenData.Panel1Collapsed = false;
                                this.splitContainerOverviewSpecimenData.Panel2Collapsed = true;
                                this.splitContainerOverviewSpecimen.Panel1Collapsed = false;
                                this.splitContainerOverviewSpecimen.Panel2Collapsed = false;
                                this.splitContainerOverviewPart.Panel1Collapsed = true;
                                this.splitContainerOverviewPart.Panel2Collapsed = false;

                                HeightOfParentData = this.groupBoxAccession.MinimumSize.Height;
                                HeightMin = this.groupBoxProcessing.MinimumSize.Height;
                                Height = HeightMax - HeightOfParentData;
                                if (Height < HeightMin)
                                    Height = HeightMin;
                                this.splitContainerOverviewSpecimen.SplitterDistance = this.splitContainerOverviewSpecimen.Height - Height;
                            }
                            else
                            {
                                this.splitContainerOverviewSpecimen.Panel1Collapsed = true;
                                this.splitContainerOverviewSpecimen.Panel2Collapsed = false;

                                HeightOfParentData = this.groupBoxPart.MinimumSize.Height + this.groupBoxPartDescription.Height;
                                HeightMin = this.groupBoxProcessing.MinimumSize.Height;
                                Height = HeightMax - HeightOfParentData;
                                if (Height < HeightMin)
                                    Height = HeightMin;
                                this.splitContainerOverviewPart.SplitterDistance = this.splitContainerOverviewPart.Height - Height;

                                if (R.RowState == DataRowState.Added)
                                {
                                    this.labelSpecimenProcessingID.Visible = false;
                                    this.textBoxSpecimenProcessingID.Visible = false;
                                }
                                else
                                {
                                    this.labelSpecimenProcessingID.Visible = true;
                                    this.textBoxSpecimenProcessingID.Visible = true;
                                }
                            }
                            this.BuildProcessingToolUsageTree();
                        }
                        this.setBackgroudColorForPanel(this.splitContainerOverviewProcessingTransaction.Panel1, ColorOfActivatedPanel);
                        this.splitContainerOverviewData.Visible = true;
                        break;

                    #endregion

                    #region Transaction

                    case "CollectionSpecimenTransaction":
                        R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        int TransationID = int.Parse(R["TransactionID"].ToString());
                        string TransactionType = DiversityCollection.LookupTable.TransactionType(TransationID);
                        if (TransactionType.ToLower() != "loan" && 1 == 0)
                        {
                            //this.checkBoxIsOnLoan.Visible = false;
                            //this.groupBoxTransaction.Text = DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("Transaction"));
                            //if (this.groupBoxTransaction.Text.Length == 0) this.groupBoxTransaction.Text = "Transaction";
                            //this.groupBoxTransaction.ForeColor = System.Drawing.Color.Brown;
                            //this.pictureBoxTransaction.Image = DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Transaction);
                        }
                        else
                        {
                            this.checkBoxIsOnLoan.Visible = false;
                            this.groupBoxTransaction.Text = DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("CollTransactionType_Enum.Code." + TransactionType.ToLower()));
                            //this.groupBoxTransaction.Text = DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("Transaction"));
                            if (this.groupBoxTransaction.Text.Length == 0) this.groupBoxTransaction.Text = "Transaction";
                            this.groupBoxTransaction.ForeColor = System.Drawing.Color.Brown;
                            this.pictureBoxTransaction.Image = DiversityCollection.Specimen.getImage(Specimen.OverviewImage.Transaction);

                            if (this.groupBoxTransaction.Text.Length == 0)
                            {
                                System.Collections.Generic.Dictionary<string, string> dict = DiversityWorkbench.Entity.EntityInformation("CollTransactionType_Enum.Code.loan");
                                this.groupBoxTransaction.Text = DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, dict);
                            }
                            bool IsManagerOfCurrentTransaction = false;
                            try
                            {
                                string SQL = "SELECT TransactionID FROM [TransactionList] where TransactionID = " + R["TransactionID"].ToString();
                                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                                System.Data.DataTable dt = new DataTable();
                                ad.Fill(dt);
                                if (dt.Rows.Count > 0) IsManagerOfCurrentTransaction = true;
                                this.groupBoxTransaction.ForeColor = System.Drawing.Color.Brown;
                                this.pictureBoxTransaction.Image = DiversityCollection.Specimen.ImageListTransactionType().Images[DiversityCollection.Specimen.IndexImageTransactionType(TransactionType, false)];

                                SQL = "SELECT TransactionID FROM [TransactionPermit] where TransactionID = " + R["TransactionID"].ToString();
                                dt.Rows.Clear();
                                string Message = "";
                                DiversityWorkbench.FormFunctions.SqlFillTable(SQL, ref dt, ref Message);
                                if (dt.Rows.Count > 0)
                                {
                                    DiversityCollection.UserControls.UserControlPermit UT = new UserControls.UserControlPermit();
                                    UT.setTransaction(int.Parse(R["TransactionID"].ToString()));
                                    this.splitContainerUserContols.Panel2.Controls.Clear();
                                    this.splitContainerUserContols.Panel2.Controls.Add(UT);
                                    this.splitContainerUserContols.Orientation = Orientation.Horizontal;
                                    UT.Dock = DockStyle.Fill;
                                    this.splitContainerUserContols.SplitterDistance = this.splitContainerUserContols.Height - (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 260); ;// (int)this.Height / 2;
                                    this.splitContainerOverviewPart.SplitterDistance = (int)this.splitContainerOverviewPart.Height - (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 120);
                                    this.splitContainerUserContols.Panel2Collapsed = false;
                                }

                            }
                            catch
                            {
                                this.groupBoxTransaction.ForeColor = System.Drawing.Color.Brown;
                            }
                            this.checkBoxIsOnLoan.Visible = false;//IsManagerOfCurrentTransaction;
                        }
                        this.splitContainerOverviewData.Visible = false;

                        HeightOfParentData = this.groupBoxPart.MinimumSize.Height;
                        HeightMin = this.groupBoxTransaction.MinimumSize.Height;
                        Height = HeightMax - HeightOfParentData;
                        if (Height < HeightMin)
                            Height = HeightMin;
                        if (this.splitContainerOverviewPart.Height > Height + HeightMin && this.splitContainerUserContols.Panel2Collapsed)
                            this.splitContainerOverviewPart.SplitterDistance = this.splitContainerOverviewPart.Height - Height;

                        this.splitContainerOverviewData.Panel1Collapsed = true;
                        this.splitContainerOverviewData.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = true;
                        this.splitContainerOverviewSpecimen.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimen.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenDependent.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimenDependent.Panel2Collapsed = false;
                        this.splitContainerOverviewUnitPart.Panel1Collapsed = true;
                        this.splitContainerOverviewUnitPart.Panel2Collapsed = false;
                        this.splitContainerOverviewPart.Panel1Collapsed = false;
                        if (TransactionType == "regulation")
                            this.splitContainerOverviewPart.Panel2Collapsed = true;
                        else
                        {
                            this.splitContainerOverviewPart.Panel2Collapsed = false;
                            this.splitContainerOverviewProcessingTransaction.Panel1Collapsed = true;
                            this.splitContainerOverviewProcessingTransaction.Panel2Collapsed = false;
                        }
                        this.setBackgroudColorForPanel(this.splitContainerOverviewProcessingTransaction.Panel2, ColorOfActivatedPanel);
                        //this.splitContainerOverviewProcessingTransaction.Panel2.BackColor = ColorOfActivatedPanel;
                        this.splitContainerOverviewData.Visible = true;
                        break;

                    #endregion

                    #region Identification etc.

                    case "IdentificationUnit":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewData.Panel1Collapsed = true;
                        this.splitContainerOverviewData.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = true;
                        this.splitContainerOverviewSpecimen.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimen.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenDependent.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimenDependent.Panel2Collapsed = false;
                        this.splitContainerOverviewUnitPart.Panel1Collapsed = false;
                        this.splitContainerOverviewUnitPart.Panel2Collapsed = true;
                        this.splitContainerOverviewUnit.Panel1Collapsed = false;
                        this.splitContainerOverviewUnit.Panel2Collapsed = true;
                        this.splitContainerOverviewUnitData.Panel1Collapsed = false;
                        this.splitContainerOverviewUnitData.Panel2Collapsed = false;

                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = false; // war true
                        this.splitContainerOverviewPrint.Panel1Collapsed = true;// war false
                        this.splitContainerOverviewPrint.Panel2Collapsed = false;
                        this.splitContainerOverviewLabel.Panel1Collapsed = false;
                        this.splitContainerOverviewLabel.Panel2Collapsed = true;// war false
                        //this.splitContainerOverviewLabel.Orientation = Orientation.Horizontal;
                        //this.splitContainerOverviewLabel.SplitterDistance = this.splitContainerOverviewLabel.Height / 2;
                        this.splitContainerOverviewSpecimenPrint.SplitterDistance = (int)(this.splitContainerOverviewData.Height * 3 / 4);
                        if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].Equals(System.DBNull.Value)
                            && this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString().Length > 0)
                            this.groupBoxDisplayOrder.Text = this.Message("Display_order_for") + " " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString();
                        else
                        {
                            this.groupBoxDisplayOrder.Text = this.Message("Display_order_for") + " ";
                            if (DiversityWorkbench.Settings.Language == "en-US")
                                this.groupBoxDisplayOrder.Text += DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("CollectionSpecimen")).ToLower();
                            else
                                this.groupBoxDisplayOrder.Text += DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("CollectionSpecimen"));
                        }


                        this.pictureBoxUnit.Image = DiversityCollection.Specimen.ImageList.Images[this.treeViewOverviewHierarchy.SelectedNode.ImageIndex];
                        //this.pictureBoxUnit.BringToFront();
                        //this.pictureBoxUnit.Left = this.groupBoxOverviewIdentification.Width - 20;
                        R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        this.groupBoxUnit.Text = R["LastIdentificationCache"].ToString();
                        bool IsPartOf = false;
                        if (R["RelationType"].ToString() == "Part of" && !R["RelatedUnitID"].Equals(System.DBNull.Value)) 
                            IsPartOf = true;
                        string Code = R["TaxonomicGroup"].ToString();
                        bool IsTaxonomyRelatedTaxonomicGroup = false;
                        if (DiversityWorkbench.CollectionSpecimen.TaxonomyRelatedTaxonomicGroups.Contains(Code))
                        {
                            IsTaxonomyRelatedTaxonomicGroup = true;
                        }
                        bool Hide = false;
                        if (!IsTaxonomyRelatedTaxonomicGroup)
                            Hide = true;
                        if (IsPartOf)
                            Hide = true;


                        this.labelFamilyCache.Visible = !Hide;
                        this.textBoxFamilyCache.Visible = !Hide;
                        this.labelOrderCache.Visible = !Hide;
                        this.textBoxOrderCache.Visible = !Hide;
                        this.buttonEditOrderAndFamily.Visible = !Hide;
                        this.labelGender.Visible = !Hide;
                        this.comboBoxGender.Visible = !Hide;
                        this.labelLifeStage.Visible = !Hide;
                        this.comboBoxLifeStage.Visible = !Hide;
                        if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.ShowExsiccata)
                        {
                            this.tableLayoutPanelExsiccata.Visible = !Hide;
                            this.tableLayoutPanelExsiccataSeries.Visible = !Hide;
                            this.tableLayoutPanelExsiccataUnit.Visible = !Hide;
                            this.labelExsiccataAbbreviation.Visible = !Hide;
                        }
                        else
                        {
                            this.tableLayoutPanelExsiccata.Visible = false;
                            this.tableLayoutPanelExsiccataSeries.Visible = false;
                            this.tableLayoutPanelExsiccataUnit.Visible = false;
                            this.labelExsiccataAbbreviation.Visible = false;
                        }

                        bool CanUpdate = this.FormFunctions.getObjectPermissions(Table, "UPDATE");
                        if (CanUpdate 
                            && !IsPartOf
                            && this._Availability == DiversityCollection.CollectionSpecimen.AvailabilityState.Available) 
                            this.comboBoxTaxonomicGroup.Enabled = true;
                        else this.comboBoxTaxonomicGroup.Enabled = false;

                        this.setUnitDatawithholding();
                        //if (R["DataWithholdingReason"].Equals(System.DBNull.Value) || R["DataWithholdingReason"].ToString().Trim().Length == 0)
                        //{
                        //    this.pictureBoxWithholdUnit.Image = this.imageListDataWithholding.Images[1];
                        //    this.toolTip.SetToolTip(this.pictureBoxWithholdUnit, "Set the withholding reason for this organism");
                        //}
                        //else
                        //{
                        //    this.pictureBoxWithholdUnit.Image = this.imageListDataWithholding.Images[0];
                        //    this.toolTip.SetToolTip(this.pictureBoxWithholdUnit, "Withholding reason: " + R["DataWithholdingReason"].ToString());
                        //}

                        //Height = this.MinHeightOfControl(this.splitContainerOverviewExsiccata);
                        Height = 55;
                        if (Height < this.splitContainerOverviewUnitData.Height)
                            this.splitContainerOverviewUnitData.SplitterDistance = this.splitContainerOverviewUnitData.Height - Height;
                        int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
                        this.setExsiccateIdentificationSource(UnitID);
                        this.setBackgroudColorForPanel(this.splitContainerOverviewUnitData.Panel1, ColorOfActivatedPanel);
                        this.setBackgroudColorForPanel(this.splitContainerOverviewUnitData.Panel2, ColorOfActivatedPanel);
                        this.setBackgroudColorForPanel(this.splitContainerOverviewUnit.Panel1, ColorOfActivatedPanel);
                        this.setBackgroudColorForPanel(this.splitContainerOverviewUnit.Panel2, ColorOfActivatedPanel);
                        //this.splitContainerOverviewUnitData.Panel1.BackColor = ColorOfActivatedPanel;
                        this.splitContainerOverviewData.Visible = true;
                        break;
                    case "Identification":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewIdentificationAnalysis.Panel1Collapsed = false;
                        this.splitContainerOverviewIdentificationAnalysis.Panel2Collapsed = true;
                        this.splitContainerOverviewUnitData.Panel1Collapsed = false;
                        this.splitContainerOverviewUnitData.Panel2Collapsed = true;
                        this.splitContainerOverviewUnit.Panel1Collapsed = false;
                        this.splitContainerOverviewUnit.Panel2Collapsed = false;
                        this.splitContainerOverviewUnitPart.Panel1Collapsed = false;
                        this.splitContainerOverviewUnitPart.Panel2Collapsed = true;
                        this.splitContainerOverviewSpecimenDependent.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimenDependent.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimen.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimen.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = true;
                        this.splitContainerOverviewData.Panel1Collapsed = true;
                        this.splitContainerOverviewData.Panel2Collapsed = false;

                        HeightOfParentData = this.groupBoxUnit.MinimumSize.Height;
                        HeightMin = this.groupBoxOverviewIdentification.MinimumSize.Height;
                        Height = HeightMax - HeightOfParentData;
                        if (Height < HeightMin)
                            Height = HeightMin;
                        this.splitContainerOverviewUnit.SplitterDistance = this.splitContainerOverviewUnit.Height - Height + 30;

                        //Height = HeightMax - HeightOfParentData;// this.groupBoxOverviewIdentification.MinimumSize.Height + 10;
                        //if (Height < this.splitContainerOverviewUnit.Height)
                        //    this.splitContainerOverviewUnit.SplitterDistance = this.splitContainerOverviewUnit.Height - Height;
                        this.pictureBoxUnit.Left = this.groupBoxOverviewIdentification.Width - 20;
                        this.pictureBoxUnit.Image = DiversityCollection.Specimen.ImageList.Images[this.treeViewOverviewHierarchy.SelectedNode.Parent.ImageIndex];
                        this.groupBoxUnit.Text = this.treeViewOverviewHierarchy.SelectedNode.Parent.Text.Trim();
                        //this.splitContainerOverviewIdentificationAnalysis.Panel1.BackColor = ColorOfActivatedPanel;
                        this.setBackgroudColorForPanel(this.splitContainerOverviewIdentificationAnalysis.Panel1, ColorOfActivatedPanel);
                        this.splitContainerOverviewData.Visible = true;
                        break;
                    case "IdentificationUnitAnalysis":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewData.Panel1Collapsed = true;
                        this.splitContainerOverviewData.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = true;
                        this.splitContainerOverviewSpecimen.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimen.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenDependent.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimenDependent.Panel2Collapsed = false;
                        this.splitContainerOverviewUnitPart.Panel1Collapsed = false;
                        this.splitContainerOverviewUnitPart.Panel2Collapsed = true;
                        this.splitContainerOverviewUnit.Panel1Collapsed = false;
                        this.splitContainerOverviewUnit.Panel2Collapsed = false;
                        this.splitContainerOverviewUnitData.Panel1Collapsed = false;
                        this.splitContainerOverviewUnitData.Panel2Collapsed = true;
                        this.splitContainerOverviewIdentificationAnalysis.Panel1Collapsed = true;
                        this.splitContainerOverviewIdentificationAnalysis.Panel2Collapsed = false;
                        this.splitContainerOverviewAnalysis.Panel1Collapsed = false;
                        this.splitContainerOverviewAnalysis.Panel2Collapsed = true;
                        this.pictureBoxUnit.Left = this.groupBoxOverviewIdentification.Width - (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 20);
                        if (this.treeViewOverviewHierarchy.SelectedNode != null)
                        {
                            if (this.ShowAnalysisAsHierarchy)
                            {
                                this.pictureBoxUnit.Image = DiversityCollection.Specimen.ImageList.Images[this.treeViewOverviewHierarchy.SelectedNode.Parent.Parent.ImageIndex];
                                this.groupBoxUnit.Text = this.treeViewOverviewHierarchy.SelectedNode.Parent.Parent.Text.Trim();
                            }
                            else
                            {
                                this.pictureBoxUnit.Image = DiversityCollection.Specimen.ImageList.Images[this.treeViewOverviewHierarchy.SelectedNode.Parent.ImageIndex];
                                this.groupBoxUnit.Text = this.treeViewOverviewHierarchy.SelectedNode.Parent.Text.Trim();
                            }
                            this.groupBoxAnalysis.Text = this.treeViewOverviewHierarchy.SelectedNode.Text;
                            if (groupBoxAnalysis.Text.Length > 45) groupBoxAnalysis.Text = groupBoxAnalysis.Text.Substring(0, 45) + "...";
                            R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        }
                        else if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                        {
                            this.pictureBoxUnit.Image = DiversityCollection.Specimen.ImageList.Images[this.treeViewOverviewHierarchyStorage.SelectedNode.Parent.ImageIndex];
                            this.groupBoxAnalysis.Text = this.treeViewOverviewHierarchyStorage.SelectedNode.Text.Trim();
                            if (groupBoxAnalysis.Text.Length > 45) groupBoxAnalysis.Text = groupBoxAnalysis.Text.Substring(0, 45) + "...";
                            R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        }
                        else
                            R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        try
                        {
                            string MeasurementUnit = DiversityCollection.LookupTable.AnalysisMeasurementUnit(R["AnalysisID"].ToString());
                            if (MeasurementUnit.Length > 0)
                            {
                                this.labelAnalysisMeasurementUnit.Text = MeasurementUnit;
                                this.labelAnalysisMeasurementUnit.Visible = true;
                            }
                            else
                                this.labelAnalysisMeasurementUnit.Visible = false;
                            bool ListRestiction = DiversityCollection.LookupTable.AnalysisResultsAreRestrictedToList(int.Parse(R["AnalysisID"].ToString()));
                            if (ListRestiction)
                            {
                                this.textBoxAnalysisResult.Visible = false;
                                this.textBoxAnalysisResult.Dock = DockStyle.Right;
                                if (this.comboBoxAnalysisResult.DataSource == null)// || 1 == 1) // Test
                                {
                                    this._dtAnalysisResult = DiversityCollection.LookupTable.AnalysisResults();
                                    string Filter = "AnalysisID = " + R["AnalysisID"].ToString() + " OR AnalysisID IS NULL";
                                    this._dvAnalysisResult = new DataView(this._dtAnalysisResult, Filter, "", DataViewRowState.Unchanged);
                                    this.comboBoxAnalysisResult.DataSource = this._dvAnalysisResult;
                                    this.comboBoxAnalysisResult.DisplayMember = "DisplayText";
                                    this.comboBoxAnalysisResult.ValueMember = "AnalysisResult";
                                }
                                else
                                {
                                    this._dvAnalysisResult.RowFilter = "AnalysisID = " + R["AnalysisID"].ToString() + " OR AnalysisID IS NULL";
                                //    this.comboBoxAnalysisResult.DataSource = this._dvAnalysisResult;
                                //    this.comboBoxAnalysisResult.DisplayMember = "DisplayText";
                                //    this.comboBoxAnalysisResult.ValueMember = "AnalysisResult";
                                }
                                if (!R["AnalysisResult"].Equals(System.DBNull.Value))
                                {
                                    int i = 0;
                                    foreach (System.Data.DataRow AR in this._dtAnalysisResult.Rows)
                                    {
                                        if (!AR["AnalysisID"].Equals(System.DBNull.Value) &&
                                            AR["AnalysisID"].ToString().Length > 0 &&
                                            AR["AnalysisID"].ToString() != R["AnalysisID"].ToString())
                                            continue;
                                        if (AR["AnalysisResult"].ToString() == R["AnalysisResult"].ToString())
                                        {
                                            break;
                                        }
                                        i++;
                                    }
                                    this.comboBoxAnalysisResult.SelectedIndex = i;
                                }
                                this.comboBoxAnalysisResult.Dock = DockStyle.Fill;
                                this.comboBoxAnalysisResult.Visible = true;
                            }
                            else
                            {
                                this.textBoxAnalysisResult.Visible = true;
                                this.textBoxAnalysisResult.Dock = DockStyle.Fill;

                                this.comboBoxAnalysisResult.Visible = false;
                                this.comboBoxAnalysisResult.Dock = DockStyle.Left;
                            }
                        }
                        catch (System.Exception ex) { }

                        HeightOfParentData = this.groupBoxUnit.MinimumSize.Height;
                        HeightMin = this.groupBoxAnalysis.MinimumSize.Height;
                        Height = HeightMax - HeightOfParentData;
                        if (Height < HeightMin)
                            Height = HeightMin;
                        this.splitContainerOverviewUnit.SplitterDistance = this.splitContainerOverviewUnit.Height - Height + 30;

                        //if (Height < this.splitContainerOverviewUnit.Height)
                        //    this.splitContainerOverviewUnit.SplitterDistance = this.splitContainerOverviewUnit.Height - Height;
                        //Height = this.groupBoxAnalysis.MinimumSize.Height + 5;
                        ////if (!R["ToolUsage"].Equals(System.DBNull.Value)) 
                        //    Height += 82;
                        //if (Height < this.splitContainerOverviewUnit.Height)
                        //    this.splitContainerOverviewUnit.SplitterDistance = this.splitContainerOverviewUnit.Height - Height;

                        this.BuildAnalysisToolUsageTree();
                        this.setBackgroudColorForPanel(this.splitContainerOverviewIdentificationAnalysis.Panel2, ColorOfActivatedPanel);
                        this.splitContainerOverviewData.Visible = true;
                        break;
                    case "IdentificationUnitGeoAnalysis":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewData.Panel1Collapsed = true;
                        this.splitContainerOverviewData.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = true;
                        this.splitContainerOverviewSpecimen.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimen.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenDependent.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimenDependent.Panel2Collapsed = false;
                        this.splitContainerOverviewUnitPart.Panel1Collapsed = false;
                        this.splitContainerOverviewUnitPart.Panel2Collapsed = true;
                        this.splitContainerOverviewUnit.Panel1Collapsed = false;
                        this.splitContainerOverviewUnit.Panel2Collapsed = false;
                        this.splitContainerOverviewUnitData.Panel1Collapsed = false;
                        this.splitContainerOverviewUnitData.Panel2Collapsed = true;
                        this.splitContainerOverviewIdentificationAnalysis.Panel1Collapsed = true;
                        this.splitContainerOverviewIdentificationAnalysis.Panel2Collapsed = false;
                        this.splitContainerOverviewAnalysis.Panel1Collapsed = true;
                        this.splitContainerOverviewAnalysis.Panel2Collapsed = false;
                        this.pictureBoxUnit.Image = DiversityCollection.Specimen.ImageList.Images[this.treeViewOverviewHierarchy.SelectedNode.Parent.ImageIndex];
                        this.pictureBoxUnit.Left = this.groupBoxGeoAnalysis.Width - (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * 20);

                        HeightOfParentData = this.groupBoxUnit.MinimumSize.Height;
                        HeightMin = this.groupBoxGeoAnalysis.MinimumSize.Height;
                        Height = HeightMax - HeightOfParentData;
                        if (Height < HeightMin)
                            Height = HeightMin;
                        this.splitContainerOverviewUnit.SplitterDistance = this.splitContainerOverviewUnit.Height - Height + 30;

                        this.splitContainerImages.Panel1.Enabled = true;

                        //Height = this.groupBoxGeoAnalysis.MinimumSize.Height + 5;
                        //if (Height < this.splitContainerOverviewUnit.Height)
                        //    this.splitContainerOverviewUnit.SplitterDistance = this.splitContainerOverviewUnit.Height - Height;

                        this.setBackgroudColorForPanel(this.splitContainerOverviewAnalysis.Panel2, ColorOfActivatedPanel);
                        //bool GeoAnalysisHasGeography = false;

                        this.labelGeoAnalysisCoordinates.Text = "";
                        this.labelGeoAnalysisGeography.Text = "";

                        try
                        {
                            this.labelGeoAnalysisCoordinates.Text = "";
                            if (this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
                            {
                                R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                                //string Test = R["AnalysisDate"].ToString();
                                //string Text2 = this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo.Rows[1]["AnalysisDate"].ToString();
                                foreach (System.Data.DataRow RGeo in this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo.Rows)
                                {
                                    if (RGeo["AnalysisDate"].ToString() == R["AnalysisDate"].ToString())// &&!RGeo[3].Equals(System.DBNull.Value))
                                    {
                                        if (this.userControlGIS.Visible)
                                        {
                                            this.userControlGIS.DataRowIdentificationUnitGeoAnalysisGeo = RGeo;
                                            if (this.userControlGIS.SelectedGISObject != DiversityCollection.UserControls.UserControlGIS.SelectedGisObject.Distribution)
                                                this.userControlGIS.SelectedGISObject = DiversityCollection.UserControls.UserControlGIS.SelectedGisObject.Organism;
                                        }
                                        if (!RGeo["GeographyAsString"].Equals(System.DBNull.Value)
                                            && RGeo["GeographyAsString"].ToString().Length > 0)
                                        {
                                            string[] Geography = RGeo["GeographyAsString"].ToString().Split(new char[] { ' ' });
                                            this.labelGeoAnalysisCoordinates.Text = "Long.: " + Geography[1].Replace("(", "") + ", Lat.: " + Geography[2].Replace(")", "");
                                            this.labelGeoAnalysisGeography.Text = RGeo["GeographyAsString"].ToString();
                                        }
                                        else
                                        {
                                            this.labelGeoAnalysisCoordinates.Text = "";
                                            this.labelGeoAnalysisGeography.Text = "";
                                        }
                                        break;
                                    }
                                }
                            }
                            else this.labelGeoAnalysisCoordinates.Text = "";
                        }
                        catch (System.Exception ex) { }

                        this.splitContainerOverviewData.Visible = true;
                        break;

                    #endregion

                    #region Collection

                    case "Collection":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewPrintCollection.Panel1Collapsed = true;
                        this.splitContainerOverviewPrintCollection.Panel2Collapsed = false;
                        this.splitContainerOverviewLabel.Panel1Collapsed = false;
                        this.splitContainerOverviewLabel.Panel2Collapsed = true;
                        this.splitContainerOverviewData.Panel1Collapsed = true;
                        this.splitContainerOverviewData.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = false;
                        this.splitContainerOverviewPrint.Panel1Collapsed = false;
                        this.setBackgroudColorForPanel(this.splitContainerOverviewPrintCollection.Panel2, ColorOfActivatedPanel);
                        this.splitContainerOverviewData.Visible = true;
                        this.splitContainerOverviewPrint.Panel2Collapsed = true;
                        if (collectionBindingSource.Current != null)
                        {
                            bool OK = this.FormFunctions.getObjectPermissions("dbo.ManagerCollectionList", "EXECUTE");
                            if (!OK) this.tableLayoutPanelCollection.Enabled = false;
                            else
                            {
                                System.Data.DataRowView RV = (System.Data.DataRowView)collectionBindingSource.Current;
                                int CollectionID;
                                if (int.TryParse(RV["CollectionID"].ToString(), out CollectionID))
                                {
                                    if (DiversityCollection.LookupTable.IsManagedCollection(CollectionID))
                                        this.tableLayoutPanelCollection.Enabled = true;
                                    else
                                        this.tableLayoutPanelCollection.Enabled = false;
                                }
                                else
                                    this.tableLayoutPanelCollection.Enabled = false;
                            }
                        }
                        else
                            this.tableLayoutPanelCollection.Enabled = false;
                        break;

                    #endregion

                    #region Printing etc.

                    case "PrintSpecimen":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewLabel.Panel1Collapsed = false;
                        this.splitContainerOverviewLabel.Panel2Collapsed = true;
                        goto case "Print";
                    case "PrintSpecimenPart":
                        this.splitContainerOverviewData.Visible = false;
                        this.splitContainerOverviewLabel.Panel1Collapsed = false;
                        this.splitContainerOverviewLabel.Panel2Collapsed = false;
                        goto case "Print";
                    case "Print":
                        this.splitContainerOverviewPrintCollection.Panel1Collapsed = false;
                        this.splitContainerOverviewPrintCollection.Panel2Collapsed = true;
                        this.splitContainerOverviewData.Panel1Collapsed = true;
                        this.splitContainerOverviewData.Panel2Collapsed = false;
                        this.splitContainerOverviewSpecimenPrint.Panel1Collapsed = true;
                        this.splitContainerOverviewSpecimenPrint.Panel2Collapsed = false;
                        this.splitContainerOverviewPrint.Panel1Collapsed = false;
                        this.splitContainerOverviewPrint.Panel2Collapsed = false;
                        this.splitContainerOverviewData.Visible = true;
                        break;

                    #endregion

                    case "Regulation":
                    case "CollectionEventRegulation":
                    case "CollectionSpecimenPartRegulation":
                        // obsolet
                        //this.splitContainerUserContols.Panel1Collapsed = true;
                        //this.splitContainerUserContols.Panel2Collapsed = false;
                        //this.splitContainerUserContols.Panel2.Controls.Clear();
                        //if (Table == "CollectionSpecimenPartRegulation")
                        //    R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        //else
                        //    R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        //string Regulation = R["Regulation"].ToString();
                        //DiversityWorkbench.Regulation.Regulation Reg = null;
                        //bool ReadOnly = false;
                        //if (R.Table.Columns.Contains("ProjectURI") && !R["ProjectURI"].Equals(System.DBNull.Value) && R["ProjectURI"].ToString().Length > 0)
                        //{
                        //    System.Uri U = new Uri(R["ProjectURI"].ToString());
                        //    ReadOnly = true;
                        //    Reg = new DiversityWorkbench.Regulation.Regulation(U, Regulation);
                        //}
                        //else
                        //{
                        //    Reg = new DiversityWorkbench.Regulation.Regulation(Regulation);
                        //}
                        //if (Reg != null)
                        //{
                        //    DiversityWorkbench.Regulation.UserControlRegulation UC = Reg.UserControlRegulation(DiversityWorkbench.Regulation.UserControlRegulation.DesignVersion.Default, ReadOnly);// new DiversityWorkbench.Regulation.UserControlRegulation(Reg, DiversityWorkbench.Regulation.UserControlRegulation.DesignVersion.Default, true);
                        //    UC.Dock = DockStyle.Fill;
                        //    this.splitContainerUserContols.Panel2.Controls.Add(UC);
                        //}
                        break;

                    default:
                        this.splitContainerOverviewData.Visible = false;
                        break;
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setBackgroudColorForPanel(System.Windows.Forms.Panel P, System.Drawing.Color Color)
        {
            foreach (System.Windows.Forms.Control C in P.Controls)
            {
                if (C.GetType() == typeof(System.Windows.Forms.GroupBox))
                    C.BackColor = Color;
            }
        }

        private void setBindingContext(System.Data.DataRow DataRow)
        {
            string Table = DataRow.Table.TableName;
            int i = 0;
            System.Data.DataTable dt = DataRow.Table;
            foreach (System.Data.DataRow r in dt.Rows)
            {
                if (dt.Rows[i] != DataRow) i++;
                else break;
            }
            switch (Table)
            {
                case "Collection":
                    this.collectionBindingSource.Position = i;
                    break;
                case "CollectionEventSeries":
                    System.Data.DataSet DS = (System.Data.DataSet)this.collectionEventSeriesBindingSource.DataSource;
                    System.Data.DataTable DT = DS.Tables["CollectionEventSeries"];
                    int iSeries = 0;// = this.collectionEventSeriesBindingSource.Position;
                    int SeriesID;// = (int)this.SeriesID;
                    if (int.TryParse(DataRow[0].ToString(), out SeriesID))
                    {
                        //this.SeriesID = SeriesID;
                        this._SeriesID = SeriesID;
                        foreach (System.Data.DataRow R in DT.Rows)
                        {
                            if (R[0].ToString() != SeriesID.ToString()) 
                                iSeries++;
                            else break;
                        }
                        this.collectionEventSeriesBindingSource.Position = iSeries;
                    }
                    //foreach (System.Data.DataRow R in this.dataSetCollectionEventSeries.CollectionEventSeries.Rows)
                    //{
                    //    if (R[0].ToString() != SeriesID.ToString()) iSeries++;
                    //    else break;
                    //}
                    //if (this.ShowEventSeriesHierarchy)
                    //    this.collectionEventSeriesBindingSource.Position = iSeries;
                    //else 
                    //    this.collectionEventSeriesBindingSource.Position = i;
                    break;
                //case "CollectionEvent":
                //    this.collectionEventBindingSource.Position = i;
                //    break;
                case "CollectionEventLocalisation":
                    this.collectionEventLocalisationBindingSource.Position = i;
                    try
                    {
                        System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                        int iLocSyst;
                        if (int.TryParse(R[1].ToString(), out iLocSyst))
                        {
                            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Select("LocalisationSystemID = " + iLocSyst.ToString());
                            if (rr.Length > 0)
                            {
                                for (int ii = 0; ii < this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Rows.Count; ii++)
                                {
                                    if (this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Rows[ii]["LocalisationSystemID"].ToString() == iLocSyst.ToString())
                                    {
                                        this.CollectionEventLocalisationGeoBindingSource.Position = ii;
                                        break;
                                    }
                                }

                            }
                        }
                    }
                    catch
                    {
                    }
                    break;
                case "CollectionEventProperty":
                    this.collectionEventPropertyBindingSource.Position = i;
                    break;
                //case "CollectionSpecimen":
                //    this.collectionSpecimenBindingSource.Position = i;
                //    break;
                case "CollectionAgent":
                    this.collectionAgentBindingSource.Position = i;
                    break;
                case "CollectionSpecimenReference":
                    this.collectionSpecimenReferenceBindingSource.Position = i;
                    break;
                case "CollectionSpecimenRelation":
                    this.collectionSpecimenRelationBindingSource.Position = i;
                    break;
                case "CollectionSpecimenRelationInvers":
                    //this.Position = i;
                    break;
                case "IdentificationUnit":
                    this.identificationUnitBindingSource.Position = i;
                    break;
                case "Identification":
                    this.identificationBindingSource.Position = i;
                    break;
                case "IdentificationUnitAnalysis":
                    this.identificationUnitAnalysisBindingSource.Position = i;
                    this.listBoxAnalysisMethod.DataSource = this.dvIdentificationUnitAnalysisMethod;
                    this.listBoxAnalysisMethodParameter.DataSource = this.dvIdentificationUnitAnalysisMethodParameter;
                    this.listBoxAnalysisMethod_SelectedIndexChanged(null, null);
                    break;
                case "IdentificationUnitGeoAnalysis":
                    this.identificationUnitGeoAnalysisBindingSource.Position = i;
                    break;
                case "IdentificationUnitInPart":
                    int PartID = 0;
                    if (int.TryParse(DataRow["SpecimenPartID"].ToString(), out PartID))
                    {
                        i = 0;
                        foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows)
                        {
                            if (R.RowState == DataRowState.Deleted)
                                continue;
                            if (R["SpecimenPartID"].ToString() == PartID.ToString())
                                break;
                            i++;
                        }
                    }
                    this.collectionSpecimenPartBindingSource.Position = i;
                    break;
                case "CollectionSpecimenPart":
                    this.collectionSpecimenPartBindingSource.Position = i;
                    break;
                case "CollectionSpecimenProcessing":
                    this.collectionSpecimenProcessingBindingSource.Position = i;
                    this.listBoxProcessingMethods.DataSource = this.dvCollectionSpecimenProcessingMethod;
                    this.listBoxProcessingMethodParameter.DataSource = this.dvCollectionSpecimenProcessingMethodParameter;
                    this.listBoxProcessingMethods_SelectedIndexChanged(null, null);
                    break;
                case "CollectionSpecimenTransaction":
                    this.collectionSpecimenTransactionBindingSource.Position = i;
                    break;
            }
        }
        
        #endregion

        #region Identifier

        public System.Data.DataTable IdentifierTable()
        {
            return this.dataSetCollectionSpecimen.ExternalIdentifier;
        }

        public void UpdateIdentifierTable()
        {
            try
            {
                bool DataWhereChanged = false;
                bool DataWhereDeleted = false;
                foreach (System.Data.DataRow RR in this.dataSetCollectionSpecimen.ExternalIdentifier.Rows)
                {
                    if (RR.RowState != DataRowState.Unchanged && RR.RowState != DataRowState.Deleted)
                    {
                        DataWhereChanged = true;
                        RR.BeginEdit();
                        RR.EndEdit();
                    }
                    else if (RR.RowState == DataRowState.Deleted)
                        DataWhereDeleted = true;
                }
                if (DataWhereChanged || DataWhereDeleted)
                {
                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "ExternalIdentifier", this.sqlDataAdapterIdentifier, this.BindingContext);
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void DisplayIdentifier(System.Windows.Forms.TreeNode N, System.Windows.Forms.TreeView Tree)
        {
            try
            {
                //System.Drawing.Image I = Tree.ImageList.Images[N.ImageIndex];
                //System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                //System.Data.DataTable dtIdentifierType = new DataTable();
                //string SqlIdentifierType = "SELECT Type FROM ExternalIdentifierType ORDER BY Type";//, 'Reference')";
                //System.Data.SqlClient.SqlDataAdapter adSqlIdentifierType = new System.Data.SqlClient.SqlDataAdapter(SqlIdentifierType, DiversityWorkbench.Settings.ConnectionString);
                //adSqlIdentifierType.Fill(dtIdentifierType);
                //string DisplayText = R["Title"].ToString();
                //try
                //{
                //    DisplayText = N.Parent.Text;
                //}
                //catch (System.Exception ex) { }

                //DiversityWorkbench.Forms.FormAnnotation f = new DiversityWorkbench.Forms.FormAnnotation(
                //    this,
                //    R["ReferencedTable"].ToString(),
                //    int.Parse(R["ReferencedID"].ToString()),
                //    R,
                //    dtIdentifierType,
                //    this.helpProviderDiversityCollection.HelpNamespace,
                //    DisplayText,
                //    I);//,                    ref this.sqlDataAdapterAnnotation);
                //f.ShowDialog();
                //this.UpdateIdentifierTable();

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #region Annotation

        public System.Data.DataTable AnnotationTable()
        {
            return this.dataSetCollectionSpecimen.Annotation;
        }

        public void UpdateAnnotationTable()
        {
            try
            {
                bool DataWhereChanged = false;
                bool DataWhereDeleted = false;
                foreach (System.Data.DataRow RR in this.dataSetCollectionSpecimen.Annotation.Rows)
                {
                    if (RR.RowState != DataRowState.Unchanged && RR.RowState != DataRowState.Deleted)
                    {
                        DataWhereChanged = true;
                        RR.BeginEdit();
                        RR.EndEdit();
                    }
                    else if (RR.RowState == DataRowState.Deleted)
                        DataWhereDeleted = true;
                }
                if (DataWhereChanged || DataWhereDeleted)
                {
                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "Annotation", this.sqlDataAdapterAnnotation, this.BindingContext);
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void DisplayAnnotation(System.Windows.Forms.TreeNode N, System.Windows.Forms.TreeView Tree)
        {
            try
            {
                System.Drawing.Image I = Tree.ImageList.Images[N.ImageIndex];
                System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                System.Data.DataTable dtAnnotationType = new DataTable();
                string SqlAnnotationType = "SELECT Code FROM AnnotationType_Enum WHERE Code in ('Annotation', 'Problem')";//, 'Reference')";
                System.Data.SqlClient.SqlDataAdapter adSqlAnnotationType = new System.Data.SqlClient.SqlDataAdapter(SqlAnnotationType, DiversityWorkbench.Settings.ConnectionString);
                adSqlAnnotationType.Fill(dtAnnotationType);
                string DisplayText = R["Title"].ToString();
                try
                {
                    DisplayText = N.Parent.Text;
                }
                catch (System.Exception ex) { }

                DiversityWorkbench.Forms.FormAnnotation f = new DiversityWorkbench.Forms.FormAnnotation(
                    this,
                    R["ReferencedTable"].ToString(),
                    int.Parse(R["ReferencedID"].ToString()),
                    R,
                    dtAnnotationType,
                    this.helpProviderDiversityCollection.HelpNamespace,
                    DisplayText,
                    I);//,                    ref this.sqlDataAdapterAnnotation);
                f.ShowDialog();



                /// sollte nicht notwendig sein, da im Formular beim Schliessen erledigt
                this.UpdateAnnotationTable();

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }
        
        #endregion

        #region EventSeries

        private void toolStripButtonOverviewHierarchyAssignEventSeries_Click(object sender, EventArgs e)
        {
            System.Data.SqlClient.SqlConnection Con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            DiversityCollection.FormCollectionEventSeries f = new FormCollectionEventSeries();
            f.ShowDialog();
            if (f.DialogResult == System.Windows.Forms.DialogResult.OK)// && f.ID != null)
            {
                try
                {
                    if (f.ID != null)
                        this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"] = (int)f.ID;// EventSeriesID;
                    else
                        this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"] = System.DBNull.Value;
                    this.fillEventSeries();
                    this.updateSpecimen();
                    this.buildOverviewHierarchyUnits();
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void toolStripButtonOverviewHierarchyNewEventSeries_Click(object sender, EventArgs e)
        {
            int EventSeriesID = 0;
            string SQL = "INSERT INTO CollectionEventSeries (Description, SeriesParentID) " +
                "VALUES ('New EventSeries', ";
            try
            {
                if (this.dataSetCollectionEventSeries.CollectionEventSeries.Rows.Count > 0)
                {
                    if (this.treeViewOverviewHierarchy.SelectedNode == null)
                    {
                        System.Windows.Forms.MessageBox.Show("Please select an event series group where the new event series should be inserted");
                        return;
                    }
                    try
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        EventSeriesID = int.Parse(r["SeriesID"].ToString());
                        SQL += EventSeriesID.ToString();
                    }
                    catch
                    {
                        System.Windows.Forms.MessageBox.Show("Please select an EventSeries / collection event group where the new EventSeries / collection event group should be inserted");
                        return;
                    }
                }
                else
                {
                    SQL += " NULL ";
                }
                SQL += ") SELECT SCOPE_IDENTITY() AS [SCOPE_IDENTITY]";
                System.Data.SqlClient.SqlConnection c = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                System.Data.SqlClient.SqlCommand cmd = new System.Data.SqlClient.SqlCommand(SQL, c);
                c.Open();
                int i = int.Parse(cmd.ExecuteScalar().ToString());
                c.Close();
                if (this.ShowEventSeriesHierarchy)
                {
                    DiversityCollection.Datasets.DataSetCollectionEventSeries.CollectionEventSeriesRow R
                        = (DiversityCollection.Datasets.DataSetCollectionEventSeries.CollectionEventSeriesRow)this.dataSetCollectionEventSeries.CollectionEventSeries.NewRow();
                    R["SeriesID"] = i;
                    R["Description"] = "New EventSeries";
                    this.dataSetCollectionEventSeries.CollectionEventSeries.Rows.Add(R);
                    this.FormFunctions.updateTable(this.dataSetCollectionEventSeries, "CollectionEventSeries", this.sqlDataAdapterEventSeries, this.collectionEventSeriesBindingSource);
                }
                else if (this.ShowEventSeries)
                {
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventSeriesRow R
                        = (DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventSeriesRow)this.dataSetCollectionSpecimen.CollectionEventSeries.NewRow();
                    R["SeriesID"] = i;
                    R["Description"] = "New EventSeries";
                    this.dataSetCollectionSpecimen.CollectionEventSeries.Rows.Add(R);
                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionEventSeries", this.sqlDataAdapterEventSeries, this.collectionEventSeriesBindingSource);
                }
                if (this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"].Equals(System.DBNull.Value))
                {
                    this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["SeriesID"] = i;
                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionEvent", this.sqlDataAdapterEvent, this.BindingContext);
                }
                this.fillEventSeries();
                if (!this.ShowEventSeriesHierarchy)
                {
                    if (this.toolStripDropDownButtonOverviewHierarchyShowSeries.Tag == HierachyDisplayStyle.Hidden.ToString())
                        this.toolStripDropDownButtonOverviewHierarchyShowSeries.Tag = HierachyDisplayStyle.Parents;
                    this.toolStripDropDownButtonOverviewHierarchyShowSeries.Visible = true;
                    this.setEventSeriesDisplayMode(this.toolStripMenuItemOverviewHierarchyShowSeriesParents);
                    this.buildOverviewHierarchyUnits();
                    //this.toolStripButtonOverviewHierarchyShowEventSeriesHierarchy.Visible = true;
                    //this.toolStripButtonOverviewHierarchyShowEventSeriesHierarchy.Tag = "Hide";
                    //this.toolStripButtonOverviewHierarchyShowEventSeriesHierarchy_Click(null, null);
                }
                else
                    this.buildOverviewHierarchyUnits();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonOverviewHierarchySamplingPlot_Click(object sender, EventArgs e)
        {
            if (this.toolStripButtonOverviewHierarchySamplingPlot.Tag != null
                && this.toolStripButtonOverviewHierarchySamplingPlot.Tag.ToString().Length > 0)
            {
                string URI = toolStripButtonOverviewHierarchySamplingPlot.Tag.ToString();
                System.Uri Uri = new Uri(toolStripButtonOverviewHierarchySamplingPlot.Tag.ToString());
                DiversityWorkbench.SamplingPlot S = new DiversityWorkbench.SamplingPlot(DiversityWorkbench.Settings.ServerConnection, Uri);
                DiversityWorkbench.FormRemoteQuery f = new DiversityWorkbench.FormRemoteQuery(URI, S);
                f.ShowDialog();
            }
        }
        
        private void dateTimePickerCollectionEventSeriesStart_CloseUp(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventSeriesBindingSource.Current;
            R["DateStart"] = this.dateTimePickerCollectionEventSeriesStart.Value;
            this.textBoxCollectionEventSeriesDate.Text = this.dateTimePickerCollectionEventSeriesStart.Value.ToShortDateString() + " " + this.dateTimePickerCollectionEventSeriesStart.Value.ToShortTimeString();
        }

        private void dateTimePickerCollectionEventSeriesStart_DropDown(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventSeriesBindingSource.Current;
            if (!R["DateStart"].Equals(System.DBNull.Value))
            {
                System.DateTime Start;
                if (System.DateTime.TryParse(R["DateStart"].ToString(), out Start))
                    this.dateTimePickerCollectionEventSeriesStart.Value = Start;
            }
        }

        private void textBoxCollectionEventSeriesDate_Validating(object sender, CancelEventArgs e)
        {
            if (textBoxCollectionEventSeriesDate.Text.Length == 0)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventSeriesBindingSource.Current;
                R["DateStart"] = System.DBNull.Value;
            }
            else
            {
                System.DateTime Date;
                if (!System.DateTime.TryParse(textBoxCollectionEventSeriesDate.Text, out Date))
                {
                    System.Windows.Forms.MessageBox.Show(textBoxCollectionEventSeriesDate.Text + " is not a valid date");
                }
            }
        }

        private void dateTimePickerCollectionEventSeriesEnd_DropDown(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventSeriesBindingSource.Current;
            if (!R["DateEnd"].Equals(System.DBNull.Value))
            {
                System.DateTime Start;
                if (System.DateTime.TryParse(R["DateEnd"].ToString(), out Start))
                    this.dateTimePickerCollectionEventSeriesEnd.Value = Start;
            }
        }

        private void dateTimePickerCollectionEventSeriesEnd_CloseUp(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventSeriesBindingSource.Current;
            R["DateEnd"] = this.dateTimePickerCollectionEventSeriesEnd.Value;
            this.textBoxCollectionEventSeriesEnd.Text = this.dateTimePickerCollectionEventSeriesEnd.Value.ToShortDateString() + " " + this.dateTimePickerCollectionEventSeriesEnd.Value.ToShortTimeString();
        }

        private void textBoxCollectionEventSeriesEnd_Validating(object sender, CancelEventArgs e)
        {
            if (textBoxCollectionEventSeriesEnd.Text.Length == 0)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventSeriesBindingSource.Current;
                R["DateEnd"] = System.DBNull.Value;
            }
            else
            {
                System.DateTime Date;
                if (!System.DateTime.TryParse(textBoxCollectionEventSeriesEnd.Text, out Date))
                {
                    System.Windows.Forms.MessageBox.Show(textBoxCollectionEventSeriesEnd.Text + " is not a valid date");
                }
            }
        }

        #endregion

        #region EventSeriesImage

        private void comboBoxEventSeriesImageWithholdingReason_DropDown(object sender, EventArgs e)
        {
            string SQL = "SELECT DISTINCT DataWithholdingReason FROM CollectionEventSeriesImage ORDER BY DataWithholdingReason";
            System.Data.DataTable dt = new DataTable();
            try
            {
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                this.comboBoxEventSeriesImageWithholdingReason.DataSource = dt;
                this.comboBoxEventSeriesImageWithholdingReason.DisplayMember = "DataWithholdingReason";
                this.comboBoxEventSeriesImageWithholdingReason.ValueMember = "DataWithholdingReason";
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }
        
        #endregion

        #region Event

        private void comboBoxDataWithholdingReasonEvent_DropDown(object sender, EventArgs e)
        {
            string SQL = "SELECT DISTINCT DataWithholdingReason FROM CollectionEvent ORDER BY DataWithholdingReason";
            System.Data.DataTable dt = new DataTable();
            try
            {
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                this.comboBoxDataWithholdingReasonEvent.DataSource = dt;
                this.comboBoxDataWithholdingReasonEvent.DisplayMember = "DataWithholdingReason";
                this.comboBoxDataWithholdingReasonEvent.ValueMember = "DataWithholdingReason";
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonCountryEditing_Click(object sender, EventArgs e)
        {
            System.Data.DataTable dt = DiversityWorkbench.Gazetteer.Countries();
            if (dt.Rows.Count > 0 && dt.Columns.Count == 2)
            {
                string ValueColumn = dt.Columns[0].ColumnName;
                string DisplayColumn = dt.Columns[1].ColumnName;
                DiversityWorkbench.FormGetStringFromList f = new DiversityWorkbench.FormGetStringFromList(dt, DisplayColumn, ValueColumn, "Select a country", "Please select a country from the list", this.textBoxCountryCache.Text, false, true);
                f.ShowDialog();
                if (f.DialogResult == DialogResult.OK)
                {
                    this.textBoxCountryCache.Text = f.SelectedValue;
                    this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CountryCache"] = f.SelectedValue;
                }
            }
            else
            {
                DiversityWorkbench.FormEditText f = new DiversityWorkbench.FormEditText("Edit the country", this.textBoxCountryCache.Text);
                f.ShowDialog();
                if (f.DialogResult == DialogResult.OK)
                {
                    this.textBoxCountryCache.Text = f.EditedText;
                    this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CountryCache"] = f.EditedText;
                }
            }
        }

        #region toolStrip

        private void toolStripButtonOverviewHierarchyAssignEvent_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.dataSetCollectionSpecimen.CollectionEvent.Rows.Count > 0)
                {
                    string Message = "Do you want to remove the specimen from the collection event ";
                    if (!this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["LocalityDescription"].Equals(System.DBNull.Value)
                        && this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["LocalityDescription"].ToString().Length > 0)
                        Message += "\r\n" + this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["LocalityDescription"].ToString();
                    if (System.Windows.Forms.MessageBox.Show(Message, "CollectionEvent", MessageBoxButtons.YesNo) == DialogResult.No)
                        return;
                }
                DiversityCollection.FormCollectionEvent f = new FormCollectionEvent();
                f.ShowDialog();
                if (f.DialogResult == System.Windows.Forms.DialogResult.OK && f.ID != null)
                {
                    this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"] = int.Parse(f.ID.ToString());
                    this.updateSpecimen();
                    this.setEvent();
                    this.buildOverviewHierarchyUnits();
                    this.setEventControls();
                }
                else if (!this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].Equals(System.DBNull.Value))
                {
                    string Message = "Do you want to remove the specimen from the collection event ";
                    if (System.Windows.Forms.MessageBox.Show(Message, "CollectionEvent", MessageBoxButtons.YesNo) == DialogResult.Yes)
                    {
                        this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"] = System.DBNull.Value;
                        this.updateSpecimen();
                        this.setEvent();
                        this.buildOverviewHierarchyUnits();
                        this.setEventControls();
                    }
               }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonOverviewHierarchyNewEvent_Click(object sender, EventArgs e)
        {
            try
            {
                string SQL = "INSERT INTO CollectionEvent (LocalityDescription)VALUES (NULL) (SELECT SCOPE_IDENTITY() AS [SCOPE_IDENTITY])";
                System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                System.Data.SqlClient.SqlCommand cmd = new System.Data.SqlClient.SqlCommand(SQL, con);
                con.Open();
                int EventID = System.Int32.Parse(cmd.ExecuteScalar().ToString());
                con.Close();
                con.Dispose();
                this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"] = EventID;
                this.setEvent();
                this.setEventControls();
                this.buildOverviewHierarchyUnits();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }
        
        #endregion

        #endregion

        #region EventLocalisation

        private void prepareToolStripDropDownButtonsEventLocalisation()
        {
            try
            {
                if (this.toolStripDropDownButtonOverviewHierarchyNewEventLocalisation.DropDownItems.Count > 0)
                    this.toolStripDropDownButtonOverviewHierarchyNewEventLocalisation.DropDownItems.Clear();
                foreach (System.Data.DataRow R in DiversityCollection.LookupTable.DtLocalisationSystem.Rows)
                {
                    if (R["LocalisationSystemParentID"].Equals(System.DBNull.Value)
                        || R["LocalisationSystemParentID"].ToString() != "7")
                    {
                        string Caption = R["LocalisationSystemName"].ToString();
                        string Entity = "LocalisationSystem.LocalisationSystemID." + R["LocalisationSystemID"].ToString();
                        System.Collections.Generic.Dictionary<string, string> E = DiversityWorkbench.Entity.EntityInformation(Entity, "General", DiversityWorkbench.Settings.Language);
                        if (E[DiversityWorkbench.Entity.EntityInformationField.DisplayTextOK.ToString()] == "True")
                            Caption = E["DisplayText"];
                        System.Windows.Forms.ToolStripMenuItem mi = new System.Windows.Forms.ToolStripMenuItem(Caption, null, menuItemOverviewHierarchyEventLocalisationOnClick);
                        mi.Tag = R["LocalisationSystemID"];
                        int LocalisationSystemID;
                        if (int.TryParse(R["LocalisationSystemID"].ToString(), out LocalisationSystemID))
                            mi.Image = DiversityCollection.Specimen.ImageForLocalisationSystem(LocalisationSystemID);
                        else
                            mi.Image = global::DiversityCollection.Resource.Localisation;
                        this.toolStripDropDownButtonOverviewHierarchyNewEventLocalisation.DropDownItems.Add(mi);
                        if (R["LocalisationSystemID"].ToString() == "7")
                        {
                            System.Windows.Forms.ToolStripMenuItem mi7added = new System.Windows.Forms.ToolStripMenuItem("add. " + Caption);
                            mi7added.Image = mi.Image;
                            this.toolStripDropDownButtonOverviewHierarchyNewEventLocalisation.DropDownItems.Add(mi7added);
                            int i = 2;
                            foreach (System.Data.DataRow R7 in DiversityCollection.LookupTable.DtLocalisationSystem.Rows)
                            {
                                if (!R7["LocalisationSystemParentID"].Equals(System.DBNull.Value)
                                    && R7["LocalisationSystemParentID"].ToString() == "7"
                                    && R7["LocalisationSystemID"].ToString() != "7")
                                {
                                    Caption = R7["LocalisationSystemName"].ToString();
                                    Entity = "LocalisationSystem.LocalisationSystemID." + R7["LocalisationSystemID"].ToString();
                                    System.Collections.Generic.Dictionary<string, string> E7 = DiversityWorkbench.Entity.EntityInformation(Entity, "General", DiversityWorkbench.Settings.Language);
                                    if (E7[DiversityWorkbench.Entity.EntityInformationField.DisplayTextOK.ToString()] == "True")
                                        Caption = E7["DisplayText"];
                                    System.Windows.Forms.ToolStripMenuItem mi7 = new System.Windows.Forms.ToolStripMenuItem(i.ToString() + ". " + Caption, null, menuItemOverviewHierarchyEventLocalisationOnClick);
                                    mi7.Tag = R7["LocalisationSystemID"];
                                    mi7.Image = mi.Image;
                                    mi7added.DropDownItems.Add(mi7);
                                    i++;
                                }
                            }
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setToolStripDropDownButtonsEventLocalisationVisibilty()
        {
            try
            {
                System.Collections.Generic.List<int> IDs = new List<int>();
                foreach (DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventLocalisationRow R in this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows)
                    if (R.RowState != DataRowState.Detached && R.RowState != DataRowState.Deleted) IDs.Add(R.LocalisationSystemID);
                foreach (System.Windows.Forms.ToolStripDropDownItem T in this.toolStripDropDownButtonOverviewHierarchyNewEventLocalisation.DropDownItems)
                {
                    T.Enabled = true;
                    if (T.DropDownItems.Count > 0)
                    {
                        foreach (System.Windows.Forms.ToolStripDropDownItem TT in T.DropDownItems)
                            TT.Enabled = true;
                    }
                }
                foreach (System.Windows.Forms.ToolStripDropDownItem T in this.toolStripDropDownButtonOverviewHierarchyNewEventLocalisation.DropDownItems)
                {
                    if (T.Tag != null)
                    {
                        int ID = int.Parse(T.Tag.ToString());
                        if (IDs.Contains(ID))
                            T.Enabled = false;
                        if (!DiversityCollection.LookupTable.LocalisationVisible(ID))
                            T.Enabled = false;
                    }
                    else if (T.DropDownItems.Count > 0)
                    {
                        foreach (System.Windows.Forms.ToolStripDropDownItem TT in T.DropDownItems)
                        {
                            int ID = int.Parse(TT.Tag.ToString());
                            if (IDs.Contains(ID))
                                TT.Enabled = false;
                            if (!DiversityCollection.LookupTable.LocalisationVisible(ID))
                                TT.Enabled = false;
                        }
                    }
                }
            }
            catch (System.Exception ex) { }
        }

        private void setEventLocalisationControls(System.Data.DataRow DataRow)
        {
            string ParsingMethodName;
            string LocalisationSystem;
            if (DataRow == null)
            {
                this.splitContainerOverviewEventLocProp.Panel1Collapsed = true;
            }
            else
            {
                this.splitContainerOverviewEventLocProp.Panel1Collapsed = false;
                int LocalisationSystemID = 0;
                if (int.TryParse(DataRow["LocalisationSystemID"].ToString(), out LocalisationSystemID))
                {
                    ParsingMethodName = DiversityCollection.LookupTable.ParsingMethodName(LocalisationSystemID);
                    LocalisationSystem = DiversityCollection.LookupTable.LocalisationSystemName(LocalisationSystemID);
                    try
                    {
                        System.Data.DataRow[] rr = DiversityCollection.LookupTable.DtLocalisationSystem.Select("LocalisationSystemID = " + LocalisationSystemID.ToString());
                        if (rr.Length > 0)
                        {
                            System.Data.DataRow r = rr[0];
                            this.labelLocation1.Text = r["DisplayTextLocation1"].ToString();
                            if (this.labelLocation1.Text.Length > 11)
                                this.labelLocation1.Text = this.labelLocation1.Text.Substring(0, 10) + ".";
                            this.labelLocation2.Text = r["DisplayTextLocation2"].ToString();
                            if (this.labelLocation2.Text.Length > 11)
                                this.labelLocation2.Text = this.labelLocation2.Text.Substring(0, 10) + ".";
                            this.toolTip.SetToolTip(this.textBoxLocation1, r["DescriptionLocation1"].ToString());
                            this.toolTip.SetToolTip(this.textBoxLocation2, r["DescriptionLocation2"].ToString());

                            this.labelLocation1Custom.Text = r["DisplayTextLocation1"].ToString();
                            this.labelLocation2Custom.Text = r["DisplayTextLocation2"].ToString();
                            this.toolTip.SetToolTip(this.textBoxLocation1a, r["DescriptionLocation1"].ToString());
                            this.toolTip.SetToolTip(this.textBoxLocation2a, r["DescriptionLocation2"].ToString());

                            this.setGeographyCustomUnitList(ParsingMethodName);

                            if (this.comboBoxGeographyLocationUnits.Items.Count > 0) 
                                this.comboBoxGeographyLocationUnits.Visible = true;
                            else this.comboBoxGeographyLocationUnits.Visible = false;
                            this.buttonGetCoordinatesFromGoogleMaps.Visible = false;
                            this.buttonCoordinatesConvert.Visible = false;
                            this.textBoxGeography.Visible = false;
                            if (this.textBoxGeography.Text.Length > 0)
                                this.textBoxGeography.Visible = true;

                            switch (ParsingMethodName)
                            {
                                case "Altitude":
                                    this.userControlModuleRelatedEntryGazetteer.Visible = false;
                                    this.userControlModuleRelatedEntrySamplingPlot.Visible = false;
                                    this.tableLayoutPanelGeographyLocationStandard.Visible = true;
                                    this.tableLayoutPanelGeographyLocation.Visible = true;

                                    this.labelLocationDirection.Visible = false;
                                    this.textBoxLocationDirection.Visible = false;
                                    this.labelLocationDistance.Visible = false;
                                    this.textBoxLocationDistance.Visible = false;

                                    this.labelLongitudeCache.Visible = false;
                                    this.labelLatitudeCache.Visible = false;
                                    this.textBoxLongitudeCache.Visible = false;
                                    this.textBoxLatitudeCache.Visible = false;
                                    this.labelAltitudeCache.Visible = true;
                                    this.textBoxAltitudeCache.Visible = true;
                                    break;
                                case "Coordinates":
                                    this.userControlModuleRelatedEntryGazetteer.Visible = false;
                                    this.userControlModuleRelatedEntrySamplingPlot.Visible = false;
                                    this.tableLayoutPanelGeographyLocation.Visible = true;
                                    this.tableLayoutPanelGeographyLocationStandard.Visible = true;
                                    if (LocalisationSystem == "Coordinates WGS84")
                                    {
                                        this.buttonGetCoordinatesFromGoogleMaps.Visible = true;
                                        this.textBoxGeography.Visible = true;
                                    }
                                    this.textBoxAltitudeCache.Visible = false;
                                    this.labelAltitudeCache.Visible = false;
                                    this.buttonCoordinatesConvert.Visible = true;
                                    goto default;
                                case "Gazetteer":
                                    this.tableLayoutPanelGeographyLocation.Visible = false;
                                    this.tableLayoutPanelGeographyLocationStandard.Visible = false;
                                    this.userControlModuleRelatedEntryGazetteer.Visible = true;
                                    this.userControlModuleRelatedEntrySamplingPlot.Visible = false;
                                    goto default;
                                case "SamplingPlot":
                                    this.tableLayoutPanelGeographyLocation.Visible = false;
                                    this.tableLayoutPanelGeographyLocationStandard.Visible = false;
                                    this.userControlModuleRelatedEntryGazetteer.Visible = false;
                                    this.userControlModuleRelatedEntrySamplingPlot.Visible = true;
                                    goto default;
                                case "RD":
                                case "GK":
                                    this.userControlModuleRelatedEntryGazetteer.Visible = false;
                                    this.userControlModuleRelatedEntrySamplingPlot.Visible = false;
                                    this.tableLayoutPanelGeographyLocation.Visible = true;
                                    this.tableLayoutPanelGeographyLocationStandard.Visible = true;
                                    goto default;
                                case "MTB":
                                    this.buttonGetCoordinatesFromGoogleMaps.Visible = true;
                                    this.userControlModuleRelatedEntrySamplingPlot.Visible = false;
                                    this.userControlModuleRelatedEntryGazetteer.Visible = false;
                                    this.tableLayoutPanelGeographyLocation.Visible = true;
                                    this.tableLayoutPanelGeographyLocationStandard.Visible = true;
                                    this.textBoxGeography.Visible = true;
                                    goto default;
                                case "Height":
                                case "Depth":
                                case "Exposition":
                                case "Slope":
                                    this.userControlModuleRelatedEntryGazetteer.Visible = false;
                                    this.userControlModuleRelatedEntrySamplingPlot.Visible = false;
                                    this.tableLayoutPanelGeographyLocation.Visible = true;
                                    this.tableLayoutPanelGeographyLocationStandard.Visible = true;

                                    this.labelLocationDirection.Visible = false;
                                    this.textBoxLocationDirection.Visible = false;
                                    this.labelLocationDistance.Visible = false;
                                    this.textBoxLocationDistance.Visible = false;

                                    this.labelAltitudeCache.Visible = false;
                                    this.labelLongitudeCache.Visible = false;
                                    this.labelLatitudeCache.Visible = false;
                                    this.textBoxLongitudeCache.Visible = false;
                                    this.textBoxLatitudeCache.Visible = false;
                                    this.textBoxAltitudeCache.Visible = false;

                                    break;
                                case "Top50":
                                    goto default;
                                default:
                                    this.labelLocationDirection.Visible = true;
                                    this.textBoxLocationDirection.Visible = true;
                                    this.labelLocationDistance.Visible = true;
                                    this.textBoxLocationDistance.Visible = true;
                                    this.labelLongitudeCache.Visible = true;
                                    this.labelLatitudeCache.Visible = true;
                                    this.textBoxLongitudeCache.Visible = true;
                                    this.textBoxLatitudeCache.Visible = true;
                                    break;
                            }
                        }
                        else // ensure correct display of old systems that are not used any more
                        {
                            System.Data.DataTable dtLocSys = new DataTable();
                            string SQL = "SELECT * FROM LocalisationSystem L WHERE L.LocalisationSystemID = " + LocalisationSystemID.ToString();
                            System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                            ad.Fill(dtLocSys);
                            if (dtLocSys.Rows.Count == 1)
                            {
                                this.labelLocation1.Text = dtLocSys.Rows[0]["DisplayTextLocation1"].ToString();
                                if (this.labelLocation1.Text.Length > 11)
                                    this.labelLocation1.Text = this.labelLocation1.Text.Substring(0, 10) + ".";
                                this.labelLocation2.Text = dtLocSys.Rows[0]["DisplayTextLocation2"].ToString();
                                if (this.labelLocation2.Text.Length > 11)
                                    this.labelLocation2.Text = this.labelLocation2.Text.Substring(0, 10) + ".";
                                this.toolTip.SetToolTip(this.textBoxLocation1, dtLocSys.Rows[0]["DescriptionLocation1"].ToString());
                                this.toolTip.SetToolTip(this.textBoxLocation2, dtLocSys.Rows[0]["DescriptionLocation2"].ToString());

                                this.labelLocation1Custom.Text = dtLocSys.Rows[0]["DisplayTextLocation1"].ToString();
                                this.labelLocation2Custom.Text = dtLocSys.Rows[0]["DisplayTextLocation2"].ToString();
                                this.toolTip.SetToolTip(this.textBoxLocation1a, dtLocSys.Rows[0]["DescriptionLocation1"].ToString());
                                this.toolTip.SetToolTip(this.textBoxLocation2a, dtLocSys.Rows[0]["DescriptionLocation2"].ToString());
                            }
                            //this.splitContainerGeography.Panel2.Visible = false;
                        }
                    }
                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                }
            }
        }
        
        private void menuItemOverviewHierarchyEventLocalisationOnClick(object sender, System.EventArgs e)
        {
            try
            {
                if (this.collectionEventLocalisationBindingSource.Current != null)
                {
                    this.labelHeaderID.Focus();
                    System.Data.DataRowView RC = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                    RC.BeginEdit();
                    RC.EndEdit();
                }

                System.Windows.Forms.ToolStripMenuItem m = (System.Windows.Forms.ToolStripMenuItem)sender;
                int LocalisationSystemID = 0;
                if (int.TryParse(m.Tag.ToString(), out LocalisationSystemID))
                {
                    try
                    {
                        if (!this.ShowEventLocalisation) this.toolStripButtonOverviewHierarchyShowEventLocalisation_Click(null, null);
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventLocalisationRow R
                            = (DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventLocalisationRow)this.dataSetCollectionSpecimen.CollectionEventLocalisation.NewRow();
                        R.CollectionEventID = int.Parse(this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionEventID"].ToString());
                        R.LocalisationSystemID = LocalisationSystemID;
                        R.Location1 = m.Text;
                        if (Specimen.DefaultUseLocalisationResponsible)
                        {
                            R.ResponsibleName = Specimen.DefaultResponsibleName;
                            R.ResponsibleAgentURI = Specimen.DefaultResponsibleURI;
                        }
                        this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows.Add(R);
                        this.updateSpecimen();
                        this.buildOverviewHierarchyUnits();
                        this.setEventLocalisationControls(R);
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "CollectionEventLocalisation", this.treeViewOverviewHierarchy, ref Nodes);
                        this.treeViewOverviewHierarchy.SelectedNode = Nodes[Nodes.Count - 1];
                        this.setToolStripDropDownButtonsEventLocalisationVisibilty();
                        this.treeViewOverviewHierarchy.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, R);
                        //this.moveToHierarchyNode(R, this.treeViewOverviewHierarchy);
                    }
                    catch (System.Data.ConstraintException x)
                    {
                        string Message = sender.ToString();
                        if (Message.StartsWith("New ")) Message = Message.Substring(4);
                        System.Windows.Forms.MessageBox.Show("There can only be one " + Message);// + "\r\n" + x.Message);
                    }
                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonGetCoordinatesFromGoogleMaps_Click(object sender, EventArgs e)
        {
            try
            {
                CultureInfo InvC = new CultureInfo("");
                string ParsingMethodName = "";
                string LocalisationSystem = "";
                int LocalisationSystemID = 0;
                System.Data.DataRowView RLoc = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;

                // get the current Localisation system
                if (int.TryParse(RLoc["LocalisationSystemID"].ToString(), out LocalisationSystemID))
                {
                    ParsingMethodName = DiversityCollection.LookupTable.ParsingMethodName(LocalisationSystemID);
                    LocalisationSystem = DiversityCollection.LookupTable.LocalisationSystemName(LocalisationSystemID);
                }

                // try to find existing Coordinates
                bool OK = false;
                double la = 0.0;
                double lo = 0.0;
                string Lat = this.textBoxLocation2.Text.ToString(InvC).Replace(",", ".");
                string Long = this.textBoxLocation1.Text.ToString(InvC).Replace(",", ".");
                if (Lat.Length > 0 && Long.Length > 0 && ParsingMethodName != "MTB")
                {
                    OK = true;
                    if (!double.TryParse(Lat, NumberStyles.Float, InvC, out la)) OK = false;
                    if (!double.TryParse(Long, NumberStyles.Float, InvC, out lo)) OK = false;
                }
                else if (ParsingMethodName == "MTB")
                {
                    Lat = this.textBoxLatitudeCache.Text.ToString(InvC).Replace(",", ".");
                    Long = this.textBoxLongitudeCache.Text.ToString(InvC).Replace(",", ".");
                    OK = true;
                    if (!double.TryParse(Lat, NumberStyles.Float, InvC, out la)) OK = false;
                    if (!double.TryParse(Long, NumberStyles.Float, InvC, out lo)) OK = false;
                }
                if (!OK)
                {
                    // try to find existing coordinates
                    System.Data.DataRow[] rrC = this.dataSetCollectionSpecimen.CollectionEventLocalisation.Select("AverageLatitudeCache <> 0 AND AverageLongitudeCache <> 0");
                    if (rrC.Length > 0)
                    {
                        OK = true;
                        if (!double.TryParse(rrC[0]["AverageLatitudeCache"].ToString(), NumberStyles.Float, InvC, out la)) OK = false;
                        if (!OK) OK = double.TryParse(rrC[0]["AverageLatitudeCache"].ToString().Replace(".", ","), NumberStyles.Float, InvC, out la);
                        if (!OK) OK = double.TryParse(rrC[0]["AverageLatitudeCache"].ToString().Replace(",", "."), NumberStyles.Float, InvC, out la);
                        if (la > 180) la = 0.0;

                        if (!double.TryParse(rrC[0]["AverageLongitudeCache"].ToString(), NumberStyles.Float, InvC, out lo)) OK = false;
                        if (!OK) OK = double.TryParse(rrC[0]["AverageLongitudeCache"].ToString().Replace(".", ","), NumberStyles.Float, InvC, out lo);
                        if (!OK) OK = double.TryParse(rrC[0]["AverageLongitudeCache"].ToString().Replace(",", "."), NumberStyles.Float, InvC, out lo);
                        if (lo > 90) lo = 0.0;
                    }
                }

                // get the correct form
                if (LocalisationSystem == "Coordinates WGS84")
                {
                    DiversityWorkbench.FormGoogleMapsCoordinates f;


                    if (OK) f = new DiversityWorkbench.FormGoogleMapsCoordinates(la, lo);
                    else f = new DiversityWorkbench.FormGoogleMapsCoordinates(0.0, 0.0);
                    f.ShowDialog();
                    if (f.DialogResult == DialogResult.OK)
                    {
                        try
                        {
                            if (f.Longitude < 360 && f.Longitude > -360 && f.Latitude < 90 && f.Latitude > -90 && f.LatitudeAccuracy != 0.0 && f.LongitudeAccuracy != 0.0)
                            {

                                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                                R["Location1"] = f.Longitude.ToString("F09", InvC);
                                this.textBoxLocation1.Text = f.Longitude.ToString("F09", InvC);
                                R["Location2"] = f.Latitude.ToString("F09", InvC);
                                this.textBoxLocation2.Text = f.Latitude.ToString("F09", InvC);
                                R["LocationAccuracy"] = f.Accuracy.ToString("F00", InvC) + " m";
                                this.textBoxLocationAccuracy.Text = f.Accuracy.ToString("F00", InvC) + " m";
                                R["AverageLongitudeCache"] = f.Longitude;
                                this.textBoxLongitudeCache.Text = f.Longitude.ToString("F09", InvC);
                                R["AverageLatitudeCache"] = f.Latitude;
                                this.textBoxLatitudeCache.Text = f.Latitude.ToString("F09", InvC);

                                /// TODO:
                                /// geonames is not available any more
                                /// implement alternativ via OpenStreetMaps
                                //System.Collections.Generic.Dictionary<DiversityWorkbench.GeoFunctions.GeoInfo, string> GeoInfos = DiversityWorkbench.GeoFunctions.getGeoInfos(f.Latitude, f.Longitude);
                                //if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Altitude))
                                //    R["AverageAltitudeCache"] = float.Parse(GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Altitude]);

                                string Notes = "";
                                if (!R["LocationNotes"].Equals(System.DBNull.Value)) Notes = R["LocationNotes"].ToString();
                                if (Notes.Length > 0)
                                {
                                    if (Notes.IndexOf("Derived from Google Maps") == -1)
                                        Notes += ". Derived from Google Maps";
                                }
                                else
                                    Notes = "Derived from Google Maps";
                                R["LocationNotes"] = Notes;
                                this.textBoxLocationNotes.Text = Notes;

                                System.Data.DataRow[] rrGeo = this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Select("LocalisationSystemID = " + R["LocalisationSystemID"].ToString());
                                if (rrGeo.Length == 1)
                                {
                                    if (rrGeo[0][2].ToString().StartsWith("POINT"))
                                    {
                                        string Geo = "POINT (" + f.Longitude.ToString("F09", InvC) + " " + f.Latitude.ToString("F09", InvC) + ")";
                                        rrGeo[0][2] = Geo;
                                        rrGeo[0][3] = Geo;
                                    }
                                }

                                /// TODO:
                                /// geonames is not available any more
                                /// implement alternative via OpenStreetMaps
                                if (1 == 1)// 2) 
                                {

                                    System.Collections.Generic.Dictionary<DiversityWorkbench.GeoFunctions.GeoInfo, string> GeoInfos = DiversityWorkbench.GeoFunctions.getGeoInfos(f.Latitude, f.Longitude);

                                    // insert Gazetteer entry if missing
                                    System.Data.DataRow[] rrGaz = this.dataSetCollectionSpecimen.CollectionEventLocalisation.Select("LocalisationSystemID = 7");
                                    if (GeoInfos.Count > 0
                                        && rrGaz.Length == 0
                                        && GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.PlaceName))
                                    {
                                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventLocalisationRow RGazetteer = this.dataSetCollectionSpecimen.CollectionEventLocalisation.NewCollectionEventLocalisationRow();
                                        RGazetteer.CollectionEventID = int.Parse(this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionEventID"].ToString());
                                        RGazetteer.LocalisationSystemID = 7;
                                        string Place = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.PlaceName];
                                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.City)
                                            && GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.City] != GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.PlaceName])
                                            Place += ", " + GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.City];
                                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.CountrySubdivision))
                                            Place += ", " + GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.CountrySubdivision];
                                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Country))
                                            Place += ", " + GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Country];
                                        RGazetteer.Location1 = Place;
                                        RGazetteer.LocationNotes = "Source: " + GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Source];
                                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Latitude))
                                            RGazetteer.AverageLatitudeCache = float.Parse(GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Latitude]);
                                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Longitude))
                                            RGazetteer.AverageLongitudeCache = float.Parse(GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Longitude]);
                                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Distance))
                                        {
                                            RGazetteer.LocationAccuracy = f.Accuracy.ToString("F00", InvC) + " m";
                                            RGazetteer.DistanceToLocation = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Distance];
                                        }
                                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Direction))
                                            RGazetteer.DirectionToLocation = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Direction];
                                        this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows.Add(RGazetteer);
                                    }
                                    else if (GeoInfos.Count > 0
                                        && rrGaz.Length == 1
                                        && rrGaz[0]["LocationNotes"].ToString().Contains(DiversityWorkbench.GeoFunctions.GeoInfoSource)
                                        && GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.PlaceName))
                                    {
                                        string Place = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.PlaceName];
                                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.City)
                                            && GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.City] != GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.PlaceName])
                                            Place += ", " + GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.City];
                                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.CountrySubdivision))
                                            Place += ", " + GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.CountrySubdivision];
                                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Country))
                                            Place += ", " + GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Country];
                                        rrGaz[0]["Location1"] = Place;
                                        rrGaz[0]["LocationNotes"] = "Source: " + GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Source];
                                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Latitude))
                                            rrGaz[0]["AverageLatitudeCache"] = float.Parse(GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Latitude]);
                                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Longitude))
                                            rrGaz[0]["AverageLongitudeCache"] = float.Parse(GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Longitude]);
                                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Distance))
                                        {
                                            rrGaz[0]["LocationAccuracy"] = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Distance];
                                            rrGaz[0]["DistanceToLocation"] = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Distance];
                                        }
                                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Direction))
                                            rrGaz[0]["DirectionToLocation"] = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Direction];
                                    }

                                    // insert altitude entry if missing
                                    System.Data.DataRow[] rrAlt = this.dataSetCollectionSpecimen.CollectionEventLocalisation.Select("LocalisationSystemID = 4");
                                    if (GeoInfos.Count > 0
                                        && rrAlt.Length == 0
                                        && GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Altitude))
                                    {
                                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventLocalisationRow RAltitude = this.dataSetCollectionSpecimen.CollectionEventLocalisation.NewCollectionEventLocalisationRow();
                                        RAltitude.CollectionEventID = int.Parse(this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionEventID"].ToString());
                                        RAltitude.LocalisationSystemID = 4;
                                        RAltitude.Location1 = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Altitude];
                                        RAltitude.AverageAltitudeCache = float.Parse(GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Altitude]);
                                        RAltitude.LocationNotes = "Source: " + GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.AltitudeSource];
                                        this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows.Add(RAltitude);
                                    }
                                    else if (GeoInfos.Count > 0
                                        && rrAlt.Length == 1
                                        && rrAlt[0]["LocationNotes"].ToString().Contains(DiversityWorkbench.GeoFunctions.GeoInfoSource)
                                        && GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Altitude))
                                    {
                                        rrAlt[0]["Location1"] = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Altitude];
                                        rrAlt[0]["AverageAltitudeCache"] = float.Parse(GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Altitude]);
                                        rrAlt[0]["LocationNotes"] = "Source: " + GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.AltitudeSource];
                                    }
                                    // setting the countryCache
                                    if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Country))
                                        this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CountryCache"] = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Country];
                                    this.saveSpecimen(null, null);

                                }
                            }
                        }
                        catch (Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        }
                    }
                }
                else if (ParsingMethodName == "MTB")//LocalisationSystem == "MTB (A, CH, D)")
                {
                    System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.CollectionEventLocalisation.Select("");
                    if (RR.Length > 0)
                    {
                        string ConnectionString = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnection.ConnectionString;
                        foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KVconn in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList())
                        {
                            if (KVconn.Value.ConnectionString.Length > 0)
                                ConnectionString = KVconn.Value.ConnectionString;
                            if (KVconn.Value.DatabaseServer.ToLower() == "tnt.diversityworkbench.de")
                                break;
                            if (KVconn.Value.LinkedServer == "TNT.DIVERSITYWORKBENCH.DE,5432" && KVconn.Value.DatabaseName == "DiversityGazetteer2")
                            {
                                ConnectionString = KVconn.Value.ConnectionString;
                                break;
                            }
                        }



                        if (lo > 0 && la > 0)
                        {
                            DiversityWorkbench.FormTK25 f;
                            int iTest = 0;
                            if (!RLoc["Location2"].Equals(System.DBNull.Value) && RLoc["Location2"].ToString().Length > 0)
                            {
                                f = new DiversityWorkbench.FormTK25(RLoc["Location1"].ToString(), RLoc["Location2"].ToString(), ConnectionString);
                            }
                            else if (!RLoc["Location1"].Equals(System.DBNull.Value) && RLoc["Location1"].ToString().Length > 0 && int.TryParse(RLoc["Location1"].ToString(), out iTest))
                            {
                                f = new DiversityWorkbench.FormTK25(RLoc["Location1"].ToString(), RLoc["Location2"].ToString(), /*(float)lo, (float)la,*/ ConnectionString);
                            }
                            else
                                f = new DiversityWorkbench.FormTK25((float)lo, (float)la, ConnectionString);
                            try
                            {
                                f.ShowDialog();
                                if (f.DialogResult == DialogResult.OK)
                                {
                                    RLoc["Location1"] = f.TK25;
                                    this.textBoxLocation1.Text = f.TK25;

                                    RLoc["Location2"] = f.TK25_Quadrant;
                                    this.textBoxLocation2.Text = f.TK25_Quadrant;

                                    RLoc["LocationNotes"] = f.TK25_Name;
                                    this.textBoxLocationNotes.Text = f.TK25_Name;

                                    RLoc["AverageLatitudeCache"] = f.AverageLatitude;
                                    this.textBoxLatitudeCache.Text = f.AverageLatitude.ToString("F09", InvC);

                                    RLoc["AverageLongitudeCache"] = f.AverageLongitude;
                                    this.textBoxLongitudeCache.Text = f.AverageLongitude.ToString("F09", InvC);

                                    if (f.Geography != null)
                                    {
                                        System.Data.DataRow[] RRGeo = this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Select("CollectionEventID = " + RLoc["CollectionEventID"].ToString() + " AND LocalisationSystemID = " + RLoc["LocalisationSystemID"].ToString());
                                        if (RRGeo.Length == 1)
                                        {
                                            RRGeo[0]["GeographyAsString"] = f.Geography;
                                            this.textBoxGeography.Text = f.Geography;
                                            this.textBoxGeography.ReadOnly = true;
                                        }
                                    }
                                }
                            }
                            catch (System.Exception ex) { }
                        }
                        else
                        {
                            string TK25 = RLoc["Location1"].ToString();
                            string TK25_Quadrant = RLoc["Location2"].ToString();
                            DiversityWorkbench.FormTK25 f = new DiversityWorkbench.FormTK25(TK25, TK25_Quadrant, ConnectionString);
                            try
                            {
                                f.ShowDialog();
                                if (f.DialogResult == DialogResult.OK)
                                {
                                    RLoc["LocationNotes"] = f.TK25_Name;
                                    this.textBoxLocationNotes.Text = f.TK25_Name;

                                    RLoc["Location1"] = f.TK25;
                                    this.textBoxLocation1.Text = f.TK25;

                                    RLoc["Location2"] = f.TK25_Quadrant;
                                    this.textBoxLocation2.Text = f.TK25_Quadrant;

                                    RLoc["AverageLatitudeCache"] = f.AverageLatitude;
                                    this.textBoxLatitudeCache.Text = f.AverageLatitude.ToString("F09", InvC);

                                    RLoc["AverageLongitudeCache"] = f.AverageLongitude;
                                    this.textBoxLongitudeCache.Text = f.AverageLongitude.ToString("F09", InvC);

                                    System.Data.DataRow[] RRGeo = this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Select("CollectionEventID = " + RLoc["CollectionEventID"].ToString() + " AND LocalisationSystemID = " + RLoc["LocalisationSystemID"].ToString());
                                    if (RRGeo.Length == 1 && f.Geography != null)
                                        RRGeo[0]["GeographyAsString"] = f.Geography;
                                }
                            }
                            catch (System.Exception ex) { }
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void dateTimePickerLocalisationDate_CloseUp(object sender, EventArgs e)
        {
            if (this.collectionEventLocalisationBindingSource.Current != null)
            {
                try
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                    R["DeterminationDate"] = this.dateTimePickerLocalisationDate.Value.Date.ToShortDateString();
                    this.textBoxGeographyDeterminationDate.Text = this.dateTimePickerLocalisationDate.Value.Date.ToShortDateString();
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void textBoxGeographyDeterminationDate_Validating(object sender, CancelEventArgs e)
        {
            if (this.textBoxGeographyDeterminationDate.Text.Length == 0)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                R.BeginEdit();
                R["DeterminationDate"] = System.DBNull.Value;
                R.EndEdit();
                //this.textBoxLocationNotes.Focus();
            }
        }

        private void textBoxLocation1_Leave(object sender, EventArgs e)
        {
            if (this.collectionEventLocalisationBindingSource.Current != null)
            {
                System.Data.DataRowView RV = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                string Test = RV["Location1"].ToString();
                string NewText = this.textBoxLocation1.Text;
                int i = 0;
                if (!RV["Location1"].Equals(System.DBNull.Value)
                    && RV["Location1"].ToString() != this.textBoxLocation1.Text)//                    && RV["Location1"].ToString() != "New Altitude (mNN)"
                {
                    if (RV["Location1"].ToString() == "New Altitude (mNN)" || RV["Location1"].ToString() == "Altitude (mNN)" || RV["Location1"].ToString().IndexOf("Altitude") > -1)
                        RV["Location1"] = this.textBoxLocation1.Text;
                    else if (!RV["Location1"].Equals(System.DBNull.Value)
                        && int.TryParse(RV["Location1"].ToString(), out i)
                        && RV["Location1"].ToString() != this.textBoxLocation1.Text)//   
                    {
                        RV["Location1"] = this.textBoxLocation1.Text;
                    }
                    bool OK = this.TryToSaveAndCalculateAverageForLocalisation(false);
                    if (OK && this.TryToSaveGeography() && NewText.Length > 0)
                    {
                        if (RV["Location1"].ToString() != NewText)
                            RV["Location1"] = NewText;
                    }
                }
            }
        }

        private void textBoxLocation1_TextChanged(object sender, EventArgs e)
        {
            //if (this.collectionEventLocalisationBindingSource.Current != null)
            //{
            //    System.Data.DataRowView RV = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
            //    string Test = RV["Location1"].ToString();
            //    if (!RV["Location1"].Equals(System.DBNull.Value)
            //        && RV["Location1"].ToString() != this.textBoxLocation1.Text//                    && RV["Location1"].ToString() != "New Altitude (mNN)"
            //        )
            //    {
            //        if (RV["Location1"].ToString() == "New Altitude (mNN)" || RV["Location1"].ToString() == "Altitude (mNN)" || RV["Location1"].ToString().IndexOf("Altitude") > -1)
            //            RV["Location1"] = this.textBoxLocation1.Text;
            //        //RV.BeginEdit();
            //        //RV["Location1"] = this.textBoxLocation1.Text;
            //        //RV.EndEdit();
            //        // wird von Triggern erledigt
            //        this.TryToSaveAndCalculateAverageForLocalisation(false);
            //    }
            //}
        }

        private void textBoxLocation2_Leave(object sender, EventArgs e)
        {
            if (this.collectionEventLocalisationBindingSource.Current != null)
            {
                int i = 0;
                double d = 0;
                System.Data.DataRowView RV = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                if (RV["Location2"].Equals(System.DBNull.Value) && int.TryParse(this.textBoxLocation2.Text, out i))
                {
                    RV["Location2"] = i.ToString();
                }
                else if (!RV["Location2"].Equals(System.DBNull.Value) 
                    && int.TryParse(RV["Location2"].ToString(), out i)
                    && RV["Location2"].ToString() != this.textBoxLocation2.Text)//                    && RV["Location2"].ToString() != this.textBoxLocation2.Text)
                {
                    RV["Location2"] = this.textBoxLocation2.Text;
                }
                else if (double.TryParse(this.textBoxLocation2.Text, out d)
                    && RV["Location2"].ToString() != this.textBoxLocation2.Text)
                {
                    RV["Location2"] = this.textBoxLocation2.Text;
                }
                else if (double.TryParse(this.textBoxLocation2.Text.Replace(",", "."), out d)
                    && RV["Location2"].ToString().Replace(",", ".") != this.textBoxLocation2.Text.Replace(",", "."))
                {
                    RV["Location2"] = this.textBoxLocation2.Text;
                }
                this.TryToSaveAndCalculateAverageForLocalisation(false);
                this.TryToSaveGeography();
            }
        }

        private void textBoxLocation2_TextChanged(object sender, EventArgs e)
        {
            //if (this.collectionEventLocalisationBindingSource.Current != null)
            //{
            //    System.Data.DataRowView RV = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
            //    if (!RV["Location2"].Equals(System.DBNull.Value)
            //        && RV["Location2"].ToString() != this.textBoxLocation2.Text)
            //    {
            //        this.TryToSaveAndCalculateAverageForLocalisation(false);
            //    }
            //}
        }

        private bool TryToSaveAndCalculateAverageForLocalisation(bool FromDataRow)
        {
            CultureInfo InvC = new CultureInfo("");

            string Loc1 = this.textBoxLocation1.Text;
            string Loc2 = this.textBoxLocation2.Text;
            System.Data.DataRowView RV = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
            if (FromDataRow)
            {
                if (RV["Location1"].Equals(System.DBNull.Value)) Loc1 = "";
                else Loc1 = RV["Location1"].ToString();
                if (RV["Location2"].Equals(System.DBNull.Value)) Loc2 = "";
                else Loc2 = RV["Location2"].ToString();
            }
            int LocSysID;
            if (!int.TryParse(RV["LocalisationSystemID"].ToString(), out LocSysID)) 
                return false;
            string LocalisationSystem = DiversityCollection.LookupTable.LocalisationSystemName(LocSysID);
            switch (LocalisationSystem)
            {
                case "mNN (barometric)":
                case "Altitude (mNN)":
                    double? _AltFrom = null;
                    double? _AltTo = null;
                    double? _AltAvg = null;

                    double AltFrom;
                    double AltTo;
                    if (Loc1.Length == 0) _AltFrom = null;
                    else
                    {
                        if (!double.TryParse(Loc1, NumberStyles.Float, InvC, out AltFrom))
                        {
                            if (!double.TryParse(Loc1.Replace(",", "."), NumberStyles.Float, InvC, out AltFrom))
                                return false;
                        }
                        _AltFrom = AltFrom;
                    }
                    if (Loc2.Length == 0) _AltTo = null;
                    else
                    {
                        if (!double.TryParse(Loc2, NumberStyles.Float, InvC, out AltTo))
                        {
                            if (!double.TryParse(Loc2.Replace(",", "."), NumberStyles.Float, InvC, out AltTo))
                                return false;
                        }
                        _AltTo = AltTo;
                    }
                    if (_AltTo != null && _AltFrom != null) _AltAvg = (_AltFrom + _AltTo) / 2;
                    else if (_AltTo != null && _AltFrom == null) _AltAvg = _AltTo;
                    else if (_AltTo == null && _AltFrom != null) _AltAvg = _AltFrom;
                    if (_AltAvg != null)
                    {
                        RV["AverageAltitudeCache"] = _AltAvg;
                        if (this.labelAltitudeCache.Text != RV["AverageAltitudeCache"].ToString())
                            this.textBoxAltitudeCache.Text = RV["AverageAltitudeCache"].ToString();
                    }
                    break;
                case "Coordinates":
                case "Coordinates WGS84":
                    double Lat = 0;
                    double Long = 0;
                    if (Loc1.Length > 0)
                    {
                        if (!double.TryParse(Loc1, NumberStyles.Float, InvC, out Long))
                        {
                            if (!double.TryParse(Loc1.Replace(",", "."), NumberStyles.Float, InvC, out Long))
                                return false;
                        }
                        RV["AverageLongitudeCache"] = Long;
                        this.textBoxLongitudeCache.Text = Long.ToString();
                    }
                    if (Loc2.Length > 0)
                    {
                        if (!double.TryParse(Loc2, NumberStyles.Float, InvC, out Lat))
                        {
                            if (!double.TryParse(Loc2.Replace(",", "."), NumberStyles.Float, InvC, out Lat))
                                return false;
                        }
                        RV["AverageLatitudeCache"] = Lat;
                        this.textBoxLatitudeCache.Text = Lat.ToString();
                    }
                    break;
                default:
                    break;
            }
            return true;
        }

        private bool TryToSaveGeography()
        {
            try
            {
                System.Data.DataRowView RV = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                int LocSysID;
                int EventID;
                if (!int.TryParse(RV["LocalisationSystemID"].ToString(), out LocSysID)) 
                    return false;
                if (!int.TryParse(RV["CollectionEventID"].ToString(), out EventID)) 
                    return false;
                string ParsingMethod = DiversityCollection.LookupTable.LocalisationSystemParingMethod(LocSysID);

                if (ParsingMethod == "Coordinates")
                {
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Select("GeographyAsString <> '' AND LocalisationSystemID = " + LocSysID.ToString() + " AND CollectionEventID = " + EventID.ToString());
                    if (rr.Length == 1)
                    {
                        string SQL = "UPDATE CollectionEventLocalisation SET Geography = geography::STGeomFromText('" + rr[0][2].ToString() + "', 4326) " +
                            "WHERE CollectionEventID = " + rr[0][0].ToString() + " AND LocalisationSystemID = " + rr[0][1].ToString() + " AND (CollectionEventLocalisation.Geography IS NULL OR CollectionEventLocalisation.Geography.ToString() LIKE 'POINT%')";
                        string Message = "";
                        DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL, ref Message);
                        if (Message.Length > 0)
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile("TryToSaveGeography()", SQL, Message);
                        this.textBoxGeography.Text = rr[0][2].ToString();
                        this.textBoxGeography.ReadOnly = true;
                    }
                }
            }
            catch (System.Exception ex) 
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                return false;
            }
            return true;
        }

        private void buttonCoordinatesConvertToWGS84_Click(object sender, EventArgs e)
        {
            if (this.collectionEventLocalisationBindingSource.Current != null)
            {
                DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventLocalisationRow R = (DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventLocalisationRow)this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows[this.collectionEventLocalisationBindingSource.Position];
                DiversityCollection.Forms.FormGeoConversion f = new DiversityCollection.Forms.FormGeoConversion(R, ref this.dataSetCollectionSpecimen);
                f.StartPosition = FormStartPosition.CenterParent;
                f.ShowDialog();
                if (f.DialogResult == DialogResult.OK)
                {
                    this.buildOverviewHierarchyUnits();
                }
            }
        }

        private void comboBoxLocalisationRecordingMethod_DropDown(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                string LocalisationSystemID = R["LocalisationSystemID"].ToString();
                string SQL = "SELECT DISTINCT RecordingMethod " +
                    "FROM CollectionEventLocalisation " +
                    "WHERE LocalisationSystemID = " + LocalisationSystemID +
                    " AND RecordingMethod LIKE N'" + this.comboBoxLocalisationRecordingMethod.Text + "%' " +
                    "ORDER BY RecordingMethod";
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                System.Data.DataTable dt = new DataTable();
                ad.Fill(dt);
                this.comboBoxLocalisationRecordingMethod.DataSource = dt;
                this.comboBoxLocalisationRecordingMethod.DisplayMember = "RecordingMethod";
                this.comboBoxLocalisationRecordingMethod.ValueMember = "RecordingMethod";
            }
            catch { }
        }

        #region Custom units

        private void textBoxLocation2c_KeyPress(object sender, KeyPressEventArgs e)
        {
            //if (e.KeyChar == ',')
            //{
            //    e.Handled = true;
            //    (sender as TextBox).AppendText(".");
            //}
        }

        private void comboBoxGeographyLocationUnits_SelectedIndexChanged(object sender, EventArgs e)
        {
            bool Custom = false;
            this.comboBoxGeographyLocationUnits.BackColor = System.Drawing.SystemColors.Window;
            if (this.comboBoxGeographyLocationUnits.Visible)
            {
                if (this.comboBoxGeographyLocationUnits.Items.Count > 0)
                {
                    if (this.comboBoxGeographyLocationUnits.SelectedIndex > 0)
                    {
                        Custom = true;
                        this.comboBoxGeographyLocationUnits.BackColor = System.Drawing.Color.Aquamarine;
                    }
                }
            }
            this.tableLayoutPanelGeographyLocationCustom.Visible = Custom;
            this.tableLayoutPanelGeographyLocationStandard.Visible = !Custom;
            if (Custom)
            {
                this.setGeographyCustomUnitControls();
            }
        }

        private void setGeographyCustomUnitList(string ParsingMethodName)
        {
            this.comboBoxGeographyLocationUnits.Items.Clear();
            this.comboBoxGeographyLocationUnits.Text = "";
            string[] List = this.GeographyCustomUnitList(ParsingMethodName);
            foreach (string s in List)
            {
                this.comboBoxGeographyLocationUnits.Items.Add(s);
            }
            if (this.comboBoxGeographyLocationUnits.Items.Count > 0)
                this.comboBoxGeographyLocationUnits.SelectedIndex = 0;
        }

        private string[] GeographyCustomUnitList(string ParsingMethodName)
        {
            string[] List;

            switch (ParsingMethodName)
            {
                case "Altitude":
                case "Height":
                case "Depth":
                    List = new string[] { "text", MeasurementUnit.m.ToString(), MeasurementUnit.feet.ToString() };
                    break;
                case "Coordinates":
                    List = new string[] { "text", MeasurementUnit.numeric.ToString(), MeasurementUnit.deg_min_sec.ToString() };
                    break;
                case "Exposition":
                    List = new string[] { "text", MeasurementUnit.degree.ToString(), MeasurementUnit.orientation.ToString() };
                    break;
                case "Slope":
                    List = new string[] { "text", MeasurementUnit.degree.ToString(), MeasurementUnit.percent.ToString() }; // };
                    break;
                default:
                    List = new string[] { };
                    break;
            }
            return List;
        }

        private void buttonGeographyCustomSave_Click(object sender, EventArgs e)
        {
            CultureInfo InvC = new CultureInfo("");
            double Value1 = 0;
            double Value2 = 0;
            bool OK1 = false;
            bool OK2 = false;
            string StringValue1 = "";
            string StringValue2 = "";
            string Ori = "";
            if (this.collectionEventLocalisationBindingSource.Current != null)
            {
                try
                {
                    string GeographicalUnit = this.comboBoxGeographyLocationUnits.Text;
                    System.Data.DataRowView r = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                    System.Data.DataRow R = this.dataSetCollectionSpecimen.CollectionEventLocalisation.Rows[this.collectionEventLocalisationBindingSource.Position];
                    R.BeginEdit();
                    r.BeginEdit();
                    switch (GeographicalUnit)
                    {
                        case "numeric":
                            StringValue1 = this.textBoxLocation1a.Text;
                            OK1 = double.TryParse(StringValue1, out Value1);
                            if (OK1)
                            {
                                r["Location1"] = Value1.ToString();
                                if (r["AverageLongitudeCache"].Equals(System.DBNull.Value) || Value1 != 0)
                                    r["AverageLongitudeCache"] = Value1;
                            }

                            StringValue2 = this.textBoxLocation2a.Text;
                            OK2 = double.TryParse(StringValue2, out Value2);
                            if (OK2)
                            {
                                r["Location2"] = Value2.ToString();
                                if (r["AverageLatitudeCache"].Equals(System.DBNull.Value) || Value2 != 0)
                                    r["AverageLatitudeCache"] = Value2;
                            }
                            break;

                        case "deg_min_sec":
                            int DegNS = 0;
                            int DegEW = 0;
                            int MinNS = 0;
                            int MinEW = 0;
                            int PrefixNS = 1;
                            int PrefixEW = 1;
                            double SecNS = 0;
                            double SecEW = 0;

                            bool OK = true;
                            string Deg = this.textBoxLocation1a.Text.ToString();
                            Deg = Deg.Replace(" ", "");
                            if (Deg.Trim().StartsWith("-")) PrefixEW = -1;
                            if (Deg.Length == 0) Deg = "0";
                            if (!int.TryParse(Deg, out DegEW)) OK = false;
                            if (OK) DegEW = System.Math.Abs(DegEW);
                            string Min = this.textBoxLocation1b.Text.ToString();
                            if (Min.Length == 0) Min = "0";
                            if (!int.TryParse(Min, out MinEW)) OK = false;
                            string Sec = this.textBoxLocation1c.Text.ToString();
                            if (Sec.Length == 0) Sec = "0";
                            OK = double.TryParse(Sec, NumberStyles.Float, InvC, out SecEW);
                            if (!OK)
                                OK = double.TryParse(Sec.Replace(".", ","), NumberStyles.Float, InvC, out SecEW);
                            if (!OK)
                                OK = double.TryParse(Sec.Replace(",", "."), NumberStyles.Float, InvC, out SecEW);
                            if (OK)
                            {
                                if (!this.convertFromDegMinSecToNumeric(ref Value1, DegEW, MinEW, SecEW))
                                    OK = false;
                            }

                            Deg = this.textBoxLocation2a.Text.ToString();
                            Deg = Deg.Replace(" ", "");
                            if (Deg.Trim().StartsWith("-")) PrefixNS = -1;
                            if (Deg.Length == 0) Deg = "0";
                            if (!int.TryParse(Deg, out DegNS)) OK = false;
                            if (OK) DegNS = System.Math.Abs(DegNS);
                            Min = this.textBoxLocation2b.Text.ToString();
                            if (Min.Length == 0) Min = "0";
                            if (!int.TryParse(Min, out MinNS)) OK = false;
                            Sec = this.textBoxLocation2c.Text.ToString();
                            if (Sec.Length == 0) Sec = "0";
                            OK = double.TryParse(Sec, NumberStyles.Float, InvC, out SecNS);
                            if (!OK)
                                OK = double.TryParse(Sec.Replace(".", ","), NumberStyles.Float, InvC, out SecNS);
                            if (!OK)
                                OK = double.TryParse(Sec.Replace(",", "."), NumberStyles.Float, InvC, out SecNS);
                            //Sec = Sec.Replace(".", ",");
                            //if (Sec.Length == 0) Sec = "0";
                            //if (!double.TryParse(Sec, out SecNS)) OK = false;
                            if (OK)
                            {
                                //if (!this.convertFromDegMinSecToNumeric(ref Value2, int.Parse(Deg), int.Parse(Min), double.Parse(Sec)))
                                if (!this.convertFromDegMinSecToNumeric(ref Value2, DegNS, MinNS, SecNS))
                                    OK = false;
                            }
                            if (OK)
                            {
                                R["Location1"] = (Value1 * PrefixEW).ToString();
                                R["Location2"] = (Value2 * PrefixNS).ToString();
                                R["AverageLatitudeCache"] = Value2 * PrefixNS;
                                R["AverageLongitudeCache"] = Value1 * PrefixEW;
                                Ori = "Lat.: " + this.textBoxLocation2a.Text + " ";
                                if (this.textBoxLocation2b.Text.Length > 0) Ori += this.textBoxLocation2b.Text + "' ";
                                if (this.textBoxLocation2c.Text.Length > 0) Ori += this.textBoxLocation2c.Text + "'' ";
                                Ori += " Long.: " + this.textBoxLocation1a.Text + " ";
                                if (this.textBoxLocation1b.Text.Length > 0) Ori += this.textBoxLocation1b.Text + "' ";
                                if (this.textBoxLocation1c.Text.Length > 0) Ori += this.textBoxLocation1c.Text + "'' ";
                                R["LocationAccuracy"] = DiversityWorkbench.GeoFunctions.AccuracyFromDegMinSec(DegNS, MinNS, SecNS, DegEW, MinEW, SecEW);
                                this.GeographyLocationSetNotesDateResponsible(R, Ori);
                            }
                            break;

                        case "degree":
                            int degFrom = 0;
                            int degTo = 0;
                            int degAv;
                            int degAcc = 0;
                            bool isDegFrom = false;
                            bool isDegTo = false;
                            if (int.TryParse(this.textBoxLocation1a.Text, out degFrom))
                            {
                                R["Location1"] = degFrom.ToString();
                                isDegFrom = true;
                            }
                            if (int.TryParse(this.textBoxLocation2a.Text, out degTo))
                            {
                                R["Location2"] = degTo.ToString();
                                isDegTo = true;
                            }
                            if (isDegFrom || isDegTo)
                            {
                                if (isDegFrom && isDegTo)
                                {
                                    degAv = (degFrom + degTo) / 2;
                                    R["AverageAltitudeCache"] = degAv;
                                }
                                else
                                {
                                    degAv = degFrom + degTo;
                                    R["AverageAltitudeCache"] = degAv;
                                }
                                R["LocationAccuracy"] = DiversityWorkbench.GeoFunctions.AccuracyFromDegree(degFrom, degTo).ToString() + " ";
                            }
                            this.GeographyLocationSetNotesDateResponsible(R, "");
                            break;
                        case "orientation":
                            double dValFrom = 0;
                            double dValTo = 0;
                            bool isFromOri = false;
                            bool isToOri = false;
                            string FromOri = this.comboBoxLocation1a.Text;
                            string ToOri = this.comboBoxLocation2a.Text;
                            if (this.convertFromOrientationToDegree(ref FromOri, ref dValFrom))
                            {
                                R["Location1"] = dValFrom;
                                isFromOri = true;
                            }
                            if (this.convertFromOrientationToDegree(ref ToOri, ref dValTo))
                            {
                                R["Location2"] = dValTo;
                                isToOri = true;
                            }
                            if (isFromOri || isToOri)
                            {
                                if (isFromOri) Ori = FromOri;
                                if (isFromOri && isToOri) Ori += " - ";
                                if (isToOri) Ori += ToOri;
                                this.GeographyLocationSetNotesDateResponsible(R, Ori);
                                R["LocationAccuracy"] = DiversityWorkbench.GeoFunctions.AccuracyFromOrientation(this.comboBoxLocation1a.Text, this.comboBoxLocation2a.Text);
                            }
                            break;
                        case "percent":
                            double pFrom = 0;
                            double pTo = 0;
                            double pmValFrom;
                            double pmValTo;
                            double pfAcc;
                            double pmAcc;
                            bool pisFrom = false;
                            bool pisTo = false;
                            if (double.TryParse(this.textBoxLocation1a.Text, out pFrom))
                            {
                                pmValFrom = this.convertUnit(pFrom, MeasurementUnit.percent, MeasurementUnit.degree);
                                R["Location1"] = pmValFrom;
                                pisFrom = true;
                            }
                            if (double.TryParse(this.textBoxLocation2a.Text, out pTo))
                            {
                                pmValTo = this.convertUnit(pTo, MeasurementUnit.percent, MeasurementUnit.degree);
                                R["Location2"] = pmValTo;
                                pisTo = true;
                            }
                            if (pisFrom || pisTo)
                            {
                                if (pisFrom) Ori = pFrom.ToString();
                                if (pisFrom && pisTo) Ori += " - ";
                                if (pisTo) Ori += pTo.ToString();
                                Ori += " percent";
                                this.GeographyLocationSetNotesDateResponsible(R, Ori);
                            }
                            if (pFrom != 0 || pTo != 0)
                            {
                                pfAcc = DiversityWorkbench.GeoFunctions.AccuracyFromValues(pFrom, pTo);
                                pmAcc = this.convertUnit((double)pfAcc, MeasurementUnit.percent, MeasurementUnit.degree);
                                R["LocationAccuracy"] = pmAcc + " ";
                            }
                            //this.textBoxLocation1a.Text = this.convertUnit(this.textBoxLocation1a.Text, MeasurementUnit.degree, MeasurementUnit.percent);
                            //this.textBoxLocation2a.Text = this.convertUnit(this.textBoxLocation2a.Text, MeasurementUnit.degree, MeasurementUnit.percent);
                            break;
                        case "feet":
                        case "foot":
                            double fFrom = 0;
                            double fTo = 0;
                            double mValFrom;
                            double mValTo;
                            double fAcc;
                            double mAcc;
                            bool isFrom = false;
                            bool isTo = false;
                            if (double.TryParse(this.textBoxLocation1a.Text, out fFrom))
                            {
                                mValFrom = this.convertUnit(fFrom, MeasurementUnit.feet, MeasurementUnit.m);
                                R["Location1"] = mValFrom;
                                isFrom = true;
                            }
                            if (double.TryParse(this.textBoxLocation2a.Text, out fTo))
                            {
                                mValTo = this.convertUnit(fTo, MeasurementUnit.feet, MeasurementUnit.m);
                                R["Location2"] = mValTo;
                                isTo = true;
                            }
                            if (isFrom || isTo)
                            {
                                if (isFrom) Ori = fFrom.ToString();
                                if (isFrom && isTo) Ori += " - ";
                                if (isTo) Ori += fTo.ToString();
                                Ori += " feet";
                                this.GeographyLocationSetNotesDateResponsible(R, Ori);
                            }
                            if (fFrom != 0 || fTo != 0)
                            {
                                fAcc = DiversityWorkbench.GeoFunctions.AccuracyFromValues(fFrom, fTo);
                                mAcc = this.convertUnit((double)fAcc, MeasurementUnit.feet, MeasurementUnit.m);
                                R["LocationAccuracy"] = mAcc + " m";
                            }
                            goto case "AverageAltitude";
                            break;
                        case "m":
                            double From = 0;
                            double To = 0;
                            double Av;
                            decimal ValFrom;
                            decimal ValTo;
                            double Acc = 0;
                            if (double.TryParse(this.textBoxLocation1a.Text, out From))
                            {
                                ValFrom = (decimal)From;
                                ValFrom = Math.Round(ValFrom, 0);
                                R["Location1"] = ValFrom.ToString();
                            }
                            if (double.TryParse(this.textBoxLocation2a.Text, out To))
                            {
                                ValTo = (decimal)To;
                                ValTo = Math.Round(ValTo, 0);
                                R["Location2"] = ValTo.ToString();
                            }
                            if (From != 0 || To != 0)
                            {
                                if (From != 0 && To != 0)
                                {
                                    Av = (From + To) / 2;
                                    R["AverageAltitudeCache"] = Av;
                                }
                                else
                                {
                                    Av = From + To;
                                    R["AverageAltitudeCache"] = Av;
                                }
                                R["LocationAccuracy"] = DiversityWorkbench.GeoFunctions.AccuracyFromValues(From, To) + " m";
                            }
                            this.GeographyLocationSetNotesDateResponsible(R, "");
                            goto case "AverageAltitude";
                            break;
                        case "AverageAltitude":
                            int LocSysID;
                            if (int.TryParse(R["LocalisationSystemID"].ToString(), out LocSysID))
                            {
                                string LocalisationSystem = DiversityCollection.LookupTable.LocalisationSystemName(LocSysID);
                                if (LocalisationSystem == "Altitude (mNN)")
                                {
                                    this.TryToSaveAndCalculateAverageForLocalisation(true);
                                }
                            }
                            break;
                        default:
                            this.comboBoxGeographyLocationUnits.Visible = true;
                            break;
                    }
                    R.EndEdit();
                    DiversityCollection.HierarchyNode N = (DiversityCollection.HierarchyNode)this.treeViewOverviewHierarchy.SelectedNode;
                    N.setText();
                }
                catch { }
            }
        }

        private void GeographyLocationSetNotesDateResponsible(System.Data.DataRow R, string OriginalValueNotes)
        {
            string LocationNotes = R["LocationNotes"].ToString();
            if (OriginalValueNotes.Length > 0)
                OriginalValueNotes = this.GeoOriValStart + OriginalValueNotes + this.GeoOriValEnd;
            if (LocationNotes.IndexOf(this.GeoOriValStart) > -1
                && LocationNotes.IndexOf(this.GeoOriValEnd) > LocationNotes.IndexOf(this.GeoOriValStart))
            {
                OriginalValueNotes = LocationNotes.Substring(0, LocationNotes.IndexOf(this.GeoOriValStart)) +
                    OriginalValueNotes +
                    LocationNotes.Substring(LocationNotes.IndexOf(this.GeoOriValEnd) + 1);
            }
            else
            {
                if (LocationNotes.Length > 0)
                    OriginalValueNotes += " " + LocationNotes.Trim();
            }
            R["LocationNotes"] = OriginalValueNotes.Trim();
            R["DeterminationDate"] = System.DateTime.Now.ToShortDateString();
            if (DiversityCollection.Specimen.DefaultUseLocalisationResponsible)
            {
                R["ResponsibleName"] = DiversityCollection.Specimen.DefaultResponsibleName;// DiversityWorkbench.User.CurrentUserName;
                R["ResponsibleAgentURI"] = DiversityCollection.Specimen.DefaultResponsibleURI;
            }
        }

        private void setGeographyCustomUnitControls()
        {
            CultureInfo InvC = new CultureInfo("");

            double Value1 = 0;
            double Value2 = 0;
            bool OK1 = false;
            bool OK2 = false;
            string StringValue1 = "";
            string StringValue2 = "";
            if (this.collectionEventLocalisationBindingSource.Current != null)
            {
                System.Data.DataRowView r = (System.Data.DataRowView)this.collectionEventLocalisationBindingSource.Current;
                if (!r["Location1"].Equals(System.DBNull.Value) && r["Location1"].ToString().Length > 0)
                {
                    OK1 = double.TryParse(r["Location1"].ToString(), NumberStyles.Float, InvC, out Value1);
                    if (!OK1)
                        OK1 = double.TryParse(r["Location1"].ToString().Replace(".", ","), NumberStyles.Float, InvC, out Value1);
                    if (!OK1)
                        OK1 = double.TryParse(r["Location1"].ToString().Replace(",", "."), NumberStyles.Float, InvC, out Value1);
                    StringValue1 = r["Location1"].ToString();
                }
                if (!r["Location2"].Equals(System.DBNull.Value) && r["Location2"].ToString().Length > 0)
                {
                    OK2 = double.TryParse(r["Location2"].ToString(), NumberStyles.Float, InvC, out Value2);
                    if (!OK2)
                        OK2 = double.TryParse(r["Location2"].ToString().Replace(".", ","), NumberStyles.Float, InvC, out Value2);
                    if (!OK2)
                        OK2 = double.TryParse(r["Location2"].ToString().Replace(",", "."), NumberStyles.Float, InvC, out Value2);
                    StringValue2 = r["Location2"].ToString();
                }
            }
            string GeographicalUnit = this.comboBoxGeographyLocationUnits.Text;

            this.textBoxLocation1a.TextAlign = HorizontalAlignment.Center;
            this.textBoxLocation2a.TextAlign = HorizontalAlignment.Center;
            this.textBoxLocation1b.TextAlign = HorizontalAlignment.Center;
            this.textBoxLocation2b.TextAlign = HorizontalAlignment.Center;
            this.textBoxLocation1a.Visible = true;
            this.textBoxLocation2a.Visible = true;
            this.comboBoxLocation2a.Visible = false;
            this.comboBoxLocation1a.Visible = false;

            switch (GeographicalUnit)
            {
                case "numeric":
                    this.textBoxLocation1b.Visible = false;
                    this.textBoxLocation1c.Visible = false;
                    this.textBoxLocation2b.Visible = false;
                    this.textBoxLocation2c.Visible = false;
                    this.buttonGeographyCustomSave.Visible = true;
                    if (OK1) this.textBoxLocation1a.Text = Value1.ToString(); else this.textBoxLocation1a.Text = "?";
                    if (OK2) this.textBoxLocation2a.Text = Value2.ToString(); else this.textBoxLocation2a.Text = "?";
                    break;
                case "deg_min_sec":
                    int W = this.tableLayoutPanelGeographyLocationCustom.Width - this.labelLocation1Custom.Width - this.labelLocation2Custom.Width - 40;
                    int Wc = (int)((double)W * 0.2);
                    this.textBoxLocation1c.Width = Wc;
                    this.textBoxLocation2c.Width = Wc;
                    this.toolTip.SetToolTip(this.textBoxLocation1a, "Degree EW");
                    this.toolTip.SetToolTip(this.textBoxLocation2a, "Degree NS");
                    this.toolTip.SetToolTip(this.textBoxLocation1b, "Minutes EW");
                    this.toolTip.SetToolTip(this.textBoxLocation1c, "Seconds EW");
                    this.toolTip.SetToolTip(this.textBoxLocation2b, "Minutes NS");
                    this.toolTip.SetToolTip(this.textBoxLocation2c, "Seconds NS");
                    this.textBoxLocation1a.TextAlign = HorizontalAlignment.Right;
                    this.textBoxLocation2a.TextAlign = HorizontalAlignment.Right;
                    this.textBoxLocation1b.TextAlign = HorizontalAlignment.Center;
                    this.textBoxLocation2b.TextAlign = HorizontalAlignment.Center;
                    this.textBoxLocation1b.Visible = true;
                    this.textBoxLocation1c.Visible = true;
                    this.textBoxLocation2b.Visible = true;
                    this.textBoxLocation2c.Visible = true;
                    this.buttonGeographyCustomSave.Visible = true;
                    if (OK1)
                    {
                        int Prefix = 1;
                        int Deg = 0;
                        int Min = 0;
                        double Sek = 0;
                        this.convertFromNumericToDegMinSec(Value1, ref Prefix, ref Deg, ref Min, ref Sek);
                        string sDeg = Deg.ToString();
                        if (Prefix < 0) sDeg = "- " + sDeg;
                        this.textBoxLocation1a.Text = sDeg;
                        if (Min > 0) this.textBoxLocation1b.Text = Min.ToString();
                        else
                        {
                            if (Sek > 0) this.textBoxLocation1b.Text = "0";
                            else this.textBoxLocation1b.Text = "";
                        }
                        if (Sek > 0) this.textBoxLocation1c.Text = Sek.ToString();
                        else this.textBoxLocation1c.Text = "";
                    }
                    else
                    {
                        this.textBoxLocation1a.Text = "";
                        this.textBoxLocation1b.Text = "";
                        this.textBoxLocation1c.Text = "";
                    }
                    if (OK2)
                    {
                        int Prefix = 1;
                        int Deg = 0;
                        int Min = 0;
                        double Sek = 0;
                        this.convertFromNumericToDegMinSec(Value2, ref Prefix, ref Deg, ref Min, ref Sek);
                        string sDeg = Deg.ToString();
                        if (Prefix < 0) sDeg = "- " + sDeg;
                        this.textBoxLocation2a.Text = sDeg;
                        if (Min > 0) this.textBoxLocation2b.Text = Min.ToString();
                        else
                        {
                            if (Sek > 0) this.textBoxLocation2b.Text = "0";
                            else this.textBoxLocation2b.Text = "";
                        }
                        if (Sek > 0) this.textBoxLocation2c.Text = Sek.ToString();
                        else this.textBoxLocation2c.Text = "";

                        //this.textBoxLocation2a.Text = ((int)Value2).ToString();
                        //int Min = (int)Value2;
                        //float MinF = Value2 - (float)Min;
                        //Min = (int)(MinF * 100F);
                        //this.textBoxLocation2b.Text = Min.ToString();
                        //MinF = MinF * 100F;
                        //float SecF = MinF - (float)Min;
                        //int Sec = (int)(SecF * 100F);
                        //this.textBoxLocation2c.Text = Sec.ToString();
                    }
                    else
                    {
                        this.textBoxLocation2a.Text = "";
                        this.textBoxLocation2b.Text = "";
                        this.textBoxLocation2c.Text = "";
                    }
                    break;
                case "degree":
                    this.textBoxLocation1b.Visible = false;
                    this.textBoxLocation1c.Visible = false;
                    this.textBoxLocation2b.Visible = false;
                    this.textBoxLocation2c.Visible = false;
                    this.buttonGeographyCustomSave.Visible = true;
                    if (OK1) this.textBoxLocation1a.Text = Value1.ToString();
                    else
                    {
                        if (StringValue1.Length < 4)
                        {
                            double Deg = 0;
                            string Ori = StringValue1;
                            if (this.convertFromOrientationToDegree(ref Ori, ref Deg))
                                this.textBoxLocation1a.Text = Deg.ToString();
                        }
                    }
                    if (OK2) this.textBoxLocation2a.Text = Value2.ToString();
                    else
                    {
                        if (StringValue2.Length < 4)
                        {
                            double Deg = 0;
                            string Ori = StringValue2;
                            if (this.convertFromOrientationToDegree(ref Ori, ref Deg))
                                this.textBoxLocation2a.Text = Deg.ToString();
                        }
                    }
                    break;
                case "orientation":
                    this.textBoxLocation1a.Visible = false;
                    this.textBoxLocation1b.Visible = false;
                    this.textBoxLocation1c.Visible = false;
                    this.textBoxLocation2a.Visible = false;
                    this.textBoxLocation2b.Visible = false;
                    this.textBoxLocation2c.Visible = false;
                    this.comboBoxLocation1a.Width = (int)(80 * DiversityWorkbench.FormFunctions.DisplayZoomFactor);
                    this.comboBoxLocation2a.Width = (int)(80 * DiversityWorkbench.FormFunctions.DisplayZoomFactor);
                    this.comboBoxLocation1a.Visible = true;
                    this.comboBoxLocation2a.Visible = true;
                    this.comboBoxLocation1a.Items.Clear();
                    this.comboBoxLocation2a.Items.Clear();
                    this.comboBoxLocation1a.Items.Add("");
                    this.comboBoxLocation2a.Items.Add("");
                    for (int i = 0; i < this.NamedOrientation.Length; i++)
                    {
                        this.comboBoxLocation1a.Items.Add(this.NamedOrientation[i]);
                        this.comboBoxLocation2a.Items.Add(this.NamedOrientation[i]);
                    }
                    this.buttonGeographyCustomSave.Visible = true;
                    string OrientFrom = this.convertFromDegreeToOrientation(StringValue1);
                    string OrientTo = this.convertFromDegreeToOrientation(StringValue2);
                    for (int i = 0; i < this.NamedOrientation.Length; i++)
                    {
                        if (this.NamedOrientation[i] == OrientFrom)
                        {
                            this.comboBoxLocation1a.SelectedIndex = i + 1;
                            break;
                        }
                    }
                    for (int i = 0; i < this.NamedOrientation.Length; i++)
                    {
                        if (this.NamedOrientation[i] == OrientTo)
                        {
                            this.comboBoxLocation2a.SelectedIndex = i + 1;
                            break;
                        }
                    }
                    break;
                case "percent":
                    this.textBoxLocation1b.Visible = false;
                    this.textBoxLocation1c.Visible = false;
                    this.textBoxLocation2b.Visible = false;
                    this.textBoxLocation2c.Visible = false;
                    this.buttonGeographyCustomSave.Visible = true;
                    this.textBoxLocation1a.Text = this.convertUnit(StringValue1, MeasurementUnit.degree, MeasurementUnit.percent);
                    this.textBoxLocation2a.Text = this.convertUnit(StringValue2, MeasurementUnit.degree, MeasurementUnit.percent);
                    break;
                case "feet":
                case "foot":
                    this.textBoxLocation1b.Visible = false;
                    this.textBoxLocation1c.Visible = false;
                    this.textBoxLocation2b.Visible = false;
                    this.textBoxLocation2c.Visible = false;
                    this.buttonGeographyCustomSave.Visible = true;
                    this.textBoxLocation1a.Text = this.convertUnit(StringValue1, MeasurementUnit.m, MeasurementUnit.feet);
                    this.textBoxLocation2a.Text = this.convertUnit(StringValue2, MeasurementUnit.m, MeasurementUnit.feet);
                    break;
                case "m":
                    this.textBoxLocation1b.Visible = false;
                    this.textBoxLocation1c.Visible = false;
                    this.textBoxLocation2b.Visible = false;
                    this.textBoxLocation2c.Visible = false;
                    this.buttonGeographyCustomSave.Visible = true;
                    this.textBoxLocation1a.Text = this.convertUnit(StringValue1, MeasurementUnit.m, MeasurementUnit.m);
                    this.textBoxLocation2a.Text = this.convertUnit(StringValue2, MeasurementUnit.m, MeasurementUnit.m);
                    break;
                default:
                    this.textBoxLocation1a.Visible = true;
                    this.textBoxLocation2a.Visible = true;
                    this.buttonGeographyCustomSave.Visible = false;
                    this.comboBoxGeographyLocationUnits.Visible = true;
                    break;
            }
        }

        #region Conversions

        /// <summary>
        /// converts all values to or from SI unit like m, sec
        /// </summary>
        /// <param name="Value"></param>
        /// <param name="UnitSource"></param>
        /// <param name="UnitTarget"></param>
        /// <returns></returns>
        private string convertUnit(string Value, MeasurementUnit UnitSource, MeasurementUnit UnitTarget)
        {
            string Result = "?";
            double Source = 0;
            decimal dResult = 0;
            double Target = 0;
            bool OK = false;
            switch (UnitSource)
            {
                case MeasurementUnit.feet:
                    OK = double.TryParse(Value, out Source);
                    if (OK)
                    {
                        Target = Source / 3.2808;
                        Result = Target.ToString();
                    }
                    break;
                case MeasurementUnit.mile:
                    OK = double.TryParse(Value, out Source);
                    if (OK)
                    {
                        Target = Source * 1609;
                        Result = Target.ToString();
                    }
                    break;
                case MeasurementUnit.km:
                    OK = double.TryParse(Value, out Source);
                    if (OK)
                    {
                        Target = Source * 1000.0;
                        Result = Target.ToString();
                    }
                    break;
                case MeasurementUnit.m:
                    switch (UnitTarget)
                    {
                        case MeasurementUnit.feet:
                            OK = double.TryParse(Value, out Source);
                            if (OK)
                            {
                                Target = Source * 3.2808;
                                goto default;
                            }
                            break;
                        case MeasurementUnit.mile:
                            OK = double.TryParse(Value, out Source);
                            if (OK)
                            {
                                Target = Source / 1609;
                                goto default;
                            }
                            break;
                        case MeasurementUnit.km:
                            OK = double.TryParse(Value, out Source);
                            if (OK)
                            {
                                Target = Source / 1000.0;
                                goto default;
                            }
                            break;
                        default:
                            if (Target == 0)
                            {
                                OK = double.TryParse(Value, out Source);
                                if (OK)
                                {
                                    Target = Source;
                                }
                                else return "";
                            }
                            dResult = (decimal)Target;
                            dResult = System.Math.Round(dResult, 9);
                            Target = (double)dResult;
                            Result = Target.ToString();
                            break;
                    }
                    break;
                case MeasurementUnit.percent:
                    switch (UnitTarget)
                    {
                        case MeasurementUnit.degree:
                            OK = double.TryParse(Value, out Source);
                            if (OK)
                            {
                                double tan = Source / 100.0;
                                double result = System.Math.Atan(tan);
                                double angle = result * 180 / Math.PI;
                                Result = angle.ToString();
                            }
                            break;
                    }
                    break;
                case MeasurementUnit.degree:
                    switch (UnitTarget)
                    {
                        case MeasurementUnit.percent:
                            OK = double.TryParse(Value, out Source);
                            if (OK)
                            {
                                Target = System.Math.Tan(Source * (Math.PI / 180.0)) * 100.0;
                                Result = Target.ToString();
                            }
                            break;
                        case MeasurementUnit.orientation:
                            OK = double.TryParse(Value, out Source);
                            if (OK)
                            {
                                int ori = (int)((Source + 11.25) / 22.5);
                                Result = this.NamedOrientation[ori];
                            }
                            break;
                    }
                    break;
                default:
                    OK = double.TryParse(Value, out Source);
                    if (OK)
                    {
                        Result = Source.ToString();
                    }
                    break;
            }
            return Result;
        }

        /// <summary>
        /// converts all values to or from SI unit like m, sec
        /// </summary>
        /// <param name="Value"></param>
        /// <param name="UnitSource"></param>
        /// <param name="UnitTarget"></param>
        /// <returns></returns>
        private double convertUnit(double Value, MeasurementUnit UnitSource, MeasurementUnit UnitTarget)
        {
            switch (UnitSource)
            {
                case MeasurementUnit.feet:
                    return Value / 3.2808;
                    break;
                case MeasurementUnit.mile:
                    return Value * 1609;
                    break;
                case MeasurementUnit.km:
                    return Value * 1000.0;
                    break;
                case MeasurementUnit.m:
                    switch (UnitTarget)
                    {
                        case MeasurementUnit.feet:
                            return Value * 3.2808;
                            break;
                        case MeasurementUnit.mile:
                            return Value / 1609;
                            break;
                        case MeasurementUnit.km:
                            return Value / 1000.0;
                            break;
                        default:
                            return Value;
                            break;
                    }
                    break;
                case MeasurementUnit.percent:
                    switch (UnitTarget)
                    {
                        case MeasurementUnit.degree:
                            double tan = Value / 100.0;
                            double result = System.Math.Atan(tan);
                            double angle = result * 180 / Math.PI;
                            return angle;
                            //return System.Math.Atan(Value, 100.0);
                            break;
                    }
                    break;
                case MeasurementUnit.degree:
                    switch (UnitTarget)
                    {
                        case MeasurementUnit.percent:
                            return System.Math.Tan(Value * (Math.PI / 180.0)) * 100.0;
                            break;
                    }
                    break;
                default:
                    return Value;
                    break;
            }
            return Value;
        }

        private bool convertFromNumericToDegMinSec(double Numeric, ref int Prefix, ref int Deg, ref int Min, ref double Sec)
        {
            bool OK = true;
            try
            {
                //Prefix
                if (Numeric < 0) Prefix = -1;
                else Prefix = 1;
                // Deg
                Deg = (int)Numeric * Math.Sign(Numeric);
                // Min
                double MinD = Numeric * Math.Sign(Numeric) - Deg;
                MinD = MinD * 0.6;
                MinD = ((MinD * 100));
                Min = (int)MinD;
                // Sec
                double SecD = MinD - Min;
                SecD *= 60;
                decimal dSec = (decimal)SecD;
                dSec = Math.Round(dSec, 9);
                SecD = (double)dSec;
                if (SecD >= 60)
                {
                    SecD -= 60;
                    Min += 1;
                }
                decimal dSecD = (decimal)SecD;
                dSecD = System.Math.Round(dSecD, 9);
                SecD = (double)dSecD;
                Sec = SecD;
                Deg = System.Math.Abs(Deg);
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                OK = false;
            }
            return OK;
        }

        private bool convertFromDegMinSecToNumeric(ref double Numeric, int Deg, int Min, double Sec)
        {
            try
            {
                if (Deg * Math.Sign(Deg) > 180 || Min >= 60 || Min < 0 || Sec < 0 || Sec >= 60)
                {
                    System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.Wrong_entry); 
                    return false;
                }
                double dDeg = (double)Deg * Math.Sign(Deg);
                double dMin = (double)Min / (double)60 * Math.Sign(Min);
                double dSec = Sec / 3600;
                Numeric = dDeg + dMin + dSec;
                //Numeric;
                //Numeric +;
                //int Seconds = (int)Sec * Math.Sign(Sec);
                //decimal MilSeconds = Sec - (decimal)Seconds;
                //Numeric += (decimal)Seconds / (decimal)3600;
                //Numeric += MilSeconds / 10000;
                if (Deg != 0)
                    Numeric = Numeric * Math.Sign(Deg);

                //decimal NumDeg = (decimal)Deg * Math.Sign(Deg);
                //decimal NumMin = (decimal)Min / (decimal)60 * Math.Sign(Min);
                //decimal NumSec = (int)Sec / (decimal)6000 * Math.Sign(Sec);
                //decimal NumMil = (Sec - (decimal)((int)NumSec)) / 10000;
                //Numeric = NumDeg + NumMin + NumSec + NumMil;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                return false;
            }
            return true;
        }

        private bool convertFromOrientationToDegree(ref string Orientation, ref double Degree)
        {
            bool OK = true;
            int i;
            try
            {
                if (Orientation.Length > 0 && Orientation.Length < 4)
                {
                    Degree = 0F;
                    Orientation = Orientation.ToUpper();
                    for (i = 0; i < Orientation.Length; i++)
                    {
                        if (Orientation[i].ToString() == "N" || Orientation[i].ToString() == "W" || Orientation[i].ToString() == "E" || Orientation[i].ToString() == "S" || Orientation[i].ToString() == "O")
                        {
                            switch (Orientation[i].ToString())
                            {
                                case "N":
                                    if (Orientation.IndexOf("W") > 0)
                                        Degree += 360.0F;
                                    else
                                        Degree += 0F;
                                    break;
                                case "E":
                                case "O":
                                    Degree += 90.0F;
                                    break;
                                case "S":
                                    Degree += 180.0F;
                                    break;
                                case "W":
                                    Degree += 270.0F;
                                    break;
                                default:
                                    OK = false;
                                    break;
                            }
                        }
                        else
                        {
                            Orientation = "?";
                            break;
                        }
                    }
                    if (Orientation != "?")
                        Degree = Degree / i;
                }
            }
            catch
            {
                OK = false;
            }
            return OK;
        }

        private string convertFromDegreeToOrientation(string Degree)
        {
            string O = "?";
            try
            {
                float D;
                bool OK = float.TryParse(Degree, out D);
                if (OK)
                {
                    int ori = (int)((D + 11.25F) / 22.5F);
                    O = this.NamedOrientation[ori];
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            return O;
        }

        #endregion

        //#region Accuracy
        ///// <summary>
        ///// Approximation in parts derived from Wieczorek, J. 2001. MaNIS/HerpNet/ORNIS Georeferencing Guidelines. 
        ///// University of California, Berkeley: Museum of Vertebrate Zoology.
        ///// rounded to values between 0 and 30 Latitude
        ///// </summary>
        ///// <param name="DegNS"></param>
        ///// <param name="MinNS"></param>
        ///// <param name="SecNS"></param>
        ///// <param name="DegEW"></param>
        ///// <param name="MinEW"></param>
        ///// <param name="SecEW"></param>
        ///// <returns></returns>
        //private string AccuracyFromDegMinSec(int DegNS, int MinNS, double SecNS, int DegEW, int MinEW, double SecEW)
        //{
        //    // int AMax = 111120;
        //    if (SecNS % 0.5 > 0 || SecEW % 0.5 > 0) return "1 m";       // Milliseconds
        //    if (SecNS % 1 > 0 || SecEW % 1 > 0) return "3 m";       // Milliseconds
        //    if (SecNS % 5 > 0 || SecEW % 5 > 0) return "40 m";      // +-  1 Second
        //    if (SecNS % 10 > 0 || SecEW % 10 > 0) return "200 m";     // +-  5 Seconds
        //    if (SecNS % 30 > 0 || SecEW % 30 > 0) return "400 m";     // +- 10 Seconds
        //    if (SecNS > 0 || SecEW > 0) return "1.2 km";    // +- 30 Seconds
        //    if (MinNS % 5 > 0 || MinEW % 5 > 0) return "2.5 km";    // +-  1 Minute
        //    if (MinNS % 10 > 0 || MinEW % 10 > 0) return "12 km";   // +-  5 Minutes
        //    if (MinNS % 30 > 0 || MinEW % 30 > 0) return "25 km";   // +- 10 Minutes
        //    if (MinNS > 0 || MinEW > 0) return "75 km";   // +- 30 Minutes
        //    if (DegNS % 5 > 0 || DegEW % 5 > 0) return "150 km";  // +-  1 Grad
        //    return "500000 m";
        //}


        ///// <summary>
        ///// Approximation derived from Wieczorek, J. 2001. MaNIS/HerpNet/ORNIS Georeferencing Guidelines. 
        ///// University of California, Berkeley: Museum of Vertebrate Zoology.
        ///// rounded to values between 0 and 30 Latitude
        ///// </summary>
        ///// <param name="DegNS"></param>
        ///// <param name="DegEW"></param>
        ///// <returns></returns>
        ////private string AccurayFromDegNumeric(decimal DegNS, decimal DegEW)
        ////{
        ////    if (DegNS % (decimal)0.00005 > 0 || DegEW % (decimal)0.00005 > 0) return "2 m";       // +-0,00001 Degrees
        ////    if (DegNS % (decimal)0.0001 > 0 || DegEW % (decimal)0.0001 > 0) return "3 m";       // +- 0,00005 Degrees
        ////    if (DegNS % (decimal)0.0005 > 0 || DegEW % (decimal)0.0005 > 0) return "15 m";       // +- 0,0001 Degrees
        ////    if (DegNS % (decimal)0.001 > 0 || DegEW % (decimal)0.001 > 0) return "30 m";       // +- 0,0005 Degrees
        ////    if (DegNS % (decimal)0.005 > 0 || DegEW % (decimal)0.005 > 0) return "150 m";       // +- 0,001 Degrees
        ////    if (DegNS % (decimal)0.01 > 0 || DegEW % (decimal)0.01 > 0) return "300 m";       // +- 0,005 Degrees
        ////    if (DegNS % (decimal)0.05 > 0 || DegEW % (decimal)0.05 > 0) return "1500 m";       // +- 0,01 Degrees
        ////    if (DegNS % (decimal)0.1 > 0 || DegEW % (decimal)0.1 > 0) return "3 km";       // +- 0,05 Degrees
        ////    if (DegNS % (decimal)0.5 > 0 || DegEW % (decimal)0.5 > 0) return "15 km";       // +- 0.1 Degrees
        ////    if (DegNS % (decimal)1 > 0 || DegEW % (decimal)1 > 0) return "30 km";       // +- 0,5 Degrees
        ////    if (DegNS % (decimal)5 > 0 || DegEW % (decimal)5 > 0) return "150 km";       // +- 1 Degree
        ////    if (DegNS % (decimal)10 > 0 || DegEW % (decimal)10 > 0) return "300 km";       // +- 5 Degrees
        ////    return "111120 m";
        ////}

        ///// <summary>
        ///// Approximation derived from Wieczorek, J. 2001. MaNIS/HerpNet/ORNIS Georeferencing Guidelines. 
        ///// University of California, Berkeley: Museum of Vertebrate Zoology.
        ///// rounded to values between 0 and 30 Latitude
        ///// </summary>
        ///// <param name="DegNS"></param>
        ///// <param name="DegEW"></param>
        ///// <returns></returns>
        //private string AccuracyFromDegNumeric(double DegNS, double DegEW)
        //{
        //    if (DegNS % 0.00005 > 0 || DegEW % 0.00005 > 0) return "2 m";       // +-0,00001 Degrees
        //    if (DegNS % 0.0001 > 0 || DegEW % 0.0001 > 0) return "3 m";       // +- 0,00005 Degrees
        //    if (DegNS % 0.0005 > 0 || DegEW % 0.0005 > 0) return "15 m";       // +- 0,0001 Degrees
        //    if (DegNS % 0.001 > 0 || DegEW % 0.001 > 0) return "30 m";       // +- 0,0005 Degrees
        //    if (DegNS % 0.005 > 0 || DegEW % 0.005 > 0) return "150 m";       // +- 0,001 Degrees
        //    if (DegNS % 0.01 > 0 || DegEW % 0.01 > 0) return "300 m";       // +- 0,005 Degrees
        //    if (DegNS % 0.05 > 0 || DegEW % 0.05 > 0) return "1500 m";       // +- 0,01 Degrees
        //    if (DegNS % 0.1 > 0 || DegEW % 0.1 > 0) return "3 km";       // +- 0,05 Degrees
        //    if (DegNS % 0.5 > 0 || DegEW % 0.5 > 0) return "15 km";       // +- 0.1 Degrees
        //    if (DegNS % 1 > 0 || DegEW % 1 > 0) return "30 km";       // +- 0,5 Degrees
        //    if (DegNS % 5 > 0 || DegEW % 5 > 0) return "150 km";       // +- 1 Degree
        //    if (DegNS % 10 > 0 || DegEW % 10 > 0) return "300 km";       // +- 5 Degrees
        //    return "111120 m";
        //}

        //private int AccuracyFromDegree(int From, int To)
        //{
        //    if ((From % 2 > 0 && From % 5 > 0) || (To % 2 > 0 && To % 5 > 0)) return 1;       // +-1 Degree
        //    if (From % 5 > 0 || To % 5 > 0) return 3;       // +-3 Degrees
        //    if (From % 15 > 0 || To % 15 > 0) return 5;       // +-5 Degrees
        //    if (From % 30 > 0 || To % 30 > 0) return 15;       // +-15 Degrees
        //    if (From % 45 > 0 || To % 45 > 0) return 30;       // +-30 Degrees
        //    if (From % 90 > 0 || To % 90 > 0) return 45;       // +-45 Degrees
        //    return 45;
        //}

        //private string AccuracyFromOrientation(string From, string To)
        //{
        //    if (From.ToString().Length > 2 || To.ToString().Length > 2)
        //        return "23";
        //    if (From.ToString().Length > 1 || To.ToString().Length > 1)
        //        return "45";
        //    else return "90";
        //}

        ///// <summary>
        ///// Calculation of the uncertainity in parts according to Wieczorek, J., Q. Guo, and R. Hijmans. 2004. 
        ///// The point-radius method for georeferencing locality descriptions and calculating associated uncertainty. 
        ///// International Journal of Geographical Information Science. 18: 745-767.
        ///// </summary>
        ///// <param name="Value1">The first value of a range</param>
        ///// <param name="Value2">The first value of a range</param>
        ///// <param name="Unit">The unit as text, e.g. m, km</param>
        ///// <returns></returns>
        //private decimal AccuracyFromValues(decimal Value1, decimal Value2)
        //{
        //    decimal d;
        //    Value1 = Value1 * System.Math.Sign(Value1);
        //    Value2 = Value2 * System.Math.Sign(Value2);
        //    for (d = (decimal)0.00001; d < (decimal)100000000; d *= (decimal)10)
        //    {
        //        if ((Value1 * 2) % d > 0)
        //        {
        //            if (Value1 == d / 10) d *= (decimal)0.25;
        //            else d *= (decimal)0.5;
        //            break;
        //        }
        //        if ((Value2 * 2) % d > 0)
        //        {
        //            if (Value2 == d / 10) d *= (decimal)0.25;
        //            else d *= (decimal)0.5;
        //            break;
        //        }
        //        if (Value1 % d > 0)
        //        {
        //            if (d < Value1) d *= (decimal)2.5;
        //            else d *= (decimal)0.5;
        //            break;
        //        }
        //        if (Value2 % d > 0)
        //        {
        //            if (d < Value2) d *= (decimal)2.5;
        //            else d *= (decimal)0.5;
        //            break;
        //        }
        //        //d *= i;
        //    }
        //    d *= (decimal)0.1;
        //    d = System.Math.Round(d, 9);
        //    double dD = (double)d;
        //    d = (decimal)dD;
        //    //for (int i = 9; i >= 0; i--)
        //    //{
        //    //    decimal SecNew = System.Math.Round(d, i);
        //    //    if (d != SecNew) break;
        //    //    d = SecNew;
        //    //}
        //    return d;
        //}

        ///// <summary>
        ///// Calculation of the uncertainity in parts according to Wieczorek, J., Q. Guo, and R. Hijmans. 2004. 
        ///// The point-radius method for georeferencing locality descriptions and calculating associated uncertainty. 
        ///// International Journal of Geographical Information Science. 18: 745-767.
        ///// </summary>
        ///// <param name="Value1">The first value of a range</param>
        ///// <param name="Value2">The first value of a range</param>
        ///// <param name="Unit">The unit as text, e.g. m, km</param>
        ///// <returns></returns>
        //private double AccuracyFromValues(double Value1, double Value2)
        //{
        //    double d = (double)this.AccuracyFromValues((decimal)Value1, (decimal)Value2);
        //    return d;
        //}

        //#endregion

        #endregion

        #endregion

        #region EventProperty

        private void prepareToolStripDropDownButtonsEventProperty()
        {
            try
            {
                if (this.toolStripDropDownButtonOverviewHierarchyNewEventProperty.DropDownItems.Count > 0)
                    this.toolStripDropDownButtonOverviewHierarchyNewEventProperty.DropDownItems.Clear();
                foreach (System.Data.DataRow R in DiversityCollection.LookupTable.DtProperty.Rows)
                {
                    string Caption = R["PropertyName"].ToString();
                    string Entity = "Property.PropertyID." + R["PropertyID"].ToString();
                    System.Collections.Generic.Dictionary<string, string> E = DiversityWorkbench.Entity.EntityInformation(Entity, "General", DiversityWorkbench.Settings.Language);
                    if (E[DiversityWorkbench.Entity.EntityInformationField.DisplayTextOK.ToString()] == "True")
                        Caption = DiversityWorkbench.Entity.EntityInformation(Entity, "General", DiversityWorkbench.Settings.Language)["DisplayText"];
                    System.Windows.Forms.ToolStripMenuItem mi = new System.Windows.Forms.ToolStripMenuItem(Caption, null, menuItemOverviewHierarchyEventPropertyOnClick);
                    mi.Tag = R["PropertyID"];

                    int PropertyID;
                    if (int.TryParse(R["PropertyID"].ToString(), out PropertyID))
                        mi.Image = DiversityCollection.Specimen.ImageForCollectionEventProperty(PropertyID);
                    else
                        mi.Image = global::DiversityCollection.Resource.EventProperty;

                    //mi.Image = global::DiversityCollection.Resource.EventProperty;
                    this.toolStripDropDownButtonOverviewHierarchyNewEventProperty.DropDownItems.Add(mi);
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setToolStripDropDownButtonsEventPropertyVisibilty()
        {
            System.Collections.Generic.List<int> IDs = new List<int>();
            foreach (DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventPropertyRow R in this.dataSetCollectionSpecimen.CollectionEventProperty.Rows)
                if (R.RowState != DataRowState.Deleted && R.RowState != DataRowState.Detached) IDs.Add(R.PropertyID);
            foreach (System.Windows.Forms.ToolStripDropDownItem T 
                in this.toolStripDropDownButtonOverviewHierarchyNewEventProperty.DropDownItems)
            {
                T.Enabled = true;
            }
            foreach (System.Windows.Forms.ToolStripDropDownItem T in this.toolStripDropDownButtonOverviewHierarchyNewEventProperty.DropDownItems)
            {
                int ID = int.Parse(T.Tag.ToString());
                if (IDs.Contains(ID))
                    T.Enabled = false;
                if (!DiversityCollection.LookupTable.PropertyVisible(ID))
                    T.Enabled = false;
            }
        }

        private void setEventPropertyControls(System.Data.DataRow DataRow)
        {
            string ParsingMethodName;
            if (DataRow == null)
            {
                this.splitContainerOverviewEventLocProp.Panel2Collapsed = true;
            }
            else
            {
                this.splitContainerOverviewEventLocProp.Panel2Collapsed = false;
                int PropertyID = 0;
                if (int.TryParse(DataRow["PropertyID"].ToString(), out PropertyID))
                {
                    ParsingMethodName = DiversityCollection.LookupTable.ParsingMethodNameProperty(PropertyID);
                    string PropertyName = DiversityCollection.LookupTable.PropertyName(PropertyID);
                    try
                    {
                        System.Data.DataRow[] rr = DiversityCollection.LookupTable.DtProperty.Select("PropertyID = " + PropertyID.ToString());
                        if (rr.Length > 0)
                        {
                            this.groupBoxEventProperty.Text = PropertyName;
                            //System.Data.DataRow r = rr[0];
                            //this.labelLocation1.Text = r["DisplayTextLocation1"].ToString();
                            //if (this.labelLocation1.Text.Length > 11)
                            //    this.labelLocation1.Text = this.labelLocation1.Text.Substring(0, 10) + ".";
                            //this.labelLocation2.Text = r["DisplayTextLocation2"].ToString();
                            //if (this.labelLocation2.Text.Length > 11)
                            //    this.labelLocation2.Text = this.labelLocation2.Text.Substring(0, 10) + ".";
                            //this.toolTip.SetToolTip(this.textBoxLocation1, r["DescriptionLocation1"].ToString());
                            //this.toolTip.SetToolTip(this.textBoxLocation2, r["DescriptionLocation2"].ToString());

                            //this.labelLocation1Custom.Text = r["DisplayTextLocation1"].ToString();
                            //this.labelLocation2Custom.Text = r["DisplayTextLocation2"].ToString();
                            //this.toolTip.SetToolTip(this.textBoxLocation1a, r["DescriptionLocation1"].ToString());
                            //this.toolTip.SetToolTip(this.textBoxLocation2a, r["DescriptionLocation2"].ToString());

                            //if (this.comboBoxGeographyLocationUnits.Items.Count > 0) this.comboBoxGeographyLocationUnits.Visible = true;
                            //else this.comboBoxGeographyLocationUnits.Visible = false;
                            //this.buttonGetCoordinatesFromGoogleMaps.Visible = false;

                            switch (ParsingMethodName)
                            {
                                //case "Sampling plot":
                                //    goto default;
                                case "Vegetation":
                                    goto default;
                                case "Geographic region":
                                    goto default;
                                case "Chronostratigraphy":
                                case "Lithostratigraphy":
                                case "Stratigraphy":
                                    this.labelEventPropertyValue.Visible = true;
                                    this.textBoxEventPropertyValue.Visible = true;
                                    this.labelEventPropertyAverageValueCache.Visible = false;
                                    this.labelEventPropertyAverageValueCache.Text = "";
                                    this.textBoxEventPropertyAverageValueCache.Visible = false;
                                    this.textBoxEventPropertyAverageValueCache.Width = 0;
                                    break;
                                case "TODO":
                                    this.labelEventPropertyAverageValueCache.Visible = true;
                                    this.labelEventPropertyAverageValueCache.Text = "Average:";
                                    this.textBoxEventPropertyAverageValueCache.Visible = true;
                                    this.textBoxEventPropertyAverageValueCache.Width = (int)(125 * DiversityWorkbench.FormFunctions.DisplayZoomFactor);
                                    this.labelEventPropertyValue.Visible = true;
                                    this.textBoxEventPropertyValue.Visible = true;
                                    break;
                                default:
                                    this.labelEventPropertyAverageValueCache.Visible = false;
                                    this.labelEventPropertyValue.Visible = false;
                                    this.textBoxEventPropertyAverageValueCache.Visible = false;
                                    this.textBoxEventPropertyValue.Visible = false;
                                    break;
                            }
                        }
                        else
                        {
                            this.splitContainerOverviewEventLocProp.Panel2.Visible = false;
                        }
                    }
                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                }
            }
        }
        
        private void menuItemOverviewHierarchyEventPropertyOnClick(object sender, System.EventArgs e)
        {
            System.Windows.Forms.ToolStripMenuItem m = (System.Windows.Forms.ToolStripMenuItem)sender;
            int PropertyID = 0;
            if (int.TryParse(m.Tag.ToString(), out PropertyID))
            {
                try
                {
                    if (!this.ShowEventProperty) this.toolStripButtonOverviewHierarchyShowEventProperty_Click(null, null);
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventPropertyRow R
                        = (DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventPropertyRow)this.dataSetCollectionSpecimen.CollectionEventProperty.NewRow();
                    R.CollectionEventID = int.Parse(this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionEventID"].ToString());
                    R.PropertyID = PropertyID;
                    R.DisplayText = m.Text;
                    if (Specimen.DefaultUseEventPropertiyResponsible)
                    {
                        R.ResponsibleName = Specimen.DefaultResponsibleName;
                        R.ResponsibleAgentURI = Specimen.DefaultResponsibleURI;
                    }
                    this.dataSetCollectionSpecimen.CollectionEventProperty.Rows.Add(R);
                    this.buildOverviewHierarchyUnits();
                    this.setEventPropertyControls(R);
                    System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                    this.getOverviewHierarchyNodes(null, "CollectionEventProperty", this.treeViewOverviewHierarchy, ref Nodes);
                    this.treeViewOverviewHierarchy.SelectedNode = Nodes[Nodes.Count - 1];
                    this.setToolStripDropDownButtonsEventPropertyVisibilty();
                    this.treeViewOverviewHierarchy.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, R);
                }
                catch (System.Data.ConstraintException x)
                {
                    string Message = sender.ToString();
                    if (Message.StartsWith("New ")) Message = Message.Substring(4);
                    System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.There_can_only_be_one + " " + Message);// + "\r\n" + x.Message);
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void buttonEventPropertyHierarchyCacheEdit_Click(object sender, EventArgs e)
        {
            string Hierarchy = "";
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventPropertyBindingSource.Current;
            if (!R["PropertyHierarchyCache"].Equals(System.DBNull.Value))
                Hierarchy = R["PropertyHierarchyCache"].ToString();
            DiversityWorkbench.FormEditText f = new DiversityWorkbench.FormEditText("Hierachy", Hierarchy);
            f.ShowDialog();
            if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
            {
                R["PropertyHierarchyCache"] = f.EditedText;
                this.textBoxEventPropertyHierarchyCache.Text = f.EditedText;
            }
        }

        #endregion

        #region EventRegulation

        //private void menuItemOverviewHierarchyEventPropertyOnClick(object sender, System.EventArgs e)
        //{
        //    System.Windows.Forms.ToolStripMenuItem m = (System.Windows.Forms.ToolStripMenuItem)sender;
        //    int PropertyID = 0;
        //    if (int.TryParse(m.Tag.ToString(), out PropertyID))
        //    {
        //        try
        //        {
        //            if (!this.ShowEventProperty) this.toolStripButtonOverviewHierarchyShowEventProperty_Click(null, null);
        //            DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventPropertyRow R
        //                = (DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventPropertyRow)this.dataSetCollectionSpecimen.CollectionEventProperty.NewRow();
        //            R.CollectionEventID = int.Parse(this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionEventID"].ToString());
        //            R.PropertyID = PropertyID;
        //            R.DisplayText = m.Text;
        //            if (Specimen.DefaultUseEventPropertiyResponsible)
        //            {
        //                R.ResponsibleName = Specimen.DefaultResponsibleName;
        //                R.ResponsibleAgentURI = Specimen.DefaultResponsibleURI;
        //            }
        //            this.dataSetCollectionSpecimen.CollectionEventProperty.Rows.Add(R);
        //            this.buildOverviewHierarchyUnits();
        //            this.setEventPropertyControls(R);
        //            System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
        //            this.getOverviewHierarchyNodes(null, "CollectionEventProperty", this.treeViewOverviewHierarchy, ref Nodes);
        //            this.treeViewOverviewHierarchy.SelectedNode = Nodes[Nodes.Count - 1];
        //            this.setToolStripDropDownButtonsEventPropertyVisibilty();
        //            this.treeViewOverviewHierarchy.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, R);
        //        }
        //        catch (System.Data.ConstraintException x)
        //        {
        //            string Message = sender.ToString();
        //            if (Message.StartsWith("New ")) Message = Message.Substring(4);
        //            System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.There_can_only_be_one + " " + Message);// + "\r\n" + x.Message);
        //        }
        //        catch (Exception ex)
        //        {
        //            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
        //        }
        //    }
        //}

        private void toolStripButtonOverviewHierarchyNewRegulation_Click(object sender, EventArgs e)
        {
            System.Data.DataTable dtReg = new DataTable();
            string Message = "";
            string SQL = "SELECT TransactionTitle FROM TransactionRegulation ORDER BY TransactionTitle";
            DiversityWorkbench.FormFunctions.SqlFillTable(SQL, ref dtReg, ref Message);
            DiversityWorkbench.FormGetStringFromList f = new DiversityWorkbench.FormGetStringFromList(dtReg, "Please select a regulation");
            f.ShowDialog();
            if (f.DialogResult == System.Windows.Forms.DialogResult.OK && f.SelectedString.Length > 0)
            {
                DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventRegulationRow R
                    = (DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventRegulationRow)this.dataSetCollectionSpecimen.CollectionEventRegulation.NewRow();
                R.CollectionEventID = int.Parse(this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionEventID"].ToString());
                R.Regulation = f.SelectedString;
                this.dataSetCollectionSpecimen.CollectionEventRegulation.Rows.Add(R);
                this.buildOverviewHierarchyUnits();
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionEventRegulation", this.treeViewOverviewHierarchy, ref Nodes);
                if (Nodes.Count > 0)
                    this.treeViewOverviewHierarchy.SelectedNode = Nodes[Nodes.Count - 1];
                this.treeViewOverviewHierarchy.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, R);
            }


            //DiversityCollection.Forms.FormRegulation f = new Forms.FormRegulation(null, true);
            //f.ShowDialog();
            //if (f.Regulation() != null && f.Regulation().Length > 0)
            //{
            //    DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventRegulationRow R
            //        = (DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventRegulationRow)this.dataSetCollectionSpecimen.CollectionEventRegulation.NewRow();
            //    R.CollectionEventID = int.Parse(this.dataSetCollectionSpecimen.CollectionEvent.Rows[0]["CollectionEventID"].ToString());
            //    R.Regulation = f.Regulation();
            //    this.dataSetCollectionSpecimen.CollectionEventRegulation.Rows.Add(R);
            //    this.buildOverviewHierarchyUnits();
            //    System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
            //    this.getOverviewHierarchyNodes(null, "CollectionEventRegulation", this.treeViewOverviewHierarchy, ref Nodes);
            //    if (Nodes.Count > 0)
            //        this.treeViewOverviewHierarchy.SelectedNode = Nodes[Nodes.Count - 1];
            //    this.treeViewOverviewHierarchy.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, R);
            //}
        }

        #endregion

        #region EventImages
        
        private void comboBoxEventImageDataWithholdingReason_DropDown(object sender, EventArgs e)
        {
            string SQL = "SELECT DISTINCT DataWithholdingReason FROM CollectionEventImage ORDER BY DataWithholdingReason";
            System.Data.DataTable dt = new DataTable();
            try
            {
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                this.comboBoxEventImageDataWithholdingReason.DataSource = dt;
                this.comboBoxEventImageDataWithholdingReason.DisplayMember = "DataWithholdingReason";
                this.comboBoxEventImageDataWithholdingReason.ValueMember = "DataWithholdingReason";
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }
        
        #endregion

        #region Specimen

        private void toolStripButtonnOverviewHierarchyNewSpecimen_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.userControlQueryList.ProjectID == -1)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a project");
                    return;
                }
                if (System.Windows.Forms.MessageBox.Show("Do you want to create a new collection specimen", "New specimen?", System.Windows.Forms.MessageBoxButtons.OKCancel, System.Windows.Forms.MessageBoxIcon.Question) == System.Windows.Forms.DialogResult.OK)
                {
                    int CollectionEventID;
                    int ID = -1;
                    string AccessionNumber = "";
                    if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows.Count > 0
                        && !this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].Equals(System.DBNull.Value)
                        && int.TryParse(this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionEventID"].ToString(), out CollectionEventID))
                        ID = this.InsertNewSpecimen(ref AccessionNumber, CollectionEventID);
                    else
                        ID = this.InsertNewSpecimen(ref AccessionNumber, null);
                    if (ID > -1)
                    {
                        this.setSpecimen(ID);
                        if (AccessionNumber.Length > 0)
                            this.userControlQueryList.AddListItem(ID, AccessionNumber);
                        else
                            this.userControlQueryList.AddListItem(ID, "ID: " + ID.ToString());
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void comboBoxCollectionSpecimenDataWithholdingReason_DropDown(object sender, EventArgs e)
        {
            string SQL = "SELECT DISTINCT DataWithholdingReason FROM CollectionSpecimen ORDER BY DataWithholdingReason";
            System.Data.DataTable dt = new DataTable();
            try
            {
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                this.comboBoxCollectionSpecimenDataWithholdingReason.DataSource = dt;
                this.comboBoxCollectionSpecimenDataWithholdingReason.DisplayMember = "DataWithholdingReason";
                this.comboBoxCollectionSpecimenDataWithholdingReason.ValueMember = "DataWithholdingReason";
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void comboBoxHeaderDataWithholdingReason_DropDown(object sender, EventArgs e)
        {
            string SQL = "SELECT DISTINCT DataWithholdingReason FROM CollectionSpecimen ORDER BY DataWithholdingReason";
            System.Data.DataTable dt = new DataTable();
            try
            {
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                this.comboBoxHeaderDataWithholdingReason.DataSource = dt;
                this.comboBoxHeaderDataWithholdingReason.DisplayMember = "DataWithholdingReason";
                this.comboBoxHeaderDataWithholdingReason.ValueMember = "DataWithholdingReason";
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonTemplateSpecimenEdit_Click(object sender, EventArgs e)
        {
            //System.Collections.Generic.List<string> Suppress = new List<string>();
            //Suppress.Add("CollectionSpecimenID");
            //Suppress.Add("CollectionEventID");
            //Suppress.Add("Version");
            //Suppress.Add("AccessionDate");
            //Suppress.Add("Version");
            //Suppress.Add("CollectionID");
            //Suppress.Add("LogCreatedWhen");
            //Suppress.Add("LogCreatedBy");
            //Suppress.Add("LogUpdatedWhen");
            //Suppress.Add("LogUpdatedBy");
            //Suppress.Add("RowGUID");

            //DiversityWorkbench.TemplateForDataSourceTable ST = new DiversityWorkbench.TemplateForDataSourceTable(LookupTable.DtExternalDatasourceWithNull(), "ExternalDatasourceName", "ExternalDatasourceID");
            //System.Collections.Generic.Dictionary<string, DiversityWorkbench.TemplateForDataSourceTable> SourceTables = new Dictionary<string, DiversityWorkbench.TemplateForDataSourceTable>();
            //SourceTables.Add("ExternalDatasourceID", ST);
            System.Data.DataRow R = ((System.Data.DataRowView)this.collectionSpecimenBindingSource.Current).Row;
            DiversityWorkbench.Forms.FormTemplateEditor f = new DiversityWorkbench.Forms.FormTemplateEditor("CollectionSpecimen", R, TemplateSpecimenSuppressedColumns, TemplateSpecimenSourceTables);
            f.setHelp("Template");
            f.ShowDialog();
        }

        private System.Collections.Generic.List<string> TemplateSpecimenSuppressedColumns
        {
            get
            {
                System.Collections.Generic.List<string> Suppress = new List<string>();
                Suppress.Add("CollectionSpecimenID");
                Suppress.Add("CollectionEventID");
                Suppress.Add("Version");
                Suppress.Add("AccessionDate");
                Suppress.Add("Version");
                Suppress.Add("CollectionID");
                Suppress.Add("LogCreatedWhen");
                Suppress.Add("LogCreatedBy");
                Suppress.Add("LogUpdatedWhen");
                Suppress.Add("LogUpdatedBy");
                Suppress.Add("RowGUID");
                return Suppress;
            }
        }

        private System.Collections.Generic.Dictionary<string, DiversityWorkbench.TemplateForDataSourceTable> TemplateSpecimenSourceTables
        {
            get
            {
                DiversityWorkbench.TemplateForDataSourceTable ST = new DiversityWorkbench.TemplateForDataSourceTable(LookupTable.DtExternalDatasourceWithNull(), "ExternalDatasourceName", "ExternalDatasourceID");
                System.Collections.Generic.Dictionary<string, DiversityWorkbench.TemplateForDataSourceTable> SourceTables = new Dictionary<string, DiversityWorkbench.TemplateForDataSourceTable>();
                SourceTables.Add("ExternalDatasourceID", ST);
                return SourceTables;
            }
        }

        private void buttonTemplateSpecimenSet_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.TemplateForData T = new DiversityWorkbench.TemplateForData("CollectionSpecimen", TemplateSpecimenSuppressedColumns, TemplateSpecimenSourceTables);
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenBindingSource.Current;
            T.CopyTemplateToRow(R.Row);
        }

        #endregion

        #region Specimen images
        
        private void comboBoxSpecimenImageWithholdingReason_DropDown(object sender, EventArgs e)
        {
            string SQL = "SELECT DISTINCT DataWithholdingReason FROM CollectionSpecimenImage ORDER BY DataWithholdingReason";
            System.Data.DataTable dt = new DataTable();
            try
            {
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                this.comboBoxSpecimenImageWithholdingReason.DataSource = dt;
                this.comboBoxSpecimenImageWithholdingReason.DisplayMember = "DataWithholdingReason";
                this.comboBoxSpecimenImageWithholdingReason.ValueMember = "DataWithholdingReason";
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }
        
        #endregion

        #region Relation

        private void setRelatedSpecimenControls()
        {
            if (this.collectionSpecimenRelationBindingSource.Current != null && this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows.Count > 0)
            {
                try
                {
                    this.tableLayoutPanelRelation.Visible = true;
                    System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenRelationBindingSource.Current;
                    bool IsInternal = false;
                    IsInternal = bool.Parse(R["IsInternalRelationCache"].ToString());
                    string DisplayText = R["RelationType"].ToString() + " ";
                    if (DisplayText.Length == 1) DisplayText = DisplayText.Trim();
                    DisplayText += R["RelatedSpecimenDisplayText"].ToString();
                    // Internal or not
                    this.userControlModuleRelatedEntryRelatedSpecimen.Visible = IsInternal;
                    this.comboBoxRelatedSpecimenCollectionID.Visible = !IsInternal;
                    this.labelRelatedSpecimenCollectionID.Visible = !IsInternal;
                    this.userControlHierarchySelectorRelatedSpecimenCollectionID.Visible = !IsInternal;
                    this.buttonRelatedSpecimenURL.Visible = !IsInternal;
                    this.textBoxRelatedSpecimenURL.Visible = !IsInternal;

                    //this.labelRelationPart.Visible = false;
                    //this.labelRelationUnit.Visible = false;
                    //this.comboBoxRelationUnit.Visible = false;
                    //this.comboBoxRelationPart.Visible = false;

                    //this.labelRelationPart.Visible = IsInternal;
                    //this.labelRelationUnit.Visible = IsInternal;
                    //this.comboBoxRelationUnit.Visible = IsInternal;
                    //this.comboBoxRelationPart.Visible = IsInternal;

                    if (IsInternal)
                    {
                        this.tableLayoutPanelRelation.SetColumnSpan(this.labelRelatedSpecimenRelationType, 3);
                        this.tableLayoutPanelRelation.SetColumnSpan(this.comboBoxRelatedSpecimenRelationType, 3);
                        this.groupBoxSpecimenRelation.Text = this.Message("Internal_relation_to") + " " + DisplayText;

                        //if (!R["SpecimenPartID"].Equals(System.DBNull.Value))
                        //{
                        //    int i = 0;
                        //    foreach (System.Data.DataRow RPart in this.DtPartList.Rows)
                        //    {
                        //        if (RPart["SpecimenPartID"].ToString() == R["SpecimenPartID"].ToString())
                        //            break;
                        //        i++;
                        //    }
                        //    this.comboBoxRelationPart.SelectedIndex = i;
                        //}

                        //if (!R["IdentificationUnitID"].Equals(System.DBNull.Value))
                        //{
                        //    int i = 0;
                        //    foreach (System.Data.DataRow RPart in this.dataSetCollectionSpecimen.IdentificationUnit.Rows)
                        //    {
                        //        if (RPart["IdentificationUnitID"].ToString() == R["IdentificationUnitID"].ToString())
                        //            break;
                        //        i++;
                        //    }
                        //    this.comboBoxRelationUnit.SelectedIndex = i;
                        //}


                    }
                    else
                    {
                        this.tableLayoutPanelRelation.SetColumnSpan(this.labelRelatedSpecimenRelationType, 1);
                        this.tableLayoutPanelRelation.SetColumnSpan(this.comboBoxRelatedSpecimenRelationType, 1);
                        if (!R["RelatedSpecimenCollectionID"].Equals(System.DBNull.Value))
                            DisplayText += " in " + DiversityCollection.LookupTable.CollectionName(int.Parse(R["RelatedSpecimenCollectionID"].ToString()));
                        this.groupBoxSpecimenRelation.Text = this.Message("External_relation_to") + " " + DisplayText;
                    }
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
            else
                this.tableLayoutPanelRelation.Visible = false;
        }

        private void buttonChangeToRelatedSpecimen_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                int ID = int.Parse(R["CollectionSpecimenID"].ToString());
                this.setSpecimen(ID);
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void chooseLastAddedRelation(System.Data.DataRow R)
        {
            System.Collections.Generic.List<System.Windows.Forms.TreeNode> RelationNodes = new List<TreeNode>();
            this.getOverviewHierarchyNodes(null, "CollectionSpecimenRelation", this.treeViewOverviewHierarchy, ref RelationNodes);
            foreach (System.Windows.Forms.TreeNode N in RelationNodes)
            {
                if (R == (System.Data.DataRow)N.Tag)
                {
                    this.treeViewOverviewHierarchy.SelectedNode = N;
                    break;
                }
            }
        }

        #region toolStrip

        private void toolStripButtonOverviewHierarchyNewRelation_Click(object sender, EventArgs e)
        {
            try
            {
                if (!this.ShowRelation) this.toolStripButtonOverviewHierarchyShowRelations_Click(null, null);
                System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                DiversityWorkbench.ServerConnection S = this.ServerConnection;
                S.DatabaseName = DiversityWorkbench.Settings.DatabaseName;
                DiversityCollection.CollectionSpecimen C = new CollectionSpecimen(S);
                DiversityWorkbench.FormRemoteQuery f = new DiversityWorkbench.FormRemoteQuery(C, con);
                f.ShowDialog();
                if (f.DialogResult == DialogResult.OK)
                {
                    System.Data.DataRow R = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.NewRow();
                    R["CollectionSpecimenID"] = this.ID;
                    int i = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows.Count + 1;
                    R["RelatedSpecimenURI"] = f.URI; //"Related Specimen - " + i.ToString();
                    R["RelatedSpecimenDisplayText"] = f.DisplayText;// R["RelatedSpecimenURI"];
                    R["IsInternalRelationCache"] = true;
                    System.Data.DataRow DataRow = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                    string Table = DataRow.Table.TableName;
                    if (Table == "IdentificationUnit")
                        R["IdentificationUnitID"] = DataRow["IdentificationUnitID"];
                    this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows.Add(R);
                    this.buildOverviewHierarchyUnits();
                    this.treeViewOverviewHierarchy.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, R);
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonOverviewHierarchyNewRelationExtern_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRow R = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.NewRow();
                R["CollectionSpecimenID"] = this.ID;
                int i = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows.Count + 1;
                string RelatedSpecimenURI = i.ToString();
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Select("RelatedSpecimenURI = '" + RelatedSpecimenURI + "'");
                while (rr.Length > 0)
                {
                    i++;
                    rr = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Select("RelatedSpecimenURI = '" + i.ToString() + "'");
                    RelatedSpecimenURI = i.ToString();
                }
                R["RelatedSpecimenURI"] = RelatedSpecimenURI;
                R["RelatedSpecimenDisplayText"] = R["RelatedSpecimenURI"];
                R["IsInternalRelationCache"] = false;
                System.Data.DataRow DataRow = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                string Table = DataRow.Table.TableName;
                if (Table == "IdentificationUnit")
                    R["IdentificationUnitID"] = DataRow["IdentificationUnitID"];
                this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows.Add(R);
                this.buildOverviewHierarchyUnits();
                this.treeViewOverviewHierarchy.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, R);
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }
        
        private void toolStripButtonOverviewHierarchyNewRelationPart_Click(object sender, EventArgs e)
        {
            try
            {
                if (!this.ShowRelation) this.toolStripButtonOverviewHierarchyShowRelations_Click(null, null);
                System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                DiversityWorkbench.ServerConnection S = this.ServerConnection;
                S.DatabaseName = DiversityWorkbench.Settings.DatabaseName;
                DiversityCollection.CollectionSpecimen C = new CollectionSpecimen(S);
                DiversityWorkbench.FormRemoteQuery f = new DiversityWorkbench.FormRemoteQuery(C, con);
                f.ShowDialog();
                if (f.DialogResult == DialogResult.OK)
                {
                    System.Data.DataRow R = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.NewRow();
                    R["CollectionSpecimenID"] = this.ID;
                    int i = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows.Count + 1;
                    R["RelatedSpecimenURI"] = f.URI; //"Related Specimen - " + i.ToString();
                    R["RelatedSpecimenDisplayText"] = f.DisplayText;// R["RelatedSpecimenURI"];
                    R["IsInternalRelationCache"] = true;
                    System.Data.DataRow DataRow = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                    R["SpecimenPartID"] = DataRow["SpecimenPartID"];
                    this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows.Add(R);
                    this.buildOverviewHierarchyParts();
                    this.treeViewOverviewHierarchyStorage.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchyStorage, null, R);
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonOverviewHierarchyNewRelationPartExtern_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRow R = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.NewRow();
                R["CollectionSpecimenID"] = this.ID;
                int i = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows.Count + 1;
                string RelatedSpecimenURI = i.ToString();
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Select("RelatedSpecimenURI = '" + RelatedSpecimenURI + "'");
                while (rr.Length > 0)
                {
                    i++;
                    rr = this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Select("RelatedSpecimenURI = '" + i.ToString() + "'");
                    RelatedSpecimenURI = i.ToString();
                }
                R["RelatedSpecimenURI"] = RelatedSpecimenURI;
                R["RelatedSpecimenDisplayText"] = R["RelatedSpecimenURI"];
                R["IsInternalRelationCache"] = false;
                System.Data.DataRow DataRow = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                R["SpecimenPartID"] = DataRow["SpecimenPartID"];
                this.dataSetCollectionSpecimen.CollectionSpecimenRelation.Rows.Add(R);
                this.buildOverviewHierarchyParts();
                this.treeViewOverviewHierarchyStorage.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchyStorage, null, R);
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #endregion

        #region Reference

        private void toolStripButtonOverviewHierarchyNewReference_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRow R = this.dataSetCollectionSpecimen.CollectionSpecimenReference.NewRow();
                R["CollectionSpecimenID"] = this.ID;
                R["ReferenceTitle"] = "New reference";
                System.Data.DataRow DataRow = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                string Table = DataRow.Table.TableName;
                if (Table == "IdentificationUnit")
                    R["IdentificationUnitID"] = DataRow["IdentificationUnitID"];
                this.dataSetCollectionSpecimen.CollectionSpecimenReference.Rows.Add(R);
                this.buildOverviewHierarchyUnits();
                this.treeViewOverviewHierarchy.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, R);
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonOverviewHierarchyPartNewReference_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRow R = this.dataSetCollectionSpecimen.CollectionSpecimenReference.NewRow();
                R["CollectionSpecimenID"] = this.ID;
                R["ReferenceTitle"] = "New reference";
                System.Data.DataRow DataRow = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                R["SpecimenPartID"] = DataRow["SpecimenPartID"];
                this.dataSetCollectionSpecimen.CollectionSpecimenReference.Rows.Add(R);
                this.buildOverviewHierarchyParts();
                this.treeViewOverviewHierarchyStorage.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchyStorage, null, R);
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #region Agent

        #region ToolStrip

        private void toolStripButtonOverviewHierarchyNewAgent_Click(object sender, EventArgs e)
        {
            if (!this.ShowCollector) this.toolStripButtonOverviewHierarchyShowAgents_Click(null, null);
            try
            {
                int i = this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count + 1;
                System.Data.DataRow R = this.dataSetCollectionSpecimen.CollectionAgent.NewRow();
                R["CollectionSpecimenID"] = this.SpecimenID;
                if (DiversityCollection.Specimen.DefaultUseCollector && i == 1)
                {
                    R["CollectorsName"] = DiversityCollection.Specimen.DefaultResponsibleName;
                    R["CollectorsAgentURI"] = DiversityCollection.Specimen.DefaultResponsibleURI;
                }
                else
                    R["CollectorsName"] = "New collector " + i.ToString();
                R["CollectorsSequence"] = System.DateTime.Now;//.ToShortDateString();
                this.dataSetCollectionSpecimen.CollectionAgent.Rows.Add(R);
                this.hideOverviewHierarchyAgent();
                this.addOverviewHierarchyAgents();
                this.treeViewOverviewHierarchy.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, R);
                //this.buildOverviewHierarchyUnits();
                //int i = this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count;
                //this.listBoxCollectionAgent.SelectedIndex = i - 1;
                //if (i == 1)
                //    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionAgent", this.sqlDataAdapterAgent, this.collectionAgentBindingSource);
                if (this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count > 0)
                    this.buttonCollectorIsResponsible.Enabled = true;
                else this.buttonCollectorIsResponsible.Enabled = false;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonOverviewHierarchyAgentUp_Click(object sender, EventArgs e)
        {
            try
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> AgentNodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionAgent", this.treeViewOverviewHierarchy, ref AgentNodes);
                if (this.treeViewOverviewHierarchy.SelectedNode != AgentNodes[0] 
                    && this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count > 1
                    && !this.dataSetCollectionSpecimen.CollectionAgent.Rows[this.collectionAgentBindingSource.Position]["CollectorsSequence"].Equals(System.DBNull.Value))
                {
                    System.Data.DataRow r = this.dataSetCollectionSpecimen.CollectionAgent.Rows[this.collectionAgentBindingSource.Position];
                    System.Data.DataRow[] rrTime = this.dataSetCollectionSpecimen.CollectionAgent.Select("", "CollectorsSequence", System.Data.DataViewRowState.CurrentRows);
                    System.Data.DataRow rTime = rrTime[0];
                    if (!rTime[3].Equals(System.DBNull.Value))
                    {
                        System.DateTime Time = System.DateTime.Parse(rTime[3].ToString());
                        System.TimeSpan TS = new TimeSpan(1, 0, 0, 0, 0);
                        Time = Time.Subtract(TS);
                        r["CollectorsSequence"] = Time;
                        this.hideOverviewHierarchyAgent();
                        this.addOverviewHierarchyAgents();
                        AgentNodes.Clear();
                        this.getOverviewHierarchyNodes(null, "CollectionAgent", this.treeViewOverviewHierarchy, ref AgentNodes);
                        this.treeViewOverviewHierarchy.SelectedNode = AgentNodes[0];
                    }
                }
                else if (this.dataSetCollectionSpecimen.CollectionAgent.Rows[this.collectionAgentBindingSource.Position]["CollectorsSequence"].Equals(System.DBNull.Value))
                {
                    this.dataSetCollectionSpecimen.CollectionAgent.Rows[this.collectionAgentBindingSource.Position]["CollectorsSequence"] = System.DateTime.Now;
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonOverviewHierarchyAgentDown_Click(object sender, EventArgs e)
        {
            try
            {
                System.Collections.Generic.List<System.Windows.Forms.TreeNode> AgentNodes = new List<TreeNode>();
                this.getOverviewHierarchyNodes(null, "CollectionAgent", this.treeViewOverviewHierarchy, ref AgentNodes);
                if (this.treeViewOverviewHierarchy.SelectedNode != AgentNodes[AgentNodes.Count - 1] 
                    && this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count > 1
                    && !this.dataSetCollectionSpecimen.CollectionAgent.Rows[this.collectionAgentBindingSource.Position]["CollectorsSequence"].Equals(System.DBNull.Value))
                {
                    System.Data.DataRow r = this.dataSetCollectionSpecimen.CollectionAgent.Rows[this.collectionAgentBindingSource.Position];
                    System.Data.DataRow[] rrTime = this.dataSetCollectionSpecimen.CollectionAgent.Select("", "CollectorsSequence DESC", System.Data.DataViewRowState.CurrentRows);
                    System.Data.DataRow rTime = rrTime[0];
                    if (!rTime[3].Equals(System.DBNull.Value))
                    {
                        System.DateTime Time = System.DateTime.Parse(rTime[3].ToString());
                        Time = Time.AddDays(1);
                        r["CollectorsSequence"] = Time;
                        this.hideOverviewHierarchyAgent();
                        this.addOverviewHierarchyAgents();
                        AgentNodes.Clear();
                        this.getOverviewHierarchyNodes(null, "CollectionAgent", this.treeViewOverviewHierarchy, ref AgentNodes);
                        this.treeViewOverviewHierarchy.SelectedNode = AgentNodes[AgentNodes.Count - 1];
                    }
                }
                else if (this.dataSetCollectionSpecimen.CollectionAgent.Rows[this.collectionAgentBindingSource.Position]["CollectorsSequence"].Equals(System.DBNull.Value))
                {
                    this.dataSetCollectionSpecimen.CollectionAgent.Rows[this.collectionAgentBindingSource.Position]["CollectorsSequence"] = System.DateTime.Now;
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }
        
        #endregion

        private void comboBoxCollectorDataWithholdingReason_DropDown(object sender, EventArgs e)
        {
            string SQL = "SELECT DISTINCT DataWithholdingReason FROM CollectionAgent ORDER BY DataWithholdingReason";
            System.Data.DataTable dt = new DataTable();
            try
            {
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                this.comboBoxCollectorDataWithholdingReason.DataSource = dt;
                this.comboBoxCollectorDataWithholdingReason.DisplayMember = "DataWithholdingReason";
                this.comboBoxCollectorDataWithholdingReason.ValueMember = "DataWithholdingReason";
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }


        private void buttonTemplateCollectorSet_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.TemplateForData T = new DiversityWorkbench.TemplateForData("CollectionAgent", TemplateCollectorSuppressedColumns);
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionAgentBindingSource.Current;
            T.CopyTemplateToRow(R.Row);


            //DiversityWorkbench.TemplateForData T = new DiversityWorkbench.TemplateForData("CollectionAgent");
            //System.Data.DataRowView R = (System.Data.DataRowView)this.collectionAgentBindingSource.Current;
            //R.BeginEdit();
            //foreach (System.Collections.Generic.KeyValuePair<string, string> KV in T.ColumnTemplateValues())
            //{
            //    R[KV.Key] = KV.Value;
            //}
            //R.EndEdit();
        }

        private System.Collections.Generic.List<string> TemplateCollectorSuppressedColumns
        {
            get
            {
                System.Collections.Generic.List<string> Suppress = new List<string>();
                Suppress.Add("CollectionSpecimenID");
                Suppress.Add("CollectorsSequence");
                Suppress.Add("LogCreatedWhen");
                Suppress.Add("LogCreatedBy");
                Suppress.Add("LogUpdatedWhen");
                Suppress.Add("LogUpdatedBy");
                Suppress.Add("RowGUID");
                return Suppress;
            }
        }

        private void buttonTemplateCollectorEdit_Click(object sender, EventArgs e)
        {
            System.Data.DataRow R = ((System.Data.DataRowView)this.collectionAgentBindingSource.Current).Row;
            DiversityWorkbench.Forms.FormTemplateEditor f = new DiversityWorkbench.Forms.FormTemplateEditor("CollectionAgent", R, this.TemplateCollectorSuppressedColumns);
            f.setHelp("Template");
            f.ShowDialog();
        }

        #endregion

        #region Identification

        private void toolStripButtonOverviewHierarchyNewIdentification_Click(object sender, EventArgs e)
        {
            System.Data.DataRow R = this.createNewIdentification(IdentInsertType.New);
            this.refreshHierarchyUnitUnitNodes(this.treeViewOverviewHierarchy.SelectedNode);
            this.treeViewOverviewHierarchy.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, R);
        }

        private void toolStripButtonOverviewHierarchyNewIdentAtBase_Click(object sender, EventArgs e)
        {
            System.Data.DataRow R = this.createNewIdentification(IdentInsertType.Old);
            this.refreshHierarchyUnitUnitNodes(this.treeViewOverviewHierarchy.SelectedNode);
            this.treeViewOverviewHierarchy.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, R);
        }

        private void toolStripButtonOverviewHierarchyNewConfirmation_Click(object sender, EventArgs e)
        {
            System.Data.DataRow R = this.createNewIdentification(IdentInsertType.Confirm);
            this.refreshHierarchyUnitUnitNodes(this.treeViewOverviewHierarchy.SelectedNode);
            this.treeViewOverviewHierarchy.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, R);
        }

        private void toolStripButtonOverviewHierarchyIdentificationToTop_Click(object sender, EventArgs e)
        {
            int IdentificationSequence = 0;
            int IdentificationSequenceCurrent = 0;
            System.Data.DataRowView R = (System.Data.DataRowView)this.identificationBindingSource.Current;
            if (!int.TryParse(R["IdentificationSequence"].ToString(), out IdentificationSequenceCurrent)) return;
            System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.Identification.Select("IdentificationUnitID = " + R["IdentificationUnitID"].ToString(), "IdentificationSequence DESC");
            if (int.TryParse(RR[0]["IdentificationSequence"].ToString(), out IdentificationSequence))
            {
                if (IdentificationSequenceCurrent == IdentificationSequence)
                {
                    System.Windows.Forms.MessageBox.Show("The selected identification is already at the top");
                    return;
                }
                IdentificationSequence++;
                if (IdentificationSequence < 32767)
                {
                    R["IdentificationSequence"] = IdentificationSequence;
                    this.saveSpecimen(null, null);
                }
            }
        }

        private void toolStripButtonOverviewHierarchyIdentificationToBase_Click(object sender, EventArgs e)
        {
            int IdentificationSequence = 0;
            int IdentificationSequenceCurrent = 0;
            System.Data.DataRowView R = (System.Data.DataRowView)this.identificationBindingSource.Current;
            if (!int.TryParse(R["IdentificationSequence"].ToString(), out IdentificationSequenceCurrent)) return;
            System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.Identification.Select("IdentificationUnitID = " + R["IdentificationUnitID"].ToString(), "IdentificationSequence ASC");
            if (int.TryParse(RR[0]["IdentificationSequence"].ToString(), out IdentificationSequence))
            {
                if (IdentificationSequenceCurrent == IdentificationSequence)
                {
                    System.Windows.Forms.MessageBox.Show("The selected identification is already at the bottom");
                    return;
                }
                IdentificationSequence--;
                if (IdentificationSequence > -32768)
                {
                    R["IdentificationSequence"] = IdentificationSequence;
                    this.saveSpecimen(null, null);
                }
            }
        }

        private System.Data.DataRow createNewIdentification(IdentInsertType InsertType)
        {
            if (!this.ShowIdentification) this.toolStripButtonOverviewHierarchyShowIdentifications_Click(null, null);
            System.Data.DataRow R;
            DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationRow RIdent = this.dataSetCollectionSpecimen.Identification.NewIdentificationRow(); ;
            try
            {
                // Check if there are Identifications present
                int p = this.identificationUnitBindingSource.Position;
                System.Data.DataRow rU = this.dataSetCollectionSpecimen.IdentificationUnit.Rows[p];
                if (rU.RowState == DataRowState.Deleted)
                    return null;
                string TaxonomicGroup = rU["TaxonomicGroup"].ToString();
                int IdentificationUnitID = System.Int32.Parse(rU["IdentificationUnitID"].ToString());
                int CollectionSpecimenID = System.Int32.Parse(rU["CollectionSpecimenID"].ToString());
                System.Data.DataRow[] rrI = this.dataSetCollectionSpecimen.Identification.Select("IdentificationUnitID = " + IdentificationUnitID.ToString());
                int Sequence;
                System.Data.DataRow ri;
                if (rrI.Length == 0)
                {
                    Sequence = 0;
                }
                else
                {
                    System.Data.DataRow[] rr;
                    if (InsertType == IdentInsertType.Old)
                        rr = this.dataSetCollectionSpecimen.Identification.Select("", "IdentificationSequence ASC");
                    else
                        rr = this.dataSetCollectionSpecimen.Identification.Select("", "IdentificationSequence DESC");
                    ri = rr[0];
                    Sequence = System.Int16.Parse(ri["IdentificationSequence"].ToString());
                    if (InsertType == IdentInsertType.Old)
                        Sequence = Sequence - 1;
                    else
                        Sequence = Sequence + 1;
                    if (InsertType == IdentInsertType.Confirm)
                    {
                        p = this.identificationBindingSource.Position;
                        System.Data.DataRow r = this.dataSetCollectionSpecimen.Identification.Rows[p];
                        for (int i = 3; i < ri.ItemArray.Length; i++)
                        {
                            RIdent[i] = r[i];
                        }
                    }
                }
                // creating the new Datarow
                RIdent.CollectionSpecimenID = CollectionSpecimenID;
                RIdent.IdentificationUnitID = IdentificationUnitID;
                RIdent.IdentificationSequence = (System.Int16)Sequence;
                if (InsertType == IdentInsertType.Confirm) RIdent.IdentificationCategory = "confirmation";//rowVals[12] = "confirmation";
                //else rowVals[12] = "determination"; // auf Wunsch von D.T. abgeschaltet
                if (InsertType != IdentInsertType.Confirm)
                {
                    if (DiversityWorkbench.CollectionSpecimen.TaxonomyRelatedTaxonomicGroups.Contains(TaxonomicGroup))
                        RIdent.TaxonomicName = TaxonomicGroup;//rowVals[10] = TaxonomicGroup;
                    else
                        RIdent.VernacularTerm = TaxonomicGroup;
                }
                // setting the responsible user
                if (DiversityCollection.Specimen.DefaultUseIdentificationResponsible == true && 
                    DiversityCollection.Specimen.DefaultResponsibleName != null &&
                    DiversityCollection.Specimen.DefaultResponsibleName.Length > 0)
                {
                    RIdent["ResponsibleName"] = DiversityCollection.Specimen.DefaultResponsibleName;
                    RIdent["ResponsibleAgentURI"] = DiversityCollection.Specimen.DefaultResponsibleURI;
                }
                this.dataSetCollectionSpecimen.Identification.Rows.Add(RIdent);
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            R = (System.Data.DataRow)RIdent;
            return R;
        }

        private void setIdentificationTermControls()
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxTaxonomicGroup.SelectedItem;
            string Code = R["Code"].ToString();
            bool IsTaxonomyRelatedTaxonomicGroup = false;
            if (DiversityWorkbench.CollectionSpecimen.TaxonomyRelatedTaxonomicGroups.Contains(Code))
            {
                IsTaxonomyRelatedTaxonomicGroup = true;
            }

            this.labelIdentificationQualifier.Visible = IsTaxonomyRelatedTaxonomicGroup;
            this.comboBoxIdentificationQualifier.Visible = IsTaxonomyRelatedTaxonomicGroup;
            this.userControlHierarchySelectorIdentificationQualifier.Visible = IsTaxonomyRelatedTaxonomicGroup;

            this.labelTaxonomicName.Visible = IsTaxonomyRelatedTaxonomicGroup;
            this.userControlModuleRelatedEntryTaxonomicName.Visible = IsTaxonomyRelatedTaxonomicGroup;

            this.labelVernacularTerm.Visible = IsTaxonomyRelatedTaxonomicGroup;
            this.comboBoxVernacularTerm.Visible = IsTaxonomyRelatedTaxonomicGroup;

            this.labelTypeNotes.Visible = IsTaxonomyRelatedTaxonomicGroup;
            this.textBoxTypeNotes.Visible = IsTaxonomyRelatedTaxonomicGroup;

            this.comboBoxTypeStatus.Visible = IsTaxonomyRelatedTaxonomicGroup;
            this.labelTypeStatus.Visible = IsTaxonomyRelatedTaxonomicGroup;
            this.userControlHierarchySelectorTypeStatus.Visible = IsTaxonomyRelatedTaxonomicGroup;

            this.labelIdentificationScientificTerm.Visible = !IsTaxonomyRelatedTaxonomicGroup;
            this.userControlModuleRelatedEntryIdentificationScientificTerm.Visible = !IsTaxonomyRelatedTaxonomicGroup;

            this.labelCircumstances.Visible = IsTaxonomyRelatedTaxonomicGroup;
            this.comboBoxCircumstances.Visible = IsTaxonomyRelatedTaxonomicGroup;
            this.userControlHierarchySelectorCircumstances.Visible = IsTaxonomyRelatedTaxonomicGroup;

            this.labelFamilyCache.Visible = IsTaxonomyRelatedTaxonomicGroup;
            this.textBoxFamilyCache.Visible = IsTaxonomyRelatedTaxonomicGroup;

            this.labelOrderCache.Visible = IsTaxonomyRelatedTaxonomicGroup;
            this.textBoxOrderCache.Visible = IsTaxonomyRelatedTaxonomicGroup;

            this.buttonEditOrderAndFamily.Visible = IsTaxonomyRelatedTaxonomicGroup;
            this.buttonSetParentUnitID.Visible = IsTaxonomyRelatedTaxonomicGroup;

            this.labelIdentificationUnitID.Visible = IsTaxonomyRelatedTaxonomicGroup;

            this.labelGender.Visible = IsTaxonomyRelatedTaxonomicGroup;
            this.comboBoxGender.Visible = IsTaxonomyRelatedTaxonomicGroup;

            this.labelLifeStage.Visible = IsTaxonomyRelatedTaxonomicGroup;
            this.comboBoxLifeStage.Visible = IsTaxonomyRelatedTaxonomicGroup;

            this.labelSubstrateRelationType.Visible = IsTaxonomyRelatedTaxonomicGroup;
            this.comboBoxSubstrateRelationType.Visible = IsTaxonomyRelatedTaxonomicGroup;
        }

        private void comboBoxVernacularTerm_DropDown(object sender, EventArgs e)
        {
            if (this.identificationUnitBindingSource.Current == null) return;
            System.Data.DataRowView RV = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
            try
            {
                string TaxonomicGroup = RV["TaxonomicGroup"].ToString();
                string SQL = "SELECT DISTINCT Identification.VernacularTerm " +
                    "FROM Identification INNER JOIN " +
                    "IdentificationUnit ON Identification.CollectionSpecimenID = IdentificationUnit.CollectionSpecimenID AND  " +
                    "Identification.IdentificationUnitID = IdentificationUnit.IdentificationUnitID " +
                    "WHERE (IdentificationUnit.TaxonomicGroup = N'" + TaxonomicGroup + "')  " +
                    "AND (Identification.VernacularTerm <> N'') ";
                if (this.comboBoxVernacularTerm.Text.Length > 0)
                    SQL += "AND Identification.VernacularTerm LIKE '" + this.comboBoxVernacularTerm.Text + "%' ";
                SQL += "ORDER BY Identification.VernacularTerm";
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                System.Data.DataTable dt = new DataTable();
                ad.Fill(dt);
                this.comboBoxVernacularTerm.DataSource = dt;
                this.comboBoxVernacularTerm.DisplayMember = "VernacularTerm";
                this.comboBoxVernacularTerm.ValueMember = "VernacularTerm";
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void comboBoxVernacularTerm_SelectionChangeCommitted(object sender, EventArgs e)
        {
            System.Data.DataRowView RV = (System.Data.DataRowView)this.identificationBindingSource.Current;
            RV["VernacularTerm"] = this.comboBoxVernacularTerm.SelectedValue;
            this.comboBoxVernacularTerm.Text = this.comboBoxVernacularTerm.SelectedValue.ToString();
        }

        private void comboBoxTaxonomicGroup_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.setIdentificationTermControls();
        }

        private void buttonCollectorIsResponsible_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count > 0)
                {
                    System.Data.DataRowView RV = (System.Data.DataRowView)this.identificationBindingSource.Current;
                    if (this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count == 1)
                    {
                        RV["ResponsibleName"] = this.dataSetCollectionSpecimen.CollectionAgent.Rows[0]["CollectorsName"].ToString();
                        RV["ResponsibleAgentURI"] = this.dataSetCollectionSpecimen.CollectionAgent.Rows[0]["CollectorsAgentURI"].ToString();
                        this.userControlModuleRelatedEntryIdentificationResponsible.textBoxValue.Text = this.dataSetCollectionSpecimen.CollectionAgent.Rows[0]["CollectorsName"].ToString();
                        this.userControlModuleRelatedEntryIdentificationResponsible.labelURI.Text = this.dataSetCollectionSpecimen.CollectionAgent.Rows[0]["CollectorsAgentURI"].ToString();
                    }
                    else
                    {
                        string FirstCollector = this.dataSetCollectionSpecimen.CollectionAgent.Rows[0]["CollectorsName"].ToString();
                        string AllCollectors = FirstCollector;
                        if (this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count == 2)
                            AllCollectors += " & " + this.dataSetCollectionSpecimen.CollectionAgent.Rows[1]["CollectorsName"].ToString();
                        else
                        {
                            AllCollectors = "";
                            for (int i = 0; i < this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count - 1; i++)
                            {
                                if (i > 0) AllCollectors += ", ";
                                AllCollectors += this.dataSetCollectionSpecimen.CollectionAgent.Rows[i]["CollectorsName"].ToString();
                            }
                            AllCollectors += " & " + this.dataSetCollectionSpecimen.CollectionAgent.Rows[this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count - 1]["CollectorsName"].ToString();
                        }
                        DiversityCollection.Forms.FormCollectorIsResponsible f = new DiversityCollection.Forms.FormCollectorIsResponsible(FirstCollector, AllCollectors);
                        f.ShowDialog();
                        if (f.Responsible == DiversityCollection.Forms.FormCollectorIsResponsible.CollectorAsIdentifier.first)
                        {
                            RV["ResponsibleName"] = this.dataSetCollectionSpecimen.CollectionAgent.Rows[0]["CollectorsName"].ToString();
                            RV["ResponsibleAgentURI"] = this.dataSetCollectionSpecimen.CollectionAgent.Rows[0]["CollectorsAgentURI"].ToString();
                            this.userControlModuleRelatedEntryIdentificationResponsible.textBoxValue.Text = this.dataSetCollectionSpecimen.CollectionAgent.Rows[0]["CollectorsName"].ToString();
                            this.userControlModuleRelatedEntryIdentificationResponsible.labelURI.Text = this.dataSetCollectionSpecimen.CollectionAgent.Rows[0]["CollectorsAgentURI"].ToString();
                        }
                        else if (f.Responsible == DiversityCollection.Forms.FormCollectorIsResponsible.CollectorAsIdentifier.all)
                        {
                            RV["ResponsibleName"] = AllCollectors;
                            RV["ResponsibleAgentURI"] = System.DBNull.Value;
                            this.userControlModuleRelatedEntryIdentificationResponsible.textBoxValue.Text = AllCollectors;
                            this.userControlModuleRelatedEntryIdentificationResponsible.labelURI.Text = "";
                        }
                    }

                }
                else
                {
                    System.Windows.Forms.MessageBox.Show("There is no collector");
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #region Template

        private void buttonTemplateIdentificationSet_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.TemplateForData T = new DiversityWorkbench.TemplateForData("Identification", TemplateIdentificationSuppressedColumns);
            System.Data.DataRowView R = (System.Data.DataRowView)this.identificationBindingSource.Current;
            T.CopyTemplateToRow(R.Row);
        }

        private System.Collections.Generic.List<string> TemplateIdentificationSuppressedColumns
        {
            get
            {
                System.Collections.Generic.List<string> Suppress = new List<string>();
                Suppress.Add("CollectionSpecimenID");
                Suppress.Add("IdentificationUnitID");
                Suppress.Add("IdentificationSequence");
                Suppress.Add("IdentificationDate");
                Suppress.Add("LogCreatedWhen");
                Suppress.Add("LogCreatedBy");
                Suppress.Add("LogUpdatedWhen");
                Suppress.Add("LogUpdatedBy");
                Suppress.Add("RowGUID");
                return Suppress;
            }
        }

        private void buttonTemplateIdentificationEdit_Click(object sender, EventArgs e)
        {
            System.Data.DataRow R = ((System.Data.DataRowView)this.identificationBindingSource.Current).Row;
            DiversityWorkbench.Forms.FormTemplateEditor f = new DiversityWorkbench.Forms.FormTemplateEditor("Identification", R, this.TemplateIdentificationSuppressedColumns);
            f.setHelp("Template");
            f.ShowDialog();
        }
        
        #endregion

        #endregion

        #region Identification unit

        private void setToolStripDropDownButtonOverviewHierarchyNewUnit()
        {
            this.toolStripDropDownButtonOverviewHierarchyNewUnit.DropDownItems.Clear();
            try
            {
                foreach (System.Data.DataRow R in DiversityCollection.LookupTable.DtTaxonomicGroupList.Rows)
                {
                    try
                    {
                        string Entity = "CollTaxonomicGroup_Enum.Code." + R["Code"].ToString();
                        string Caption = DiversityWorkbench.Entity.EntityInformation(Entity, "General", DiversityWorkbench.Settings.Language)["DisplayText"];
                        System.Drawing.Image Image = DiversityCollection.Specimen.TaxonImage(false, R["Code"].ToString());
                        System.Windows.Forms.ToolStripMenuItem mi = new System.Windows.Forms.ToolStripMenuItem(Caption, Image, newUnit);
                        mi.Tag = R["Code"];
                        try
                        {
                            this.toolStripDropDownButtonOverviewHierarchyNewUnit.DropDownItems.Add(mi);
                        }
                        catch (System.Exception ex)
                        { }
                    }
                    catch (System.Exception ex)
                    {
                    }
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        private void setToolStripDropDownButtonOverviewHierarchyNewUnitWithAdaptiveHierarchy()
        {
            this.toolStripDropDownButtonOverviewHierarchyNewUnit.DropDownItems.Clear();
            System.Collections.Generic.Dictionary<string, string> TaxonomicGroupHierarchy = new Dictionary<string, string>();
            try
            {
                foreach (System.Data.DataRow R in DiversityCollection.LookupTable.DtTaxonomicGroupList.Rows)//.DtMaterialCategoryList.Rows)
                {
                    try
                    {
                        string Code = R["Code"].ToString();
                        string Parent = DiversityCollection.LookupTable.TaxonomicGroupVisibleParent(R["Code"].ToString()); ;
                        if (!TaxonomicGroupHierarchy.ContainsKey(Code))
                            TaxonomicGroupHierarchy.Add(Code, Parent);
                        else
                        {
                        }
                    }
                    catch (System.Exception ex)
                    {
                    }
                }
                foreach (System.Collections.Generic.KeyValuePair<string, string> KV in TaxonomicGroupHierarchy)
                {
                    if (KV.Value.Length == 0)
                    {
                        string Caption = KV.Key;
                        if (DiversityCollection.Specimen.TaxonomicGroup_Images.ContainsKey(KV.Key))
                        {
                            try
                            {
                                System.Drawing.Image Image = DiversityCollection.Specimen.TaxonImage(false, KV.Key);
                                System.Windows.Forms.ToolStripMenuItem mi = new System.Windows.Forms.ToolStripMenuItem(Caption, Image, newUnit);
                                mi.Tag = KV.Key;
                                System.Data.DataRow[] RR = DiversityCollection.LookupTable.DtTaxonomicGroupList.Select("Code = '" + KV.Key + "'");
                                mi.ToolTipText = "Insert a new " + RR[0]["Description"].ToString();
                                this.toolStripDropDownButtonOverviewHierarchyNewUnit.DropDownItems.Add(mi);
                                this.setToolStripDropDownButtonOverviewHierarchyNewUnitWithAdaptiveHierarchy(mi, ref TaxonomicGroupHierarchy);
                            }
                            catch (System.Exception ex)
                            {
                            }
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        private void setToolStripDropDownButtonOverviewHierarchyNewUnitWithAdaptiveHierarchy(System.Windows.Forms.ToolStripMenuItem ToolStripMenuItem, ref System.Collections.Generic.Dictionary<string, string> TaxonCodes)
        {
            try
            {
                string Code = ToolStripMenuItem.Tag.ToString();
                foreach (System.Collections.Generic.KeyValuePair<string, string> KV in TaxonCodes)
                {
                    if (KV.Value == Code)
                    {
                        string Caption = KV.Key;
                        System.Drawing.Image Image = DiversityCollection.Specimen.TaxonImage(false, KV.Key);
                        System.Windows.Forms.ToolStripMenuItem mi = new System.Windows.Forms.ToolStripMenuItem(Caption, Image, newUnit);
                        mi.Tag = KV.Key;
                        System.Data.DataRow[] RR = DiversityCollection.LookupTable.DtTaxonomicGroupList.Select("Code = '" + KV.Key + "'");
                        mi.ToolTipText = "Insert a new " + RR[0]["Description"].ToString();
                        ToolStripMenuItem.DropDownItems.Add(mi);
                        this.setToolStripDropDownButtonOverviewHierarchyNewUnitWithAdaptiveHierarchy(mi, ref TaxonCodes);
                    }
                }
            }
            catch { }
        }

        private void newUnit(object sender, System.EventArgs e)
        {
            if (this.treeViewOverviewHierarchy.SelectedNode == null) return;
            if (this.treeViewOverviewHierarchy.SelectedNode.Tag == null) return;
            if (this.treeViewOverviewHierarchy.SelectedNode != null)
            {
                System.Windows.Forms.ToolStripMenuItem M = (System.Windows.Forms.ToolStripMenuItem)sender;
                string TaxonomicGroup = M.Tag.ToString();
                try
                {
                    System.Data.DataRow DataRow = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                    string Table = DataRow.Table.TableName;
                    int? RelatedUnitID = null;
                    try
                    {
                        if (!this.ShowUnit) this.toolStripButtonOverviewHierarchyShowUnits_Click(null, null);
                        int DisplayOrder = 1;
                        if (this.dataSetCollectionSpecimen.IdentificationUnit.Rows.Count > 0)
                        {
                            System.Data.DataRow[] rrDO = this.dataSetCollectionSpecimen.IdentificationUnit.Select("", "DisplayOrder DESC");
                            DisplayOrder = int.Parse(rrDO[0]["DisplayOrder"].ToString()) + 1;
                        }
                        if (Table == "IdentificationUnit")
                            RelatedUnitID = System.Int32.Parse(DataRow["IdentificationUnitID"].ToString());
                        int UnitID = 0;
                        string SQL = "INSERT INTO IdentificationUnit (CollectionSpecimenID, LastIdentificationCache, TaxonomicGroup, DisplayOrder ";
                        if (RelatedUnitID != null)
                            SQL += ", RelatedUnitID";
                        SQL += ") VALUES (" + DataRow["CollectionSpecimenID"].ToString() + ", '" + TaxonomicGroup + "', '" + TaxonomicGroup + "', " + DisplayOrder.ToString();
                        if (RelatedUnitID != null)
                            SQL += ", " + RelatedUnitID.ToString();
                        SQL += ") (SELECT SCOPE_IDENTITY() AS [SCOPE_IDENTITY])";
                        UnitID = int.Parse(DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL));
                        SQL = "SELECT MAX(IdentificationUnitID) FROM IdentificationUnit where LogCreatedBy = suser_sname()";
                        int TestUnitID;
                        if (int.TryParse(DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL), out TestUnitID))
                        {
                            if (TestUnitID != UnitID)
                            {
                                UnitID = TestUnitID;
                            }
                        }
                        this.setSpecimen(int.Parse(DataRow["CollectionSpecimenID"].ToString()));
                        this.buildOverviewHierarchyUnits();

                        System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.IdentificationUnit.Select("IdentificationUnitID = " + UnitID.ToString());
                        if (RR.Length > 0)
                        {
                            this.treeViewOverviewHierarchy.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, RR[0]);
                            System.Data.DataRow R = this.createNewIdentification(IdentInsertType.New);
                            this.refreshHierarchyUnitUnitNodes(this.treeViewOverviewHierarchy.SelectedNode);
                            this.treeViewOverviewHierarchy.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, R);
                        }
                    }
                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                }
                catch { return; }
            }
        }

        private void comboBoxUnitPart_DropDown(object sender, EventArgs e)
        {
            if (this.identificationUnitBindingSource != null)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
                if (!R["TaxonomicGroup"].Equals(System.DBNull.Value))
                {
                    string TaxonomicGroup = R["TaxonomicGroup"].ToString();
                    string SQL = "SELECT DISTINCT UnitDescription FROM IdentificationUnit WHERE TaxonomicGroup = '" + TaxonomicGroup + "' AND UnitDescription <> '' AND NOT UnitDescription IS NULL";
                    if (this.comboBoxUnitDescription.Text.Length > 0) SQL += " AND UnitDescription Like '" + this.comboBoxUnitDescription.Text + "%'";
                    SQL += " ORDER BY UnitDescription";
                    System.Data.DataTable dt = new DataTable();
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(dt);
                    foreach (System.Collections.Generic.KeyValuePair<string, int> KV in DiversityCollection.Specimen.UnitPartList(TaxonomicGroup))
                    {
                        if (this.comboBoxUnitDescription.Text.Length > 0 && !KV.Key.StartsWith(this.comboBoxUnitDescription.Text)) 
                            continue;
                        System.Data.DataRow[] rr = dt.Select("UnitDescription ='" + KV.Key + "'");
                        if (rr.Length == 0)
                        {
                            System.Data.DataRow RN = dt.NewRow();
                            RN["UnitDescription"] = KV.Key;
                            dt.Rows.Add(RN);
                        }
                    }
                    this.comboBoxUnitDescription.DataSource = dt;
                    this.comboBoxUnitDescription.DisplayMember = "UnitDescription";
                    this.comboBoxUnitDescription.ValueMember = "UnitDescription";
                }
            }
        }

        private void comboBoxUnitPart_SelectionChangeCommitted(object sender, EventArgs e)
        {

        }

        private void comboBoxSubstrateRelationType_DropDown(object sender, EventArgs e)
        {
            //this.buttonSetParentUnitID.Enabled = false;
            //try
            //{
            //    System.Data.DataRowView RV = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
            //    System.Data.DataTable dt = this.dataSetCollectionSpecimen.IdentificationUnit.Copy();
            //    System.Collections.Generic.List<System.Data.DataRow> RR = new List<DataRow>();
            //    foreach(System.Data.DataRow R in dt.Rows)
            //    {

            //    }
            //}
            //catch (System.Exception ex) { }
        }

        private void comboBoxSubstrateRelationType_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.buttonSetParentUnitID.Enabled = false;
            if (this.identificationUnitBindingSource.Current != null)
            {
                System.Data.DataRowView RV = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
                if (RV["RelationType"].ToString() == "Child of" || comboBoxSubstrateRelationType.SelectedValue.ToString() == "Child of")
                    this.buttonSetParentUnitID.Enabled = true;
            }
        }

        private void buttonSetParentUnitID_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRowView RV = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
                System.Data.DataTable dt = this.dataSetCollectionSpecimen.IdentificationUnit.Copy();
                //System.Collections.Generic.List<System.Data.DataRow> RowsToRemove = new List<DataRow>();
                System.Collections.Generic.Dictionary<int, string> ParentList = new Dictionary<int,string>();
                foreach (System.Data.DataRow R in dt.Rows)
                {
                    if (R["IdentificationUnitID"].ToString() != RV["IdentificationUnitID"].ToString() &&
                        R["IdentificationUnitID"].ToString() != RV["RelatedUnitID"].ToString())
                    {
                        DiversityCollection.HierarchyNode N = new HierarchyNode(R);
                        ParentList.Add(int.Parse(R["IdentificationUnitID"].ToString()), N.Text.Trim());
                        //RowsToRemove.Add(R);
                    }
                }
                ParentList.Add(-1, "");
                //foreach (System.Data.DataRow R in RowsToRemove)
                //    R.Delete();
                //System.Data.DataRow RNew = dt.NewRow();
                //dt.Rows.Add(RNew);
                DiversityWorkbench.FormGetStringFromList f = new DiversityWorkbench.FormGetStringFromList(ParentList, "Parent", "Please select the parent from the list");
                f.ShowDialog();
                if (f.DialogResult == System.Windows.Forms.DialogResult.OK && f.SelectedString.Length > 0 && f.SelectedValue.ToString() != "-1")
                {
                    RV["ParentUnitID"] = int.Parse(f.SelectedValue);
                    this.buildOverviewHierarchy();
                }
            }
            catch (System.Exception ex) { }
        }

        private void textBoxIdentificationUnitID_ReadOnlyChanged(object sender, EventArgs e)
        {
            if (!textBoxIdentificationUnitID.ReadOnly)
                textBoxIdentificationUnitID.ReadOnly = true;
        }

        private void buttonTemplateUnitEdit_Click(object sender, EventArgs e)
        {
            System.Data.DataRow R = ((System.Data.DataRowView)this.identificationUnitBindingSource.Current).Row;
            DiversityWorkbench.Forms.FormTemplateEditor f = new DiversityWorkbench.Forms.FormTemplateEditor("IdentificationUnit", R, this.TemplateUnitSuppressedColumns);
            f.setHelp("Template");
            f.ShowDialog();
        }

        private System.Collections.Generic.List<string> TemplateUnitSuppressedColumns
        {
            get
            {
                System.Collections.Generic.List<string> Suppress = new List<string>();
                Suppress.Add("CollectionSpecimenID");
                Suppress.Add("IdentificationUnitID");
                Suppress.Add("LastIdentificationCache");
                Suppress.Add("RelatedUnitID");
                Suppress.Add("DisplayOrder");
                Suppress.Add("ParentUnitID");
                Suppress.Add("LogCreatedWhen");
                Suppress.Add("LogCreatedBy");
                Suppress.Add("LogUpdatedWhen");
                Suppress.Add("LogUpdatedBy");
                Suppress.Add("RowGUID");
                return Suppress;
            }
        }

        private void buttonTemplateUnitSet_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.TemplateForData T = new DiversityWorkbench.TemplateForData("IdentificationUnit", TemplateUnitSuppressedColumns);
            System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
            T.CopyTemplateToRow(R.Row);
        }

        private void pictureBoxWithholdUnit_Click(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
            DiversityWorkbench.FormGetString f = new DiversityWorkbench.FormGetString("Datawithholding", "Enter the datawithholding reason", R["DatawithholdingReason"].ToString());
            f.ShowDialog();
            if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
            {
                R["DatawithholdingReason"] = f.String;
                this.setUnitDatawithholding();
            }
        }

        private void setUnitDatawithholding()
        {
            try
            {
                if (this.identificationUnitBindingSource.Current == null)
                    this.pictureBoxWithholdUnit.Visible = false;
                else
                {
                    this.pictureBoxWithholdUnit.Visible = true;
                    System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitBindingSource.Current;
                    if (R["DataWithholdingReason"].Equals(System.DBNull.Value) || R["DataWithholdingReason"].ToString().Trim().Length == 0)
                    {
                        this.pictureBoxWithholdUnit.Image = this.imageListDataWithholding.Images[1];
                        this.toolTip.SetToolTip(this.pictureBoxWithholdUnit, "Set the withholding reason for this organism");
                    }
                    else
                    {
                        this.pictureBoxWithholdUnit.Image = this.imageListDataWithholding.Images[0];
                        this.toolTip.SetToolTip(this.pictureBoxWithholdUnit, "Withholding reason: " + R["DataWithholdingReason"].ToString());
                    }
                }
            }
            catch(System.Exception ex)
            { }
        }

        private void toolStripButtonOverviewHierarchyTaxonList_Click(object sender, EventArgs e)
        {
            if (this.treeViewOverviewHierarchy.SelectedNode != null &&
                this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
            {
                System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                DiversityCollection.Forms.FormTaxonList f = new DiversityCollection.Forms.FormTaxonList(R);
                f.ShowDialog();
            }
        }

        private void toolStripButtonOverviewHierarchyTaxonEdit_Click(object sender, EventArgs e)
        {
            if (this.treeViewOverviewHierarchy.SelectedNode != null &&
                this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
            {
                try
                {
                    string Title = this.labelHeaderAccessionNumber.Text;
                    if (this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].Equals(System.DBNull.Value) ||
                        this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["AccessionNumber"].ToString().Length == 0)
                        Title = "ID " + this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionSpecimenID"].ToString();
                    Title = "Organisms of " + Title;
                    DiversityCollection.FormIdentificationUnitGridMode f = new FormIdentificationUnitGridMode(this.ID, Title, this.userControlQueryList.ProjectID);
                    f.Width = this.Width - 10;
                    f.Height = this.Height - 10;
                    DiversityWorkbench.FormFunctions.SetHelp(this.helpProviderDiversityCollection, f, "Grid specimen organisms");
                    f.ShowDialog();
                    this.setSpecimen(this.ID);
                }
                catch (System.Exception ex)
                {
                }
            }
        }

        private void comboBoxUnitRetrievalType_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                this.pictureBoxUnitRetrievalType.Image = DiversityCollection.Specimen.ImageForRetrievalType(this.comboBoxUnitRetrievalType.SelectedValue.ToString());
            }
            catch (System.Exception ex)
            {
            }
        }

        #endregion

        #region GeoAnalysis

        private void toolStripButtonOverviewHierarchyNewUnitGeoObject_Click(object sender, EventArgs e)
        {
            if (!this.ShowGeoAnalysis) this.toolStripButtonOverviewHierarchyShowGeoAnalysis_Click(null, null);
            try
            {
                int p = this.identificationUnitBindingSource.Position;
                System.Data.DataRow rU = this.dataSetCollectionSpecimen.IdentificationUnit.Rows[p];
                int IdentificationUnitID = System.Int32.Parse(rU["IdentificationUnitID"].ToString());

                System.Data.DataRow R = this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysis.NewRow();
                R["CollectionSpecimenID"] = this.SpecimenID;
                R["IdentificationUnitID"] = IdentificationUnitID;
                R["AnalysisDate"] = System.DateTime.Now;
                this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysis.Rows.Add(R);
                this.hideOverviewHierarchyGeoAnalysis();
                this.addOverviewHierarchyGeoAnalysis(true);
                this.treeViewOverviewHierarchy.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, R);
                this.userControlGIS.DataRowIdentificationUnitGeoAnalysisGeo = R;
                this.userControlGIS.SelectedGISObject = DiversityCollection.UserControls.UserControlGIS.SelectedGisObject.Organism;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void dateTimePickerGeoAnalysisDate_CloseUp(object sender, EventArgs e)
        {
            //System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitGeoAnalysisBindingSource.Current;
            //string DateString = this.dateTimePickerGeoAnalysisDate.Value.Year.ToString() + "/";
            //if (this.dateTimePickerGeoAnalysisDate.Value.Month < 10) DateString += "0";
            //DateString += this.dateTimePickerGeoAnalysisDate.Value.Month.ToString() + "/";
            //if (this.dateTimePickerGeoAnalysisDate.Value.Day < 10) DateString += "0";
            //DateString += this.dateTimePickerGeoAnalysisDate.Value.Day.ToString() + " ";
            //if (this.dateTimePickerGeoAnalysisDate.Value.Hour < 10) DateString += "0";
            //DateString += this.dateTimePickerGeoAnalysisDate.Value.Hour.ToString() + ":";
            //if (this.dateTimePickerGeoAnalysisDate.Value.Minute < 10) DateString += "0";
            //DateString += this.dateTimePickerGeoAnalysisDate.Value.Minute.ToString();
            //R["AnalysisDate"] = DateString;
            //this.maskedTextBoxGeoAnalysisDate.Text = DateString;
            //this.treeViewOverviewHierarchy.SelectedNode.Text = this.dateTimePickerGeoAnalysisDate.Value.ToShortDateString();
        }

        private void ShowGeoAnalysisMap()
        {
            //this.setMapControls();
            //this.toolStripButtonGeoAnalysis.BackColor = System.Drawing.Color.Red;
            this.setImageVisibility("1000");
            //this.toolStripButtonGeoAnalysis_Click(null, null);
            //int iSelectedGeoAnalysis = this.identificationUnitGeoAnalysisBindingSource.Position;
            //System.Collections.Generic.List<string> GeographyStringsForGoogleMaps
            //    = DiversityWorkbench.GeoFunctions.getGeographyStringsForGoogleMaps(this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo.Rows[iSelectedGeoAnalysis][3].ToString());
            //this.userControlGoogleMaps.setUrlForPolygon(GeographyStringsForGoogleMaps[0], GeographyStringsForGoogleMaps[1], GeographyStringsForGoogleMaps[2], GeographyStringsForGoogleMaps[3]);
        }

        private void buttonGeoAnalysisSet_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRowView RA
                    = (System.Data.DataRowView)this.identificationUnitGeoAnalysisBindingSource.Current;

                System.Data.DataRow[] RRGA = this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysis.Select(
                    "IdentificationUnitID = " + RA["IdentificationUnitID"].ToString() +
                    " AND CollectionSpecimenID = " + RA["CollectionSpecimenID"].ToString());// +

                System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo.Select(
                    "IdentificationUnitID = " + RA["IdentificationUnitID"].ToString() +
                    " AND CollectionSpecimenID = " + RA["CollectionSpecimenID"].ToString());

                if (RR.Length + 1 == RRGA.Length)
                {
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeoRow R = this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo.NewIdentificationUnitGeoAnalysisGeoRow();
                    R.IdentificationUnitID = int.Parse(RA["IdentificationUnitID"].ToString());
                    R.CollectionSpecimenID = int.Parse(RA["CollectionSpecimenID"].ToString());
                    R.AnalysisDate = System.DateTime.Parse(RA["AnalysisDate"].ToString());
                    this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo.Rows.Add(R);
                    this.setGeographyViaGisEditor(R);
                }

                else if (RR.Length == 1 && RRGA.Length == 1)
                {
                    this.setGeographyViaGisEditor((DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeoRow)RR[0]);
                }
                else if (RR.Length == 0)
                {
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeoRow R = this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo.NewIdentificationUnitGeoAnalysisGeoRow();
                    R.IdentificationUnitID = int.Parse(RA["IdentificationUnitID"].ToString());
                    R.CollectionSpecimenID = int.Parse(RA["CollectionSpecimenID"].ToString());
                    R.AnalysisDate = System.DateTime.Parse(RA["AnalysisDate"].ToString());
                    this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo.Rows.Add(R);
                    this.setGeographyViaGisEditor(R);
                }
                else
                {
                    bool RowFound = false;
                    System.DateTime AnalysisDate;
                    if (System.DateTime.TryParse(RA["AnalysisDate"].ToString(), out AnalysisDate))
                    {
                        foreach (System.Data.DataRow Ra in RR)
                        {
                            System.DateTime CurrentAnalysisDate;
                            if (System.DateTime.TryParse(Ra["AnalysisDate"].ToString(), out CurrentAnalysisDate))
                            {
                                if (CurrentAnalysisDate == AnalysisDate)
                                {
                                    this.setGeographyViaGisEditor((DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeoRow)Ra);
                                    RowFound = true;
                                    break;
                                }
                            }
                        }
                    }
                    if (!RowFound)
                    {
                        System.Data.DataRow[] RRmissing = this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo.Select("", "AnalysisDate DESC");
                        this.setGeographyViaGisEditor((DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeoRow)RRmissing[0]);
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setGeographyViaGisEditor(DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeoRow R)
        {
            try
            {
                GeoObject GO = new GeoObject();
                string Geography = "";
                // getting a geography to start with
                if (!R["GeographyAsString"].Equals(System.DBNull.Value))
                    Geography = R.GeographyAsString.ToString();
                else
                {
                    System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeo.Select("GeographyAsString <> ''", "");
                    if (RR.Length > 0)
                    {
                        Geography = RR[0]["GeographyAsString"].ToString();
                    }
                    else if (this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Rows.Count > 0
                        && !this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Rows[0]["GeographyAsString"].Equals(System.DBNull.Value))
                    {
                        Geography = this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Rows[0]["GeographyAsString"].ToString();
                    }
                    else if (DiversityWorkbench.Settings.GeoLatitude != 0 && DiversityWorkbench.Settings.GeoLongitude != 0)
                    {
                        Geography = "POINT(" + DiversityWorkbench.Settings.GeoLongitude.ToString() + " " + DiversityWorkbench.Settings.GeoLatitude.ToString() + ")";
                    }
                    else
                    {
                        Geography = "POINT(0 0)";
                    }
                }

                GO.GeometryData = Geography;
                GO.FillBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(255, 1, 1));
                GO.FillTransparency = 50;
                GO.Identifier = "X";
                GO.PointSymbolSize = 1;
                GO.StrokeBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromRgb(255, 1, 1));
                GO.StrokeThickness = 1;
                GO.StrokeTransparency = 255;
                string Unit = "Organism";
                System.Data.DataRow[] RRunit = this.dataSetCollectionSpecimen.IdentificationUnit.Select("IdentificationUnitID = " + R["IdentificationUnitID"].ToString(), "");
                Unit = RRunit[0]["LastIdentificationCache"].ToString();
                GO.DisplayText = "New position of " + Unit;
                System.Collections.Generic.List<GeoObject> L = new List<GeoObject>();
                L.Add(GO);
                DiversityWorkbench.FormGeography f = new DiversityWorkbench.FormGeography(L);
                f.ShowDialog();
                if (f.DialogResult == DialogResult.OK && f.Geography.Length > 0)
                {
                    string SQL = "Update IdentificationUnitGeoAnalysis SET Geography = geography::STGeomFromText('" + f.Geography + "', 4326)"
                        + " WHERE CollectionSpecimenID = " + R.CollectionSpecimenID.ToString()
                        + " AND IdentificationUnitID = " + R.IdentificationUnitID.ToString();
                    if (!R["AnalysisDate"].Equals(System.DBNull.Value))
                    {
                        System.DateTime AnalysisDate;
                        if (System.DateTime.TryParse(R["AnalysisDate"].ToString(), out AnalysisDate))
                        {
                            SQL += " AND YEAR(AnalysisDate) = " + AnalysisDate.Year.ToString()
                                + " AND MONTH(AnalysisDate) = " + AnalysisDate.Month.ToString()
                                + " AND DAY(AnalysisDate) = " + AnalysisDate.Day.ToString()
                                + " AND DATEPART(hh, AnalysisDate) = " + AnalysisDate.Hour.ToString()
                                + " AND DATEPART(n, AnalysisDate) = " + AnalysisDate.Minute.ToString()
                                + " AND DATEPART(s, AnalysisDate) = " + AnalysisDate.Second.ToString();
                        }
                    }
                    this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "IdentificationUnitGeoAnalysis", this.sqlDataAdapterGeoAnalysis, this.BindingContext);
                    string Message = "";
                    if (DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL, ref Message))
                    {
                        R["GeographyAsString"] = f.Geography;
                        R.BeginEdit();
                        R.EndEdit();
                        this.setSpecimen(this.ID);
                    }
                    else
                    {
                        System.Windows.Forms.MessageBox.Show("Setting of the geography failed");
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile("setGeographyViaGisEditor(DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitGeoAnalysisGeoRow R)", SQL, Message);
                    }
                }
                else if (R.GeographyAsString.Equals(System.DBNull.Value))
                {
                    System.Windows.Forms.MessageBox.Show("No geography was given");
                }
            }
            catch (System.Exception ex) 
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

      
        #endregion

        #region Analysis

        #region Common

        private void prepareToolStripDropDownButtonAnalysis(System.Windows.Forms.TreeNode Node, System.Windows.Forms.ToolStripDropDownButton ToolStripDropDownButton, bool ForParts)
        {
            bool CanInsert = this.FormFunctions.getObjectPermissions("IdentificationUnitAnalysis", "INSERT");
            if (!CanInsert)
            {
                ToolStripDropDownButton.Visible = false;
                return;
            }
            if (Node.Tag == null) return;
            string TaxonomicGroup = "";
            try
            {
                if (ToolStripDropDownButton.DropDownItems.Count > 0)
                    ToolStripDropDownButton.DropDownItems.Clear();
                System.Data.DataRow DataRow = (System.Data.DataRow)Node.Tag;
                if (!ForParts)
                {
                    string Table = DataRow.Table.TableName;
                    switch (Table)
                    {
                        case "IdentificationUnitAnalysis":
                            System.Data.DataRow PRow = (System.Data.DataRow)Node.Parent.Tag;
                            if (PRow.Table.Columns.Contains("TaxonomicGroup"))
                                TaxonomicGroup = PRow["TaxonomicGroup"].ToString();
                            else
                            {
                                System.Data.DataRow PPRow = (System.Data.DataRow)Node.Parent.Parent.Tag;
                                if (PPRow.Table.Columns.Contains("TaxonomicGroup"))
                                    TaxonomicGroup = PPRow["TaxonomicGroup"].ToString();
                                else
                                {
                                    System.Data.DataRow PPPRow = (System.Data.DataRow)Node.Parent.Parent.Parent.Tag;
                                    if (PPPRow.Table.Columns.Contains("TaxonomicGroup"))
                                        TaxonomicGroup = PPPRow["TaxonomicGroup"].ToString();
                                }
                            }
                            break;
                        case "IdentificationUnit":
                            TaxonomicGroup = DataRow["TaxonomicGroup"].ToString();
                            break;
                        default:
                            return;
                            break;
                    }
                }
                else
                {
                    string SpecimenID = "";
                    string UnitID = "";
                    SpecimenID = DataRow["CollectionSpecimenID"].ToString();
                    UnitID = DataRow["IdentificationUnitID"].ToString();
                    string Select = "CollectionSpecimenID = " + SpecimenID + " AND IdentificationUnitID = " + UnitID;
                    System.Data.DataRow[] RUnit = this.dataSetCollectionSpecimen.IdentificationUnit.Select(Select);
                    TaxonomicGroup = RUnit[0]["TaxonomicGroup"].ToString();
                }
                //System.Data.DataTable dtAnalyis = DiversityCollection.LookupTable.Analysis(TaxonomicGroup, true);
                int IdentificationUnitID = 0;
                if (int.TryParse(DataRow["IdentificationUnitID"].ToString(), out IdentificationUnitID))
                {
                    System.Data.DataTable dtAnalyis = DiversityCollection.LookupTable.AnalysisForUnit(IdentificationUnitID);//(TaxonomicGroup, true);
                    foreach (System.Data.DataRow R in dtAnalyis.Rows)
                    {
                        if (R["AnalysisParentID"].Equals(System.DBNull.Value))
                        {
                            string Caption = R["DisplayText"].ToString();
                            System.Windows.Forms.ToolStripMenuItem mi;
                            if (ForParts)
                                mi = new System.Windows.Forms.ToolStripMenuItem(Caption, null, menuItemOverviewHierarchyAnalysisForPartsOnClick);
                            else
                                mi = new System.Windows.Forms.ToolStripMenuItem(Caption, null, menuItemOverviewHierarchyAnalysisOnClick);
                            mi.Tag = R["AnalysisID"];
                            mi.Image = global::DiversityCollection.Resource.Analysis;
                            mi.ToolTipText = R["Description"].ToString();
                            ToolStripDropDownButton.DropDownItems.Add(mi);
                            this.addChildsToDropDownButtonAnalysis(mi, dtAnalyis, R["AnalysisID"].ToString(), ForParts);



                            //if (R["TaxonomicGroup"].ToString() == TaxonomicGroup)
                            //{
                            //    if (ForParts)
                            //        mi = new System.Windows.Forms.ToolStripMenuItem(Caption, null, menuItemOverviewHierarchyAnalysisForPartsOnClick);
                            //    else
                            //        mi = new System.Windows.Forms.ToolStripMenuItem(Caption, null, menuItemOverviewHierarchyAnalysisOnClick);
                            //    mi.Tag = R["AnalysisID"];
                            //    mi.Image = global::DiversityCollection.Resource.Analysis;
                            //    mi.ToolTipText = R["Description"].ToString();
                            //    ToolStripDropDownButton.DropDownItems.Add(mi);
                            //    this.addChildsToDropDownButtonAnalysis(mi, TaxonomicGroup, dtAnalyis, R["AnalysisID"].ToString(), ForParts);
                            //}
                            //else
                            //{
                            //    mi = new System.Windows.Forms.ToolStripMenuItem(Caption);
                            //    mi.ForeColor = System.Drawing.Color.Blue;
                            //    ToolStripDropDownButton.DropDownItems.Add(mi);
                            //    this.addChildsToDropDownButtonAnalysis(mi, TaxonomicGroup, dtAnalyis, R["AnalysisID"].ToString(), ForParts);
                            //}
                        }
                    }

                    // getting all the entries without top parents in the table
                    foreach (System.Data.DataRow R in dtAnalyis.Rows)
                    {
                        if (!R["AnalysisParentID"].Equals(System.DBNull.Value))
                        {
                            System.Data.DataRow[] RR = dtAnalyis.Select("AnalysisID = " + R["AnalysisParentID"].ToString());
                            if (RR.Length == 0)
                            {
                                string Caption = R["DisplayText"].ToString();
                                System.Windows.Forms.ToolStripMenuItem mi;
                                if (ForParts)
                                    mi = new System.Windows.Forms.ToolStripMenuItem(Caption, null, menuItemOverviewHierarchyAnalysisForPartsOnClick);
                                else
                                    mi = new System.Windows.Forms.ToolStripMenuItem(Caption, null, menuItemOverviewHierarchyAnalysisOnClick);
                                mi.Tag = R["AnalysisID"];
                                mi.Image = global::DiversityCollection.Resource.Analysis;
                                mi.ToolTipText = R["Description"].ToString();
                                ToolStripDropDownButton.DropDownItems.Add(mi);
                                this.addChildsToDropDownButtonAnalysis(mi, dtAnalyis, R["AnalysisID"].ToString(), ForParts);
                            }
                        }
                    }

                }
                if (ToolStripDropDownButton.DropDownItems.Count > 0)
                    ToolStripDropDownButton.Visible = true;
                else
                    ToolStripDropDownButton.Visible = false;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void prepareToolStripDropDownButtonsAnalysis(System.Windows.Forms.TreeNode Node)
        {
            this.prepareToolStripDropDownButtonAnalysis(Node, this.toolStripDropDownButtonOverviewHierarchyNewAnalysis, false);
        }

        private void addChildsToDropDownButtonAnalysis(System.Windows.Forms.ToolStripMenuItem ToolStripMenuItem, string TaxonomicGroup, System.Data.DataTable DtAnalysis, string AnalysisID, bool ForParts)
        {
            foreach (System.Data.DataRow R in DtAnalysis.Rows)
            {
                if (R["AnalysisParentID"].ToString() == AnalysisID)
                {
                    string Caption = R["DisplayText"].ToString();
                    System.Windows.Forms.ToolStripMenuItem mi;
                    if (R["TaxonomicGroup"].ToString() == TaxonomicGroup)
                    {
                        //Caption = "New " + Caption;
                        if (ForParts)
                            mi = new System.Windows.Forms.ToolStripMenuItem(Caption, null, menuItemOverviewHierarchyAnalysisForPartsOnClick);
                        else
                            mi = new System.Windows.Forms.ToolStripMenuItem(Caption, null, menuItemOverviewHierarchyAnalysisOnClick);
                        mi.Tag = R["AnalysisID"];
                        mi.Image = global::DiversityCollection.Resource.Analysis;
                        mi.ToolTipText = R["Description"].ToString();
                        //System.Drawing.Font F = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Regular);//  
                        //mi.Font = F;
                        ToolStripMenuItem.DropDownItems.Add(mi);
                        this.addChildsToDropDownButtonAnalysis(mi, TaxonomicGroup, DtAnalysis, R["AnalysisID"].ToString(), ForParts);
                    }
                    else
                    {
                        //System.Drawing.Font F = new Font(System.Drawing.FontFamily.GenericSansSerif, (float)8.25, System.Drawing.FontStyle.Bold);//  
                        mi = new System.Windows.Forms.ToolStripMenuItem(Caption);
                        mi.ForeColor = System.Drawing.Color.Blue;
                        //mi.Font = F;
                        ToolStripMenuItem.DropDownItems.Add(mi);
                        this.addChildsToDropDownButtonAnalysis(mi, TaxonomicGroup, DtAnalysis, R["AnalysisID"].ToString(), ForParts);
                    }
                }
            }
        }

        private void addChildsToDropDownButtonAnalysis(System.Windows.Forms.ToolStripMenuItem ToolStripMenuItem, System.Data.DataTable DtAnalysis, string AnalysisID, bool ForParts)
        {
            foreach (System.Data.DataRow R in DtAnalysis.Rows)
            {
                if (R["AnalysisParentID"].ToString() == AnalysisID)
                {
                    string Caption = R["DisplayText"].ToString();
                    System.Windows.Forms.ToolStripMenuItem mi;
                    if (ForParts)
                        mi = new System.Windows.Forms.ToolStripMenuItem(Caption, null, menuItemOverviewHierarchyAnalysisForPartsOnClick);
                    else
                        mi = new System.Windows.Forms.ToolStripMenuItem(Caption, null, menuItemOverviewHierarchyAnalysisOnClick);
                    mi.Tag = R["AnalysisID"];
                    mi.Image = global::DiversityCollection.Resource.Analysis;
                    mi.ToolTipText = R["Description"].ToString();
                    ToolStripMenuItem.DropDownItems.Add(mi);
                    this.addChildsToDropDownButtonAnalysis(mi, DtAnalysis, R["AnalysisID"].ToString(), ForParts);
                }
            }
        }

        private void menuItemOverviewHierarchyAnalysisOnClick(object sender, System.EventArgs e)
        {
            System.Windows.Forms.ToolStripMenuItem m = (System.Windows.Forms.ToolStripMenuItem)sender;
            int AnalysisID = 0;
            if (m.Tag == null) return;
            if (this.treeViewOverviewHierarchy.SelectedNode == null) return;
            try
            {
                if (!this.ShowAnalysis) this.toolStripDropDownButtonOverviewHierarchyShowAnalysis.Tag = AnalysisDisplayStyle.NoHierarchy;
                System.Data.DataRow DataRow = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                string Table = DataRow.Table.TableName;
                if (int.TryParse(m.Tag.ToString(), out AnalysisID))
                {
                    try
                    {
                        int CollectionSpecimenID = int.Parse(DataRow["CollectionSpecimenID"].ToString());
                        int IdentificationUnitID = int.Parse(DataRow["IdentificationUnitID"].ToString());
                        System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select("CollectionSpecimenID = " + CollectionSpecimenID.ToString() + " AND IdentificationUnitID = " + IdentificationUnitID.ToString() + " AND AnalysisID = " + AnalysisID.ToString(), "AnalysisNumber DESC");
                        string AnalysisNumber = this.NextAnalysisNumber(CollectionSpecimenID, IdentificationUnitID, AnalysisID);
                        if (AnalysisNumber.Length > 0)
                        {
                            DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisRow R
                                = (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisRow)this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.NewRow();
                            R.CollectionSpecimenID = CollectionSpecimenID;
                            R.IdentificationUnitID = IdentificationUnitID;
                            R.AnalysisNumber = AnalysisNumber;
                            R.AnalysisID = AnalysisID;
                            if (Specimen.DefaultUseAnalyisisResponsible)
                            {
                                R.ResponsibleName = Specimen.DefaultResponsibleName;
                                R.ResponsibleAgentURI = Specimen.DefaultResponsibleURI;
                            }
                            this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Rows.Add(R);
                            this.refreshHierarchyUnitUnitNodes(this.treeViewOverviewHierarchy.SelectedNode);
                            this.moveToHierarchyNode(R, this.treeViewOverviewHierarchy);
                        }
                    }
                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                }
            }
            catch { return; }
        }

        private string NextAnalysisNumber(int CollectionSpecimenID, int IdentificationUnitID, int AnalysisID)
        {
            string AnalysisNumber = "1";
            string Error = "";
            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select(
                "CollectionSpecimenID = " + CollectionSpecimenID.ToString() +
                " AND IdentificationUnitID = " + IdentificationUnitID.ToString() +
                " AND AnalysisID = " + AnalysisID.ToString(), "AnalysisNumber DESC");
            if (rr.Length > 0)
            {
                int AnalysisNr = 1;
                if (int.TryParse(rr[0]["AnalysisNumber"].ToString(), out AnalysisNr))
                {
                    AnalysisNr++;
                    if (AnalysisNr < rr.Length) AnalysisNr = rr.Length + 1;
                    System.Data.DataRow[] rrTest = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select
                        ("CollectionSpecimenID = " + CollectionSpecimenID.ToString() +
                        " AND IdentificationUnitID = " + IdentificationUnitID.ToString() +
                        " AND AnalysisID = " + AnalysisID.ToString() +
                        " AND AnalysisNumber = '" + AnalysisNr.ToString() + "'", "");
                    if (rrTest.Length == 0)
                        return AnalysisNr.ToString();
                    else
                    {
                        bool Searching = true;
                        while (Searching)
                        {
                            DiversityWorkbench.FormGetString f = new DiversityWorkbench.FormGetString("Number of analysis", "Please enter the number of the analysis. " + Error, "");
                            f.ShowDialog();
                            if (f.DialogResult == DialogResult.Cancel)
                            {
                                Searching = false;
                                return "";
                            }
                            else
                            {
                                AnalysisNumber = f.String;
                                System.Data.DataRow[] rTest = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select
                                    ("CollectionSpecimenID = " + CollectionSpecimenID.ToString() +
                                    " AND IdentificationUnitID = " + IdentificationUnitID.ToString() +
                                    " AND AnalysisID = " + AnalysisID.ToString() +
                                    " AND AnalysisNumber = '" + AnalysisNumber + "'", "");
                                if (rTest.Length == 0)
                                    return AnalysisNumber;
                                else
                                    Error = "The number " + AnalysisNumber + " is already present";
                            }
                        }
                    }
                }
                else
                {
                    AnalysisNumber = "";
                    bool Search = true;
                    while (AnalysisNumber.Length == 0 && Search)
                    {
                        DiversityWorkbench.FormGetString f = new DiversityWorkbench.FormGetString("Number of analysis", "Please enter the number of the analysis. " + Error, "");
                        f.ShowDialog();
                        if (f.DialogResult == DialogResult.Cancel)
                        {
                            Search = false;
                            return "";
                        }
                        AnalysisNumber = f.String;
                        System.Data.DataRow[] rrTest = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select
                            ("CollectionSpecimenID = " + CollectionSpecimenID.ToString() +
                            " AND IdentificationUnitID = " + IdentificationUnitID.ToString() +
                            " AND AnalysisID = " + AnalysisID.ToString() +
                            " AND AnalysisNumber = '" + AnalysisNumber + "'", "");
                        if (rrTest.Length == 0)
                            return AnalysisNumber;
                        else
                        {
                            Error = "The number " + AnalysisNumber + " is already present";
                            AnalysisNumber = "";
                        }
                    }
                }
            }
            return AnalysisNumber;
        }

        private void prepareToolStripDropDownButtonsAnalysisForParts(System.Windows.Forms.TreeNode Node)
        {
            this.prepareToolStripDropDownButtonAnalysis(Node, this.toolStripDropDownButtonOverviewHierarchyNewAnalysisForParts, true);
        }

        private void menuItemOverviewHierarchyAnalysisForPartsOnClick(object sender, System.EventArgs e)
        {
            System.Windows.Forms.ToolStripMenuItem m = (System.Windows.Forms.ToolStripMenuItem)sender;
            int AnalysisID = 0;
            if (m.Tag == null) return;
            if (this.treeViewOverviewHierarchyStorage.SelectedNode == null) return;
            try
            {
                System.Data.DataRow DataRow = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                string Table = DataRow.Table.TableName;
                if (int.TryParse(m.Tag.ToString(), out AnalysisID))
                {
                    try
                    {
                        int CollectionSpecimenID = int.Parse(DataRow["CollectionSpecimenID"].ToString());
                        int IdentificationUnitID = int.Parse(DataRow["IdentificationUnitID"].ToString());
                        int SpecimenPartID = int.Parse(DataRow["SpecimenPartID"].ToString());
                        System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select("CollectionSpecimenID = " + CollectionSpecimenID.ToString() + " AND IdentificationUnitID = " + IdentificationUnitID.ToString() + " AND AnalysisID = " + AnalysisID.ToString(), "AnalysisNumber DESC");
                        int AnalysisNr = rr.Length + 1;
                        string AnalysisNumber = AnalysisNr.ToString();
                        string Filter = "CollectionSpecimenID = " + CollectionSpecimenID.ToString() +
                            " AND IdentificationUnitID = " + IdentificationUnitID.ToString() +
                            " AND AnalysisID = " + AnalysisID.ToString() +
                            " AND AnalysisNumber = '" + AnalysisNumber + "'";// OR AnalysisNumber = '"; 
                        // try to get the next if anything is present
                        if (rr.Length > 0)
                        {
                            // try with the number of records found
                            System.Data.DataRow[] rrTest = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select(Filter, "");
                            if (rrTest.Length > 0) // number is allready there
                            {
                                if (int.TryParse(rr[0]["AnalysisNumber"].ToString(), out AnalysisNr)) // take last number from data
                                {
                                    AnalysisNr++;
                                    Filter = "CollectionSpecimenID = " + CollectionSpecimenID.ToString() +
                                        " AND IdentificationUnitID = " + IdentificationUnitID.ToString() +
                                        " AND AnalysisID = " + AnalysisID.ToString() +
                                        " AND AnalysisNumber = '" + AnalysisNr.ToString() + "'"; 
                                    System.Data.DataRow[] rrTestLast = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select(Filter, "");
                                    if (rrTestLast.Length == 0)
                                        AnalysisNumber = AnalysisNr.ToString();
                                    else
                                    {
                                        AnalysisNumber = "Please enter number for analysis";
                                    }
                                }
                                else // last number from data is not an integer
                                {
                                    AnalysisNumber = "Please enter number for analysis";
                                }
                            }
                        }
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisRow R
                            = (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisRow)this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.NewRow();
                        R.CollectionSpecimenID = CollectionSpecimenID;
                        R.IdentificationUnitID = IdentificationUnitID;
                        R.AnalysisNumber = AnalysisNumber;
                        R.AnalysisID = AnalysisID;
                        R.SpecimenPartID = SpecimenPartID;
                        this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Rows.Add(R);
                        this.refreshHierarchyPartUnitNodes(this.treeViewOverviewHierarchyStorage.SelectedNode, "IdentificationUnitInPart");
                        this.buildOverviewHierarchyUnits();
                        this.moveToHierarchyNode(R, this.treeViewOverviewHierarchyStorage);
                    }
                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                }
            }
            catch { return; }
        }

        private void dateTimePickerAnalysisDate_CloseUp(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitAnalysisBindingSource.Current;
            string DateString = this.dateTimePickerAnalysisDate.Value.Year.ToString() + "/" +
                this.dateTimePickerAnalysisDate.Value.Month.ToString() + "/" +
                this.dateTimePickerAnalysisDate.Value.Day.ToString();
            R["AnalysisDate"] = DateString;
            this.textBoxAnalysisDate.Text = DateString;
        }

        private void setAnalysisPartList()
        {
            this.comboBoxAnalysisSpecimenPart.DataSource = null;
            this.dataSetCollectionSpecimen.AnalysisOfPart.Clear();
            System.Data.DataRow R;
            try
            {
                if (this.treeViewOverviewHierarchy.Focused)
                {
                    if (this.treeViewOverviewHierarchy.SelectedNode != null)
                        R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                    else
                        return;
                }
                else
                {
                    if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                        R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                    else
                        return;
                }
                int UnitID = 0;
                if (R.Table.TableName != "IdentificationUnitAnalysis") return;
                if (int.TryParse(R["IdentificationUnitID"].ToString(), out UnitID))
                {
                    System.Data.DataRow rNull = this.dataSetCollectionSpecimen.AnalysisOfPart.NewRow();
                    rNull["DisplayText"] = System.DBNull.Value;
                    rNull["SpecimenPartID"] = System.DBNull.Value;
                    this.dataSetCollectionSpecimen.AnalysisOfPart.Rows.Add(rNull);
                    foreach (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow rU in this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows)
                    {
                        if (rU.RowState != DataRowState.Deleted && rU.RowState != DataRowState.Detached && rU.IdentificationUnitID == UnitID)
                        {
                            int PartID = rU.SpecimenPartID;
                            string Display = "";
                            System.Data.DataRow[] sP =
                                this.dataSetCollectionSpecimen.CollectionSpecimenPart.Select("SpecimenPartID = " + PartID.ToString());
                            if (sP.Length > 0)
                            {
                                if (!sP[0]["AccessionNumber"].Equals(System.DBNull.Value)) Display = sP[0]["AccessionNumber"].ToString() + " - ";
                                if (!sP[0]["PartSublabel"].Equals(System.DBNull.Value)) Display += sP[0]["PartSublabel"].ToString() + " - ";
                                if (!sP[0]["StorageLocation"].Equals(System.DBNull.Value)) Display += sP[0]["StorageLocation"].ToString() + " - ";
                                if (!sP[0]["MaterialCategory"].Equals(System.DBNull.Value)) Display += sP[0]["MaterialCategory"].ToString() + " - ";
                                System.Data.DataRow rNew = this.dataSetCollectionSpecimen.AnalysisOfPart.NewRow();
                                rNew["DisplayText"] = Display;
                                rNew["SpecimenPartID"] = PartID;
                                this.dataSetCollectionSpecimen.AnalysisOfPart.Rows.Add(rNew);
                            }
                        }
                    }
                }

                int SpecimenPartID = -1;
                int i = 0;
                if (int.TryParse(R["SpecimenPartID"].ToString(), out SpecimenPartID))
                {
                    for (i = 0; i < this.dataSetCollectionSpecimen.AnalysisOfPart.Rows.Count; i++)
                    {
                        if (this.dataSetCollectionSpecimen.AnalysisOfPart.Rows[i]["SpecimenPartID"].ToString() == SpecimenPartID.ToString())
                            break;
                    }
                }

                this.comboBoxAnalysisSpecimenPart.DataSource = this.dataSetCollectionSpecimen.AnalysisOfPart;
                this.comboBoxAnalysisSpecimenPart.DisplayMember = "DisplayText";
                this.comboBoxAnalysisSpecimenPart.ValueMember = "SpecimenPartID";

                this.comboBoxAnalysisSpecimenPart.SelectedIndex = i;
            }
            catch { }
        }

        private void comboBoxAnalysisSpecimenPart_SelectionChangeCommitted(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRow R;
                if (this.treeViewOverviewHierarchy.SelectedNode != null)
                    R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                else if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                    R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                else
                    return;
                R.EndEdit();
                R.BeginEdit();
                System.Data.DataRowView RV = (System.Data.DataRowView)this.comboBoxAnalysisSpecimenPart.SelectedItem;
                if (RV[0].Equals(System.DBNull.Value))
                    R["SpecimenPartID"] = System.DBNull.Value;
                else
                    R["SpecimenPartID"] = int.Parse(RV["SpecimenPartID"].ToString());
                this.comboBoxAnalysisSpecimenPart.Text = RV["DisplayText"].ToString();
                R.EndEdit();
            }
            catch { }
        }

        private void textBoxAnalysisDate_Validating(object sender, CancelEventArgs e)
        {
            bool OK = true;
            if (this.textBoxAnalysisDate.Text.Length == 0)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitAnalysisBindingSource.Current;
                R.BeginEdit();
                R["AnalysisDate"] = System.DBNull.Value;
                R.EndEdit();
            }
        }

        private void comboBoxAnalysisResult_DropDown(object sender, EventArgs e)
        {
            //if (this.identificationUnitAnalysisBindingSource.Current != null)
            //{
            //    System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitAnalysisBindingSource.Current;
            //    bool RestrictToList = false;
            //    int AnalysisID = int.Parse(R["AnalysisID"].ToString());
            //    System.Data.DataTable dt = LookupTable.AnalysisResults(AnalysisID, ref RestrictToList);
            //    this.comboBoxAnalysisResult.DataSource = dt;
            //    this.comboBoxAnalysisResult.DisplayMember = "DisplayText";
            //    this.comboBoxAnalysisResult.ValueMember = "AnalysisResult";
            //}
        }
        
        #endregion

        #region Tool usage

        private void toolStripButtonAnalysisToolSave_Click(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitAnalysisBindingSource.Current;
            this.ToolUsageSave(R, this.treeViewAnalysisTools, this.toolStripButtonAnalysisToolSave);
            //this.toolStripButtonAnalysisToolSave.Enabled = false;
            return;
        }

        private void toolStripButtonAnalysisToolInfo_Click(object sender, EventArgs e)
        {
            if (this.treeViewAnalysisTools.SelectedNode != null)
                this.ToolUsageInfo(this.treeViewAnalysisTools.SelectedNode);
        }

        private void toolStripButtonAnalysisToolAdd_Click(object sender, EventArgs e)
        {
            System.Data.DataRowView RV = (System.Data.DataRowView)this.identificationUnitAnalysisBindingSource.Current;
            int AnalysisID = 0;
            if (int.TryParse(RV["AnalysisID"].ToString(), out AnalysisID))
            {
                this.ToolUsageAdd("ToolListForAnalysis", AnalysisID, RV, this.treeViewAnalysisTools, this.toolStripButtonAnalysisToolSave);
                //this.toolStripButtonAnalysisToolSave.Enabled = true;
                //this.toolStripButtonAnalysisToolSave.BackColor = System.Drawing.Color.Red;
            }
        }

        private void toolStripButtonAnalysisToolEdit_Click(object sender, EventArgs e)
        {
            this.ToolUsageEdit(this.treeViewAnalysisTools.SelectedNode, this.toolStripButtonAnalysisToolSave);
            this.ToolUsageSave((System.Data.DataRowView)this.identificationUnitAnalysisBindingSource.Current, this.treeViewAnalysisTools, this.toolStripButtonAnalysisToolSave);
            //this.toolStripButtonAnalysisToolSave.Enabled = true;
        }

        private void toolStripButtonAnalysisToolRemove_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitAnalysisBindingSource.Current;
                R.BeginEdit();
                string ToolUsage = this.RemoveToolUsage(R["ToolUsage"].ToString(), this.treeViewAnalysisTools.SelectedNode);
                R["ToolUsage"] = ToolUsage;
                R.EndEdit();
                DiversityCollection.Tool.BuildToolTreeFromXmlContent(this.treeViewAnalysisTools, ToolUsage);
                this.toolStripButtonAnalysisToolSave.Enabled = true;
                this.toolStripButtonAnalysisToolSave.BackColor = System.Drawing.Color.Red;
            }
            catch (Exception ex)
            {
            }
        }

        private void treeViewAnalysisTools_AfterSelect(object sender, TreeViewEventArgs e)
        {
            try
            {
                this.toolStripButtonAnalysisToolAdd.Enabled = false;
                this.toolStripButtonAnalysisToolEdit.Enabled = false;
                this.toolStripButtonAnalysisToolInfo.Enabled = false;
                this.toolStripButtonAnalysisToolRemove.Enabled = false;
                this.toolStripButtonAnalysisToolSave.Enabled = false;
                if (this.treeViewAnalysisTools.SelectedNode.Tag != null)
                {
                    DiversityWorkbench.UserControls.XMLNode X = (DiversityWorkbench.UserControls.XMLNode)this.treeViewAnalysisTools.SelectedNode.Tag;
                    if (X.Name == "Tool")
                    {
                        this.toolStripButtonAnalysisToolInfo.Enabled = true;
                        this.toolStripButtonAnalysisToolRemove.Enabled = true;
                    }
                    if (X.Name == "Usage")
                    {
                        this.toolStripButtonAnalysisToolEdit.Enabled = true;
                    }
                    if (X.Name == "Tools")
                    {
                        this.toolStripButtonAnalysisToolAdd.Enabled = true;
                    }
                }
                else if (this.treeViewAnalysisTools.SelectedNode.Text == "Tools")
                    this.toolStripButtonAnalysisToolAdd.Enabled = true;
            }
            catch (System.Exception ex) { }
        }

        private void BuildAnalysisToolUsageTree()
        {
            try
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitAnalysisBindingSource.Current;
                string ToolUsage = R["ToolUsage"].ToString();
                DiversityCollection.Tool.BuildToolTreeFromXmlContent(this.treeViewAnalysisTools, ToolUsage);
                this.toolStripButtonAnalysisToolEdit.Enabled = false;
                this.toolStripButtonAnalysisToolRemove.Enabled = false;
                this.toolStripButtonAnalysisToolInfo.Enabled = false;
                this.toolStripButtonAnalysisToolSave.Enabled = false;
                if (ToolUsage.Length > 0)
                    this.toolStripButtonAnalysisToolAdd.Enabled = false;
                else
                    this.toolStripButtonAnalysisToolAdd.Enabled = true;
            }
            catch { }
        }

        #endregion

        #region Methods

        private System.Data.DataView _dvIdentificationUnitAnalysisMethod;
        private System.Data.DataView dvIdentificationUnitAnalysisMethod
        {
            get
            {
                if (this._dvIdentificationUnitAnalysisMethod == null)
                    this._dvIdentificationUnitAnalysisMethod = new DataView(this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodList);
                int UnitID;
                int AnalysisID;
                string AnalysisNumber;
                System.Data.DataRowView RU = (System.Data.DataRowView)this.identificationUnitAnalysisBindingSource.Current;
                if (int.TryParse(RU["IdentificationUnitID"].ToString(), out UnitID) &&
                    int.TryParse(RU["AnalysisID"].ToString(), out AnalysisID))
                {
                    AnalysisNumber = RU["AnalysisNumber"].ToString();
                    string RowFilter = "AnalysisID = " + AnalysisID.ToString() +
                        " AND IdentificationUnitID = " + UnitID.ToString() +
                        " AND AnalysisNumber = '" + AnalysisNumber + "'";
                    this._dvIdentificationUnitAnalysisMethod.RowFilter = RowFilter;
                    this._dvIdentificationUnitAnalysisMethod.Sort = "DisplayText";
                }
                return this._dvIdentificationUnitAnalysisMethod;
            }
        }

        private System.Data.DataView _dvIdentificationUnitAnalysisMethodParameter;
        private System.Data.DataView dvIdentificationUnitAnalysisMethodParameter
        {
            get
            {
                if (this._dvIdentificationUnitAnalysisMethodParameter == null)
                    this._dvIdentificationUnitAnalysisMethodParameter = new DataView(this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameterList);
                int UnitID;
                int AnalysisID;
                int MethodID;
                string AnalysisNumber;
                string MethodMarker;
                if (this.listBoxAnalysisMethod.SelectedIndex > -1)
                {
                    System.Data.DataRowView RM = (System.Data.DataRowView)this.listBoxAnalysisMethod.SelectedItem;// this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodList.Rows[this.listBoxAnalysisMethod.SelectedIndex];
                    if (int.TryParse(RM["IdentificationUnitID"].ToString(), out UnitID) &&
                        int.TryParse(RM["AnalysisID"].ToString(), out AnalysisID) &&
                        int.TryParse(RM["MethodID"].ToString(), out MethodID))
                    {
                        AnalysisNumber = RM["AnalysisNumber"].ToString();
                        MethodMarker = RM["MethodMarker"].ToString();
                        string RowFilter = "AnalysisID = " + AnalysisID.ToString() +
                            " AND IdentificationUnitID = " + UnitID.ToString() +
                            " AND AnalysisNumber = '" + AnalysisNumber + "'" +
                            " AND MethodID = " + MethodID.ToString() +
                            " AND MethodMarker = '" + MethodMarker + "'";
                        this._dvIdentificationUnitAnalysisMethodParameter.RowFilter = RowFilter;
                        this._dvIdentificationUnitAnalysisMethodParameter.Sort = "DisplayText";
                    }
                }
                else
                    this._dvIdentificationUnitAnalysisMethodParameter.RowFilter = "1 = 0";
                return this._dvIdentificationUnitAnalysisMethodParameter;
            }
        }

        private void setAnalysisMethodControls(int UnitID, int AnalysisID)
        {
            // METHOD
            try
            {
                this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodList.Clear();
                string SQL = "SELECT A.CollectionSpecimenID, A.IdentificationUnitID, M.MethodID, A.AnalysisID, A.AnalysisNumber, M.DisplayText, A.MethodMarker " +
                    "FROM IdentificationUnitAnalysisMethod AS A INNER JOIN " +
                    "Method AS M ON A.MethodID = M.MethodID " +
                    "WHERE (A.IdentificationUnitID = " + UnitID.ToString() + ") AND (A.AnalysisID = " + AnalysisID.ToString() + ")";
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.SelectCommand.CommandText = SQL;
                ad.Fill(this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodList);
            }
            catch (System.Exception ex) { }

            // METHOD PARAMETER
            try
            {
                string SQL = "SELECT A.CollectionSpecimenID, A.IdentificationUnitID, A.AnalysisID, A.AnalysisNumberker, A.MethodID, A.ParameterID, A.Value, P.DisplayText, A.MethodMar " +
                    "FROM IdentificationUnitAnalysisMethodParameter AS A INNER JOIN " +
                    "Parameter AS P ON A.ParameterID = P.ParameterID AND A.MethodID = P.MethodID " +
                    "WHERE (A.IdentificationUnitID = " + UnitID.ToString() + ") AND (A.AnalysisID = " + AnalysisID.ToString() + ")";
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.SelectCommand.CommandText = SQL;
                ad.Fill(this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameterList);
            }
            catch (System.Exception ex) { }

            this.listBoxAnalysisMethodParameter.DataSource = this.dvIdentificationUnitAnalysisMethodParameter;
            this.listBoxAnalysisMethodParameter.DisplayMember = "DisplayText";
            this.listBoxAnalysisMethodParameter.ValueMember = "ParameterID";

            //this.textBoxAnalysisMethodParameterValue.DataBindings.Clear();
            //this.textBoxAnalysisMethodParameterValue.DataBindings.Add(new System.Windows.Forms.Binding("Text", this.dvIdentificationUnitAnalysisMethodParameter, "Value", true));
            //this.comboBoxAnalysisMethodParameterValue.DataBindings.Clear();
            //this.comboBoxAnalysisMethodParameterValue.DataBindings.Add(new System.Windows.Forms.Binding("SelectedValue", this.dvIdentificationUnitAnalysisMethodParameter, "Value", true));
        }

        private void toolStripButtonAnalysisMethodAdd_Click(object sender, EventArgs e)
        {
            if (this.identificationUnitAnalysisBindingSource.Current == null)
            {
                System.Windows.Forms.MessageBox.Show("No analysis selected");
                return;
            }
            int UnitID;
            int AnalysisID;
            System.Data.DataRowView RA = (System.Data.DataRowView)this.identificationUnitAnalysisBindingSource.Current;
            if (!int.TryParse(RA["AnalysisID"].ToString(), out AnalysisID))
                return;
            if (!int.TryParse(RA["IdentificationUnitID"].ToString(), out UnitID))
                return;
            string AnalysisNumber;
            AnalysisNumber = RA["AnalysisNumber"].ToString();

            string MethodMarker = "0";
            System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethod.Select("IdentificationUnitID = " + UnitID.ToString() + " AND AnalysisID = " + AnalysisID.ToString() + " AND AnalysisNumber = '" + AnalysisNumber + "'", "MethodMarker DESC");
            if (RR.Length > 0)
                MethodMarker = RR[0]["MethodMarker"].ToString();
            int iMethodMarker;
            if (int.TryParse(MethodMarker, out iMethodMarker))
                MethodMarker = (iMethodMarker + 1).ToString();
            System.Data.DataRow[] RRtest = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethod.Select("IdentificationUnitID = " + UnitID.ToString() + " AND AnalysisID = " + AnalysisID.ToString() + " AND AnalysisNumber = '" + AnalysisNumber + "' AND MethodMarker = '" + MethodMarker + "'", "");
            int i = RRtest.Length;
            while (i > 0)
            {
                DiversityWorkbench.FormGetString fMarker = new DiversityWorkbench.FormGetString("Method marker", "Please enter a new method marker. The marker " + MethodMarker + " is allready present", "");
                fMarker.ShowDialog();
                if (fMarker.DialogResult == System.Windows.Forms.DialogResult.Cancel)
                    return;
                else if (fMarker.DialogResult == System.Windows.Forms.DialogResult.OK)
                {
                    MethodMarker = fMarker.String;
                    System.Data.DataRow[] RRt = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethod.Select("IdentificationUnitID = " + UnitID.ToString() + " AND AnalysisID = " + AnalysisID.ToString() + " AND AnalysisNumber = '" + AnalysisNumber + "' AND MethodMarker = '" + MethodMarker + "'", "");
                    i = RRt.Length;
                }
            }

            string SQL = "SELECT A.MethodID, M.DisplayText " +
                " FROM MethodForAnalysis A, Method M " +
                " WHERE A.MethodID = M.MethodID AND A.AnalysisID = " + AnalysisID.ToString();
            SQL += " ORDER BY DisplayText";
            System.Data.DataTable dtMethods = new DataTable();
            System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            ad.Fill(dtMethods);
            if (dtMethods.Rows.Count == 0)
            {
                string Message = "No methods available";
                System.Windows.Forms.MessageBox.Show(Message);
                return;
            }
            DiversityWorkbench.FormGetStringFromList f = new DiversityWorkbench.FormGetStringFromList(dtMethods, "DisplayText", "MethodID", "New method", "Please select the new method for the analysis");
            f.ShowDialog();
            if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
            {
                try
                {
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisMethodRow RM = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethod.NewIdentificationUnitAnalysisMethodRow();
                    RM.AnalysisID = AnalysisID;
                    RM.MethodID = int.Parse(f.SelectedValue);
                    RM.AnalysisNumber = AnalysisNumber;
                    RM.CollectionSpecimenID = this.ID;
                    RM.IdentificationUnitID = UnitID;
                    RM.MethodMarker = MethodMarker;
                    this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethod.Rows.Add(RM);
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisMethodListRow RML = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodList.NewIdentificationUnitAnalysisMethodListRow();
                    RML.AnalysisID = AnalysisID;
                    RML.MethodID = int.Parse(f.SelectedValue);
                    RML.AnalysisNumber = AnalysisNumber;
                    RML.IdentificationUnitID = UnitID;
                    RML.CollectionSpecimenID = this.ID;
                    RML.DisplayText = f.SelectedString + " " + MethodMarker;
                    RML.MethodMarker = MethodMarker;
                    this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodList.Rows.Add(RML);
                    System.Data.DataTable dtPV = new DataTable();
                    SQL = "SELECT " + this.ID.ToString() + ", " + UnitID.ToString() + ", " + AnalysisID.ToString() + ", '" + AnalysisNumber +
                        "', MethodID, ParameterID, DisplayText, DefaultValue " +
                        "FROM Parameter " +
                        "WHERE MethodID = " + RM.MethodID.ToString();
                    System.Data.SqlClient.SqlDataAdapter adPV = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    adPV.Fill(dtPV);
                    foreach (System.Data.DataRow RP in dtPV.Rows)
                    {
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameterRow RPV = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.NewIdentificationUnitAnalysisMethodParameterRow();
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameterListRow RPVL = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameterList.NewIdentificationUnitAnalysisMethodParameterListRow();
                        RPV.CollectionSpecimenID = this.ID;
                        RPVL.CollectionSpecimenID = this.ID;
                        RPV.IdentificationUnitID = UnitID;
                        RPVL.IdentificationUnitID = UnitID;
                        RPV.AnalysisID = AnalysisID;
                        RPVL.AnalysisID = AnalysisID;
                        RPV.AnalysisNumber = AnalysisNumber;
                        RPVL.AnalysisNumber = AnalysisNumber;
                        RPV.MethodID = int.Parse(f.SelectedValue);
                        RPVL.MethodID = int.Parse(f.SelectedValue);
                        RPV.MethodMarker = MethodMarker;
                        RPVL.MethodMarker = MethodMarker;
                        RPV.ParameterID = int.Parse(RP["ParameterID"].ToString());
                        RPVL.ParameterID = int.Parse(RP["ParameterID"].ToString());
                        RPV.Value = RP["DefaultValue"].ToString();
                        RPVL.Value = RP["DefaultValue"].ToString();
                        RPVL.DisplayText = RP["DisplayText"].ToString();
                        this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.Rows.Add(RPV);
                        this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameterList.Rows.Add(RPVL);
                    }
                }
                catch (Exception ex)
                {

                    //throw;
                }
            }
        }

        private void toolStripButtonAnalysisMethodDelete_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxAnalysisMethod.SelectedItem;
                string Restriction = "MethodID = " + R["MethodID"].ToString() +
                    " AND CollectionSpecimenID = " + R["CollectionSpecimenID"].ToString() +
                    " AND IdentificationUnitID = " + R["IdentificationUnitID"].ToString() +
                    " AND AnalysisID = " + R["AnalysisID"].ToString() +
                    " AND AnalysisNumber = '" + R["AnalysisNumber"].ToString() + "'" +
                    " AND MethodMarker = '" + R["MethodMarker"].ToString() + "'";
                System.Data.DataRow[] rrP = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.Select(Restriction);
                System.Data.DataRow[] rrPL = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameterList.Select(Restriction);
                for (int i = 0; i < rrP.Length; i++)
                    rrP[i].Delete();
                for (int i = 0; i < rrPL.Length; i++)
                    rrPL[i].Delete();
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethod.Select(Restriction);
                System.Data.DataRow[] rrL = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodList.Select(Restriction);
                rr[0].Delete();
                rrL[0].Delete();
                this.updateSpecimen();
                this.setSpecimen(this.SpecimenID);
            }
            catch (System.Exception ex) { }
        }

        private void listBoxAnalysisMethod_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.listBoxAnalysisMethodParameter.DataSource = this.dvIdentificationUnitAnalysisMethodParameter;
            this.listBoxAnalysisMethodParameter_SelectedIndexChanged(null, null);
            try
            {
                if (this.listBoxAnalysisMethod.SelectedItem != null)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxAnalysisMethod.SelectedItem;
                    this.toolStripTextBoxAnalysisMethodMarker.Text = R["MethodMarker"].ToString();
                }
                else this.toolStripTextBoxAnalysisMethodMarker.Text = "";
            }
            catch (System.Exception ex)
            {
            }
        }

        private void listBoxAnalysisMethodParameter_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (this.listBoxAnalysisMethodParameter.SelectedItem == null)
            {
                this.comboBoxAnalysisMethodParameterValue.Visible = false;
                this.textBoxAnalysisMethodParameterValue.Visible = false;
                return;
            }
            System.Data.DataRowView RV = (System.Data.DataRowView)this.listBoxAnalysisMethodParameter.SelectedItem;
            for (int i = 0; i < this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.Rows.Count; i++)
            {
                if (this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.Rows[i]["ParameterID"].ToString() == RV["ParameterID"].ToString() &&
                    this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.Rows[i]["MethodID"].ToString() == RV["MethodID"].ToString() &&
                    this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.Rows[i]["IdentificationUnitID"].ToString() == RV["IdentificationUnitID"].ToString() &&
                    this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.Rows[i]["AnalysisID"].ToString() == RV["AnalysisID"].ToString() &&
                    this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.Rows[i]["AnalysisNumber"].ToString() == RV["AnalysisNumber"].ToString() &&
                    this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.Rows[i]["MethodMarker"].ToString() == RV["MethodMarker"].ToString())
                {
                    this.identificationUnitAnalysisMethodParameterBindingSource.Position = i;
                    break;
                }
            }

            if (this.identificationUnitAnalysisMethodParameterBindingSource.Current != null)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitAnalysisMethodParameterBindingSource.Current;
                string SQL = "SELECT Value, DisplayText " +
                    "FROM ParameterValue_Enum " +
                    "WHERE (MethodID = " + R["MethodID"].ToString() + ") AND (ParameterID = " + R["ParameterID"].ToString() + ") ORDER BY DisplayText";
                System.Data.DataTable dt = new DataTable();
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                if (dt.Rows.Count > 0)
                {
                    this.textBoxAnalysisMethodParameterValue.Visible = false;
                    this.textBoxAnalysisMethodParameterValue.Dock = DockStyle.None;
                    this.comboBoxAnalysisMethodParameterValue.Visible = true;
                    this.comboBoxAnalysisMethodParameterValue.Dock = DockStyle.Fill;
                    this.comboBoxAnalysisMethodParameterValue.DataSource = dt;
                    this.comboBoxAnalysisMethodParameterValue.DisplayMember = "DisplayText";
                    this.comboBoxAnalysisMethodParameterValue.ValueMember = "Value";
                    for (int i = 0; i < dt.Rows.Count; i++)
                    {
                        if (R["Value"].ToString() == dt.Rows[i]["Value"].ToString())
                        {
                            this.comboBoxAnalysisMethodParameterValue.SelectedIndex = i;
                            break;
                        }
                    }
                }
                else
                {
                    this.comboBoxAnalysisMethodParameterValue.Visible = false;
                    this.comboBoxAnalysisMethodParameterValue.Dock = DockStyle.None;
                    this.textBoxAnalysisMethodParameterValue.Visible = true;
                    this.textBoxAnalysisMethodParameterValue.Dock = DockStyle.Fill;

                }
            }
            else
            {
                this.textBoxAnalysisMethodParameterValue.Visible = false;
                this.comboBoxAnalysisMethodParameterValue.Visible = false;
            }
        }
        
        private void buttonAnalysisMethodParameterAddMissing_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.listBoxAnalysisMethod.SelectedItem != null)//this.identificationUnitAnalysisMethodListBindingSource.Current != null)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxAnalysisMethod.SelectedItem;
                    string SQL = "SELECT MethodID, ParameterID, DisplayText, DefaultValue " +
                        "FROM Parameter AS P " +
                        "WHERE (MethodID = " + R["MethodID"].ToString() + ") AND (ParameterID NOT IN " +
                        "(SELECT ParameterID " +
                        "FROM IdentificationUnitAnalysisMethodParameter AS U " +
                        "WHERE (IdentificationUnitID = " + R["IdentificationUnitID"].ToString() + ") " +
                        "AND (AnalysisID = " + R["AnalysisID"].ToString() + ") " +
                        "AND (AnalysisNumber = '" + R["AnalysisNumber"].ToString() + "') " +
                        "AND (MethodID = " + R["MethodID"].ToString() + ") " +
                        "AND (MethodMarker = '" + R["MethodMarker"].ToString() + "')))";
                    System.Data.DataTable dt = new DataTable();
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(dt);
                    if (dt.Rows.Count > 0)
                    {
                        System.Collections.Generic.Dictionary<string, bool> Dict = new Dictionary<string, bool>();
                        foreach (System.Data.DataRow RP in dt.Rows)
                            Dict.Add(RP["DisplayText"].ToString(), false);
                        DiversityWorkbench.Forms.FormGetMultiFromList f = new DiversityWorkbench.Forms.FormGetMultiFromList("Missing parameter", "Please select the parameters that should be added", Dict);
                        f.ShowDialog();
                        if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                        {
                            int UnitID = int.Parse(R["IdentificationUnitID"].ToString());
                            int AnalysisID = int.Parse(R["AnalysisID"].ToString());
                            string AnalysisNumber = R["AnalysisNumber"].ToString();
                            int MethodID = int.Parse(R["MethodID"].ToString());
                            string MethodMarker = R["MethodMarker"].ToString();
                            foreach (System.Collections.Generic.KeyValuePair<string, bool> KV in f.Items)
                            {
                                if (KV.Value)
                                {
                                    System.Data.DataRow[] rr = dt.Select("DisplayText = '" + KV.Key + "'");
                                    if (rr.Length > 0)
                                    {
                                        int ParameterID = int.Parse(rr[0]["ParameterID"].ToString());
                                        string DefaultValue = rr[0]["DefaultValue"].ToString();
                                        DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameterRow RPV = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.NewIdentificationUnitAnalysisMethodParameterRow();
                                        DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameterListRow RPVL = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameterList.NewIdentificationUnitAnalysisMethodParameterListRow();
                                        RPV.CollectionSpecimenID = this.ID;
                                        RPVL.CollectionSpecimenID = this.ID;
                                        RPV.IdentificationUnitID = UnitID;
                                        RPVL.IdentificationUnitID = UnitID;
                                        RPV.AnalysisID = AnalysisID;
                                        RPVL.AnalysisID = AnalysisID;
                                        RPV.AnalysisNumber = AnalysisNumber;
                                        RPVL.AnalysisNumber = AnalysisNumber;
                                        RPV.MethodID = MethodID;
                                        RPVL.MethodID = MethodID;
                                        RPV.MethodMarker = MethodMarker;
                                        RPVL.MethodMarker = MethodMarker;
                                        RPV.ParameterID = int.Parse(rr[0]["ParameterID"].ToString());
                                        RPVL.ParameterID = int.Parse(rr[0]["ParameterID"].ToString());
                                        RPV.Value = rr[0]["DefaultValue"].ToString();
                                        RPVL.Value = rr[0]["DefaultValue"].ToString();
                                        RPVL.DisplayText = rr[0]["DisplayText"].ToString();
                                        this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.Rows.Add(RPV);
                                        this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameterList.Rows.Add(RPVL);
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        System.Windows.Forms.MessageBox.Show("No parameters missing");
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonAnalysisMethodParameterRemove_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.listBoxAnalysisMethodParameter.SelectedItem != null)
                {
                    System.Data.DataRowView Rlist = (System.Data.DataRowView)this.listBoxAnalysisMethodParameter.SelectedItem;
                    string Message = "Do you want to remove parameter\r\n" + Rlist["DisplayText"].ToString();
                    if (System.Windows.Forms.MessageBox.Show(Message, "Remove parameter?", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == System.Windows.Forms.DialogResult.Yes)
                    {
                        int i = this.listBoxAnalysisMethod.SelectedIndex;
                        System.Data.DataRowView R = (System.Data.DataRowView)this.identificationUnitAnalysisMethodParameterBindingSource.Current;
                        R.Delete();
                        this.saveSpecimen(null, null);
                        this.listBoxAnalysisMethod.SelectedIndex = i;
                    }
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        #endregion

        //#region Descriptions

        //private void InitAnalysisDescriptions()
        //{
        //    this.checkBoxAnalysisDescriptionsRestrictToLocalServer.Visible = this._SearchForDescriptions;
        //    this.splitContainerAnalysisDescriptions.Visible = this._SearchForDescriptions;
        //    if (this._SearchForDescriptions)
        //    {
        //        if (!this.SearchForAnalysisDescriptions())
        //        {
        //            this.listBoxAnalysisDescriptions.DataSource = null;
        //            this.labelAnalysisDescriptionsNothingFound.Visible = true;
        //        }
        //    }
        //    else
        //    {
        //        this.labelAnalysisDescriptionsNothingFound.Visible = false;
        //    }
        //}

        //private bool SearchForAnalysisDescriptions()
        //{
        //    if (!DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList().ContainsKey("DiversityDescriptions"))
        //    {
        //        DiversityWorkbench.Description D = new DiversityWorkbench.Description(DiversityWorkbench.Settings.ServerConnection);
        //        if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityDescriptions"].DatabaseList().Count == 0)
        //            return false;
        //    }

        //    string SQL = "SELECT DISTINCT dbo.BaseURL() + CAST(description_id AS VARCHAR) AS URI " + 
        //        "FROM DescriptionScope WHERE ([type] = 'Specimen' OR [type] = 'Observation') " +
        //        "AND dwbURI = '" + DiversityWorkbench.Settings.ServerConnection.BaseURL + this.ID.ToString() + "'";
        //    System.Data.DataTable dt = new DataTable();

        //    System.Collections.Generic.Dictionary<string, DiversityWorkbench.ServerConnection> ServerConnections = new Dictionary<string, DiversityWorkbench.ServerConnection>();

        //    foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityDescriptions"].ServerConnections())
        //    {
        //        if (KV.Value.DatabaseServer != DiversityWorkbench.Settings.DatabaseServer)
        //            continue; // these are sources that had been linked in manually and so far are not prepared for use as cache db sources
        //        ServerConnections.Add(KV.Value.DisplayText, KV.Value);
        //    }
        //    if (ServerConnections.Count > 0)
        //    {
        //        foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> SC in ServerConnections)
        //        {
        //            string Message = "";
        //            System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, SC.Value.ConnectionString);
        //            ad.Fill(dt);
        //            ad.Dispose();
        //        }
        //    }
        //    if (dt.Rows.Count > 0)
        //    {
        //        this.listBoxAnalysisDescriptions.DataSource = dt;
        //        this.listBoxAnalysisDescriptions.DisplayMember = "URI";
        //        this.listBoxAnalysisDescriptions.ValueMember = "URI";
        //        this.labelAnalysisDescriptionsNothingFound.Visible = false;
        //    }
        //    else
        //    {
        //        this.listBoxAnalysisDescriptions.DataSource = null;
        //        this.labelAnalysisDescriptionsNothingFound.Visible = true;
        //    }
        //    return true;
        //}

        //private bool _SearchForDescriptions = false;

        //private void checkBoxAnalysisDescriptionsDoSearch_Click(object sender, EventArgs e)
        //{
        //    this._SearchForDescriptions = !this._SearchForDescriptions;
        //    this.checkBoxAnalysisDescriptionsDoSearch.Checked = this._SearchForDescriptions;
        //}
        
        //private void checkBoxAnalysisDescriptionsRestrictToLocalServer_Click(object sender, EventArgs e)
        //{
        //    this.checkBoxAnalysisDescriptionsRestrictToLocalServer.Checked = true;
        //}

        //private string _DiversityDescriptionsApplicationPath;
        //private void buttonAnalysisDescriptionsOpenModule_Click(object sender, EventArgs e)
        //{
        //    if (this._DiversityDescriptionsApplicationPath == null || this._DiversityDescriptionsApplicationPath.Length == 0)
        //    {
        //    }
        //    else
        //    {
        //        System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxAnalysisDescriptions.SelectedItem;
        //        string URI = R["URI"].ToString();
        //        //string ID = DiversityWorkbench.WorkbenchUnit.getIDFromURI(URI);
        //        System.Diagnostics.Process.Start(this._DiversityDescriptionsApplicationPath, URI);
        //    }
        //}

        //private void buttonAnalysisDescriptionsShowInfos_Click(object sender, EventArgs e)
        //{
        //    System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxAnalysisDescriptions.SelectedItem;
        //    string URI = R["URI"].ToString();
        //    DiversityWorkbench.Description D = new DiversityWorkbench.Description(DiversityWorkbench.Settings.ServerConnection);
        //    DiversityWorkbench.FormRemoteQuery f = new DiversityWorkbench.FormRemoteQuery(URI, D);
        //    f.ShowDialog();
        //}

        //#endregion

        #endregion

        #region Specimen parts

        #region New Part

        private void setToolStripDropDownButtonOverviewHierarchyNewPart()
        {
            this.toolStripDropDownButtonOverviewHierarchyNewPart.DropDownItems.Clear();
            foreach (System.Data.DataRow R in DiversityCollection.LookupTable.DtMaterialCategoryList.Rows)
            {
                string Caption = "New " + R["DisplayText"].ToString();
                System.Drawing.Image Image = DiversityCollection.Specimen.MaterialCategoryImage(false, R["Code"].ToString());
                System.Windows.Forms.ToolStripMenuItem mi = new System.Windows.Forms.ToolStripMenuItem(Caption, Image, newPart);
                mi.Tag = R["Code"];
                mi.ToolTipText = "Insert a new " + R["Description"].ToString();
                //mi.Image = global::DiversityCollection.Resource.Processing;
                this.toolStripDropDownButtonOverviewHierarchyNewPart.DropDownItems.Add(mi);
                //this.toolStripDropDownButtonOverviewHierarchyNewUnit.DropDownItems.Add(R["DisplayText"].ToString(),
            }
        }

        private void setToolStripDropDownButtonOverviewHierarchyNewPartWithHierarchy()
        {
            this.toolStripDropDownButtonOverviewHierarchyNewPart.DropDownItems.Clear();
            foreach (System.Data.DataRow R in DiversityCollection.LookupTable.DtMaterialCategoryList.Rows)
            {
                if (R["ParentCode"].Equals(System.DBNull.Value) || R["ParentCode"].ToString().Length == 0)
                {
                    string Caption = "New " + R["DisplayText"].ToString();
                    System.Drawing.Image Image = DiversityCollection.Specimen.MaterialCategoryImage(false, R["Code"].ToString());
                    System.Windows.Forms.ToolStripMenuItem mi = new System.Windows.Forms.ToolStripMenuItem(Caption, Image, newPart);
                    mi.Tag = R["Code"];
                    mi.ToolTipText = "Insert a new " + R["Description"].ToString();
                    this.toolStripDropDownButtonOverviewHierarchyNewPart.DropDownItems.Add(mi);
                    this.setToolStripDropDownButtonOverviewHierarchyNewPartWithHierarchy(mi);
                }
            }
        }

        private void setToolStripDropDownButtonOverviewHierarchyNewPartWithAdaptiveHierarchy()
        {
            this.toolStripDropDownButtonOverviewHierarchyNewPart.DropDownItems.Clear();
            System.Collections.Generic.Dictionary<string, string> MaterialCodeHierarchy = new Dictionary<string, string>();
            try
            {
                foreach (System.Data.DataRow R in DiversityCollection.LookupTable.DtMaterialCategoryList.Rows)
                {
                    try
                    {
                        string Code = R["Code"].ToString();
                        string Parent = DiversityCollection.LookupTable.MaterialCategoryVisibleParent(R["Code"].ToString()); ;
                        if (!MaterialCodeHierarchy.ContainsKey(Code))
                            MaterialCodeHierarchy.Add(Code, Parent);
                        else
                        {
                        }
                    }
                    catch (System.Exception ex)
                    {
                    }
                }
                foreach (System.Collections.Generic.KeyValuePair<string, string> KV in MaterialCodeHierarchy)
                {
                    if (KV.Value.Length == 0)
                    {
                        string Caption = KV.Key;
                        if (DiversityCollection.Specimen.MaterialCategory_Images.ContainsKey(KV.Key))
                        {
                            try
                            {
                                System.Drawing.Image Image = DiversityCollection.Specimen.MaterialCategoryImage(false, KV.Key);
                                System.Windows.Forms.ToolStripMenuItem mi = new System.Windows.Forms.ToolStripMenuItem(Caption, Image, newPart);
                                mi.Tag = KV.Key;
                                System.Data.DataRow[] RR = DiversityCollection.LookupTable.DtMaterialCategoryList.Select("Code = '" + KV.Key + "'");
                                mi.ToolTipText = "Insert a new " + RR[0]["Description"].ToString();
                                this.toolStripDropDownButtonOverviewHierarchyNewPart.DropDownItems.Add(mi);
                                this.setToolStripDropDownButtonOverviewHierarchyNewPartWithAdaptiveHierarchy(mi, ref MaterialCodeHierarchy);
                            }
                            catch (System.Exception ex)
                            {
                            }
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        private void setToolStripDropDownButtonOverviewHierarchyNewPartWithAdaptiveHierarchy(System.Windows.Forms.ToolStripMenuItem ToolStripMenuItem, ref System.Collections.Generic.Dictionary<string, string> MaterialCodes)
        {
            try
            {
                string Code = ToolStripMenuItem.Tag.ToString();
                foreach (System.Collections.Generic.KeyValuePair<string, string> KV in MaterialCodes)
                {
                    if (KV.Value == Code)
                    {
                        string Caption = KV.Key;
                        System.Drawing.Image Image = DiversityCollection.Specimen.MaterialCategoryImage(false, KV.Key);
                        System.Windows.Forms.ToolStripMenuItem mi = new System.Windows.Forms.ToolStripMenuItem(Caption, Image, newPart);
                        mi.Tag = KV.Key;
                        System.Data.DataRow[] RR = DiversityCollection.LookupTable.DtMaterialCategoryList.Select("Code = '" + KV.Key + "'");
                        mi.ToolTipText = "Insert a new " + RR[0]["Description"].ToString();
                        ToolStripMenuItem.DropDownItems.Add(mi);
                        this.setToolStripDropDownButtonOverviewHierarchyNewPartWithAdaptiveHierarchy(mi, ref MaterialCodes);
                    }
                }
            }
            catch { }
        }

        private void setToolStripDropDownButtonOverviewHierarchyNewPartWithHierarchy(System.Windows.Forms.ToolStripMenuItem ToolStripMenuItem)
        {
            try
            {
                string ParentCode = ToolStripMenuItem.Tag.ToString();
                foreach (System.Data.DataRow R in DiversityCollection.LookupTable.DtMaterialCategoryList.Rows)
                {
                    if (R["ParentCode"].ToString() == ParentCode)
                    {
                        string Caption = R["DisplayText"].ToString();
                        System.Drawing.Image Image = DiversityCollection.Specimen.MaterialCategoryImage(false, R["Code"].ToString());
                        System.Windows.Forms.ToolStripMenuItem mi = new System.Windows.Forms.ToolStripMenuItem(Caption, Image, newPart);
                        mi.Tag = R["Code"];
                        mi.ToolTipText = "Insert a new " + R["Description"].ToString();
                        ToolStripMenuItem.DropDownItems.Add(mi);
                        this.setToolStripDropDownButtonOverviewHierarchyNewPartWithHierarchy(mi);
                    }
                }
            }
            catch { }
        }

        private void newPart(object sender, System.EventArgs e)
        {
            int? NewPartID = null;
            if (this.treeViewOverviewHierarchyStorage.SelectedNode == null) return;
            if (this.treeViewOverviewHierarchyStorage.SelectedNode.Tag == null) return;
            if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
            {
                System.Windows.Forms.ToolStripMenuItem M = (System.Windows.Forms.ToolStripMenuItem)sender;
                string MaterialCategory = M.Tag.ToString();
                if (MaterialCategory.Contains("bservation"))
                {
                    string Message = MaterialCategory.Substring(0, 1).ToUpper() + MaterialCategory.Substring(1) + "\r\ncan not be placed in a collection";
                    System.Windows.Forms.MessageBox.Show(Message);
                    return;
                }
                try
                {
                    System.Data.DataRow DataRow = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                    string Table = DataRow.Table.TableName;
                    int? CollectionID = null;
                    int CID = 0;
                    if (!DataRow["CollectionID"].Equals(System.DBNull.Value))
                    {
                        if (int.TryParse(DataRow["CollectionID"].ToString(), out CID))
                            CollectionID = CID;
                    }
                    if (DefaultCollection != -1 && CollectionID == null)
                        CollectionID = DefaultCollection;

                    if (CollectionID == null)
                    {
                        DiversityWorkbench.FormGetItemFromHierarchy f = new DiversityWorkbench.FormGetItemFromHierarchy(
                            DiversityCollection.LookupTable.DtCollectionWithHierarchy,
                            "CollectionID",
                            "CollectionParentID",
                            "DisplayText",
                            "CollectionName",
                            "CollectionID",
                            "Please select a collection",
                            "Collection",
                            true);
                        f.ShowDialog();
                        if (f.DialogResult != DialogResult.OK)
                            return;
                        else
                            CollectionID = int.Parse(f.SelectedValue);

                    }

                    int? DerivedFromSpecimenPartID = null;
                    try
                    {
                        if (Table == "CollectionSpecimenPart")
                            DerivedFromSpecimenPartID = System.Int32.Parse(DataRow["SpecimenPartID"].ToString());
                        int SpecimenPartID = 0;

                        // get SpecimenPartID from database
                        string StorageLocation = "";
                        if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.StorageLocationSource == "Taxa")
                        {
                            if (this.dataSetCollectionSpecimen.IdentificationUnit.Rows.Count > 0)
                            {
                                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnit.Select("DisplayOrder = 1", "");
                                if (rr.Length > 0)
                                    StorageLocation = rr[0]["LastIdentificationCache"].ToString();
                            }
                        }
                        else if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.StorageLocationSource == "Text")
                            StorageLocation = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.StorageLocationText;

                        string SQL = "INSERT INTO CollectionSpecimenPart (CollectionSpecimenID, MaterialCategory, CollectionID, DerivedFromSpecimenPartID, StorageLocation)";
                        SQL += " VALUES (" + this.ID.ToString() + ", '" + MaterialCategory + "', ";
                        if (CollectionID != null) SQL += CollectionID.ToString();
                        else SQL += "NULL";
                        SQL += ", ";
                        if (DerivedFromSpecimenPartID != null) SQL += DerivedFromSpecimenPartID.ToString();
                        else SQL += "NULL";
                        SQL += ", '" + DiversityWorkbench.FormFunctions.SqlRemoveHyphens(StorageLocation) + "') (SELECT SCOPE_IDENTITY() AS [SCOPE_IDENTITY])";

                        SpecimenPartID = int.Parse(DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL));
                        string SqlTest = "SELECT MAX(SpecimenPartID) FROM CollectionSpecimenPart";
                        string Test = DiversityWorkbench.FormFunctions.SqlExecuteScalar(SqlTest);
                        if (Test != SpecimenPartID.ToString())
                            int.TryParse(Test, out SpecimenPartID);

                        System.Data.DataRow R = this.dataSetCollectionSpecimen.CollectionSpecimenPart.NewRow();
                        R["CollectionSpecimenID"] = this.ID;
                        R["SpecimenPartID"] = SpecimenPartID;
                        R["MaterialCategory"] = MaterialCategory;
                        if (CollectionID != null)
                            R["CollectionID"] = CollectionID;
                        else
                        {
                            if (DefaultCollection != -1)
                                R["CollectionID"] = DefaultCollection;
                            else
                            {
                                DiversityWorkbench.FormGetItemFromHierarchy f = new DiversityWorkbench.FormGetItemFromHierarchy(
                                    DiversityCollection.LookupTable.DtCollection,
                                    "CollectionID",
                                    "CollectionParentID",
                                    "CollectionName",
                                    "CollectionID",
                                    "Select a collection from the list or choose it from the hierarchy",
                                    "Select a collection");
                                f.ShowDialog();
                                if (f.DialogResult == DialogResult.OK)
                                {
                                    R["CollectionID"] = int.Parse(f.SelectedValue.ToString());
                                }
                                else return;
                            }
                        }
                        if (DerivedFromSpecimenPartID != null)
                            R["DerivedFromSpecimenPartID"] = (int)DerivedFromSpecimenPartID;
                        if (this.dataSetCollectionSpecimen.IdentificationUnit.Rows.Count > 0
                            && DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.StorageLocationSource == "Taxa")
                        {
                            System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnit.Select("DisplayOrder = 1", "");
                            if (rr.Length > 0)
                                R["StorageLocation"] = rr[0]["LastIdentificationCache"].ToString();
                        }
                        else if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.StorageLocationSource == "Text")
                            R["StorageLocation"] = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.StorageLocationText;
                        this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows.Add(R);
                        R.AcceptChanges();
                        switch (Table)
                        {
                            case "Collection":
                            case "CollectionSpecimen":
                                foreach (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitRow RU in this.dataSetCollectionSpecimen.IdentificationUnit.Rows)
                                {
                                    DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow RNew =
                                        (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow)this.dataSetCollectionSpecimen.IdentificationUnitInPart.NewRow();
                                    RNew.CollectionSpecimenID = int.Parse(RU["CollectionSpecimenID"].ToString());
                                    RNew.SpecimenPartID = SpecimenPartID;
                                    RNew.IdentificationUnitID = int.Parse(RU["IdentificationUnitID"].ToString());
                                    RNew.DisplayOrder = short.Parse(RU["DisplayOrder"].ToString());
                                    this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows.Add(RNew);
                                }
                                break;
                            case "CollectionSpecimenPart":
                                if (DerivedFromSpecimenPartID != null)
                                {
                                    System.Collections.Generic.List<DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow> RowList = new List<DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow>();
                                    foreach (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow RP in this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows)
                                    {
                                        if (RP.SpecimenPartID == (int)DerivedFromSpecimenPartID)
                                        {
                                            DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow RNew =
                                                (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow)this.dataSetCollectionSpecimen.IdentificationUnitInPart.NewRow();
                                            RNew.CollectionSpecimenID = int.Parse(RP["CollectionSpecimenID"].ToString());
                                            RNew.SpecimenPartID = SpecimenPartID;
                                            RNew.IdentificationUnitID = int.Parse(RP["IdentificationUnitID"].ToString());
                                            RNew.DisplayOrder = short.Parse(RP["DisplayOrder"].ToString());
                                            RowList.Add(RNew);
                                            //this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows.Add(RNew);
                                        }
                                    }
                                    foreach (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow RList in RowList)
                                    {
                                        this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows.Add(RList);
                                    }
                                }
                                break;
                            default:
                                break;
                        }
                        this.updateSpecimen();
                        this.buildOverviewHierarchyParts();
                        this.treeViewOverviewHierarchyStorage.SelectedNode = getTreeNodeOfDataRow(treeViewOverviewHierarchyStorage, null, R);
                    }
                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                }
                catch { return; }
            }
        }
        
        #endregion

        private void dateTimePickerPreparationDate_CloseUp(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
            R["PreparationDate"] = this.dateTimePickerPreparationDate.Value.ToShortDateString();
            this.textBoxPreparationDate.Text = this.dateTimePickerPreparationDate.Value.ToShortDateString();
        }

        private void comboBoxPreparationMethod_DropDown(object sender, EventArgs e)
        {
            this.comboBoxPreparationMethod.DropDownWidth = this.textBoxPreparationMethod.Width;
            if (this.collectionSpecimenPartBindingSource.Current != null)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
                if (!R["MaterialCategory"].Equals(System.DBNull.Value))
                {
                    string MaterialCategory = R["MaterialCategory"].ToString();
                    string SQL = "SELECT DISTINCT PreparationMethod FROM CollectionSpecimenPart WHERE MaterialCategory = '" + MaterialCategory + "' ";
                    if (this.textBoxPreparationMethod.Text.Length > 0)
                        SQL += " AND PreparationMethod LIKE '" + this.textBoxPreparationMethod.Text + "%' ";
                    SQL += "ORDER BY PreparationMethod";
                    System.Data.DataTable dt = new DataTable();
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(dt);
                    this.comboBoxPreparationMethod.DataSource = dt;
                    this.comboBoxPreparationMethod.DisplayMember = "PreparationMethod";
                    this.comboBoxPreparationMethod.ValueMember = "PreparationMethod";
                }
            }
        }

        private void comboBoxPreparationMethod_SelectionChangeCommitted(object sender, EventArgs e)
        {
            if (this.comboBoxPreparationMethod.SelectedValue == null) return;
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
            R["PreparationMethod"] = this.comboBoxPreparationMethod.SelectedValue.ToString();
            this.textBoxPreparationMethod.Text = this.comboBoxPreparationMethod.SelectedValue.ToString();
        }

        private void toolStripButtonOverviewHierarchyCopyPart_Click(object sender, EventArgs e)
        {
            try
            {
                //Check if anything is available  
                if (this.collectionSpecimenPartBindingSource.Current == null)
                {
                    System.Windows.Forms.MessageBox.Show("Nothing to copy");
                    return;
                }

                //Creating the DataSet used as as template for the Copy form
                DiversityCollection.Datasets.DataSetCollectionSpecimen ds = (DiversityCollection.Datasets.DataSetCollectionSpecimen)this.dataSetCollectionSpecimen.Clone();
                DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenPartRow RS = ds.CollectionSpecimenPart.NewCollectionSpecimenPartRow();
                System.Data.DataRowView Rori = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
                foreach (System.Data.DataColumn C in this.dataSetCollectionSpecimen.CollectionSpecimenPart.Columns)
                {
                    RS[C.ColumnName] = Rori[C.ColumnName];
                }
                ds.CollectionSpecimenPart.Rows.Add(RS);


                DiversityCollection.Forms.FormCopyPart f = new Forms.FormCopyPart(ds);
                f.ShowDialog();

                if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                {
                    int iOriPartID;
                    if (int.TryParse(Rori["SpecimenPartID"].ToString(), out iOriPartID))
                    {
                        foreach (System.Data.DataRow R in f.DataTableParts().Rows)
                        {
                            string SQL = "DECLARE @SpecimenPartID int; EXECUTE [dbo].[procCopyCollectionSpecimenPart] " +
                                "NULL, " +
                                iOriPartID.ToString() + ", ";

                            if (R["AccessionNumber"].Equals(System.DBNull.Value))
                                SQL += "NULL";
                            else SQL += "'" + R["AccessionNumber"].ToString().Replace("'", "''") + "'";
                            SQL += ", ";
                            if (R["PartSublabel"].Equals(System.DBNull.Value))
                                SQL += "NULL";
                            else SQL += "'" + R["PartSublabel"].ToString().Replace("'", "''") + "'";
                            SQL += ", ";
                            if (R["StorageLocation"].Equals(System.DBNull.Value))
                                SQL += "NULL";
                            else SQL += "'" + R["StorageLocation"].ToString().Replace("'", "''") + "'";
                            SQL += ", ";
                            SQL += "'" + f.IncludedTables() + "'";
                            DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SQL);
                        }
                    }
                }
                this.setSpecimen(this.ID);
                //this.buildOverviewHierarchyParts();
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }

            return;
            
            //if (this.treeViewOverviewHierarchyStorage.SelectedNode == null) return;
            //if (this.treeViewOverviewHierarchyStorage.SelectedNode.Tag == null) return;
            //System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
            //if (R.Table.TableName != "CollectionSpecimenPart") return;
            //DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenPartRow Rnew = this.dataSetCollectionSpecimen.CollectionSpecimenPart.NewCollectionSpecimenPartRow();
            //System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenPart.Select("", "SpecimenPartID DESC");
            //int SpecimenPartID = 0;
            //if (rr.Length == 0) return;
            //int.TryParse(rr[0]["SpecimenPartID"].ToString(), out SpecimenPartID);
            //int OriSpecimenPartID = SpecimenPartID;

            //string SQL = "INSERT INTO CollectionSpecimenPart (CollectionSpecimenID, MaterialCategory, CollectionID, DerivedFromSpecimenPartID, StorageLocation)";
            //SQL += " VALUES (" + this.ID.ToString() + ", '" + R["MaterialCategory"].ToString() + "', ";
            //if (!R["CollectionID"].Equals(System.DBNull.Value))
            //    SQL += R["CollectionID"].ToString();
            //else SQL += "NULL";
            //SQL += ", ";
            //if (!R["DerivedFromSpecimenPartID"].Equals(System.DBNull.Value))
            //    SQL += R["DerivedFromSpecimenPartID"].ToString();
            //else SQL += "NULL";
            //SQL += ", ";
            //if (!R["StorageLocation"].Equals(System.DBNull.Value))
            //    SQL += "'" + DiversityWorkbench.FormFunctions.SqlRemoveHyphens(R["StorageLocation"].ToString()) + "'";
            //else SQL += "''";
            //SQL += ") (SELECT SCOPE_IDENTITY() AS [SCOPE_IDENTITY])";

            //SpecimenPartID = int.Parse(DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL));


            ////SpecimenPartID++;
            //foreach (System.Data.DataColumn C in Rnew.Table.Columns)
            //{
            //    if (C.ColumnName == "SpecimenPartID")
            //        Rnew[C.ColumnName] = SpecimenPartID;
            //    else
            //        Rnew[C.ColumnName] = R[C.ColumnName];
            //}

            //this.sqlDataAdapterPart.SelectCommand.CommandText = DiversityCollection.CollectionSpecimen.SqlPart + " WHERE SpecimenPartID = " + SpecimenPartID;
            //this.sqlDataAdapterPart.Fill(this.dataSetCollectionSpecimen.CollectionSpecimenPart);
            ////this.FormFunctions.initSqlAdapter(ref this.sqlDataAdapterPart, DiversityCollection.CollectionSpecimen.SqlPart + WhereClause + " ORDER BY AccessionNumber, PartSublabel, StorageLocation", this.dataSetCollectionSpecimen.CollectionSpecimenPart);

            ////this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows.Add(Rnew);


            //System.Collections.Generic.List<System.Data.DataRow> Rowlist = new List<DataRow>();
            //foreach (System.Data.DataRow RUiP in this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows)
            //{
            //    if (RUiP["SpecimenPartID"].ToString() == OriSpecimenPartID.ToString())
            //    {
            //        DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow RUipNew = this.dataSetCollectionSpecimen.IdentificationUnitInPart.NewIdentificationUnitInPartRow();
            //        foreach (System.Data.DataColumn C in RUipNew.Table.Columns)
            //        {
            //            if (C.ColumnName == "SpecimenPartID")
            //                RUipNew[C.ColumnName] = SpecimenPartID;
            //            //else if (C.ColumnName == "DisplayOrder")
            //            //    RUipNew[C.ColumnName] = 0;
            //            else
            //                RUipNew[C.ColumnName] = RUiP[C.ColumnName];
            //        }
            //        Rowlist.Add(RUipNew);
            //    }
            //}
            //foreach (System.Data.DataRow RUipNew in Rowlist)
            //{
            //    this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows.Add(RUipNew);
            //}
            //this.buildOverviewHierarchyParts();
            //this.treeViewOverviewHierarchyStorage.SelectedNode = getTreeNodeOfDataRow(treeViewOverviewHierarchyStorage, null, Rnew);
        }

        private void comboBoxStorageContainer_DropDown(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
            string Container = "";
            if (!R["StorageContainer"].Equals(System.DBNull.Value) && R["StorageContainer"].ToString().Length > 0)
                Container = R["StorageContainer"].ToString();
            string SQL = "SELECT DISTINCT SP.StorageContainer " +
                "FROM CollectionSpecimenPart AS SP INNER JOIN " +
                "CollectionProject AS P ON SP.CollectionSpecimenID = P.CollectionSpecimenID INNER JOIN " +
                "ProjectList AS L ON P.ProjectID = L.ProjectID ";
            if(this.userControlQueryList.ProjectID != -1)
                SQL += "WHERE L.ProjectID = " + this.userControlQueryList.ProjectID.ToString() + " AND SP.StorageContainer <> '' " ;
            SQL += " ORDER BY SP.StorageContainer";
            System.Data.DataTable dt = new DataTable();
            if (Container.Length > 0)
            {
                System.Data.DataColumn C = new DataColumn("StorageContainer", System.Type.GetType("System.String"));
                dt.Columns.Add(C);
                System.Data.DataRow r = dt.NewRow();
                r[0] = Container;
                dt.Rows.Add(r);
                //SQL = "SELECT '" + Container + "' AS StorageContainer UNION " + SQL;
            }
            System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            ad.Fill(dt);
            if (dt.Rows.Count > 0)
            {
                this.comboBoxStorageContainer.DataSource = dt;
                this.comboBoxStorageContainer.ValueMember = "StorageContainer";
                this.comboBoxStorageContainer.DisplayMember = "StorageContainer";
            }
            else
                this.comboBoxStorageContainer.DataSource = null;
        }

        private void comboBoxStockUnit_DropDown(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
            string StockUnit = "";
            if (!R["StockUnit"].Equals(System.DBNull.Value) && R["StockUnit"].ToString().Length > 0)
                StockUnit = R["StockUnit"].ToString();
            string SQL = "SELECT DISTINCT SP.StockUnit " +
                "FROM CollectionSpecimenPart AS SP INNER JOIN " +
                "CollectionProject AS P ON SP.CollectionSpecimenID = P.CollectionSpecimenID INNER JOIN " +
                "ProjectList AS L ON P.ProjectID = L.ProjectID ";
            if (this.userControlQueryList.ProjectID != -1)
                SQL += "WHERE L.ProjectID = " + this.userControlQueryList.ProjectID.ToString();
            SQL += " ORDER BY SP.StockUnit";
            System.Data.DataTable dt = new DataTable();
            if (StockUnit.Length > 0)
            {
                System.Data.DataColumn C = new DataColumn("StockUnit", System.Type.GetType("System.String"));
                dt.Columns.Add(C);
                System.Data.DataRow r = dt.NewRow();
                r[0] = StockUnit;
                dt.Rows.Add(r);
            }
            System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            ad.Fill(dt);
            if (dt.Rows.Count > 0)
            {
                this.comboBoxStockUnit.DataSource = dt;
                this.comboBoxStockUnit.ValueMember = "StockUnit";
                this.comboBoxStockUnit.DisplayMember = "StockUnit";
            }
            else
                this.comboBoxStockUnit.DataSource = null;
        }

        private void buttonStockHistoryInfo_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.collectionSpecimenPartBindingSource.Current != null)
                {
                    System.Data.DataRowView RV = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
                    string PartID = RV["SpecimenPartID"].ToString();
                    string SQL = "SELECT P.Stock, P.StockUnit, getdate() AS [Date], P.LogUpdatedBy AS [User] " +
                        "FROM CollectionSpecimenPart AS P " +
                        "WHERE (P.SpecimenPartID = " + PartID + ") " +
                        "UNION " +
                        "SELECT L.Stock, L.StockUnit, L.LogDate AS [Date], case when U.CombinedNameCache is null or L.LogUser = 'dbo' then L.LogUser else U.CombinedNameCache end AS [User] " +
                        "FROM CollectionSpecimenPart AS P INNER JOIN " +
                        "CollectionSpecimenPart_log AS L ON P.CollectionSpecimenID = L.CollectionSpecimenID AND P.SpecimenPartID = L.SpecimenPartID LEFT OUTER JOIN " +
                        "UserProxy AS U ON L.LogUser = U.LoginName " +
                        "WHERE (NOT (L.Stock IS NULL)) AND (L.SpecimenPartID = " + PartID + ") " +
                        "ORDER BY [Date]";
                    System.Data.DataTable dt = new DataTable();
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.Connection);
                    ad.Fill(dt);
                    System.Windows.Forms.Form F = new Form();
                    F.Text = "Volume history of the selected part";
                    F.Width = 500;
                    F.Height = 200;
                    System.Windows.Forms.DataGridView G = new DataGridView();
                    F.Controls.Add(G);
                    G.DataSource = dt;
                    G.Dock = DockStyle.Fill;
                    //G.Enabled = false;
                    G.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                    System.ComponentModel.ComponentResourceManager resources = new System.ComponentModel.ComponentResourceManager(typeof(FormCollectionSpecimen));
                    F.Icon = ((System.Drawing.Icon)(resources.GetObject("$this.Icon")));
                    G.AllowUserToAddRows = false;
                    G.RowHeadersVisible = false;
                    G.AllowUserToDeleteRows = false;
                    //G.ReadOnly = true;
                    foreach (System.Windows.Forms.DataGridViewColumn C in G.Columns)
                    {
                        C.ReadOnly = true;
                        C.AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells;
                    }
                    F.StartPosition = FormStartPosition.CenterParent;
                    F.ShowDialog();
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        private void buttonFindNextAccessionNumberPart_Click(object sender, EventArgs e)
        {
            try
            {
                string AccessionNumber = this.textBoxAccessionNumberPart.Text;
                if (AccessionNumber.Length == 0)
                    AccessionNumber = this.textBoxAccessionNumber.Text;
                DiversityCollection.FormAccessionNumber f = new FormAccessionNumber(AccessionNumber, false, true);
                f.ShowDialog();
                if (f.DialogResult == DialogResult.OK)
                {
                    if (f.AccessionNumber.Length > 0)
                    {
                        System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
                        R["AccessionNumber"] = f.AccessionNumber;
                        this.textBoxAccessionNumberPart.Text = f.AccessionNumber;
                    }
                }
            }
            catch (System.Exception ex) { }
        }

        private void buttonSetMaterialCategoryRange_Click(object sender, EventArgs e)
        {
            this.CustomizeDisplay(FormCustomizeDisplay.Customization.MaterialCategory);
        }

        private void textBoxStock_TextChanged(object sender, EventArgs e)
        {
            if (this.textBoxStock.Text.Length == 0)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
                R.BeginEdit();
                R["Stock"] = System.DBNull.Value;
                R.EndEdit();
                this.textBoxStorageNotes.Focus();
                //this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenPart", this.sqlDataAdapterPart, this.BindingContext);
            }
            else
            {
                double Stock;
                if (!double.TryParse(this.textBoxStock.Text, out Stock))
                {
                    System.Windows.Forms.MessageBox.Show(this.textBoxStock.Text + " is not a numeric value");
                }
            }
        }

        #region Storage Location

        private void buttonSetStorageLocationSource_Click(object sender, EventArgs e)
        {
            this.CustomizeDisplay(FormCustomizeDisplay.Customization.StorageLocation);
        }

        private void comboBoxStorageLocation_DropDown(object sender, EventArgs e)
        {
            System.Collections.Generic.List<string> StorageList = new List<string>();
            StorageList.Add(this.textBoxStorageLocation.Text);
            try
            {
                if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.StorageLocationSource == "Text")
                {
                    StorageList.Add(DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.StorageLocationText);
                }
                else if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.StorageLocationSource == "Taxa")
                {
                    foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.Identification.Rows)
                    {
                        if (!StorageList.Contains(R["TaxonomicName"].ToString()))
                            StorageList.Add(R["TaxonomicName"].ToString());
                    }
                }
                else
                {
                    string CollectionID = "";
                    string SQL = "SELECT DISTINCT StorageLocation " +
                        "FROM CollectionSpecimenPart " +
                        "WHERE (StorageLocation <> '') ";
                    System.Data.DataRowView RV = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
                    if (!RV["StorageLocation"].Equals(System.DBNull.Value) && RV["StorageLocation"].ToString().Length > 0)
                        SQL += " AND StorageLocation <> '" + RV["StorageLocation"].ToString() + "'";
                    if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.StorageLocationSource == "Collection")
                    {
                        if (!RV["CollectionID"].Equals(System.DBNull.Value))
                            CollectionID = RV["CollectionID"].ToString();
                        if (CollectionID.Length > 0)
                            SQL += " AND CollectionID = " + CollectionID;
                    }
                    SQL += " ORDER BY StorageLocation";
                    System.Data.DataTable dt = new DataTable();
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(dt);
                    foreach (System.Data.DataRow r in dt.Rows)
                        StorageList.Add(r[0].ToString());
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            this.comboBoxStorageLocation.DataSource = StorageList;
        }

        private void comboBoxStorageLocation_SelectionChangeCommitted(object sender, EventArgs e)
        {
            string StorageLocation = this.comboBoxStorageLocation.SelectedValue.ToString();
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
            R.BeginEdit();
            R["StorageLocation"] = StorageLocation;
            R.EndEdit();
            this.textBoxStorageLocation.Text = this.comboBoxStorageLocation.SelectedValue.ToString(); //StorageLocation;
            if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
            {
                DiversityCollection.HierarchyNode N = (DiversityCollection.HierarchyNode)this.treeViewOverviewHierarchyStorage.SelectedNode;
                N.setText();
            }
            //this.buildStorageHierarchy();
        }
        
        #endregion

        private void textBoxSpecimenPartID_ReadOnlyChanged(object sender, EventArgs e)
        {
            if (!this.textBoxSpecimenPartID.ReadOnly)
                this.textBoxSpecimenPartID.ReadOnly = true;
        }

        #region Template
        
        private void buttonTemplatePartSet_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.TemplateForData T = new DiversityWorkbench.TemplateForData("CollectionSpecimenPart", TemplatePartSuppressedColumns, TemplatePartSourceTables);
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
            T.CopyTemplateToRow(R.Row);
        }

        private System.Collections.Generic.List<string> TemplatePartSuppressedColumns
        {
            get
            {
                System.Collections.Generic.List<string> Suppress = new List<string>();
                Suppress.Add("CollectionSpecimenID");
                Suppress.Add("SpecimenPartID");
                Suppress.Add("CollectionID");
                Suppress.Add("DerivedFromSpecimenPartID");
                Suppress.Add("LogCreatedWhen");
                Suppress.Add("LogCreatedBy");
                Suppress.Add("LogUpdatedWhen");
                Suppress.Add("LogUpdatedBy");
                Suppress.Add("RowGUID");
                return Suppress;
            }
        }

        private System.Collections.Generic.Dictionary<string, DiversityWorkbench.TemplateForDataSourceTable> TemplatePartSourceTables
        {
            get
            {
                DiversityWorkbench.TemplateForDataSourceTable ST = new DiversityWorkbench.TemplateForDataSourceTable(LookupTable.DtCollection, "CollectionName", "CollectionID");
                System.Collections.Generic.Dictionary<string, DiversityWorkbench.TemplateForDataSourceTable> SourceTables = new Dictionary<string, DiversityWorkbench.TemplateForDataSourceTable>();
                SourceTables.Add("CollectionID", ST);
                return SourceTables;
            }
        }

        private void buttonTemplatePartEdit_Click(object sender, EventArgs e)
        {
            System.Data.DataRow R = ((System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current).Row;
            DiversityWorkbench.Forms.FormTemplateEditor f = new DiversityWorkbench.Forms.FormTemplateEditor("CollectionSpecimenPart", R, this.TemplatePartSuppressedColumns, this.TemplatePartSourceTables);
            f.setHelp("Template");
            f.ShowDialog();
        }
        
        #endregion

        #endregion

        #region Part description

        private void toolStripButtonPartDescriptionAdd_Click(object sender, EventArgs e)
        {
            DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenPartDescriptionRow R = this.dataSetCollectionSpecimen.CollectionSpecimenPartDescription.NewCollectionSpecimenPartDescriptionRow();
            R.CollectionSpecimenID = this.ID;
            System.Data.DataRowView RP = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
            R.SpecimenPartID = int.Parse(RP["SpecimenPartID"].ToString());
            R.Description = "New description";
            this.dataSetCollectionSpecimen.CollectionSpecimenPartDescription.Rows.Add(R);
            this.setPartDescriptionSourcePosition();

            //System.Data.DataRowView RPartDes = (System.Data.DataRowView)this.collectionSpecimenPartDescriptionBindingSource.Current;
            //if (RPartDes != null)
            //{
            //    try
            //    {
            //        RPartDes.BeginEdit();
            //        RPartDes.EndEdit();
            //    }
            //    catch (System.Data.ConstraintException cex)
            //    {
            //        System.Windows.Forms.MessageBox.Show(cex.Message);
            //    }
            //}
            //this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "CollectionSpecimenPartDescription", this.sqlDataAdapterPartDescription, this.BindingContext);

        }

        private void toolStripButtonPartDescriptionDelete_Click(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenPartDescriptionBindingSource.Current;
            R.Delete();
            this.setPartDescriptionSourcePosition();
        }

        private void listBoxPartDescription_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.setPartDescriptionSourcePosition();
        }

        private void listBoxPartDescription_DataSourceChanged(object sender, EventArgs e)
        {
            this.setPartDescriptionSourcePosition();
        }

        private void setPartDescriptionSourcePosition()
        {
            int i = -1;
            try
            {
                bool DataBaseChanged = false;
                try 
                { 
                    System.Object o = this.listBoxPartDescription.SelectedItem; 
                }
                catch(System.Exception ex)
                {
                    DataBaseChanged = true;
                }
                if (this.listBoxPartDescription.Items.Count > 0 && DataBaseChanged)
                    this.listBoxPartDescription.SelectedIndex = 0;
                if (this.collectionSpecimenPartDescriptionBindingSource.Current != null && this.listBoxPartDescription.SelectedItem != null)
                {
                    System.Data.DataRowView Rlist = (System.Data.DataRowView)this.listBoxPartDescription.SelectedItem;
                    foreach (System.Data.DataRow RD in this.dataSetCollectionSpecimen.CollectionSpecimenPartDescription.Rows)
                    {
                        i++;
                        if (RD[0].ToString() == Rlist[0].ToString()
                            && RD[1].ToString() == Rlist[1].ToString()
                            && RD[2].ToString() == Rlist[2].ToString())
                        {
                            break;
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
            }
            this.collectionSpecimenPartDescriptionBindingSource.Position = i;

            bool EnablePartDescription = this.FormFunctions.getObjectPermissions("CollectionSpecimenPartDescription", "UPDATE");
            if (i == -1)
                EnablePartDescription = false;
            this.listBoxPartDescription.Enabled = EnablePartDescription;
            this.textBoxPartDescriptionNotes.Enabled = EnablePartDescription;
            this.userControlModuleRelatedEntryPartDescription.Enabled = EnablePartDescription;
            this.toolStripButtonPartDescriptionDelete.Enabled = EnablePartDescription;
        }
        
        #endregion

        #region IdentificationUnitInPart
        
        private void comboBoxIdentificationUnitInPartDescription_DropDown(object sender, EventArgs e)
        {
            try
            {
                this.comboBoxIdentificationUnitInPartDescription.DataSource = null;
                System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                int UnitID;
                int PartID;
                if (!int.TryParse(R["IdentificationUnitID"].ToString(), out UnitID)) return;
                if (!int.TryParse(R["SpecimenPartID"].ToString(), out PartID)) return;
                string SQL = "SELECT TaxonomicGroup " +
                    "FROM IdentificationUnit AS U " +
                    "WHERE IdentificationUnitID = " + UnitID.ToString();
                string TaxonomicGroup = DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL); ;

                SQL = "SELECT DISTINCT I.Description " +
                    "FROM IdentificationUnitInPart AS I INNER JOIN " +
                    "IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID AND I.IdentificationUnitID = U.IdentificationUnitID ";
                if (this.userControlQueryList.ProjectID != 0)
                    SQL += " INNER JOIN CollectionProject AS P ON I.CollectionSpecimenID = P.CollectionSpecimenID";
                SQL += " WHERE U.TaxonomicGroup = N'" + TaxonomicGroup + "'";
                if (this.userControlQueryList.ProjectID != 0)
                    SQL += " AND P.ProjectID = " + this.userControlQueryList.ProjectID.ToString();

                System.Data.DataTable dt = new DataTable();
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                this.comboBoxIdentificationUnitInPartDescription.DataSource = dt;
                this.comboBoxIdentificationUnitInPartDescription.DisplayMember = "Description";
                this.comboBoxIdentificationUnitInPartDescription.ValueMember = "Description";
            }
            catch (System.Exception ex) { }
        }


        
        #endregion

        #region Processing

        private void prepareToolStripDropDownButtonsProcessing(System.Windows.Forms.TreeNode Node)
        {
            if (Node.Tag == null) return;
            string MaterialCategory = "";
            try
            {
                if (this.toolStripDropDownButtonOverviewHierarchyNewProcessing.DropDownItems.Count > 0)
                    this.toolStripDropDownButtonOverviewHierarchyNewProcessing.DropDownItems.Clear();
                System.Data.DataRow DataRow = (System.Data.DataRow)Node.Tag;
                string Table = DataRow.Table.TableName;
                int? PartID = null;
                switch (Table)
                {
                    case "CollectionSpecimen":
                        break;
                    case "CollectionSpecimenProcessing":
                        System.Data.DataRow ParentRow = (System.Data.DataRow)Node.Parent.Tag;
                        if (ParentRow.RowState != DataRowState.Detached && ParentRow.RowState != DataRowState.Deleted)
                        {
                            if (ParentRow.Table.TableName == "CollectionSpecimenPart")
                            {
                                if (!ParentRow["MaterialCategory"].Equals(System.DBNull.Value))
                                {
                                    MaterialCategory = ParentRow["MaterialCategory"].ToString();
                                    PartID = int.Parse(ParentRow["SpecimenPartID"].ToString());
                                }
                            }
                        }
                        break;
                    case "CollectionSpecimenPart":
                        if (DataRow.RowState != DataRowState.Detached && DataRow.RowState != DataRowState.Deleted)
                        {
                            if (!DataRow["MaterialCategory"].Equals(System.DBNull.Value))
                            {
                                MaterialCategory = DataRow["MaterialCategory"].ToString();
                                PartID = int.Parse(DataRow["SpecimenPartID"].ToString());
                            }
                        }
                        break;
                    default:
                        return;
                }
                System.Data.DataTable Dt = DiversityCollection.LookupTable.ProcessingForPart(this.ID, PartID);
                foreach (System.Data.DataRow R in Dt.Rows)
                {
                    if (R["ProcessingParentID"].Equals(System.DBNull.Value))
                    {
                        string Caption = R["DisplayText"].ToString();
                        System.Windows.Forms.ToolStripMenuItem mi;
                        mi = new System.Windows.Forms.ToolStripMenuItem(Caption, null, menuItemOverviewHierarchyProcessingOnClick);
                        mi.Tag = R["ProcessingID"];
                        mi.Image = global::DiversityCollection.Resource.Processing;
                        mi.ToolTipText = R["Description"].ToString();
                        this.toolStripDropDownButtonOverviewHierarchyNewProcessing.DropDownItems.Add(mi);
                        this.addChildsToDropDownButtonProcessing(mi, MaterialCategory, Dt, R["ProcessingID"].ToString());
                    }
                }
                if (this.toolStripDropDownButtonOverviewHierarchyNewProcessing.DropDownItems.Count > 0)
                    this.toolStripDropDownButtonOverviewHierarchyNewProcessing.Visible = true;
                else
                    this.toolStripDropDownButtonOverviewHierarchyNewProcessing.Visible = false;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void addChildsToDropDownButtonProcessing(System.Windows.Forms.ToolStripMenuItem ToolStripMenuItem, string MaterialCategory, System.Data.DataTable DtProcessing, string ProcessingID)
        {
            foreach (System.Data.DataRow R in DtProcessing.Rows)
            {
                if (R["ProcessingParentID"].ToString() == ProcessingID)
                {
                    string Caption = R["DisplayText"].ToString();
                    System.Windows.Forms.ToolStripMenuItem mi;
                    mi = new System.Windows.Forms.ToolStripMenuItem(Caption, null, menuItemOverviewHierarchyProcessingOnClick);
                    mi.Tag = R["ProcessingID"];
                    mi.ToolTipText = R["Description"].ToString();
                    mi.Image = global::DiversityCollection.Resource.Processing;
                    ToolStripMenuItem.DropDownItems.Add(mi);
                    this.addChildsToDropDownButtonProcessing(mi, MaterialCategory, DtProcessing, R["ProcessingID"].ToString());
                }
            }
        }

        private void menuItemOverviewHierarchyProcessingOnClick(object sender, System.EventArgs e)
        {
            System.Windows.Forms.ToolStripMenuItem m = (System.Windows.Forms.ToolStripMenuItem)sender;
            int ProcessingID = 0;
            if (m.Tag == null) return;
            if (this.treeViewOverviewHierarchyStorage.SelectedNode == null) return;
            try
            {
                if (!this.ShowProcessing) this.toolStripButtonOverviewHierarchyDisplayShowProcessing_Click(null, null);
                System.Data.DataRow DataRow = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                string Table = DataRow.Table.TableName;
                if (int.TryParse(m.Tag.ToString(), out ProcessingID))
                {
                    try
                    {
                        int CollectionSpecimenID = int.Parse(DataRow["CollectionSpecimenID"].ToString());
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenProcessingRow R
                            = (DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenProcessingRow)this.dataSetCollectionSpecimen.CollectionSpecimenProcessing.NewRow();
                        R.CollectionSpecimenID = CollectionSpecimenID;
                        R.ProcessingID = ProcessingID;
                        R.ProcessingDate = System.DateTime.Now;
                        switch (Table)
                        {
                            case "CollectionSpecimen":
                                break;
                            case "CollectionSpecimenProcessing":
                                if (!DataRow["SpecimenPartID"].Equals(System.DBNull.Value))
                                    R.SpecimenPartID = int.Parse(DataRow["SpecimenPartID"].ToString());
                                break;
                            case "CollectionSpecimenPart":
                                R.SpecimenPartID = int.Parse(DataRow["SpecimenPartID"].ToString());
                                break;
                            default:
                                return;
                        }
                        if (Specimen.DefaultUseProcessingResponsible)
                        {
                            R.ResponsibleName = Specimen.DefaultResponsibleName;
                            R.ResponsibleAgentURI = Specimen.DefaultResponsibleURI;
                        }
                        this.dataSetCollectionSpecimen.CollectionSpecimenProcessing.Rows.Add(R);
                        this.refreshHierarchyPartUnitNodes(this.treeViewOverviewHierarchyStorage.SelectedNode, Table);
                    }
                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                }
            }
            catch { return; }
        }

        #region Tool usage

        private void toolStripButtonProcessingToolUsageAdd_Click(object sender, EventArgs e)
        {
            System.Data.DataRowView RV = (System.Data.DataRowView)this.collectionSpecimenProcessingBindingSource.Current;
            int ProcessingID = 0;
            if (int.TryParse(RV["ProcessingID"].ToString(), out ProcessingID))
            {
                this.ToolUsageAdd("ToolListForProcessing", ProcessingID, RV, this.treeViewProcessingToolUsage, this.toolStripButtonAnalysisToolSave);
                //this.toolStripButtonProcessingToolUsageSave.Enabled = true;
            }
        }

        private void toolStripButtonProcessingToolUsageEdit_Click(object sender, EventArgs e)
        {
            this.ToolUsageEdit(this.treeViewProcessingToolUsage.SelectedNode, this.toolStripButtonProcessingToolUsageSave);
            this.ToolUsageSave((System.Data.DataRowView)this.collectionSpecimenProcessingBindingSource.Current, this.treeViewProcessingToolUsage, this.toolStripButtonProcessingToolUsageSave);
        }

        private void toolStripButtonProcessingToolUsageDelete_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenProcessingBindingSource.Current;
                R.BeginEdit();
                string ToolUsage = this.RemoveToolUsage(R["ToolUsage"].ToString(), this.treeViewProcessingToolUsage.SelectedNode);
                R["ToolUsage"] = ToolUsage;
                R.EndEdit();
                DiversityCollection.Tool.BuildToolTreeFromXmlContent(this.treeViewProcessingToolUsage, ToolUsage);
                this.toolStripButtonProcessingToolUsageSave.Enabled = true;
                this.toolStripButtonProcessingToolUsageSave.BackColor = System.Drawing.Color.Red;
            }
            catch (Exception ex)
            {
            }
        }

        private void toolStripButtonProcessingToolUsageSave_Click_1(object sender, EventArgs e)
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenProcessingBindingSource.Current;
            this.ToolUsageSave(R, this.treeViewProcessingToolUsage, this.toolStripButtonProcessingToolUsageSave);
            //this.toolStripButtonProcessingToolUsageSave.Enabled = false;
            return;
        }

        private void toolStripButtonProcessingToolUsageInfo_Click(object sender, EventArgs e)
        {
            if (this.treeViewProcessingToolUsage.SelectedNode != null)
                this.ToolUsageInfo(this.treeViewAnalysisTools.SelectedNode);
        }

        private void treeViewProcessingToolUsage_AfterSelect(object sender, TreeViewEventArgs e)
        {
            //System.Windows.Forms.MessageBox.Show("Available in upcoming version");
            try
            {
                this.toolStripButtonProcessingToolUsageInfo.Enabled = false;
                this.toolStripButtonProcessingToolUsageDelete.Enabled = false;
                this.toolStripButtonProcessingToolUsageEdit.Enabled = false;
                this.toolStripButtonProcessingToolUsageSave.Enabled = false;
                this.toolStripButtonProcessingToolUsageAdd.Enabled = false;
                if (this.treeViewProcessingToolUsage.SelectedNode.Tag != null)
                {
                    DiversityWorkbench.UserControls.XMLNode X = (DiversityWorkbench.UserControls.XMLNode)this.treeViewProcessingToolUsage.SelectedNode.Tag;
                    if (X.Name == "Tool")
                    {
                        this.toolStripButtonProcessingToolUsageInfo.Enabled = true;
                        this.toolStripButtonProcessingToolUsageDelete.Enabled = true;
                    }
                    if (X.Name == "Usage")
                    {
                        this.toolStripButtonProcessingToolUsageEdit.Enabled = true;
                    }
                    if (X.Name == "Tools")
                    {
                        this.toolStripButtonProcessingToolUsageAdd.Enabled = true;
                    }
                }
                else if (this.treeViewProcessingToolUsage.SelectedNode.Text == "Tools")
                    this.toolStripButtonProcessingToolUsageAdd.Enabled = true;
            }
            catch (System.Exception ex) { }
        }

        private void BuildProcessingToolUsageTree()
        {
            try
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenProcessingBindingSource.Current;
                string ToolUsage = R["ToolUsage"].ToString();
                DiversityCollection.Tool.BuildToolTreeFromXmlContent(this.treeViewProcessingToolUsage, ToolUsage);
                this.toolStripButtonProcessingToolUsageInfo.Enabled = false;
                this.toolStripButtonProcessingToolUsageDelete.Enabled = false;
                this.toolStripButtonProcessingToolUsageEdit.Enabled = false;
                this.toolStripButtonProcessingToolUsageSave.Enabled = false;
                if (ToolUsage.Length > 0)
                    this.toolStripButtonProcessingToolUsageAdd.Enabled = false;
                else
                    this.toolStripButtonProcessingToolUsageAdd.Enabled = true;
            }
            catch { }
        }

        #region Common functions for tool handling

        private void ToolUsageAdd(string SqlFunction, int ID, System.Data.DataRowView RV, System.Windows.Forms.TreeView TreeView, System.Windows.Forms.ToolStripButton ToolStripButtonSave)
        {
            try
            {
                string Restriction = "";
                System.Data.DataTable dt = new DataTable();
                string SQL = "SELECT T.ToolID " +
                    " FROM dbo." + SqlFunction + "(" + ID.ToString() + ") T " +
                    " WHERE T.OnlyHierarchy = 0 AND NOT ToolUsageTemplate IS NULL";
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                if (dt.Rows.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("No tools are available for this Item");
                    return;
                }
                foreach (System.Data.DataRow r in dt.Rows)
                {
                    if (Restriction.Length > 0) Restriction += ", ";
                    Restriction += r[0].ToString();
                }
                System.Collections.Generic.List<DiversityWorkbench.QueryRestrictionItem> Restrictions = new List<DiversityWorkbench.QueryRestrictionItem>();
                DiversityWorkbench.QueryRestrictionItem Q = new DiversityWorkbench.QueryRestrictionItem();
                Q.ColumnName = "ToolID";
                Q.TableName = "Tool";
                Q.Restriction = " IN (" + Restriction + ")";
                Restrictions.Add(Q);
                DiversityCollection.Forms.FormTool f = new Forms.FormTool(null, Restrictions);
                f.ShowDialog();
                if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                {
                    RV.BeginEdit();
                    if (RV["ToolUsage"].Equals(System.DBNull.Value) || RV["ToolUsage"].ToString().Length == 0)
                        RV["ToolUsage"] = f.ToolUsageTemplate;
                    else
                    {
                        RV["ToolUsage"] = this.ToolUsageAdd(RV["ToolUsage"].ToString(), f.ToolUsageTemplate);
                    }
                    RV.EndEdit();
                }
                DiversityCollection.Tool.BuildToolTreeFromXmlContent(TreeView, RV["ToolUsage"].ToString());
                ToolStripButtonSave.Enabled = true;
                ToolStripButtonSave.BackColor = System.Drawing.Color.Red;
                this.ToolUsageSave(RV, TreeView, ToolStripButtonSave);
            }
            catch (Exception ex)
            {
            }
        }

        private void ToolUsageAdd(string RestrictionTable, string RestrictionColumn, System.Data.DataRowView RV, System.Windows.Forms.TreeView TreeView)
        {
            try
            {
                string Restriction = "";
                System.Data.DataTable dt = new DataTable();
                string SQL = "SELECT ToolID " +
                    " FROM " + RestrictionTable +
                    " WHERE " + RestrictionColumn + " = " + RV[RestrictionColumn].ToString();
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                if (dt.Rows.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("No tools are available for this " + RestrictionColumn.Replace("ID", ""));
                    return;
                }
                foreach (System.Data.DataRow r in dt.Rows)
                {
                    if (Restriction.Length > 0) Restriction += ", ";
                    Restriction += r[0].ToString();
                }
                System.Collections.Generic.List<DiversityWorkbench.QueryRestrictionItem> Restrictions = new List<DiversityWorkbench.QueryRestrictionItem>();
                DiversityWorkbench.QueryRestrictionItem Q = new DiversityWorkbench.QueryRestrictionItem();
                Q.ColumnName = "ToolID";
                Q.TableName = "Tool";
                Q.Restriction = " IN (" + Restriction + ")";
                Restrictions.Add(Q);
                DiversityCollection.Forms.FormTool f = new Forms.FormTool(null, Restrictions);
                f.ShowDialog();
                if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                {
                    RV.BeginEdit();
                    if (RV["ToolUsage"].Equals(System.DBNull.Value))
                        RV["ToolUsage"] = f.ToolUsageTemplate;
                    else
                    {
                        RV["ToolUsage"] = this.ToolUsageAdd(RV["ToolUsage"].ToString(), f.ToolUsageTemplate);
                    }
                    RV.EndEdit();
                }
                DiversityCollection.Tool.BuildToolTreeFromXmlContent(TreeView, RV["ToolUsage"].ToString());
            }
            catch (Exception ex)
            {
            }
        }

        private string ToolUsageAdd(string OriginalToolUsage, string AddedToolUsage)
        {
            try
            {
                string CombinedToolUsage = "";
                System.Collections.Generic.List<string> Tools = new List<string>();
                string Tool = OriginalToolUsage.Substring(OriginalToolUsage.IndexOf("<Tool "));
                Tool = Tool.Replace("</Tools>", "");
                while (Tool.Length > 0)
                {
                    Tools.Add(Tool.Substring(0, Tool.IndexOf("</Tool>") + 7));
                    Tool = Tool.Substring(Tool.IndexOf("</Tool>") + 7);
                }
                Tool = AddedToolUsage.Substring(OriginalToolUsage.IndexOf("<Tool "));
                Tool = Tool.Replace("</Tools>", "");
                Tools.Add(Tool);
                CombinedToolUsage = OriginalToolUsage.Substring(0, OriginalToolUsage.IndexOf("<Tool "));
                foreach (string s in Tools)
                    CombinedToolUsage += s;
                CombinedToolUsage += "</Tools>";
                return CombinedToolUsage;

            }
            catch (Exception ex)
            {
            }
            return "";
        }

        private string RemoveToolUsage(string OriginalToolUsage, System.Windows.Forms.TreeNode NodeToRemove)
        {
            int ToolIDToRemove = -1;
            DiversityWorkbench.UserControls.XMLNode XN = (DiversityWorkbench.UserControls.XMLNode)NodeToRemove.Tag;
            foreach (DiversityWorkbench.UserControls.XMLAttribute XA in XN.Attributes)
            {
                if (XA.Name == "ToolID")
                {
                    int.TryParse(XA.Value, out ToolIDToRemove);
                    break;
                }
            }

            System.Collections.Generic.List<string> Tools = new List<string>();
            string ReducedToolUsage = "";
            string Tool = OriginalToolUsage.Substring(OriginalToolUsage.IndexOf("<Tool "));
            Tool = Tool.Replace("</Tools>", "");
            while (Tool.Length > 0)
            {
                Tools.Add(Tool.Substring(0, Tool.IndexOf("</Tool>") + 7));
                Tool = Tool.Substring(Tool.IndexOf("</Tool>") + 7);
            }
            int i = 0;
            int ToolID = -1;
            bool ToolFound = false;
            foreach (string s in Tools)
            {
                string IDofTool = s.Substring(s.IndexOf("ToolID=") + 8);
                IDofTool = IDofTool.Substring(0, IDofTool.IndexOf("\""));
                if (int.TryParse(IDofTool, out ToolID))
                {
                    if (ToolID == ToolIDToRemove)
                    {
                        ToolFound = true;
                        break;
                    }
                }
                i++;
            }
            if (ToolFound)
            {
                Tools.RemoveAt(i);
                if (Tools.Count == 0)
                    return "";
                ReducedToolUsage = OriginalToolUsage.Substring(0, OriginalToolUsage.IndexOf("<Tool "));
                foreach (string s in Tools)
                    ReducedToolUsage += s;
                ReducedToolUsage += "</Tools>";
                return ReducedToolUsage;
            }
            return OriginalToolUsage;
        }

        private void ToolUsageSave(System.Data.DataRowView R, System.Windows.Forms.TreeView TreeView, System.Windows.Forms.ToolStripButton ToolStripButton)
        {
            string XML = DiversityCollection.Tool.XmlFromToolTree(TreeView);
            if (XML.IndexOf("?>") > -1)
                XML = XML.Substring(XML.IndexOf("?>") + 2).Trim();
            R.Row.BeginEdit();
            R["ToolUsage"] = XML;
            R.Row.EndEdit();
            ToolStripButton.BackColor = System.Drawing.SystemColors.Control;
            ToolStripButton.Enabled = false;
        }

        private void ToolUsageEdit(System.Windows.Forms.TreeNode TreeNode, System.Windows.Forms.ToolStripButton ToolStripButtonSave)
        {
            try
            {
                if (TreeNode.Tag != null)
                {
                    DiversityWorkbench.UserControls.XMLNode X = (DiversityWorkbench.UserControls.XMLNode)TreeNode.Tag;
                    if (X.Name == "Usage")
                    {
                        string Name = "";
                        string Value = "";
                        foreach (DiversityWorkbench.UserControls.XMLAttribute a in X.Attributes)
                        {
                            if (a.Name == "Name") Name = a.Value;
                            if (a.Name == "Value") Value = a.Value;
                        }
                        string NewValue = "";
                        bool NewValueGiven = false;
                        if (TreeNode.Nodes.Count == 0)
                        {
                            DiversityWorkbench.FormGetString f = new DiversityWorkbench.FormGetString("Edit usage/setting", "Edit the value for " + Name, Value);
                            f.ShowDialog();
                            if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                            {
                                NewValue = f.String;
                                NewValueGiven = true;
                            }
                        }
                        else
                        {
                            System.Collections.Generic.Dictionary<int, string> Values = new Dictionary<int, string>();
                            int iN = 0;
                            foreach (System.Windows.Forms.TreeNode TN in TreeNode.Nodes)
                            {
                                Values.Add(iN, TN.Text);
                                iN++;
                            }
                            DiversityWorkbench.FormGetStringFromList f = new DiversityWorkbench.FormGetStringFromList(Values, "Select value", "Please select a value from the list");
                            f.StartPosition = FormStartPosition.CenterParent;
                            f.ShowDialog();
                            if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                            {
                                NewValue = f.String;
                                NewValueGiven = true;
                            }
                        }
                        if (NewValueGiven && NewValue.Length > 0)
                        {
                            int ii = 0;
                            for (int i = 0; i < X.Attributes.Count; i++)
                            {
                                if (X.Attributes[i].Name == "Value")
                                {
                                    ii = i;
                                    break;
                                }
                            }
                            DiversityWorkbench.UserControls.XMLAttribute a = new DiversityWorkbench.UserControls.XMLAttribute();
                            a.Name = X.Attributes[ii].Name;
                            a.Value = NewValue;
                            X.Attributes.RemoveAt(ii);
                            X.Attributes.Add(a);
                            TreeNode.Text = Name + ": " + a.Value;
                        }
                    }
                }
                ToolStripButtonSave.BackColor = System.Drawing.Color.Red;
                ToolStripButtonSave.Enabled = true;
            }
            catch (System.Exception ex) { }
        }

        private void ToolUsageInfo(System.Windows.Forms.TreeNode TreeNode)
        {
            try
            {
                if (TreeNode != null)
                {
                    if (TreeNode.Tag != null)
                    {
                        DiversityWorkbench.UserControls.XMLNode XN = (DiversityWorkbench.UserControls.XMLNode)TreeNode.Tag;
                        if (XN.Name == "Tool" && XN.Attributes != null)
                        {
                            foreach (DiversityWorkbench.UserControls.XMLAttribute XA in XN.Attributes)
                            {
                                if (XA.Name != null && XA.Name == "ToolID")
                                {
                                    int ToolID;
                                    if (int.TryParse(XA.Value, out ToolID))
                                    {
                                        DiversityCollection.Forms.FormTool f = new Forms.FormTool(ToolID);
                                        f.StartPosition = FormStartPosition.CenterParent;
                                        f.ShowDialog();
                                    }
                                    break;
                                }
                            }
                        }
                    }
                }

            }
            catch (Exception ex)
            {
            }
        }

        #endregion

        #endregion

        #region Methods

        #region Views

        private System.Data.DataView _dvCollectionSpecimenProcessingMethod;
        private System.Data.DataView dvCollectionSpecimenProcessingMethod
        {
            get
            {
                if (this._dvCollectionSpecimenProcessingMethod == null)
                    this._dvCollectionSpecimenProcessingMethod = new DataView(this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodList);
                int SpecimenProcessingID;
                int ProcessingID;
                System.Data.DataRowView RU = (System.Data.DataRowView)this.collectionSpecimenProcessingBindingSource.Current;//.identificationUnitAnalysisBindingSource.Current;
                if (int.TryParse(RU["SpecimenProcessingID"].ToString(), out SpecimenProcessingID) &&
                    int.TryParse(RU["ProcessingID"].ToString(), out ProcessingID))
                {
                    string RowFilter = "ProcessingID = " + ProcessingID.ToString() +
                        " AND SpecimenProcessingID = " + SpecimenProcessingID.ToString();
                    this._dvCollectionSpecimenProcessingMethod.RowFilter = RowFilter;
                    this._dvCollectionSpecimenProcessingMethod.Sort = "DisplayText";
                }
                if (this._dvCollectionSpecimenProcessingMethod.Count > 0)
                    this.comboBoxProcessingID.Enabled = false;
                else
                    this.comboBoxProcessingID.Enabled = true;

                return this._dvCollectionSpecimenProcessingMethod;
            }
        }

        private System.Data.DataView _dvCollectionSpecimenProcessingMethodParameter;
        private System.Data.DataView dvCollectionSpecimenProcessingMethodParameter
        {
            get
            {
                if (this._dvCollectionSpecimenProcessingMethodParameter == null)
                    this._dvCollectionSpecimenProcessingMethodParameter = new DataView(this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameterList);
                int SpecimenProcessingID;
                int ProcessingID;
                int MethodID;
                string MethodMarker = "";
                try
                {
                    if (this.listBoxProcessingMethods.SelectedIndex > -1)
                    {
                        System.Data.DataRowView RM = (System.Data.DataRowView)this.listBoxProcessingMethods.SelectedItem;//.listBoxAnalysisMethod.SelectedItem;// this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodList.Rows[this.listBoxAnalysisMethod.SelectedIndex];
                        if (int.TryParse(RM["SpecimenProcessingID"].ToString(), out SpecimenProcessingID) &&
                            int.TryParse(RM["ProcessingID"].ToString(), out ProcessingID) &&
                            int.TryParse(RM["MethodID"].ToString(), out MethodID))
                        {
                            MethodMarker = RM["MethodMarker"].ToString();
                            string RowFilter = "ProcessingID = " + ProcessingID.ToString() +
                                " AND SpecimenProcessingID = " + SpecimenProcessingID.ToString() +
                                " AND MethodID = " + MethodID.ToString() +
                                " AND MethodMarker = '" + MethodMarker + "'";
                            this._dvCollectionSpecimenProcessingMethodParameter.RowFilter = RowFilter;
                            this._dvCollectionSpecimenProcessingMethodParameter.Sort = "DisplayText";
                        }
                    }
                    else
                        this._dvCollectionSpecimenProcessingMethodParameter.RowFilter = "1 = 0";
                }
                catch (System.Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
                return this._dvCollectionSpecimenProcessingMethodParameter;
            }
        }
        
        #endregion

        private void setProcessingMethodControls(int PartID, int ProcessingID)
        {
            // METHOD
            try
            {
                this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodList.Clear();//.IdentificationUnitAnalysisMethodList.Clear();
                string SQL = "SELECT P.CollectionSpecimenID, P.SpecimenProcessingID, P.MethodID, P.ProcessingID, M.DisplayText, M.MethodMarker " +
                    "FROM CollectionSpecimenProcessingMethod AS P INNER JOIN " +
                    "Method AS M ON P.MethodID = M.MethodID INNER JOIN " +
                    "CollectionSpecimenProcessing AS S ON P.CollectionSpecimenID = S.CollectionSpecimenID AND P.SpecimenProcessingID = S.SpecimenProcessingID " +
                    "WHERE S.SpecimenPartID = " + PartID.ToString() + ") AND (P.ProcessingID = " + ProcessingID.ToString() + ")";
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.SelectCommand.CommandText = SQL;
                ad.Fill(this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodList);
            }
            catch (System.Exception ex) { }

            // METHOD PARAMETER
            try
            {
                this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameterList.Clear();
                string SQL = "SELECT MP.CollectionSpecimenID, MP.SpecimenProcessingID, MP.ProcessingID, MP.MethodID, MP.ParameterID, MP.Value, P.DisplayText, MP.MethodMarker " +
                    "FROM CollectionSpecimenProcessingMethodParameter AS MP INNER JOIN " +
                    "CollectionSpecimenProcessing AS S ON MP.CollectionSpecimenID = S.CollectionSpecimenID AND MP.SpecimenProcessingID = S.SpecimenProcessingID INNER JOIN " +
                    "Parameter AS P ON MP.ParameterID = P.ParameterID AND MP.MethodID = P.MethodID " +
                    "WHERE (S.SpecimenPartID = " + PartID.ToString() + ") AND (MP.ProcessingID = " + ProcessingID.ToString() + ")";
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.SelectCommand.CommandText = SQL;
                ad.Fill(this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameterList);//.IdentificationUnitAnalysisMethodParameterList);
            }
            catch (System.Exception ex) { }

            this.listBoxProcessingMethodParameter.DataSource = this.dvCollectionSpecimenProcessingMethodParameter;//.dvIdentificationUnitAnalysisMethodParameter;
            this.listBoxProcessingMethodParameter.DisplayMember = "DisplayText";
            this.listBoxProcessingMethodParameter.ValueMember = "ParameterID";
        }

        #region Toolstrip

        private void toolStripButtonProcessingMethodAdd_Click(object sender, EventArgs e)
        {
            if (this.collectionSpecimenProcessingBindingSource.Current == null) //.identificationUnitAnalysisBindingSource.Current == null)
            {
                System.Windows.Forms.MessageBox.Show("No processing selected");
                return;
            }
            int SpecimenProcessingID;
            int ProcessingID;
            System.Data.DataRowView RA = (System.Data.DataRowView)this.collectionSpecimenProcessingBindingSource.Current;
            if (!int.TryParse(RA["ProcessingID"].ToString(), out ProcessingID))
                return;
            if (!int.TryParse(RA["SpecimenProcessingID"].ToString(), out SpecimenProcessingID))
                return;

            string SQL = "SELECT A.MethodID, M.DisplayText " +
                " FROM MethodForProcessing A, Method M " +
                " WHERE A.MethodID = M.MethodID AND A.ProcessingID = " + ProcessingID.ToString();
            SQL += " ORDER BY DisplayText";
            System.Data.DataTable dtMethods = new DataTable();
            System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            ad.Fill(dtMethods);
            if (dtMethods.Rows.Count == 0)
            {
                string Message = "No methods available";
                System.Windows.Forms.MessageBox.Show(Message);
                return;
            }

            string MethodMarker = "0";
            System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethod.Select("SpecimenProcessingID = " + SpecimenProcessingID.ToString(), "MethodMarker DESC");
            if (RR.Length > 0)
                MethodMarker = RR[0]["MethodMarker"].ToString();
            int iMethodMarker;
            if (int.TryParse(MethodMarker, out iMethodMarker))
                MethodMarker = (iMethodMarker + 1).ToString();
            System.Data.DataRow[] RRtest = this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethod.Select("SpecimenProcessingID = " + SpecimenProcessingID.ToString() +  " AND MethodMarker = '" + MethodMarker + "'", "");
            int i = RRtest.Length;
            while (i > 0)
            {
                DiversityWorkbench.FormGetString fMarker = new DiversityWorkbench.FormGetString("Method marker", "Please enter a new method marker. The marker " + MethodMarker + " is allready present", "");
                fMarker.ShowDialog();
                if (fMarker.DialogResult == System.Windows.Forms.DialogResult.Cancel)
                    return;
                else if (fMarker.DialogResult == System.Windows.Forms.DialogResult.OK)
                {
                    MethodMarker = fMarker.String;
                    System.Data.DataRow[] RRt = this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethod.Select("SpecimenProcessingID = " + SpecimenProcessingID.ToString() + " AND MethodMarker = '" + MethodMarker + "'", "");
                    i = RRt.Length;
                }
            }

            DiversityWorkbench.FormGetStringFromList f = new DiversityWorkbench.FormGetStringFromList(dtMethods, "DisplayText", "MethodID", "New method", "Please select the new method for the processing");
            f.ShowDialog();
            if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
            {
                try
                {
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenProcessingMethodRow RM = this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethod.NewCollectionSpecimenProcessingMethodRow();//.NewIdentificationUnitAnalysisMethodRow();
                    RM.ProcessingID = ProcessingID;
                    RM.MethodID = int.Parse(f.SelectedValue);
                    RM.CollectionSpecimenID = this.ID;
                    RM.SpecimenProcessingID = SpecimenProcessingID;
                    RM.MethodMarker = MethodMarker;
                    this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethod.Rows.Add(RM);//.IdentificationUnitAnalysisMethod.Rows.Add(RM);
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenProcessingMethodListRow RML = this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodList.NewCollectionSpecimenProcessingMethodListRow();//  .IdentificationUnitAnalysisMethodListRow RML = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodList.NewIdentificationUnitAnalysisMethodListRow();
                    RML.ProcessingID = ProcessingID;
                    RML.MethodID = int.Parse(f.SelectedValue);
                    RML.SpecimenProcessingID = SpecimenProcessingID;
                    RML.CollectionSpecimenID = this.ID;
                    RML.DisplayText = f.SelectedString + " " + MethodMarker;
                    RML.MethodMarker = MethodMarker;
                    this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodList.Rows.Add(RML);
                    System.Data.DataTable dtPV = new DataTable();
                    SQL = "SELECT " + this.ID.ToString() + ", " + SpecimenProcessingID.ToString() + ", " + ProcessingID.ToString() + ", MethodID, ParameterID, DisplayText, DefaultValue " +
                        "FROM Parameter " +
                        "WHERE MethodID = " + RM.MethodID.ToString();
                    System.Data.SqlClient.SqlDataAdapter adPV = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    adPV.Fill(dtPV);
                    foreach (System.Data.DataRow RP in dtPV.Rows)
                    {
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameterRow RPV = this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameter.NewCollectionSpecimenProcessingMethodParameterRow();// .IdentificationUnitAnalysisMethodParameterRow RPV = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.NewIdentificationUnitAnalysisMethodParameterRow();
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameterListRow RPVL = this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameterList.NewCollectionSpecimenProcessingMethodParameterListRow();// .IdentificationUnitAnalysisMethodParameterListRow RPVL = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameterList.NewIdentificationUnitAnalysisMethodParameterListRow();
                        RPV.CollectionSpecimenID = this.ID;
                        RPVL.CollectionSpecimenID = this.ID;
                        RPV.SpecimenProcessingID = SpecimenProcessingID;
                        RPVL.SpecimenProcessingID = SpecimenProcessingID;
                        RPV.ProcessingID = ProcessingID;
                        RPVL.ProcessingID = ProcessingID;
                        RPV.MethodID = int.Parse(f.SelectedValue);
                        RPVL.MethodID = int.Parse(f.SelectedValue);
                        RPV.MethodMarker = MethodMarker;
                        RPVL.MethodMarker = MethodMarker;
                        RPV.ParameterID = int.Parse(RP["ParameterID"].ToString());
                        RPVL.ParameterID = int.Parse(RP["ParameterID"].ToString());
                        RPV.Value = RP["DefaultValue"].ToString();
                        RPVL.Value = RP["DefaultValue"].ToString();
                        RPVL.DisplayText = RP["DisplayText"].ToString();
                        this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameter.Rows.Add(RPV);// .IdentificationUnitAnalysisMethodParameter.Rows.Add(RPV);
                        this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameterList.Rows.Add(RPVL);// .IdentificationUnitAnalysisMethodParameterList.Rows.Add(RPVL);
                    }
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void toolStripButtonProcessingMethodDelete_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxProcessingMethods.SelectedItem;// .listBoxAnalysisMethod.SelectedItem;
                string Restriction = "MethodID = " + R["MethodID"].ToString() +
                    " AND CollectionSpecimenID = " + R["CollectionSpecimenID"].ToString() +
                    " AND SpecimenProcessingID = " + R["SpecimenProcessingID"].ToString() +
                    " AND ProcessingID = " + R["ProcessingID"].ToString() +
                    " AND MethodMarker = '" + R["MethodMarker"].ToString() + "'";
                System.Data.DataRow[] rrP = this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameter.Select(Restriction);// .IdentificationUnitAnalysisMethodParameter.Select(Restriction);
                System.Data.DataRow[] rrPL = this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameterList.Select(Restriction);// .IdentificationUnitAnalysisMethodParameterList.Select(Restriction);
                for (int i = 0; i < rrP.Length; i++)
                    rrP[i].Delete();
                for (int i = 0; i < rrPL.Length; i++)
                    rrPL[i].Delete();
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethod.Select(Restriction);// .IdentificationUnitAnalysisMethod.Select(Restriction);
                System.Data.DataRow[] rrL = this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodList.Select(Restriction);// .IdentificationUnitAnalysisMethodList.Select(Restriction);
                rr[0].Delete();
                rrL[0].Delete();
                this.updateSpecimen();
                this.setSpecimen(this.SpecimenID);
            }
            catch (System.Exception ex) { }
        }
        
        #endregion 
       
        private void listBoxProcessingMethods_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.listBoxProcessingMethodParameter.DataSource = this.dvCollectionSpecimenProcessingMethodParameter;// .listBoxAnalysisMethodParameter.DataSource = this.dvIdentificationUnitAnalysisMethodParameter;
            this.listBoxProcessingMethodParameter_SelectedIndexChanged(null, null);
        }

        private void listBoxProcessingMethodParameter_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (this.listBoxProcessingMethodParameter.SelectedItem == null)// .listBoxAnalysisMethodParameter.SelectedItem == null)
            {
                this.comboBoxProcessingMethodParameterValue.Visible = false;// .comboBoxAnalysisMethodParameterValue.Visible = false;
                this.textBoxProcessingMethodParameterValue.Visible = false;// .textBoxAnalysisMethodParameterValue.Visible = false;
                return;
            }
            try
            {
                System.Data.DataRowView RV = (System.Data.DataRowView)this.listBoxProcessingMethodParameter.SelectedItem;// .listBoxAnalysisMethodParameter.SelectedItem;
                for (int i = 0; i < this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameter.Rows.Count; i++)// .IdentificationUnitAnalysisMethodParameter.Rows.Count; i++)
                {
                    if (this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameter.Rows[i]["ParameterID"].ToString() == RV["ParameterID"].ToString() &&
                        this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameter.Rows[i]["MethodID"].ToString() == RV["MethodID"].ToString() &&
                        this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameter.Rows[i]["SpecimenProcessingID"].ToString() == RV["SpecimenProcessingID"].ToString() &&
                        this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameter.Rows[i]["ProcessingID"].ToString() == RV["ProcessingID"].ToString() &&
                        this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameter.Rows[i]["MethodMarker"].ToString() == RV["MethodMarker"].ToString())
                    {
                        this.collectionSpecimenProcessingMethodParameterBindingSource.Position = i;// .identificationUnitAnalysisMethodParameterBindingSource.Position = i;
                        break;
                    }
                }

                if (this.collectionSpecimenProcessingMethodParameterBindingSource.Current != null && DiversityWorkbench.Settings.ConnectionString.Length > 0)// .identificationUnitAnalysisMethodParameterBindingSource.Current != null)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenProcessingMethodParameterBindingSource.Current;// .identificationUnitAnalysisMethodParameterBindingSource.Current;
                    string SQL = "SELECT Value, DisplayText " +
                        "FROM ParameterValue_Enum " +
                        "WHERE (MethodID = " + R["MethodID"].ToString() + ") AND (ParameterID = " + R["ParameterID"].ToString() + ") ORDER BY DisplayText";
                    System.Data.DataTable dt = new DataTable();
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(dt);
                    if (dt.Rows.Count > 0)
                    {
                        this.textBoxProcessingMethodParameterValue.Visible = false;
                        this.textBoxProcessingMethodParameterValue.Dock = DockStyle.None;
                        this.comboBoxProcessingMethodParameterValue.Visible = true;
                        this.comboBoxProcessingMethodParameterValue.Dock = DockStyle.Fill;
                        this.comboBoxProcessingMethodParameterValue.DataSource = dt;
                        this.comboBoxProcessingMethodParameterValue.DisplayMember = "DisplayText";
                        this.comboBoxProcessingMethodParameterValue.ValueMember = "Value";
                        for (int i = 0; i < dt.Rows.Count; i++)
                        {
                            if (R["Value"].ToString() == dt.Rows[i]["Value"].ToString())
                            {
                                this.comboBoxProcessingMethodParameterValue.SelectedIndex = i;
                                break;
                            }
                        }
                    }
                    else
                    {
                        this.comboBoxProcessingMethodParameterValue.Visible = false;
                        this.comboBoxProcessingMethodParameterValue.Dock = DockStyle.None;
                        this.textBoxProcessingMethodParameterValue.Visible = true;
                        this.textBoxProcessingMethodParameterValue.Dock = DockStyle.Fill;

                    }
                }
                else
                {
                    this.textBoxProcessingMethodParameterValue.Visible = false;
                    this.comboBoxProcessingMethodParameterValue.Visible = false;
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        private void buttonProcessingMethodParameterAddMissing_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.listBoxProcessingMethods.SelectedItem != null)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxProcessingMethods.SelectedItem;//System.Data.DataRow R = this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethod.Rows[this.collectionSpecimenProcessingMethodBindingSource.Position];
                    //System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenProcessingMethodBindingSource.Current;
                    string SQL = "SELECT MethodID, ParameterID, DisplayText, DefaultValue " +
                        "FROM Parameter AS P " +
                        "WHERE (MethodID = " + R["MethodID"].ToString() + ") AND (ParameterID NOT IN " +
                        "(SELECT ParameterID " +
                        "FROM CollectionSpecimenProcessingMethodParameter AS U " +
                        "WHERE (SpecimenProcessingID = " + R["SpecimenProcessingID"].ToString() + ") " +
                        "AND (ProcessingID = " + R["ProcessingID"].ToString() + ") " +
                        "AND (MethodID = " + R["MethodID"].ToString() + ") " +
                        "AND (MethodMarker = '" + R["MethodMarker"].ToString() + "')))";
                    System.Data.DataTable dt = new DataTable();
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(dt);
                    if (dt.Rows.Count > 0)
                    {
                        System.Collections.Generic.Dictionary<string, bool> Dict = new Dictionary<string, bool>();
                        foreach (System.Data.DataRow RP in dt.Rows)
                            Dict.Add(RP["DisplayText"].ToString(), false);
                        DiversityWorkbench.Forms.FormGetMultiFromList f = new DiversityWorkbench.Forms.FormGetMultiFromList("Missing parameter", "Please select the parameters that should be added", Dict);
                        f.ShowDialog();
                        if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                        {
                            int SpecimenProcessingID = int.Parse(R["SpecimenProcessingID"].ToString());
                            int ProcessingID = int.Parse(R["ProcessingID"].ToString());
                            int MethodID = int.Parse(R["MethodID"].ToString());
                            string MethodMarker = R["MethodMarker"].ToString();
                            foreach (System.Collections.Generic.KeyValuePair<string, bool> KV in f.Items)
                            {
                                if (KV.Value)
                                {
                                    System.Data.DataRow[] rr = dt.Select("DisplayText = '" + KV.Key + "'");
                                    if (rr.Length > 0)
                                    {
                                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameterRow RPV = this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameter.NewCollectionSpecimenProcessingMethodParameterRow();// .IdentificationUnitAnalysisMethodParameterRow RPV = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.NewIdentificationUnitAnalysisMethodParameterRow();
                                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameterListRow RPVL = this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameterList.NewCollectionSpecimenProcessingMethodParameterListRow();// .IdentificationUnitAnalysisMethodParameterListRow RPVL = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameterList.NewIdentificationUnitAnalysisMethodParameterListRow();
                                        RPV.CollectionSpecimenID = this.ID;
                                        RPVL.CollectionSpecimenID = this.ID;
                                        RPV.SpecimenProcessingID = SpecimenProcessingID;
                                        RPVL.SpecimenProcessingID = SpecimenProcessingID;
                                        RPV.ProcessingID = ProcessingID;
                                        RPVL.ProcessingID = ProcessingID;
                                        RPV.MethodID = MethodID;
                                        RPVL.MethodID = MethodID;
                                        RPV.MethodMarker = MethodMarker;
                                        RPVL.MethodMarker = MethodMarker;
                                        RPV.ParameterID = int.Parse(rr[0]["ParameterID"].ToString());
                                        RPVL.ParameterID = int.Parse(rr[0]["ParameterID"].ToString());
                                        RPV.Value = rr[0]["DefaultValue"].ToString();
                                        RPVL.Value = rr[0]["DefaultValue"].ToString();
                                        RPVL.DisplayText = rr[0]["DisplayText"].ToString();
                                        this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameter.Rows.Add(RPV);
                                        this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethodParameterList.Rows.Add(RPVL);
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        System.Windows.Forms.MessageBox.Show("No parameters missing");
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonProcessingMethodParameterRemove_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.listBoxProcessingMethodParameter.SelectedItem != null)
                {
                    System.Data.DataRowView Rlist = (System.Data.DataRowView)this.listBoxProcessingMethodParameter.SelectedItem;
                    string Message = "Do you want to remove parameter\r\n" + Rlist["DisplayText"].ToString();
                    if (System.Windows.Forms.MessageBox.Show(Message, "Remove parameter?", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == System.Windows.Forms.DialogResult.Yes)
                    {
                        int i = this.listBoxProcessingMethods.SelectedIndex;
                        System.Data.DataRowView R = (System.Data.DataRowView)this.collectionSpecimenProcessingMethodParameterBindingSource.Current;
                        R.Delete();
                        this.saveSpecimen(null, null);
                        this.listBoxProcessingMethods.SelectedIndex = i;
                    }
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        #endregion

        #region Transaction

        private void buttonOpenTransaction_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                int ID = int.Parse(R["TransactionID"].ToString());
                DiversityCollection.FormTransaction f = new FormTransaction(ID);
                f.ShowDialog();
                if (f.ChangeToSpecimen && f.CollectionSpecimenID != this.ID)
                {
                    this.setSpecimen(f.CollectionSpecimenID);
                    return;
                }
                if (f.DialogResult == DialogResult.OK)
                {
                    DiversityCollection.LookupTable.ResetTransaction();
                    R["TransactionID"] = f.ID;
                    this.setSpecimen(this.ID);
                    this.setTransactionTitle();
                }
                DiversityCollection.LookupTable.ResetTransaction();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }
        
        private void toolStripButtonOverviewHierarchyNewTransaction_Click(object sender, EventArgs e)
        {
            try
            {
                if (!this.ShowTransaction) this.toolStripButtonOverviewHierarchyDisplayShowTransactions_Click(null, null);
                System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                DiversityCollection.FormTransaction f = new FormTransaction(true);
                f.ShowDialog();
                if (f.DialogResult == DialogResult.OK)
                {
                    DiversityCollection.LookupTable.ResetTransaction();
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenTransactionRow TR = 
                        (DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenTransactionRow)this.dataSetCollectionSpecimen.CollectionSpecimenTransaction.NewRow();
                    TR.TransactionID = f.ID;
                    string TransactionType = DiversityCollection.LookupTable.TransactionType(f.ID);
                    if (TransactionType == "loan" || TransactionType == "forwarding")
                        TR.IsOnLoan = true;
                    else if (TransactionType == "return")
                    {
                        if (f.ParentID == null)
                        {
                            System.Windows.Forms.MessageBox.Show("A return needs a superior transaction");
                            return;
                        }
                        string ParentTransactionID = f.ParentID.ToString();
                        System.Data.DataRow[] RRloan = this.dataSetCollectionSpecimen.CollectionSpecimenTransaction.Select("TransactionID = " + ParentTransactionID);
                        if (RRloan.Length == 0)
                        {
                            System.Windows.Forms.MessageBox.Show("No fitting loan could be found for this return");
                            return;
                        }
                        System.Data.DataRow Rloan = RRloan[0];
                        Rloan.BeginEdit();
                        Rloan["TransactionReturnID"] = f.ID;
                        Rloan.EndEdit();
                    }
                    else if (TransactionType == "regulation")
                    {
                        TR.TransactionTitle = f.TransactionTitle;
                    }
                    TR.CollectionSpecimenID = int.Parse(R["CollectionSpecimenID"].ToString());
                    TR.SpecimenPartID = int.Parse(R["SpecimenPartID"].ToString());
                    this.dataSetCollectionSpecimen.CollectionSpecimenTransaction.Rows.Add(TR);
                    this.refreshHierarchyPartUnitNodes(this.treeViewOverviewHierarchyStorage.SelectedNode, TR.Table.TableName);
                    this.treeViewOverviewHierarchyStorage.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchyStorage, null, TR);
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setTransactionTitle()
        {
            System.Data.DataRowView RV = (System.Data.DataRowView)this.collectionSpecimenTransactionBindingSource.Current;
            int TransactionID = 0;
            int.TryParse(RV["TransactionID"].ToString(), out TransactionID);
            this.textBoxTransaction.Text = DiversityCollection.LookupTable.TransactionTitle(TransactionID);
            this.textBoxTransaction.ForeColor = System.Drawing.Color.Brown;
        }
        
        private void toolStripButtonOverviewHierarchyNewPermit_Click(object sender, EventArgs e)
        {
            try
            {
                DiversityCollection.Forms.FormGetPermit f = new Forms.FormGetPermit();
                f.ShowDialog();
                if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                {
                    if (f.SelectedTransactionID() != null)
                    {
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenTransactionRow TR =
                            (DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenTransactionRow)this.dataSetCollectionSpecimen.CollectionSpecimenTransaction.NewRow();
                        TR.TransactionID = (int)f.SelectedTransactionID();
                        System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        TR.CollectionSpecimenID = int.Parse(R["CollectionSpecimenID"].ToString());
                        TR.SpecimenPartID = int.Parse(R["SpecimenPartID"].ToString());
                        this.dataSetCollectionSpecimen.CollectionSpecimenTransaction.Rows.Add(TR);
                        this.refreshHierarchyPartUnitNodes(this.treeViewOverviewHierarchyStorage.SelectedNode, TR.Table.TableName);
                        this.treeViewOverviewHierarchyStorage.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchyStorage, null, TR);
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #region Collection

        private void buttonOpenFormCollection_Click(object sender, EventArgs e)
        {
            int CollectionID;
            System.Data.DataRowView R = (System.Data.DataRowView)this.collectionBindingSource.Current;
            if (int.TryParse(R["CollectionID"].ToString(), out CollectionID))
            {
                DiversityCollection.FormCollection f = new FormCollection(CollectionID);
                f.ShowDialog();
            }
        }

        private void toolStripButtonOverviewHierarchyNewCollection_Click(object sender, EventArgs e)
        {

        }

        private void buttonEditDefaultCollection_Click(object sender, EventArgs e)
        {
            DiversityCollection.FormCollection f;
            if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection == -1)
            {
                f = new FormCollection(null);
            }
            else
            {
                f = new FormCollection(DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection);
            }
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                DefaultCollection = f.ID;
            }
        }

        private int DefaultCollection
        {
            get
            {
                if (this._DefaultCollection == null)
                {
                    if (DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection != -1)
                    {
                        this._DefaultCollection = DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection;
                        return (int)this._DefaultCollection;
                    }
                    if (this._DefaultCollection == null)
                        return -1;
                    else
                        return (int)this._DefaultCollection;
                }
                else
                {
                    return (int)this._DefaultCollection;
                }
            }

            set
            {
                this._DefaultCollection = value;
                this.textBoxDefaultCollection.Text = DiversityCollection.LookupTable.CollectionNameHierarchy((int)this._DefaultCollection);
                string Owner = DiversityCollection.LookupTable.CollectionOwner((int)this._DefaultCollection);
                string ToolTip = this.textBoxDefaultCollection.Text;
                if (Owner.Length > 0) ToolTip = Owner + ": " + ToolTip;
                this.toolTip.SetToolTip(this.textBoxDefaultCollection, ToolTip);
                if ((int)this._DefaultCollection != DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection)
                {
                    DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.DefaultCollection = (int)this._DefaultCollection;
                    DiversityCollection.Forms.FormCollectionSpecimenSettings.Default.Save();
                }
            }
        }

        #endregion

        #region Common toolStrip Events

        private void toolStripButtonOverviewHierarchyDeletePart_Click(object sender, EventArgs e)
        {
            System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
            string Table = R.Table.TableName;
            switch (Table)
            {
                case "Collection":
                case "CollectionSpecimen":
                case "IdentificationUnitInPart":
                   System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.You_can_not_delete_this_entry_here);// "You can not delete this entry here");
                    break;
                case "IdentificationUnitAnalysis":
                    if (this.treeViewOverviewHierarchyStorage.SelectedNode.Tag != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        System.Data.DataRow[] rrMethod = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethod.Select("AnalysisID = " + r["AnalysisID"].ToString() 
                            + " AND IdentificationUnitID = " + r["IdentificationUnitID"].ToString()
                            + " AND AnalysisNumber = '" + r["AnalysisNumber"].ToString() + "'", "");
                        if (rrMethod.Length > 0)
                        {
                            System.Data.DataRow[] rrParameter = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.Select("AnalysisID = " + r["AnalysisID"].ToString()
                            + " AND IdentificationUnitID = " + r["IdentificationUnitID"].ToString()
                            + " AND AnalysisNumber = '" + r["AnalysisNumber"].ToString() + "'", "");
                            if (System.Windows.Forms.MessageBox.Show("There are method data within this analysis. These will be deleted as well", "Delete methods", MessageBoxButtons.OKCancel) == System.Windows.Forms.DialogResult.OK)
                            {
                                for (int i = 0; i < rrParameter.Length; i++)
                                    rrParameter[i].Delete();
                                for (int i = 0; i < rrMethod.Length; i++)
                                    rrMethod[i].Delete();
                            }
                            else
                                return;
                        }
                        r.Delete();
                        this.buildOverviewHierarchyParts();
                        this.buildOverviewHierarchyUnits();
                    }
                    break;
                case "CollectionSpecimenPart":
                    if (this.treeViewOverviewHierarchyStorage.SelectedNode.Tag != null)
                    {
                        foreach (System.Windows.Forms.TreeNode N in this.treeViewOverviewHierarchyStorage.SelectedNode.Nodes)
                        {
                            try
                            {
                                System.Data.DataRow Rchild = (System.Data.DataRow)N.Tag;
                                if (Rchild.Table.TableName == "CollectionSpecimenPart")
                                {
                                    System.Windows.Forms.MessageBox.Show( DiversityCollection.Forms.FormCollectionSpecimenText.Please_delete_all_depending_entries);//"Please delete all depending parts before deleting this specimen part");
                                    return;
                                }
                            }
                            catch { return; }
                        }
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        int PartID = 0;
                        if (int.TryParse(r["SpecimenPartID"].ToString(), out PartID))
                        {
                            System.Collections.Generic.List<DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow> ListToDelete = new List<Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow>();
                            foreach (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow RUIP
                                in this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows)
                            {
                                if (RUIP.RowState != DataRowState.Deleted && RUIP.SpecimenPartID == PartID)
                                    ListToDelete.Add(RUIP);
                                    //RUIP.Delete();
                            }
                            foreach (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow RR in ListToDelete)
                                RR.Delete();
                            r.Delete();
                            this.buildOverviewHierarchyParts();
                        }
                        //this.refreshHierarchyUnitUnitNodes(this.treeViewOverviewHierarchy.SelectedNode.Parent);
                    }
                    break;
                case "ExternalIdentifier":
                    R.BeginEdit();
                    R.Delete();
                    R.EndEdit();
                    this.buildOverviewHierarchyParts();
                    break;
                case "CollectionSpecimenProcessing":
                    System.Data.DataRow[] rrProcMethod = this.dataSetCollectionSpecimen.CollectionSpecimenProcessingMethod.Select("SpecimenProcessingID = " + R["SpecimenProcessingID"].ToString());
                    if (rrProcMethod.Length > 0)
                    {
                        if (System.Windows.Forms.MessageBox.Show("The processing contains " + rrProcMethod.Length.ToString() + " method(s). Are you sure you want to delete it?", "Delete processing?", MessageBoxButtons.YesNo) == System.Windows.Forms.DialogResult.No)
                            return;
                    }
                    goto default;
                    break;
                default:
                    if (this.treeViewOverviewHierarchyStorage.SelectedNode.Tag != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        r.Delete();
                        this.buildOverviewHierarchyParts();
                        //this.refreshHierarchyUnitUnitNodes(this.treeViewOverviewHierarchy.SelectedNode.Parent);
                    }
                    break;
            }
        }

        private void toolStripButtonOverviewHierarchyDelete_Click(object sender, EventArgs e)
        {
            System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
            string Table = R.Table.TableName;
            switch (Table)
            {
                case "CollectionEvent":
//#if DEBUG
                    string ErrorMessage = "";
                    if (this.DeleteCollectionEvent(EventID, ref ErrorMessage, this.ID))
                    {
                        this.setSpecimen(this.ID);
                    }
                    else
                        System.Windows.Forms.MessageBox.Show(ErrorMessage);

                    // Check if several collection specimen are related to the selected event
                    //if (this.NumberOfSpecimenInEvent() > 1)
                    //{
                    //    string Message = "The collection event contains more than 1 specimen.\r\n"
                    //        + DiversityCollection.Forms.FormCollectionSpecimenText.You_can_not_delete_this_entry_here
                    //        + "\r\nDo you want to remove the specimen from the collection event instead";
                    //    if (System.Windows.Forms.MessageBox.Show(Message, "No deleting", MessageBoxButtons.YesNo, MessageBoxIcon.Information) == System.Windows.Forms.DialogResult.Yes)
                    //    {
                    //        string SqlEvent = "UPDATE S SET CollectionEventID = NULL FROM CollectionSpecimen S WHERE S.CollectionSpecimenID = " + this.ID.ToString();
                    //        if (DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SqlEvent))
                    //            this.setSpecimen(this.ID);
                    //    }
                    //}
                    //else
                    //{
                    //    // remove the depending data
                    //    string ErrorMessage = "";
                    //    if (this.DeleteCollectionEvent(EventID, ref ErrorMessage))
                    //    {
                    //        this.setSpecimen(this.ID);
                    //    }
                    //    else
                    //        System.Windows.Forms.MessageBox.Show(ErrorMessage);
                    //}
//#else
//                    System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.You_can_not_delete_this_entry_here);//"You can not delete this entry here");
//#endif
                    break;
                case "CollectionEventList":
                    bool ok = true;
                    if (this.treeViewOverviewHierarchy.SelectedNode == null) ok = false;
                    if (this.treeViewOverviewHierarchy.SelectedNode.Nodes.Count > 0) ok = false;
                    if (!ok)
                    {
                        System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.Please_delete_all_depending_entries);//"Please select an item that contains no childs");
                        return;
                    }
                    System.Data.DataRow rEL = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;

                    int CollEventID = 0;
                    if (int.TryParse(rEL["CollectionEventID"].ToString(), out CollEventID))
                    {
                        string Message = "";
                        if (this.DeleteCollectionEvent(CollEventID, ref Message))
                        {
                            this.setSpecimen(this.ID);
                        }
                        else
                            System.Windows.Forms.MessageBox.Show(Message);
                    }

                    //try
                    //{
                    //    string Sql = "SELECT COUNT(*) FROM CollectionEventLocalisation WHERE CollectionEventID = " + rEL["CollectionEventID"].ToString();
                    //    System.Data.SqlClient.SqlConnection SqlConnection = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                    //    System.Data.SqlClient.SqlCommand SqlCommand = new System.Data.SqlClient.SqlCommand(Sql, SqlConnection);
                    //    SqlConnection.Open();
                    //    int i = 0;
                    //    if (int.TryParse(SqlCommand.ExecuteScalar().ToString(), out i))
                    //    {
                    //        if (i > 0)
                    //        {
                    //            string Message = DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("CollectionEventLocalisation"));
                    //            Message += ": " + i.ToString() + DiversityCollection.Forms.FormCollectionSpecimenText.Depending_data;
                    //            string Header = DiversityCollection.Forms.FormCollectionSpecimenText.Delete + " ?";
                    //            //if (System.Windows.Forms.MessageBox.Show("This event contains " + i.ToString() + " depending datasets in the table CollectionEventLocalisation\r\nDo you really want to delete this collection event", "Delete collection event", MessageBoxButtons.OKCancel) == DialogResult.OK)
                    //            if (System.Windows.Forms.MessageBox.Show(Message, Header, MessageBoxButtons.OKCancel) == DialogResult.OK)
                    //            {
                    //                SqlCommand.CommandText = "DELETE FROM CollectionEventLocalisation WHERE CollectionEventID = " + rEL["CollectionEventID"].ToString();
                    //                SqlCommand.ExecuteNonQuery();
                    //            }
                    //            else
                    //                return;
                    //        }
                    //    }
                    //    Sql = "SELECT COUNT(*) FROM CollectionEventProperty WHERE CollectionEventID = " + rEL["CollectionEventID"].ToString(); ;
                    //    if (int.TryParse(SqlCommand.ExecuteScalar().ToString(), out i))
                    //    {
                    //        if (i > 0)
                    //        {
                    //            string Message = DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("CollectionEventProperty"));
                    //            Message += ": " + i.ToString() + DiversityCollection.Forms.FormCollectionSpecimenText.Depending_data;
                    //            string Header = DiversityCollection.Forms.FormCollectionSpecimenText.Delete + " ?";
                    //            //if (System.Windows.Forms.MessageBox.Show("This event contains " + i.ToString() + " depending datasets in the table CollectionEventProperty\r\nDo you really want to delete this collection event", "Delete collection event", MessageBoxButtons.OKCancel) == DialogResult.OK)
                    //            if (System.Windows.Forms.MessageBox.Show(Message, Header, MessageBoxButtons.OKCancel) == DialogResult.OK)
                    //            {
                    //                SqlCommand.CommandText = "DELETE FROM CollectionEventProperty WHERE CollectionEventID = " + rEL["CollectionEventID"].ToString();
                    //                SqlCommand.ExecuteNonQuery();
                    //            }
                    //            else
                    //                return;
                    //        }
                    //    }
                    //    SqlCommand.CommandText = "DELETE FROM CollectionEvent WHERE CollectionEventID = " + rEL["CollectionEventID"].ToString(); ;
                    //    SqlCommand.ExecuteNonQuery();
                    //    SqlConnection.Close();
                    //    this.setSpecimen(this.ID);
                    //}
                    //catch
                    //{
                    //    System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.Please_delete_all_depending_entries);//"Please select an collection event that contains no depending datasets");
                    //}
                    break;
                case "CollectionSpecimen":
                    System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.You_can_not_delete_this_entry_here);//"You can not delete this entry here");
                    break;
                case "CollectionEventSeries":
                    bool OK = true;
                    if (this.treeViewOverviewHierarchy.SelectedNode == null) OK = false;
                    if (this.treeViewOverviewHierarchy.SelectedNode.Nodes.Count > 0) OK = false;
                    if (!OK)
                    {
                        System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.Please_delete_all_depending_entries);//"Please select an item that contains no childs");
                        return;
                    }
                    string SQL = "";
                    System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                    System.Data.SqlClient.SqlCommand cmd = new System.Data.SqlClient.SqlCommand(SQL, con);
                    //int EventSeriesID = 0;
                    System.Data.DataRow rE = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                    try
                    {
                        switch (Table)
                        {
                            case "CollectionEventSeries":
                                string Header = DiversityCollection.Forms.FormCollectionSpecimenText.Delete + "?";
                                string Message = rE["Description"].ToString();
                                Message += "\r\n-\r\n " + Header;
                                //if (System.Windows.Forms.MessageBox.Show("Do you want to delete the collection event group or EventSeries\r\n" + rE["Description"].ToString(), "Delete EventSeries / collection event group", MessageBoxButtons.YesNo) != DialogResult.Yes)
                                if (System.Windows.Forms.MessageBox.Show(Message, Header, MessageBoxButtons.YesNo) != DialogResult.Yes)
                                    return;
                                SQL = "DELETE FROM " + Table + " WHERE SeriesID = " + rE["SeriesID"].ToString();
                                break;
                            case "CollectionEvent":
                                Header = DiversityCollection.Forms.FormCollectionSpecimenText.Delete + "?";
                                Message = this.treeViewOverviewHierarchy.SelectedNode.Text;
                                Message += "\r\n-\r\n " + Header;
                                //if (System.Windows.Forms.MessageBox.Show("Do you want to delete the collection event\r\n" + this.treeViewOverviewHierarchy.SelectedNode.Text, "Delete collection event", MessageBoxButtons.YesNo) != DialogResult.Yes)
                                if (System.Windows.Forms.MessageBox.Show(Message, Header, MessageBoxButtons.YesNo) != DialogResult.Yes)
                                    return;
                                SQL = "DELETE FROM " + Table + " WHERE CollectionEventID = " + rE["CollectionEventID"].ToString();
                                break;
                        }
                        con.Open();
                        cmd.CommandText = SQL;
                        cmd.ExecuteNonQuery();
                        con.Close();
                        this.setSpecimen(this.ID);
                    }
                    catch
                    {
                        System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.Please_delete_all_depending_entries);//"Please select an EventSeries / collection event group that contains no events");
                    }
                break;
                case "CollectionEventLocalisation":
                    try
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        int LocID;
                        if (int.TryParse(r["LocalisationSystemID"].ToString(), out LocID))
                        {
                            System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.Select("LocalisationSystemID = " + LocID.ToString());
                            if (RR.Length == 1)
                            {
                                RR[0].Delete();
                                this.dataSetCollectionSpecimen.CollectionEventLocalisationGeo.AcceptChanges();
                            }
                        }
                        r.BeginEdit();
                        r.Delete();
                        r.EndEdit();
                        this.treeViewOverviewHierarchy.SelectedNode.Remove();
                    }
                    catch { }
                    this.setToolStripDropDownButtonsEventLocalisationVisibilty();
                    break;
                case "CollectionEventProperty":
                    try
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        r.BeginEdit();
                        r.Delete();
                        r.EndEdit();
                        this.treeViewOverviewHierarchy.SelectedNode.Remove();
                    }
                    catch { }
                    this.setToolStripDropDownButtonsEventPropertyVisibilty();
                    break;
                case "IdentificationUnit":
                    if (this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        int UnitID = System.Int32.Parse(r["IdentificationUnitID"].ToString());
                        int SubstrateID = System.Int32.Parse(r["IdentificationUnitID"].ToString());
                        System.Data.DataRow[] UU = this.dataSetCollectionSpecimen.IdentificationUnit.Select("IdentificationUnitID = " + UnitID.ToString());
                        System.Data.DataRow U = UU[0];

                        //TODO: unklar - hier werden abhaengige Datensaetze nicht geloescht
                        System.Data.DataRow[] AA = this.dataSetCollectionSpecimen.IdentificationUnitAnalysis.Select("IdentificationUnitID = " + UnitID.ToString());
                        if (AA.Length > 0)
                        {
                            System.Collections.Generic.List<System.Data.DataRow> rr = new List<DataRow>();
                            foreach (System.Data.DataRow A in AA)
                                rr.Add(A);
                            foreach (System.Data.DataRow d in rr)
                                d.Delete();
                        }
                        System.Data.DataRow[] AM = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethod.Select("IdentificationUnitID = " + UnitID.ToString());
                        if (AM.Length > 0)
                        {
                            System.Collections.Generic.List<System.Data.DataRow> rr = new List<DataRow>();
                            foreach (System.Data.DataRow A in AM)
                                rr.Add(A);
                            foreach (System.Data.DataRow d in rr)
                                d.Delete();
                        }
                        System.Data.DataRow[] AP = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.Select("IdentificationUnitID = " + UnitID.ToString());
                        if (AP.Length > 0)
                        {
                            System.Collections.Generic.List<System.Data.DataRow> rr = new List<DataRow>();
                            foreach (System.Data.DataRow A in AP)
                                rr.Add(A);
                            foreach (System.Data.DataRow d in rr)
                                d.Delete();
                        }


                        System.Data.DataRow[] CC = this.dataSetCollectionSpecimen.IdentificationUnit.Select("RelatedUnitID = " + UnitID.ToString());
                        foreach (System.Data.DataRow C in CC)
                        {
                            C["RelatedUnitID"] = U["RelatedUnitID"];
                        }
                        U.Delete();
                        System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.IdentificationUnitInPart.Select("IdentificationUnitID = " + UnitID.ToString());
                        if (RR.Length > 0)
                        {
                            for (int i = 0; i < RR.Length; i++)
                                RR[i].Delete();
                            this.buildOverviewHierarchyParts();
                        }
                        this.buildOverviewHierarchyUnits();
                    }
                    break;
                case "Identification":
                    if (this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        r.Delete();
                        this.refreshHierarchyUnitUnitNodes(this.treeViewOverviewHierarchy.SelectedNode.Parent);
                    }
                    break;
                case "CollectionSpecimenReference":
                    if (this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        r.Delete();
                        this.buildOverviewHierarchyUnits();
                    }
                    break;
                case "CollectionSpecimenRelation":
                    if (this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        r.Delete();
                        this.buildOverviewHierarchyUnits();
                    }
                    break;
                case "CollectionAgent":
                    if (this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        r.Delete();
                        this.buildOverviewHierarchyUnits();
                    }
                    break;
                case "IdentificationUnitGeoAnalysis":
                    if (this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        r.Delete();
                        this.buildOverviewHierarchyUnits();
                    }
                    break;
                case "CollectionEventRegulation":
                    // obsolet
                    if (this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        r.Delete();
                        this.buildOverviewHierarchyUnits();
                    }
                    break;
                default:
                    if (this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        System.Data.DataRow[] rrMethod = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethod.Select("AnalysisID = " + r["AnalysisID"].ToString()
                            + " AND IdentificationUnitID = " + r["IdentificationUnitID"].ToString()
                            + " AND AnalysisNumber = '" + r["AnalysisNumber"].ToString() + "'", "");
                        if (rrMethod.Length > 0)
                        {
                            System.Data.DataRow[] rrParameter = this.dataSetCollectionSpecimen.IdentificationUnitAnalysisMethodParameter.Select("AnalysisID = " + r["AnalysisID"].ToString()
                            + " AND IdentificationUnitID = " + r["IdentificationUnitID"].ToString()
                            + " AND AnalysisNumber = '" + r["AnalysisNumber"].ToString() + "'", "");
                            if (System.Windows.Forms.MessageBox.Show("There are method data within this analysis. These will be deleted as well", "Delete methods", MessageBoxButtons.OKCancel) == System.Windows.Forms.DialogResult.OK)
                            {
                                for (int i = 0; i < rrParameter.Length; i++)
                                    rrParameter[i].Delete();
                                for (int i = 0; i < rrMethod.Length; i++)
                                    rrMethod[i].Delete();
                            }
                            else
                                return;
                        }
                        r.Delete();
                        this.buildOverviewHierarchyUnits();
                    }
                    break;
            }
            if (Table == "CollectionAgent")
            {
                if (this.dataSetCollectionSpecimen.CollectionAgent.Rows.Count > 0)
                    this.buttonCollectorIsResponsible.Enabled = true;
                else this.buttonCollectorIsResponsible.Enabled = false;
            }
        }

        /// <summary>
        /// Remove collection event including data related to the corresponding ID
        /// </summary>
        /// <param name="EventID">The CollectionEventID of the dataset</param>
        /// <param name="Message">In case of an error, the message containing the reason for the failure</param>
        /// <param name="CurrentSpecimen">If the current specimen is involved</param>
        /// <returns>If the removal was successful. False: Error during removal or User may stop removal</returns>
        private bool DeleteCollectionEvent(int EventID, ref string Message, int? CollectionSpecimenID = null)
        {
            bool OK = true;
            try
            {
                // Check count
                if (this.NumberOfSpecimenInEvent() > 1) // several specimen - so only a link from the specimen will be removed
                {
                    if (CollectionSpecimenID != null)
                    {
                        Message = "The collection event contains more than 1 specimen.\r\n"
                            + DiversityCollection.Forms.FormCollectionSpecimenText.You_can_not_delete_this_entry_here
                            + "\r\n\r\nDo you want to remove the specimen from the collection event instead?";
                        if (System.Windows.Forms.MessageBox.Show(Message, "No deleting", MessageBoxButtons.YesNo, MessageBoxIcon.Information) == System.Windows.Forms.DialogResult.Yes)
                        {
                            string SqlEvent = "UPDATE S SET CollectionEventID = NULL FROM CollectionSpecimen S " +
                                "WHERE S.CollectionEventID = " + EventID.ToString() +
                                "AND S.CollectionSpecimenID = " + CollectionSpecimenID.ToString();
                            Message = "";
                            OK = DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SqlEvent, ref Message);
                        }
                    }
                    else
                        System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.You_can_not_delete_this_entry_here, "No deleting", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
                else
                {
                    // Only 1 specimen conneted to event - so removal is possible
                    Message = "Do you realy want to delete the selected collection event?\r\n";
                    string Header = DiversityCollection.Forms.FormCollectionSpecimenText.Delete + " ?";

                    // Checking all dependent tables
                    System.Collections.Generic.List<string> L = new List<string>();
                    L.Add("CollectionEventLocalisation");
                    L.Add("CollectionEventProperty");
                    L.Add("CollectionEventImage");
                    L.Add("CollectionEventParameterValue");
                    L.Add("CollectionEventMethod");
                    L.Add("CollectionEventRegulation");
                    string DependetData = "";
                    foreach (string S in L)
                    {
                        this.CollectionEventDependingTableCount(EventID, S, ref DependetData);
                    }
                    if (DependetData.Length > 0)
                        Message += "\r\n" + DiversityCollection.Forms.FormCollectionSpecimenText.Depending_data + ":\r\n" + DependetData;

                    // Removing the data
                    if (System.Windows.Forms.MessageBox.Show(Message, Header, MessageBoxButtons.OKCancel) == DialogResult.OK)
                    {
                        Message = "";
                        // Remove depending data
                        foreach (string S in L)
                        {
                            if (!this.CollectionEventDependingDataRemove(EventID, S, ref Message))
                                OK = false;
                        }
                        if (Message.Length == 0 && OK)
                        {
                            // Remove link from Collection Specimen
                            string SqlEvent = "UPDATE S SET CollectionEventID = NULL FROM CollectionSpecimen S WHERE S.CollectionEventID = " + EventID.ToString();
                            if (CollectionSpecimenID != null)
                                SqlEvent += " AND S.CollectionSpecimenID = " + CollectionSpecimenID.ToString();
                            OK = (DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(SqlEvent, ref Message));
                            if (OK)
                            {
                                OK = this.CollectionEventDependingDataRemove(EventID, "CollectionEvent", ref Message);
                            }
                            else
                            {
                                Message = "Error during removal:\r\n" + Message;
                            }
                        }
                    }
                    else
                        return false;
                }
            }
            catch (Exception ex)
            {
                OK = false;
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                Message = ex.Message;
            }
            return OK;
        }

        /// <summary>
        /// Counting data related to a collection event
        /// </summary>
        /// <param name="EventID">The CollectionEventID of the dataset that should be counted</param>
        /// <param name="Table">The name of the Table containing the data</param>
        /// <param name="Message">If the table contains data linked to the ID, the name of the table and the count of depending data</param>
        private void CollectionEventDependingTableCount(int EventID, string Table, ref string Message)
        {
            string Sql = "SELECT COUNT(*) FROM " + Table + " WHERE CollectionEventID = " + EventID.ToString(); ;
            string Result = DiversityWorkbench.FormFunctions.SqlExecuteScalar(Sql);
            int i = 0;
            if (int.TryParse(Result, out i))
            {
                if (i > 0)
                {
                    Message += "\r\n" + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation(Table));
                    Message += ": \t" + i.ToString();
                }
            }
        }

        /// <summary>
        /// Removing the data related to a collection event
        /// </summary>
        /// <param name="EventID">The CollectionEventID of the dataset that should be removed</param>
        /// <param name="Table">The name of the Table containing the data</param>
        /// <param name="Message">In case of an error, the message containing the reason for the failure</param>
        /// <returns>If removal was successful</returns>
        private bool CollectionEventDependingDataRemove(int EventID, string Table, ref string Message)
        {
            string Sql = "DELETE FROM " + Table + " WHERE CollectionEventID = " + EventID.ToString();
            return DiversityWorkbench.FormFunctions.SqlExecuteNonQuery(Sql, ref Message);
        }

        private void toolStripButtonOverviewHierarchyFind_Click(object sender, EventArgs e)
        {
            System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
            string Table = R.Table.TableName;
            int? SpecimenID = null;
            switch (Table)
            {
                case "IdentificationUnitList":
                case "CollectionSpecimenList":
                    if (this.treeViewOverviewHierarchy.SelectedNode != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        try
                        {
                            SpecimenID = int.Parse(r["CollectionSpecimenID"].ToString());
                        }
                        catch (Exception)
                        {
                            string Message = DiversityCollection.Forms.FormCollectionSpecimenText.Please_select;
                            Message += ": " + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("CollectionSpecimen"));
                            System.Windows.Forms.MessageBox.Show(Message);
                        }
                    }
                    break;
                case "CollectionSpecimenRelation":
                    if (this.treeViewOverviewHierarchy.SelectedNode != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        try
                        {
                            string URI = r["RelatedSpecimenURI"].ToString();
                            SpecimenID = int.Parse(URI.Substring(DiversityCollection.LookupTable.BaseURL.Length));
                        }
                        catch (Exception)
                        {
                            string Message = DiversityCollection.Forms.FormCollectionSpecimenText.Please_select;
                            Message += ": " + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("CollectionSpecimen"));
                            System.Windows.Forms.MessageBox.Show(Message);
                        }
                    }
                    break;
                case "CollectionSpecimenRelationInvers":
                    if (this.treeViewOverviewHierarchy.SelectedNode != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                        try
                        {
                            SpecimenID = int.Parse(r["CollectionSpecimenID"].ToString());
                            //int SpecimenID = int.Parse(r["CollectionSpecimenID"].ToString());
                            //this.setSpecimen(SpecimenID);
                        }
                        catch (Exception)
                        {
                            string Message = DiversityCollection.Forms.FormCollectionSpecimenText.Please_select;
                            Message += ": " + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("CollectionSpecimen"));
                            System.Windows.Forms.MessageBox.Show(Message);
                        }
                    }
                    break;
            }
            if (SpecimenID == null) return;
            try
            {
                if (Table == "CollectionSpecimenRelationInvers")
                {
                    System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                    System.Data.SqlClient.SqlCommand C = new System.Data.SqlClient.SqlCommand("SELECT COUNT(*) FROM CollectionSpecimenID_UserAvailable WHERE CollectionSpecimenID = " + SpecimenID.ToString(), con);
                    con.Open();
                    int i;
                    if (!int.TryParse(C.ExecuteScalar().ToString(), out i) || i == 0)
                    {
                        System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.You_have_no_access_to_this_dataset);//"You have no access to this dataset");
                        return;
                    }
                    con.Close();
                }
                this.setSpecimen((int)SpecimenID);
            }
            catch (Exception)
            {
                string Message = DiversityCollection.Forms.FormCollectionSpecimenText.Please_select;
                Message += ": " + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("CollectionSpecimen"));
                System.Windows.Forms.MessageBox.Show(Message);
            }
        }

        private void toolStripButtonOverviewHierarchyPartFind_Click(object sender, EventArgs e)
        {
            if (this.treeViewOverviewHierarchyStorage.SelectedNode == null)
                return;
            System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
            string Table = R.Table.TableName;
            int? SpecimenID = null;
            switch (Table)
            {
                case "IdentificationUnitList":
                case "CollectionSpecimenList":
                    if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        try
                        {
                            SpecimenID = int.Parse(r["CollectionSpecimenID"].ToString());
                        }
                        catch (Exception)
                        {
                            string Message = DiversityCollection.Forms.FormCollectionSpecimenText.Please_select;
                            Message += ": " + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("CollectionSpecimen"));
                            System.Windows.Forms.MessageBox.Show(Message);
                        }
                    }
                    break;
                case "CollectionSpecimenRelation":
                    if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        try
                        {
                            string URI = r["RelatedSpecimenURI"].ToString();
                            SpecimenID = int.Parse(URI.Substring(DiversityCollection.LookupTable.BaseURL.Length));
                        }
                        catch (Exception)
                        {
                            string Message = DiversityCollection.Forms.FormCollectionSpecimenText.Please_select;
                            Message += ": " + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("CollectionSpecimen"));
                            System.Windows.Forms.MessageBox.Show(Message);
                        }
                    }
                    break;
                case "CollectionSpecimenRelationInvers":
                    if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                    {
                        System.Data.DataRow r = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        try
                        {
                            SpecimenID = int.Parse(r["CollectionSpecimenID"].ToString());
                            //int SpecimenID = int.Parse(r["CollectionSpecimenID"].ToString());
                            //this.setSpecimen(SpecimenID);
                        }
                        catch (Exception)
                        {
                            string Message = DiversityCollection.Forms.FormCollectionSpecimenText.Please_select;
                            Message += ": " + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("CollectionSpecimen"));
                            System.Windows.Forms.MessageBox.Show(Message);
                        }
                    }
                    break;
            }
            if (SpecimenID == null) return;
            try
            {
                if (Table == "CollectionSpecimenRelationInvers")
                {
                    System.Data.SqlClient.SqlConnection con = new System.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                    System.Data.SqlClient.SqlCommand C = new System.Data.SqlClient.SqlCommand("SELECT COUNT(*) FROM CollectionSpecimenID_UserAvailable WHERE CollectionSpecimenID = " + SpecimenID.ToString(), con);
                    con.Open();
                    int i;
                    if (!int.TryParse(C.ExecuteScalar().ToString(), out i) || i == 0)
                    {
                        System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.You_have_no_access_to_this_dataset);//"You have no access to this dataset");
                        return;
                    }
                    con.Close();
                }
                this.setSpecimen((int)SpecimenID);
            }
            catch (Exception)
            {
                string Message = DiversityCollection.Forms.FormCollectionSpecimenText.Please_select;
                Message += ": " + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("CollectionSpecimen"));
                System.Windows.Forms.MessageBox.Show(Message);
            }
        }

        #region External identifier

        private void toolStripButtonOverviewHierarchyNewID_Click(object sender, EventArgs e)
        {
            this.AddIDUnit(this.treeViewOverviewHierarchy.SelectedNode, DiversityWorkbench.ReferencingTable.IdentifierType.ID);
        }

        private void toolStripButtonOverviewHierarchyPartNewID_Click(object sender, EventArgs e)
        {
            this.AddIDPart(DiversityWorkbench.ReferencingTable.IdentifierType.ID);
        }

        private void AddIDUnit(System.Windows.Forms.TreeNode Node, DiversityWorkbench.ReferencingTable.IdentifierType TypeOfIdentifier)
        {
            try
            {
                System.Data.DataRow ReferencedRow = (System.Data.DataRow)Node.Tag;
                string ReferencedTable = ReferencedRow.Table.TableName;
                string ReferencedRowDisplayText = Node.Text;
                System.Drawing.Image Image = Node.TreeView.ImageList.Images[Node.ImageIndex];
                int ReferencedID = 0;
                if (ReferencedTable == "CollectionSpecimenPart")
                {
                    if (treeViewOverviewHierarchyStorage.SelectedNode == null && this.dataSetCollectionSpecimen.ExternalIdentifier.Rows.Count == 0)
                    {
                        System.Windows.Forms.MessageBox.Show("Please select the entry for which you want to add an identifier");
                        return;
                    }
                    if (!int.TryParse(ReferencedRow["SpecimenPartID"].ToString(), out ReferencedID)) return;
                }
                else if (ReferencedTable == "CollectionSpecimenReference")
                {
                    if (!int.TryParse(ReferencedRow["ReferenceID"].ToString(), out ReferencedID)) return;
                }
                else
                {
                    if (treeViewOverviewHierarchy.SelectedNode == null && this.dataSetCollectionSpecimen.ExternalIdentifier.Rows.Count == 0)
                    {
                        System.Windows.Forms.MessageBox.Show("Please select the entry for which you want to add an identifier");
                        return;
                    }
                    if (this.treeViewOverviewHierarchy.SelectedNode != null &&
                        this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
                    {
                        switch (ReferencedTable)
                        {
                            case "CollectionEvent":
                                if (!int.TryParse(ReferencedRow["CollectionEventID"].ToString(), out ReferencedID)) return;
                                break;
                            case "CollectionSpecimen":
                                if (!int.TryParse(ReferencedRow["CollectionSpecimenID"].ToString(), out ReferencedID)) return;
                                break;
                            case "IdentificationUnit":
                                if (!int.TryParse(ReferencedRow["IdentificationUnitID"].ToString(), out ReferencedID)) return;
                                break;
                            case "CollectionSpecimenReference":
                                if (!int.TryParse(ReferencedRow["ReferenceID"].ToString(), out ReferencedID)) return;
                                break;
                            default:
                                return;
                                break;
                        }
                    }
                }

                DiversityCollection.Forms.FormExternalIdentifier f = new Forms.FormExternalIdentifier(TypeOfIdentifier);
                f.ShowDialog();
                if (f.IdentifierType() != null && f.IdentifierType().Length > 0 && f.Identifier().Length > 0)
                {
                    System.Data.DataRow R = this.dataSetCollectionSpecimen.ExternalIdentifier.NewRow();
                    R["Type"] = f.IdentifierType();
                    R["Identifier"] = f.Identifier();
                    R["URL"] = f.URL();
                    R["Notes"] = f.Notes();
                    R["ReferencedID"] = ReferencedID;
                    R["ReferencedTable"] = ReferencedTable;
                    this.dataSetCollectionSpecimen.ExternalIdentifier.Rows.Add(R);
                }
                else
                {
                    System.Windows.Forms.MessageBox.Show("Type of the identifier or identifier is missing");
                }
                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "ExternalIdentifier", this.sqlDataAdapterIdentifier, this.BindingContext);
                this.buildOverviewHierarchy();
            }
            catch (System.Exception ex) { }
        }

        private void AddIDPart(DiversityWorkbench.ReferencingTable.IdentifierType TypeOfIdentifier)
        {
            try
            {
                if (this.treeViewOverviewHierarchyStorage.SelectedNode.Tag != null)
                {
                    this.AddIDUnit(this.treeViewOverviewHierarchyStorage.SelectedNode, TypeOfIdentifier);

                    this.toolStripButtonOverviewHierarchyPartNewID.Visible = false;
                    //this.toolStripButtonOverviewHierarchyPartNewRegulation.Visible = false;
                    if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                    {
                        System.Data.DataRow ReferencedRow = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        this.setToolStripOverviewHierarchyPartExternalIdentifierVisibility(ReferencedRow);
                    }

                    this.buildOverviewHierarchyParts();
                }
                else
                    System.Windows.Forms.MessageBox.Show("Please select the entry for which you want to add an external identifier");
            }
            catch (Exception ex) { }
        }
        
        #endregion

        #region Annotation

        private void toolStripButtonpOverviewHierarchyAnnotationEdit_Click(object sender, EventArgs e)
        {
            this.AddAnnotationUnit();
        }

        private void toolStripButtonpOverviewHierarchyAnnotationAdd_Click(object sender, EventArgs e)
        {
            this.AddAnnotationUnit();
        }

        private void AddAnnotationUnit()
        {
            try
            {
                if (this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
                {
                    this.AddAnnotation(this.treeViewOverviewHierarchy.SelectedNode);


                    System.Data.DataRow ReferencedRow = (System.Data.DataRow)this.treeViewOverviewHierarchy.SelectedNode.Tag;
                    this.setToolStripOverviewHierarchyAnnotationVisibility(ReferencedRow);

                    this.toolStripButtonpOverviewHierarchyAnnotationEdit.Visible = false;
                    this.toolStripButtonpOverviewHierarchyAnnotationAdd.Visible = false;

                    this.buildOverviewHierarchyUnits();
                    //this.addOverviewHierarchyAnnotations(AnnotationTarget.Units);
                }
                else
                    System.Windows.Forms.MessageBox.Show("Please select the entry for which you want to add an annotation");
            }
            catch (Exception ex) { }
        }

        private void toolStripButtonOverviewHierarchyPartAnnotationEdit_Click(object sender, EventArgs e)
        {
            this.AddAnnotationPart();
        }

        private void toolStripButtonOverviewHierarchyPartAnnotationAdd_Click(object sender, EventArgs e)
        {
            this.AddAnnotationPart();
        }

        private void AddAnnotationPart()
        {
            try
            {
                if (this.treeViewOverviewHierarchyStorage.SelectedNode.Tag != null)
                {
                    this.AddAnnotation(this.treeViewOverviewHierarchyStorage.SelectedNode);

                    this.toolStripButtonOverviewHierarchyPartAnnotationEdit.Visible = false;
                    this.toolStripButtonOverviewHierarchyPartAnnotationAdd.Visible = false;

                    System.Data.DataRow ReferencedRow = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                    this.setToolStripOverviewHierarchyPartAnnotationVisibility(ReferencedRow);

                    this.buildOverviewHierarchyParts();
                    //this.addOverviewHierarchyAnnotations(AnnotationTarget.Parts);
                }
                else
                    System.Windows.Forms.MessageBox.Show("Please select the entry for which you want to add an annotation");
            }
            catch (Exception ex) { }
        }

        private void AddAnnotation(System.Windows.Forms.TreeNode Node)
        {
            try
            {
                System.Data.DataRow ReferencedRow = (System.Data.DataRow)Node.Tag;
                string ReferencedTable = ReferencedRow.Table.TableName;
                string ReferencedRowDisplayText = Node.Text;
                System.Drawing.Image Image = Node.TreeView.ImageList.Images[Node.ImageIndex];
                int ReferencedID = 0;
                if (ReferencedTable == "CollectionSpecimenPart")
                {
                    if (treeViewOverviewHierarchyStorage.SelectedNode == null && this.dataSetCollectionSpecimen.Annotation.Rows.Count == 0)
                    {
                        System.Windows.Forms.MessageBox.Show("Please select the entry for which you want to add an annotation");
                        return;
                    }
                    if (!int.TryParse(ReferencedRow["SpecimenPartID"].ToString(), out ReferencedID)) return;
                }
                else
                {
                    if (treeViewOverviewHierarchy.SelectedNode == null && this.dataSetCollectionSpecimen.Annotation.Rows.Count == 0)
                    {
                        System.Windows.Forms.MessageBox.Show("Please select the entry for which you want to add an annotation");
                        return;
                    }
                    if (this.treeViewOverviewHierarchy.SelectedNode != null &&
                        this.treeViewOverviewHierarchy.SelectedNode.Tag != null)
                    {
                        switch (ReferencedTable)
                        {
                            //case "CollectionEventSeries":
                            //    if (!int.TryParse(ReferencedRow["SeriesID"].ToString(), out ReferencedID)) return;
                            //    break;
                            case "CollectionEvent":
                                if (!int.TryParse(ReferencedRow["CollectionEventID"].ToString(), out ReferencedID)) return;
                                break;
                            case "CollectionSpecimen":
                                if (!int.TryParse(ReferencedRow["CollectionSpecimenID"].ToString(), out ReferencedID)) return;
                                break;
                            case "IdentificationUnit":
                                if (!int.TryParse(ReferencedRow["IdentificationUnitID"].ToString(), out ReferencedID)) return;
                                break;
                            default:
                                return;
                                break;
                        }
                    }
                }

                System.Data.DataTable dtAnnotationType = new DataTable();
                string SQL = "SELECT Code FROM AnnotationType_Enum WHERE Code IN ('Annotation', 'Problem', 'Reference') ";
                System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dtAnnotationType);
                DiversityWorkbench.Forms.FormAnnotation f = new DiversityWorkbench.Forms.FormAnnotation(
                    this
                    , ReferencedTable
                    , ReferencedID
                    , ReferencedRow
                    , dtAnnotationType
                    , this.helpProviderDiversityCollection.HelpNamespace
                    , ReferencedRowDisplayText
                    , Image);
                f.ShowDialog();

                this.FormFunctions.updateTable(this.dataSetCollectionSpecimen, "Annotation", this.sqlDataAdapterAnnotation, this.BindingContext);

            }
            catch (System.Exception ex) { }
        }
        
        #endregion

        #region Regulation

        private void toolStripButtonOverviewHierarchyPartNewRegulation_Click(object sender, EventArgs e)
        {
            bool OKins = DiversityWorkbench.FormFunctions.Permissions("CollectionSpecimenTransaction", "Insert");
            if (OKins)
            {
                DiversityWorkbench.FormGetString freg = new DiversityWorkbench.FormGetString("New regulation", "Please enter the regulation identifier as provided by the administation", "");
                freg.ShowDialog();
                if (freg.DialogResult == System.Windows.Forms.DialogResult.OK && freg.String.Length > 0)
                {
                    // Test if the given string is allowed
                    string SQL = "SELECT TOP 1 TransactionID FROM [Transaction] T WHERE T.TransactionTitle = '" + freg.String + "' ";// AND T.TransactionType = 'provision'";
                    int TransactionID;
                    if (int.TryParse(DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL), out TransactionID))
                    {
                        System.Data.DataRowView Rpart = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenTransactionRow TR
                            = (DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenTransactionRow)this.dataSetCollectionSpecimen.CollectionSpecimenTransaction.NewRow();
                        TR.TransactionID = TransactionID;
                        TR.TransactionTitle = freg.String;
                        TR.CollectionSpecimenID = this.ID;
                        TR.SpecimenPartID = int.Parse(Rpart["SpecimenPartID"].ToString());
                        this.dataSetCollectionSpecimen.CollectionSpecimenTransaction.Rows.Add(TR);
                    }
                    else
                    {
                        System.Windows.Forms.MessageBox.Show("This regulation can not be found in the regulations for the collection event");
                        return;
                    }
                }
            }


            return;

            bool OK = DiversityWorkbench.FormFunctions.Permissions("CollectionSpecimenPartRegulation", "Update");
            string Regulation = "";
            if (OK)
            {
                if (this.dataSetCollectionSpecimen.CollectionEventRegulation.Rows.Count > 0)
                {
                    System.Collections.Generic.List<string> L = new List<string>();
                    foreach (System.Data.DataRow R in this.dataSetCollectionSpecimen.CollectionEventRegulation.Rows)
                        L.Add(R["Regulation"].ToString());
                    DiversityWorkbench.FormGetStringFromList f = new DiversityWorkbench.FormGetStringFromList(L, "Regulation", "Please select the regulation", true);
                    f.ShowDialog();
                    if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                    {
                        Regulation = f.SelectedString;
                    }
                }
                else
                {
                    DiversityCollection.Forms.FormRegulation f = new Forms.FormRegulation(null, true);
                    f.ShowDialog();
                    if (f.Regulation() != null && f.Regulation().Length > 0)
                    {
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenPartRegulationRow R
                            = (DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenPartRegulationRow)this.dataSetCollectionSpecimen.CollectionSpecimenPartRegulation.NewRow();
                        R.CollectionSpecimenID = int.Parse(this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionSpecimenID"].ToString());
                        System.Data.DataRowView RPart = (System.Data.DataRowView)this.collectionSpecimenPartBindingSource.Current;
                        R.SpecimenPartID = int.Parse(RPart["SpecimenPartID"].ToString());
                        R.Regulation = f.Regulation();
                        this.dataSetCollectionSpecimen.CollectionSpecimenPartRegulation.Rows.Add(R);
                        this.buildOverviewHierarchyParts();
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(null, "CollectionSpecimenPartRegulation", this.treeViewOverviewHierarchyStorage, ref Nodes);
                        if (Nodes.Count > 0)
                            this.treeViewOverviewHierarchyStorage.SelectedNode = Nodes[Nodes.Count - 1];
                    }
                }
            }
            else
            {
                DiversityWorkbench.FormGetString f = new DiversityWorkbench.FormGetString("New regulation", "Please enter the regulation identifier as provided by the administation", "");
                f.ShowDialog();
                if (f.DialogResult == System.Windows.Forms.DialogResult.OK && f.String.Length > 0)
                {
                    // Test if the given string is allowed
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.CollectionEventRegulation.Select("Regulation = '" + f.String + "'", "");
                    if (rr.Length == 0)
                    {
                        System.Windows.Forms.MessageBox.Show("This regulation can not be found in the regulations for the collection event");
                        return;
                    }
                    Regulation = f.String;
                }
            }
            if (Regulation.Length > 0)
            {
                System.Data.DataRow RPart = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenPartRegulationRow Rnew
                    = (DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionSpecimenPartRegulationRow)this.dataSetCollectionSpecimen.CollectionSpecimenPartRegulation.NewRow();
                Rnew.CollectionSpecimenID = int.Parse(this.dataSetCollectionSpecimen.CollectionSpecimen.Rows[0]["CollectionSpecimenID"].ToString());
                Rnew.SpecimenPartID = int.Parse(RPart["SpecimenPartID"].ToString());
                Rnew.Regulation = Regulation;
                try
                {
                    this.dataSetCollectionSpecimen.CollectionSpecimenPartRegulation.Rows.Add(Rnew);
                    this.buildOverviewHierarchyParts();
                    System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                    this.getOverviewHierarchyNodes(null, "CollectionSpecimenPartRegulation", this.treeViewOverviewHierarchyStorage, ref Nodes);
                    if (Nodes.Count > 0)
                        this.treeViewOverviewHierarchyStorage.SelectedNode = Nodes[Nodes.Count - 1];
                    this.treeViewOverviewHierarchyStorage.SelectedNode = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchyStorage, null, Rnew);
                }
                catch (System.Exception ex)
                {
                    System.Windows.Forms.MessageBox.Show(ex.Message);
                }
            }
        }
        
        #endregion

        #endregion        

        #region Auxillary

        private int MinHeightOfControl(System.Windows.Forms.Control Control)
        {
            int Height = 0;
            Height += Control.Height;
            if (Control.GetType() == typeof(System.Windows.Forms.GroupBox)
                || Control.GetType() == typeof(System.Windows.Forms.Panel)
                || Control.GetType() == typeof(System.Windows.Forms.TabControl)
                || Control.GetType() == typeof(System.Windows.Forms.TabPage)
                || Control.GetType() == typeof(System.Windows.Forms.TableLayoutPanel)
                || Control.GetType() == typeof(System.Windows.Forms.SplitterPanel)
                || Control.GetType() == typeof(System.Windows.Forms.SplitContainer))
            {
                foreach (System.Windows.Forms.Control C in Control.Controls)
                {
                    Height += this.MinHeightOfControl(C);
                }
            }
            return Height;
        }

        private void updateHierarchyNodeByUserControlModuleRelatedEntry(object sender, EventArgs e)
        {
            try
            {
                System.Windows.Forms.TextBox T = (System.Windows.Forms.TextBox)sender;
                if (T.DataBindings.Count == 0) return;
                System.Windows.Forms.Binding B = T.DataBindings[0];
                if (B.DataSource == null) return;
                System.Windows.Forms.BindingSource BS = (System.Windows.Forms.BindingSource)B.DataSource;
                if (BS.Current == null) return;
                System.Data.DataRowView RV = (System.Data.DataRowView)BS.Current;
                System.Data.DataRow R = RV.Row;
                System.Windows.Forms.TreeNode N = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchy, null, R);
                if (N == null) return;
                DiversityCollection.HierarchyNode H = (DiversityCollection.HierarchyNode)N;
                if (H == null) return;
                H.setText();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #endregion

        #region Printing and DisplayOrder

        #region Toolstrips

        #region Preview

        private void setMultiPrintRestrictionText()
        {
            try
            {
                System.Data.DataRow R = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                if (R.RowState != DataRowState.Deleted && R.RowState != DataRowState.Detached)
                {
                    if (R["CollectionID"].Equals(System.DBNull.Value))
                    {
                        this.checkBoxPrintRestrictToCollection.Checked = false;
                        this.checkBoxPrintRestrictToCollection.Visible = false;
                    }
                    else
                    {
                        string Collection = DiversityCollection.LookupTable.CollectionName(int.Parse(R["CollectionID"].ToString()));
                        this.checkBoxPrintRestrictToCollection.Text = this.Message("Restrict_to_collection") + ":  " + Collection;
                    }
                    if (R["MaterialCategory"].Equals(System.DBNull.Value))
                    {
                        this.checkBoxPrintRestrictToMaterial.Checked = false;
                        this.checkBoxPrintRestrictToMaterial.Visible = false;
                        this.pictureBoxPrintRestrictToMaterial.Visible = false;
                        this.tableLayoutPanelLabel.Height = 50;
                    }
                    else
                    {
                        this.checkBoxPrintRestrictToMaterial.Text = this.Message("Restrict_to_material") + ":  " + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.Abbreviation, DiversityWorkbench.Entity.EntityInformation("CollMaterialCategory_Enum.Code." + R["MaterialCategory"].ToString()));
                        this.pictureBoxPrintRestrictToMaterial.Image = DiversityCollection.Specimen.MaterialCategoryImage(false, R["MaterialCategory"].ToString());
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonLabelPrintBrowserOptinos_Click(object sender, EventArgs e)
        {
        }

        private void toolStripButtonPageSetup_Click(object sender, EventArgs e)
        {
            this.webBrowserLabel.ShowPageSetupDialog();
            this.webBrowserLabel.Refresh();
        }

        private void toolStripButtonPrint_Click(object sender, EventArgs e)
        {
            this.webBrowserLabel.ShowPrintPreviewDialog();
        }

        private void toolStripButtonNewSchemaFile_Click(object sender, EventArgs e)
        {

        }

        private void toolStripButtonLabelExport_Click(object sender, EventArgs e)
        {
            this.saveFileDialog.RestoreDirectory = true;
            this.saveFileDialog.Filter = "html files (*.htm)|*.htm";
            this.saveFileDialog.AddExtension = true;
            this.saveFileDialog.DefaultExt = "htm";
            this.saveFileDialog.FileName = "Label.htm";
            if (this.saveFileDialog.ShowDialog() == DialogResult.OK)
            {
                string Text = this.webBrowserLabel.DocumentText;
                System.IO.StreamWriter w = new System.IO.StreamWriter(this.saveFileDialog.FileName, false, System.Text.Encoding.UTF8);
                w.Write(Text);
                w.Close();
            }
        }

        private void toolStripTextBoxPrintDuplicates_TextChanged(object sender, EventArgs e)
        {
            int D;
            if (int.TryParse(this.toolStripTextBoxPrintDuplicates.Text, out D))
            {
                if (D > 99 || D < 1)
                {
                    System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.Values_are_restricted_to + ": 1 - 99");//"Only values from 1 - 99 are allowed here");
                    this.toolStripTextBoxPrintDuplicates.Text = "1";
                }
            }
            else
            {
                System.Windows.Forms.MessageBox.Show(DiversityCollection.Forms.FormCollectionSpecimenText.Values_are_restricted_to + ": 1 - 99");//"Only values from 1 - 99 are allowed here");
                this.toolStripTextBoxPrintDuplicates.Text = "1";
            }
        }

        private void toolStripButtonOpenSchemaFile_Click(object sender, EventArgs e)
        {
            string Path = System.Windows.Forms.Application.StartupPath + "\\LabelPrinting\\Schemas";
            if (!System.IO.File.Exists(Path))
            {
                System.IO.Directory.CreateDirectory(Path);
                //Path = Path + "\\Label.xslt";
            }
            //if (!System.IO.File.Exists(Path))
            //{
            //    DiversityCollection.XmlExport.writeDefaultXslt(Path);
            //}
            if (this.textBoxSchemaFile.Text.Length > 0)
            {
                try
                {
                    System.IO.FileInfo FI = new System.IO.FileInfo(this.textBoxSchemaFile.Text);
                    if (FI.Exists)
                        Path = FI.DirectoryName;
                }
                catch { }
            }
            this.openFileDialogLabelSchema = new OpenFileDialog();
            this.openFileDialogLabelSchema.RestoreDirectory = true;
            this.openFileDialogLabelSchema.Multiselect = false;
            this.openFileDialogLabelSchema.InitialDirectory = Path;
            this.openFileDialogLabelSchema.Filter = "XSLT Files|*.xslt";
            try
            {
                this.openFileDialogLabelSchema.ShowDialog();
                if (this.openFileDialogLabelSchema.FileName.Length > 0)
                {
                    this.textBoxSchemaFile.Tag = this.openFileDialogLabelSchema.FileName;
                    System.IO.FileInfo f = new System.IO.FileInfo(this.openFileDialogLabelSchema.FileName);
                    this.textBoxSchemaFile.Text = f.FullName;
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonLabelPreview_Click(object sender, EventArgs e)
        {
            string File = this.createXmlFromDataset(this.dataSetCollectionSpecimen, this.dataSetCollectionEventSeries, false);
            if (File.Length > 0)
            {
                try
                {
                    System.Uri URI = new Uri(File);
                    this.webBrowserLabel.Url = URI;
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void toolStripButtonLabelMulti_Click(object sender, EventArgs e)
        {
            if (this.userControlQueryList.listBoxQueryResult.Items.Count > 50)
            {
                if (System.Windows.Forms.MessageBox.Show("Do you really want to generate the labels for\r\n\t\t"
                    + this.userControlQueryList.listBoxQueryResult.Items.Count.ToString()
                    + "\r\n\tspecimen selected in the list", "Label print", MessageBoxButtons.YesNo) == DialogResult.No)
                    return;
            }
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            DiversityCollection.CollectionSpecimen Specimen = new CollectionSpecimen(this.ServerConnection);
            DiversityCollection.Datasets.DataSetCollectionSpecimen dsSpecimen = new DiversityCollection.Datasets.DataSetCollectionSpecimen();
            DiversityCollection.Datasets.DataSetCollectionEventSeries dsEventSeries = new DiversityCollection.Datasets.DataSetCollectionEventSeries();
            try
            {
                for (int i = 0; i < this.userControlQueryList.listBoxQueryResult.Items.Count; i++)
                {
                    System.Data.DataRowView rv = (System.Data.DataRowView)this.userControlQueryList.listBoxQueryResult.Items[i];
                    int SpecimenID = int.Parse(rv["ID"].ToString());
                    Specimen.fillSpecimen(SpecimenID, ref dsSpecimen, ref dsEventSeries);
                }
                string File = this.createXmlFromDataset(dsSpecimen, dsEventSeries, true);
                if (File.Length > 0)
                {
                    System.Uri URI = new Uri(File);
                    this.webBrowserLabel.Url = URI;
                }

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
        }

        private void comboBoxLabelConversion_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (this.comboBoxLabelConversion.SelectedIndex > -1)
            {
                this.toolTip.SetToolTip(this.comboBoxLabelConversion, DiversityCollection.Transaction.ConversionDescription(this.comboBoxLabelConversion.Text));
            }
        }

        #endregion

        #region Part

        private void fillPartDisplayLists(System.Windows.Forms.TreeNode Node)
        {
            if (Node == null) return;
            this.dataSetCollectionSpecimen.IdentificationUnitInPartDisplayList.Clear();
            this.dataSetCollectionSpecimen.IdentificationUnitInPartHideList.Clear();
            this.dataSetCollectionSpecimen.IdentificationUnitNotInPartList.Clear();
            System.Collections.Generic.List<System.Data.DataRow> RowsInPart = new List<DataRow>();
            try
            {
                // filling the table IdentificationUnitNotInPartList with all units that are part of the specimen
                foreach(DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitRow RN 
                    in this.dataSetCollectionSpecimen.IdentificationUnit.Rows)
                {
                    if (RN.CollectionSpecimenID != this.SpecimenID) 
                        continue;
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitNotInPartListRow Rnew 
                        = this.dataSetCollectionSpecimen.IdentificationUnitNotInPartList.NewIdentificationUnitNotInPartListRow();
                    Rnew.CollectionSpecimenID = RN.CollectionSpecimenID;
                    Rnew.IdentificationUnitID = RN.IdentificationUnitID;
                    if (!RN.DisplayOrder.Equals(System.DBNull.Value))
                        Rnew.DisplayOrder = RN.DisplayOrder;
                    try
                    {
                        Rnew.DisplayText = DiversityCollection.HierarchyNode.DisplayText(RN);
                        //if (RN.LastIdentificationCache.Equals(System.DBNull.Value))
                        //    Rnew.DisplayText = RN.TaxonomicGroup;
                        //else
                        //    Rnew.DisplayText = RN.LastIdentificationCache;
                    }
                    catch
                    {
                        Rnew.DisplayText = RN.TaxonomicGroup;
                    }
                    this.dataSetCollectionSpecimen.IdentificationUnitNotInPartList.Rows.Add(Rnew);
                }
                System.Data.DataRow DataRow = (System.Data.DataRow)Node.Tag;
                int SpecimenPartID = 0;
                // transfer the units to the other tables
                if (DataRow.RowState != DataRowState.Deleted && DataRow.RowState != DataRowState.Detached && int.TryParse(DataRow["SpecimenPartID"].ToString(), out SpecimenPartID))
                {
                    foreach (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitNotInPartListRow RU 
                        in this.dataSetCollectionSpecimen.IdentificationUnitNotInPartList.Rows)
                    {
                        foreach (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow RUIP 
                            in this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows)
                        {
                            if (RUIP.RowState != DataRowState.Deleted && RU.RowState != DataRowState.Deleted)
                            {
                                // if a row in IdentificationUnitNotInPartList belongs to a row in IdentificationUnitInPart transfer it
                                if (RUIP.CollectionSpecimenID.ToString() == RU.CollectionSpecimenID.ToString() &&
                                    RUIP.IdentificationUnitID.ToString() == RU.IdentificationUnitID.ToString() &&
                                    RUIP.SpecimenPartID.ToString() == SpecimenPartID.ToString())
                                {
                                    // if the display order = 0 transfer it to the hidden units
                                    if (RUIP.DisplayOrder.Equals(System.DBNull.Value) ||
                                        RUIP.DisplayOrder.ToString() == "0")
                                    {
                                        DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartHideListRow RH
                                            = (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartHideListRow)this.dataSetCollectionSpecimen.IdentificationUnitInPartHideList.NewRow();
                                        RH.CollectionSpecimenID = RUIP.CollectionSpecimenID;
                                        RH.IdentificationUnitID = RUIP.IdentificationUnitID;
                                        RH.SpecimenPartID = RUIP.SpecimenPartID;
                                        RH.DisplayOrder = RUIP.DisplayOrder;
                                        RH.DisplayText = RU.DisplayText;
                                        this.dataSetCollectionSpecimen.IdentificationUnitInPartHideList.Rows.Add(RH);
                                    }
                                    else // transfer it to the shown units
                                    {
                                        DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartDisplayListRow RD
                                            = (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartDisplayListRow)this.dataSetCollectionSpecimen.IdentificationUnitInPartDisplayList.NewRow();
                                        RD.CollectionSpecimenID = RUIP.CollectionSpecimenID;
                                        RD.IdentificationUnitID = RUIP.IdentificationUnitID;
                                        RD.SpecimenPartID = RUIP.SpecimenPartID;
                                        RD.DisplayOrder = RUIP.DisplayOrder;
                                        RD.DisplayText = RU.DisplayText;
                                        this.dataSetCollectionSpecimen.IdentificationUnitInPartDisplayList.Rows.Add(RD);
                                    }
                                    RowsInPart.Add(RU);
                                }
                            }
                        }
                    }
                    foreach (System.Data.DataRow R in RowsInPart)
                    {
                        R.Delete();
                    }
                    // sorting the rows in IdentificationUnitInPartDisplayList
                    System.Data.DataTable dt = this.dataSetCollectionSpecimen.IdentificationUnitInPartDisplayList.Copy();
                    this.dataSetCollectionSpecimen.IdentificationUnitInPartDisplayList.Clear();
                    System.Data.DataRow[] RR = dt.Select("", "DisplayOrder");
                    short i = 1;
                    foreach (System.Data.DataRow R in RR)
                    {
                        DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartDisplayListRow RD
                            = (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartDisplayListRow)this.dataSetCollectionSpecimen.IdentificationUnitInPartDisplayList.NewRow();
                        RD.CollectionSpecimenID = int.Parse(R["CollectionSpecimenID"].ToString());
                        RD.IdentificationUnitID = int.Parse(R["IdentificationUnitID"].ToString());
                        RD.SpecimenPartID = int.Parse(R["SpecimenPartID"].ToString());
                        R["DisplayOrder"] = i;
                        RD.DisplayOrder = i; // short.Parse(R["DisplayOrder"].ToString());
                        RD.DisplayText = R["DisplayText"].ToString();
                        this.dataSetCollectionSpecimen.IdentificationUnitInPartDisplayList.Rows.Add(RD);
                        string Restriction = "CollectionSpecimenID = " + RD.CollectionSpecimenID.ToString() +
                            " AND SpecimenPartID = " + RD.SpecimenPartID.ToString() +
                            " AND IdentificationUnitID = " + RD.IdentificationUnitID.ToString();
                        System.Data.DataRow[] RIUIP =
                            this.dataSetCollectionSpecimen.IdentificationUnitInPart.Select(Restriction);
                        if (RIUIP[0]["DisplayOrder"].ToString() != i.ToString())
                            RIUIP[0]["DisplayOrder"] = i;
                        i++;
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #region Tool strip

        private void toolStripButtonShowUnitInPartLabel_Click(object sender, EventArgs e)
        {
            if (this.listBoxPartHide.SelectedIndex == -1)
            {
                string Message = DiversityCollection.Forms.FormCollectionSpecimenText.Please_select;
                Message += ": " + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("IdentificationUnit"));
                System.Windows.Forms.MessageBox.Show(Message);
                return;
            }
            try
            {
                // getting the row that should be shown
                System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxPartHide.SelectedItem;

                // getting the next display order
                int DisplayOrder = 0;
                System.Data.DataRow[] rr1 = this.dataSetCollectionSpecimen.IdentificationUnitInPart.Select("DisplayOrder = 1", "DisplayOrder DESC");
                if (rr1.Length == 0)
                    DisplayOrder = 1;
                else
                {
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitInPart.Select("NOT DisplayOrder IS NULL AND DisplayOrder <> 0", "DisplayOrder DESC");
                    if (rr.Length > 0)
                        DisplayOrder = int.Parse(rr[0]["DisplayOrder"].ToString()) + 1;
                    else
                        DisplayOrder = 1;
                }

                // getting the dataset and the tree node
                System.Data.DataRow[] RU = this.dataSetCollectionSpecimen.IdentificationUnitInPart.Select(
                    "CollectionSpecimenID = " + R["CollectionSpecimenID"].ToString() +
                    " AND IdentificationUnitID = " + R["IdentificationUnitID"].ToString() +
                    " AND SpecimenPartID = " + R["SpecimenPartID"].ToString());
                if (RU.Length == 0) return;
                System.Windows.Forms.TreeNode Thide = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchyStorage, null, RU[0]);

                // setting the display order
                RU[0].BeginEdit();
                RU[0]["DisplayOrder"] = DisplayOrder;
                RU[0].EndEdit();

                // moving the list items and update the node image
                DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartDisplayListRow Rshow = this.dataSetCollectionSpecimen.IdentificationUnitInPartDisplayList.NewIdentificationUnitInPartDisplayListRow();
                Rshow["CollectionSpecimenID"] = R["CollectionSpecimenID"];
                Rshow["IdentificationUnitID"] = R["IdentificationUnitID"];
                Rshow["SpecimenPartID"] = R["SpecimenPartID"];
                Rshow["DisplayOrder"] = DisplayOrder;
                Rshow[4] = R[4];
                this.dataSetCollectionSpecimen.IdentificationUnitInPartDisplayList.Rows.Add(Rshow);
                R.Row.Delete();
                Thide.ImageIndex--;
            }
            catch { }
        }

        private void toolStripButtonHideUnitFromPartLabel_Click(object sender, EventArgs e)
        {
            if (this.listBoxPartShowInLabel.SelectedIndex == -1)
            {
                string Message = DiversityCollection.Forms.FormCollectionSpecimenText.Please_select;
                Message += ": " + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("IdentificationUnit"));
                System.Windows.Forms.MessageBox.Show(Message);
                return;
            }
            try
            {
                // getting the row that should be hidden
                System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxPartShowInLabel.SelectedItem;
                if (R["DisplayOrder"].ToString() == "1" || this.listBoxPartShowInLabel.SelectedIndex == 0)
                {
                    System.Windows.Forms.MessageBox.Show("The main unit can not be hidden from the label");
                    return;
                }

                // getting the row and the tree node
                System.Data.DataRow[] RU = this.dataSetCollectionSpecimen.IdentificationUnitInPart.Select(
                    "CollectionSpecimenID = " + R["CollectionSpecimenID"].ToString() +
                    " AND IdentificationUnitID = " + R["IdentificationUnitID"].ToString() +
                    " AND SpecimenPartID = " + R["SpecimenPartID"].ToString());
                if (RU.Length == 0) return;
                System.Windows.Forms.TreeNode Thide = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchyStorage, null, RU[0]);

                // setting the display order to 0
                RU[0]["DisplayOrder"] = 0;

                // moving the list items and update the node image
                DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartHideListRow Rhide = this.dataSetCollectionSpecimen.IdentificationUnitInPartHideList.NewIdentificationUnitInPartHideListRow();
                Rhide["CollectionSpecimenID"] = R["CollectionSpecimenID"];
                Rhide["IdentificationUnitID"] = R["IdentificationUnitID"];
                Rhide["SpecimenPartID"] = R["SpecimenPartID"];
                Rhide["DisplayOrder"] = 0;
                Rhide[4] = R[4];
                this.dataSetCollectionSpecimen.IdentificationUnitInPartHideList.Rows.Add(Rhide);
                R.Row.Delete();
                Thide.ImageIndex++;
            }
            catch { }
        }

        private void toolStripButtonPartLabelMoveUp_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.listBoxPartShowInLabel.SelectedIndex == -1)
                {
                    string Message = DiversityCollection.Forms.FormCollectionSpecimenText.Please_select;
                    Message += ": " + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("IdentificationUnit"));
                    System.Windows.Forms.MessageBox.Show(Message);
                    return;
                }
                if (this.listBoxPartShowInLabel.SelectedIndex == 0)
                {
                    System.Windows.Forms.MessageBox.Show("The selected unit is already at the top");
                    return;
                }
                System.Data.DataRowView RMoveUp = (System.Data.DataRowView)this.listBoxPartShowInLabel.SelectedItem;
                System.Data.DataRowView RMoveDown = (System.Data.DataRowView)this.listBoxPartShowInLabel.Items[this.listBoxPartShowInLabel.SelectedIndex - 1];
                if (this.listBoxPartShowInLabel.SelectedIndex == 0 || RMoveUp["DisplayOrder"].ToString() == "1")
                {
                    System.Windows.Forms.MessageBox.Show("The selected unit is already at the top");
                    return;
                }
                int DisplayOrderLower = int.Parse(RMoveUp["DisplayOrder"].ToString()); // the DisplayOrder of the lower dataset
                int DisplayOrderUpper = DisplayOrderLower - 1;// the DisplayOrder of the upper dataset
                // changing the positions
                RMoveDown["DisplayOrder"] = DisplayOrderLower;
                RMoveUp["DisplayOrder"] = DisplayOrderUpper;
                // writing the result in the source table
                foreach (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow R
                    in this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows)
                {
                    if (R.RowState != DataRowState.Detached && R.RowState != DataRowState.Deleted)
                    {
                        if (R.CollectionSpecimenID.ToString() == RMoveDown["CollectionSpecimenID"].ToString()
                            && R.SpecimenPartID.ToString() == RMoveDown["SpecimenPartID"].ToString()
                            && R.IdentificationUnitID.ToString() == RMoveDown["IdentificationUnitID"].ToString())
                            R.DisplayOrder = short.Parse(RMoveDown["DisplayOrder"].ToString());

                        if (R.CollectionSpecimenID.ToString() == RMoveUp["CollectionSpecimenID"].ToString()
                            && R.SpecimenPartID.ToString() == RMoveUp["SpecimenPartID"].ToString()
                            && R.IdentificationUnitID.ToString() == RMoveUp["IdentificationUnitID"].ToString())
                            R.DisplayOrder = short.Parse(RMoveUp["DisplayOrder"].ToString());
                    }
                }
                this.fillPartDisplayLists(this.treeViewOverviewHierarchyStorage.SelectedNode);
            }
            catch (System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
        }

        private void toolStripButtonPartLabelMoveDown_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.listBoxPartShowInLabel.SelectedIndex == -1)
                {
                    string Message = DiversityCollection.Forms.FormCollectionSpecimenText.Please_select;
                    Message += ": " + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("IdentificationUnit"));
                    System.Windows.Forms.MessageBox.Show(Message);
                    return;
                }
                if (this.listBoxPartShowInLabel.SelectedIndex == this.listBoxPartShowInLabel.Items.Count - 1)
                {
                    System.Windows.Forms.MessageBox.Show("The selected unit is already at the base");
                    return;
                }
                System.Data.DataRowView RMoveDown = (System.Data.DataRowView)this.listBoxPartShowInLabel.SelectedItem;
                System.Data.DataRowView RMoveUp = (System.Data.DataRowView)this.listBoxPartShowInLabel.Items[this.listBoxPartShowInLabel.SelectedIndex + 1];
                int DisplayOrderUpper = int.Parse(RMoveDown["DisplayOrder"].ToString()); // the DisplayOrder of the higher dataset
                int DisplayOrderLower = DisplayOrderUpper + 1; // the DisplayOrder of the lower dataset
                // changing the positions
                RMoveDown["DisplayOrder"] = DisplayOrderLower;
                RMoveUp["DisplayOrder"] = DisplayOrderUpper;
                // writing the result in the source table
                foreach (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow R
                    in this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows)
                {
                    if (R.RowState != DataRowState.Detached && R.RowState != DataRowState.Deleted)
                    {
                        if (R.CollectionSpecimenID.ToString() == RMoveDown["CollectionSpecimenID"].ToString()
                            && R.SpecimenPartID.ToString() == RMoveDown["SpecimenPartID"].ToString()
                            && R.IdentificationUnitID.ToString() == RMoveDown["IdentificationUnitID"].ToString())
                            R.DisplayOrder = short.Parse(RMoveDown["DisplayOrder"].ToString());

                        if (R.CollectionSpecimenID.ToString() == RMoveUp["CollectionSpecimenID"].ToString()
                            && R.SpecimenPartID.ToString() == RMoveUp["SpecimenPartID"].ToString()
                            && R.IdentificationUnitID.ToString() == RMoveUp["IdentificationUnitID"].ToString())
                            R.DisplayOrder = short.Parse(RMoveUp["DisplayOrder"].ToString());
                    }
                }
                this.fillPartDisplayLists(this.treeViewOverviewHierarchyStorage.SelectedNode);
            }
            catch (System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
        }

        private void toolStripButtonUnitRemoveFromPart_Click(object sender, EventArgs e)
        {
            if (this.listBoxPartShowInLabel.SelectedIndex == -1)
            {
                string Message = DiversityCollection.Forms.FormCollectionSpecimenText.Please_select;
                Message += ": " + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("IdentificationUnit"));
                System.Windows.Forms.MessageBox.Show(Message);
                return;
            }
            try
            {
                // getting the selected item
                System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxPartShowInLabel.SelectedItem;

                // getting the row that should be deleted
                System.Data.DataRowView RVdel = (System.Data.DataRowView)this.listBoxPartShowInLabel.SelectedItem;
                System.Data.DataRow[] RUdel = this.dataSetCollectionSpecimen.IdentificationUnitInPart.Select(
                    "CollectionSpecimenID = " + RVdel["CollectionSpecimenID"].ToString() +
                    " AND IdentificationUnitID = " + RVdel["IdentificationUnitID"].ToString() +
                    " AND SpecimenPartID = " + RVdel["SpecimenPartID"].ToString());
                System.Data.DataRow[] RUlistDel = this.dataSetCollectionSpecimen.IdentificationUnitInPartDisplayList.Select(
                    "CollectionSpecimenID = " + RVdel["CollectionSpecimenID"].ToString() +
                    " AND IdentificationUnitID = " + RVdel["IdentificationUnitID"].ToString() +
                    " AND SpecimenPartID = " + RVdel["SpecimenPartID"].ToString());
                System.Windows.Forms.TreeNode TNdel = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchyStorage, null, RUdel[0]);
                if (RUdel.Length > 0 && RUlistDel.Length > 0 && TNdel != null)
                {
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitNotInPartListRow RUnot = this.dataSetCollectionSpecimen.IdentificationUnitNotInPartList.NewIdentificationUnitNotInPartListRow();
                    RUnot["CollectionSpecimenID"] = RVdel["CollectionSpecimenID"];
                    RUnot["IdentificationUnitID"] = RVdel["IdentificationUnitID"];
                    RUnot["CollectionSpecimenID"] = RVdel["CollectionSpecimenID"];
                    int DisplayOrder = this.dataSetCollectionSpecimen.IdentificationUnitNotInPartList.Rows.Count + 1;
                    string WhereClause = "CollectionSpecimenID = " + RVdel["CollectionSpecimenID"].ToString() + " AND IdentificationUnitID = " +  RVdel["IdentificationUnitID"].ToString();
                    if (int.TryParse(this.dataSetCollectionSpecimen.IdentificationUnit.Select(WhereClause)[0]["DisplayOrder"].ToString(), out DisplayOrder))
                        RUnot["DisplayOrder"] = DisplayOrder;
                    RUnot["DisplayText"] = RVdel[4].ToString();
                    this.dataSetCollectionSpecimen.IdentificationUnitNotInPartList.Rows.Add(RUnot);
                    RUdel[0].Delete();
                    RUlistDel[0].Delete();
                    TNdel.Remove();
                }
            }
            catch (System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
        }

        /// <summary>
        /// Moving a unit into a part
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void toolStripButtonUnitMoveInPart_Click(object sender, EventArgs e)
        {
            if (this.listBoxUnitsNotInPart.SelectedIndex == -1)
            {
                string Message = DiversityCollection.Forms.FormCollectionSpecimenText.Please_select;
                Message += ": " + DiversityWorkbench.Entity.EntityContent(DiversityWorkbench.Entity.EntityInformationField.DisplayText, DiversityWorkbench.Entity.EntityInformation("IdentificationUnit"));
                System.Windows.Forms.MessageBox.Show(Message);
                return;
            }
            try
            {
                // getting the SpecimenPartID
                int SpecimenPartID = 0;
                if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                {
                    System.Data.DataRow Rselected = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                    if (Rselected.RowState != DataRowState.Deleted) SpecimenPartID = int.Parse(Rselected["SpecimenPartID"].ToString());
                    else
                    {
                        System.Data.DataRow RH = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        SpecimenPartID = int.Parse(RH["SpecimenPartID"].ToString());
                    }
                }
                else
                {
                    // getting the selected row
                    if (this.listBoxPartShowInLabel.Items.Count > 0)
                    {
                        System.Data.DataRowView RVmainItem = (System.Data.DataRowView)this.listBoxPartShowInLabel.Items[0];
                        SpecimenPartID = int.Parse(RVmainItem["SpecimenPartID"].ToString());
                    }
                    else return;
                }

                // getting the next display order
                int DisplayOrder = 1;
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitInPart.Select("NOT DisplayOrder IS NULL", "DisplayOrder DESC");
                if (rr.Length > 0)
                    DisplayOrder = int.Parse(rr[0]["DisplayOrder"].ToString()) + 1;
                else
                    DisplayOrder = 1;

                // insert a new row in table IdentificationUnitInPart
                DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow RU =
                    (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow)this.dataSetCollectionSpecimen.IdentificationUnitInPart.NewRow();
                System.Data.DataRowView R = (System.Data.DataRowView)this.listBoxUnitsNotInPart.SelectedItem;
                RU.CollectionSpecimenID = int.Parse(R["CollectionSpecimenID"].ToString());
                RU.IdentificationUnitID = int.Parse(R["IdentificationUnitID"].ToString());
                RU.SpecimenPartID = SpecimenPartID;
                RU.DisplayOrder = (System.Int16)DisplayOrder;
                this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows.Add(RU);

                // requery the lists
                this.fillPartDisplayLists(this.treeViewOverviewHierarchyStorage.SelectedNode);
                try
                {
                    System.Windows.Forms.TreeNode Tsel = new TreeNode();
                    if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                    {
                        Tsel = this.treeViewOverviewHierarchyStorage.SelectedNode;
                        //this.treeViewOverviewHierarchyStorage.SelectedNode.Nodes.Clear();
                    }
                    else
                    {
                        System.Data.DataRow[] Rpart = this.dataSetCollectionSpecimen.CollectionSpecimenPart.Select("SpecimenPartID = " + SpecimenPartID.ToString());
                        if (Rpart.Length > 0)
                        {
                            Tsel = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchyStorage, null, Rpart[0]);
                        }
                    }
                    if (Tsel != null)
                    {
                        Tsel.Nodes.Clear();
                        this.addOverviewHierarchyPartDependentData(Tsel);
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> ChildNodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(Tsel, "IdentificationUnitInPart", this.treeViewOverviewHierarchyStorage, ref ChildNodes);
                    }
                }
                catch { }
                finally
                {
                }
            }
            catch { }
        }

        private void toolStripButtonUnitMoveInPartAll_Click(object sender, EventArgs e)
        {
            try
            {
                // getting the SpecimenPartID
                int SpecimenPartID = 0;
                if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                {
                    System.Data.DataRow Rselected = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                    if (Rselected.RowState != DataRowState.Deleted) SpecimenPartID = int.Parse(Rselected["SpecimenPartID"].ToString());
                    else
                    {
                        System.Data.DataRow RH = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                        SpecimenPartID = int.Parse(RH["SpecimenPartID"].ToString());
                    }
                }
                else
                {
                    // getting the selected row
                    if (this.listBoxPartShowInLabel.Items.Count > 0)
                    {
                        System.Data.DataRowView RVmainItem = (System.Data.DataRowView)this.listBoxPartShowInLabel.Items[0];
                        SpecimenPartID = int.Parse(RVmainItem["SpecimenPartID"].ToString());
                    }
                    else return;
                }

                // getting the next display order
                int DisplayOrder = 1;
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnitInPart.Select("NOT DisplayOrder IS NULL", "DisplayOrder DESC");
                if (rr.Length > 0)
                    DisplayOrder = int.Parse(rr[0]["DisplayOrder"].ToString()) + 1;
                else
                    DisplayOrder = 1;

                // insert new rows in table IdentificationUnitInPart
                System.Collections.Generic.List<System.Data.DataRowView> RowsToInsert = new List<DataRowView>();
                foreach (System.Object O in this.listBoxUnitsNotInPart.Items)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)O;
                    RowsToInsert.Add(R);
                }
                System.Collections.Generic.List<int> MissingUnitIDs = new List<int>();
                {
                    int UnitID;
                    foreach (System.Data.DataRowView R in RowsToInsert)
                    {
                        if (int.TryParse(R["IdentificationUnitID"].ToString(), out UnitID))
                        {
                            if (!MissingUnitIDs.Contains(UnitID))
                                MissingUnitIDs.Add(UnitID);
                        }
                    }
                }
                foreach (int UnitID in MissingUnitIDs)
                {
                    DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow RU =
                        (DiversityCollection.Datasets.DataSetCollectionSpecimen.IdentificationUnitInPartRow)this.dataSetCollectionSpecimen.IdentificationUnitInPart.NewRow();
                    RU.CollectionSpecimenID = this.ID;
                    RU.IdentificationUnitID = UnitID;
                    RU.SpecimenPartID = SpecimenPartID;
                    RU.DisplayOrder = (System.Int16)DisplayOrder;
                    try
                    {
                        this.dataSetCollectionSpecimen.IdentificationUnitInPart.Rows.Add(RU);
                    }
                    catch (System.Exception ex)
                    {

                    }
                    DisplayOrder++;
                }
                // requery the lists
                this.fillPartDisplayLists(this.treeViewOverviewHierarchyStorage.SelectedNode);
                try
                {
                    System.Windows.Forms.TreeNode Tsel = new TreeNode();
                    if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
                    {
                        Tsel = this.treeViewOverviewHierarchyStorage.SelectedNode;
                        //this.treeViewOverviewHierarchyStorage.SelectedNode.Nodes.Clear();
                    }
                    else
                    {
                        System.Data.DataRow[] Rpart = this.dataSetCollectionSpecimen.CollectionSpecimenPart.Select("SpecimenPartID = " + SpecimenPartID.ToString());
                        if (Rpart.Length > 0)
                        {
                            Tsel = this.getTreeNodeOfDataRow(this.treeViewOverviewHierarchyStorage, null, Rpart[0]);
                        }
                    }
                    if (Tsel != null)
                    {
                        Tsel.Nodes.Clear();
                        this.addOverviewHierarchyPartDependentData(Tsel);
                        System.Collections.Generic.List<System.Windows.Forms.TreeNode> ChildNodes = new List<TreeNode>();
                        this.getOverviewHierarchyNodes(Tsel, "IdentificationUnitInPart", this.treeViewOverviewHierarchyStorage, ref ChildNodes);
                    }
                }
                catch { }
                finally
                {
                }
            }
            catch (System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
        }

        private void toolStripMenuItemPartLabelSortByID_Click(object sender, EventArgs e)
        {
            this.SortByDisplayOrderPart("IdentificationUnitID");
        }

        private void toolStripMenuItemPartLabelSortByName_Click(object sender, EventArgs e)
        {
            this.SortByDisplayOrderPart("LastIdentificationCache");
        }

        private void toolStripMenuItemPartLabelSortByIdentifier_Click(object sender, EventArgs e)
        {
            this.SortByDisplayOrderPart("UnitIdentifier");
        }

        private void SortByDisplayOrderPart(string Target)
        {
            int SpecimenPartID = 0;
            if (this.treeViewOverviewHierarchyStorage.SelectedNode != null)
            {
                System.Data.DataRow Rselected = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                if (Rselected.RowState != DataRowState.Deleted) SpecimenPartID = int.Parse(Rselected["SpecimenPartID"].ToString());
                else
                {
                    System.Data.DataRow RH = (System.Data.DataRow)this.treeViewOverviewHierarchyStorage.SelectedNode.Tag;
                    SpecimenPartID = int.Parse(RH["SpecimenPartID"].ToString());
                }
            }
            else
            {
                // getting the selected row
                if (this.listBoxPartShowInLabel.Items.Count > 0)
                {
                    System.Data.DataRowView RVmainItem = (System.Data.DataRowView)this.listBoxPartShowInLabel.Items[0];
                    SpecimenPartID = int.Parse(RVmainItem["SpecimenPartID"].ToString());
                }
                else return;
            }
            string SQL = "SELECT P.CollectionSpecimenID, P.IdentificationUnitID, P.SpecimenPartID, P.DisplayOrder, U.LastIdentificationCache " +
                "FROM  IdentificationUnitInPart AS P INNER JOIN " +
                "IdentificationUnit AS U ON P.CollectionSpecimenID = U.CollectionSpecimenID AND P.IdentificationUnitID = U.IdentificationUnitID " +
                "WHERE (P.SpecimenPartID = " + SpecimenPartID + ") AND (P.DisplayOrder > 0) " +
                "ORDER BY U." + Target;
            System.Data.DataTable dt = new DataTable();
            System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            ad.Fill(dt);
            for (int i = 0; i < dt.Rows.Count; i++)
            {
                System.Data.DataRow[] RR = 
                    this.dataSetCollectionSpecimen.IdentificationUnitInPart.Select(
                    " CollectionSpecimenID = " + dt.Rows[i]["CollectionSpecimenID"].ToString() +
                    " AND IdentificationUnitID = " + dt.Rows[i]["IdentificationUnitID"].ToString() +
                    " AND SpecimenPartID = " + SpecimenPartID, "");
                if(RR.Length > 0)
                {
                    RR[0]["DisplayOrder"] = i + 1;
                }
            }
            //System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.IdentificationUnitInPart.Select("DisplayOrder > 0", Target);
            //for (int i = 0; i < RR.Length; i++)
            //{
            //    RR[i]["DisplayOrder"] = i + 1;
            //}
            this.setSpecimen(this.ID);
        }

        #endregion   
     
        #endregion        

        #region Specimen

        private void toolStripButtonDisplayShow_Click(object sender, EventArgs e)
        {
            if (this.listBoxDisplayOrderListHide.SelectedIndex > -1)
            {
                try
                {
                    System.Data.DataRowView rv = (System.Data.DataRowView)this.listBoxDisplayOrderListHide.SelectedItem;
                    int UnitID = System.Int32.Parse(rv["IdentificationUnitID"].ToString());
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnit.Select("IdentificationUnitID = " + UnitID.ToString());
                    System.Data.DataRow r = rr[0];
                    System.Data.DataRow[] rrDO = this.dataSetCollectionSpecimen.IdentificationUnit.Select("", "DisplayOrder DESC");
                    System.Data.DataRow rDO = rrDO[0];
                    int DisplayOrder = System.Int32.Parse(rDO["DisplayOrder"].ToString()) + 1;
                    r["DisplayOrder"] = DisplayOrder;
                    this.corrDisplayOrder(0);
                    System.Collections.Generic.List<System.Windows.Forms.TreeNode> UnitNodes = new List<TreeNode>();
                    this.getOverviewHierarchyNodes(null, "IdentificationUnit", this.treeViewOverviewHierarchy, ref UnitNodes);
                    foreach (System.Windows.Forms.TreeNode N in UnitNodes)
                    {
                        System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                        int IdentificationUnitID = int.Parse(R["IdentificationUnitID"].ToString());
                        if (UnitID == IdentificationUnitID)
                        {
                            int i = N.ImageIndex;
                            N.ImageIndex = i - 1;
                            N.SelectedImageIndex = i - 1;
                            break;
                        }
                    }
                }
                catch { }
            }
        }

        private void toolStripButtonDisplayHide_Click(object sender, EventArgs e)
        {
            if (this.listBoxDisplayOrderListShow.SelectedIndex > -1)
            {
                try
                {
                    System.Data.DataRowView rv = (System.Data.DataRowView)this.listBoxDisplayOrderListShow.SelectedItem;
                    if (/*rv["DisplayOrder"].ToString() == "1" ||*/ this.listBoxDisplayOrderListShow.SelectedIndex == 0)
                    {
                        System.Windows.Forms.MessageBox.Show("The main unit can not be hidden from the label");
                        return;
                    }
                    int UnitID = System.Int32.Parse(rv["IdentificationUnitID"].ToString());
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnit.Select("IdentificationUnitID = " + UnitID.ToString());
                    System.Data.DataRow r = rr[0];
                    r["DisplayOrder"] = 0;
                    this.corrDisplayOrder(0);
                    System.Collections.Generic.List<System.Windows.Forms.TreeNode> UnitNodes = new List<TreeNode>();
                    this.getOverviewHierarchyNodes(null, "IdentificationUnit", this.treeViewOverviewHierarchy, ref UnitNodes);
                    foreach (System.Windows.Forms.TreeNode N in UnitNodes)
                    {
                        System.Data.DataRow R = (System.Data.DataRow)N.Tag;
                        int IdentificationUnitID = int.Parse(R["IdentificationUnitID"].ToString());
                        if (UnitID == IdentificationUnitID)
                        {
                            int i = N.ImageIndex;
                            N.ImageIndex = i + 1;
                            N.SelectedImageIndex = i + 1;
                            break;
                        }
                    }
                }
                catch { }
            }
        }

        private void toolStripButtonDisplayOrderUp_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.listBoxDisplayOrderListShow.SelectedIndex > 0)
                {
                    System.Data.DataRowView rv = (System.Data.DataRowView)this.listBoxDisplayOrderListShow.SelectedItem;
                    int UnitID = System.Int32.Parse(rv["IdentificationUnitID"].ToString());
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnit.Select("IdentificationUnitID = " + UnitID.ToString());
                    System.Data.DataRow r = rr[0];
                    int DisplayOrderLower = System.Int32.Parse(r["DisplayOrder"].ToString());
                    System.Data.DataRow[] rrU = this.dataSetCollectionSpecimen.IdentificationUnit.Select("DisplayOrder < " + DisplayOrderLower.ToString(), "DisplayOrder DESC");
                    if (rrU.Length > 0)
                    {
                        System.Data.DataRow rU = rrU[0];
                        int DisplayOrderUpper = System.Int32.Parse(rU["DisplayOrder"].ToString());
                        System.Data.DataRow[] rrDU = this.dataSetCollectionSpecimen.IdentificationUnit.Select("DisplayOrder = " + DisplayOrderUpper.ToString());
                        System.Data.DataRow rDU = rrDU[0];
                        r["DisplayOrder"] = DisplayOrderUpper;
                        rDU["DisplayOrder"] = DisplayOrderLower;
                    }
                }
                else
                {
                    if (this.listBoxDisplayOrderListShow.SelectedIndex == 0)
                    {
                        System.Data.DataRowView rv = (System.Data.DataRowView)this.listBoxDisplayOrderListShow.SelectedItem;
                        int UnitID = System.Int32.Parse(rv["IdentificationUnitID"].ToString());
                        System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnit.Select("IdentificationUnitID = " + UnitID.ToString());
                        System.Data.DataRow r = rr[0];
                        int DisplayOrder = System.Int32.Parse(r["DisplayOrder"].ToString());
                        if (DisplayOrder != 1)
                            r["DisplayOrder"] = 1;
                    }
                }
                this.corrDisplayOrder();

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void toolStripButtonDisplayOrderDown_Click(object sender, EventArgs e)
        {
            if (this.listBoxDisplayOrderListShow.SelectedIndex < this.listBoxDisplayOrderListShow.Items.Count - 1)
            {
                try
                {
                    // the selected item to move down resp. get a higher display order
                    System.Data.DataRowView rv = (System.Data.DataRowView)this.listBoxDisplayOrderListShow.SelectedItem;
                    int UnitID = System.Int32.Parse(rv["IdentificationUnitID"].ToString());
                    System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnit.Select("IdentificationUnitID = " + UnitID.ToString());
                    System.Data.DataRow r = rr[0];
                    int DisplayOrderLower = System.Int32.Parse(r["DisplayOrder"].ToString());

                    System.Data.DataRow[] rrU = this.dataSetCollectionSpecimen.IdentificationUnit.Select("DisplayOrder > " + DisplayOrderLower.ToString(), "DisplayOrder");
                    System.Data.DataRow rU = rrU[0];
                    int DisplayOrderUpper = System.Int32.Parse(rU["DisplayOrder"].ToString());

                    //				int DisplayOrderUpper = DisplayOrderLower + 1;
                    // the item to change place with
                    System.Data.DataRow[] rrDU = this.dataSetCollectionSpecimen.IdentificationUnit.Select("DisplayOrder = " + DisplayOrderUpper.ToString());
                    System.Data.DataRow rDU = rrDU[0];
                    r["DisplayOrder"] = DisplayOrderUpper;
                    rDU["DisplayOrder"] = DisplayOrderLower;

                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
            this.corrDisplayOrder();
        }

        private void corrDisplayOrder()
        {
            try
            {
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnit.Select("DisplayOrder > 0", "DisplayOrder");
                System.Data.DataRow r = rr[0];
                int DisplayOrder = System.Int32.Parse(r["DisplayOrder"].ToString());
                if (DisplayOrder != 1)
                {
                    r["DisplayOrder"] = 1;
                    this.corrDisplayOrder(1);
                }
            }
            catch { }
            try
            {
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnit.Select("DisplayOrder > 0", "DisplayOrder DESC");
                System.Data.DataRow r = rr[0];
                int DisplayOrder = System.Int32.Parse(r["DisplayOrder"].ToString());
                if (DisplayOrder != rr.Length)
                {
                    int DO = rr.Length;
                    foreach (System.Data.DataRow rCorr in rr)
                    {
                        rCorr["DisplayOrder"] = DO;
                        DO--;
                    }
                }
            }
            catch { }
        }

        private void corrDisplayOrder(int DisplayOrder)
        {
            try
            {
                System.Data.DataRow[] rr = this.dataSetCollectionSpecimen.IdentificationUnit.Select("DisplayOrder > " + DisplayOrder.ToString(), "DisplayOrder");
                if (rr.Length > 0)
                {
                    System.Data.DataRow r = rr[0];
                    int DO = System.Int32.Parse(r["DisplayOrder"].ToString());
                    if (DO != DisplayOrder + 1)
                    {
                        DO = DisplayOrder + 1;
                        r["DisplayOrder"] = DO;
                    }
                    System.Data.DataRow[] rrRest = this.dataSetCollectionSpecimen.IdentificationUnit.Select("DisplayOrder > " + DO.ToString());
                    if (rrRest.Length > 0)
                    {
                        this.corrDisplayOrder(DO);
                    }
                }
            }
            catch { }
        }

        private void SortByDisplayOrder(string Target)
        {
            System.Data.DataRow[] RR = this.dataSetCollectionSpecimen.IdentificationUnit.Select("DisplayOrder > 0", Target);
            for(int i = 0; i < RR.Length; i++)
            {
                RR[i]["DisplayOrder"] = i + 1;
            }
            this.setSpecimen(this.ID);
        }

        private void toolStripMenuItemDisplayOrderSortByName_Click(object sender, EventArgs e)
        {
            this.SortByDisplayOrder("LastIdentificationCache");
        }

        private void toolStripMenuItemDisplayOrderSortByID_Click(object sender, EventArgs e)
        {
            this.SortByDisplayOrder("IdentificationUnitID");
        }

        private void toolStripMenuItemDisplayOrderSortByIdentifier_Click(object sender, EventArgs e)
        {
            this.SortByDisplayOrder("UnitIdentifier");
        }

        #endregion

        #endregion

        #region toolStripButtons for Printing

        private void toolStripButtonOverviewHierarchyPrintSpecimen_Click(object sender, EventArgs e)
        {
            if (!this.ShowImagesLabel) this.buttonHeaderShowLabel_Click(null, null);
            if (this.ShowImagesEvent) this.buttonHeaderShowEventImage_Click(null, null);
            if (this.ShowImagesMaps) this.buttonHeaderShowMaps_Click(null, null);
            if (this.ShowImagesSpecimen) this.buttonHeaderShowSpecimenImage_Click(null, null);
            this._PrintPart = false;
            this.setOverviewDataVisibility("PrintSpecimen");
        }

        private void toolStripButtonOverviewHierarchyPrintPart_Click(object sender, EventArgs e)
        {
            if (!this.ShowImagesLabel) this.buttonHeaderShowLabel_Click(null, null);
            if (this.ShowImagesEvent) this.buttonHeaderShowEventImage_Click(null, null);
            if (this.ShowImagesMaps) this.buttonHeaderShowMaps_Click(null, null);
            if (this.ShowImagesSpecimen) this.buttonHeaderShowSpecimenImage_Click(null, null);
            this._PrintPart = true;
            this.setOverviewDataVisibility("PrintSpecimenPart");
        }
        
        #endregion

        #endregion

        #endregion

        #region Visibility of Images

        private void buttonHeaderShowMaps_Click(object sender, EventArgs e)
        {
            if (this.buttonHeaderShowMaps.BackColor == System.Drawing.SystemColors.Control)
                this.buttonHeaderShowMaps.BackColor = System.Drawing.Color.Red;
            else this.buttonHeaderShowMaps.BackColor = System.Drawing.SystemColors.Control;
            this.setImageVisibility();
        }

        private void buttonHeaderShowEventImage_Click(object sender, EventArgs e)
        {
            if (this.buttonHeaderShowEventImage.BackColor == System.Drawing.Color.Red)
            {
                if (this.dataSetCollectionSpecimen.CollectionEventImage.Rows.Count > 0)
                    this.buttonHeaderShowEventImage.BackColor = System.Drawing.Color.Yellow;
                else
                    this.buttonHeaderShowEventImage.BackColor = System.Drawing.SystemColors.Control;
            }
            else
            {
                this.buttonHeaderShowEventImage.BackColor = System.Drawing.Color.Red;
                if (this.dataSetCollectionSpecimen.CollectionEventImage.Rows.Count > 0
                    && this.listBoxEventImages.Items.Count == 0)
                    this.FormFunctions.FillImageList(this.listBoxEventImages, this.imageListEventImages, this.imageListForm, this.dataSetCollectionSpecimen.CollectionEventImage, "URI", this.userControlImageEventImage);
            }
            this.setImageVisibility();
        }

        private void buttonHeaderShowSpecimenImage_Click(object sender, EventArgs e)
        {
            if (this.buttonHeaderShowSpecimenImage.BackColor == System.Drawing.Color.Red)
            {
                if (this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count > 0)
                    this.buttonHeaderShowSpecimenImage.BackColor = System.Drawing.Color.Yellow;
                else
                    this.buttonHeaderShowSpecimenImage.BackColor = System.Drawing.SystemColors.Control;
            }
            else
            {
                this.buttonHeaderShowSpecimenImage.BackColor = System.Drawing.Color.Red;
                if (this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count > 0
                    && this.listBoxSpecimenImage.Items.Count == 0)
                    this.FormFunctions.FillImageList(this.listBoxSpecimenImage, this.imageListSpecimenImages, this.imageListForm, this.dataSetCollectionSpecimen.CollectionSpecimenImage, "URI", this.userControlImageSpecimenImage);
            }
            this.setImageVisibility();
        }

        private void buttonHeaderShowLabel_Click(object sender, EventArgs e)
        {
            if (this.buttonHeaderShowLabel.BackColor == System.Drawing.SystemColors.Control)
                this.buttonHeaderShowLabel.BackColor = System.Drawing.Color.Red;
            else this.buttonHeaderShowLabel.BackColor = System.Drawing.SystemColors.Control;
            this.setImageVisibility();
            if (this.ShowImagesLabel) this.switchToLabelIfPossible();
        }

        /// <summary>
        /// setting the visibility of the Image panels
        /// </summary>
        /// <param name="Visibility">4 digit string with 0 for hide and 1 for show. Maps - EventImages - SpecimenImages - Label</param>
        private void setImageVisibility(string Visibility)
        {
            try
            {
                if (Visibility.Length != 4) return;

                if (Visibility.Substring(0, 1) == "1")
                    this.buttonHeaderShowMaps.BackColor = System.Drawing.Color.Red;
                else
                    this.buttonHeaderShowMaps.BackColor = System.Drawing.SystemColors.Control;

                if (Visibility.Substring(1, 1) == "1")
                    this.buttonHeaderShowEventImage.BackColor = System.Drawing.Color.Red;
                else
                {
                    if (this.dataSetCollectionSpecimen.CollectionEventImage.Rows.Count > 0)
                        this.buttonHeaderShowEventImage.BackColor = System.Drawing.Color.Yellow;
                    else
                        this.buttonHeaderShowEventImage.BackColor = System.Drawing.SystemColors.Control;
                }

                if (Visibility.Substring(2, 1) == "1")
                    this.buttonHeaderShowSpecimenImage.BackColor = System.Drawing.Color.Red;
                else
                {
                    if (this.dataSetCollectionSpecimen.CollectionSpecimenImage.Rows.Count > 0)
                        this.buttonHeaderShowSpecimenImage.BackColor = System.Drawing.Color.Yellow;
                    else
                        this.buttonHeaderShowSpecimenImage.BackColor = System.Drawing.SystemColors.Control;
                }

                if (Visibility.Substring(3, 1) == "1")
                    this.buttonHeaderShowLabel.BackColor = System.Drawing.Color.Red;
                else
                    this.buttonHeaderShowLabel.BackColor = System.Drawing.SystemColors.Control;

                this.setImageVisibility();
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void setImageVisibility()
        {
            if (this.ShowImagesMaps || this.ShowImagesEvent || this.ShowImagesSpecimen || this.ShowImagesLabel)
            {
                this.splitContainerData.Panel1Collapsed = false;
                if (this.ShowImagesMaps || this.ShowImagesEvent)
                {
                    this.splitContainerImages.Panel1Collapsed = false;
                    if (this.ShowImagesMaps)
                    {
                        //this.splitContainerImagesEvent.Panel1Collapsed = false;
                        this.splitContainerImagesEvent.Panel1Collapsed = true;
                        //this.splitContainerImagesGIS.Panel1Collapsed = false;
                        this.splitContainerImagesGIS.Panel1Collapsed = true;
                        this.splitContainerImagesGIS.Panel2Collapsed = true;
                        //this.splitContainerImagesGIS.Panel2Collapsed = false;
                        //this.splitContainerImagesGeography.Panel1Collapsed = false;
                        this.splitContainerImagesGeography.Panel1Collapsed = true;
                        //this.splitContainerImagesGeography.Panel2Collapsed = true;
                        this.splitContainerImagesGeography.Panel2Collapsed = false;
                        this.splitContainerImagesGIS.Panel2Collapsed = false;
                    }
                    else this.splitContainerImagesEvent.Panel1Collapsed = true;
                    if (this.ShowImagesEvent) this.splitContainerImagesEvent.Panel2Collapsed = false;
                    else this.splitContainerImagesEvent.Panel2Collapsed = true;
                }
                else this.splitContainerImages.Panel1Collapsed = true;
                if (this.ShowImagesSpecimen || this.ShowImagesLabel)
                {
                    this.splitContainerImages.Panel2Collapsed = false;
                    if (this.ShowImagesSpecimen) this.splitContainerImagesSpecimen.Panel1Collapsed = false;
                    else this.splitContainerImagesSpecimen.Panel1Collapsed = true;
                    if (this.ShowImagesLabel) this.splitContainerImagesSpecimen.Panel2Collapsed = false;
                    else this.splitContainerImagesSpecimen.Panel2Collapsed = true;
                }
                else this.splitContainerImages.Panel2Collapsed = true;
            }
            else
                this.splitContainerData.Panel1Collapsed = true;
            if (this.ShowImagesSpecimen && !this.ShowImagesLabel)
            {
                this.splitContainerImage.SplitterDistance = this.splitContainerImagesSpecimen.Width - 240;
                this.userControlImageSpecimenImage.AdaptImage();
            }
        }

        private bool ShowImagesMaps 
        { 
            get 
            { 
                if (this.buttonHeaderShowMaps.BackColor == System.Drawing.SystemColors.Control) 
                    return false; 
                else return true; 
            } 
        }
        
        private bool ShowImagesEvent 
        { 
            get 
            {
                if (this.buttonHeaderShowEventImage.BackColor == System.Drawing.Color.Red) 
                    return true; 
                else 
                    return false; 
            } 
        }
        
        private bool ShowImagesSpecimen 
        { 
            get 
            {
                if (this.buttonHeaderShowSpecimenImage.BackColor == System.Drawing.Color.Red)
                    return true;
                else
                    return false;
            } 
        }
        
        private bool ShowImagesLabel { get { if (this.buttonHeaderShowLabel.BackColor == System.Drawing.SystemColors.Control) return false; else return true; } }

        private ImageDisplayState _DisplayImagesSpecimen = ImageDisplayState.Missing;
        
        private ImageDisplayState DisplayImagesSpecimen
        {
            get
            {
                if (this.dataSetCollectionSpecimen.CollectionEventImage.Rows.Count == 0)
                    this._DisplayImagesSpecimen = ImageDisplayState.Missing;
                return this._DisplayImagesSpecimen;
            }
            set
            {
                if (value != ImageDisplayState.Missing)
                {
                    this._DisplayImagesSpecimen = value;
                }
                this._DisplayImagesSpecimen = value;
            }
        }

        private void switchToLabelIfPossible()
        {
            try
            {
                if (this.dataSetCollectionSpecimen.CollectionSpecimenPart.Rows.Count > 0)
                {
                    System.Collections.Generic.List<System.Windows.Forms.TreeNode> PartNodes = new List<TreeNode>();
                    this.getOverviewHierarchyNodes(null, "CollectionSpecimenPart", this.treeViewOverviewHierarchyStorage, ref PartNodes);
                    if (PartNodes.Count > 0)
                    {
                        this.treeViewOverviewHierarchyStorage.SelectedNode = PartNodes[0];
                        this.toolStripButtonOverviewHierarchyPrintPart_Click(null, null);
                    }
                }
                else
                {
                    System.Collections.Generic.List<System.Windows.Forms.TreeNode> Nodes = new List<TreeNode>();
                    this.getOverviewHierarchyNodes(null, "CollectionSpecimen", this.treeViewOverviewHierarchy, ref Nodes);
                    if (Nodes.Count > 0)
                    {
                        this.treeViewOverviewHierarchy.SelectedNode = Nodes[0];
                        this.toolStripButtonOverviewHierarchyPrintSpecimen_Click(null, null);
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #region Image template and Description
        
        private string ImageDescriptionTemplate
        {
            get
            {
                string Template = "";
                if (!this.userControlQueryList.ProjectIsSelected)
                    System.Windows.Forms.MessageBox.Show("Please select a project");
                else
                {
                    string SQL = "SELECT CASE WHEN ImageDescriptionTemplate IS NULL THEN '' ELSE CAST(ImageDescriptionTemplate AS nvarchar(MAX)) END AS ImageDescriptionTemplate " +
                        "FROM ProjectProxy " +
                        "WHERE ProjectID = " + this.userControlQueryList.ProjectID.ToString();
                    Template = DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL);
                    if (this.userControlQueryList.ProjectID > 0 && Template.Length == 0)
                        System.Windows.Forms.MessageBox.Show("For the current project no description template is defined");
                }
                return Template;
            }
        }

        private void setImageDescription(System.Windows.Forms.BindingSource BindingSource)
        {
            if (BindingSource.Current == null)
            {
                System.Windows.Forms.MessageBox.Show("Please select an image");
                return;
            }
            try
            {
                System.Data.DataRowView R = (System.Data.DataRowView)BindingSource.Current;
                string XML = R["Description"].ToString();
                DiversityWorkbench.Forms.FormXml f = new DiversityWorkbench.Forms.FormXml("EXIF for image", XML, true);
                f.ShowDialog();
            }
            catch (Exception ex)
            {
            }
        }
        
        #endregion

        #region Import Wizard: Step dictionaries for import events

        private enum ImportWizardMainTables { Analysis, Collection, Method, Processing, Transaction, CollectionEventSeries, CollectionEvent, CollectionSpecimen, Annotation, ExternalIdentifier, CollectionAgent, CollectionProject, CollectionSpecimenPart, IdentificationUnit, CollectionSpecimenRelation, CollectionSpecimenReference, CollectionSpecimenImage };

        #region Series
        
        private enum ImportWizardSeriesTables { CollectionEventSeriesImage };

        private System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> ImportStepsSeries()
        {
            System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS = new Dictionary<string, DiversityWorkbench.Import.Step>();

            DiversityWorkbench.Import.DataTable DT = this.ImportWizardDataTable("CollectionEventSeries", "", "Series", DiversityWorkbench.Import.DataTable.Parallelity.unique, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.CollectionEventSeries, "DateCache", "SeriesCode");
            DiversityWorkbench.Import.Step S = DiversityWorkbench.Import.Step.GetStepTemplate(DT, DiversityCollection.Specimen.ImageForTable(DT.TableName, false), 0, true, null);
            S.MustSelect = true;
            IS.Add(DT.PositionKey, S);

            System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.StepColumnGroup> ColumnGroups = new Dictionary<string, DiversityWorkbench.Import.StepColumnGroup>();

            DiversityWorkbench.Import.StepColumnGroup GCreator = this.ImportWizardStepColumnGroup("Creator",
                DiversityCollection.Specimen.ImageForTable("CollectionAgent", false),
                "CreatorAgent, CreatorAgentURI, IPR, CopyrightStatement, LicenseType");
            ColumnGroups.Add(GCreator.DisplayText, GCreator);

            DiversityWorkbench.Import.DataTable DTImages = this.ImportWizardDataTable("CollectionEventSeriesImage", DT.TableAlias, "Images", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardSeriesTables.CollectionEventSeriesImage, "", "");
            DiversityWorkbench.Import.Step SImages = DiversityWorkbench.Import.Step.GetStepTemplate(DTImages, DiversityCollection.Specimen.ImageForTable(DTImages.TableName, false), 1, false, ColumnGroups);
            IS.Add(DTImages.PositionKey, SImages);

            return IS;
        }
        
        #endregion

        #region Event

        private enum ImportWizardEventTables { CollectionEventImage, CollectionEventLocalisation, CollectionEventProperty, CollectionEventMethod, CollectionEventRegulation, Annotation, ExternalIdentifier };
        private enum ImportWizardEventLocalisation { Top50 = 1, GaussKrueger, MTB, Altitude, mNN, GreenwichCoordinates, NamedArea, WGS84, Coordinates, Exposition, Slope, PostsdamDatum, SamplingPlot, Depth, Height, DutchCoordinates, OesterreichischeKarte, NamedArea2, NamedArea3, NamedArea4, NamedArea5 };
        private enum ImportWizardEventProperties { EUNIS = 1, GeographicRegions = 10, Chronostratigraphy = 20, Lithostratigraphy = 30, Lebensraumtypen = 40, Pflanzengesellschaften = 50, Biostratigraphy = 60 };

        private System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> ImportStepsEvent(bool IsSelected)
        {
            System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS = new Dictionary<string, DiversityWorkbench.Import.Step>();
            try
            {
                string SeriesTable = "";
                if (IsSelected)
                {
                    DiversityWorkbench.Import.DataTable DTSeries = this.ImportWizardDataTable("CollectionEventSeries", "", "Series", DiversityWorkbench.Import.DataTable.Parallelity.unique, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.CollectionEventSeries, "DateCache", "SeriesCode");
                    DTSeries.IsForAttachment = true;
                    DiversityWorkbench.Import.Step S = DiversityWorkbench.Import.Step.GetStepTemplate(DTSeries, DiversityCollection.Specimen.ImageForTable(DTSeries.TableName, false), 0, false, null);
                    IS.Add(DTSeries.PositionKey, S);
                    SeriesTable = DTSeries.TableAlias;
                }

                DiversityWorkbench.Import.DataTable DTEvent = this.ImportWizardDataTable("CollectionEvent", SeriesTable, "Event", DiversityWorkbench.Import.DataTable.Parallelity.unique, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.CollectionEvent, "Version, ToolUsage, CollectionDate", "CollectorsEventNumber, CollectionEventID");
                DTEvent.AddDatasource("CountryCache", "SELECT NULL AS DisplayText, NULL AS Value UNION SELECT DISTINCT CountryCache AS DisplayText, CountryCache AS Value  " +
                            "FROM CollectionEvent " +
                            "WHERE (CountryCache <> N'') " +
                            "ORDER BY DisplayText");
                if (!IsSelected)
                {
                    DTEvent.AddDatasource("SeriesID", "SELECT SeriesID AS Value, case when SeriesCode is null OR SeriesCode = '' then Description else SeriesCode + " +
                        "case when Description <> '' AND Description <> SeriesCode then ' (= ' + Description + ')' else '' end end AS DisplayText " +
                        "FROM  CollectionEventSeries ORDER BY DisplayText");
                }

                DiversityWorkbench.Import.Step SEvent = DiversityWorkbench.Import.Step.GetStepTemplate(DTEvent, DiversityCollection.Specimen.ImageForTable(DTEvent.TableName, false), 0, IsSelected, null);
                SEvent.StepColumnGroups = this.ImportWizardColumnGroupsCollectionEvent();
                if (IsSelected)
                    SEvent.MustSelect = true;
                IS.Add(DTEvent.PositionKey, SEvent);

                DiversityWorkbench.Import.DataTable DTImages = this.ImportWizardDataTable("CollectionEventImage", DTEvent.TableAlias, "Image", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardEventTables.CollectionEventImage, "", "");
                DiversityWorkbench.Import.Step SImages = DiversityWorkbench.Import.Step.GetStepTemplate(DTImages, DiversityCollection.Specimen.ImageForTable(DTImages.TableName, false), 1, false, null);
                IS.Add(DTImages.PositionKey, SImages);

                /// Localisation
                this.ImportStepsEventLocalisation(ref IS);

                /// Properties
                this.ImportStepsEventProperties(ref IS);

                /// Methods
                DiversityWorkbench.Import.DataTable DTMethod = this.ImportWizardDataTable("CollectionEventMethod", DTEvent.TableAlias, "Method", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardEventTables.CollectionEventMethod, "", "");
                DTMethod.AddDatasource("MethodID", "SELECT MethodID AS Value, HierarchyDisplayText AS DisplayText " +
                    "FROM [dbo].[MethodHierarchyAll] () ORDER BY DisplayText");
                DiversityWorkbench.Import.Step SMethod = DiversityWorkbench.Import.Step.GetStepTemplate(DTMethod, DiversityCollection.Specimen.ImageForTable(DTMethod.TableName, false), 1, false, null);
                IS.Add(DTMethod.PositionKey, SMethod);

                /// Parameter
                DiversityWorkbench.Import.DataTable DTMethodParameter = this.ImportWizardDataTable("CollectionEventParameterValue", DTMethod.TableAlias, "Parameter", DiversityWorkbench.Import.DataTable.Parallelity.parallel, 1, "", "");
                DTMethodParameter.AddDatasource("MethodID", "SELECT MethodID AS Value, HierarchyDisplayText AS DisplayText " +
                    "FROM [dbo].[MethodHierarchyAll] () AS M  " +
                    "WHERE M.ForCollectionEvent = 1 " +
                    "ORDER BY M.DisplayText");
                DTMethodParameter.AddDatasource("ParameterID", "SELECT P.ParameterID AS Value, M.HierarchyDisplayText + ': ' + P.DisplayText AS DisplayText " +
                    "FROM [dbo].[MethodHierarchyAll] () AS M, Parameter AS P  " +
                    "WHERE M.MethodID = P.MethodID AND M.ForCollectionEvent = 1 " +
                    "ORDER BY M.DisplayText");
                DiversityWorkbench.Import.Step SMethodParameter = DiversityWorkbench.Import.Step.GetStepTemplate(DTMethodParameter, DiversityCollection.Specimen.ImageForTable(DTMethodParameter.TableName, false), 2, false, null);
                IS.Add(DTMethodParameter.PositionKey, SMethodParameter);

                //EventIdentifier
                this.ImportStepEventIdentifier(ref IS);
                //Annotation
                this.ImportStepEventAnnotation(ref IS);

                /// Regulation
                DiversityWorkbench.Import.DataTable DTRegulation = this.ImportWizardDataTable("CollectionEventRegulation", DTEvent.TableAlias, "Regulation", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardEventTables.CollectionEventRegulation, "", "");
                DiversityWorkbench.Import.Step SRegulation = DiversityWorkbench.Import.Step.GetStepTemplate(DTRegulation, DiversityCollection.Specimen.ImageForTable(DTRegulation.TableName, false), 1, false, null);
                IS.Add(DTRegulation.PositionKey, SRegulation);

            }
            catch (System.Exception ex)
            {
            }
            return IS;
        }

        private void ImportStepEventIdentifier(ref System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS)
        {
            try
            {
                // ExternalIdentifier
                DiversityWorkbench.Import.DataTable DTEventIdentifier = this.ImportWizardDataTable("ExternalIdentifier", "CollectionEvent", "Identifier event", DiversityWorkbench.Import.DataTable.Parallelity.referencing, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardEventTables.ExternalIdentifier, "", "");
                if (DTEventIdentifier.DataColumns.ContainsKey("ReferencedID"))
                {
                    DTEventIdentifier.DataColumns["ReferencedID"].ForeignRelationColumn = "CollectionEventID";
                    DTEventIdentifier.DataColumns["ReferencedID"].ForeignRelationTable = "CollectionEvent";
                    DTEventIdentifier.DataColumns["ReferencedID"].ForeignRelationTableAlias = "CollectionEvent";
                    DTEventIdentifier.DataColumns["ReferencedID"].TypeOfSource = DiversityWorkbench.Import.DataColumn.SourceType.ParentTable;
                    DTEventIdentifier.AddPresetValue("ReferencedTable", "CollectionEvent");

                    DTEventIdentifier.DataColumns["Type"].IsSelected = true;
                    DTEventIdentifier.ParallelPositionForReferencingTable = 1;
                    DiversityWorkbench.Import.Step SEventIdentifier = DiversityWorkbench.Import.Step.GetStepTemplate(DTEventIdentifier, DiversityCollection.Specimen.ImageForTable("ExternalIdentifier", false), 1, false, null);
                    IS.Add(DTEventIdentifier.PositionKey, SEventIdentifier);
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void ImportStepEventAnnotation(ref System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS)
        {
            try
            {
                // Annotation
                DiversityWorkbench.Import.DataTable DTEventAnnotation = this.ImportWizardDataTable("Annotation", "CollectionEvent", "Annotation event", DiversityWorkbench.Import.DataTable.Parallelity.referencing, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardEventTables.Annotation, "", "");
                if (DTEventAnnotation.DataColumns.ContainsKey("ReferencedID"))
                {
                    DTEventAnnotation.DataColumns["ReferencedID"].ForeignRelationColumn = "CollectionEventID";
                    DTEventAnnotation.DataColumns["ReferencedID"].ForeignRelationTable = "CollectionEvent";
                    DTEventAnnotation.DataColumns["ReferencedID"].ForeignRelationTableAlias = "CollectionEvent";
                    DTEventAnnotation.DataColumns["ReferencedID"].TypeOfSource = DiversityWorkbench.Import.DataColumn.SourceType.ParentTable;
                    DTEventAnnotation.AddPresetValue("ReferencedTable", "CollectionEvent");
                    DTEventAnnotation.ParallelPositionForReferencingTable = 1;
                    DiversityWorkbench.Import.Step SEventAnnotation = DiversityWorkbench.Import.Step.GetStepTemplate(DTEventAnnotation, DiversityCollection.Specimen.ImageForTable("Annotation", false), 1, false, null);
                    IS.Add(DTEventAnnotation.PositionKey, SEventAnnotation);
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void ImportStepsEventLocalisation(ref System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS)
        {
            try
            {
                DiversityWorkbench.Import.Step S_WGS84 = this.ImportWizardLocalisation(ImportWizardEventLocalisation.WGS84);
                IS.Add(S_WGS84.DataTableTemplate.PositionKey, S_WGS84);

                DiversityWorkbench.Import.Step S_Coo = this.ImportWizardLocalisation(ImportWizardEventLocalisation.Coordinates);
                IS.Add(S_Coo.DataTableTemplate.PositionKey, S_Coo);

                DiversityWorkbench.Import.Step S_GaussKrueger = this.ImportWizardLocalisation(ImportWizardEventLocalisation.GaussKrueger);
                IS.Add(S_GaussKrueger.DataTableTemplate.PositionKey, S_GaussKrueger);

                DiversityWorkbench.Import.Step S_PostsdamDatum = this.ImportWizardLocalisation(ImportWizardEventLocalisation.PostsdamDatum);
                IS.Add(S_PostsdamDatum.DataTableTemplate.PositionKey, S_PostsdamDatum);

                DiversityWorkbench.Import.Step S_NamedArea = this.ImportWizardLocalisation(ImportWizardEventLocalisation.NamedArea);
                IS.Add(S_NamedArea.DataTableTemplate.PositionKey, S_NamedArea);

                DiversityWorkbench.Import.Step S_MTB = this.ImportWizardLocalisation(ImportWizardEventLocalisation.MTB);
                IS.Add(S_MTB.DataTableTemplate.PositionKey, S_MTB);

                DiversityWorkbench.Import.Step S_Altitude = this.ImportWizardLocalisation(ImportWizardEventLocalisation.Altitude);
                IS.Add(S_Altitude.DataTableTemplate.PositionKey, S_Altitude);

                DiversityWorkbench.Import.Step S_Depth = this.ImportWizardLocalisation(ImportWizardEventLocalisation.Depth);
                IS.Add(S_Depth.DataTableTemplate.PositionKey, S_Depth);

                DiversityWorkbench.Import.Step S_Height = this.ImportWizardLocalisation(ImportWizardEventLocalisation.Height);
                IS.Add(S_Height.DataTableTemplate.PositionKey, S_Height);

                DiversityWorkbench.Import.Step S_Slope = this.ImportWizardLocalisation(ImportWizardEventLocalisation.Slope);
                IS.Add(S_Slope.DataTableTemplate.PositionKey, S_Slope);

                DiversityWorkbench.Import.Step S_Exposition = this.ImportWizardLocalisation(ImportWizardEventLocalisation.Exposition);
                IS.Add(S_Exposition.DataTableTemplate.PositionKey, S_Exposition);

                DiversityWorkbench.Import.Step S_SamplingPlot = this.ImportWizardLocalisation(ImportWizardEventLocalisation.SamplingPlot);
                IS.Add(S_SamplingPlot.DataTableTemplate.PositionKey, S_SamplingPlot);

                DiversityWorkbench.Import.Step S_NamedArea2 = this.ImportWizardLocalisation(ImportWizardEventLocalisation.NamedArea2);
                IS.Add(S_NamedArea2.DataTableTemplate.PositionKey, S_NamedArea2);

                DiversityWorkbench.Import.Step S_NamedArea3 = this.ImportWizardLocalisation(ImportWizardEventLocalisation.NamedArea3);
                IS.Add(S_NamedArea3.DataTableTemplate.PositionKey, S_NamedArea3);

                DiversityWorkbench.Import.Step S_NamedArea4 = this.ImportWizardLocalisation(ImportWizardEventLocalisation.NamedArea4);
                IS.Add(S_NamedArea4.DataTableTemplate.PositionKey, S_NamedArea4);

                DiversityWorkbench.Import.Step S_NamedArea5 = this.ImportWizardLocalisation(ImportWizardEventLocalisation.NamedArea5);
                IS.Add(S_NamedArea5.DataTableTemplate.PositionKey, S_NamedArea5);
            }
            catch (System.Exception ex)
            {
            }
        }

        private void ImportStepsEventProperties(ref System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS)
        {
            DiversityWorkbench.Import.Step S_Chrono = this.ImportWizardEventProperty(ImportWizardEventProperties.Chronostratigraphy);
            IS.Add(S_Chrono.DataTableTemplate.PositionKey, S_Chrono);

            DiversityWorkbench.Import.Step S_Lithostratigraphy = this.ImportWizardEventProperty(ImportWizardEventProperties.Lithostratigraphy);
            IS.Add(S_Lithostratigraphy.DataTableTemplate.PositionKey, S_Lithostratigraphy);

            DiversityWorkbench.Import.Step S_Biostratigraphy = this.ImportWizardEventProperty(ImportWizardEventProperties.Biostratigraphy);
            IS.Add(S_Biostratigraphy.DataTableTemplate.PositionKey, S_Biostratigraphy);

            DiversityWorkbench.Import.Step S_GeographicRegions = this.ImportWizardEventProperty(ImportWizardEventProperties.GeographicRegions);
            IS.Add(S_GeographicRegions.DataTableTemplate.PositionKey, S_GeographicRegions);

            DiversityWorkbench.Import.Step S_Lebensraumtypen = this.ImportWizardEventProperty(ImportWizardEventProperties.Lebensraumtypen);
            IS.Add(S_Lebensraumtypen.DataTableTemplate.PositionKey, S_Lebensraumtypen);

            DiversityWorkbench.Import.Step S_Pflanzengesellschaften = this.ImportWizardEventProperty(ImportWizardEventProperties.Pflanzengesellschaften);
            IS.Add(S_Pflanzengesellschaften.DataTableTemplate.PositionKey, S_Pflanzengesellschaften);

            DiversityWorkbench.Import.Step S_EUNIS = this.ImportWizardEventProperty(ImportWizardEventProperties.EUNIS);
            IS.Add(S_EUNIS.DataTableTemplate.PositionKey, S_EUNIS);
        }

        private System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.StepColumnGroup> ImportWizardColumnGroupsCollectionEvent()
        {
            System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.StepColumnGroup> ColumnGroups = new Dictionary<string, DiversityWorkbench.Import.StepColumnGroup>();
            //DiversityWorkbench.Import.StepColumnGroup Glog = this.ImportWizardStepColumnGroup("Logging",
            //    DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Logging, false),
            //    "LogCreatedWhen, LogCreatedBy, LogUpdatedWhen, LogUpdatedBy, RowGUID");
            //ColumnGroups.Add(Glog.DisplayText, Glog);
            DiversityWorkbench.Import.StepColumnGroup Gref = this.ImportWizardStepColumnGroup("Reference",
                DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Reference, false),
                "ReferenceTitle, ReferenceURI, ReferenceDetails");
            ColumnGroups.Add(Gref.DisplayText, Gref);
            DiversityWorkbench.Import.StepColumnGroup Gdate = this.ImportWizardStepColumnGroup("Date and time",
                DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.DateTime, false),
                "CollectionDay, CollectionMonth, CollectionYear, CollectionDateSupplement, CollectionEndDay, CollectionEndMonth, CollectionEndYear, " +
                " CollectionDateCategory, CollectionTime, CollectionTimeSpan, DataWithholdingReasonDate");
            ColumnGroups.Add(Gdate.DisplayText, Gdate);
            return ColumnGroups;
        }

        private DiversityWorkbench.Import.Step ImportWizardLocalisation(DiversityCollection.FormCollectionSpecimen.ImportWizardEventLocalisation Localisation)
        {
            /*SELECT     CollectionEventID, LocalisationSystemID, Location1, Location2, LocationAccuracy, LocationNotes, DeterminationDate, DistanceToLocation, DirectionToLocation, 
            ResponsibleName, ResponsibleAgentURI, Geography, AverageAltitudeCache, AverageLatitudeCache, AverageLongitudeCache, LogCreatedWhen, LogCreatedBy, 
            LogUpdatedWhen, LogUpdatedBy, RowGUID, RecordingMethod
            FROM         CollectionEventLocalisation*/

            System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.StepColumnGroup> ColumnGroups = new Dictionary<string, DiversityWorkbench.Import.StepColumnGroup>();

            DiversityWorkbench.Import.StepColumnGroup Gres = this.ImportWizardStepColumnGroup("Responsible",
                DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Agent, false),
                "ResponsibleName, ResponsibleAgentURI, DeterminationDate");
            ColumnGroups.Add(Gres.DisplayText, Gres);
            string IgnoredColumns = "";
            DiversityWorkbench.Import.StepColumnGroup Ggeo;
            switch (Localisation)
            {
                case ImportWizardEventLocalisation.Coordinates:
                case ImportWizardEventLocalisation.WGS84:
                case ImportWizardEventLocalisation.PostsdamDatum:
                case ImportWizardEventLocalisation.GreenwichCoordinates:
                case ImportWizardEventLocalisation.SamplingPlot:
                case ImportWizardEventLocalisation.MTB:
                    Ggeo = this.ImportWizardStepColumnGroup("Geography",
                        DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Localisation, false),
                        "Geography, AverageAltitudeCache, AverageLatitudeCache, AverageLongitudeCache");
                    ColumnGroups.Add(Ggeo.DisplayText, Ggeo);
                    IgnoredColumns = "DistanceToLocation, DirectionToLocation";
                    break;
                case ImportWizardEventLocalisation.NamedArea:
                case ImportWizardEventLocalisation.NamedArea2:
                case ImportWizardEventLocalisation.NamedArea3:
                case ImportWizardEventLocalisation.NamedArea4:
                case ImportWizardEventLocalisation.NamedArea5:
                    Ggeo = this.ImportWizardStepColumnGroup("Geography",
                        DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Localisation, false),
                        "Geography, AverageAltitudeCache, AverageLatitudeCache, AverageLongitudeCache, DistanceToLocation, DirectionToLocation");
                    ColumnGroups.Add(Ggeo.DisplayText, Ggeo);
                    IgnoredColumns = "";
                    break;
                case ImportWizardEventLocalisation.OesterreichischeKarte:
                case ImportWizardEventLocalisation.GaussKrueger:
                    Ggeo = this.ImportWizardStepColumnGroup("Geography",
                        DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Localisation, false),
                        "AverageLatitudeCache, AverageLongitudeCache");
                    ColumnGroups.Add(Ggeo.DisplayText, Ggeo);
                    IgnoredColumns = "Geography, AverageAltitudeCache, DistanceToLocation, DirectionToLocation";
                    break;
                case ImportWizardEventLocalisation.Top50:
                case ImportWizardEventLocalisation.Altitude:
                default:
                    IgnoredColumns = "Geography, AverageAltitudeCache, AverageLatitudeCache, AverageLongitudeCache, " +
                        "DistanceToLocation, DirectionToLocation";
                    break;
            }

            string Title = DiversityCollection.LookupTable.LocalisationSystemName((int)Localisation);
            System.Collections.Generic.Dictionary<string, string> DD = DiversityCollection.LookupTable.LocalisationSystemInfo(((int)Localisation).ToString());
            string DisplayTextLocation1 = DD["DisplayTextLocation1"];
            string DisplayTextLocation2 = DD["DisplayTextLocation2"];
            DiversityWorkbench.Import.DataTable DT = this.ImportWizardDataTable("CollectionEventLocalisation", "CollectionEvent", Title, DiversityWorkbench.Import.DataTable.Parallelity.restricted, ((int)ImportWizardEventTables.CollectionEventLocalisation), IgnoredColumns, "");
            DT.AddPresetValue("LocalisationSystemID", ((int)Localisation).ToString());
            DT.AddColumnDisplayText("Location1", DisplayTextLocation1);
            DT.AddColumnDisplayText("Location2", DisplayTextLocation2);
            DT.ParentTableAlias = "CollectionEvent";
            System.Drawing.Image Image = DiversityCollection.Specimen.ImageForLocalisationSystem(((int)Localisation));
            DiversityWorkbench.Import.Step S = DiversityWorkbench.Import.Step.GetStepTemplate(DT, Image, 1, false, ColumnGroups);
            //DT.Step = S;
            return S;
        }

        private DiversityWorkbench.Import.Step ImportWizardEventProperty(DiversityCollection.FormCollectionSpecimen.ImportWizardEventProperties Property)
        {
            /*SELECT     CollectionEventID, PropertyID, DisplayText, PropertyURI, PropertyHierarchyCache, PropertyValue, ResponsibleName, ResponsibleAgentURI, Notes, 
            AverageValueCache, LogCreatedWhen, LogCreatedBy, LogUpdatedWhen, LogUpdatedBy, RowGUID
            FROM         CollectionEventProperty*/

            System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.StepColumnGroup> ColumnGroups = new Dictionary<string, DiversityWorkbench.Import.StepColumnGroup>();

            DiversityWorkbench.Import.StepColumnGroup Gres = this.ImportWizardStepColumnGroup("Responsible",
                DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Agent, false),
                "ResponsibleName, ResponsibleAgentURI");
            ColumnGroups.Add(Gres.DisplayText, Gres);

            string IgnoredColumns = "PropertyValue, AverageValueCache";

            switch (Property)
            {
                case ImportWizardEventProperties.Chronostratigraphy:
                case ImportWizardEventProperties.EUNIS:
                case ImportWizardEventProperties.GeographicRegions:
                case ImportWizardEventProperties.Lebensraumtypen:
                case ImportWizardEventProperties.Lithostratigraphy:
                case ImportWizardEventProperties.Pflanzengesellschaften:
                case ImportWizardEventProperties.Biostratigraphy:
                    IgnoredColumns = "";
                    break;
                default:
                    break;
            }

            string Title = DiversityCollection.LookupTable.PropertyName((int)Property);
            DiversityWorkbench.Import.DataTable DT = this.ImportWizardDataTable("CollectionEventProperty", "CollectionEvent", Title, DiversityWorkbench.Import.DataTable.Parallelity.restricted, ((int)ImportWizardEventTables.CollectionEventProperty), IgnoredColumns, "");
            DT.AddPresetValue("PropertyID", ((int)Property).ToString());
            System.Drawing.Image Image = DiversityCollection.Specimen.ImageForCollectionEventProperty(((int)Property));
            DiversityWorkbench.Import.Step S = DiversityWorkbench.Import.Step.GetStepTemplate(DT, Image, 1, false, ColumnGroups);

            return S;
        }

        #endregion

        #region Specimen

        private enum ImportWizardUnitTables { Identification, IdentificationUnitInPart, IdentificationUnitGeoAnalysis, IdentificationUnitAnalysis, Annotation, ExternalIdentifier };
        private enum ImportWizardPartTables { CollectionSpecimenProcessing, CollectionSpecimenTransaction, CollectionSpecimenPartDescription, /*CollectionSpecimenPartRegulation,*/ Annotation, ExternalIdentifier };
        private enum ImportWizardImageTables { CollectionSpecimenImageProperty };
        private enum ImportWizardReferenceTables { ExternalIdentifier };

        private System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> ImportStepsSpecimen(DiversityWorkbench.Import.iStartingMessage iMessage)
        {
            iMessage.ShowCurrentStep("Creating the steps for the collection event\r\n||........");
            System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS = this.ImportStepsEvent(false);

            iMessage.ShowCurrentStep("Creating the steps for the specimen\r\n|||.......");
            DiversityWorkbench.Import.DataTable DTSpecimen = this.ImportWizardDataTable("CollectionSpecimen", "CollectionEvent", "Specimen", DiversityWorkbench.Import.DataTable.Parallelity.unique, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.CollectionSpecimen, "Version, CollectionID, AccessionDate", "CollectionSpecimenID, AccessionNumber, DepositorsAccessionNumber");
            DTSpecimen.AddDatasource("ExternalDatasourceID", "SELECT ExternalDatasourceID AS Value, ExternalDatasourceName AS DisplayText " +
                "FROM CollectionExternalDatasource " +
                "ORDER BY DisplayText ");
            DiversityWorkbench.Import.Import.DefaultDuplicateCheckColumn = DTSpecimen.DataColumns["AccessionNumber"];
            DiversityWorkbench.Import.Step SSpecimen = DiversityWorkbench.Import.Step.GetStepTemplate(DTSpecimen, DiversityCollection.Specimen.ImageForTable(DTSpecimen.TableName, false), 0, true, null);
            SSpecimen.StepColumnGroups = this.ImportWizardColumnGroupsSpecimen(false);
            SSpecimen.MustSelect = true;
            IS.Add(DTSpecimen.PositionKey, SSpecimen);

            DiversityWorkbench.Import.DataTable DTSpecimenIdentifier = this.ImportWizardDataTable("ExternalIdentifier", "CollectionSpecimen", "Identifier", DiversityWorkbench.Import.DataTable.Parallelity.referencing, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.ExternalIdentifier, "", "");
            if (DTSpecimenIdentifier.DataColumns.ContainsKey("ReferencedID"))
            {
                DTSpecimenIdentifier.DataColumns["ReferencedID"].ForeignRelationColumn = "CollectionSpecimenID";
                DTSpecimenIdentifier.DataColumns["ReferencedID"].ForeignRelationTable = "CollectionSpecimen";
                DTSpecimenIdentifier.DataColumns["ReferencedID"].ForeignRelationTableAlias = "CollectionSpecimen";
                DTSpecimenIdentifier.DataColumns["ReferencedID"].TypeOfSource = DiversityWorkbench.Import.DataColumn.SourceType.ParentTable;
                DTSpecimenIdentifier.AddPresetValue("ReferencedTable", "CollectionSpecimen");

                DTSpecimenIdentifier.DataColumns["Type"].IsSelected = true;

                DiversityWorkbench.Import.Step SSpecimenIdentifier = DiversityWorkbench.Import.Step.GetStepTemplate(DTSpecimenIdentifier, DiversityCollection.Specimen.ImageForTable("ExternalIdentifier", false), 1, false, null);
                IS.Add(DTSpecimenIdentifier.PositionKey, SSpecimenIdentifier);
            }

            DiversityWorkbench.Import.DataTable DTSpecimenAnnotation = this.ImportWizardDataTable("Annotation", "CollectionSpecimen", "Annotation", DiversityWorkbench.Import.DataTable.Parallelity.referencing, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.Annotation, "", "");
            DTSpecimenAnnotation.DataColumns["ReferencedID"].ForeignRelationColumn = "CollectionSpecimenID";
            DTSpecimenAnnotation.DataColumns["ReferencedID"].ForeignRelationTable = "CollectionSpecimen";
            DTSpecimenAnnotation.DataColumns["ReferencedID"].ForeignRelationTableAlias = "CollectionSpecimen";
            DTSpecimenAnnotation.DataColumns["ReferencedID"].TypeOfSource = DiversityWorkbench.Import.DataColumn.SourceType.ParentTable;
            DTSpecimenAnnotation.AddPresetValue("ReferencedTable", "CollectionSpecimen");
            DTSpecimenAnnotation.ParallelPositionForReferencingTable = 1;
            DiversityWorkbench.Import.Step SSpecimenAnnotation = DiversityWorkbench.Import.Step.GetStepTemplate(DTSpecimenAnnotation, DiversityCollection.Specimen.ImageForTable("Annotation", false), 1, false, null);
            IS.Add(DTSpecimenAnnotation.PositionKey, SSpecimenAnnotation);

            this.ImportStepsProjectsEtc(ref IS);

            iMessage.ShowCurrentStep("Creating the steps for the parts\r\n||||......");
            this.ImportStepsPart(ref IS);

            iMessage.ShowCurrentStep("Creating the steps for the units\r\n|||||.....");
            this.ImportStepsUnit(ref IS, false, iMessage);

            iMessage.ShowCurrentStep("Creating the steps for the relations\r\n||||||....");
            this.ImportStepsRelation(ref IS);

            iMessage.ShowCurrentStep("Creating the steps for the references\r\n|||||||...");
            this.ImportStepsReference(ref IS);

            return IS;
        }

        private System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> ImportStepsObservation(DiversityWorkbench.Import.iStartingMessage iMessage)
        {
            System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS = this.ImportStepsEvent(false);

            string IgnoredColumns = "Version, CollectionID, AccessionNumber, AccessionDate, AccessionDay, AccessionMonth, AccessionYear, " +
                "AccessionDateSupplement, AccessionDateCategory, DepositorsName, DepositorsAgentURI, DepositorsAccessionNumber, " +
                "LabelTitle, LabelType, LabelTranscriptionState, LabelTranscriptionNotes, ExsiccataURI, ExsiccataAbbreviation";

            DiversityWorkbench.Import.DataTable DTSpecimen = this.ImportWizardDataTable("CollectionSpecimen", "CollectionEvent", "Observation", DiversityWorkbench.Import.DataTable.Parallelity.unique, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.CollectionSpecimen, IgnoredColumns, "CollectionSpecimenID");
            DTSpecimen.AddDatasource("ExternalDatasourceID", "SELECT ExternalDatasourceID AS Value, ExternalDatasourceName AS DisplayText " +
                "FROM CollectionExternalDatasource " +
                "ORDER BY DisplayText");
            DiversityWorkbench.Import.Step SSpecimen = DiversityWorkbench.Import.Step.GetStepTemplate(DTSpecimen, DiversityCollection.Specimen.MaterialCategoryImage(false, "observation"), 0, true, null);
            SSpecimen.StepColumnGroups = this.ImportWizardColumnGroupsSpecimen(true);
            SSpecimen.MustSelect = true;
            IS.Add(DTSpecimen.PositionKey, SSpecimen);

            this.ImportStepsProjectsEtc(ref IS);

            this.ImportStepsUnit(ref IS, true, iMessage);

            return IS;
        }

        private void ImportStepsProjectsEtc(ref System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS)
        {
            DiversityWorkbench.Import.DataTable DTProjects = this.ImportWizardDataTable("CollectionProject", "CollectionSpecimen", "Project", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.CollectionProject, "", "");
            DTProjects.AddDatasource("ProjectID", "SELECT ProjectID AS Value, Project AS DisplayText " +
                "FROM ProjectProxy " +
                "ORDER BY DisplayText ");
            DiversityWorkbench.Import.Step SProjects = DiversityWorkbench.Import.Step.GetStepTemplate(DTProjects, DiversityCollection.Specimen.ImageForTable(DTProjects.TableName, false), 1, false, null);
            SProjects.MustSelect = true;
            IS.Add(DTProjects.PositionKey, SProjects);

            /*SELECT     CollectionSpecimenID, CollectorsName, CollectorsAgentURI, CollectorsSequence, CollectorsNumber, Notes, DataWithholdingReason, LogCreatedWhen, 
            LogCreatedBy, LogUpdatedWhen, LogUpdatedBy, RowGUID
            FROM         CollectionAgent
             * */
            DiversityWorkbench.Import.DataTable DTAgents = this.ImportWizardDataTable("CollectionAgent", "CollectionSpecimen", "Agent", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.CollectionAgent, /*"CollectorsSequence"*/ "", "CollectorsNumber");
            DiversityWorkbench.Import.Step SAgents = DiversityWorkbench.Import.Step.GetStepTemplate(DTAgents, DiversityCollection.Specimen.ImageForTable(DTAgents.TableName, false), 1, false, null);
            IS.Add(DTAgents.PositionKey, SAgents);

            /*
             * SELECT     CollectionSpecimenID, URI, ResourceURI, SpecimenPartID, IdentificationUnitID, ImageType, Description, Notes, DataWithholdingReason, LogCreatedWhen, 
            LogCreatedBy, LogUpdatedWhen, LogUpdatedBy, RowGUID, Title, IPR, CreatorAgent, CreatorAgentURI, CopyrightStatement, LicenseType, InternalNotes
            FROM         CollectionSpecimenImage
             * */
            System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.StepColumnGroup> ColumnGroups = new Dictionary<string, DiversityWorkbench.Import.StepColumnGroup>();

            DiversityWorkbench.Import.StepColumnGroup GCreator = this.ImportWizardStepColumnGroup("Creator",
                DiversityCollection.Specimen.ImageForTable("CollectionAgent", false),
                "CreatorAgent, CreatorAgentURI, IPR, CopyrightStatement, LicenseType");
            ColumnGroups.Add(GCreator.DisplayText, GCreator);

            DiversityWorkbench.Import.DataTable DTImages = this.ImportWizardDataTable("CollectionSpecimenImage", "CollectionSpecimen", "Image", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.CollectionSpecimenImage, "", "");
            DTImages.DataColumns["SpecimenPartID"].SelectParallelForeignRelationTableAlias = true;
            DTImages.DataColumns["IdentificationUnitID"].SelectParallelForeignRelationTableAlias = true;
            DiversityWorkbench.Import.Step SImages = DiversityWorkbench.Import.Step.GetStepTemplate(DTImages, DiversityCollection.Specimen.ImageForTable(DTImages.TableName, false), 1, false, ColumnGroups);
            IS.Add(DTImages.PositionKey, SImages);

            DiversityWorkbench.Import.DataTable DTImageProperty = this.ImportWizardDataTable("CollectionSpecimenImageProperty", DTImages.TableAlias, "Image property", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardImageTables.CollectionSpecimenImageProperty, "", "");
            DiversityWorkbench.Import.Step SImageProperty = DiversityWorkbench.Import.Step.GetStepTemplate(DTImageProperty, DiversityCollection.Specimen.ImageForTable(DTImageProperty.TableName, false), 2, false, null);
            IS.Add(DTImageProperty.PositionKey, SImageProperty);
        }

        private void ImportStepsRelation(ref System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS)
        {

            //DiversityWorkbench.Import.DataTable DTRelation = this.ImportWizardDataTable("CollectionSpecimenRelation", "CollectionSpecimen", "Relation", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.CollectionSpecimenRelation, "IdentificationUnitID, SpecimenPartID", "");
            DiversityWorkbench.Import.DataTable DTRelation = this.ImportWizardDataTable("CollectionSpecimenRelation", "CollectionSpecimen", "Relation", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.CollectionSpecimenRelation, "", "");
            
            // 18.8.2015 - MW: Lookup tables for these columns
            DTRelation.DataColumns["IdentificationUnitID"].SelectParallelForeignRelationTableAlias = true;
            DTRelation.DataColumns["SpecimenPartID"].SelectParallelForeignRelationTableAlias = true;

            //DTRelation.DataColumns["IdentificationUnitID"].ForeignRelationColumn = "";
            //DTRelation.DataColumns["IdentificationUnitID"].ForeignRelationTable = "";
            //DTRelation.DataColumns["IdentificationUnitID"].ForeignRelationTableAlias = "";
            //DTRelation.DataColumns["SpecimenPartID"].ForeignRelationColumn = "";
            //DTRelation.DataColumns["SpecimenPartID"].ForeignRelationTable = "";
            //DTRelation.DataColumns["SpecimenPartID"].ForeignRelationTableAlias = "";

            DiversityWorkbench.Import.Step SRelation = DiversityWorkbench.Import.Step.GetStepTemplate(DTRelation, DiversityCollection.Specimen.ImageForTable(DTRelation.TableName, false), 1, false, null);
            IS.Add(DTRelation.PositionKey, SRelation);

        }

        private void ImportStepsReference(ref System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS)
        {
            try
            {
                DiversityWorkbench.Import.DataTable DTReference = this.ImportWizardDataTable("CollectionSpecimenReference", "CollectionSpecimen", "Reference", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.CollectionSpecimenReference, "", "");

                if (DTReference.DataColumns.ContainsKey("IdentificationUnitID"))
                {
                    DTReference.DataColumns["IdentificationUnitID"].SelectParallelForeignRelationTableAlias = true;
                    DTReference.DataColumns["SpecimenPartID"].SelectParallelForeignRelationTableAlias = true;
                    try
                    {
                        // Fehler in DataTable: ParentTableAlias = "CollectionSpecimenReference", sollte aber "CollectionSpecimenReference_1" sein
                        DiversityWorkbench.Import.DataTable DTReferenceIdentifier = this.ImportWizardDataTable("ExternalIdentifier", DTReference.TableAlias, "Ref. identifier", DiversityWorkbench.Import.DataTable.Parallelity.referencing, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardReferenceTables.ExternalIdentifier, "", "");
                        if (DTReferenceIdentifier.DataColumns.ContainsKey("ReferencedID"))
                        {
                            DTReferenceIdentifier.DataColumns["ReferencedID"].ForeignRelationColumn = "ReferenceID";
                            DTReferenceIdentifier.DataColumns["ReferencedID"].ForeignRelationTable = "CollectionSpecimenReference";
                            DTReferenceIdentifier.DataColumns["ReferencedID"].ForeignRelationTableAlias = "CollectionSpecimenReference";
                            DTReferenceIdentifier.DataColumns["ReferencedID"].TypeOfSource = DiversityWorkbench.Import.DataColumn.SourceType.ParentTable;
                            DTReferenceIdentifier.AddPresetValue("ReferencedTable", "CollectionSpecimenReference");

                            DTReferenceIdentifier.DataColumns["Type"].IsSelected = true;

                            DiversityWorkbench.Import.Step SReferenceIdentifier = DiversityWorkbench.Import.Step.GetStepTemplate(DTReferenceIdentifier, DiversityCollection.Specimen.ImageForTable("ExternalIdentifier", false), 2, false, null);
                            IS.Add(DTReferenceIdentifier.PositionKey, SReferenceIdentifier);
                        }
                    }
                    catch (System.Exception ex)
                    {
                    }

                    DiversityWorkbench.Import.Step SReference = DiversityWorkbench.Import.Step.GetStepTemplate(DTReference, DiversityCollection.Specimen.ImageForTable(DTReference.TableName, false), 1, false, null);
                    IS.Add(DTReference.PositionKey, SReference);
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        #region Part

        private void ImportStepsPart(ref System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS)
        {
            /*
            SELECT CollectionSpecimenID, SpecimenPartID, DerivedFromSpecimenPartID, PreparationMethod, PreparationDate, AccessionNumber, PartSublabel, CollectionID, 
            MaterialCategory, StorageLocation, Stock, StockUnit, StorageContainer, Notes, LogCreatedWhen, LogCreatedBy, LogUpdatedWhen, LogUpdatedBy, RowGUID, 
            ResponsibleName, ResponsibleAgentURI, DataWithholdingReason
            FROM CollectionSpecimenPart
            */
            try
            {
                System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.StepColumnGroup> ColumnGroups = new Dictionary<string, DiversityWorkbench.Import.StepColumnGroup>();

                DiversityWorkbench.Import.StepColumnGroup Gstore = this.ImportWizardStepColumnGroup("Storage",
                    DiversityCollection.Specimen.ImageForOverview(Specimen.OverviewImage.Collection),
                    "CollectionID, StorageLocation, Stock, StockUnit, StorageContainer");
                ColumnGroups.Add(Gstore.DisplayText, Gstore);

                DiversityWorkbench.Import.StepColumnGroup Gprep = this.ImportWizardStepColumnGroup("Preparation",
                    DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Processing, false),
                    "PreparationMethod, PreparationDate, PreparationMethodID");
                ColumnGroups.Add(Gprep.DisplayText, Gprep);

                DiversityWorkbench.Import.StepColumnGroup Gres = this.ImportWizardStepColumnGroup("Responsible",
                    DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Agent, false),
                    "ResponsibleName, ResponsibleAgentURI");
                ColumnGroups.Add(Gres.DisplayText, Gres);

                DiversityWorkbench.Import.DataTable DTPart = this.ImportWizardDataTable("CollectionSpecimenPart", "CollectionSpecimen", "Part", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.CollectionSpecimenPart, "", "AccessionNumber, StorageLocation, PartSublabel, SpecimenPartID");
                DTPart.AddDatasource("CollectionID", ImportWizardCollectionList);
                DTPart.DataColumns["DerivedFromSpecimenPartID"].SelectParallelForeignRelationTableAlias = true;
                DiversityWorkbench.Import.Step SPart = DiversityWorkbench.Import.Step.GetStepTemplate(DTPart, DiversityCollection.Specimen.ImageForTable(DTPart.TableName, false), 1, false, ColumnGroups);
                //SPart.StepColumnGroups = this.ImportWizardColumnGroupsPart();
                IS.Add(DTPart.PositionKey, SPart);

                /*
                 * SELECT     CollectionSpecimenID, ProcessingDate, ProcessingID, Protocoll, SpecimenPartID, ProcessingDuration, ResponsibleName, ResponsibleAgentURI, Notes, 
                LogCreatedWhen, LogCreatedBy, LogUpdatedWhen, LogUpdatedBy, RowGUID, ToolUsage
                FROM         CollectionSpecimenProcessing
                 * */
                DiversityWorkbench.Import.DataTable DTProcessing = this.ImportWizardDataTable("CollectionSpecimenProcessing", DTPart.TableAlias, "Processing", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardPartTables.CollectionSpecimenProcessing, "ToolUsage", "");
                DiversityWorkbench.Import.Step SProcessing = DiversityWorkbench.Import.Step.GetStepTemplate(DTProcessing, DiversityCollection.Specimen.ImageForTable(DTProcessing.TableName, false), 2, false, null);
                IS.Add(DTProcessing.PositionKey, SProcessing);

                this.ImportStepsProcessingMethod(ref IS, DTProcessing.TableAlias);

                /*SELECT     CollectionSpecimenID, TransactionID, SpecimenPartID, IsOnLoan, LogInsertedBy, LogInsertedWhen, LogUpdatedBy, LogUpdatedWhen, RowGUID, 
                AccessionNumber
                FROM         CollectionSpecimenTransaction
                 * */
                DiversityWorkbench.Import.DataTable DTTransaction = this.ImportWizardDataTable("CollectionSpecimenTransaction", DTPart.TableAlias, "Transaction", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardPartTables.CollectionSpecimenTransaction, "", "AccessionNumber");
                DTTransaction.AddDatasource("TransactionID", "SELECT DisplayText, TransactionID AS Value FROM [dbo].[TransactionHierarchyAll] () ORDER BY DisplayText");
                DiversityWorkbench.Import.Step STransaction = DiversityWorkbench.Import.Step.GetStepTemplate(DTTransaction, DiversityCollection.Specimen.ImageForTable(DTTransaction.TableName, false), 2, false, null);
                IS.Add(DTTransaction.PositionKey, STransaction);

                DiversityWorkbench.Import.DataTable DTPartDescription = this.ImportWizardDataTable("CollectionSpecimenPartDescription", DTPart.TableAlias, "Description", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardPartTables.CollectionSpecimenPartDescription, "", "");
                DiversityWorkbench.Import.Step SPartDescription = DiversityWorkbench.Import.Step.GetStepTemplate(DTPartDescription, DiversityCollection.Specimen.ImageForTable(DTPartDescription.TableName, false), 2, false, null);
                IS.Add(DTPartDescription.PositionKey, SPartDescription);

                //DiversityWorkbench.Import.DataTable DTPartRegulation = this.ImportWizardDataTable("CollectionSpecimenPartRegulation", DTPart.TableAlias, "Regulation", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardPartTables.CollectionSpecimenPartRegulation, "", "");
                //DiversityWorkbench.Import.Step SPartRegulation = DiversityWorkbench.Import.Step.GetStepTemplate(DTPartRegulation, DiversityCollection.Specimen.ImageForTable(DTPartRegulation.TableName, false), 2, false, null);
                //IS.Add(DTPartRegulation.PositionKey, SPartRegulation);

                this.ImportStepsPartExternalIdentifier(ref IS, DTPart.TableAlias);
                this.ImportStepsPartAnnotation(ref IS, DTPart.TableAlias);

            }
            catch (System.Exception ex) { }
        }

        /// <summary>
        /// Versuch fuer D. Neumann - geht so leider nicht
        /// </summary>
        /// <param name="IS"></param>
        private void ImportStepRegulation(ref System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS)
        {
            //DiversityWorkbench.Import.DataTable DTTransaction = this.ImportWizardDataTable("CollectionSpecimenTransaction", DTPart.TableAlias, "Transaction", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardPartTables.CollectionSpecimenTransaction, "", "AccessionNumber");
            //DTTransaction.AddDatasource("TransactionID", "SELECT DisplayText, TransactionID AS Value FROM [dbo].[TransactionHierarchyAll] () ORDER BY DisplayText");
            //DiversityWorkbench.Import.Step STransaction = DiversityWorkbench.Import.Step.GetStepTemplate(DTTransaction, DiversityCollection.Specimen.ImageForTable(DTTransaction.TableName, false), 2, false, null);
            //IS.Add(DTTransaction.PositionKey, STransaction);

            // Kopie aus TaxonNames
            //DT.DataColumns["NameID"].SourceFunctionDisplayText = "Generate new value";
            //DT.DataColumns["NameID"].PrepareInsertFunction = prepareInsertNewId;
            //DT.DataColumns["NameID"].DataRetrievalType = DiversityWorkbench.Import.DataColumn.RetrievalType.FunctionInDatabase;

        }


        private void ImportStepsProcessingMethod(ref System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS, string TableAlias)
        {
            ///TODO: Tabellen sind noch nicht in verwendbarer Form - erst Umbau notwendig
            //return;
            ///TODO

            /*SELECT     CollectionSpecimenID, SpecimenProcessingID, MethodID, ProcessingID, LogCreatedWhen, LogCreatedBy, LogUpdatedWhen, LogUpdatedBy, RowGUID
            FROM         CollectionSpecimenProcessingMethod*/
            DiversityWorkbench.Import.DataTable DTProcessingMethod = this.ImportWizardDataTable("CollectionSpecimenProcessingMethod", TableAlias, "Method", DiversityWorkbench.Import.DataTable.Parallelity.parallel, 1, "", "");
            DTProcessingMethod.AddDatasource("MethodID", "SELECT M.MethodID AS Value, M.HierarchyDisplayText AS DisplayText " +
                "FROM [dbo].[MethodHierarchyAll] () AS M WHERE MethodID IN (SELECT MethodID FROM MethodForProcessing) " +
                "ORDER BY DisplayText");
            DiversityWorkbench.Import.Step SProcessingMethod = DiversityWorkbench.Import.Step.GetStepTemplate(DTProcessingMethod, DiversityCollection.Specimen.ImageForTable(DTProcessingMethod.TableName, false), 3, false, null);
            IS.Add(DTProcessingMethod.PositionKey, SProcessingMethod);

            /*SELECT     CollectionSpecimenID, SpecimenProcessingID, ProcessingID, MethodID, ParameterID, Value, LogCreatedWhen, LogCreatedBy, LogUpdatedWhen, 
            LogUpdatedBy
            FROM         CollectionSpecimenProcessingMethodParameter*/
            DiversityWorkbench.Import.DataTable DTProcessingMethodParameter = this.ImportWizardDataTable("CollectionSpecimenProcessingMethodParameter", DTProcessingMethod.TableAlias, "Parameter", DiversityWorkbench.Import.DataTable.Parallelity.parallel, 1, "", "");
            DTProcessingMethodParameter.AddDatasource("MethodID", "SELECT M.MethodID AS Value, M.HierarchyDisplayText AS DisplayText " +
                "FROM [dbo].[MethodHierarchyAll] () AS M WHERE MethodID IN (SELECT MethodID FROM MethodForProcessing) " +
                "ORDER BY M.DisplayText");
            DTProcessingMethodParameter.AddDatasource("ParameterID", "SELECT P.ParameterID AS Value, M.HierarchyDisplayText + ': ' + P.DisplayText AS DisplayText " +
                "FROM [dbo].[MethodHierarchyAll] () AS M, Parameter AS P " +
                "WHERE M.MethodID = P.MethodID AND M.MethodID IN (SELECT MethodID FROM MethodForProcessing) " +
                "ORDER BY DisplayText");
            DiversityWorkbench.Import.Step SProcessingMethodParameter = DiversityWorkbench.Import.Step.GetStepTemplate(DTProcessingMethodParameter, DiversityCollection.Specimen.ImageForTable(DTProcessingMethodParameter.TableName, false), 4, false, null);
            IS.Add(DTProcessingMethodParameter.PositionKey, SProcessingMethodParameter);
        }

        private void ImportStepsPartExternalIdentifier(ref System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS, string TableAlias)
        {
            try
            {
                DiversityWorkbench.Import.DataTable DTPartExternalIdentifier = this.ImportWizardDataTable("ExternalIdentifier", TableAlias, "Identifier part", DiversityWorkbench.Import.DataTable.Parallelity.referencing, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardPartTables.ExternalIdentifier, "", "");
                if (DTPartExternalIdentifier.DataColumns.ContainsKey("ReferencedID"))
                {
                    DTPartExternalIdentifier.DataColumns["ReferencedID"].ForeignRelationColumn = "SpecimenPartID";
                    DTPartExternalIdentifier.DataColumns["ReferencedID"].ForeignRelationTable = "CollectionSpecimenPart";
                    DTPartExternalIdentifier.DataColumns["ReferencedID"].ForeignRelationTableAlias = TableAlias;
                    DTPartExternalIdentifier.DataColumns["ReferencedID"].TypeOfSource = DiversityWorkbench.Import.DataColumn.SourceType.ParentTable;
                    DTPartExternalIdentifier.AddPresetValue("ReferencedTable", "CollectionSpecimenPart");

                    DTPartExternalIdentifier.DataColumns["Type"].IsSelected = true;

                    DTPartExternalIdentifier.ParallelPositionForReferencingTable = 1;

                    DiversityWorkbench.Import.Step SPartExternalIdentifier = DiversityWorkbench.Import.Step.GetStepTemplate(DTPartExternalIdentifier, DiversityCollection.Specimen.ImageForTable("ExternalIdentifier", false), 2, false, null);
                    IS.Add(DTPartExternalIdentifier.PositionKey, SPartExternalIdentifier);
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        private void ImportStepsPartAnnotation(ref System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS, string TableAlias)
        {
            try
            {
                DiversityWorkbench.Import.DataTable DTPartAnnotation = this.ImportWizardDataTable("Annotation", TableAlias, "Annotation part", DiversityWorkbench.Import.DataTable.Parallelity.referencing, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardPartTables.Annotation, "", "");
                if (DTPartAnnotation.DataColumns.ContainsKey("ReferencedID"))
                {
                    DTPartAnnotation.DataColumns["ReferencedID"].ForeignRelationColumn = "SpecimenPartID";
                    DTPartAnnotation.DataColumns["ReferencedID"].ForeignRelationTable = "CollectionSpecimenPart";
                    DTPartAnnotation.DataColumns["ReferencedID"].ForeignRelationTableAlias = TableAlias;
                    DTPartAnnotation.DataColumns["ReferencedID"].TypeOfSource = DiversityWorkbench.Import.DataColumn.SourceType.ParentTable;
                    DTPartAnnotation.AddPresetValue("ReferencedTable", "CollectionSpecimenPart");

                    DTPartAnnotation.ParallelPositionForReferencingTable = 1;

                    DiversityWorkbench.Import.Step SPartAnnotation = DiversityWorkbench.Import.Step.GetStepTemplate(DTPartAnnotation, DiversityCollection.Specimen.ImageForTable("Annotation", false), 2, false, null);
                    IS.Add(DTPartAnnotation.PositionKey, SPartAnnotation);
                }
            }
            catch (System.Exception ex)
            {
            }
        }
        
        #endregion

        #region Unit

        private void ImportStepsUnit(ref System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS, bool IsForObservation, DiversityWorkbench.Import.iStartingMessage iMessage)
        {
            /*SELECT     CollectionSpecimenID, IdentificationUnitID, LastIdentificationCache, FamilyCache, OrderCache, TaxonomicGroup, OnlyObserved, RelatedUnitID, RelationType, 
            ColonisedSubstratePart, LifeStage, Gender, NumberOfUnits, ExsiccataNumber, ExsiccataIdentification, UnitIdentifier, UnitDescription, Circumstances, DisplayOrder, 
            Notes, HierarchyCache, ParentUnitID
            FROM         IdentificationUnit*/

            System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.StepColumnGroup> ColumnGroups = new Dictionary<string, DiversityWorkbench.Import.StepColumnGroup>();

            DiversityWorkbench.Import.StepColumnGroup Grel = this.ImportWizardStepColumnGroup("Relation",
                DiversityCollection.Specimen.ImageForTable("Parent", false),
                "RelatedUnitID, RelationType, ColonisedSubstratePart, ParentUnitID");
            ColumnGroups.Add(Grel.DisplayText, Grel);

            DiversityWorkbench.Import.StepColumnGroup Ghier = this.ImportWizardStepColumnGroup("Hierarchy, name",
                DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Hierarchy, false),
                "LastIdentificationCache, FamilyCache, OrderCache, HierarchyCache");
            ColumnGroups.Add(Ghier.DisplayText, Ghier);

            DiversityWorkbench.Import.StepColumnGroup Gnotes = this.ImportWizardStepColumnGroup("Notes etc.",
                DiversityCollection.Specimen.ImageForTable("Annotation", false),
                "Notes, UnitIdentifier, UnitDescription, DisplayOrder, ExsiccataNumber");
            ColumnGroups.Add(Gnotes.DisplayText, Gnotes);

            DiversityWorkbench.Import.DataTable DTUnits = this.ImportWizardDataTable("IdentificationUnit", "CollectionSpecimen", "Organism", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.IdentificationUnit, "ExsiccataIdentification", "IdentificationUnitID, UnitIdentifier");
            DTUnits.DataColumns["RelatedUnitID"].SelectParallelForeignRelationTableAlias = true;
            DTUnits.DataColumns["ParentUnitID"].SelectParallelForeignRelationTableAlias = true;
            DiversityWorkbench.Import.Step SUnits = DiversityWorkbench.Import.Step.GetStepTemplate(DTUnits, DiversityCollection.Specimen.ImageForTable(DTUnits.TableName, false), 1, false, ColumnGroups);
            IS.Add(DTUnits.PositionKey, SUnits);

            /*
             * SELECT     CollectionSpecimenID, IdentificationUnitID, IdentificationSequence, IdentificationDate, IdentificationDay, IdentificationMonth, IdentificationYear, 
            IdentificationDateSupplement, IdentificationDateCategory, VernacularTerm, TaxonomicName, NameURI, IdentificationCategory, IdentificationQualifier, TypeStatus, 
            TypeNotes, ReferenceTitle, ReferenceURI, Notes, ResponsibleName, ResponsibleAgentURI, ReferenceDetails
            FROM         Identification
             * */

            System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.StepColumnGroup> ColumnGroupsIdentification = new Dictionary<string, DiversityWorkbench.Import.StepColumnGroup>();

            DiversityWorkbench.Import.StepColumnGroup Gdate = this.ImportWizardStepColumnGroup("Date",
                DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.DateTime, false),
                "IdentificationDay, IdentificationMonth, IdentificationYear, " +
                "IdentificationDateSupplement, IdentificationDateCategory");
            ColumnGroupsIdentification.Add(Gdate.DisplayText, Gdate);

            DiversityWorkbench.Import.StepColumnGroup GResponsible = this.ImportWizardStepColumnGroup("Responsible",
                DiversityCollection.Specimen.ImageForOverview(Specimen.OverviewImage.Agent),
                "ResponsibleName, ResponsibleAgentURI");
            ColumnGroupsIdentification.Add(GResponsible.DisplayText, GResponsible);

            DiversityWorkbench.Import.StepColumnGroup GReference = this.ImportWizardStepColumnGroup("Reference",
                DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Reference, false),
                "ReferenceTitle, ReferenceURI, ReferenceDetails");
            ColumnGroupsIdentification.Add(GReference.DisplayText, GReference);

            iMessage.ShowCurrentStep("Creating the step for the identification\r\n|||||.....");
            DiversityWorkbench.Import.DataTable DTIdentification = this.ImportWizardDataTable("Identification", DTUnits.TableAlias, "Identification", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardUnitTables.Identification, "IdentificationDate", "");
            DiversityWorkbench.Import.Step SIdentification = DiversityWorkbench.Import.Step.GetStepTemplate(DTIdentification, DiversityCollection.Specimen.ImageForTable(DTIdentification.TableName, false), 2, false, ColumnGroupsIdentification);
            IS.Add(DTIdentification.PositionKey, SIdentification);

            if (!IsForObservation)
            {
                DiversityWorkbench.Import.DataTable DTIdentificationUnitInPart = this.ImportWizardDataTable("IdentificationUnitInPart", DTUnits.TableAlias, "Organism in part", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardUnitTables.IdentificationUnitInPart, "", "");
                //DTIdentificationUnitInPart.DataColumns["SpecimenPartID"].ForeignRelationTableAlias = "CollectionSpecimenPart_1";
                //DTIdentificationUnitInPart.DataColumns["SpecimenPartID"].ForeignRelationTable = "CollectionSpecimenPart";
                DTIdentificationUnitInPart.DataColumns["SpecimenPartID"].SelectParallelForeignRelationTableAlias = true;
                DiversityWorkbench.Import.Step SIdentificationUnitInPart = DiversityWorkbench.Import.Step.GetStepTemplate(DTIdentificationUnitInPart, DiversityCollection.Specimen.ImageForTable(DTIdentificationUnitInPart.TableName, false), 2, false, null);
                IS.Add(DTIdentificationUnitInPart.PositionKey, SIdentificationUnitInPart);
            }

            /*
             * SELECT     CollectionSpecimenID, IdentificationUnitID, AnalysisID, AnalysisNumber, AnalysisResult, ExternalAnalysisURI, ResponsibleName, ResponsibleAgentURI, 
            AnalysisDate, SpecimenPartID, ToolID, Notes, LogCreatedWhen, LogCreatedBy, LogUpdatedWhen, LogUpdatedBy, RowGUID, ToolUsage
            FROM         IdentificationUnitAnalysis
             * */
            iMessage.ShowCurrentStep("Creating the steps for the analysis\r\n|||||.....");
            DiversityWorkbench.Import.DataTable DTAnalysis = this.ImportWizardDataTable("IdentificationUnitAnalysis", DTUnits.TableAlias, "Analysis", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardUnitTables.IdentificationUnitAnalysis, "ToolID, ToolUsage", "");
            DTAnalysis.DataColumns["SpecimenPartID"].ForeignRelationTable = "CollectionSpecimenPart";
            DTAnalysis.DataColumns["SpecimenPartID"].SelectParallelForeignRelationTableAlias = true;
            DiversityWorkbench.Import.Step SAnalysis = DiversityWorkbench.Import.Step.GetStepTemplate(DTAnalysis, DiversityCollection.Specimen.ImageForTable(DTAnalysis.TableName, false), 2, false, null);
            IS.Add(DTAnalysis.PositionKey, SAnalysis);

            /*SELECT     CollectionSpecimenID, IdentificationUnitID, MethodID, AnalysisID, AnalysisNumber, LogCreatedWhen, LogCreatedBy, LogUpdatedWhen, LogUpdatedBy, 
            RowGUID
            FROM         IdentificationUnitAnalysisMethod*/
            try
            {
                DiversityWorkbench.Import.DataTable DTAnalysisMethod = this.ImportWizardDataTable("IdentificationUnitAnalysisMethod", DTAnalysis.TableAlias, "Method", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardUnitTables.IdentificationUnitAnalysis, "", "");
                DTAnalysisMethod.AddDatasource("MethodID", "SELECT M.MethodID AS Value, M.HierarchyDisplayText AS DisplayText " +
                    "FROM [dbo].[MethodHierarchyAll] () AS M WHERE MethodID IN (SELECT MethodID FROM MethodForAnalysis) " +
                    "ORDER BY M.DisplayText");
                if (DTAnalysisMethod.DataColumns.Count > 0)
                {
                    DTAnalysisMethod.DataColumns["AnalysisID"].IsSelected = true;
                    DTAnalysisMethod.DataColumns["AnalysisID"].TypeOfSource = DiversityWorkbench.Import.DataColumn.SourceType.ParentTable;
                    DiversityWorkbench.Import.Step SAnalysisMethod = DiversityWorkbench.Import.Step.GetStepTemplate(DTAnalysisMethod, DiversityCollection.Specimen.ImageForTable(DTAnalysisMethod.TableName, false), 3, false, null);
                    IS.Add(DTAnalysisMethod.PositionKey, SAnalysisMethod);
                }


                /*SELECT     CollectionSpecimenID, IdentificationUnitID, AnalysisID, AnalysisNumber, MethodID, ParameterID, Value, LogCreatedWhen, LogCreatedBy, LogUpdatedWhen, 
                LogUpdatedBy, RowGUID
                FROM         IdentificationUnitAnalysisMethodParameter*/
                DiversityWorkbench.Import.DataTable DTAnalysisMethodParameter = this.ImportWizardDataTable("IdentificationUnitAnalysisMethodParameter", DTAnalysisMethod.TableAlias, "Parameter", DiversityWorkbench.Import.DataTable.Parallelity.parallel, 1, "", "");
                if (DTAnalysisMethodParameter.DataColumns.Count > 0)
                {
                    DTAnalysisMethodParameter.DataColumns["MethodID"].TypeOfSource = DiversityWorkbench.Import.DataColumn.SourceType.ParentTable;
                    DTAnalysisMethodParameter.AddDatasource("MethodID", "SELECT M.MethodID AS Value, M.HierarchyDisplayText AS DisplayText " +
                        "FROM [dbo].[MethodHierarchyAll] () AS M WHERE MethodID IN (SELECT MethodID FROM MethodForAnalysis) " +
                        "ORDER BY DisplayText");
                    DTAnalysisMethodParameter.AddDatasource("ParameterID", "SELECT P.ParameterID AS Value, M.HierarchyDisplayText + ': ' + P.DisplayText AS DisplayText " +
                        "FROM [dbo].[MethodHierarchyAll] () AS M, Parameter AS P " +
                        "WHERE M.MethodID = P.MethodID AND M.MethodID IN (SELECT MethodID FROM MethodForAnalysis) " +
                        "ORDER BY DisplayText");
                    DiversityWorkbench.Import.Step SAnalysisMethodParameter = DiversityWorkbench.Import.Step.GetStepTemplate(DTAnalysisMethodParameter, DiversityCollection.Specimen.ImageForTable(DTAnalysisMethodParameter.TableName, false), 4, false, null);
                    IS.Add(DTAnalysisMethodParameter.PositionKey, SAnalysisMethodParameter);
                }
            }
            catch (System.Exception ex) { }

            DiversityWorkbench.Import.DataTable DTGeoAnalysis = this.ImportWizardDataTable("IdentificationUnitGeoAnalysis", DTUnits.TableAlias, "Geoanalysis", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardUnitTables.IdentificationUnitGeoAnalysis, "Geometry", "");
            DiversityWorkbench.Import.Step SGeoAnalysis = DiversityWorkbench.Import.Step.GetStepTemplate(DTGeoAnalysis, DiversityCollection.Specimen.ImageForTable(DTGeoAnalysis.TableName, false), 2, false, null);
            IS.Add(DTGeoAnalysis.PositionKey, SGeoAnalysis);

            this.ImportStepsUnitExternalIdentifier(ref IS, DTUnits.TableAlias);
            this.ImportStepsUnitAnnotation(ref IS, DTUnits.TableAlias);

        }

        private void ImportStepsUnitExternalIdentifier(ref System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS, string TableAlias)
        {
            try
            {
                DiversityWorkbench.Import.DataTable DTUnitExternalIdentifier = this.ImportWizardDataTable("ExternalIdentifier", TableAlias, "Identifier unit", DiversityWorkbench.Import.DataTable.Parallelity.referencing, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardPartTables.ExternalIdentifier, "", "");
                if (DTUnitExternalIdentifier.DataColumns.ContainsKey("ReferencedID"))
                {
                    DTUnitExternalIdentifier.DataColumns["ReferencedID"].ForeignRelationColumn = "IdentificationUnitID";
                    DTUnitExternalIdentifier.DataColumns["ReferencedID"].ForeignRelationTable = "IdentificationUnit";
                    DTUnitExternalIdentifier.DataColumns["ReferencedID"].ForeignRelationTableAlias = TableAlias;
                    DTUnitExternalIdentifier.DataColumns["ReferencedID"].TypeOfSource = DiversityWorkbench.Import.DataColumn.SourceType.ParentTable;
                    DTUnitExternalIdentifier.AddPresetValue("ReferencedTable", "IdentificationUnit");

                    DTUnitExternalIdentifier.DataColumns["Type"].IsSelected = true;
                    DTUnitExternalIdentifier.ParallelPositionForReferencingTable = 1;
                    DiversityWorkbench.Import.Step SUnitExternalIdentifier = DiversityWorkbench.Import.Step.GetStepTemplate(DTUnitExternalIdentifier, DiversityCollection.Specimen.ImageForTable("ExternalIdentifier", false), 2, false, null);
                    IS.Add(DTUnitExternalIdentifier.PositionKey, SUnitExternalIdentifier);
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void ImportStepsUnitAnnotation(ref System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS, string TableAlias)
        {
            try
            {
                DiversityWorkbench.Import.DataTable DTUnitAnnotation = this.ImportWizardDataTable("Annotation", TableAlias, "Annotation unit", DiversityWorkbench.Import.DataTable.Parallelity.referencing, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardPartTables.Annotation, "", "");
                if (DTUnitAnnotation.DataColumns.ContainsKey("ReferencedID"))
                {
                    DTUnitAnnotation.DataColumns["ReferencedID"].ForeignRelationColumn = "IdentificationUnitID";
                    DTUnitAnnotation.DataColumns["ReferencedID"].ForeignRelationTable = "IdentificationUnit";
                    DTUnitAnnotation.DataColumns["ReferencedID"].ForeignRelationTableAlias = TableAlias;
                    DTUnitAnnotation.DataColumns["ReferencedID"].TypeOfSource = DiversityWorkbench.Import.DataColumn.SourceType.ParentTable;
                    DTUnitAnnotation.AddPresetValue("ReferencedTable", "IdentificationUnit");
                    DTUnitAnnotation.ParallelPositionForReferencingTable = 1;
                    DiversityWorkbench.Import.Step SUnitAnnotation = DiversityWorkbench.Import.Step.GetStepTemplate(DTUnitAnnotation, DiversityCollection.Specimen.ImageForTable("Annotation", false), 2, false, null);
                    IS.Add(DTUnitAnnotation.PositionKey, SUnitAnnotation);
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }
        
        #endregion

        private System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.StepColumnGroup> ImportWizardColumnGroupsSpecimen(bool ForObservation)
        {
            //SELECT     CollectionSpecimenID, Version, CollectionEventID, CollectionID, AccessionNumber, AccessionDate, AccessionDay, AccessionMonth, AccessionYear, 
            //AccessionDateSupplement, AccessionDateCategory, DepositorsName, DepositorsAgentURI, DepositorsAccessionNumber, LabelTitle, LabelType, 
            //LabelTranscriptionState, LabelTranscriptionNotes, ExsiccataURI, ExsiccataAbbreviation, OriginalNotes, AdditionalNotes, ReferenceTitle, ReferenceURI, 
            //ReferenceDetails, Problems, DataWithholdingReason, InternalNotes, ExternalDatasourceID, ExternalIdentifier, LogCreatedWhen, LogCreatedBy, LogUpdatedWhen, 
            //LogUpdatedBy, RowGUID
            //FROM         CollectionSpecimen

            System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.StepColumnGroup> ColumnGroups = new Dictionary<string, DiversityWorkbench.Import.StepColumnGroup>();

            DiversityWorkbench.Import.StepColumnGroup Gref = this.ImportWizardStepColumnGroup("Reference",
                DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Reference, false),
                "ReferenceTitle, ReferenceURI, ReferenceDetails");
            ColumnGroups.Add(Gref.DisplayText, Gref);

            DiversityWorkbench.Import.StepColumnGroup GNotes = this.ImportWizardStepColumnGroup("Notes",
                DiversityCollection.Specimen.ImageForTable("Annotation", false),
                "OriginalNotes, AdditionalNotes, InternalNotes, Problems");
            ColumnGroups.Add(GNotes.DisplayText, GNotes);

            if (!ForObservation)
            {
                DiversityWorkbench.Import.StepColumnGroup Gaccession = this.ImportWizardStepColumnGroup("Accession",
                    DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Specimen, false),
                    "AccessionNumber, AccessionDate, AccessionDay, AccessionMonth, AccessionYear, AccessionDateSupplement, AccessionDateCategory");
                ColumnGroups.Add(Gaccession.DisplayText, Gaccession);

                DiversityWorkbench.Import.StepColumnGroup GDepositor = this.ImportWizardStepColumnGroup("Depositor",
                    DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Agent, false),
                    "DepositorsName, DepositorsAgentURI, DepositorsAccessionNumber");
                ColumnGroups.Add(GDepositor.DisplayText, GDepositor);

                DiversityWorkbench.Import.StepColumnGroup GLabel = this.ImportWizardStepColumnGroup("Label",
                    DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Label, false),
                    "LabelTitle, LabelType, LabelTranscriptionState, LabelTranscriptionNotes");
                ColumnGroups.Add(GLabel.DisplayText, GLabel);
            }
            return ColumnGroups;
        }

        #endregion

        #region Analysis

        private enum ImportWizardAnalysisTables { AnalysisResult, ProjectAnalysis, AnalysisTaxonomicGroup, MethodForAnalysis };

        private System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> ImportStepsAnalysis
        {
            get
            {
                System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS = new Dictionary<string, DiversityWorkbench.Import.Step>();

                DiversityWorkbench.Import.DataTable DT = this.ImportWizardDataTable("Analysis", "", "Analysis", DiversityWorkbench.Import.DataTable.Parallelity.unique, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.Analysis, "AnalysisToolID", "AnalysisID, DisplayText");
                DiversityWorkbench.Import.Step S = DiversityWorkbench.Import.Step.GetStepTemplate(DT, DiversityCollection.Specimen.ImageForTable(DT.TableName, false), 0, true, null);
                S.MustSelect = true;
                IS.Add(DT.PositionKey, S);

                DiversityWorkbench.Import.DataTable DTResult = this.ImportWizardDataTable("AnalysisResult", DT.TableAlias, "Result", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardAnalysisTables.AnalysisResult, "", "");
                DTResult.ParentTableAlias = DT.TableAlias;
                DiversityWorkbench.Import.Step SResult = DiversityWorkbench.Import.Step.GetStepTemplate(DTResult, DiversityCollection.Specimen.ImageForTable(DT.TableName, false), 1, false, null);
                IS.Add(DTResult.PositionKey, SResult);

                DiversityWorkbench.Import.DataTable DTProject = this.ImportWizardDataTable("ProjectAnalysis", DT.TableAlias, "Project", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardAnalysisTables.ProjectAnalysis, "", "");
                DTProject.ParentTableAlias = DT.TableAlias;
                DTProject.Image = DiversityCollection.Specimen.ImageForTable("CollectionProject", false);
                DTProject.AddDatasource("ProjectID", "SELECT ProjectID AS Value, Project AS DisplayText " +
                    "FROM ProjectProxy " +
                    "ORDER BY DisplayText ");
                DiversityWorkbench.Import.Step SProject = DiversityWorkbench.Import.Step.GetStepTemplate(DTProject, DiversityCollection.Specimen.ImageForTable("CollectionProject", false), 1, false, null);
                IS.Add(DTProject.PositionKey, SProject);

                DiversityWorkbench.Import.DataTable DTTaxa = this.ImportWizardDataTable("AnalysisTaxonomicGroup", DT.TableAlias, "Taxonomic groups", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardAnalysisTables.AnalysisTaxonomicGroup, "", "");
                DTTaxa.AddDatasource("TaxonomicGroup", "SELECT DisplayText, Code AS Value FROM CollTaxonomicGroup_Enum ORDER BY DisplayText");
                DTTaxa.ParentTableAlias = DT.TableAlias;
                DTTaxa.Image = DiversityCollection.Specimen.ImageForTable("IdentificationUnit", false);
                DiversityWorkbench.Import.Step STaxa = DiversityWorkbench.Import.Step.GetStepTemplate(DTTaxa, DiversityCollection.Specimen.ImageForTable("IdentificationUnit", false), 1, false, null);
                IS.Add(DTTaxa.PositionKey, STaxa);

                DiversityWorkbench.Import.DataTable DTMethod = this.ImportWizardDataTable("MethodForAnalysis", DT.TableAlias, "Methods", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardAnalysisTables.MethodForAnalysis, "", "");
                DTMethod.AddDatasource("MethodID", "SELECT MethodID AS Value, DisplayText FROM Method ORDER BY DisplayText ORDER BY DisplayText");
                DTMethod.ParentTableAlias = DT.TableAlias;
                DTMethod.Image = DiversityCollection.Specimen.ImageForTable("Method", false);
                DiversityWorkbench.Import.Step SMethod = DiversityWorkbench.Import.Step.GetStepTemplate(DTMethod, DiversityCollection.Specimen.ImageForTable("Method", false), 1, false, null);
                IS.Add(DTMethod.PositionKey, SMethod);

                return IS;
            }
        }
        
        #endregion

        #region Collection

        private enum ImportWizardCollectionTables { CollectionImage };

        private System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> ImportStepsCollection
        {
            get
            {
                /*SELECT     CollectionID, CollectionParentID, CollectionName, CollectionAcronym, AdministrativeContactName, AdministrativeContactAgentURI, Description, Location, 
                CollectionOwner, DisplayOrder, LogCreatedWhen, LogCreatedBy, LogUpdatedWhen, LogUpdatedBy, RowGUID
                FROM         Collection*/

                System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS = new Dictionary<string, DiversityWorkbench.Import.Step>();

                //TODO: Attachment ueber CollectionID klappt nicht
                DiversityWorkbench.Import.DataTable DT = this.ImportWizardDataTable("Collection", "", "Collection", DiversityWorkbench.Import.DataTable.Parallelity.unique, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.Collection, "", /*"CollectionID,*/ "CollectionName, CollectionAcronym");
                DiversityWorkbench.Import.Step S = DiversityWorkbench.Import.Step.GetStepTemplate(DT, DiversityCollection.Specimen.ImageForTable(DT.TableName, false), 0, true, null);
                S.MustSelect = true;
                IS.Add(DT.PositionKey, S);

                System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.StepColumnGroup> ColumnGroups = new Dictionary<string, DiversityWorkbench.Import.StepColumnGroup>();

                DiversityWorkbench.Import.StepColumnGroup GCreator = this.ImportWizardStepColumnGroup("Creator",
                    DiversityCollection.Specimen.ImageForTable("CollectionAgent", false),
                    "CreatorAgent, CreatorAgentURI, IPR, CopyrightStatement, LicenseType");
                ColumnGroups.Add(GCreator.DisplayText, GCreator);

                DiversityWorkbench.Import.DataTable DTImage = this.ImportWizardDataTable("CollectionImage", DT.TableAlias, "Image", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardCollectionTables.CollectionImage, "", "");
                DTImage.ParentTableAlias = DT.TableAlias;
                DiversityWorkbench.Import.Step SImage = DiversityWorkbench.Import.Step.GetStepTemplate(DTImage, DiversityCollection.Specimen.ImageForTable(DTImage.TableName, false), 1, false, ColumnGroups);
                IS.Add(DTImage.PositionKey, SImage);

                return IS;
            }
        }

        #endregion

        #region Method

        private enum ImportWizardMethodTables { MethodForAnalysis, MethodForProcessing, Parameter };

        private System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> ImportStepsMethod
        {
            get
            {
                /*SELECT     CollectionID, CollectionParentID, CollectionName, CollectionAcronym, AdministrativeContactName, AdministrativeContactAgentURI, Description, Location, 
                CollectionOwner, DisplayOrder, LogCreatedWhen, LogCreatedBy, LogUpdatedWhen, LogUpdatedBy, RowGUID
                FROM         Collection*/

                System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS = new Dictionary<string, DiversityWorkbench.Import.Step>();

                DiversityWorkbench.Import.DataTable DT = this.ImportWizardDataTable("Method", "", "Method", DiversityWorkbench.Import.DataTable.Parallelity.unique, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.Method, "", "CollectionName, CollectionAcronym");
                DiversityWorkbench.Import.Step S = DiversityWorkbench.Import.Step.GetStepTemplate(DT, DiversityCollection.Specimen.ImageForTable(DT.TableName, false), 0, true, null);
                S.MustSelect = true;
                IS.Add(DT.PositionKey, S);

                DiversityWorkbench.Import.DataTable DTAnalysis = this.ImportWizardDataTable("MethodForAnalysis", DT.TableAlias, "Analysis", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMethodTables.MethodForAnalysis, "", "");
                DTAnalysis.ParentTableAlias = DT.TableAlias;
                DiversityWorkbench.Import.Step SAnalysis = DiversityWorkbench.Import.Step.GetStepTemplate(DTAnalysis, DiversityCollection.Specimen.ImageForTable(DTAnalysis.TableName, false), 1, false, null);
                IS.Add(DTAnalysis.PositionKey, SAnalysis);

                DiversityWorkbench.Import.DataTable DTProcessing = this.ImportWizardDataTable("MethodForProcessing", DT.TableAlias, "Processing", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMethodTables.MethodForProcessing, "", "");
                DTAnalysis.ParentTableAlias = DT.TableAlias;
                DiversityWorkbench.Import.Step SProcessing = DiversityWorkbench.Import.Step.GetStepTemplate(DTProcessing, DiversityCollection.Specimen.ImageForTable(DTProcessing.TableName, false), 1, false, null);
                IS.Add(DTProcessing.PositionKey, SProcessing);

                DiversityWorkbench.Import.DataTable DTParameter = this.ImportWizardDataTable("Parameter", DT.TableAlias, "Parameter", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMethodTables.Parameter, "", "");
                DTAnalysis.ParentTableAlias = DT.TableAlias;
                DiversityWorkbench.Import.Step SParameter = DiversityWorkbench.Import.Step.GetStepTemplate(DTParameter, DiversityCollection.Specimen.ImageForTable(DTParameter.TableName, false), 1, false, null);
                IS.Add(DTParameter.PositionKey, SParameter);

                DiversityWorkbench.Import.DataTable DTParameterValue_Enum = this.ImportWizardDataTable("ParameterValue_Enum", DTParameter.TableAlias, "Value", DiversityWorkbench.Import.DataTable.Parallelity.parallel, 1, "", "");
                DTAnalysis.ParentTableAlias = DT.TableAlias;
                DiversityWorkbench.Import.Step SParameterValue_Enum = DiversityWorkbench.Import.Step.GetStepTemplate(DTParameterValue_Enum, DiversityCollection.Specimen.ImageForTable(DTParameterValue_Enum.TableName, false), 2, false, null);
                IS.Add(DTParameterValue_Enum.PositionKey, SParameterValue_Enum);

                return IS;
            }
        }

        #endregion

        #region Processing

        private enum ImportWizardProcessingTables { ProcessingMaterialCategory };

        private System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> ImportStepsProcessing
        {
            get
            {
                System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS = new Dictionary<string, DiversityWorkbench.Import.Step>();

                DiversityWorkbench.Import.DataTable DT = this.ImportWizardDataTable("Processing", "", "Processing", DiversityWorkbench.Import.DataTable.Parallelity.unique, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.Processing, "ProcessingGroup", "ProcessingID, DisplayText");
                DiversityWorkbench.Import.Step S = DiversityWorkbench.Import.Step.GetStepTemplate(DT, DiversityCollection.Specimen.ImageForTable(DT.TableName, false), 0, true, null);
                S.MustSelect = true;
                IS.Add(DT.PositionKey, S);

                DiversityWorkbench.Import.DataTable DTMaterialCategory = this.ImportWizardDataTable("ProcessingMaterialCategory", DT.TableAlias, "Material", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardProcessingTables.ProcessingMaterialCategory, "", "");
                DTMaterialCategory.AddDatasource("MaterialCategory", "SELECT DisplayText, Code AS Value FROM CollMaterialCategory_Enum ORDER BY DisplayText");
                DTMaterialCategory.ParentTableAlias = DT.TableAlias;
                DTMaterialCategory.Image = DiversityCollection.Specimen.ImageForTable("CollectionSpecimenPart", false);
                DiversityWorkbench.Import.Step SMaterialCategory = DiversityWorkbench.Import.Step.GetStepTemplate(DTMaterialCategory, DiversityCollection.Specimen.ImageForTable("CollectionSpecimenPart", false), 1, false, null);
                IS.Add(DTMaterialCategory.PositionKey, SMaterialCategory);

                return IS;
            }
        }

        #endregion

        #region Transaction

        private enum ImportWizardTransactionTables { TransactionDocument, TransactionAgent, TransactionPayment, Identifier };

        private System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> ImportStepsTransaction
        {
            get
            {
                /*SELECT     TransactionID, ParentTransactionID, TransactionType, TransactionTitle, ReportingCategory, AdministratingCollectionID, MaterialDescription, MaterialCategory, 
                MaterialCollectors, FromCollectionID, FromTransactionPartnerName, FromTransactionPartnerAgentURI, FromTransactionNumber, ToCollectionID, 
                ToTransactionPartnerName, ToTransactionPartnerAgentURI, ToTransactionNumber, NumberOfUnits, Investigator, TransactionComment, BeginDate, AgreedEndDate, 
                ActualEndDate, InternalNotes, ResponsibleName, ResponsibleAgentURI, LogCreatedWhen, LogCreatedBy, LogUpdatedWhen, LogUpdatedBy, xx_ProjectID, 
                RowGUID
                FROM         [Transaction]*/

                System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.Step> IS = new Dictionary<string, DiversityWorkbench.Import.Step>();

                DiversityWorkbench.Import.DataTable DT = this.ImportWizardDataTable("Transaction", "", "Transaction", DiversityWorkbench.Import.DataTable.Parallelity.unique, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.Transaction, "", "TransactionTitle, TransactionID");
                DT.AddDatasource("AdministratingCollectionID", ImportWizardCollectionList);
                DT.AddDatasource("FromCollectionID", ImportWizardCollectionList);
                DT.AddDatasource("ToCollectionID", ImportWizardCollectionList);

                System.Collections.Generic.Dictionary<string, DiversityWorkbench.Import.StepColumnGroup> ColumnGroups = new Dictionary<string, DiversityWorkbench.Import.StepColumnGroup>();

                DiversityWorkbench.Import.StepColumnGroup Gdate = this.ImportWizardStepColumnGroup("Date",
                DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.DateTime, false),
                "BeginDate, AgreedEndDate, ActualEndDate, DateSupplement");
                ColumnGroups.Add(Gdate.DisplayText, Gdate);

                DiversityWorkbench.Import.StepColumnGroup Gnotes = this.ImportWizardStepColumnGroup("Material & notes",
                DiversityCollection.Specimen.ImageForTable("annotation", false),
                "MaterialDescription, MaterialCategory, MaterialCollectors, InternalNotes, TransactionComment");
                ColumnGroups.Add(Gnotes.DisplayText, Gnotes);

                DiversityWorkbench.Import.StepColumnGroup Gresponsible = this.ImportWizardStepColumnGroup("Responsible",
                DiversityCollection.Specimen.ImageForTableOrField(Specimen.ImageTableOrField.Agent, false),
                "ResponsibleName, ResponsibleAgentURI, Investigator, ToRecipient");
                ColumnGroups.Add(Gresponsible.DisplayText, Gresponsible);

                DiversityWorkbench.Import.Step S = DiversityWorkbench.Import.Step.GetStepTemplate(DT, DiversityCollection.Specimen.ImageForTable(DT.TableName, false), 0, true, ColumnGroups);
                S.MustSelect = true;
                IS.Add(DT.PositionKey, S);

                /*SELECT     TransactionID, Date, TransactionText, TransactionDocument, InternalNotes, LogCreatedWhen, LogCreatedBy, LogUpdatedWhen, LogUpdatedBy, RowGUID
                FROM         TransactionDocument
                 * */

                DiversityWorkbench.Import.DataTable DTTransactionDocument = this.ImportWizardDataTable("TransactionDocument", DT.TableAlias, "Document", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardTransactionTables.TransactionDocument, "", "");
                DTTransactionDocument.ParentTableAlias = DT.TableAlias;
                DiversityWorkbench.Import.Step STransactionDocument = DiversityWorkbench.Import.Step.GetStepTemplate(DTTransactionDocument, DiversityCollection.Specimen.ImageForTable(DTTransactionDocument.TableName, false), 1, false, null);
                IS.Add(DTTransactionDocument.PositionKey, STransactionDocument);

                DiversityWorkbench.Import.DataTable DTTransactionAgent = this.ImportWizardDataTable("TransactionAgent", DT.TableAlias, "Agent", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardTransactionTables.TransactionAgent, "", "");
                DTTransactionAgent.ParentTableAlias = DT.TableAlias;
                DiversityWorkbench.Import.Step STransactionAgent = DiversityWorkbench.Import.Step.GetStepTemplate(DTTransactionAgent, DiversityCollection.Specimen.ImageForTable(DTTransactionAgent.TableName, false), 1, false, null);
                IS.Add(DTTransactionAgent.PositionKey, STransactionAgent);

                DiversityWorkbench.Import.DataTable DTTransactionPayment = this.ImportWizardDataTable("TransactionPayment", DT.TableAlias, "Payment", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardTransactionTables.TransactionPayment, "", "");
                DTTransactionPayment.ParentTableAlias = DT.TableAlias;
                DiversityWorkbench.Import.Step STransactionPayment = DiversityWorkbench.Import.Step.GetStepTemplate(DTTransactionPayment, DiversityCollection.Specimen.ImageForTable(DTTransactionPayment.TableName, false), 1, false, null);
                IS.Add(DTTransactionPayment.PositionKey, STransactionPayment);

                DiversityWorkbench.Import.DataTable DTTransactionIdentifier = this.ImportWizardDataTable("ExternalIdentifier", "Transaction", "Identifier", DiversityWorkbench.Import.DataTable.Parallelity.referencing, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.ExternalIdentifier, "", "");
                DTTransactionIdentifier.DataColumns["ReferencedID"].ForeignRelationColumn = "TransactionID";
                DTTransactionIdentifier.DataColumns["ReferencedID"].ForeignRelationTable = "Transaction";
                DTTransactionIdentifier.DataColumns["ReferencedID"].ForeignRelationTableAlias = "Transaction";
                DTTransactionIdentifier.DataColumns["ReferencedID"].TypeOfSource = DiversityWorkbench.Import.DataColumn.SourceType.ParentTable;

                DTTransactionIdentifier.AddPresetValue("ReferencedTable", "Transaction");

                DiversityWorkbench.Import.Step STransactionIdentifier = DiversityWorkbench.Import.Step.GetStepTemplate(DTTransactionIdentifier, DiversityCollection.Specimen.ImageForTable("ExternalIdentifier", false), 1, false, null);
                IS.Add(DTTransactionIdentifier.PositionKey, STransactionIdentifier);

                //DiversityWorkbench.Import.DataTable DTTransactionAnnotation = this.ImportWizardDataTable("Annotation", "Transaction", "Annotation", DiversityWorkbench.Import.DataTable.Parallelity.parallel, (int)DiversityCollection.FormCollectionSpecimen.ImportWizardMainTables.Annotation, "", "");
                //DTTransactionAnnotation.DataColumns["ReferencedID"].ForeignRelationColumn = "TransactionID";
                //DTTransactionAnnotation.DataColumns["ReferencedID"].ForeignRelationTable = "Transaction";
                //DTTransactionAnnotation.DataColumns["ReferencedID"].ForeignRelationTableAlias = "Transaction";

                //DTTransactionIdentifier.AddPresetValue("ReferencedTable", "Transaction");
                //DiversityWorkbench.Import.Step STransactionAnnotation = DiversityWorkbench.Import.Step.GetStepTemplate(DTTransactionIdentifier, DiversityCollection.Specimen.ImageForTable("Annotation", false), 1, false, null);
                //IS.Add(DTTransactionIdentifier.PositionKey, STransactionAnnotation);

                return IS;
            }
        }

        #endregion

        #region Common functions

        private DiversityWorkbench.Import.StepColumnGroup ImportWizardStepColumnGroup(string DisplayText, System.Drawing.Image Image, string Columns)
        {
            System.Collections.Generic.List<string> L = new List<string>();
            Columns = Columns.Replace(" ", "");
            string[] CC = Columns.Split(new char[] { ',' });
            for (int i = 0; i < CC.Length; i++)
                L.Add(CC[i]);
            DiversityWorkbench.Import.StepColumnGroup G = new DiversityWorkbench.Import.StepColumnGroup(Image, DisplayText, L);
            return G;
        }

        private DiversityWorkbench.Import.DataTable ImportWizardDataTable(string TableName, string ParentTableAlias, string DisplayText, DiversityWorkbench.Import.DataTable.Parallelity P, int SequencePosition, string IgnoredColumns, string AttachmentColumns)
        { //1
            System.Collections.Generic.List<string> lAC = new List<string>();
            AttachmentColumns = AttachmentColumns.Replace(" ", "");
            string[] ACC = AttachmentColumns.Split(new char[] { ',' });
            for (int i = 0; i < ACC.Length; i++)
                lAC.Add(ACC[i]);
            System.Collections.Generic.List<string> IC = new List<string>();
            IgnoredColumns = IgnoredColumns.Replace(" ", "");
            string[] CC = IgnoredColumns.Split(new char[] { ',' });
            for (int i = 0; i < CC.Length; i++)
                IC.Add(CC[i]);
            DiversityWorkbench.Import.DataTable DT = DiversityWorkbench.Import.DataTable.GetTableTemplate(TableName, ParentTableAlias, DisplayText, DiversityCollection.Specimen.ImageForTable(TableName, false), P, SequencePosition, IC, lAC);
            return DT;
        }

        private readonly string ImportWizardCollectionList = "SELECT DisplayText, CollectionID AS Value FROM [dbo].[CollectionHierarchyAll] () ORDER BY DisplayText";

        #endregion

        #endregion

        #region Datawithholding reason - control setting

        private void initDataWithholdingControls()
        {
            try
            {
                this.comboBoxHeaderDataWithholdingReason_TextChanged(null, null);
                this.comboBoxSpecimenImageWithholdingReason_TextChanged(null, null);
                this.comboBoxEventSeriesImageWithholdingReason_TextChanged(null, null);
                this.comboBoxEventImageDataWithholdingReason_TextChanged(null, null);
                this.comboBoxDataWithholdingReasonEvent_TextChanged(null, null);
                this.comboBoxCollectorDataWithholdingReason_TextChanged(null, null);
                this.setUnitDatawithholding();
                this.textBoxPartWithhold_TextChanged(null, null);
                this.setCollectionDateWithholding();
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }
        
        private void comboBoxHeaderDataWithholdingReason_TextChanged(object sender, EventArgs e)
        {
            this.SetDataWithholdingControl(this.comboBoxHeaderDataWithholdingReason, this.pictureBoxWithholdSpecimen);
        }

        private void comboBoxSpecimenImageWithholdingReason_TextChanged(object sender, EventArgs e)
        {
            this.SetDataWithholdingControl(this.comboBoxSpecimenImageWithholdingReason, this.pictureBoxSpecimenImageWithholdingReason);
        }

        private void comboBoxEventSeriesImageWithholdingReason_TextChanged(object sender, EventArgs e)
        {
            this.SetDataWithholdingControl(this.comboBoxEventSeriesImageWithholdingReason, this.pictureBoxEventSeriesImageWithholdingReason);
        }

        private void comboBoxEventImageDataWithholdingReason_TextChanged(object sender, EventArgs e)
        {
            this.SetDataWithholdingControl(this.comboBoxEventImageDataWithholdingReason, this.pictureBoxWithholdEventImage);
        }

        private void comboBoxDataWithholdingReasonEvent_TextChanged(object sender, EventArgs e)
        {
            this.SetDataWithholdingControl(this.comboBoxDataWithholdingReasonEvent, this.pictureBoxWithholdingReasonEvent);
        }

        private void comboBoxCollectorDataWithholdingReason_TextChanged(object sender, EventArgs e)
        {
            this.SetDataWithholdingControl(this.comboBoxCollectorDataWithholdingReason, this.pictureBoxCollectorDataWithholdingReason);
        }

        private void textBoxPartWithhold_TextChanged(object sender, EventArgs e)
        {
            if (this.textBoxPartWithhold.AutoCompleteCustomSource == null 
                || this.textBoxPartWithhold.AutoCompleteCustomSource.Count == 0)
            {
                try
                {
                    string SQL = "SELECT DISTINCT S.DataWithholdingReason " +
                        "FROM CollectionSpecimenPart AS S ";
                    if (this.userControlQueryList.ProjectIsSelected)
                    {
                        SQL += " INNER JOIN CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID WHERE P.ProjectID = " +
                            this.userControlQueryList.ProjectID.ToString() + " AND ";
                    }
                    else
                        SQL += " WHERE ";
                    SQL += "S.DataWithholdingReason <> N'' ORDER BY S.DataWithholdingReason";
                    System.Data.DataTable dt = new DataTable();
                    string Message = "";
                    DiversityWorkbench.FormFunctions.SqlFillTable(SQL, ref dt, ref Message);
                    System.Windows.Forms.AutoCompleteStringCollection Source = new AutoCompleteStringCollection();
                    foreach (System.Data.DataRow RP in dt.Rows)
                    {
                        Source.Add(RP["DataWithholdingReason"].ToString());
                    }
                    this.textBoxPartWithhold.AutoCompleteMode = AutoCompleteMode.SuggestAppend;
                    this.textBoxPartWithhold.AutoCompleteSource = AutoCompleteSource.CustomSource;
                    this.textBoxPartWithhold.AutoCompleteCustomSource = Source;
                }
                catch (System.Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
            this.SetDataWithholdingControl(this.textBoxPartWithhold, this.pictureBoxWithholdPart);
        }

        private void textBoxPartWithhold_Leave(object sender, EventArgs e)
        {
            if (this.textBoxPartWithhold.AutoCompleteCustomSource != null &&
                !this.textBoxPartWithhold.AutoCompleteCustomSource.Contains(this.textBoxPartWithhold.Text))
            {
                this.textBoxPartWithhold.AutoCompleteCustomSource.Add(this.textBoxPartWithhold.Text);
            }
        }

        private void SetDataWithholdingControl(System.Windows.Forms.Control C, System.Windows.Forms.PictureBox PB)
        {
            if (C.Text.Trim().Length == 0 && C.Text.Length > 0)
                C.Text = "";
            if (C.Text.Length > 0)
            {
                C.BackColor = System.Drawing.Color.Pink;
                PB.Image = this.imageListDataWithholding.Images[0];
                this.toolTip.SetToolTip(PB, "Data withheld");
            }
            else
            {
                C.BackColor = System.Drawing.Color.White;
                PB.Image = this.imageListDataWithholding.Images[1];
                this.toolTip.SetToolTip(PB, "Data will be published, not withheld");
            }
        }

        private void setCollectionDateWithholding()
        {
            try
            {
                string Reason = "";
                if (this.collectionEventBindingSource.Current != null)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventBindingSource.Current;
                    if (!R["DataWithholdingReasonDate"].Equals(System.DBNull.Value) && R["DataWithholdingReasonDate"].ToString().Length > 0)
                    {
                        Reason = R["DataWithholdingReasonDate"].ToString();
                    }
                }
                string Tooltip = "";
                if (Reason.Length > 0)
                {
                    this.buttonWithholdingReasonCollectionDate.Image = this.imageListDataWithholding.Images[0];
                    Tooltip = "Reason for withholding the collection date: " + Reason;
                }
                else
                {
                    this.buttonWithholdingReasonCollectionDate.Image = this.imageListDataWithholding.Images[1];
                    Tooltip = "Collection date not withheld";
                }
                this.toolTip.SetToolTip(this.buttonWithholdingReasonCollectionDate, Tooltip);
            }
            catch (System.Exception ex)
            { }
        }

        private void buttonWithholdingReasonCollectionDate_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.collectionEventBindingSource.Current != null)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.collectionEventBindingSource.Current;
                    System.Data.DataTable dt = new DataTable();
                    string Reason = "";
                    if (!R["DataWithholdingReasonDate"].Equals(System.DBNull.Value))
                        Reason = R["DataWithholdingReasonDate"].ToString();//DiversityWorkbench.FormFunctions.SqlExecuteScalar(SQL);
                    string SQL = "SELECT DISTINCT DataWithholdingReasonDate FROM CollectionEvent WHERE DataWithholdingReasonDate <> '' ORDER BY DataWithholdingReasonDate";
                    System.Data.SqlClient.SqlDataAdapter ad = new System.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(dt);
                    DiversityWorkbench.FormGetStringFromList f = new DiversityWorkbench.FormGetStringFromList(dt, "DataWithholdingReasonDate", "DataWithholdingReasonDate", "Withhold date", "Please enter the reason for withholding the collection date", Reason, false);
                    f.ShowDialog();
                    if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                    {
                        R["DataWithholdingReasonDate"] = f.String;
                        this.setCollectionDateWithholding();
                    }
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        #endregion

        #region Interface

        public void SetHeight(int Height)
        {
            this.splitContainerUserContols.SplitterDistance = this.splitContainerUserContols.Height - (int)(DiversityWorkbench.FormFunctions.DisplayZoomFactor * Height); ;// (int)this.Height / 2;
            this.splitContainerUserContols.Panel2Collapsed = false;
        }

        public DiversityWorkbench.WorkbenchUnit.ModuleType GetModuleType()
        {
            return DiversityWorkbench.WorkbenchUnit.ModuleType.Collection;
        }
        
        #endregion

    }
}