#define NAGOYA_TEST

using DiversityWorkbench;
using DiversityWorkbench.DwbManual;
using DWBServices;
using DWBServices.WebServices;
using DWBServices.WebServices.TaxonomicServices;
using System;
using System.Collections.Generic;
using System.Data;
using System.Diagnostics;
using System.Drawing;
using System.Windows.Forms;

namespace DiversityCollection.Forms
{
    public partial class FormMaintenance : Form
    {
        #region Parameter

        private int _CollectionSpecimenID;
        private System.Collections.Generic.List<int> _CollectionSpecimenIDs;
        private bool _ShowList;
        private string _ShowListQueryHeader;
        private string _ShowListQueryDescription;

        private DiversityWorkbench.Forms.FormFunctions _FormFunctions;
        private System.Data.DataTable _dtSynColTax;
        private System.Data.DataTable _dtSynColTaxText;
        private System.Data.DataTable _dtSynColTaxHierarchy;
        private System.Data.DataTable _dtSynUnitTerms;
        private System.Data.DataTable _dtSynUnitTermsText;
        private System.Data.DataTable _dtSynColExs;
        private System.Data.DataTable _dtSynColPlot;
        private System.Data.DataTable _dtSynColTerm;
        private System.Data.DataTable _dtPartDesc;
        private System.Data.DataTable _dtSynColGaz;
        private System.Data.DataTable _dtSynColGazTK25;
        private System.Data.DataTable _dtSynColRef;
        private System.Data.DataTable _dtSynColAge;
        private System.Data.DataTable _dtSynColAgeText;
        private System.Data.DataTable _dtSynColAgeTextCollisions;
        private System.Data.DataTable _dtSynColAgeSplit;
        private System.Data.DataTable _dtSynColAgeSplitCollisions;
        private System.Data.DataTable _dtCollectionProjects;
        private System.Data.DataTable _dtCollectionProjectsWithNull;
        private System.Data.DataTable _dtSamplingPlotToLocalityProjects;
        private System.Data.DataTable _dtTK25Projects;

        private System.Data.DataTable _dtAccNrDuplicates;

        private System.Data.DataTable _dtEvents;
        private System.Data.DataTable _dtCountry;
        private System.Data.DataTable _dtPlace;
        private System.Data.DataTable _dtAltitude;

        private System.Data.DataTable _dtCoordinates;
        private System.Data.DataTable _dtCoordinateCalculation;
        private LookupTable.CoordinateSystem _ResultCoordinateSystem;
        private System.Windows.Forms.DataGridViewCellStyle _StyleOK;
        private System.Windows.Forms.DataGridViewCellStyle _StyleBlocked;
        private System.Windows.Forms.DataGridViewCellStyle _StyleError;
        private System.Windows.Forms.DataGridViewCellStyle _StyleUpdated;
        private System.Windows.Forms.DataGridViewCellStyle _StyleNotOK;

        private enum _SynColGazType { Place, Coordinates, TK25, Geography, Country, Nation };
        private enum _SynColTermsType { Term, Hierarchy };

        private string _SynchronizeColTaxTextTaxonDatabase;
        private string _SynchronizeColTaxTextConnectionString;
        private bool? _SynchronizeColTaxTextSameServer;
        private string _SynchronizeColTaxTextBaseURL;
        private string _SynchronizeColTaxTextLinkedServer;
        private string _SynchronizeTK25BaseURL;

        private System.Collections.Generic.Dictionary<string, System.Data.DataTable> _SynColTaxTextNameLists;

        private string _SynchronizeColUnitTermsTextDatabase;
        private string _SynchronizeColUnitTermsTextConnectionString;
        private string _SynchronizeColUnitTermsTextLinkedServer;
        private string _SynchronizeColUnitTermsTextBaseURL;
        private System.Collections.Generic.Dictionary<string, System.Data.DataTable> _SynColUnitTermsTextNameLists;

        public enum Maintenance { StorageMissingUnit }

        //private enum _SynColGazQuery { Select, Update };

        //private enum _SynColPlotType { DisplayText, Geography, Accuracy, Coordinates, Altitude, Country };

        #endregion

        #region Construction

        public FormMaintenance()
        {
            InitializeComponent();
            this.initForm();
            this.setDatabases();
            try
            {
                if (DiversityCollection.Forms.FormMaintenanceSettings.Default.SynColTaxDatabase.Length > 0)
                {
                    this.comboBoxSynColTaxDatabase.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.SynColTaxDatabase;
                    this.comboBoxSynColTaxFamOrdDatabase.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.SynColTaxDatabase;
                    this.comboBoxSynColTaxTextDatabase.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.SynColTaxDatabase;
                    this.comboBoxAcceptedNameTaxonomySource.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.SynColTaxDatabase;
                }
                if (DiversityCollection.Forms.FormMaintenanceSettings.Default.Project.Length > 0)
                {
                    this.comboBoxSynColTaxProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxSynColRefProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxSynColGazProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxSynColExsProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxSynColPlotProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxSynColTaxFamOrdProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxSynFamOrdProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxSynColTaxTextProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxAccNrDuplicatesProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxBulkProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxSetPlaceProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    //this.comboBoxUnrelatedEventSeriesProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxAccNrDuplicatesProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxSynColAgeSplitCollectorsProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxGazetteerForProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxNagoyaProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxAnalysisProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxCheckRetrievalProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                    this.comboBoxGeographyInAreaProject.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Project;
                }

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            this.InitUnrelatedEvents();
            // online manual
            this.helpProvider.HelpNamespace = DiversityWorkbench.WorkbenchResources.WorkbenchDirectory.HelpProviderNameSpace();
        }

        public FormMaintenance(Maintenance MaintenanceTarget, int? ProjectID = null) : this()
        {
            this.tabControlMain.TabPages.Remove(this.tabPageSynchronize);
            this.tabControlMain.TabPages.Remove(this.tabPageUnrelatedEventSeries);
            this.tabControlMain.TabPages.Remove(this.tabPageEvents);
            this.tabControlMain.TabPages.Remove(this.tabPageSpecimen);
            this.tabControlMain.TabPages.Remove(this.tabPageUnit);
            this.tabControlMain.TabPages.Remove(this.tabPageBulkInserts);
            this.tabControlMain.TabPages.Remove(this.tabPageAnalysis);
            this.tabControlMain.TabPages.Remove(this.tabPageImages);
            this.tabControlMain.TabPages.Remove(this.tabPageRegulations);
            this.tabControlMain.TabPages.Remove(this.tabPageAnnotations);
            this.tabControlMain.TabPages.Remove(this.tabPageIdentifier);
            this.tabControlMain.TabPages.Remove(this.tabPageTools);

            this.tabControlStorage.TabPages.Remove(this.tabPageStorageLocationLastIdentification);

            if (ProjectID != null)
            {
                int i = 0;
                foreach (System.Data.DataRow R in this._dtCollectionProjects.Rows)
                {
                    if (R["ProjectID"].ToString() == ProjectID.ToString())
                    {
                        this.comboBoxPrintProject.SelectedIndex = i;
                        break;
                    }
                    i++;
                }
            }
        }

        #endregion

        #region Form

        private void initForm()
        {
            try
            {
                //TODO: Wieder einbauen wenn fertig (folgenden Code loeschen)
#if !DEBUG
                this.tabControlCoordinates.TabPages.Remove(this.tabPageCoordinatesOutside);

                //this.tabControlSynchronize.TabPages.Remove(this.tabPageCollPartDescriptions);

                //this.tabControlSynchronize.TabPages.Remove(this.tabPageUnitTerms);
                //this.tabControlSynUnitTerms.TabPages.Remove(this.tabPageSynUnitTermsText);
                //this.tabControlSynUnitTerms.TabPages.Remove(this.tabPageSynUnitTermsLinked);
                this.tabControlTaxonNames.TabPages.Remove(this.tabPageTaxonRemoveWrongNameURI);
                //this.tabControlCollectionEvent.TabPages.Remove(this.tabPageMergeEvents);
#endif

#if DEBUG
                this.checkBoxSynColTaxTextViaCacheDB.Visible = true;
#endif

                this.tabControlCoordinateCalculation.TabPages.Remove(this.tabPageCoordinateParser);
                this.tabControlPlaceAndCountry.TabPages.Remove(this.tabPagePlaceAndCountryGazetteer);

                this.comboBoxSynColGazTarget.Items.Add(_SynColGazType.Place.ToString());
                this.comboBoxSynColGazTarget.Items.Add(_SynColGazType.Coordinates.ToString());

                this.radioButtonSynColGazCountryToPlace.Checked = !DiversityWorkbench.Settings.GazetteerHierarchyPlaceToCountry;
                this.radioButtonSynColGazPlaceToCountry.Checked = DiversityWorkbench.Settings.GazetteerHierarchyPlaceToCountry;
                this.radioButtonGazetteerCountryToPlace.Checked = !DiversityWorkbench.Settings.GazetteerHierarchyPlaceToCountry;
                this.radioButtonGazetteerPlaceToCountry.Checked = DiversityWorkbench.Settings.GazetteerHierarchyPlaceToCountry;

                // Obsolete
                //this.comboBoxSynColGazTarget.Items.Add(_SynColGazType.TK25.ToString());

                //this.comboBoxSynColGazTarget.Items.Add(_SynColGazType.Geography.ToString());
                //this.comboBoxSynColGazTarget.Items.Add(_SynColGazType.Country.ToString());
                //this.comboBoxSynColGazTarget.Items.Add(_SynColGazType.Nation.ToString());

                this.comboBoxGazetteerLocalisationSystem.DataSource = DiversityCollection.LookupTable.DtLocationNameAeras();
                this.comboBoxGazetteerLocalisationSystem.DisplayMember = "DisplayText";
                this.comboBoxGazetteerLocalisationSystem.ValueMember = "LocalisationSystemID";

                this.comboBoxSynColGazTarget.SelectedIndex = 0;

                DiversityWorkbench.Agent Agent = new DiversityWorkbench.Agent(DiversityWorkbench.Settings.ServerConnection);
                try
                {
                    System.Data.DataTable dtTypes = Agent.AgentNameDisplayTypes(true);
                    if (dtTypes.Columns.Count > 1)
                    {
                        this.comboBoxSynColAgeDisplaytype.DataSource = dtTypes;
                        this.comboBoxSynColAgeDisplaytype.DisplayMember = dtTypes.Columns[1].ColumnName;
                        this.comboBoxSynColAgeDisplaytype.ValueMember = dtTypes.Columns[0].ColumnName;

                        this.comboBoxSynColAgeTextDisplaytype.DataSource = dtTypes;
                        this.comboBoxSynColAgeTextDisplaytype.DisplayMember = dtTypes.Columns[1].ColumnName;
                        this.comboBoxSynColAgeTextDisplaytype.ValueMember = dtTypes.Columns[0].ColumnName;
                    }
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }

                try
                {
                    // #184
                    if (this.userControlWebViewGeoNames != null)
                    {
                        System.Uri U = new Uri("http://www.geonames.org/img/globe.gif");
                        this.userControlWebViewGeoNames.Url = null;
                        this.userControlWebViewGeoNames.Navigate(U);
                    }
                    //this.web BrowserGeoNames.Url = U;
                    this.labelSetPlaceAndCountry.Text = DiversityCollection.Forms.FormMaintenanceText.SetPlaceAndCountryInfo;
                }
                catch (System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }

                this.initOrphanedData();

                this.initSamplingPlots();

                this.initAcceptedNames();
                //this.initGazetteer();
                this.initAnalysis();

                //this.InitSynTerms();

                initSynchronization_ScientificTerms();

                this.initSynColAgeText();

                this.initSplitCollectors();

                this.initGeographyInArea();

                // einblenden erst wenn fertig
                //this.tabControlSynchronize.TabPages.Remove(this.tabPageCollTerms);

                // wird nicht mehr angezeigt, da eingegebene Daten inkonsistent sind
                this.tabControlSynColTaxFamOrd.TabPages.Remove(this.tabPageAvailableData);
                this.tabControlSynColGaz.TabPages.Remove(this.tabPageSynColGazTK25);
                this.buttonUnrelatedEventSeriesList.Height = (int)(this.buttonUnrelatedEventSeriesList.Height * DiversityWorkbench.Forms.FormFunctions.DisplayZoomFactor);
                this.buttonUnrelatedEventSeriesDelete.Height = (int)(this.buttonUnrelatedEventSeriesDelete.Height * DiversityWorkbench.Forms.FormFunctions.DisplayZoomFactor);

                // Event & Series
                this.initEvent();
                this.initEventSeries();

                this.initCheckGeography();
                this.initTaxonBrokenLinks();

                this.toolTip.SetToolTip(this.buttonSetTimeout, "Set the timeout for maintenance queries: " + DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout.ToString() + " sec.");
                this.buttonSetTimeout.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout.ToString() + " s";
                if (DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout == 0)
                    this.buttonSetTimeout.Text = "inf.";
                //this.textBoxImagesTimeout.Text = (DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout).ToString();// (DiversityWorkbench.Settings.TimeoutDatabaseInSeconds).ToString();

                this.initNagoya();

                this.initTK25forCoordinates();

                this.initImageExtenionCheck();
                this.initRetrievalType();

                this.initReferences();
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void initOrphanedData()
        {
            try
            {
                if (DiversityWorkbench.Settings.ConnectionString.Length > 0)
                {
                    // Series
                    if (this.tabControlMain.TabPages.Contains(this.tabPageUnrelatedEventSeries))
                        this.tabControlMain.TabPages.Remove(this.tabPageUnrelatedEventSeries);

                    bool OK = this.FormFunctions.getObjectPermissions("CollectionEventSeries", "DELETE");
                    if (!OK && this.tabControlOrphanedData.TabPages.Contains(this.tabPageOrphanedSeries))
                        this.tabControlOrphanedData.TabPages.Remove(this.tabPageOrphanedSeries);

                    // Events
                    OK = this.FormFunctions.getObjectPermissions("CollectionEvent", "DELETE");
                    if (!OK && this.tabControlOrphanedData.TabPages.Contains(this.tabPageOrphanedEvent))
                        this.tabControlOrphanedData.TabPages.Remove(this.tabPageOrphanedEvent);

                    // Annotations
                    if (this.tabControlMain.TabPages.Contains(this.tabPageAnnotations))
                        this.tabControlMain.TabPages.Remove(this.tabPageAnnotations);

                    OK = this.FormFunctions.getObjectPermissions("Annotation", "DELETE");
                    if (!OK && this.tabControlOrphanedData.TabPages.Contains(this.tabPageOrphanedAnnotations))
                        this.tabControlOrphanedData.TabPages.Remove(this.tabPageOrphanedAnnotations);

                    // Identifier
                    if (this.tabControlMain.TabPages.Contains(this.tabPageIdentifier))
                        this.tabControlMain.TabPages.Remove(this.tabPageIdentifier);

                    OK = this.FormFunctions.getObjectPermissions("ExternalIdentifier", "DELETE");
                    if (!OK && this.tabControlOrphanedData.TabPages.Contains(this.tabPageOrphanedIdentifier))
                        this.tabControlOrphanedData.TabPages.Remove(this.tabPageOrphanedIdentifier);
                }

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void initSamplingPlots()
        {
            if (DiversityWorkbench.Settings.ConnectionString != "")
            {
                try
                {
                    this.comboBoxSynColPlotDatabase.Items.Clear();
                    this.comboBoxSynColPlotDatabase.Items.Add("");
                    foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversitySamplingPlots"].ServerConnectionList())
                    {
                        this.comboBoxSynColPlotDatabase.Items.Add(KV.Key);
                    }
                    //foreach (string DS in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversitySamplingPlots"].DatabaseList())
                    //{
                    //    this.comboBoxSynColPlotDatabase.Items.Add(DS);
                    //}
                    if (comboBoxSynColPlotDatabase.Items.Count > 0)
                        comboBoxSynColPlotDatabase.SelectedIndex = 0;
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void FormMaintenance_FormClosing(object sender, FormClosingEventArgs e)
        {
            if (this.comboBoxSynColTaxProject.Text.Length > 0)
                DiversityCollection.Forms.FormMaintenanceSettings.Default.Project = this.comboBoxSynColTaxProject.Text;
            else
            {
                if (this.comboBoxSynColExsProject.Text.Length > 0)
                    DiversityCollection.Forms.FormMaintenanceSettings.Default.Project = this.comboBoxSynColExsProject.Text;
                else
                {
                }
            }
            if (this.comboBoxSynColTaxDatabase.Text.Length > 0)
                DiversityCollection.Forms.FormMaintenanceSettings.Default.SynColTaxDatabase = this.comboBoxSynColTaxDatabase.Text;
            DiversityCollection.Forms.FormMaintenanceSettings.Default.Save();
            if (this._ConnectionForSamplingPlotSynchronisation != null)
            {
                if (this._ConnectionForSamplingPlotSynchronisation.State == ConnectionState.Open)
                    this._ConnectionForSamplingPlotSynchronisation.Close();
                this._ConnectionForSamplingPlotSynchronisation.Dispose();
            }
            if(_sqlConnectionSynColAgeText != null)
            {
                if (_sqlConnectionSynColAgeText.State == ConnectionState.Open)
                    _sqlConnectionSynColAgeText.Close();
                _sqlConnectionSynColAgeText.Dispose();
            }
            if (_sqlConnectionCollectorsSequence != null)
            {
                if (_sqlConnectionCollectorsSequence.State == ConnectionState.Open)
                {
                    DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(CollectorsSequenceRemoveTempTable());
                    _sqlConnectionCollectorsSequence.Close();
                }
                _sqlConnectionCollectorsSequence.Dispose();
            }
        }

        private DiversityWorkbench.Forms.FormFunctions FormFunctions
        {
            get
            {
                if (this._FormFunctions == null)
                    this._FormFunctions = new DiversityWorkbench.Forms.FormFunctions(this, DiversityWorkbench.Settings.ConnectionString, ref this.toolTip);
                return this._FormFunctions;
            }
        }

        private void InitUnrelatedEvents()
        {
            try
            {
                if (DiversityWorkbench.Settings.ConnectionString.Length > 0)
                {
                    bool OK = this.FormFunctions.getObjectPermissions("CollectionEvent", "DELETE");
                    if (!OK && this.tabControlCollectionEvent.TabPages.Contains(this.tabPageRemoveEvents))
                        this.tabControlCollectionEvent.TabPages.Remove(this.tabPageRemoveEvents);

                    OK = this.FormFunctions.getObjectPermissions("CollectionEventSeries", "DELETE");
                    if (!OK && this.tabControlMain.TabPages.Contains(this.tabPageUnrelatedEventSeries))
                        this.tabControlMain.TabPages.Remove(this.tabPageUnrelatedEventSeries);
                }

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonFeedback_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Feedback.SendFeedback(System.Reflection.Assembly.GetAssembly(this.GetType()).GetName().Version.ToString(), "", "");
        }

        private void buttonSetTimeout_Click(object sender, EventArgs e)
        {
            int Timeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;// /1000;
            DiversityWorkbench.Forms.FormGetInteger f = new DiversityWorkbench.Forms.FormGetInteger(Timeout, "Timeout", "Please enter the timeout for the maintenance queries in seconds");
            f.ShowDialog();
            if (f.DialogResult == System.Windows.Forms.DialogResult.OK && f.Integer != null)
            {
                DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout = (int)f.Integer;// *1000;
                DiversityCollection.Forms.FormMaintenanceSettings.Default.Save();
                this.toolTip.SetToolTip(this.buttonSetTimeout, "Set the timeout for maintenance queries: " + DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout.ToString() + " sec.");
                this.buttonSetTimeout.Text = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout.ToString() + " s";
                if (DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout == 0)
                    this.buttonSetTimeout.Text = "inf.";
            }
        }

        #endregion

        #region Database

        private void setDatabases()
        {
            if (DiversityWorkbench.Settings.ConnectionString != "")
            {
                try
                {
                    // Taxonomy
                    this.comboBoxSynColTaxDatabase.Items.Clear();
                    this.comboBoxSynColTaxFamOrdDatabase.Items.Clear();
                    this.comboBoxSynColTaxTextDatabase.Items.Clear();
                    this.comboBoxAcceptedNameTaxonomySource.Items.Clear();
                    this.comboBoxRemoveNameURITaxonDB.Items.Clear();
                    foreach (DiversityWorkbench.DatabaseService DS in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DatabaseServices())
                    {
                        this.comboBoxSynColTaxDatabase.Items.Add(DS.DisplayText);
                        this.comboBoxSynColTaxFamOrdDatabase.Items.Add(DS.DisplayText);
                        this.comboBoxSynColTaxTextDatabase.Items.Add(DS.DisplayText);
                        this.comboBoxAcceptedNameTaxonomySource.Items.Add(DS.DisplayText);
                        if (!DS.IsWebservice && !DS.IsListInDatabase && !DS.IsCacheDB && !DS.IsForeignSource)
                            this.comboBoxRemoveNameURITaxonDB.Items.Add(DS.DisplayText);
                    }

                    // Agents
                    this.comboBoxSynColAgeDatabase.Items.Clear();
                    this.comboBoxSynColAgeTextDatabase.Items.Clear();
                    foreach (DiversityWorkbench.DatabaseService DS in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityAgents"].DatabaseServices())
                    {
                        this.comboBoxSynColAgeDatabase.Items.Add(DS.DisplayText);
                        this.comboBoxSynColAgeTextDatabase.Items.Add(DS.DisplayText);
                    }
                    if (this.comboBoxSynColAgeTextDatabase.Items.Count > 0)
                        this.comboBoxSynColAgeTextDatabase.SelectedIndex = 0;
                    if (this.comboBoxSynColAgeDatabase.Items.Count > 0)
                        this.comboBoxSynColAgeDatabase.SelectedIndex = 0;

                    // Exsiccatae
                    this.comboBoxSynColExsDB.Items.Clear();
                    if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList().ContainsKey("DiversityExsiccatae"))
                    {
                        foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityExsiccatae"].ServerConnections())
                        {
                            this.comboBoxSynColExsDB.Items.Add(KV.Value.DisplayText);
                        }
                        if (this.comboBoxSynColExsDB.Items.Count > 0)
                            this.comboBoxSynColExsDB.SelectedIndex = 0;
                    }

                    // References
                    this.comboBoxSynColRefDatabase.Items.Clear();
                    foreach (DiversityWorkbench.DatabaseService DS in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityReferences"].DatabaseServices())
                    {
                        if (!DS.IsWebservice)
                            this.comboBoxSynColRefDatabase.Items.Add(DS.DisplayText);
                    }
                    if (this.comboBoxSynColRefDatabase.Items.Count > 0)
                        this.comboBoxSynColRefDatabase.SelectedIndex = 0;

                    // TK25
                    this.comboBoxTK25Source.Items.Clear();
                    foreach (DiversityWorkbench.DatabaseService DS in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()[this._TK25Module].DatabaseServices())
                    {
                        this.comboBoxTK25Source.Items.Add(DS.DisplayText);
                    }
                    if (comboBoxTK25Source.Items.Count > 0)
                        comboBoxTK25Source.SelectedIndex = 0;

                    // Gazetteer
                    this.comboBoxSynColGazDatabase.Items.Clear();
                    this.comboBoxSynColGazTK25Database.Items.Clear();
                    this.comboBoxGazetteerDatabase.Items.Clear();
                    //foreach (DiversityWorkbench.DatabaseService DS in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].DatabaseServices())
                    //{
                    //    this.comboBoxSynColGazDatabase.Items.Add(DS.DisplayText);
                    //    this.comboBoxSynColGazTK25Database.Items.Add(DS.DisplayText);
                    //    this.comboBoxGazetteerDatabase.Items.Add(DS.DisplayText);
                    //}
                    foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList())
                    {
                        this.comboBoxSynColGazDatabase.Items.Add(KV.Value.DisplayText);
                        this.comboBoxSynColGazTK25Database.Items.Add(KV.Value.DisplayText);
                        this.comboBoxGazetteerDatabase.Items.Add(KV.Value.DisplayText);
                    }

                    // Terms
                    foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KVconn in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList())
                    {
                        this.comboBoxSynColTermDatabase.Items.Add(KVconn.Key);
                        this.comboBoxSynTermsTextDatabase.Items.Add(KVconn.Key);

                        this.comboBoxSynUnitTermsDatabase.Items.Add(KVconn.Key);
                        this.comboBoxSynUnitTermsTextDatabase.Items.Add(KVconn.Key);

                        this.comboBoxPartDescDatabase.Items.Add(KVconn.Key);
                        this.comboBoxSynPartDescriptionTextDatabase.Items.Add(KVconn.Key);
                    }

                    //Check
                    this.comboBoxGeographyInAreaSource.Items.Clear();
                    foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList())
                    {
                        this.comboBoxGeographyInAreaSource.Items.Add(KV.Value.DisplayText);
                    }
                    if (comboBoxGeographyInAreaSource.Items.Count > 0)
                        comboBoxGeographyInAreaSource.SelectedIndex = 0;


                    this.setLookupTables();
                    this.setModuleConnectionsForBulkControls();
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
            this.FormFunctions.setTitle();
        }

        private void setLookupTables()
        {
            try
            {
                if (this._dtCollectionProjects == null) this._dtCollectionProjects = new DataTable();
                else this._dtCollectionProjects.Clear();
                string SQL = "SELECT [ProjectID], [Project] " +
                    "FROM [" + DiversityWorkbench.Settings.DatabaseName + "].[dbo].[ProjectList] ORDER BY Project";
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(this._dtCollectionProjects);

                if (this._dtCollectionProjectsWithNull == null) this._dtCollectionProjectsWithNull = new DataTable();
                else this._dtCollectionProjectsWithNull.Clear();
                ad.SelectCommand.CommandText = "SELECT NULL AS [ProjectID] , NULL AS [Project] " +
                    "UNION " +
                    "SELECT [ProjectID], [Project] " +
                    "FROM [" + DiversityWorkbench.Settings.DatabaseName + "].[dbo].[ProjectList] ORDER BY Project";
                ad.Fill(this._dtCollectionProjectsWithNull);

                this.comboBoxSynColTaxProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSynColTaxProject.DisplayMember = "Project";
                this.comboBoxSynColTaxProject.ValueMember = "ProjectID";

                //ad.SelectCommand.CommandText = "SELECT TerminologyID AS ProjectID, DisplayText AS Project " +
                //    "FROM Terminology ORDER BY Project";
                //System.Data.DataTable _dtTerminology = new DataTable();
                //ad.Fill(_dtTerminology);
                //this.comboBoxSynUnitTermsTermProject.DataSource = _dtTerminology;
                //this.comboBoxSynUnitTermsTermProject.DisplayMember = "Project";
                //this.comboBoxSynUnitTermsTermProject.ValueMember = "ProjectID";

                //this.comboBoxSynUnitTermsTextTermProject.DataSource = _dtTerminology;
                //this.comboBoxSynUnitTermsTextTermProject.DisplayMember = "Project";
                //this.comboBoxSynUnitTermsTextTermProject.ValueMember = "ProjectID";

                this.comboBoxSynUnitTermsProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSynUnitTermsProject.DisplayMember = "Project";
                this.comboBoxSynUnitTermsProject.ValueMember = "ProjectID";

                this.comboBoxSynUnitTermsTextProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSynUnitTermsTextProject.DisplayMember = "Project";
                this.comboBoxSynUnitTermsTextProject.ValueMember = "ProjectID";

                this.comboBoxPartDescProject.DataSource = this._dtCollectionProjects;
                this.comboBoxPartDescProject.DisplayMember = "Project";
                this.comboBoxPartDescProject.ValueMember = "ProjectID";

                this.comboBoxSynColExsProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSynColExsProject.DisplayMember = "Project";
                this.comboBoxSynColExsProject.ValueMember = "ProjectID";

                this.comboBoxSynColPlotProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSynColPlotProject.DisplayMember = "Project";
                this.comboBoxSynColPlotProject.ValueMember = "ProjectID";

                this.comboBoxSynColGazProject.DataSource = this._dtCollectionProjectsWithNull;
                this.comboBoxSynColGazProject.DisplayMember = "Project";
                this.comboBoxSynColGazProject.ValueMember = "ProjectID";
                //this.comboBoxSynColGazProject.Sorted = true;

                this.comboBoxSynColGazTK25Project.DataSource = this._dtCollectionProjectsWithNull;
                this.comboBoxSynColGazTK25Project.DisplayMember = "Project";
                this.comboBoxSynColGazTK25Project.ValueMember = "ProjectID";

                this.comboBoxSynColRefProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSynColRefProject.DisplayMember = "Project";
                this.comboBoxSynColRefProject.ValueMember = "ProjectID";

                this.comboBoxSynColAgeProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSynColAgeProject.DisplayMember = "Project";
                this.comboBoxSynColAgeProject.ValueMember = "ProjectID";

                this.comboBoxSynColAgeTextProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSynColAgeTextProject.DisplayMember = "Project";
                this.comboBoxSynColAgeTextProject.ValueMember = "ProjectID";

                this.comboBoxSynFamOrdProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSynFamOrdProject.DisplayMember = "Project";
                this.comboBoxSynFamOrdProject.ValueMember = "ProjectID";

                this.comboBoxSynColTaxFamOrdProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSynColTaxFamOrdProject.DisplayMember = "Project";
                this.comboBoxSynColTaxFamOrdProject.ValueMember = "ProjectID";

                this.comboBoxSynColTaxTextProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSynColTaxTextProject.DisplayMember = "Project";
                this.comboBoxSynColTaxTextProject.ValueMember = "ProjectID";

                this.comboBoxSynColTermProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSynColTermProject.DisplayMember = "Project";
                this.comboBoxSynColTermProject.ValueMember = "ProjectID";

                this.comboBoxSynTermsTextProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSynTermsTextProject.DisplayMember = "Project";
                this.comboBoxSynTermsTextProject.ValueMember = "ProjectID";

                this.comboBoxBulkProject.DataSource = this._dtCollectionProjects;
                this.comboBoxBulkProject.DisplayMember = "Project";
                this.comboBoxBulkProject.ValueMember = "ProjectID";

                this.comboBoxSetPlaceProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSetPlaceProject.DisplayMember = "Project";
                this.comboBoxSetPlaceProject.ValueMember = "ProjectID";

                this.comboBoxMergeEventsProject.DataSource = this._dtCollectionProjectsWithNull;
                this.comboBoxMergeEventsProject.DisplayMember = "Project";
                this.comboBoxMergeEventsProject.ValueMember = "ProjectID";

                this.comboBoxAddCoordinatesProject.DataSource = this._dtCollectionProjects;
                this.comboBoxAddCoordinatesProject.DisplayMember = "Project";
                this.comboBoxAddCoordinatesProject.ValueMember = "ProjectID";

                this.comboBoxCalculateCoordinatesProject.DataSource = this._dtCollectionProjects;
                this.comboBoxCalculateCoordinatesProject.DisplayMember = "Project";
                this.comboBoxCalculateCoordinatesProject.ValueMember = "ProjectID";

                this.comboBoxParseCoordinatesProject.DataSource = this._dtCollectionProjects;
                this.comboBoxParseCoordinatesProject.DisplayMember = "Project";
                this.comboBoxParseCoordinatesProject.ValueMember = "ProjectID";

                //this.comboBoxUnrelatedEventSeriesProject.DataSource = this._dtCollectionProjects;
                //this.comboBoxUnrelatedEventSeriesProject.DisplayMember = "Project";
                //this.comboBoxUnrelatedEventSeriesProject.ValueMember = "ProjectID";

                this.comboBoxPrintProject.DataSource = this._dtCollectionProjects;
                this.comboBoxPrintProject.DisplayMember = "Project";
                this.comboBoxPrintProject.ValueMember = "ProjectID";

                this.comboBoxSynColAgeSplitCollectorsProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSynColAgeSplitCollectorsProject.DisplayMember = "Project";
                this.comboBoxSynColAgeSplitCollectorsProject.ValueMember = "ProjectID";

                SQL = "select USER_NAME()";
                string User = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL).ToLower();
                if (User == "dbo")
                    this.comboBoxCheckGeographyProject.DataSource = this._dtCollectionProjectsWithNull;
                else
                    this.comboBoxCheckGeographyProject.DataSource = this._dtCollectionProjects;
                this.comboBoxCheckGeographyProject.DisplayMember = "Project";
                this.comboBoxCheckGeographyProject.ValueMember = "ProjectID";

                this.comboBoxGazetteerForProject.DataSource = this._dtCollectionProjects;
                this.comboBoxGazetteerForProject.DisplayMember = "Project";
                this.comboBoxGazetteerForProject.ValueMember = "ProjectID";

                this.comboBoxImagesProject.DataSource = this._dtCollectionProjects;
                this.comboBoxImagesProject.DisplayMember = "Project";
                this.comboBoxImagesProject.ValueMember = "ProjectID";

                this.comboBoxSetStorageLocationProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSetStorageLocationProject.DisplayMember = "Project";
                this.comboBoxSetStorageLocationProject.ValueMember = "ProjectID";

                this.comboBoxSynColTaxBrokenProject.DataSource = this._dtCollectionProjects;
                this.comboBoxSynColTaxBrokenProject.DisplayMember = "Project";
                this.comboBoxSynColTaxBrokenProject.ValueMember = "ProjectID";

                this.comboBoxEventMethodParametersProject.DataSource = this._dtCollectionProjectsWithNull;
                this.comboBoxEventMethodParametersProject.DisplayMember = "Project";
                this.comboBoxEventMethodParametersProject.ValueMember = "ProjectID";

                this.comboBoxAcceptedNameProject.DataSource = this._dtCollectionProjects;
                this.comboBoxAcceptedNameProject.DisplayMember = "Project";
                this.comboBoxAcceptedNameProject.ValueMember = "ProjectID";

                this.comboBoxNagoyaProject.DataSource = this._dtCollectionProjects;
                this.comboBoxNagoyaProject.DisplayMember = "Project";
                this.comboBoxNagoyaProject.ValueMember = "ProjectID";

                this.comboBoxTK25forCoordinatesProject.DataSource = this._dtCollectionProjects;
                this.comboBoxTK25forCoordinatesProject.DisplayMember = "Project";
                this.comboBoxTK25forCoordinatesProject.ValueMember = "ProjectID";

                this.comboBoxAnalysisProject.DataSource = this._dtCollectionProjects;
                this.comboBoxAnalysisProject.DisplayMember = "Project";
                this.comboBoxAnalysisProject.ValueMember = "ProjectID";

                this.comboBoxCheckRetrievalProject.DataSource = this._dtCollectionProjects;
                this.comboBoxCheckRetrievalProject.DisplayMember = "Project";
                this.comboBoxCheckRetrievalProject.ValueMember = "ProjectID";

                this.comboBoxGeographyInAreaProject.DataSource = this._dtCollectionProjects;
                this.comboBoxGeographyInAreaProject.DisplayMember = "Project";
                this.comboBoxGeographyInAreaProject.ValueMember = "ProjectID";

                this.comboBoxOutsideTK25Project.DataSource = this._dtCollectionProjects;
                this.comboBoxOutsideTK25Project.DisplayMember = "Project";
                this.comboBoxOutsideTK25Project.ValueMember = "ProjectID";

                this.comboBoxPlaceAndCountryGazetteerProject.DataSource = this._dtCollectionProjects;
                this.comboBoxPlaceAndCountryGazetteerProject.DisplayMember = "Project";
                this.comboBoxPlaceAndCountryGazetteerProject.ValueMember = "ProjectID";

                this.comboBoxRemoveNameURIProject.DataSource = this._dtCollectionProjects;
                this.comboBoxRemoveNameURIProject.DisplayMember = "Project";
                this.comboBoxRemoveNameURIProject.ValueMember = "ProjectID";

                System.Data.DataTable _dtProject = new DataTable();
                SQL = "SELECT NULL AS ProjectID , NULL AS Project " +
                    "UNION " +
                    "SELECT ProjectID, Project " +
                    "FROM [" + DiversityWorkbench.Settings.DatabaseName + "].[dbo].[ProjectList] ORDER BY Project";
                ad.SelectCommand.CommandText = SQL;
                ad.Fill(_dtProject);
                this.comboBoxAccNrDuplicatesProject.DataSource = _dtProject;
                this.comboBoxAccNrDuplicatesProject.DisplayMember = "Project";
                this.comboBoxAccNrDuplicatesProject.ValueMember = "ProjectID";

                SQL = "SELECT ProjectID, Project " +
                    "FROM [" + DiversityWorkbench.Settings.DatabaseName + "].[dbo].[ProjectList] ORDER BY Project";
                ad.SelectCommand.CommandText = SQL;
                this._dtSamplingPlotToLocalityProjects = new DataTable();
                ad.Fill(this._dtSamplingPlotToLocalityProjects);
                this.comboBoxSamplingPlotToLocalityProject.DataSource = _dtSamplingPlotToLocalityProjects;
                this.comboBoxSamplingPlotToLocalityProject.DisplayMember = "Project";
                this.comboBoxSamplingPlotToLocalityProject.ValueMember = "ProjectID";

                SQL = "SELECT ProjectID, Project " +
                    "FROM [" + DiversityWorkbench.Settings.DatabaseName + "].[dbo].[ProjectList] ORDER BY Project";
                ad.SelectCommand.CommandText = SQL;
                this._dtTK25Projects = new DataTable();
                ad.Fill(this._dtTK25Projects);
                this.comboBoxTK25Project.DataSource = _dtTK25Projects;
                this.comboBoxTK25Project.DisplayMember = "Project";
                this.comboBoxTK25Project.ValueMember = "ProjectID";

                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                string Restriction = "";
                foreach (string C in DiversityWorkbench.CollectionSpecimen.TermRelatedTaxonomicGroups)
                {
                    if (Restriction.Length > 0)
                        Restriction += ", ";
                    Restriction += "'" + C + "'";
                }
                Restriction = "Code not in (" + Restriction + ")";
                DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxSynColTaxFamOrdTaxonomicGroup, "CollTaxonomicGroup_Enum", con, false, true, false, Restriction);
                DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxSynColTaxTextTaxonomicGroup, "CollTaxonomicGroup_Enum", con, false, true, false, Restriction);
                DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxSynColTaxTaxonomicGroup, "CollTaxonomicGroup_Enum", con, false, true, false, Restriction);
                DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxSynFamOrdTaxonomicGroup, "CollTaxonomicGroup_Enum", con);
                DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxSynColTaxBrokenTaxonomicGroup, "CollTaxonomicGroup_Enum", con, true, true, false, Restriction);
                DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxAcceptedNameTaxonomicGroup, "CollTaxonomicGroup_Enum", con, true, true, false, Restriction);
                DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxAnalysisTaxonomicGroup, "CollTaxonomicGroup_Enum", con, false, true, false, Restriction);

                DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxBulkTaxonomicGroup, "CollTaxonomicGroup_Enum", con, true, true);
                DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxBulkIdentCategory, "CollIdentificationCategory_Enum", con);

                Restriction = Restriction.Replace(" not ", " ");
                DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxSynUnitTermsTaxonomicGroup, "CollTaxonomicGroup_Enum", con, false, true, false, Restriction);
                DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxSynUnitTermsTextTaxonomicGroup, "CollTaxonomicGroup_Enum", con, false, true, false, Restriction);

                //foreach (string T in DiversityWorkbench.CollectionSpecimen.TermRelatedTaxonomicGroups)
                //{
                //    this.comboBoxSynUnitTermsTaxonomicGroup.Items.Add(T);
                //    this.comboBoxSynUnitTermsTextTaxonomicGroup.Items.Add(T);
                //}

                this.comboBoxAddCoordinatesSource.Items.Add(LookupTable.CoordinateSystem.GaussKrüger);
                this.comboBoxAddCoordinatesSource.Items.Add(LookupTable.CoordinateSystem.PotsdamDatum);
                this.comboBoxAddCoordinatesSource.Items.Add(LookupTable.CoordinateSystem.UTM);
                this.comboBoxAddCoordinatesSource.Items.Add(LookupTable.CoordinateSystem.WGS84);

                //this.comboBoxCalculateCoordinatesType.Items.Add(LookupTable.CoordinateSystem.PotsdamDatum);
                this.comboBoxCalculateCoordinatesType.Items.Add(LookupTable.CoordinateSystem.WGS84);

                foreach (string P in this.CoordiateParser)
                {
                    this.comboBoxParseCoordinatesType.Items.Add(P);
                }
                this.comboBoxParseCoordinatesType.SelectedIndex = 0;

                System.Data.DataTable dtMethod = new DataTable();
                SQL = "SELECT NULL AS MethodID , NULL AS Method " +
                    "UNION " +
                    "SELECT MethodID, DisplayText AS Method " +
                    "FROM Method ORDER BY Method";
                ad.SelectCommand.CommandText = SQL;
                ad.Fill(dtMethod);
                this.comboBoxEventMethodParametersMethod.DataSource = dtMethod;
                this.comboBoxEventMethodParametersMethod.DisplayMember = "Method";
                this.comboBoxEventMethodParametersMethod.ValueMember = "MethodID";
                // fixing unclear visibilty changes - TODO

                this.comboBoxEventMethodParametersMethod.Visible = true;
                this.labelEventMethodParametersMethod.Visible = true;
                this.buttonEventMethodParametersCheckDataset.Visible = false;

            }
            catch (System.Exception ex) { }
        }

        #endregion

        #region Synchronization etc.

        #region Common
        private enum SynchronisationSource { ModuleOnSameServer, ModuleOnDifferentServer, ModuleOnLinkedServer, Webservice, NoConnection }
        private SynchronisationSource SourceForSynchronisation = SynchronisationSource.ModuleOnSameServer;

        #endregion

        #region Taxonomy

        #region TaxonNames via ID

        private void checkBoxSynColTaxViaCacheDB_Click(object sender, EventArgs e)
        {
            this.setSynColTaxControlsAccordingToCacheDB();
        }

        private void setSynColTaxControlsAccordingToCacheDB()
        {
            this.comboBoxSynColTaxDatabase.Enabled = !this.checkBoxSynColTaxViaCacheDB.Checked;
            this.comboBoxSynColTaxTaxonNameProject.Enabled = !this.checkBoxSynColTaxViaCacheDB.Checked;
        }

        private void comboBoxSynColTaxDatabase_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.labelSynColTaxDatabase.Text = "Taxonomy database:";
            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DatabaseList().Contains(comboBoxSynColTaxDatabase.SelectedItem.ToString()))
            {
                this.labelSynColTaxTaxonomicGroup.Visible = false;
                this.comboBoxSynColTaxTaxonomicGroup.Visible = false;
                if (comboBoxSynColTaxDatabase.Text.IndexOf("].DiversityTaxonNames_") > -1)
                {
                    this.labelSynColTaxDatabase.Text += "  " + comboBoxSynColTaxDatabase.Text.Substring(comboBoxSynColTaxDatabase.Text.IndexOf("].DiversityTaxonNames_") + "].DiversityTaxonNames_".Length);
                }
            }
            else
            {
                this.labelSynColTaxTaxonomicGroup.Visible = true;
                this.comboBoxSynColTaxTaxonomicGroup.Visible = true;
                if (comboBoxSynColTaxDatabase.Text.IndexOf("].DiversityTaxonNames_") > -1)
                {
                    this.labelSynColTaxDatabase.Text += "  " + comboBoxSynColTaxDatabase.Text.Substring(comboBoxSynColTaxDatabase.Text.IndexOf("].DiversityTaxonNames_") + "].DiversityTaxonNames_".Length);
                }
            }
            DiversityWorkbench.DatabaseService x = new DiversityWorkbench.DatabaseService(comboBoxSynColTaxDatabase.SelectedItem.ToString());
            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DatabaseServices().Contains(x))
            {
                this.comboBoxSynColTaxTaxonNameProject.Visible = true;
                this.labelSynColTaxTaxonNameProject.Visible = true;
            }
            else
            {
                this.comboBoxSynColTaxTaxonNameProject.Visible = false;
                this.labelSynColTaxTaxonNameProject.Visible = false;
                this.comboBoxSynColTaxTaxonNameProject.SelectedIndex = -1;
            }
        }

        private async void buttonSynColTaxCheck_Click(object sender, EventArgs e)
        {
            bool setColumnWidth = true;
            if (this.dataGridViewSynColTax.ColumnCount > 1) setColumnWidth = false;
            if (this.comboBoxSynColTaxDatabase.Text.Length == 0 && !this.checkBoxSynColTaxViaCacheDB.Checked)
            {
                System.Windows.Forms.MessageBox.Show("Please choose a database"
                    );
                return;
            }
            if (this.checkBoxSynColTaxViaCacheDB.Checked && DiversityCollection.CacheDatabase.CacheDB.CacheDatabaseName().Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("You have no connection to the cache database");
                return;
            }
            string BaseURL = "";
            string SQL = "";
            string SqlOrder = "";
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            try
            {
                if (this.checkBoxSynColTaxViaCacheDB.Checked)
                {
                    SourceForSynchronisation = SynchronisationSource.ModuleOnSameServer;
                }
                else if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnectionList().ContainsKey(this.comboBoxSynColTaxDatabase.Text))
                {
                    DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnectionList()[this.comboBoxSynColTaxDatabase.Text];
                    if (SC.LinkedServer.Length > 0)
                    {
                        SourceForSynchronisation = SynchronisationSource.ModuleOnLinkedServer;
                        BaseURL = SC.BaseURL;
                    }
                    else if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DataBaseURIs().TryGetValue(this.comboBoxSynColTaxDatabase.Text, out BaseURL))
                    {
                        if (BaseURL == null || BaseURL.Length == 0)
                        {
                            System.Windows.Forms.MessageBox.Show("Connection to " + this.comboBoxSynColTaxDatabase.Text + " not established");
                            SourceForSynchronisation = SynchronisationSource.NoConnection;
                            return;
                        }
                        string ModulBaseURL = "";
                        DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityCollection"].DataBaseURIs().TryGetValue(DiversityWorkbench.Settings.DatabaseName, out ModulBaseURL);
                        string TaxonNameServer = BaseURL.ToLower().Substring(0, BaseURL.ToLower().IndexOf("/taxonname"));
                        string CollectionServer = ModulBaseURL.ToLower().Substring(0, ModulBaseURL.ToLower().IndexOf("/collection"));
                        if (TaxonNameServer != CollectionServer)
                            SourceForSynchronisation = SynchronisationSource.ModuleOnDifferentServer;
                    }
                }
                else if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DatabaseAndServiceURIs().TryGetValue(this.comboBoxSynColTaxDatabase.Text, out BaseURL))
                {
                    if (BaseURL == null || BaseURL.Length == 0)
                    {
                        System.Windows.Forms.MessageBox.Show("Connection to " + this.comboBoxSynColTaxDatabase.Text + " not established");
                        SourceForSynchronisation = SynchronisationSource.NoConnection;
                        return;
                    }
                    else
                        SourceForSynchronisation = SynchronisationSource.Webservice;
                }

                if (BaseURL == null)
                {
                }

                switch (SourceForSynchronisation)
                {
                    case SynchronisationSource.ModuleOnLinkedServer:
                    case SynchronisationSource.ModuleOnSameServer:
                        this.SynChroniseTaxonNamesOnSameServer(BaseURL);
                        break;
                    case SynchronisationSource.ModuleOnDifferentServer:
                        this.SynchroniseTaxonNameOnDifferentServer(BaseURL);
                        break;
                    case SynchronisationSource.Webservice:
                        await this.SynchroniseTaxonNamesViaWebservice(BaseURL);
                        break;
                }
            }
            catch (System.Exception ex)
            {
            }

            try
            {
                if (this.dataGridViewSynColTax.ColumnCount > 0 && setColumnWidth)
                {
                    this.dataGridViewSynColTax.Columns[0].Width = 30;
                    this.dataGridViewSynColTax.Columns[1].Width = (int)this.dataGridViewSynColTax.Width * 3 / 8;
                    this.dataGridViewSynColTax.Columns[2].Width = (int)this.dataGridViewSynColTax.Width * 3 / 8;
                }
                if (this.dataGridViewSynColTax.Columns.Count > 0)
                {
                    this.dataGridViewSynColTax.ReadOnly = false;
                    if (this.dataGridViewSynColTax.Columns.Count > 3)
                    {
                        this.dataGridViewSynColTax.Columns[1].ReadOnly = true;
                        this.dataGridViewSynColTax.Columns[2].ReadOnly = true;
                        this.dataGridViewSynColTax.Columns[3].ReadOnly = true;
                        this.dataGridViewSynColTax.Columns[3].Visible = false;
                    }
                    if (this.dataGridViewSynColTax.Columns.Count > 5)
                    {
                        this.dataGridViewSynColTax.Columns[4].ReadOnly = true;
                        this.dataGridViewSynColTax.Columns[5].ReadOnly = true;
                    }
                }
            }
            catch (System.Exception ex)
            { }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
        }

        private void SynChroniseTaxonNamesOnSameServer(string BaseURL)
        {
            try
            {
                string Prefix = "dbo.";
                DiversityWorkbench.ServerConnection SC = null;
                if (this.checkBoxSynColTaxViaCacheDB.Checked)
                {
                    Prefix = "[" + CacheDatabase.CacheDB.CacheDatabaseName() + "].[dbo].";
                }
                else
                {
                    SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnectionList()[this.comboBoxSynColTaxDatabase.Text];
                    if (SC.LinkedServer.Length > 0)
                        Prefix = "[" + SC.LinkedServer + "].[" + SC.DatabaseName + "].dbo.";
                    else Prefix = "[" + SC.DatabaseName + "].dbo.";
                }

                string SQL = "SELECT";
                string SqlOrder = " ORDER BY T.TaxonNameCache ";
                if (this.checkBoxSynColTaxViaCacheDB.Checked)
                    SqlOrder = " ORDER BY T.TaxonName ";
                if (!this.checkBoxSynColTaxIncludeAccNr.Checked) SQL += " DISTINCT ";
                SQL += " cast(1 as bit) AS OK,";
                SQL += " I.TaxonomicName AS [TaxonomicName in DiversityCollection],  ";
                if (this.checkBoxSynColTaxViaCacheDB.Checked)
                    SQL += " T.TaxonName AS [TaxonNameCache in TaxonSynonymy]";
                else
                    SQL += " T.TaxonNameCache AS [TaxonNameCache in DiversityTaxonNames]";
                SQL += ", I.NameURI ";
                if (this.checkBoxSynColTaxIncludeAccNr.Checked) SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";
                SQL += " FROM Identification I INNER JOIN " + Prefix;
                if (this.checkBoxSynColTaxViaCacheDB.Checked)
                    SQL += "TaxonSynonymy T " +
                        " ON I.NameURI = T.NameURI AND I.TaxonomicName <> T.TaxonName ";
                else
                    SQL += "TaxonName T " +
                        " ON RTRIM(SUBSTRING(I.NameURI, LEN('" + BaseURL + "') + 1, 255))  " +
                        " = CAST(T.NameID AS varchar) AND  " +
                        " I.TaxonomicName <> T.TaxonNameCache ";
                if (this.comboBoxSynColTaxTaxonomicGroup.SelectedIndex > -1)
                {
                    SQL += " INNER JOIN IdentificationUnit U ON U.CollectionSpecimenID = I.CollectionSpecimenID AND I.IdentificationUnitID = U.IdentificationUnitID ";
                }
                SQL += " INNER JOIN CollectionProject P ON I.CollectionSpecimenID = P.CollectionSpecimenID " +
                    " INNER JOIN CollectionSpecimen S ON I.CollectionSpecimenID = S.CollectionSpecimenID " +
                    " WHERE (NOT (I.NameURI IS NULL)) " +
                    " AND (I.NameURI LIKE '" + BaseURL + "%')";
                if (this.comboBoxSynColTaxProject.SelectedIndex > -1)
                {
                    int ProjectID = 0;
                    if (this.comboBoxSynColTaxProject.SelectedItem != null)
                    {
                        System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColTaxProject.SelectedItem;
                        if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                            SQL += " AND P.ProjectID = " + ProjectID.ToString();
                        else
                            return;
                    }
                    else return;
                    //if (!int.TryParse(this.comboBoxSynColTaxProject.SelectedValue.ToString(), out ProjectID))
                    //    return;
                    //else
                    //    SQL += " AND P.ProjectID = " + ProjectID.ToString();
                }
                if (this.comboBoxSynColTaxTaxonomicGroup.SelectedIndex > -1 && this.comboBoxSynColTaxTaxonomicGroup.Visible)
                {
                    SQL += " AND U.TaxonomicGroup = '" + this.comboBoxSynColTaxTaxonomicGroup.SelectedValue.ToString() + "' ";
                }
                SQL += SqlOrder;
                //if (this._dtSynColTax == null) 
                this._dtSynColTax = new DataTable();
                //else this._dtSynColTax.Clear();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));// DiversityWorkbench.Settings.TimeoutDatabase));
                ad.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;// / 1000;// DiversityWorkbench.Settings.TimeoutDatabase;
                ad.Fill(this._dtSynColTax);
                this.dataGridViewSynColTax.DataSource = this._dtSynColTax;
                if (this._dtSynColTax.Rows.Count > 0)
                {
                    this.labelSynColTaxCheck.Text = this._dtSynColTax.Rows.Count.ToString() + " differences found";
                    this.buttonSynColTaxUpdate.Enabled = true;
                }
                else
                {
                    this.labelSynColTaxCheck.Text = "No differences found";
                    this.buttonSynColTaxUpdate.Enabled = false;
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private void SynchroniseTaxonNameOnDifferentServer(string BaseURL)
        {
            try
            {
                string SQL = "SELECT ";
                string SqlOrder = " ORDER BY Identification.TaxonomicName ";
                if (!this.checkBoxSynColTaxIncludeAccNr.Checked) SQL += " DISTINCT ";
                SQL += " cast(1 as bit) AS OK,";
                SQL += " Identification.TaxonomicName AS [TaxonomicName in DiversityCollection], '' AS [Name in " + this.comboBoxSynColTaxDatabase.Text + "], Identification.NameURI ";
                if (this.checkBoxSynColTaxIncludeAccNr.Checked) SQL += ", CollectionSpecimen.AccessionNumber, CollectionSpecimen.CollectionSpecimenID ";
                SQL += " FROM Identification ";
                if (this.comboBoxSynColTaxTaxonomicGroup.Text.Length > 0)
                    SQL += " INNER JOIN IdentificationUnit ON Identification.CollectionSpecimenID = IdentificationUnit.CollectionSpecimenID " +
                        " AND Identification.IdentificationUnitID = IdentificationUnit.IdentificationUnitID ";
                SQL += " INNER JOIN CollectionProject ON Identification.CollectionSpecimenID = CollectionProject.CollectionSpecimenID " +
                    " INNER JOIN CollectionSpecimen ON Identification.CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID " +
                    " WHERE (NOT (Identification.NameURI IS NULL)) " +
                    " AND (Identification.NameURI LIKE '" + BaseURL + "%')";
                if (this.comboBoxSynColTaxTaxonomicGroup.Visible && this.comboBoxSynColTaxTaxonomicGroup.Text.Length > 0)
                    SQL += " AND IdentificationUnit.TaxonomicGroup = '" + this.comboBoxSynColTaxTaxonomicGroup.Text + "'";
                if (this.comboBoxSynColTaxProject.SelectedIndex > -1)
                {
                    int ProjectID = 0;
                    if (this.comboBoxSynColTaxProject.SelectedItem != null)
                    {
                        System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColTaxProject.SelectedItem;
                        if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                            SQL += " AND CollectionProject.ProjectID = " + ProjectID.ToString();
                        else
                            return;
                    }
                    else return;
                    //if (!int.TryParse(this.comboBoxSynColTaxProject.SelectedValue.ToString(), out ProjectID))
                    //    return;
                    //else
                    //    SQL += " AND CollectionProject.ProjectID = " + ProjectID.ToString();
                }
                SQL += SqlOrder;
                //if (this._dtSynColTax == null) 
                this._dtSynColTax = new DataTable();
                //else this._dtSynColTax.Clear();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(this._dtSynColTax);
                this.dataGridViewSynColTax.DataSource = this._dtSynColTax;
                System.Data.DataTable dtItem = new DataTable();
                System.Collections.Generic.List<System.Data.DataRow> RowsToDelete = new List<DataRow>();

                DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DataBaseURIs().TryGetValue(this.comboBoxSynColTaxDatabase.Text, out BaseURL);

                string TaxonConnectionString = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnectionList()[this.comboBoxSynColTaxDatabase.Text].ConnectionString;

                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(TaxonConnectionString);
                try
                {
                    con.Open();
                    Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand("", con);
                    foreach (System.Data.DataRow R in this._dtSynColTax.Rows)
                    {
                        string NameID = DiversityWorkbench.WorkbenchUnit.getIDFromURI(R[3].ToString());
                        SQL = "SELECT T.TaxonNameCache FROM dbo.TaxonName T " +
                            " WHERE T.NameID = " + NameID;
                        C.CommandText = SQL;
                        string Taxon = "";
                        try
                        {
                            Taxon = C.ExecuteScalar()?.ToString() ?? string.Empty;
                        }
                        catch (System.Exception ex)
                        {
                            //RowsToDelete.Add(R);
                        }


                        if (Taxon.Trim() == R[1].ToString().Trim() || Taxon.Length == 0)
                        {
                            RowsToDelete.Add(R);
                        }
                        else
                        {
                            R[2] = Taxon.Trim();
                            if (R[2].ToString().Length == 0)
                                RowsToDelete.Add(R);
                            else
                            {
                                string GenusPresent = R[1].ToString();
                                if (GenusPresent.IndexOf(' ') > -1)
                                    GenusPresent = GenusPresent.Substring(0, GenusPresent.IndexOf(' '));
                                string GenusTaxon = Taxon;
                                if (Taxon.IndexOf(' ') > -1)
                                    GenusTaxon = Taxon.Substring(0, Taxon.IndexOf(' ', 0));
                                if (GenusPresent != GenusTaxon)
                                    R[0] = false;
                            }
                        }
                    }
                }
                catch (System.Exception ex)
                {
                }
                finally
                {
                    con.Close();
                    con.Dispose();
                }

                foreach (System.Data.DataRow R in RowsToDelete)
                    R.Delete();
                this._dtSynColTax.AcceptChanges();
                if (this._dtSynColTax.Rows.Count > 0)
                {
                    this.labelSynColTaxCheck.Text = this._dtSynColTax.Rows.Count.ToString() + " differences to " + this.comboBoxSynColTaxDatabase.Text + " found";
                    this.buttonSynColTaxUpdate.Enabled = true;
                }
                else
                {
                    this.labelSynColTaxCheck.Text = "No differences found";
                    this.buttonSynColTaxUpdate.Enabled = false;
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        private async System.Threading.Tasks.Task SynchroniseTaxonNamesViaWebservice(string BaseURL)
        {
            try
            {
                // getting all Names starting with the BaseURL
                string SQL = "SELECT ";
                string SqlOrder = " ORDER BY Identification.TaxonomicName ";
                if (!this.checkBoxSynColTaxIncludeAccNr.Checked) SQL += " DISTINCT ";
                SQL += " cast(1 as bit) AS OK,";
                SQL += " Identification.TaxonomicName AS [TaxonomicName in DiversityCollection], '' AS [Name in " + this.comboBoxSynColTaxDatabase.Text + "], Identification.NameURI ";
                if (this.checkBoxSynColTaxIncludeAccNr.Checked) SQL += ", CollectionSpecimen.AccessionNumber, CollectionSpecimen.CollectionSpecimenID ";
                SQL += " FROM Identification ";
                if (this.comboBoxSynColTaxTaxonomicGroup.Text.Length > 0)
                    SQL += " INNER JOIN IdentificationUnit ON Identification.CollectionSpecimenID = IdentificationUnit.CollectionSpecimenID " +
                        " AND Identification.IdentificationUnitID = IdentificationUnit.IdentificationUnitID ";
                SQL += " INNER JOIN CollectionProject ON Identification.CollectionSpecimenID = CollectionProject.CollectionSpecimenID " +
                    " INNER JOIN CollectionSpecimen ON Identification.CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID " +
                    " WHERE (NOT (Identification.NameURI IS NULL)) " +
                    " AND (Identification.NameURI LIKE '" + BaseURL + "%')";
                if (this.comboBoxSynColTaxTaxonomicGroup.Text.Length > 0)
                    SQL += " AND IdentificationUnit.TaxonomicGroup = '" + this.comboBoxSynColTaxTaxonomicGroup.Text + "'";
                if (this.comboBoxSynColTaxProject.SelectedIndex > -1)
                {
                    int ProjectID = 0;
                    if (this.comboBoxSynColTaxProject.SelectedItem != null)
                    {
                        System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColTaxProject.SelectedItem;
                        if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                            SQL += " AND CollectionProject.ProjectID = " + ProjectID.ToString();
                        else
                            return;
                    }
                    else
                        return;
                    //if (!int.TryParse(this.comboBoxSynColTaxProject.SelectedValue.ToString(), out ProjectID))
                    //    return;
                    //else
                    //    SQL += " AND CollectionProject.ProjectID = " + ProjectID.ToString();
                }
                SQL += SqlOrder;
                //if (this._dtSynColTax == null) 
                this._dtSynColTax = new DataTable();
                //else this._dtSynColTax.Clear();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(this._dtSynColTax);
                this.dataGridViewSynColTax.DataSource = this._dtSynColTax;

                //System.Data.DataTable dtItem = new DataTable();

                // Removing the rows where no difference is found
                System.Collections.Generic.List<System.Data.DataRow> RowsToDelete = new List<DataRow>();

                DwbServiceEnums.DwbService currentDwbService =
                    getCurrentService(this.comboBoxSynColTaxDatabase.Text);
                IDwbWebservice<DwbSearchResult, DwbSearchResultItem, DwbEntity> _api =
                    DwbServiceProviderAccessor.GetDwbWebservice(currentDwbService);
                if (_api != null)
                {
                    foreach (System.Data.DataRow R in this._dtSynColTax.Rows)
                    {
                        string nameUri = R["NameURI"]?.ToString();
                        if (!_api.IsValidUrl(nameUri))
                        {
                            MessageBox.Show("The selected value is not a valid URI or unit ID.", "Invalid Selection",
                                MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return;
                        }

                        DwbEntity clientEntity = await getApiDetailModel(_api, nameUri);
                        if (clientEntity == null)
                            return;

                        string NameOfTaxon = clientEntity.GetMappedApiEntityModel().GetDisplayText() ?? string.Empty;
                        string CurrentName = R[1].ToString();
                        if (NameOfTaxon.Trim() == CurrentName.Trim())
                            RowsToDelete.Add(R);
                        else
                        {
                            R[2] = NameOfTaxon.Trim();
                            if (R[2].ToString().Length == 0)
                                RowsToDelete.Add(R);
                        }
                    }
                }
                foreach (System.Data.DataRow R in RowsToDelete)
                    R.Delete();
                this._dtSynColTax.AcceptChanges();
                if (this._dtSynColTax.Rows.Count > 0)
                {
                    this.labelSynColTaxCheck.Text = this._dtSynColTax.Rows.Count.ToString() + " differences to " + this.comboBoxSynColTaxDatabase.Text + " found";
                    this.buttonSynColTaxUpdate.Enabled = true;
                }
                else
                {
                    this.labelSynColTaxCheck.Text = "No differences found";
                    this.buttonSynColTaxUpdate.Enabled = false;
                }
            }
            catch (System.Exception ex)
            {
                MessageBox.Show("An error occurred when trying to synchronize with the webservice: " + ex.Message, "SynchronizeError", MessageBoxButtons.OK, MessageBoxIcon.Error);
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }
        
        private void buttonSynColTaxUpdate_Click(object sender, EventArgs e)
        {
            if (this.comboBoxSynColTaxDatabase.Text.Length == 0 && !this.checkBoxSynColTaxViaCacheDB.Checked)
            {
                System.Windows.Forms.MessageBox.Show("Please choose a database");
                return;
            }
            System.Data.DataRow[] RR = this._dtSynColTax.Select("OK = 1", "");
            if (RR.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }
            string BaseURL = "";
            string SQL = "";
            string Message = "";
            switch (this.SourceForSynchronisation)
            {
                case SynchronisationSource.ModuleOnLinkedServer:
                case SynchronisationSource.ModuleOnSameServer:
                    string Prefix = "dbo.";
                    DiversityWorkbench.ServerConnection SC = null;
                    if (this.checkBoxSynColTaxViaCacheDB.Checked)
                    {
                        Prefix = "[" + CacheDatabase.CacheDB.CacheDatabaseName() + "].[dbo].";
                    }
                    else
                    {
                        SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnectionList()[this.comboBoxSynColTaxDatabase.Text];
                        if (SC.LinkedServer.Length > 0)
                            Prefix = "[" + SC.LinkedServer + "].[" + SC.DatabaseName + "].dbo.";
                        else Prefix = "[" + SC.DatabaseName + "].dbo.";
                        BaseURL = SC.BaseURL;
                    }
                    try
                    {
                        SQL = "UPDATE I SET I.TaxonomicName = T.TaxonName";
                        if (!this.checkBoxSynColTaxViaCacheDB.Checked)
                            SQL += "Cache";
                        SQL += " FROM Identification I INNER JOIN " + Prefix;
                        if (this.checkBoxSynColTaxViaCacheDB.Checked)
                            SQL += "TaxonSynonymy T " +
                                " ON I.NameURI = T.NameURI AND I.TaxonomicName <> T.TaxonName ";
                        else
                            SQL += "TaxonName T " +
                                " ON RTRIM(SUBSTRING(I.NameURI, LEN('" + BaseURL + "') + 1, 255))  " +
                                " = CAST(T.NameID AS varchar) AND  " +
                                " I.TaxonomicName <> T.TaxonNameCache ";
                        //" FROM Identification I INNER JOIN " + Prefix + "TaxonName T " +
                        //" ON RTRIM(SUBSTRING(I.NameURI, LEN('" + BaseURL + "') + 1, 255))  " +
                        //" = CAST(T.NameID AS varchar) AND  " +
                        //" I.TaxonomicName <> T.TaxonNameCache " +
                        SQL += " INNER JOIN CollectionProject P ON I.CollectionSpecimenID = P.CollectionSpecimenID " +
                                " INNER JOIN CollectionSpecimen S ON I.CollectionSpecimenID = S.CollectionSpecimenID " +
                                " WHERE (NOT (I.NameURI IS NULL)) " +
                                " AND (I.NameURI LIKE '" + BaseURL + "%')";
                        if (this.comboBoxSynColTaxProject.SelectedIndex > -1)
                        {
                            int ProjectID = 0;
                            if (this.comboBoxSynColTaxProject.SelectedItem != null)
                            {
                                System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColTaxProject.SelectedItem;
                                if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                                    SQL += " AND P.ProjectID = " + ProjectID.ToString();
                                else
                                    return;
                            }
                            else return;
                            //if (!int.TryParse(this.comboBoxSynColTaxProject.SelectedValue.ToString(), out ProjectID))
                            //    return;
                            //else
                            //    SQL += " AND P.ProjectID = " + ProjectID.ToString();
                        }

                        string LinkRestriction = this.LinkRestriction(this.dataGridViewSynColTax, 0, 3);
                        if (LinkRestriction == " IS NULL ")
                            return;
                        if (LinkRestriction.Length > 0)
                            SQL += " AND I.NameURI " + LinkRestriction;

                        Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
                        Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                        C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                        try
                        {
                            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                            con.Open();
                            //Message = 
                            C.ExecuteScalar();//.ToString();
                            System.Windows.Forms.MessageBox.Show("Update finished");
                        }
                        catch (Exception ex)
                        {
                            Message = "Update failed: " + ex.Message;
                        }
                        finally
                        {
                            con.Close();
                            this.Cursor = System.Windows.Forms.Cursors.Default;
                            //this.dataGridViewSynColTax.DataSource = null;
                        }
                        if (Message.Length > 0)
                        {
                            int iTest;
                            if (!int.TryParse(Message, out iTest)) // some messages contain numbers returned by the server with no meaning in this routine
                                System.Windows.Forms.MessageBox.Show(Message);
                        }
                        else
                        {
                            this.dataGridViewSynColTax.DataSource = null;
                            this.buttonSynColTaxUpdate.Enabled = false;
                            //System.Windows.Forms.MessageBox.Show("Update finished");
                        }
                    }
                    catch (System.Exception ex)
                    {
                    }
                    break;
                default:
                    if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DatabaseAndServiceURIs().TryGetValue(this.comboBoxSynColTaxDatabase.Text, out BaseURL))
                    {
                        this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                        int iError = 0;
                        for (int i = 0; i < this.dataGridViewSynColTax.Rows.Count; i++)
                        {
                            if (this.dataGridViewSynColTax.Rows[i].Cells[0].Value.ToString() == "True")
                            {
                                string Taxon = this._dtSynColTax.Rows[i][2].ToString();
                                if (Taxon.IndexOf("'") > -1) Taxon = Taxon.Replace("'", "''");
                                SQL = "UPDATE Identification SET Identification.TaxonomicName = N'" + Taxon + "' FROM Identification ";
                                if (this.comboBoxSynColTaxTaxonomicGroup.Text.Length > 0)
                                    SQL += " INNER JOIN IdentificationUnit ON Identification.CollectionSpecimenID = IdentificationUnit.CollectionSpecimenID " +
                                        " AND Identification.IdentificationUnitID = IdentificationUnit.IdentificationUnitID ";
                                SQL += " INNER JOIN CollectionProject ON Identification.CollectionSpecimenID = CollectionProject.CollectionSpecimenID " +
                                    " INNER JOIN CollectionSpecimen ON Identification.CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID " +
                                    " WHERE (Identification.NameURI = '" + this._dtSynColTax.Rows[i]["NameURI"].ToString() + "')";
                                if (this.comboBoxSynColTaxTaxonomicGroup.Visible && this.comboBoxSynColTaxTaxonomicGroup.Text.Length > 0)
                                    SQL += " AND IdentificationUnit.TaxonomicGroup = '" + this.comboBoxSynColTaxTaxonomicGroup.Text + "'";
                                if (this.comboBoxSynColTaxProject.SelectedIndex > -1)
                                {
                                    int ProjectID = 0;
                                    if (this.comboBoxSynColTaxProject.SelectedItem != null)
                                    {
                                        System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColTaxProject.SelectedItem;
                                        if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                                            SQL += " AND CollectionProject.ProjectID = " + ProjectID.ToString();
                                        else
                                            return;
                                    }
                                    else return;
                                    //if (!int.TryParse(this.comboBoxSynColTaxProject.SelectedValue.ToString(), out ProjectID))
                                    //    return;
                                    //else
                                    //    SQL += " AND CollectionProject.ProjectID = " + ProjectID.ToString();
                                }
                                if (this.checkBoxSynColTaxIncludeAccNr.Checked)
                                    SQL += " AND CollectionSpecimen.CollectionSpecimenID = " + this._dtSynColTax.Rows[i]["CollectionSpecimenID"].ToString();
                                Microsoft.Data.SqlClient.SqlConnection conn = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, conn);
                                try
                                {
                                    conn.Open();
                                    C.ExecuteNonQuery();
                                }
                                catch (Exception ex)
                                {
                                    iError++;
                                    Message += ex.Message + "\r\n";
                                }
                                finally
                                {
                                    conn.Close();
                                }
                            }
                        }
                        if (iError > 0)
                        {
                            if (iError == this.dataGridViewSynColTax.Rows.Count)
                                System.Windows.Forms.MessageBox.Show("Update failed");
                            else
                                System.Windows.Forms.MessageBox.Show("Update failed for " + iError.ToString() + " datasets");
                        }
                        else
                        {
                            System.Windows.Forms.MessageBox.Show("Update finished");
                        }
                        this.dataGridViewSynColTax.DataSource = null;
                        this.buttonSynColTaxUpdate.Enabled = false;
                    }
                    break;
            }
            //this.dataGridViewSynColTax.DataSource = null;
            //System.Windows.Forms.MessageBox.Show("Update finished");
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonSynColTaxSelectAll_Click(object sender, EventArgs e)
        {
            if (this._dtSynColTax == null || this._dtSynColTax.Rows.Count == 0)
                return;

            foreach (System.Data.DataRow R in this._dtSynColTax.Rows)
            {
                R[0] = true;
            }
        }

        private void buttonSynColTaxSelectNone_Click(object sender, EventArgs e)
        {
            if (this._dtSynColTax == null || this._dtSynColTax.Rows.Count == 0)
                return;

            foreach (System.Data.DataRow R in this._dtSynColTax.Rows)
            {
                R[0] = false;
            }
        }

        private void buttonSynColTaxSelectSameName_Click(object sender, EventArgs e)
        {
            if (this._dtSynColTax == null || this._dtSynColTax.Rows.Count == 0)
                return;

            foreach (System.Data.DataRow R in this._dtSynColTax.Rows)
            {
                string[] ColName = R[1].ToString().Split(new char[] { ' ' });
                string[] TaxName = R[2].ToString().Split(new char[] { ' ' });
                bool OK = true;
                if (ColName.Length < 2 || TaxName.Length < 2)
                    OK = false;
                else
                {
                    for (int i = 0; i < 2; i++)
                    {
                        if (ColName[i] != TaxName[i])
                        {
                            OK = false;
                            break;
                        }
                    }
                }
                R[0] = OK;
            }
        }

        /// <summary>
        /// Return the 
        /// </summary>
        /// <param name="Grid"></param>
        /// <param name="IndexSelectionCell"></param>
        /// <param name="IndexLinkCell"></param>
        /// <returns></returns>
        private string LinkRestriction(System.Windows.Forms.DataGridView Grid, int IndexSelectionCell, int IndexLinkCell)
        {
            string Restriction = "";
            System.Collections.Generic.List<string> InList = new List<string>();
            System.Collections.Generic.List<string> NotInList = new List<string>();
            if (Grid.Rows.Count > 0)
            {
                foreach (System.Windows.Forms.DataGridViewRow R in Grid.Rows)
                {
                    string Link = R.Cells[IndexLinkCell].Value.ToString();
                    if (R.Cells[IndexSelectionCell].Value.ToString() == "True")
                    {
                        if (!InList.Contains(Link))
                            InList.Add(Link);
                    }
                    else
                    {
                        if (!NotInList.Contains(Link))
                            NotInList.Add(Link);
                    }
                }
            }
            if (InList.Count == 0)
            {
                Restriction = " IS NULL ";
                System.Windows.Forms.MessageBox.Show("Nothing selected");
            }
            else if (NotInList.Count > 0)
            {
                if (NotInList.Count > InList.Count)
                {
                    foreach (string s in InList)
                    {
                        if (Restriction.Length > 0) Restriction += ", ";
                        Restriction += "'" + s + "'";
                    }
                    Restriction = " IN (" + Restriction + ")";
                }
                else
                {
                    foreach (string s in NotInList)
                    {
                        if (Restriction.Length > 0) Restriction += ", ";
                        Restriction += "'" + s + "'";
                    }
                    Restriction = " NOT IN (" + Restriction + ")";
                }
            }
            return Restriction;
        }

        private void checkBoxSynColTaxIncludeAccNr_Click(object sender, EventArgs e)
        {
            if (this.checkBoxSynColTaxIncludeAccNr.Checked) this.buttonSynColTaxCheckDataset.Visible = true;
            else this.buttonSynColTaxCheckDataset.Visible = false;
        }

        private void buttonSynColTaxCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSynColTax.SelectedRows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewSynColTax.SelectedRows[0];
            bool OK = true;
            try { string test = R.Cells["CollectionSpecimenID"].Value.ToString(); }
            catch { OK = false; }
            if (OK)
            {
                if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
                {
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                else
                    this.DialogResult = DialogResult.Cancel;
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            }
        }

        private void comboBoxSynColTaxTaxonNameProject_DropDown(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataTable dt = new DataTable();
                string SQL = "SELECT ProjectID, Project " +
                    "FROM " + this.comboBoxSynColTaxDatabase.Text + ".dbo.ProjectProxy " +
                    "ORDER BY Project";
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                this.comboBoxSynColTaxTaxonNameProject.DataSource = dt;
                this.comboBoxSynColTaxTaxonNameProject.DisplayMember = "Project";
                this.comboBoxSynColTaxTaxonNameProject.ValueMember = "ProjectID";
            }
            catch
            {
            }
        }

        #endregion

        #region TaxonNames via text

        #region init

        private void setSynchronizeColTaxTextDatabaseParameters()
        {
            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DataBaseURIs().TryGetValue(this.comboBoxSynColTaxTextDatabase.Text, out this._SynchronizeColTaxTextBaseURL))
            {
                this._SynchronizeColTaxTextTaxonDatabase = this.comboBoxSynColTaxTextDatabase.SelectedItem.ToString();
                this._SynchronizeColTaxTextConnectionString = DiversityWorkbench.Settings.ConnectionString;
                this._SynchronizeColTaxTextSameServer = true;
                foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnections())
                {
                    if (KV.Value.DisplayText == this._SynchronizeColTaxTextTaxonDatabase)
                    {
                        this._SynchronizeColTaxTextConnectionString = KV.Value.ConnectionString;
                        this._SynchronizeColTaxTextTaxonDatabase = KV.Value.DatabaseName;
                        this._SynchronizeColTaxTextBaseURL = KV.Value.BaseURL;
                        this._SynchronizeColTaxTextLinkedServer = KV.Value.LinkedServer;
                        if (KV.Value.DatabaseServer != DiversityWorkbench.Settings.DatabaseServer)
                            this._SynchronizeColTaxTextSameServer = false;
                    }
                }
                this.labelSynColTaxTextTaxonNameProjec.Visible = true;
                this.comboBoxSynColTaxTextTaxonNameProject.Visible = true;
                this.comboBoxSynColTaxTextTaxonNameProject_DropDown(null, null);
                this.radioButtonSynColTaxTextCompareParts.Enabled = true;
                this.numericUpDownSynColTaxTextCompareParts.Enabled = true;
                this.tableLayoutPanelSynColTaxTextCompareParts.Enabled = true;
            }
            else if (isTaxWebService(this.comboBoxSynColTaxTextDatabase.Text))
            {
                this.labelSynColTaxTextTaxonNameProjec.Visible = false;
                this.comboBoxSynColTaxTextTaxonNameProject.Visible = false;
                this.radioButtonSynColTaxTextCompareParts.Enabled = true;
                this.numericUpDownSynColTaxTextCompareParts.Enabled = true;
                this.tableLayoutPanelSynColTaxTextCompareParts.Enabled = true;
                this.checkBoxSynColTaxTextComparePartsRestrictToLastIdent.Checked = true;
                this._SynchronizeColTaxTextTaxonDatabase = "";
            }
            else
            {
                this.labelSynColTaxTextTaxonNameProjec.Visible = false;
                this.comboBoxSynColTaxTextTaxonNameProject.Visible = false;
                this.radioButtonSynColTaxTextCompareParts.Enabled = false;
                this.numericUpDownSynColTaxTextCompareParts.Enabled = false;
                this.tableLayoutPanelSynColTaxTextCompareParts.Enabled = false;
            }
            this.dataGridViewSynColTaxText.DataSource = null;
            this._dtSynColTaxText = new DataTable();
            this.radioButtonSynColTaxTextCompareAll.Checked = true;
        }

        #endregion

        #region Search options

        private void checkBoxSynColTaxTextIncludeAccNr_Click(object sender, EventArgs e)
        {
            if (this.checkBoxSynColTaxTextIncludeAccNr.Checked) this.buttonSynColTaxTextCheckDataset.Visible = true;
            else this.buttonSynColTaxTextCheckDataset.Visible = false;
        }

        private void radioButtonSynColTaxTextCompareAll_CheckedChanged(object sender, EventArgs e)
        {
            this.buttonSynColTaxTextUpdate.Enabled = false;
            this.radioButtonSynColTaxTextComparePartsInsertName.Enabled = this.radioButtonSynColTaxTextCompareParts.Checked;
            this.radioButtonSynColTaxTextComparePartsUpdateName.Enabled = this.radioButtonSynColTaxTextCompareParts.Checked;
            this.checkBoxSynColTaxTextIncludeAnyIdentificationInfo.Enabled = this.radioButtonSynColTaxTextCompareParts.Checked;

            this.checkBoxSynColTaxTextCompareAllExcludeAuthors.Enabled = !this.radioButtonSynColTaxTextCompareParts.Checked;

            this.setFuzzySearch();
        }

        private void comboBoxSynColTaxTextDatabase_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.labelSynColTaxCheckText.Text = "";
            this.labelSynColTaxTextDatabase.Text = this.labelSynColTaxTextDatabase.Tag.ToString();
            this.buttonSynColTaxTextUpdate.Enabled = false;
            this.checkBoxSynColTaxTextIncludeHierarchy.Checked = false;
            this.checkBoxSynColTaxTextIncludeHierarchy.Visible = false;
            string DB = "";
            if (this.comboBoxSynColTaxTextDatabase.SelectedIndex > -1)
            {
                this.numericUpDownSynColTaxTextMax.Visible = true;
                this.checkBoxSynColTaxTextMax.Visible = true;
                if (isTaxWebService(this.comboBoxSynColTaxTextDatabase.Text)) {
                    this.numericUpDownSynColTaxTextMax.Value = 50;
                }
                else
                {
                    //this.numericUpDownSynColTaxTextMax.Visible = true;
                    //this.checkBoxSynColTaxTextMax.Visible = true;
                    this.numericUpDownSynColTaxTextMax.Value = 100;
                    DB = this.comboBoxSynColTaxTextDatabase.Text;
                    if (DB.IndexOf("].DiversityTaxonNames_") > -1)
                        DB = DB.Substring(DB.IndexOf("].DiversityTaxonNames_") + "].DiversityTaxonNames_".Length);
                    else DB = "";
                }
                this.labelSynColTaxTextDatabase.Text = this.labelSynColTaxTextDatabase.Tag.ToString() + "  " + DB;
                this._SynchronizeColTaxTextBaseURL = null;
                this._SynchronizeColTaxTextConnectionString = null;
                this._SynchronizeColTaxTextTaxonDatabase = null;
                this._SynchronizeColTaxTextSameServer = null;
                this.setSynchronizeColTaxTextDatabaseParameters();
            }
        }

        private void comboBoxSynColTaxTextTaxonNameProject_DropDown(object sender, EventArgs e)
        {
            try
            {
                string SelectedDatabase = this.comboBoxSynColTaxTextDatabase.SelectedItem.ToString();
                string ConnectionString = DiversityWorkbench.Settings.ConnectionString;
                string Database = this.comboBoxSynColTaxTextDatabase.Text;
                string LinkedServer = "";
                foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnections())
                {
                    if (KV.Value.DisplayText == SelectedDatabase)
                    {
                        ConnectionString = KV.Value.ConnectionString;
                        Database = KV.Value.DatabaseName;
                        LinkedServer = KV.Value.LinkedServer;
                        break;
                    }
                }

                System.Data.DataTable dt = new DataTable();
                string SQL = "SELECT NULL AS ProjectID, NULL AS Project " +
                    "UNION SELECT ProjectID, Project " +
                    "FROM " + this.SynchronizeColTaxTextPrefix + "ProjectList " +
                    "ORDER BY Project";
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, ConnectionString);
                ad.Fill(dt);
                this.comboBoxSynColTaxTextTaxonNameProject.DataSource = dt;
                this.comboBoxSynColTaxTextTaxonNameProject.DisplayMember = "Project";
                this.comboBoxSynColTaxTextTaxonNameProject.ValueMember = "ProjectID";
            }
            catch (System.Exception ex)
            {
            }
        }

        private void comboBoxSynColTaxTextRank_DropDown(object sender, EventArgs e)
        {
            try
            {
                //string SelectedDatabase = this.SynchronizeColTaxTextTaxonDatabase;
                //string Prefix = this.SynchronizeColTaxTextTaxonDatabase + ".dbo.";
                //if (this.SynchronizeColTaxTextLinkedServer.Length > 0)
                //    Prefix = "[" + 
                string SQL = "SELECT NULL AS Code, NULL AS DisplayText, NULL AS DisplayOrder UNION SELECT R.Code, R.DisplayText, R.DisplayOrder ";
                SQL += "FROM ";
                SQL += this.SynchronizeColTaxTextPrefix + "TaxonNameTaxonomicRank_Enum AS R ORDER BY DisplayOrder";
                System.Data.DataTable dt = new DataTable();
                string ConnectionString = DiversityWorkbench.Settings.ConnectionString;
                if (!(bool)this.SynchronizeColTaxTextSameServer)
                    ConnectionString = this.SynchronizeColTaxTextConnectionString;
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, ConnectionString);
                ad.Fill(dt);
                this.comboBoxSynColTaxTextRank.DataSource = dt;
                this.comboBoxSynColTaxTextRank.DisplayMember = "DisplayText";
                this.comboBoxSynColTaxTextRank.ValueMember = "Code";
            }
            catch (System.Exception ex) { }
        }

        private void checkBoxSynColTaxTextCompareAllExcludeAuthors_Click(object sender, EventArgs e)
        {
            this.setFuzzySearch();
        }

        private void setFuzzySearch()
        {
            if (this.radioButtonSynColTaxTextCompareParts.Checked || this.checkBoxSynColTaxTextCompareAllExcludeAuthors.Checked)
                this.checkBoxSynColTaxTextFuzzySearch.Enabled = true;
            else this.checkBoxSynColTaxTextFuzzySearch.Enabled = false;
        }

        private void checkBoxSynColTaxTextFuzzySearch_Click(object sender, EventArgs e)
        {
            this.numericUpDownSynColTaxTextFuzzySearch.Enabled = this.checkBoxSynColTaxTextFuzzySearch.Checked;
        }

        #endregion

        #region Cache DB

        private void checkBoxSynColTaxTextViaCacheDB_Click(object sender, EventArgs e)
        {
            this.comboBoxSynColTaxTextDatabase.Enabled = !this.checkBoxSynColTaxTextViaCacheDB.Checked;
            this.comboBoxSynColTaxTextTaxonNameProject.Enabled = !this.checkBoxSynColTaxTextViaCacheDB.Checked;
        }

        #endregion

        #region Starting query

        private async void buttonSynColTaxTextCheck_Click(object sender, EventArgs e)
        {
            try
            {
                this.dataGridViewSynColTaxText.DataSource = null;
                this._dtSynColTaxText = new DataTable();
                int ProjectID = 0;
                string TaxGroup = "";
                if (!this.allValuesSetForTaxonTextSynchro(ref ProjectID, ref TaxGroup)) return;
                bool setColumnWidth = true;
                if (this.checkBoxSynColTaxTextViaCacheDB.Checked)
                {
                    // Cache DB
                    this.SynchronizeColTaxTextWithWorkbenchModuleOnSameServer();
                }
                else
                {
                    // Workbench modules
                    if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DataBaseURIs().TryGetValue(this.comboBoxSynColTaxTextDatabase.Text, out this._SynchronizeColTaxTextBaseURL))
                    {
                        if (this.comboBoxSynColTaxTextTaxonNameProject.SelectedValue == null || this.comboBoxSynColTaxTextTaxonNameProject.SelectedValue == System.DBNull.Value)
                        {
                            System.Windows.Forms.MessageBox.Show("Please select a project in the taxonomic names database");
                            return;
                        }
                        if ((bool)this.SynchronizeColTaxTextSameServer && this.radioButtonSynColTaxTextCompareAll.Checked && !this.checkBoxSynColTaxTextCompareAllExcludeAuthors.Checked)
                        {
                            this.SynchronizeColTaxTextWithWorkbenchModuleOnSameServer();
                        }
                        else
                        {
                            this.SynchronizeColTaxTextWithWorkbenchModuleOnDifferentServer(this.SynchronizeColTaxTextTaxonDatabase, this.SynchronizeColTaxTextConnectionString, this.SynchronizeColTaxTextBaseURL);
                            //this.SynchronizeColTaxTextSetGridColors();
                        }
                    }
                    // Webservices
                    else if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DatabaseAndServiceURIs().TryGetValue(this.comboBoxSynColTaxTextDatabase.Text, out this._SynchronizeColTaxTextBaseURL))
                    {
                        this.radioButtonSynColTaxTextCompareParts.Enabled = true;
                        await this.SynchronizeColTaxTextWithWebService(this._SynchronizeColTaxTextBaseURL);
                    }
                }

                if (this.dataGridViewSynColTaxText.ColumnCount > 1)
                    setColumnWidth = true;
                if (this.dataGridViewSynColTaxText.ColumnCount > 0 && setColumnWidth)
                {
                    this.dataGridViewSynColTaxText.Columns[0].AutoSizeMode = DataGridViewAutoSizeColumnMode.ColumnHeader;
                    this.dataGridViewSynColTaxText.Columns[1].AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells;
                    this.dataGridViewSynColTaxText.Columns[2].AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells;
                }
                this.dataGridViewSynColTaxText.ReadOnly = false;
                for (int i = 1; i < this.dataGridViewSynColTaxText.ColumnCount; i++)
                {
                    this.dataGridViewSynColTaxText.Columns[i].ReadOnly = true;
                }
                for (int i = 0; i < this.dataGridViewSynColTaxText.ColumnCount; i++)
                {
                    this.dataGridViewSynColTaxText.Columns[i].SortMode = DataGridViewColumnSortMode.NotSortable;
                }
                //this.dataGridViewSynColTaxText.Columns[1].ReadOnly = true;
                //this.dataGridViewSynColTaxText.Columns[2].ReadOnly = true;
                //this.dataGridViewSynColTaxText.Columns[3].ReadOnly = true;
                this.progressBarSynColTaxText.Visible = false;
            }
            catch (System.Exception ex) { }
        }

        #endregion

        #region Selection of datasets

        private void buttonSynColTaxTextCheckAll_Click(object sender, EventArgs e)
        {
            // #173
            if (this._dtSynColTaxText == null) return;

            if (this.SynColTaxTextCheckHasBeenEdited())
            {
                if (System.Windows.Forms.MessageBox.Show("Are you sure that you want to select all rows?", "Select all?", MessageBoxButtons.OKCancel) == System.Windows.Forms.DialogResult.Cancel)
                    return;
            }
            foreach (System.Data.DataRow R in this._dtSynColTaxText.Rows)
                R[0] = true;
        }

        private void buttonSynColTaxTextCheckNone_Click(object sender, EventArgs e)
        {
            // #173
            if (this._dtSynColTaxText == null) return;

            if (this.SynColTaxTextCheckHasBeenEdited())
            {
                if (System.Windows.Forms.MessageBox.Show("Are you sure that you want to deselect all rows?", "Deselect all?", MessageBoxButtons.OKCancel) == System.Windows.Forms.DialogResult.Cancel)
                    return;
            }
            foreach (System.Data.DataRow R in this._dtSynColTaxText.Rows)
                R[0] = false;
        }

        private bool SynColTaxTextCheckHasBeenEdited()
        {
            // #173
            if (this._dtSynColTaxText == null) return false;

            bool Edited = false;
            System.Data.DataRow[] rrYes = this._dtSynColTaxText.Select("OK = 1", "");
            System.Data.DataRow[] rrNo = this._dtSynColTaxText.Select("OK = 0", "");
            if (rrNo.Length > 0 && rrYes.Length > 0)
                Edited = true;
            return Edited;
        }

        #endregion

        #region Checking single dataset

        private void buttonSynColTaxTextCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSynColTaxText.SelectedCells.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            int Position = this.dataGridViewSynColTaxText.SelectedCells[0].RowIndex;
            if (int.TryParse(this.dataGridViewSynColTaxText.Rows[Position].Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
            {
                DiversityCollection.Forms.FormCollectionSpecimen f = new Forms.FormCollectionSpecimen(this._CollectionSpecimenID, false, false);
                f.setViewMode(Forms.FormCollectionSpecimen.ViewMode.SingleInspectionMode);
                f.Width = this.Width - 10;
                f.Height = this.Height - 10;
                f.ShowDialog();
                //this.DialogResult = DialogResult.OK;
                //this.Close();
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
                this.DialogResult = DialogResult.Cancel;
            }

        }

        #endregion

        #region Export

        private void buttonSynColTaxTextExport_Click(object sender, EventArgs e)
        {
            try
            {
                string Directory = DiversityWorkbench.WorkbenchResources.WorkbenchDirectory.HelpProviderNameSpace() + "\\Maintenance";
                System.IO.DirectoryInfo D = new System.IO.DirectoryInfo(Directory);
                if (!D.Exists) D.Create();
                string File = this.SynColTaxTextExportFileName("SyncForTaxaViaText");
                if (File.Length == 0)
                    return;
                File = Directory + "\\" + File + ".txt";
                System.IO.StreamWriter w = new System.IO.StreamWriter(File, false, System.Text.Encoding.UTF8);
                string Header = "";
                foreach (System.Data.DataColumn C in this._dtSynColTaxText.Columns)
                {
                    if (C.ColumnName == "OK") continue;
                    if (Header.Length > 0) Header += "\t";
                    Header += C.ColumnName;
                }
                w.WriteLine(Header);
                foreach (System.Data.DataRow R in this._dtSynColTaxText.Rows)
                {
                    string Row = "";
                    foreach (System.Data.DataColumn C in this._dtSynColTaxText.Columns)
                    {
                        if (C.ColumnName == "OK") continue;
                        if (Row.Length > 0) Row += "\t";
                        Row += R[C.ColumnName].ToString();
                    }
                    w.WriteLine(Row);
                }
                w.Close();
                w.Dispose();
                System.IO.FileInfo FI = new System.IO.FileInfo(File);
                this.SynColTaxTextExportGetFile(FI);
            }
            catch (Exception)
            {
                System.Windows.Forms.MessageBox.Show("Saving data failed");
            }
        }

        private void buttonSynColTaxTextExportAll_Click(object sender, EventArgs e)
        {
            try
            {
                string Directory = DiversityWorkbench.WorkbenchResources.WorkbenchDirectory.HelpProviderNameSpace() + "\\Maintenance";
                System.IO.DirectoryInfo D = new System.IO.DirectoryInfo(Directory);
                if (!D.Exists) D.Create();
                string File = this.SynColTaxTextExportFileName("SyncForTaxaViaTextAll");
                if (File.Length == 0)
                    return;
                File = Directory + "\\" + File + ".txt";
                System.IO.StreamWriter w = new System.IO.StreamWriter(File, false, System.Text.Encoding.UTF8);
                string Header = "Name in Collection\tName in TaxonNames\tNameURI\tSynonymy";
                w.WriteLine(Header);
                foreach (System.Data.DataRow R in this._dtSynColTaxText.Rows)
                {
                    string Row = "";
                    foreach (System.Data.DataColumn C in this._dtSynColTaxText.Columns)
                    {
                        if (C.ColumnName == "OK") continue;
                        if (Row.Length > 0) Row += "\t";
                        if (R["Similarities"].ToString() == "1")
                        {
                            if (C.ColumnName != "Similarities")
                                Row += R[C.ColumnName].ToString();
                        }
                        else
                        {
                            Row += R[C.ColumnName].ToString();
                            break;
                        }
                    }
                    w.WriteLine(Row);
                    if (this._SynColTaxTextNameLists.ContainsKey(R[1].ToString()))
                    {
                        foreach (System.Data.DataRow Rsim in this._SynColTaxTextNameLists[R[1].ToString()].Rows)
                        {
                            Row = "\t" + Rsim[1].ToString() + "\t" + Rsim[0].ToString() + "\t" + Rsim[2].ToString();
                            w.WriteLine(Row);
                        }
                    }
                    w.WriteLine("");
                }
                w.Close();
                w.Dispose();
                System.IO.FileInfo FI = new System.IO.FileInfo(File);
                this.SynColTaxTextExportGetFile(FI);
            }
            catch (Exception ex)
            {
                System.Windows.Forms.MessageBox.Show("Saving data failed: " + ex.Message);
            }
        }

        private string SynColTaxTextExportFileName(string File)
        {
            DiversityWorkbench.Forms.FormGetString f = new DiversityWorkbench.Forms.FormGetString("File name", "Please edit or enter name for the file", File);
            f.ShowDialog();
            if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
            {
                char[] cc = System.IO.Path.GetInvalidFileNameChars();
                foreach (char c in cc)
                {
                    if (f.String.IndexOf(c) != -1)
                    {
                        System.Windows.Forms.MessageBox.Show(f.String + " is no valid file name");
                        return "";
                    }
                }

                if (f.String.Length > 0
                && f.String.IndexOf("/") == -1
                && f.String.IndexOf("\\") == -1
                && f.String.IndexOf(",") == -1
                && f.String.IndexOf(";") == -1
                && f.String.IndexOf(".") == -1
                && f.String.IndexOf(":") == -1
                && f.String.IndexOf(" ") == -1
                && f.String.IndexOf("*") == -1
                && f.String.IndexOf("\"") == -1
                && f.String.IndexOf("|") == -1
                && f.String.IndexOf("[") == -1
                && f.String.IndexOf("]") == -1
                && f.String.IndexOf("=") == -1
                && f.String.IndexOf("<") == -1
                && f.String.IndexOf(">") == -1
                && f.String.IndexOf("?") == -1
                )
                    return f.String;
                else
                {
                    System.Windows.Forms.MessageBox.Show(f.String + " is no valid file name");
                    return "";
                }
            }
            else return "";
        }

        private void SynColTaxTextExportGetFile(System.IO.FileInfo FI)
        {
            System.Windows.Forms.MessageBox.Show("Data saved in " + FI.FullName);
            this.openFileDialog.InitialDirectory = FI.DirectoryName;
            this.openFileDialog.FileName = FI.Name;
            this.openFileDialog.Filter = "txt files (*.txt)|*.txt";
            if (this.openFileDialog.ShowDialog() == System.Windows.Forms.DialogResult.OK)
            {
                // System.Diagnostics.Process.Start(FI.FullName);
                System.Diagnostics.Process.Start(new ProcessStartInfo
                {
                    FileName = FI.FullName,
                    UseShellExecute = true
                });
            }
        }

        #endregion

        #region Selecting of valid name if many are found

        private void dataGridViewSynColTaxText_CellClick(object sender, DataGridViewCellEventArgs e)
        {
            int i = this.dataGridViewSynColTaxText.SelectedCells[0].RowIndex;
            string Name = this._dtSynColTaxText.Rows[i][1].ToString();
            if (this._SynColTaxTextNameLists == null)
                this._SynColTaxTextNameLists = new Dictionary<string, DataTable>();
            if (this._SynColTaxTextNameLists.ContainsKey(Name))
            {
                this.buttonSynColTaxTextCheckNameList.Visible = true;
            }
            else this.buttonSynColTaxTextCheckNameList.Visible = false;

            if (this.dataGridViewSynColTaxText.SelectedCells[0].ColumnIndex == 0)
                this.buttonSynColTaxTextUpdate.Enabled = true;
        }

        private void buttonSynColTaxTextCheckNameList_Click(object sender, EventArgs e)
        {
            int i = this.dataGridViewSynColTaxText.SelectedCells[0].RowIndex;
            string Name = this._dtSynColTaxText.Rows[i][1].ToString();
            if (this._SynColTaxTextNameLists.ContainsKey(Name))
            {
                string Message = "Please select the valid name from the list:\r\n" + Name;
                DiversityWorkbench.Forms.FormSelectTableRow f = new DiversityWorkbench.Forms.FormSelectTableRow(this._SynColTaxTextNameLists[Name], Message);//, 2, "1", System.Drawing.Color.LightGreen, System.Drawing.Color.LightPink);
                f.dataGridView.Columns[0].Visible = false;
                f.dataGridView.Columns[1].HeaderText = "Name in " + this.comboBoxSynColTaxTextDatabase.Text;
                if (f.dataGridView.ColumnCount > 2)
                    f.dataGridView.Columns[2].Width = 70;
                f.dataGridView.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                f.Width = 570;
                f.dataGridView.Columns[1].Width = f.Width - 140;
                int Height = (f.dataGridView.Rows[0].Height * (this._SynColTaxTextNameLists[Name].Rows.Count + 1)) + 140;
                if (Height > this.Height)
                    Height = this.Height;
                f.Height = Height;
                f.ForeColor = System.Drawing.Color.DarkBlue;
                f.StartPosition = FormStartPosition.CenterParent;
                f.ShowDialog();
                //f.MarkResults(2, "1", System.Drawing.Color.LightGreen, System.Drawing.Color.LightPink);
                if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                {
                    System.Data.DataRow Rs = f.SelectedRow;
                    System.Data.DataRow Rd = this._dtSynColTaxText.Rows[i];
                    if (Rd[2].ToString() != Rs[1].ToString())
                    {
                        Rd[2] = Rs[1];
                        string URI = Rd[3].ToString().Substring(0, Rd[3].ToString().IndexOf("=") + 1) + Rs[0].ToString();
                        bool AdaptHierarchy = true;
                        if (Rd[3].ToString() == URI
                            || !this.checkBoxSynColTaxTextIncludeHierarchy.Checked)
                            AdaptHierarchy = false;
                        Rd[3] = URI;
                    }
                    Rd[0] = true;
                }
            }
        }

        #endregion

        #region Update

        private void buttonSynColTaxTextUpdate_Click(object sender, EventArgs e)
        {
            int ProjectID = 0;
            string TaxGroup = "";
            if (!this.allValuesSetForTaxonTextSynchro(ref ProjectID, ref TaxGroup))
                return;

            string BaseURL = "";

            if (this.checkBoxSynColTaxTextViaCacheDB.Checked)
            {
                string Message = this.SynchronizeColTaxText_UpdateFromTableContent(TaxGroup, ProjectID);
                if (Message.Length == 0)
                    this.buttonSynColTaxTextUpdate.Enabled = false;
                this.labelSynColTaxCheckText.Text = "";
            }
            else
            {
                if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DataBaseURIs().TryGetValue(this.comboBoxSynColTaxTextDatabase.Text, out BaseURL))
                {
                    bool IsSameServer = true;
                    string SelectedDatabase = this.comboBoxSynColTaxTextDatabase.SelectedItem.ToString();
                    string ConnectionString = DiversityWorkbench.Settings.ConnectionString;
                    foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnections())
                    {
                        if (KV.Value.DisplayText == SelectedDatabase)
                        {
                            ConnectionString = KV.Value.ConnectionString;
                            SelectedDatabase = KV.Value.DatabaseName;
                            if (KV.Value.DatabaseServer != DiversityWorkbench.Settings.DatabaseServer)
                                IsSameServer = false;
                        }
                    }
                    if (IsSameServer && this.radioButtonSynColTaxTextCompareAll.Checked)
                    {
                        if (this.checkBoxSynColTaxTextCompareAllExcludeAuthors.Checked)
                        {
                            string Message = this.SynchronizeColTaxText_UpdateFromTableContent(TaxGroup, ProjectID);
                            if (Message.Length == 0)
                                this.buttonSynColTaxTextUpdate.Enabled = false;
                            this.labelSynColTaxCheckText.Text = "";
                        }
                        else
                        {
                            this.SynchronizeColTaxText_UpdateWithWorkbenchModuleOnSameServer(TaxGroup, ProjectID);
                            this.buttonSynColTaxTextUpdate.Enabled = false;
                            this.labelSynColTaxCheckText.Text = "";
                        }
                    }
                    else
                    {
                        string Message = this.SynchronizeColTaxText_UpdateFromTableContent(TaxGroup, ProjectID);
                        if (Message.Length == 0)
                            this.buttonSynColTaxTextUpdate.Enabled = false;
                        this.labelSynColTaxCheckText.Text = "";
                    }
                }
                else
                {
                    string Message = this.SynchronizeColTaxText_UpdateFromTableContent(TaxGroup, ProjectID);
                    if (Message.Length == 0)
                        this.buttonSynColTaxTextUpdate.Enabled = false;
                    this.labelSynColTaxCheckText.Text = "";
                }
            }
            this.SynchronizeColTaxTextSetGridColors();
        }

        private bool allValuesSetForTaxonTextSynchro(ref int ProjectID, ref string TaxonomicGroup)
        {
            if (this.comboBoxSynColTaxTextTaxonomicGroup.Text.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a taxonomic group");
                return false;
            }
            else
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColTaxTextTaxonomicGroup.SelectedItem;
                TaxonomicGroup = R[0].ToString();
            }

            if (this.comboBoxSynColTaxTextProject.SelectedIndex == -1)
            {
                System.Windows.Forms.MessageBox.Show("Please select a project");
                return false;
            }
            else
            {
                if (this.comboBoxSynColTaxTextProject.SelectedIndex > -1)
                {
                    if (!int.TryParse(this.comboBoxSynColTaxTextProject.SelectedValue.ToString(), out ProjectID))
                    {
                        System.Windows.Forms.MessageBox.Show("Please select a project");
                        return false;
                    }
                }
            }

            if (!this.checkBoxSynColTaxTextViaCacheDB.Checked)
            {
                if (this.comboBoxSynColTaxTextDatabase.SelectedIndex == -1)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a database");
                    return false;
                }
                else
                {
                    string SelectedDatabase = this.comboBoxSynColTaxTextDatabase.SelectedItem.ToString();
                    System.Collections.Generic.List<DiversityWorkbench.DatabaseService> L = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DatabaseServices();
                    foreach (DiversityWorkbench.DatabaseService DS in L)
                    {
                        if (DS.DatabaseName == SelectedDatabase && !DS.IsWebservice)
                        {
                            if (this.comboBoxSynColTaxTextTaxonNameProject.SelectedIndex == -1)
                            {
                                System.Windows.Forms.MessageBox.Show("Please select a names project");
                                return false;
                            }
                            break;
                        }
                    }
                }
            }
            return true;
        }

        #endregion

        #region Connection parameters

        public string SynchronizeColTaxTextLinkedServer
        {
            get
            {
                if (this._SynchronizeColTaxTextLinkedServer == null)
                    this.setSynchronizeColTaxTextDatabaseParameters();
                return _SynchronizeColTaxTextLinkedServer;
            }
        }

        public string SynchronizeColTaxTextTaxonDatabase
        {
            get
            {
                if (this._SynchronizeColTaxTextTaxonDatabase == null)
                    this.setSynchronizeColTaxTextDatabaseParameters();
                return _SynchronizeColTaxTextTaxonDatabase;
            }
        }

        public string SynchronizeColTaxTextConnectionString
        {
            get
            {
                if (this._SynchronizeColTaxTextConnectionString == null)
                    this.setSynchronizeColTaxTextDatabaseParameters();
                return _SynchronizeColTaxTextConnectionString;
            }
        }

        public bool? SynchronizeColTaxTextSameServer
        {
            get
            {
                if (this._SynchronizeColTaxTextSameServer == null)
                    this.setSynchronizeColTaxTextDatabaseParameters();
                return _SynchronizeColTaxTextSameServer;
            }
        }

        public string SynchronizeColTaxTextBaseURL
        {
            get
            {
                if (this._SynchronizeColTaxTextBaseURL == null)
                    this.setSynchronizeColTaxTextDatabaseParameters();
                return _SynchronizeColTaxTextBaseURL;
            }
        }

        public string SynchronizeColTaxTextPrefix
        {
            get
            {
                string Prefix = this.SynchronizeColTaxTextTaxonDatabase + ".dbo.";
                if (this.SynchronizeColTaxTextLinkedServer.Length > 0)
                    Prefix = "[" + this.SynchronizeColTaxTextLinkedServer + "]." + Prefix;
                return Prefix;
            }
        }

        #endregion

        #region Handling the data


        private void SynchronizeColTaxTextWithWorkbenchModuleOnSameServer()
        {
            //string SelectedDatabase = this.SynchronizeColTaxTextTaxonDatabase;
            //string BaseURL = this.SynchronizeColTaxTextBaseURL;
            string Prefix = "dbo.";
            //DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnectionList()[this.comboBoxSynColTaxDatabase.Text];
            if (this.checkBoxSynColTaxTextViaCacheDB.Checked)
            {
                Prefix = "[" + DiversityCollection.CacheDatabase.CacheDB.CacheDatabaseName() + "].[dbo].";
            }
            else
            {
                if (this.SynchronizeColTaxTextLinkedServer.Length > 0)
                    Prefix = "[" + this.SynchronizeColTaxTextLinkedServer + "].[" + this.SynchronizeColTaxTextTaxonDatabase + "].dbo.";
                else Prefix = "[" + this.SynchronizeColTaxTextTaxonDatabase + "].dbo.";
            }

            string SQL = "SELECT ";
            if (!this.checkBoxSynColTaxTextIncludeAccNr.Checked)
                SQL += " DISTINCT ";
            if (this.checkBoxSynColTaxTextMax.Checked)
                SQL += " TOP " + this.numericUpDownSynColTaxTextMax.Value.ToString() + " ";
            SQL += " CAST(1 as bit) AS OK, I.TaxonomicName AS [TaxonomicName in DiversityCollection], ";
            if (this.checkBoxSynColTaxTextViaCacheDB.Checked)
                SQL += "T.TaxonName AS [Name in CacheDB], T.NameURI ";
            else
                SQL += "T.TaxonNameCache AS [Name in DiversityTaxonNames], B.BaseURL + CAST(T.NameID AS VARCHAR(55)) AS NameURI ";
            if (this.checkBoxSynColTaxTextIncludeAccNr.Checked)
                SQL += ", case when C.AccessionNumber is null then '[' + cast(C.CollectionSpecimenID as varchar) + ']' else  C.AccessionNumber end AS AccessionNumber, C.CollectionSpecimenID ";
            SQL += "FROM ";
            if (this.checkBoxSynColTaxTextViaCacheDB.Checked)
                SQL += "";
            else
                SQL += Prefix + "ViewBaseURL B, ";
            if (this.checkBoxSynColTaxTextIncludeAccNr.Checked)
                SQL += " CollectionSpecimen C, ";
            if (this.checkBoxSynColTaxTextViaCacheDB.Checked)
                SQL += Prefix + "TaxonSynonymy";
            else
                SQL += Prefix + "TaxonNameProject AS TP INNER JOIN " +
                Prefix + "TaxonName";
            SQL += " AS T INNER JOIN " +
                "Identification AS I INNER JOIN " +
                "IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID " +
                "AND I.IdentificationUnitID = U.IdentificationUnitID ON T.";
            if (this.checkBoxSynColTaxTextViaCacheDB.Checked)
                SQL += "TaxonName";
            else
                SQL += "TaxonNameCache";
            SQL += " = I.TaxonomicName INNER JOIN " +
                "CollectionProject AS P ON I.CollectionSpecimenID = P.CollectionSpecimenID ";
            if (this.checkBoxSynColTaxTextViaCacheDB.Checked)
                SQL += "";
            else
                SQL += " ON TP.NameID = T.NameID AND TP.ProjectID = " + this.comboBoxSynColTaxTextTaxonNameProject.SelectedValue.ToString() + " ";
            SQL += " WHERE (I.NameURI IS NULL OR I.NameURI = '') AND (NOT (I.TaxonomicName IS NULL)) AND (LEN(I.TaxonomicName) > 0) " +
                " AND U.TaxonomicGroup = N'" + this.comboBoxSynColTaxTextTaxonomicGroup.Text + "' " +
                " AND P.ProjectID = " + this.comboBoxSynColTaxTextProject.SelectedValue.ToString() + " ";
            if (this.checkBoxSynColTaxTextIncludeAccNr.Checked)
                SQL += " AND C.CollectionSpecimenID = U.CollectionSpecimenID ";
            if (this.textBoxSynColTaxTextStartString.Text.Length > 0)
                SQL += " AND I.TaxonomicName LIKE '" + this.textBoxSynColTaxTextStartString.Text + "%' ";
            if (this.checkBoxSynColTaxTextComparePartsRestrictToLastIdent.Checked)
                SQL += "and exists (select * from Identification L " +
                    "where L.IdentificationUnitID = I.IdentificationUnitID " +
                    "and L.CollectionSpecimenID = I.CollectionSpecimenID  " +
                    "group by L.IdentificationUnitID  " +
                    "having max(L.IdentificationSequence) = I.IdentificationSequence)";
            if (this.checkBoxSynColTaxTextViaCacheDB.Checked)
                SQL += " ORDER BY [Name in CacheDB]";
            else
                SQL += " ORDER BY [Name in DiversityTaxonNames]";

            if (this._dtSynColTaxText == null)
                this._dtSynColTaxText = new DataTable();
            else
                this._dtSynColTaxText.Clear();
            Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
            ad.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
            try
            {
                ad.Fill(this._dtSynColTaxText);
                this.dataGridViewSynColTaxText.DataSource = this._dtSynColTaxText;
                if (this._dtSynColTaxText.Rows.Count > 0)
                {
                    this.labelSynColTaxCheckText.Text = this._dtSynColTaxText.Rows.Count.ToString() + " matches found";
                    this.buttonSynColTaxTextUpdate.Enabled = true;
                }
                else
                {
                    this.labelSynColTaxCheckText.Text = "No matches found";
                    this.buttonSynColTaxTextUpdate.Enabled = false;
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void SynchronizeColTaxTextWithWorkbenchModuleOnDifferentServer(string SelectedDatabase, string ConnectionString, string BaseURL)
        {
            string Message = "";
            System.Collections.Generic.List<System.Data.DataRow> RowsToDelete = new List<DataRow>();
            System.Data.DataTable dtQueryResults = new DataTable();

            this.SynchronizeColTaxTextFillList();

            this.progressBarSynColTaxText.Maximum = this._dtSynColTaxText.Rows.Count;
            this.progressBarSynColTaxText.Minimum = 0;
            this.progressBarSynColTaxText.Value = 0;
            this.progressBarSynColTaxText.Visible = true;
            int i = 0;

            this._SynColTaxTextNameLists = new Dictionary<string, DataTable>();

            string Prefix = SelectedDatabase + ".dbo.";
            if (this.SynchronizeColTaxTextLinkedServer.Length > 0)
                Prefix = "[" + this.SynchronizeColTaxTextLinkedServer + "]." + Prefix;

            Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter("", ConnectionString);
            Microsoft.Data.SqlClient.SqlConnection conRank = new Microsoft.Data.SqlClient.SqlConnection(ConnectionString);
            Microsoft.Data.SqlClient.SqlCommand cmdRank = new Microsoft.Data.SqlClient.SqlCommand("", conRank);
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            foreach (System.Data.DataRow R in this._dtSynColTaxText.Rows)
            {
                try
                {
                    dtQueryResults.Clear();
                    string TaxonInCollection = R[1].ToString();

                    /*                
                    SELECT dbo.BaseURL() + CAST(T.NameID AS VARCHAR(55)) AS NameURI, T.TaxonNameCache, 
                    CASE WHEN MIN(A.IgnoreButKeepForReference) IS NULL OR MIN(A.IgnoreButKeepForReference) > 0 THEN 0 ELSE 1 END AS IsAccepted
                    FROM DiversityTaxonNames_Myxomycetes.dbo.TaxonNameProject AS TP INNER JOIN
                    DiversityTaxonNames_Myxomycetes.dbo.TaxonName AS T ON TP.NameID = T.NameID LEFT OUTER JOIN
                    DiversityTaxonNames_Myxomycetes.dbo.TaxonAcceptedName AS A ON TP.ProjectID = A.ProjectID AND TP.NameID = A.NameID
                    WHERE (T.IgnoreButKeepForReference = 0) AND (TP.ProjectID = 505)
                    GROUP BY dbo.BaseURL() + CAST(T.NameID AS VARCHAR(55)), T.TaxonNameCache
                    HAVING (T.TaxonNameCache LIKE N'ARCcin%')
                     * */

                    string SQL = "SELECT U.BaseURL + CAST(T.NameID AS VARCHAR(55)) AS NameURI, T.TaxonNameCache, " +
                        "CASE WHEN MIN(A.IgnoreButKeepForReference) IS NULL OR MIN(A.IgnoreButKeepForReference) > 0 THEN NULL ELSE 'Accepted' END AS Accepted ";
                    SQL += "FROM " + Prefix + "ViewBaseURL AS U, ";
                    SQL += Prefix + "TaxonNameProject AS TP INNER JOIN " +
                        Prefix + "TaxonName AS T ON TP.NameID = T.NameID LEFT OUTER JOIN " +
                        Prefix + "TaxonAcceptedName AS A  ON TP.ProjectID = A.ProjectID AND TP.NameID = A.NameID " +
                        " WHERE T.NameID = TP.NameID " +
                        " AND T.IgnoreButKeepForReference = 0 " +
                        " AND TP.ProjectID = " + this.comboBoxSynColTaxTextTaxonNameProject.SelectedValue.ToString();
                    if (this.radioButtonSynColTaxTextCompareAll.Checked)
                    {
                        if (this.checkBoxSynColTaxTextCompareAllExcludeAuthors.Checked)
                        {
                            string Intraspec = "";
                            string[] SearchString = TaxonInCollection.Split(new char[] { ' ' });
                            string SearchFor = "";

                            // Check for hybrids
                            bool IsHybrid = false;
                            for (int iS = 0; iS < SearchString.Length; iS++)
                            {
                                if (SearchString[iS] == "x")
                                {
                                    IsHybrid = true;
                                    break;
                                }
                            }

                            // get the rank
                            string Rank = "sp.";
                            if (this.comboBoxSynColTaxTextRank.SelectedIndex > -1 &&
                                this.comboBoxSynColTaxTextRank.SelectedText != null &&
                                this.comboBoxSynColTaxTextRank.SelectedText.Length > 0)
                                Rank = this.comboBoxSynColTaxTextRank.SelectedValue.ToString();
                            else
                            {
                                for (int iS = 0; iS < SearchString.Length; iS++)
                                {
                                    if (this.TaxonomicRanks(ConnectionString, Prefix).Contains(SearchString[iS]))
                                    {
                                        Rank = SearchString[iS];
                                        break;
                                    }
                                    if (iS > 1 && SearchString[iS].EndsWith("'") && SearchString[iS].StartsWith("'"))
                                    {
                                        Rank = "cult.";
                                        break;
                                    }
                                }

                                for (int iS = 0; iS < SearchString.Length; iS++)
                                {
                                    if (SearchFor.Length > 0 && !SearchFor.EndsWith(" "))
                                        SearchFor += " ";
                                    if (SearchString[iS] == "x")
                                        IsHybrid = true;
                                    if (iS <= 1)
                                    {
                                        SearchFor += SearchString[iS];
                                    }
                                    else if (iS > 1 && ((SearchString[iS][0].ToString() == SearchString[iS][0].ToString().ToUpper() && char.IsLetter(SearchString[iS][0])) || SearchString[iS][0].ToString() == "("))
                                    {
                                        // Stop after a upper letter or a ( is detected indicating the start of the authors
                                        SearchFor += "%";
                                        break;
                                    }
                                    else if (iS == 2)
                                    {
                                        if (Rank == "sp.")
                                        {
                                            SearchFor += SearchString[iS];
                                        }

                                    }
                                    else if (iS == 3 && Rank != "sp.")
                                    {
                                        Intraspec = SearchString[iS];
                                    }
                                    else
                                    {
                                        if (IsHybrid && iS == 3)
                                        {
                                            SearchFor += SearchString[iS];
                                        }
                                        else
                                        {

                                        }
                                    }
                                }
                            }
                            if (!SearchFor.EndsWith("%"))
                            {
                                if (!SearchFor.EndsWith(" "))
                                {
                                    SearchFor += " ";
                                }
                                SearchFor += "%";
                            }
                            SearchFor = SearchFor.Replace("'", "''");
                            SQL += " AND (T.TaxonNameCache LIKE '" + SearchFor + "' OR T.TaxonNameCache = '" + SearchFor.Substring(0, SearchFor.Length - 2) + "')";
                            if (IsHybrid) SQL += " AND T.IsHybrid = 1 ";
                            else SQL += " AND T.IsHybrid = 0 ";
                            if (Rank == "sp.")
                                SQL += " AND (T.TaxonomicRank IN ('" + Rank + "', 'agg.', 'aggr.'))"; /// auf Wunsch von Marcel
                            else if (SearchString.Length == 2 || Rank.Length > 0)
                                SQL += " AND (T.TaxonomicRank = '" + Rank + "')";
                            if (Intraspec.Length > 0)
                                SQL += " AND T.InfraspecificEpithet = '" + Intraspec + "' ";
                        }
                        else
                            SQL += " AND (T.TaxonNameCache = '" + TaxonInCollection + "')";
                    }
                    else if (this.radioButtonSynColTaxTextCompareParts.Checked)
                    {
                        string[] tt = TaxonInCollection.Split(new char[] { ' ' });
                        string T = "";
                        for (int ti = 0; ti < tt.Length; ti++)
                        {
                            if (ti >= this.numericUpDownSynColTaxTextCompareParts.Value)
                                break;
                            if (T.Length > 0)
                                T += " ";
                            T += tt[ti];
                        }
                        SQL += " AND T.TaxonNameCache LIKE '" + T + "%'";
                    }
                    if (this.comboBoxSynColTaxTextRank.Text.Length > 0)
                    {
                        System.Data.DataRowView RRank = (System.Data.DataRowView)this.comboBoxSynColTaxTextRank.SelectedItem;
                        SQL += " AND T.TaxonomicRank = '" + RRank["Code"].ToString() + "'";
                    }
                    SQL += " GROUP BY dbo.BaseURL() + CAST(T.NameID AS VARCHAR(55)), T.TaxonNameCache, U.BaseURL, T.NameID " +
                        " ORDER BY T.TaxonNameCache";
                    try
                    {
                        ad.SelectCommand.CommandText = SQL;
                        ad.Fill(dtQueryResults);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }

                    if (dtQueryResults.Rows.Count > 0)
                    {
                        if (dtQueryResults.Rows.Count > 1)
                        {
                            if (!this._SynColTaxTextNameLists.ContainsKey(TaxonInCollection))
                                this._SynColTaxTextNameLists.Add(TaxonInCollection, dtQueryResults.Copy());
                            if (R.Table.Columns.Contains("Similarities"))
                                R["Similarities"] = dtQueryResults.Rows.Count;
                        }
                        R[2] = dtQueryResults.Rows[0]["TaxonNameCache"].ToString();
                        R[3] = dtQueryResults.Rows[0]["NameURI"].ToString();
                        if (R[1].ToString() == R[2].ToString())
                            R[0] = true;
                        else if (dtQueryResults.Rows.Count == 1 && this.checkBoxSynColTaxTextCompareAllExcludeAuthors.Checked)
                            R[0] = true;
                        else
                        {
                            R[0] = false;
                            //this.dataGridViewSynColTaxText.Rows[i].DefaultCellStyle.BackColor = C;
                        }
                    }
                    else
                    {
                        if (this.checkBoxSynColTaxTextFuzzySearch.Checked)
                        {
                            string TaxonSearchBase = R[1].ToString();
                            dtQueryResults = this.SynchronizeColTaxTextFuzzySearch(TaxonSearchBase, Prefix, ConnectionString);
                            if (dtQueryResults.Rows.Count > 1)
                            {
                                if (!this._SynColTaxTextNameLists.ContainsKey(TaxonInCollection))
                                    this._SynColTaxTextNameLists.Add(TaxonInCollection, dtQueryResults.Copy());
                                if (R.Table.Columns.Contains("Similarities"))
                                    R["Similarities"] = dtQueryResults.Rows.Count;
                            }
                            R[2] = dtQueryResults.Rows[0]["TaxonNameCache"].ToString();
                            R[3] = dtQueryResults.Rows[0]["NameURI"].ToString();
                            if (R[1].ToString() == R[2].ToString())
                                R[0] = true;
                            else if (dtQueryResults.Rows.Count == 1 && this.checkBoxSynColTaxTextCompareAllExcludeAuthors.Checked)
                                R[0] = false;
                            else if (dtQueryResults.Rows.Count > 0)
                            {
                                R[0] = false;
                            }
                            else
                                RowsToDelete.Add(R);
                        }
                        else
                            RowsToDelete.Add(R);
                    }

                    i++;
                    if (i < this.progressBarSynColTaxText.Maximum)
                        this.progressBarSynColTaxText.Value = i;
                }
                catch (System.Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex, R[1].ToString());
                    RowsToDelete.Add(R);
                }
            }

            // deleting the not synchronizable
            foreach (System.Data.DataRow R in RowsToDelete)
                R.Delete();
            this._dtSynColTaxText.AcceptChanges();

            if (this._dtSynColTaxText.Rows.Count > 0)
            {
                //string Database = this.comboBoxSynColTaxTextDatabase.SelectedItem.ToString();
                this.labelSynColTaxCheckText.Text = this._dtSynColTaxText.Rows.Count.ToString() + " matches to " + this.comboBoxSynColTaxTextDatabase.Text + " found";
                this.buttonSynColTaxTextUpdate.Enabled = true;
                try
                {
                    foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColTaxText.Rows)
                    {
                        System.Drawing.Color C = System.Drawing.Color.White;
                        if (R.Cells[0].Value.ToString().ToLower() == "false")
                        {
                            C = System.Drawing.Color.LightYellow;
                            int Sim;
                            string Value = R.Cells[4].Value.ToString();
                            if (this.checkBoxSynColTaxTextIncludeAccNr.Checked)
                            {
                                Value = R.Cells[6].Value.ToString();
                            }
                            if (int.TryParse(Value, out Sim) && Sim > 1)
                            {
                                C = System.Drawing.Color.LightBlue;
                            }
                            else
                            {
                                string[] TaxonCollection = R.Cells[1].Value.ToString().Split(new char[] { ' ' });
                                string[] TaxonFromDTN = R.Cells[2].Value.ToString().Split(new char[] { ' ' });
                                int iTT = TaxonCollection.Length;
                                if (iTT > TaxonFromDTN.Length)
                                    iTT = TaxonFromDTN.Length;
                                for (int itt = 0; itt < iTT; itt++)
                                {
                                    if (TaxonCollection[itt] == TaxonCollection[itt].ToLower()
                                        && TaxonCollection[itt] != TaxonFromDTN[itt])
                                    {
                                        string TC = TaxonCollection[itt].Replace(")", "").Replace("(", "");
                                        string TN = TaxonFromDTN[itt].Replace(")", "").Replace("(", "");
                                        int iTC;
                                        int iTN;
                                        if (!int.TryParse(TC, out iTC) && !int.TryParse(TN, out iTN))
                                        {
                                            C = System.Drawing.Color.Pink;
                                            break;
                                        }
                                    }
                                    if (itt == 0
                                        && TaxonCollection[itt] != TaxonFromDTN[itt])
                                    {
                                        C = System.Drawing.Color.Pink;
                                        break;
                                    }
                                }
                            }
                        }
                        else if (R.Cells[1].Value.ToString() != R.Cells[2].Value.ToString())
                            C = System.Drawing.Color.LightYellow;
                        for (int iDGV = 0; iDGV < this.dataGridViewSynColTaxText.Columns.Count; iDGV++)
                        {
                            R.Cells[iDGV].Style.BackColor = C;
                        }
                    }
                }
                catch (System.Exception ex) { }

            }
            else
            {
                this.labelSynColTaxCheckText.Text = "No matches found";
                this.buttonSynColTaxTextUpdate.Enabled = false;
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        /// <summary>
        /// Try to find matching names for a taxon
        /// </summary>
        /// <param name="Taxon">The taxonomic name</param>
        /// <param name="Prefix">The SQL prefix esp. for linked servers</param>
        /// <param name="ConnectionString">The connection string to the names database</param>
        /// <returns></returns>
        private System.Data.DataTable SynchronizeColTaxTextFuzzySearch(string Taxon, string Prefix, string ConnectionString)
        {
            System.Data.DataTable dtQueryResults = new DataTable();
            try
            {
                // getting the list of strings for comparision
                System.Collections.Generic.List<string> Taxa = new List<string>();
                for (int i = 0; i < Taxon.Length; i++)
                {
                    if (Taxon[i] == ' ')
                        continue;
                    string TaxonSearch_1 = Taxon.Substring(0, i) + "_" + Taxon.Substring(i + 1);
                    if (!Taxa.Contains(TaxonSearch_1))
                        Taxa.Add(TaxonSearch_1);
                    if (this.numericUpDownSynColTaxTextFuzzySearch.Value > 1)
                    {
                        for (int ii = 0; ii < TaxonSearch_1.Length; ii++)
                        {
                            if (TaxonSearch_1[ii] == ' ')
                                continue;
                            string TaxonSearch_2 = TaxonSearch_1.Substring(0, ii) + "_" + TaxonSearch_1.Substring(ii + 1);
                            if (!Taxa.Contains(TaxonSearch_2))
                                Taxa.Add(TaxonSearch_2);
                            if (this.numericUpDownSynColTaxTextFuzzySearch.Value > 2)
                            {
                                for (int iii = 0; iii < TaxonSearch_2.Length; iii++)
                                {
                                    if (TaxonSearch_2[iii] == ' ')
                                        continue;
                                    string TaxonSearch_3 = TaxonSearch_2.Substring(0, iii) + "_" + TaxonSearch_2.Substring(iii + 1);
                                    if (!Taxa.Contains(TaxonSearch_3))
                                        Taxa.Add(TaxonSearch_3);
                                }
                            }
                        }
                    }
                }

                // dupliate the list with _ instead of % as wildcard
                System.Collections.Generic.List<string> TaxaPercent = new List<string>();
                foreach (string T in Taxa)
                {
                    if (!TaxaPercent.Contains(T.Replace("_", "%")))
                        TaxaPercent.Add(T.Replace("_", "%"));
                }
                foreach (string T in TaxaPercent)
                {
                    if (!Taxa.Contains(T))
                        Taxa.Add(T);
                }

                // try to find matching names in the database
                foreach (string T in Taxa)
                {
                    this.SynchronizeColTaxTextFuzzySearch(ref dtQueryResults, T + "%", Prefix, ConnectionString);
                    if (dtQueryResults.Rows.Count > 0)
                    {
                        // for queries with the wildcard % avoid access differences in length
                        if (T.IndexOf("%") > -1)
                        {
                            System.Collections.Generic.List<System.Data.DataRow> NonFittingRows = new List<DataRow>();
                            foreach (System.Data.DataRow R in dtQueryResults.Rows)
                            {
                                string[] TaxonOri = Taxon.Split(new char[] { ' ' });
                                string[] TaxonQuery = R[1].ToString().Split(new char[] { ' ' });
                                if (TaxonOri.Length > 0 && TaxonQuery.Length > 0)
                                {
                                    // compare first part
                                    int LengthDiff = Math.Sign((TaxonOri[0].Length - TaxonQuery[0].Length)) * (TaxonOri[0].Length - TaxonQuery[0].Length);
                                    if (LengthDiff > this.numericUpDownSynColTaxTextFuzzySearch.Value)
                                    {
                                        NonFittingRows.Add(R);
                                    }
                                    if (TaxonOri.Length > 1 && TaxonQuery.Length > 1)
                                    {
                                        // compare second part
                                        LengthDiff = Math.Sign((TaxonOri[1].Length - TaxonQuery[1].Length)) * (TaxonOri[1].Length - TaxonQuery[1].Length);
                                        if (LengthDiff > this.numericUpDownSynColTaxTextFuzzySearch.Value)
                                        {
                                            NonFittingRows.Add(R);
                                        }
                                    }
                                }
                            }
                            if (NonFittingRows.Count > 0)
                            {
                                foreach (System.Data.DataRow R in NonFittingRows)
                                    R.Delete();
                                dtQueryResults.AcceptChanges();
                            }
                        }
                        if (dtQueryResults.Rows.Count > 0)
                            break;
                    }
                }
            }
            catch (System.Exception ex)
            {
            }
            //}
            return dtQueryResults;
        }

        private void SynchronizeColTaxTextFuzzySearch(ref System.Data.DataTable dtQueryResults, string Taxon, string Prefix, string ConnectionString)
        {
            string SQL = "SELECT U.BaseURL + CAST(T.NameID AS VARCHAR(55)) AS NameURI, T.TaxonNameCache, " +
                "CASE WHEN MIN(A.IgnoreButKeepForReference) IS NULL OR MIN(A.IgnoreButKeepForReference) > 0 THEN NULL ELSE 'Accepted' END AS Accepted ";
            SQL += "FROM " + Prefix + "ViewBaseURL AS U, ";
            SQL += Prefix + "TaxonNameProject AS TP INNER JOIN " +
                Prefix + "TaxonName AS T ON TP.NameID = T.NameID LEFT OUTER JOIN " +
                Prefix + "TaxonAcceptedName AS A  ON TP.ProjectID = A.ProjectID AND TP.NameID = A.NameID " +
                " WHERE T.NameID = TP.NameID " +
                " AND T.IgnoreButKeepForReference = 0 " +
                " AND TP.ProjectID = " + this.comboBoxSynColTaxTextTaxonNameProject.SelectedValue.ToString() +
                " AND T.TaxonNameCache LIKE '" + Taxon + "'";
            SQL += " GROUP BY dbo.BaseURL() + CAST(T.NameID AS VARCHAR(55)), T.TaxonNameCache, U.BaseURL, T.NameID ";
            Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, ConnectionString);

            try
            {
                ad.Fill(dtQueryResults);
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private System.Collections.Generic.List<string> _TaxonomicRanks;
        private System.Collections.Generic.List<string> TaxonomicRanks(string ConnectionString, string Prefix)
        {
            if (this._TaxonomicRanks == null)
            {
                try
                {
                    this._TaxonomicRanks = new List<string>();
                    string SQL = "Select CODE from " + Prefix + "TaxonNameTaxonomicRank_Enum R where r.DisplayOrder < 270";
                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, ConnectionString);
                    System.Data.DataTable dt = new DataTable();
                    ad.Fill(dt);
                    foreach (System.Data.DataRow R in dt.Rows)
                        this._TaxonomicRanks.Add(R[0].ToString());
                }
                catch (Exception ex)
                {
                    //DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    this._TaxonomicRanks = null;
                }
            }
            return this._TaxonomicRanks;
        }

        private async System.Threading.Tasks.Task SynchronizeColTaxTextWithWebService(string BaseURL)
        {
            this.SynchronizeColTaxTextFillList();

            foreach (System.Windows.Forms.DataGridViewColumn C in this.dataGridViewSynColTaxText.Columns)
            {
                C.SortMode = DataGridViewColumnSortMode.NotSortable;
                if (C.DataPropertyName == "NameURI")
                    C.Visible = false;
            }

            System.Collections.Generic.List<System.Data.DataRow> RowsToDelete = new List<DataRow>();
            System.Data.DataTable dtQueryResults = new DataTable();
            this.progressBarSynColTaxText.Maximum = this._dtSynColTaxText.Rows.Count;
            this.progressBarSynColTaxText.Minimum = 0;
            this.progressBarSynColTaxText.Value = 0;
            this.progressBarSynColTaxText.Visible = true;
            int i = 0;
            try
            {
                int indexOfNameLists = 0;
                this._SynColTaxTextNameLists = new Dictionary<string, DataTable>();
                foreach (System.Data.DataRow R in this._dtSynColTaxText.Rows)
                {
                    dtQueryResults.Clear();
                    string TaxonInCollection = R[1].ToString();
                    string TaxonForSearch = TaxonInCollection;
                    if (this.radioButtonSynColTaxTextCompareParts.Checked)
                    {
                        // restricting the name of the taxon to the number of parts that were selected for the search
                        string[] TT = TaxonForSearch.Split(new char[] { ' ' });
                        TaxonForSearch = "";
                        try
                        {
                            for (int iTT = 0; iTT < this.numericUpDownSynColTaxTextCompareParts.Value; iTT++)
                            {
                                if (iTT >= TT.Length) break;
                                if (TaxonForSearch.Length > 0) TaxonForSearch += " ";
                                TaxonForSearch += TT[iTT];
                            }
                        }
                        catch (System.Exception ex) { }
                    }

                    // Getting the results from Index Fungorum - go down to Genus and species because search with authors may not be suported
                    string TaxonForSearchInWebservice = TaxonForSearch;
                    try
                    {
                        while (dtQueryResults.Rows.Count == 0 && TaxonForSearchInWebservice.IndexOf(" ") > -1)
                        {

                            DwbServiceEnums.DwbService currentDwbService =
                                getCurrentService(this.comboBoxSynColTaxDatabase.Text);
                            IDwbWebservice<DwbSearchResult, DwbSearchResultItem, DwbEntity> _api =
                                DwbServiceProviderAccessor.GetDwbWebservice(currentDwbService);
                            if (_api == null)
                                break;
                            if (!Uri.TryCreate(TaxonForSearchInWebservice, UriKind.RelativeOrAbsolute, out Uri URI))
                            {
                                MessageBox.Show("An error occurred when trying to connect with the webservice. ");
                                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile("Invalid URI Error inFormMaintenances.SynchronizeColTaxTextWithWebService method. URI: " + TaxonForSearchInWebservice);
                                return;
                            }

                            string Restriction = TaxonForSearchInWebservice;
                            string urlString = _api.DwbApiQueryUrlString(currentDwbService, Restriction, 0, 5) ?? string.Empty;
                            DwbSearchResult clientdwbSearch = await getApiSearchModel(_api, urlString);
                            ReadDwbSearchModelInQueryTable(clientdwbSearch, ref dtQueryResults);
                            TaxonForSearchInWebservice = TaxonForSearchInWebservice.Substring(0, TaxonForSearchInWebservice.LastIndexOf(" ")).Trim();
                        }
                    }
                    catch (System.Exception ex)
                    {
                        MessageBox.Show("An error occurred when trying to connect with the webservice: " + ex.Message);
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }

                    // Checking the results and removing those names that do not match
                    if (this.radioButtonSynColTaxTextCompareParts.Checked && dtQueryResults.Rows.Count > 0)
                    {
                        System.Collections.Generic.List<System.Data.DataRow> RowsInWebserviceNotMatching = new List<DataRow>();
                        try
                        {
                            foreach (System.Data.DataRow rIF in dtQueryResults.Rows)
                            {
                                string[] TT = TaxonForSearch.Split(new char[] { ' ' });
                                string[] IF = rIF[1].ToString().Split(new char[] { ' ' });
                                for (int ii = 0; ii < this.numericUpDownSynColTaxTextCompareParts.Value; ii++)
                                {
                                    if (TT.Length <= ii || IF.Length <= ii)
                                    {
                                        break;
                                    }
                                    if (TT[ii] != IF[ii])
                                    {
                                        RowsInWebserviceNotMatching.Add(rIF);
                                        break;
                                    }
                                }
                            }
                            if (RowsInWebserviceNotMatching.Count > 0)
                            {
                                foreach (System.Data.DataRow Rnm in RowsInWebserviceNotMatching)
                                    Rnm.Delete();
                                dtQueryResults.AcceptChanges();
                            }
                        }
                        catch (System.Exception ex) { }
                    }

                    string NameInWebservice = "";
                    if (dtQueryResults.Rows.Count == 1)
                    {
                        NameInWebservice = dtQueryResults.Rows[0][1].ToString().Trim();
                        if (NameInWebservice != TaxonInCollection && !this.radioButtonSynColTaxTextCompareParts.Checked)
                            RowsToDelete.Add(R);
                        else
                        {
                            indexOfNameLists++;
                            R[2] = NameInWebservice.Trim();
                            R[3] = BaseURL + dtQueryResults.Rows[0][0].ToString().Trim();
                            if (R.Table.Columns.Contains("Similarities"))
                                R["Similarities"] = dtQueryResults.Rows.Count;
                        }
                    }
                    else
                    {
                        if (dtQueryResults.Rows.Count > 1)
                        {
                            if (this.radioButtonSynColTaxTextCompareParts.Checked)
                            {
                                if (!this._SynColTaxTextNameLists.ContainsKey(TaxonInCollection))
                                    this._SynColTaxTextNameLists.Add(TaxonInCollection, dtQueryResults.Copy());
                                indexOfNameLists++;
                                R[0] = false;
                                R[2] = dtQueryResults.Rows[0][1].ToString().Trim();
                                R[3] = BaseURL + dtQueryResults.Rows[0][0].ToString().Trim();
                                if (R.Table.Columns.Contains("Similarities"))
                                    R["Similarities"] = dtQueryResults.Rows.Count;
                            }
                            else
                            {
                                bool NameMatchFound = false;
                                foreach (System.Data.DataRow r in dtQueryResults.Rows)
                                {
                                    if (r[1].ToString() == R[1].ToString())
                                    {
                                        R[2] = r[1].ToString().Trim();
                                        R[3] = BaseURL + r[0].ToString().Trim();
                                        NameMatchFound = true;
                                        indexOfNameLists++;
                                        break;
                                    }
                                }
                                if (!NameMatchFound)
                                    RowsToDelete.Add(R);
                            }
                        }
                        else
                            RowsToDelete.Add(R);
                    }
                    // Todo Ariane when does this happen? do we needto mplement webservicestuff here?
                    if (!RowsToDelete.Contains(R) && !R[3].Equals(System.DBNull.Value) & R[3].ToString().Length > 0 && this.checkBoxSynColTaxTextIncludeHierarchy.Checked)
                    {
                        try
                        {
                            string URI = R[3].ToString();
                            System.Data.DataTable dtItem = new DataTable();
                            System.Data.DataColumn Curi = new DataColumn("_URI");
                            dtItem.Columns.Add(Curi);
                            System.Data.DataRow Ruri = dtItem.NewRow();
                            Ruri[0] = R[3];
                            dtItem.Rows.Add(Ruri);
                            switch (this.comboBoxSynColTaxTextDatabase.Text)
                            {
                                //case "IndexFungorum":
                                //    F.getItemResults(URI, ref dtItem);
                                //    break;
                                //case "CatalogueOfLife":
                                //    //case "CatalogueOfLife_2":
                                //    C.getItemResults(URI, ref dtItem);
                                //    break;
                                //case "PalaeoDB":
                                //    P.getItemResults(URI, ref dtItem);
                                //    break;
                                //case "MycoBank":
                                //    MB.getItemResults(URI, ref dtItem);
                                //    break;
                            }
                            if (dtItem.Columns.Contains("Family"))
                            {
                                R["Family"] = dtItem.Rows[0]["Family"];
                            }
                            if (dtItem.Columns.Contains("Order"))
                            {
                                R["Order"] = dtItem.Rows[0]["Order"];
                            }
                            if (dtItem.Columns.Contains("Hierarchy"))
                            {
                                R["Hierarchy"] = dtItem.Rows[0]["Hierarchy"];
                            }
                        }
                        catch (System.Exception ex) { }
                    }
                    i++;
                    this.progressBarSynColTaxText.Value = i;
                }
            }
            catch (System.Exception ex) { }
            foreach (System.Data.DataRow R in RowsToDelete)
                R.Delete();
            this._dtSynColTaxText.AcceptChanges();
            if (this._dtSynColTaxText.Rows.Count > 0)
            {
                //string Database = this.comboBoxSynColTaxTextDatabase.SelectedItem.ToString();
                this.labelSynColTaxCheckText.Text = this._dtSynColTaxText.Rows.Count.ToString() + " matches to " + this.comboBoxSynColTaxTextDatabase.Text + " found";
                this.buttonSynColTaxTextUpdate.Enabled = true;
            }
            else
            {
                this.labelSynColTaxCheckText.Text = "No matches found";
                this.buttonSynColTaxTextUpdate.Enabled = false;
            }
            this.SynchronizeColTaxTextSetGridColors();
            return;
        }

        private void SynchronizeColTaxTextSetGridColors()
        {
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColTaxText.Rows)
            {
                if (R.Cells[1].Value.ToString() != R.Cells[2].Value.ToString())
                {
                    int Sim;
                    System.Drawing.Color Col = System.Drawing.Color.LightYellow;
                    System.Drawing.Color FCol = System.Drawing.Color.Black;
                    if (int.TryParse(R.Cells[4].Value.ToString(), out Sim) && Sim > 1)
                    {
                        FCol = System.Drawing.Color.DarkBlue;
                        Col = System.Drawing.Color.LightBlue;
                    }
                    for (int iDGV = 0; iDGV < this.dataGridViewSynColTaxText.Columns.Count; iDGV++)
                    {
                        R.Cells[iDGV].Style.BackColor = Col;
                        R.Cells[iDGV].Style.ForeColor = FCol;
                    }
                }
            }
        }
        private void SynchronizeColTaxTextFillList()
        {
            bool IsWebservice = false;
            foreach (DiversityWorkbench.DatabaseService DS in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DatabaseServices())
            {
                if (DS.DisplayText == this.comboBoxSynColTaxTextDatabase.Text && DS.IsWebservice)
                {
                    IsWebservice = true;
                    break;
                }
            }
            string Source = "";
            if (!IsWebservice)
            {
                Source = this.SynchronizeColTaxTextTaxonDatabase;
                if (this.SynchronizeColTaxTextLinkedServer.Length > 0)
                    Source = this.SynchronizeColTaxTextLinkedServer + "." + Source;
            }
            else Source = this.comboBoxSynColTaxTextDatabase.Text;

            string SQL = "SELECT ";
            string SqlOrder = " ORDER BY RTRIM(LTRIM(I.TaxonomicName)) ";
            if (!this.checkBoxSynColTaxTextIncludeAccNr.Checked) SQL += " DISTINCT ";
            if (this.checkBoxSynColTaxTextMax.Checked)
                SQL += "TOP " + this.numericUpDownSynColTaxTextMax.Value.ToString();
            SQL += " CAST(1 as bit) AS OK, RTRIM(LTRIM(I.TaxonomicName)) AS [TaxonomicName in DiversityCollection], '' AS [Name in " + Source + "], I.NameURI ";
            if (this.checkBoxSynColTaxTextIncludeAccNr.Checked) SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";

            //if (this.comboBoxSynColTaxTextDatabase.Text == "IndexFungorum" && this.radioButtonSynColTaxTextCompareParts.Checked)
            //    SQL += ", CAST(0 AS int) AS Similarities ";
            if (/*IsWebservice && */this.radioButtonSynColTaxTextCompareParts.Checked ||
                (this.radioButtonSynColTaxTextCompareAll.Checked && this.checkBoxSynColTaxTextCompareAllExcludeAuthors.Checked))
                SQL += ", CAST(1 AS int) AS Similarities ";

            if (this.checkBoxSynColTaxTextIncludeHierarchy.Checked)
            {
                SQL += ",'' AS [Family], '' AS [Order], '' AS Hierarchy";
            }
            SQL += " FROM Identification AS I ";
            if (this.comboBoxSynColTaxTextTaxonomicGroup.Text.Length > 0)
                SQL += " INNER JOIN IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID " +
                    " AND I.IdentificationUnitID = U.IdentificationUnitID ";
            if (this.checkBoxSynColTaxTextComparePartsRestrictToLastIdent.Checked)
                SQL += " AND I.TaxonomicName = U.LastIdentificationCache ";
            SQL += " INNER JOIN CollectionProject AS P ON I.CollectionSpecimenID = P.CollectionSpecimenID " +
                " INNER JOIN CollectionSpecimen AS S ON I.CollectionSpecimenID = S.CollectionSpecimenID " +
                " WHERE (I.NameURI IS NULL  OR I.NameURI = '') AND I.TaxonomicName <> '' ";
            if (this.comboBoxSynColTaxTextTaxonomicGroup.Text.Length > 0)
            {
                System.Data.DataRowView rTax = (System.Data.DataRowView)this.comboBoxSynColTaxTextTaxonomicGroup.SelectedItem;
                SQL += " AND U.TaxonomicGroup = '" + rTax[0].ToString() + "'";
            }
            if (this.comboBoxSynColTaxTextProject.SelectedIndex > -1
                || this.comboBoxSynColTaxTextProject.Items.Count == 1)
            {
                int ProjectID = 0;
                if (this.comboBoxSynColTaxTextProject.SelectedItem != null)
                {
                    System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColTaxTextProject.SelectedItem;
                    if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                        SQL += " AND P.ProjectID = " + ProjectID.ToString();
                    else
                        return;
                }
                else return;
                //if (!int.TryParse(this.comboBoxSynColTaxTextProject.SelectedValue.ToString(), out ProjectID))
                //    return;
                //else
                //    SQL += " AND P.ProjectID = " + ProjectID.ToString();
            }
            if (this.textBoxSynColTaxTextStartString.Text.Length > 0)
                SQL += " AND I.TaxonomicName LIKE '" + this.textBoxSynColTaxTextStartString.Text + "%' ";
            if (this.checkBoxSynColTaxTextComparePartsRestrictToLastIdent.Checked)
                SQL += " and exists(select * from Identification AS L where L.CollectionSpecimenID = I.CollectionSpecimenID and L.IdentificationUnitID = I.IdentificationUnitID group by L.CollectionSpecimenID, L.IdentificationUnitID " +
                    "having  max(L.IdentificationSequence) = I.IdentificationSequence )";
            SQL += SqlOrder;
            if (this._dtSynColTaxText == null) this._dtSynColTaxText = new DataTable();
            else this._dtSynColTaxText.Clear();
            Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            try
            {
                ad.Fill(this._dtSynColTaxText);
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
            this.dataGridViewSynColTaxText.DataSource = this._dtSynColTaxText;
        }

        private void SynchronizeColTaxText_UpdateWithWorkbenchModuleOnSameServer(string TaxGroup, int ProjectID)
        {
            string NameList = "";
            bool UseNameList = false;
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColTaxText.Rows)
            {
                if (R.Cells[0].Value.ToString().ToLower() == "false")
                    UseNameList = true;
                else
                {
                    if (NameList.Length > 0)
                        NameList += ", ";
                    NameList += "N'" + R.Cells[1].Value.ToString() + "'";
                }
            }
            string SQL = "UPDATE I " +
                "SET NameURI = '" + this.SynchronizeColTaxTextBaseURL + "' + CAST(T.NameID AS VARCHAR) " +
                "FROM " + this.SynchronizeColTaxTextPrefix + "TaxonNameProject AS TP, " + this.SynchronizeColTaxTextPrefix + "TaxonName AS T INNER JOIN " +
                "Identification AS I INNER JOIN " +
                "IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID AND I.IdentificationUnitID = U.IdentificationUnitID ON " +
                "T.TaxonNameCache = I.TaxonomicName INNER JOIN " +
                "CollectionProject AS P ON I.CollectionSpecimenID = P.CollectionSpecimenID " +
                "WHERE (I.NameURI IS NULL OR I.NameURI = '') AND (NOT (I.TaxonomicName IS NULL)) AND (LEN(I.TaxonomicName) > 0) " +
                "AND (U.TaxonomicGroup = N'" + TaxGroup + "') " +
                "AND (P.ProjectID = " + ProjectID.ToString() + ") " +
                "AND (I.CollectionSpecimenID IN (" + this.ListOfCollectionSpecimenIDForUpdateOfIdentificationViaText + "))" +
                "AND TP.NameID = T.NameID AND TP.ProjectID = " + this.comboBoxSynColTaxTextTaxonNameProject.SelectedValue.ToString();
            if (UseNameList)
                SQL += " AND I.TaxonomicName IN (" + NameList + ")";
            if (this.checkBoxSynColTaxTextComparePartsRestrictToLastIdent.Checked)
            {
                SQL += " AND U.LastIdentificationCache = I.TaxonomicName " +
                    " AND EXISTS (SELECT * FROM Identification Imax WHERE I.CollectionSpecimenID = Imax.CollectionSpecimenID and i.IdentificationUnitID = Imax.IdentificationUnitID group by Imax.CollectionSpecimenID, Imax.IdentificationUnitID having I.IdentificationSequence = max(Imax.IdentificationSequence))";
            }

            Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
            Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
            string Message = "";
            try
            {
                con.Open();
                C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                C.ExecuteScalar();
                Message = "Update finished";
            }
            catch (Exception ex)
            {
                Message = "Update failed: " + ex.Message;
            }
            finally
            {
                con.Close();
                this.dataGridViewSynColTaxText.DataSource = null;
            }
            System.Windows.Forms.MessageBox.Show(Message);
        }

        private string SynchronizeColTaxText_UpdateFromTableContent(string TaxGroup, int ProjectID)
        {
            System.Collections.Generic.List<System.Data.DataRow> UpdatedRows = new List<DataRow>();
            this._dtSynColTaxText.AcceptChanges();
            this.progressBarSynColTaxText.Maximum = this._dtSynColTaxText.Rows.Count;
            this.progressBarSynColTaxText.Minimum = 0;
            this.progressBarSynColTaxText.Value = 0;
            this.progressBarSynColTaxText.Visible = true;
            int i = 0;
            string Message = "";
            Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand("", con);
            try
            {
                con.Open();
                foreach (System.Data.DataRow R in this._dtSynColTaxText.Rows)
                {
                    if (R.RowState == DataRowState.Unchanged && R[0].ToString().ToLower() == "true")
                    {
                        string Taxon = R[2].ToString();
                        if (Taxon.IndexOf("'") > -1)
                            Taxon = Taxon.Replace("'", "''");
                        string SQL = "UPDATE I SET I.TaxonomicName = '" + Taxon + "',  I.NameURI = '" + R[3].ToString() + "' " +
                            " FROM Identification I  INNER JOIN  IdentificationUnit U ON I.CollectionSpecimenID = U.CollectionSpecimenID " +
                            " AND  I.IdentificationUnitID = U.IdentificationUnitID  INNER JOIN CollectionProject P " +
                            " ON I.CollectionSpecimenID = P.CollectionSpecimenID  " +
                            " WHERE (I.NameURI IS NULL OR I.NameURI = '')  AND RTRIM(LTRIM(I.TaxonomicName)) = N'" + R[1].ToString().Trim().Replace("'", "''") + "'" +
                            " AND (U.TaxonomicGroup = N'" + TaxGroup + "')" +
                            " AND P.ProjectID = " + ProjectID.ToString();
                        if (this.checkBoxSynColTaxTextCompareAllExcludeAuthors.Checked)
                        {

                        }
                        if (this.checkBoxSynColTaxTextComparePartsRestrictToLastIdent.Checked)
                            SQL += " and exists (select * from Identification L " +
                                "where L.IdentificationUnitID = I.IdentificationUnitID " +
                                "and L.CollectionSpecimenID = I.CollectionSpecimenID  " +
                                "group by L.IdentificationUnitID  " +
                                "having max(L.IdentificationSequence) = I.IdentificationSequence)";
                        if (this.radioButtonSynColTaxTextCompareParts.Checked
                            && this.radioButtonSynColTaxTextComparePartsInsertName.Checked)
                        {
                            SQL = "declare @MaxSequence table (UnitID int, MaxSequence int); " +
                                "insert into @MaxSequence(UnitID, MaxSequence) " +
                                "SELECT U.IdentificationUnitID, MAX(I.IdentificationSequence) " +
                                "FROM Identification AS I INNER JOIN IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID " +
                                "AND I.IdentificationUnitID = U.IdentificationUnitID  " +
                                "INNER JOIN CollectionProject AS P ON I.CollectionSpecimenID = P.CollectionSpecimenID " +
                                "INNER JOIN Identification AS M ON U.CollectionSpecimenID = M.CollectionSpecimenID  " +
                                "AND U.IdentificationUnitID = M.IdentificationUnitID " +
                                "WHERE /*(I.NameURI IS NULL) AND*/ (U.TaxonomicGroup = N'" + TaxGroup + "') " + // MW 2018/10/02 - NameURI must not be included as all identifications must be taken into account to get the correct sequence
                                "AND (P.ProjectID = " + ProjectID.ToString() + ") AND (M.TaxonomicName = N'" + R[1].ToString().Replace("'", "''") + "') " +
                                "group by U.IdentificationUnitID; " +
                                "declare @UnitID int; " +
                                "declare @Sequence int;  " +
                                "declare @SourceSequence int; " +
                                "while (select count(*) from @MaxSequence) > 0 " +
                                "begin " +
                                "set @UnitID = (select max(UnitID) from @MaxSequence); " +
                                "set @Sequence = (select MaxSequence + 1 from @MaxSequence where UnitID = @UnitID); " +
                                "set @SourceSequence = (select MAX(I.IdentificationSequence) " +
                                "FROM Identification AS I INNER JOIN IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID " +
                                "AND I.IdentificationUnitID = U.IdentificationUnitID " +
                                "WHERE (I.NameURI IS NULL)  " +
                                "AND (U.TaxonomicGroup = N'" + TaxGroup + "')  " +
                                "AND (I.TaxonomicName = N'" + R[1].ToString().Replace("'", "''") + "') " +
                                "AND U.IdentificationUnitID = @UnitID); " +
                                "INSERT INTO [dbo].[Identification]   " +
                                "([CollectionSpecimenID],[IdentificationUnitID], IdentificationSequence,[TaxonomicName],[NameURI] ";
                            if (this.checkBoxSynColTaxTextIncludeAnyIdentificationInfo.Checked)
                                SQL += ", IdentificationDay, IdentificationMonth, IdentificationYear, " +
                                    "IdentificationDateSupplement, IdentificationDateCategory, VernacularTerm, IdentificationCategory, IdentificationQualifier, TypeStatus, TypeNotes, ReferenceTitle, " +
                                    "ReferenceURI, Notes, ResponsibleName, ResponsibleAgentURI, ReferenceDetails";
                            SQL += ")  " +
                                "SELECT I.CollectionSpecimenID, I.IdentificationUnitID, @Sequence, '" + Taxon + "' " +
                                "AS TaxonomicName,  '" + R[3].ToString() + "' AS NameURI ";
                            if (this.checkBoxSynColTaxTextIncludeAnyIdentificationInfo.Checked)
                                SQL += ", I.IdentificationDay, I.IdentificationMonth, I.IdentificationYear, I.IdentificationDateSupplement, " +
                                    "I.IdentificationDateCategory, I.VernacularTerm, I.IdentificationCategory, I.IdentificationQualifier, I.TypeStatus, I.TypeNotes, I.ReferenceTitle, I.ReferenceURI, I.Notes,  " +
                                    "I.ResponsibleName, I.ResponsibleAgentURI, I.ReferenceDetails ";
                            SQL += "FROM  Identification AS I INNER JOIN  IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID " +
                                "AND I.IdentificationUnitID = U.IdentificationUnitID  " +
                                "INNER JOIN  CollectionProject AS P ON I.CollectionSpecimenID = P.CollectionSpecimenID  WHERE (I.NameURI IS NULL) " +
                                "AND (I.TaxonomicName = '" + R[1].ToString().Replace("'", "''") + "')  AND (U.TaxonomicGroup = N'" + TaxGroup + "') " +
                                "and (I.IdentificationSequence = @SourceSequence) " +
                                "AND (U.IdentificationUnitID = @UnitID) " +
                                "AND (P.ProjectID = " + ProjectID.ToString() + ") ";
                            if (this.checkBoxSynColTaxTextComparePartsRestrictToLastIdent.Checked)
                                SQL += " AND U.LastIdentificationCache = I.TaxonomicName;  ";
                            SQL += " delete M from @MaxSequence M where M.UnitID = @UnitID; " +
                               "end";
                        }
                        C.CommandText = SQL;
                        try
                        {
                            C.ExecuteNonQuery();
                            UpdatedRows.Add(R);
                        }
                        catch (System.Exception ex)
                        {
                            if (Message.Length == 0)
                                Message = "Failed taxa:\r\n\r\n";
                            Message += Taxon + ": " + ex.Message + "\r\n";
                            //R[0] = false;
                        }
                        if (this.checkBoxSynColTaxTextIncludeHierarchy.Checked)
                        {
                            SQL = "UPDATE U SET U.FamilyCache = '" + R["Family"].ToString() + "', " +
                                " U.OrderCache = '" + R["Order"].ToString() + "', " +
                                " U.HierarchyCache = '" + R["Hierarchy"].ToString() + "' " +
                                " FROM Identification AS I INNER JOIN " +
                                " IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID AND I.IdentificationUnitID = U.IdentificationUnitID INNER JOIN " +
                                " CollectionProject AS P ON I.CollectionSpecimenID = P.CollectionSpecimenID " +
                                " WHERE (I.NameURI = '" + R[3].ToString() + "') AND (I.TaxonomicName = '" + R[1].ToString().Replace("'", "''") + "') " +
                                " AND (U.TaxonomicGroup = N'" + TaxGroup + "') AND (P.ProjectID = " + ProjectID.ToString() + ") ";
                            C.CommandText = SQL;
                            C.ExecuteNonQuery();
                        }
                    }
                    else
                        i--;
                    i++;
                    this.progressBarSynColTaxText.Value = i;
                }
                System.Windows.Forms.MessageBox.Show("Update finished");
                if (UpdatedRows.Count > 0)
                {
                    foreach (System.Data.DataRow R in UpdatedRows)
                        R.Delete();
                    this._dtSynColTaxText.AcceptChanges();
                }
                //if (Message.Length == 0)
                //    this.dataGridViewSynColTaxText.DataSource = null;
            }
            catch (Exception ex)
            {
                if (this.radioButtonSynColTaxTextComparePartsInsertName.Checked)
                    System.Windows.Forms.MessageBox.Show("Insert failed:\r\n" + ex.Message);
                else
                    System.Windows.Forms.MessageBox.Show("Update failed:\r\n" + ex.Message);
            }
            finally
            {
                con.Close();
                this.progressBarSynColTaxText.Visible = false;
            }
            if (Message.Length > 0)
                System.Windows.Forms.MessageBox.Show(Message);
            return Message;
        }

        private string ListOfCollectionSpecimenIDForUpdateOfIdentificationViaText
        {
            get
            {
                string List = "";
                try
                {
                    if (this.checkBoxSynColTaxTextIncludeAccNr.Checked)
                    {
                        foreach (System.Data.DataRow R in this._dtSynColTaxText.Rows)
                        {
                            List += R["CollectionSpecimenID"].ToString() + ", ";
                        }
                        List = List.Substring(0, List.Length - 2);
                    }
                    else
                    {
                        string SQL = "SELECT DISTINCT I.CollectionSpecimenID " +
                            "FROM " + this.SynchronizeColTaxTextPrefix + "TaxonName AS T INNER JOIN " +
                            "Identification AS I INNER JOIN " +
                            "IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID AND I.IdentificationUnitID = U.IdentificationUnitID ON " +
                            "T.TaxonNameCache = I.TaxonomicName AND I.TaxonomicName = T.TaxonNameCache INNER JOIN " +
                            "CollectionProject AS P ON I.CollectionSpecimenID = P.CollectionSpecimenID " +
                            "WHERE (I.NameURI IS NULL OR I.NameURI = '') AND (NOT (I.TaxonomicName IS NULL)) AND (LEN(I.TaxonomicName) > 0) " +
                            "AND (U.TaxonomicGroup = N'" + this.comboBoxSynColTaxTextTaxonomicGroup.Text + "')";
                        if (this.comboBoxSynColTaxTextProject.SelectedIndex > 0
                            || this.comboBoxSynColTaxTextProject.Items.Count == 1)
                        {
                            int ProjectID = 0;
                            if (this.comboBoxSynColTaxTextProject.SelectedItem != null)
                            {
                                System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColTaxTextProject.SelectedItem;
                                if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                                    SQL += " AND P.ProjectID = " + ProjectID.ToString();
                                else
                                    return "";
                            }
                            else return "";
                            //if (!int.TryParse(this.comboBoxSynColTaxTextProject.SelectedValue.ToString(), out ProjectID))
                            //    return "";
                            //else
                            //    SQL += " AND P.ProjectID = " + ProjectID.ToString();
                        }
                        SQL += " AND I.TaxonomicName IN (";
                        System.Data.DataTable dtID = new DataTable();
                        foreach (System.Data.DataRow R in this._dtSynColTaxText.Rows)
                        {
                            SQL += "N'" + R[1].ToString().Replace("'", "''") + "', ";
                        }
                        SQL = SQL.Substring(0, SQL.Length - 2) + ")";
                        if (this.checkBoxSynColTaxTextComparePartsRestrictToLastIdent.Checked)
                        {
                            SQL += "AND U.LastIdentificationCache = I.TaxonomicName " +
                                "AND EXISTS (SELECT * FROM Identification Imax WHERE I.CollectionSpecimenID = Imax.CollectionSpecimenID and i.IdentificationUnitID = Imax.IdentificationUnitID group by Imax.CollectionSpecimenID, Imax.IdentificationUnitID having I.IdentificationSequence = max(Imax.IdentificationSequence))";
                        }
                        Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                        ad.Fill(dtID);
                        if (dtID.Rows.Count > 0)
                        {
                            foreach (System.Data.DataRow R in dtID.Rows)
                            {
                                List += R[0].ToString() + ", ";
                            }
                            List = List.Substring(0, List.Length - 2);
                        }
                    }
                }
                catch (System.Exception ex) { string x = ex.Message; }
                return List;
            }
        }

        #endregion

        #endregion

        #region Taxa - broken links

        private void initTaxonBrokenLinks()
        {
            try
            {
                System.Data.DataTable dt = new DataTable();
                System.Data.DataColumn dcDisplay = new DataColumn("Display", typeof(string));
                dt.Columns.Add(dcDisplay);
                System.Data.DataColumn dcBaseURL = new DataColumn("BaseURL", typeof(string));
                dt.Columns.Add(dcBaseURL);
                System.Data.DataRow Rnull = dt.NewRow();
                Rnull[0] = System.DBNull.Value;
                Rnull[1] = System.DBNull.Value;
                dt.Rows.Add(Rnull);
                foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.WorkbenchUnit> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList())
                {
                    if (KV.Key == "DiversityTaxonNames")
                    {
                        foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> SC in KV.Value.ServerConnectionList())
                        {
                            System.Data.DataRow R = dt.NewRow();
                            R[0] = SC.Value.DisplayText;
                            R[1] = SC.Value.BaseURL;
                            dt.Rows.Add(R);
                            if (this._iWUTaxonBrokenLinks == null)
                            {
                                DiversityWorkbench.TaxonName T = new DiversityWorkbench.TaxonName(SC.Value);
                                this._iWUTaxonBrokenLinks = T;
                            }
                        }
                        foreach (System.Collections.Generic.KeyValuePair<string, string> AS in KV.Value.AccessibleDatabasesAndServicesOfModule())
                        {
                            if (!KV.Value.ServerConnectionList().ContainsKey(AS.Key))
                            {
                                if (KV.Value.DatabaseAndServiceURIs().ContainsKey(AS.Key))
                                {
                                    System.Data.DataRow R = dt.NewRow();
                                    R[0] = AS.Key;
                                    R[1] = KV.Value.DatabaseAndServiceURIs()[AS.Key];
                                    dt.Rows.Add(R);
                                }
                            }
                        }

                    }
                }
                this.comboBoxSynColTaxBrokenSource.DataSource = dt;
                this.comboBoxSynColTaxBrokenSource.DisplayMember = "Display";
                this.comboBoxSynColTaxBrokenSource.ValueMember = "BaseURL";
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private System.Data.DataTable _DtTaxaBrokenLinks;
        private DiversityWorkbench.IWorkbenchUnit _iWUTaxonBrokenLinks;

        private void buttonSynColTaxBrokenCheck_Click(object sender, EventArgs e)
        {
            int CollectionSpecimenID;
            if (int.TryParse(this.dataGridViewSynColTaxBroken.Rows[this.dataGridViewSynColTaxBroken.SelectedCells[0].RowIndex].Cells[0].Value.ToString(), out CollectionSpecimenID))
            {
                DiversityCollection.Forms.FormCollectionSpecimen f = new Forms.FormCollectionSpecimen(CollectionSpecimenID, false, false);
                f.setViewMode(Forms.FormCollectionSpecimen.ViewMode.SingleInspectionMode);
                f.Width = this.Width - 10;
                f.Height = this.Height - 10;
                f.ShowDialog();
            }
        }

        private void buttonSynColTaxBrokenSearch_Click(object sender, EventArgs e)
        {
            string BaseURL = "";
            string LinkedServer = "";
            string ConnectionString = "";
            string TaxonDatabase = "";
            try
            {
                if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DataBaseURIs().TryGetValue(this.comboBoxSynColTaxBrokenSource.Text, out BaseURL))
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColTaxBrokenSource.SelectedItem;
                    TaxonDatabase = R[0].ToString();
                    ConnectionString = DiversityWorkbench.Settings.ConnectionString;
                    foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnections())
                    {
                        if (KV.Value.DisplayText == TaxonDatabase)
                        {
                            ConnectionString = KV.Value.ConnectionString;
                            TaxonDatabase = KV.Value.DatabaseName;
                            BaseURL = KV.Value.BaseURL;
                            LinkedServer = KV.Value.LinkedServer;
                        }
                    }
                }
            }
            catch(System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }

            this.labelSynColTaxBrokenCurrentState.Text = "";
            System.Collections.Generic.List<string> FailedUris = new List<string>();
            System.Collections.Generic.List<string> ExcludedUris = new List<string>();
            this._DtTaxaBrokenLinks = new DataTable();
            try
            {
                string SQL = "SELECT ";
                if (this.checkBoxSynColTaxBrokenLimit.Checked)
                    SQL += " TOP " + this.textBoxSynColTaxBrokenLimit.Text;
                SQL += " I.CollectionSpecimenID, CAST(1 as bit) AS OK, I.TaxonomicName, I.NameURI " +
                    "FROM Identification AS I INNER JOIN " +
                    "CollectionProject AS P ON I.CollectionSpecimenID = P.CollectionSpecimenID INNER JOIN " +
                    "IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID AND I.IdentificationUnitID = U.IdentificationUnitID " +
                    "WHERE (I.NameURI <> '') " +
                    "AND (P.ProjectID = " + this.comboBoxSynColTaxBrokenProject.SelectedValue.ToString() + ") ";
                if (this.comboBoxSynColTaxBrokenSource.SelectedValue != null && this.comboBoxSynColTaxBrokenSource.SelectedValue.ToString().Length > 0)
                    SQL += "AND (I.NameURI LIKE '" + this.comboBoxSynColTaxBrokenSource.SelectedValue.ToString() + "%') ";
                if (this.comboBoxSynColTaxBrokenTaxonomicGroup.SelectedValue != null && this.comboBoxSynColTaxBrokenTaxonomicGroup.SelectedValue.ToString().Length > 0)
                    SQL += "AND (U.TaxonomicGroup = N'" + this.comboBoxSynColTaxBrokenTaxonomicGroup.SelectedValue.ToString() + "')";
                if (this.checkBoxSynColTaxBrokenTaxonStart.Checked && this.textBoxSynColTaxBrokenTaxonStart.Text.Length > 0)
                    SQL += " AND (I.TaxonomicName LIKE '" + this.textBoxSynColTaxBrokenTaxonStart.Text + "%')";
                if (this.checkBoxSynColTaxBrokenRestrictLastIdent.Checked)
                    SQL += " AND (I.TaxonomicName = U.LastIdentificationCache)";
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(this._DtTaxaBrokenLinks);
                this.labelSynColTaxBrokenCurrentState.Text = "Testing " + this._DtTaxaBrokenLinks.Rows.Count.ToString() + " datasets";
                Application.DoEvents();
                this.progressBarSynColTaxBrokenLinks.Maximum = this._DtTaxaBrokenLinks.Rows.Count;
                this.progressBarSynColTaxBrokenLinks.Value = 0;
                this.dataGridViewSynColTaxBroken.Columns.Clear();

                foreach (System.Data.DataRow R in this._DtTaxaBrokenLinks.Rows)
                {
                    string URI = R["NameURI"].ToString();
                    string ID = DiversityWorkbench.WorkbenchUnit.getIDFromURI(URI);
                    if (ID.Length == 0)
                    {
                        string Server = URI;
                        if (Server.IndexOf("/") > -1)
                            Server = Server.Substring(0, Server.LastIndexOf("/"));
                        if (!FailedUris.Contains(Server) && !ExcludedUris.Contains(Server))
                        {
                            if (System.Windows.Forms.MessageBox.Show("The retrieval of the ID for the server " + Server + " failed. Exclude this server from the search", "Exclude server?", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
                            {
                                if (!ExcludedUris.Contains(Server))
                                    ExcludedUris.Add(Server);
                            }
                            else
                            {
                                if (!FailedUris.Contains(Server))
                                    FailedUris.Add(Server);
                            }
                        }
                        if (ExcludedUris.Contains(Server))
                            R.Delete();
                        //this._DtTaxaBrokenLinks.Clear();
                        //break;
                    }
                    else
                    {
                        //System.Collections.Generic.Dictionary<string, string> D = new Dictionary<string, string>();
                        bool OK = false;
                        try
                        {
                            if (LinkedServer.Length > 0)
                            {
                                string SqlTest = "SELECT COUNT(*) FROM [" + LinkedServer + "].[" + TaxonDatabase + "].dbo.TaxonName AS T WHERE (T.NameID = " + ID.ToString() + ")";
                                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(ConnectionString);
                                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SqlTest, con);
                                con.Open();
                                if (int.Parse(C.ExecuteScalar()?.ToString()) > 0)
                                    OK = true;
                                con.Close();
                                con.Dispose();

                            }
                            else
                                OK = this._iWUTaxonBrokenLinks.DoesExist(int.Parse(ID));
                            if (!OK)
                            {
                                DiversityWorkbench.TaxonName T = new DiversityWorkbench.TaxonName(DiversityWorkbench.Settings.ServerConnection);
                                System.Collections.Generic.Dictionary<string, string> UV = T.UnitValues(URI);
                                if (UV.Count > 0 && UV["_URI"] == URI)
                                    OK = true;
                            }
                            //D = this._iWUTaxonBrokenLinks.UnitValues(int.Parse(ID));
                        }
                        catch (System.Exception ex)
                        {
                            OK = false;
                        }
                        if (/*D.Count > 0 && */OK)
                            R.Delete();
                    }
                    this.progressBarSynColTaxBrokenLinks.Value++;
                }
                this._DtTaxaBrokenLinks.AcceptChanges();
                this.labelSynColTaxBrokenCurrentState.Text = this._DtTaxaBrokenLinks.Rows.Count.ToString() + " broken links found";
                if(FailedUris.Count > 0)
                {
                    FailedUris.Sort();
                    string Message = "The retrieval of the ID for the following URIs failed. Please check connection to datasource";
                    foreach (string U in FailedUris)
                        Message += "\r\n" + U;
                    System.Windows.Forms.MessageBox.Show(Message, "Failed URLs", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            this.dataGridViewSynColTaxBroken.DataSource = this._DtTaxaBrokenLinks;
            if (this.dataGridViewSynColTaxBroken.Columns.Count > 3)
            {
                this.dataGridViewSynColTaxBroken.Columns[0].Visible = false;
                this.dataGridViewSynColTaxBroken.Columns[1].ReadOnly = false;
                this.dataGridViewSynColTaxBroken.Columns[2].ReadOnly = true;
                this.dataGridViewSynColTaxBroken.Columns[3].ReadOnly = true;
                this.dataGridViewSynColTaxBroken.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
            }
        }

        private void buttonSynColTaxBrokenAll_Click(object sender, EventArgs e)
        {
            // #173
            if (this._DtTaxaBrokenLinks == null) return;

            foreach (System.Data.DataRow R in this._DtTaxaBrokenLinks.Rows)
                R["OK"] = true;
        }

        private void buttonSynColTaxBrokenNone_Click(object sender, EventArgs e)
        {
            // #173
            if (this._DtTaxaBrokenLinks == null) return;

            foreach (System.Data.DataRow R in this._DtTaxaBrokenLinks.Rows)
                R["OK"] = false;
        }

        private void buttonSynColTaxBrokenShowList_Click(object sender, EventArgs e)
        {
            foreach (System.Data.DataRow R in this._DtTaxaBrokenLinks.Rows)
            {
                if (R["OK"].ToString().ToLower() == "true")
                    this.CollectionSpecimenIDs.Add(int.Parse(R["CollectionSpecimenID"].ToString()));
            }
            this._ShowList = true;
            this.DialogResult = DialogResult.OK;
            this.Close();
        }

        private void buttonSynColTaxBrokenConnections_Click(object sender, EventArgs e)
        {
            DiversityWorkbench.Forms.FormConnectionAdministration f = new DiversityWorkbench.Forms.FormConnectionAdministration(DiversityWorkbench.WorkbenchResources.WorkbenchDirectory.HelpProviderNameSpace());
            f.ShowDialog();
        }

        private void buttonSynColTaxBrokenUpdate_Click(object sender, EventArgs e)
        {

        }

        #endregion

        #region dwb webservices

        private DwbServiceEnums.DwbService getCurrentService(string comboText)
        {
            DwbServiceEnums.DwbService service = DwbServiceEnums.DwbService.None;
            if (Enum.TryParse(comboText, true, out DwbServiceEnums.DwbService result))
            {
                service = result;
            }

            return service;
        }
        private bool isTaxWebService(string comboText)
        {
            DwbServiceEnums.DwbService service = DwbServiceEnums.DwbService.None;
            if (Enum.TryParse(comboText, true, out DwbServiceEnums.DwbService result))
            {
                var serviceInfo = DwbServiceEnums.TaxonomicServiceInfoDictionary();
                if (serviceInfo.TryGetValue(service, out DwbServiceEnums.DwbServiceInfo serviceInfoValue))
                {
                    if (serviceInfoValue.Type == DwbServiceEnums.DwbServiceType.TaxonomicService)
                        return true;
                }
            }

            return false;
        }
        private async System.Threading.Tasks.Task<DwbEntity> getApiDetailModel(IDwbWebservice<DwbSearchResult, DwbSearchResultItem, DwbEntity> _api, string nameUri)
        {
            try
            {
                var tt = await _api.CallWebServiceAsync<object>(
                    nameUri,
                    DwbServiceEnums.HttpAction.GET);
                DwbEntity clientEntity = _api.GetDwbApiDetailModel(tt);
                return clientEntity;
            }
            catch (ArgumentException aEx)
            {
                MessageBox.Show(
                    "The web service call is incorrect.\r\n\r\n  " +
                    "For more details on the error, see the error log file.\r\n\r\n",
                    "Web service Error", MessageBoxButtons.OK,
                    MessageBoxIcon.Error);
                ExceptionHandling.WriteToErrorLogFile(
                    "FormMaintenance - getApiSearchModel, ArgumentException exception: " +
                    aEx);
                return null;
            }
            catch (InvalidOperationException ioEx)
            {
                MessageBox.Show(
                    "The web service call is incorrect.\r\n\r\n  " +
                    "For more details on the error, see the error log file.\r\n\r\n",
                    "Web service Error", MessageBoxButtons.OK,
                    MessageBoxIcon.Error);
                ExceptionHandling.WriteToErrorLogFile(
                    "FormMaintenance - getApiSearchModel, Exception exception: " +
                    ioEx);
                return null;
            }
            catch (Exception ex)
            {
                MessageBox.Show(
                    "The web service call is incorrect.\r\n\r\n  " +
                    "For more details on the error, see the error log file.\r\n\r\n",
                    "Web service Error", MessageBoxButtons.OK,
                    MessageBoxIcon.Error);
                ExceptionHandling.WriteToErrorLogFile(
                    "FormMaintenance - getApiSearchModel, Exception exception: " +
                    ex);
                return null;
            }

        }

        private async System.Threading.Tasks.Task<DwbSearchResult> getApiSearchModel(IDwbWebservice<DwbSearchResult, DwbSearchResultItem, DwbEntity> _api, string searchUri)
        {
            try
            {
                var tt = await _api.CallWebServiceAsync<object>(
                    searchUri,
                    DwbServiceEnums.HttpAction.GET);
                DwbSearchResult clientSearch = null;
                if (tt != null)
                {
                    clientSearch = _api.GetDwbApiSearchResultModel(tt);
                }

                return clientSearch;
            }
            catch (ArgumentException aEx)
            {
                MessageBox.Show(
                    "The web service call is incorrect.\r\n\r\n  " +
                    "For more details on the error, see the error log file.\r\n\r\n",
                    "Web service Error", MessageBoxButtons.OK,
                    MessageBoxIcon.Error);
                ExceptionHandling.WriteToErrorLogFile(
                    "FormMaintenance - getApiSearchModel, ArgumentException exception: " +
                    aEx);
                return null;
            }
            catch (InvalidOperationException ioEx)
            {
                MessageBox.Show(
                    "The web service call is incorrect.\r\n\r\n  " +
                    "For more details on the error, see the error log file.\r\n\r\n",
                    "Web service Error", MessageBoxButtons.OK,
                    MessageBoxIcon.Error);
                ExceptionHandling.WriteToErrorLogFile(
                    "FormMaintenance - getApiSearchModel, Exception exception: " +
                    ioEx);
                return null;
            }
            catch (Exception ex)
            {
                MessageBox.Show(
                    "The web service call is incorrect.\r\n\r\n  " +
                    "For more details on the error, see the error log file.\r\n\r\n",
                    "Web service Error", MessageBoxButtons.OK,
                    MessageBoxIcon.Error);
                ExceptionHandling.WriteToErrorLogFile(
                    "FormMaintenance - getApiSearchModel, Exception exception: " +
                    ex);
                return null;
            }
        }

        private void ReadDwbSearchModelInQueryTable(DwbSearchResult dwbSearch, ref System.Data.DataTable dtQuery)
        {
            try
            {
                if (dwbSearch is null)
                    return;
                if (dwbSearch is TaxonomicSearchResult)
                {
                    TaxonomicSearchResult taxonomichResult = (TaxonomicSearchResult)dwbSearch;
                    dtQuery.Columns.Clear();
                    var columns = new[]
                    {
                        new { Name = "_URI", Type = "System.String" },
                        new { Name = "_DisplayText", Type = "System.String" },
                        new { Name = "Taxon", Type = "System.String" },
                        new { Name = "URL", Type = "System.String" },
                        new { Name = "Kingdom", Type = "System.String" },
                        new { Name = "Rank", Type = "System.String" },
                        new { Name = "Status", Type = "System.String" },
                        new { Name = "External ID", Type = "System.String" },
                        new { Name = "Database", Type = "System.String" },
                        new { Name = "Common names", Type = "System.String" },
                        new { Name = "Distribution", Type = "System.String" },
                        new { Name = "Citation", Type = "System.String" }
                    };
                    foreach (var column in columns)
                    {
                        dtQuery.Columns.Add(new DataColumn(column.Name, Type.GetType(column.Type)));
                    }

                    foreach (var item in taxonomichResult.DwbApiSearchResponse)
                    {
                        var row = dtQuery.NewRow();
                        row["_URI"] = item._URL;
                        row["_DisplayText"] = item._DisplayText;
                        row["Taxon"] = item.Taxon;
                        row["URL"] = item._URL;
                        row["Kingdom"] = item.Kingdom;
                        row["Rank"] = item.Rank;
                        row["Status"] = item.Status;
                        row["Common names"] = item.CommonNames;
                        dtQuery.Rows.Add(row);
                    }
                }
                else
                {
                    // TODO implement other service mappings
                }

            }
            catch (Exception ex)
            {
#if DEBUG

                Console.WriteLine(ex.StackTrace);
#endif 
            }
        }
        private void ReadDwbDetailModelInQueryTable(DwbEntity dwbEntity, ref System.Data.DataTable dtQuery)
        {
            try
            {
                if (dwbEntity is null)
                    return;
                if (dwbEntity is TaxonomicEntity)
                {
                    TaxonomicEntity taxonomicEntity = (TaxonomicEntity)dwbEntity;

                    dtQuery.Columns.Clear();
                    var columns = new[]
                    {
                        new { Name = "_URI", Type = "System.String" },
                        new { Name = "_DisplayText", Type = "System.String" },
                        new { Name = "Family", Type = "System.String" },
                        new { Name = "Order", Type = "System.String" },
                        new { Name = "Hierarchy", Type = "System.String" },
                    };
                    foreach (var column in columns)
                    {
                        dtQuery.Columns.Add(new DataColumn(column.Name, Type.GetType(column.Type)));
                    }

                    var row = dtQuery.NewRow();
                    row["_URI"] = taxonomicEntity._URL;
                    row["_DisplayText"] = taxonomicEntity._DisplayText;
                    row["Family"] = taxonomicEntity.Family;
                    row["Order"] = taxonomicEntity.Order;
                    row["Hierarchy"] = taxonomicEntity.Hierarchy;
                    dtQuery.Rows.Add(row);
                }
                else
                {
                    // TODO implement other service mappings
                }
            }
            catch (Exception ex)
            {
#if DEBUG

                Console.WriteLine(ex.StackTrace);
#endif 
            }
        }
        #endregion
        
        #region Family and order

        #region Synchronize with a taxon database
        /*
        SELECT DISTINCT 
        IdentificationUnit.LastIdentificationCache, DiversityTaxonNames_Fungi.dbo.TaxonFamily.Family, IdentificationUnit.TaxonomicGroup, 
        IdentificationUnit.CollectionSpecimenID, CollectionSpecimen.AccessionNumber
        FROM IdentificationUnit INNER JOIN
        Identification ON IdentificationUnit.CollectionSpecimenID = Identification.CollectionSpecimenID AND 
        IdentificationUnit.IdentificationUnitID = Identification.IdentificationUnitID AND 
        IdentificationUnit.LastIdentificationCache = Identification.TaxonomicName INNER JOIN
        DiversityTaxonNames_Fungi.dbo.TaxonFamily ON Identification.NameURI = DiversityTaxonNames_Fungi.dbo.BaseURL() 
        + CAST(DiversityTaxonNames_Fungi.dbo.TaxonFamily.NameID AS varchar) INNER JOIN
        CollectionProject ON IdentificationUnit.CollectionSpecimenID = CollectionProject.CollectionSpecimenID INNER JOIN
        ProjectList ON CollectionProject.ProjectID = ProjectList.ProjectID INNER JOIN
        CollectionSpecimen ON IdentificationUnit.CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID AND 
        CollectionProject.CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID
        WHERE (IdentificationUnit.TaxonomicGroup = N'fungus') AND (NOT (DiversityTaxonNames_Fungi.dbo.TaxonFamily.Family IS NULL)) AND 
        (IdentificationUnit.FamilyCache IS NULL) AND (CollectionProject.ProjectID = 264)
        ORDER BY IdentificationUnit.LastIdentificationCache, DiversityTaxonNames_Fungi.dbo.TaxonFamily.Family

        SELECT     IdentificationUnit.LastIdentificationCache, DiversityTaxonNames_Fungi.dbo.TaxonFamily.Family, IdentificationUnit.TaxonomicGroup
        FROM IdentificationUnit INNER JOIN
        Identification ON IdentificationUnit.CollectionSpecimenID = Identification.CollectionSpecimenID AND 
        IdentificationUnit.IdentificationUnitID = Identification.IdentificationUnitID AND 
        IdentificationUnit.LastIdentificationCache = Identification.TaxonomicName INNER JOIN
        DiversityTaxonNames_Fungi.dbo.TaxonFamily ON Identification.NameURI = DiversityTaxonNames_Fungi.dbo.BaseURL() 
        + CAST(DiversityTaxonNames_Fungi.dbo.TaxonFamily.NameID AS varchar) INNER JOIN
        CollectionProject ON IdentificationUnit.CollectionSpecimenID = CollectionProject.CollectionSpecimenID INNER JOIN
        ProjectList ON CollectionProject.ProjectID = ProjectList.ProjectID
        WHERE     (IdentificationUnit.TaxonomicGroup = N'fungus') AND (NOT (DiversityTaxonNames_Fungi.dbo.TaxonFamily.Family IS NULL)) AND 
        (IdentificationUnit.FamilyCache IS NULL) AND (CollectionProject.ProjectID = 264)
        ORDER BY IdentificationUnit.LastIdentificationCache, DiversityTaxonNames_Fungi.dbo.TaxonFamily.Family       
         * */

        private string SynColTaxFamOrdConnectionString()
        {
            string ConnectionString = "";
            if (this.comboBoxSynColTaxFamOrdDatabase.Text.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please choose a database");
                return "";
            }
            string DB = this.comboBoxSynColTaxFamOrdDatabase.SelectedItem.ToString();// = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseList();
            ConnectionString = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnectionList()[DB].ConnectionString;

            return ConnectionString;
        }

        private string SynColTaxFamOrdBaseURL()
        {
            string BaseURL = "";
            string SQL = "";
            //string SqlOrder = "";
            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DataBaseURIs().TryGetValue(this.comboBoxSynColTaxFamOrdDatabase.Text, out BaseURL))
                return BaseURL;
            else return "";
        }

        private async void buttonSynColTaxFamOrdCheck_Click(object sender, EventArgs e)
        {
            // #175
            if (this.checkBoxSynColTaxFamOrdMaxRecords.Checked && this.numericUpDownSynColTaxFamOrdMaxRecords.Value == 0)
            {
                if (System.Windows.Forms.MessageBox.Show("You restricted the number of results to 0. Change to 100?", "0 results", MessageBoxButtons.OKCancel, MessageBoxIcon.Question) == DialogResult.OK)
                    this.numericUpDownSynColTaxFamOrdMaxRecords.Value = 100;
                else return;
            }
            // get all relevant datasets
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            bool setColumnWidth = true;
            if (this.dataGridViewSynColTaxFamOrd.ColumnCount > 1) setColumnWidth = false;
            if (this.comboBoxSynColTaxFamOrdDatabase.Text.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please choose a database");
                return;
            }
            // #175
            if (this.comboBoxSynColTaxFamOrdTaxonProject.Visible && this.comboBoxSynColTaxFamOrdTaxonProject.Text.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please choose a project within the taxon database");
                return;
            }
            string BaseURL = "";
            string SQL = "";
            string SqlCount = "";
            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DataBaseURIs().TryGetValue(this.comboBoxSynColTaxFamOrdDatabase.Text, out BaseURL))
            {
                SQL = "SELECT ";
                SqlCount = "SELECT COUNT(*) ";
                if (!this.checkBoxSynColTaxFamOrdIncludeAccNr.Checked) SQL += " DISTINCT ";
                if (this.checkBoxSynColTaxFamOrdMaxRecords.Visible && this.checkBoxSynColTaxFamOrdMaxRecords.Checked)
                    SQL += " TOP " + this.numericUpDownSynColTaxFamOrdMaxRecords.Value.ToString() + " ";
                SQL += " CAST(1 as bit) AS OK, U.LastIdentificationCache AS [Last identification in DiversityCollection], ";
                if (this.radioButtonFamily.Checked)
                    SQL += "U.FamilyCache AS [Family in DiversityCollection], '' AS [Family in DiversityTaxonNames] ";//HL.Family AS [Family in DiversityTaxonNames] ";
                else if (this.radioButtonOrder.Checked)
                    SQL += "U.OrderCache AS [Order in DiversityCollection], '' AS [Order in DiversityTaxonNames] ";//HL.[Order] AS [Order in DiversityTaxonNames] ";
                else
                    SQL += "U.HierarchyCache AS [Hierarchy in DiversityCollection], '' AS [Hierarchy in DiversityTaxonNames] ";//HL.Hierarchy AS [Hierarchy in DiversityTaxonNames] ";

                SQL += ", I.NameURI ";
                if (this.checkBoxSynColTaxFamOrdIncludeAccNr.Checked) SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";
                SQL += this.SqlFromClauseSynColTaxFamOrd() + " ORDER BY U.LastIdentificationCache ";
                SqlCount += this.SqlFromClauseSynColTaxFamOrd();
                this._dtSynColTaxHierarchy = new DataTable();
                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, con);
                ad.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                try
                {
                    ad.Fill(this._dtSynColTaxHierarchy);
                    string TaxonProjectID = "";
                    if (this.comboBoxSynColTaxFamOrdTaxonProject.SelectedValue != null)
                        TaxonProjectID = this.comboBoxSynColTaxFamOrdTaxonProject.SelectedValue.ToString();
                    string TaxonConnectionString = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnectionList()[this.comboBoxSynColTaxFamOrdDatabase.Text].ConnectionString;
                    Microsoft.Data.SqlClient.SqlConnection conDTN = new Microsoft.Data.SqlClient.SqlConnection(TaxonConnectionString);
                    Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand("", conDTN);
                    conDTN.Open();
                    this.progressBarSynColTaxFamOrdDatabase.Value = 0;
                    this.progressBarSynColTaxFamOrdDatabase.Minimum = 0;
                    this.progressBarSynColTaxFamOrdDatabase.Maximum = this._dtSynColTaxHierarchy.Rows.Count;
                    this.progressBarSynColTaxFamOrdDatabase.Visible = true;
                    string Prefix = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnectionList()[this.comboBoxSynColTaxFamOrdDatabase.Text].DatabaseName + ".dbo.";
                    string LinkedServer = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnectionList()[this.comboBoxSynColTaxFamOrdDatabase.Text].LinkedServer;
                    System.Data.DataTable dtHierarchy = new DataTable();
                    Microsoft.Data.SqlClient.SqlDataAdapter adHierarchy = new Microsoft.Data.SqlClient.SqlDataAdapter("", DiversityWorkbench.Settings.ConnectionString);
                    if (LinkedServer.Length > 0)
                        Prefix = "[" + LinkedServer + "]." + Prefix;
                    System.Collections.Generic.List<System.Data.DataRow> RowsToRemove = new List<DataRow>();
                    foreach (System.Data.DataRow R in this._dtSynColTaxHierarchy.Rows)
                    {
                        string NameID = DiversityWorkbench.WorkbenchUnit.getIDFromURI(R[4].ToString());
                        if (NameID.Length == 0)
                        {
                            RowsToRemove.Add(R);
                            continue;
                        }
                        string Result = "";
                        // get only single values for higher performance
                        if (this.radioButtonFamily.Checked || this.radioButtonOrder.Checked)
                        {
                            if (Prefix.Length == 0)
                            {
                                SQL = "SELECT H.Taxon FROM [dbo].[HierarchySuperiorList] (" + NameID + ", " + TaxonProjectID + ") H WHERE H.TaxonomicRank = '";
                                if (this.radioButtonFamily.Checked)
                                    SQL += "fam";
                                else if (this.radioButtonOrder.Checked)
                                    SQL += "ord";
                                SQL += ".'";
                            }
                            else
                            {
                                if (this.radioButtonFamily.Checked)
                                    SQL = "SELECT Family FROM " + Prefix + "TaxonFamily F WHERE F.NameID = " + NameID;
                                else if (this.radioButtonOrder.Checked)
                                    SQL = "SELECT [Order] FROM " + Prefix + "TaxonOrder O WHERE O.NameID = " + NameID;
                            }
                            C.CommandText = SQL;
                            try
                            {
                                Result = C.ExecuteScalar()?.ToString();
                                R[3] = Result;
                            }
                            catch (System.Exception ex) { }
                        }
                        else
                        {
                            if (this.radioButtonTaxonHierarchyCache.Checked)
                            {
                                SQL = "SELECT H.[HierarchyListCache] FROM " + Prefix + "[TaxonHierarchy] H WHERE H.NameID = " + NameID + " AND ProjectID = " + TaxonProjectID;
                                Result = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL);
                            }
                            else
                            { 
                                if (dtHierarchy == null)
                                    dtHierarchy = new DataTable();
                                else dtHierarchy.Rows.Clear();
                                if (Prefix.Length == 0)
                                {
                                    SQL = "SELECT H.Taxon FROM " + Prefix + "[HierarchySuperiorList] (" + NameID + ", " + TaxonProjectID + ") H WHERE H.NameID <> " + NameID + " ORDER BY Seq DESC";
                                    adHierarchy.SelectCommand.CommandText = SQL;
                                    adHierarchy.Fill(dtHierarchy);
                                    foreach (System.Data.DataRow RH in dtHierarchy.Rows)
                                    {
                                        if (Result.Length > 0) Result += " | ";
                                        Result += RH[0].ToString();
                                    }
                                }
                                else
                                {
                                    int i = 1;
                                    SQL = "SELECT N.NameID,  H.NameParentID, " + i.ToString() + " AS Seq, N.TaxonNameCache, " +
                                        "CASE WHEN E.DisplayOrder BETWEEN 180 AND 260 AND N.InfragenericEpithet <> '' THEN N.InfragenericEpithet ELSE RTRIM(N.GenusOrSupragenericName) " +
                                        "+ CASE WHEN N.SpeciesEpithet <> '' THEN ' ' + N.SpeciesEpithet ELSE '' END + CASE WHEN N.InfraspecificEpithet <> '' THEN ' ' + N.TaxonomicRank + ' ' + N.InfraspecificEpithet " +
                                        "ELSE '' END END AS Taxon , N.TaxonomicRank, rtrim(upper(substring(ltrim(E.DisplayText), 1, 1)) + substring(E.DisplayText, 2, 50)) " +
                                        "FROM " + Prefix + "TaxonHierarchy H, " + Prefix + "TaxonNameTaxonomicRank_Enum E, " + Prefix + "TaxonName N " +
                                        "WHERE N.TaxonomicRank = E.Code AND H.NameID = N.NameID " +
                                        " and H.ProjectID = " + TaxonProjectID +
                                        " and H.IgnoreButKeepForReference = 0 and N.NameID = " + NameID;
                                    adHierarchy.SelectCommand.CommandText = SQL;
                                    adHierarchy.Fill(dtHierarchy);
                                    while (dtHierarchy.Select("NameParentID IS NULL").Length < 1)
                                    {
                                        i++;
                                        System.Data.DataRow[] rr = dtHierarchy.Select("", "Seq DESC");
                                        if (rr.Length > 0)
                                        {
                                            string ParentNameID = rr[0]["NameParentID"].ToString();
                                            SQL = "SELECT N.NameID,  H.NameParentID, " + i.ToString() + " AS Seq, N.TaxonNameCache, " +
                                                "CASE WHEN E.DisplayOrder BETWEEN 180 AND 260 AND N.InfragenericEpithet <> '' THEN N.InfragenericEpithet ELSE RTRIM(N.GenusOrSupragenericName) " +
                                                "+ CASE WHEN N.SpeciesEpithet <> '' THEN ' ' + N.SpeciesEpithet ELSE '' END + CASE WHEN N.InfraspecificEpithet <> '' THEN ' ' + N.TaxonomicRank + ' ' + N.InfraspecificEpithet " +
                                                "ELSE '' END END AS Taxon , N.TaxonomicRank, rtrim(upper(substring(ltrim(E.DisplayText), 1, 1)) + substring(E.DisplayText, 2, 50)) " +
                                                "FROM " + Prefix + "TaxonHierarchy H, " + Prefix + "TaxonNameTaxonomicRank_Enum E, " + Prefix + "TaxonName N " +
                                                "WHERE N.TaxonomicRank = E.Code AND H.NameID = N.NameID " +
                                                " and H.NameID <> H.NameParentID " +
                                                " and H.ProjectID = " + TaxonProjectID +
                                                " and H.IgnoreButKeepForReference = 0 and N.NameID = " + ParentNameID;
                                            adHierarchy.SelectCommand.CommandText = SQL;
                                            int iBefore = dtHierarchy.Rows.Count;
                                            adHierarchy.Fill(dtHierarchy);
                                            // Markus 16.09.2016 - endlos ...
                                            if (dtHierarchy.Rows.Count == iBefore)
                                                break;
                                        }
                                        else
                                            break;
                                    }
                                    foreach (System.Data.DataRow RH in dtHierarchy.Rows)
                                    {
                                        if (this.radioButtonTaxonHierarchyBottomUp.Checked)
                                        {
                                            if (Result.Length > 0)
                                            {
                                                Result += " | ";
                                            }
                                            Result += RH["Taxon"].ToString();
                                        }
                                        else
                                        {
                                            if (Result.Length > 0)
                                            {
                                                Result = " | " + Result;
                                            }
                                            Result = RH["Taxon"].ToString() + Result;
                                        }
                                    }
                                }
                            }
                            R[3] = Result;
                        }

                        if (R[3].ToString().Length == 0 || R[2].ToString() == R[3].ToString())
                            R.Delete();
                        else if (R[2].ToString().Trim() == R[3].ToString().Trim() && R[2].ToString().Length < R[3].ToString().Length)
                        {
                            R.Delete();
                        }
                        if (this.progressBarSynColTaxFamOrdDatabase.Value < this.progressBarSynColTaxFamOrdDatabase.Maximum)
                            this.progressBarSynColTaxFamOrdDatabase.Value++;
                    }
                    if (RowsToRemove.Count > 0)
                    {
                        foreach (System.Data.DataRow R in RowsToRemove)
                            R.Delete();
                        this._dtSynColTaxHierarchy.AcceptChanges();
                    }
                    //C.CommandText = SqlCount;
                    string TotalCount = "";
                    try
                    {
                        int i;
                        if (int.TryParse(DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SqlCount).ToString(), out i))
                            TotalCount = i.ToString();
                    }
                    catch (System.Exception ex)
                    {
                    }
                    conDTN.Close();
                    conDTN.Dispose();
                    this._dtSynColTaxHierarchy.AcceptChanges();

                    this.dataGridViewSynColTaxFamOrd.DataSource = this._dtSynColTaxHierarchy;
                    if (this._dtSynColTaxHierarchy.Rows.Count > 0)
                    {
                        this.labelSynColTaxFamOrdCheck.Text = this._dtSynColTaxHierarchy.Rows.Count.ToString() + " differences found";
                        this.buttonSynColTaxFamOrdUpdate.Enabled = true;
                    }
                    else
                    {
                        this.labelSynColTaxFamOrdCheck.Text = "No differences found";
                        if (this.checkBoxSynColTaxFamOrdMaxRecords.Visible && this.checkBoxSynColTaxFamOrdMaxRecords.Checked)
                            this.labelSynColTaxFamOrdCheck.Text += "; Tested number: " + this.numericUpDownSynColTaxFamOrdMaxRecords.Value.ToString();
                        this.buttonSynColTaxFamOrdUpdate.Enabled = false;
                    }
                    if (this.dataGridViewSynColTaxFamOrd.ColumnCount > 0 && setColumnWidth)
                    {
                        this.dataGridViewSynColTaxFamOrd.Columns[0].Width = (int)this.dataGridViewSynColTaxFamOrd.Width * 3 / 8;
                    }
                    if (TotalCount.Length > 0)
                        this.labelSynColTaxFamOrdCheck.Text += "; Total count: " + TotalCount;
                }
                catch (System.Exception ex)
                {
                    System.Windows.Forms.MessageBox.Show(ex.Message);
                }
            }
            else
            {
                if (isTaxWebService(this.comboBoxSynColTaxFamOrdDatabase.Text))
                {
                    this.dataGridViewSynColTaxFamOrd.DataSource = null;

                    DwbServiceEnums.DwbService currentDwbService =
                        getCurrentService(this.comboBoxSynColTaxDatabase.Text);
                    IDwbWebservice<DwbSearchResult, DwbSearchResultItem, DwbEntity> _api =
                        DwbServiceProviderAccessor.GetDwbWebservice(currentDwbService);
                    if (_api == null)
                        return;
                    var serviceTypeNameDictionary = DwbServiceEnums.TaxonomicServiceInfoDictionary();
                    string Webservice = "";
                    if (serviceTypeNameDictionary.TryGetValue(_api.GetServiceName(), out var serviceTypeInfo))
                    {
                        Webservice = serviceTypeInfo?.Name ?? string.Empty; 
                    }

                    string FamilyColumn = "Family";
                    string OrderColum = "Order";
                    string HierarchyColumn = "Hierarchy";
                    string URI = "";
                    
                    this._dtSynColTaxHierarchy = new DataTable();
                    int iDifference = 0;
                    this.progressBarSynColTaxFamOrdDatabase.Visible = true;
                    this.progressBarSynColTaxFamOrdDatabase.Value = 0;
                    SQL = "SELECT ";
                    if (!this.checkBoxSynColTaxFamOrdIncludeAccNr.Checked) SQL += " DISTINCT ";
                    SQL += " CAST(0 as bit) AS OK, U.LastIdentificationCache, ";
                    if (this.radioButtonFamily.Checked) SQL += "U.FamilyCache, '' AS [Family from " + Webservice + "] ";
                    else if (this.radioButtonOrder.Checked) SQL += "U.OrderCache, '' AS [Order from " + Webservice + "] ";
                    else if (this.radioButtonHierarchy.Checked) SQL += "U.HierarchyCache, '' AS [Hierarchy from " + Webservice + "] ";
                    SQL += ", I.NameURI ";
                    if (this.checkBoxSynColTaxFamOrdIncludeAccNr.Checked) SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";
                    SQL += this.SqlFromClauseSynColTaxFamOrd() + " ORDER BY U.LastIdentificationCache ";
                    Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, con);
                    ad.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                    try
                    {
                        ad.Fill(this._dtSynColTaxHierarchy);
                        this.progressBarSynColTaxFamOrdDatabase.Maximum = this._dtSynColTaxHierarchy.Rows.Count;
                        this.dataGridViewSynColTaxFamOrd.DataSource = this._dtSynColTaxHierarchy;
                        if (this._dtSynColTaxHierarchy.Rows.Count > 0)
                        {
                            this.labelSynColTaxFamOrdCheck.Text = this._dtSynColTaxHierarchy.Rows.Count.ToString() + " differences found";
                            this.buttonSynColTaxFamOrdUpdate.Enabled = true;
                        }
                        else
                        {
                            this.labelSynColTaxFamOrdCheck.Text = "No differences found";
                            this.buttonSynColTaxFamOrdUpdate.Enabled = false;
                        }
                        if (this.dataGridViewSynColTaxFamOrd.ColumnCount > 0 && setColumnWidth)
                        {
                            this.dataGridViewSynColTaxFamOrd.Columns[0].Width = (int)this.dataGridViewSynColTaxFamOrd.Width * 3 / 8;
                        }
                        if (this._dtSynColTaxHierarchy.Rows.Count > 0)
                        {
                            foreach (System.Data.DataRow R in this._dtSynColTaxHierarchy.Rows)
                            {
                                System.Data.DataTable dtResult = new DataTable();
                                System.Data.DataRow Rname = dtResult.NewRow();
                                dtResult.Rows.Add(Rname);
                                string nameUri = R["NameURI"]?.ToString();
                                if (!_api.IsValidUrl(nameUri))
                                {
                                    MessageBox.Show("The selected value is not a valid URI or unit ID.",
                                        "Invalid Selection",
                                        MessageBoxButtons.OK, MessageBoxIcon.Error);
                                    return;
                                }

                                DwbEntity clientEntity = await getApiDetailModel(_api, nameUri);
                                if (clientEntity == null)
                                    return;
                                ReadDwbDetailModelInQueryTable(clientEntity.GetMappedApiEntityModel(), ref dtResult);

                                if (!dtResult.Columns.Contains("_URI"))
                                {
                                    System.Data.DataColumn C = new DataColumn("_URI", typeof(string));
                                    dtResult.Columns.Add(C);
                                }

                                Rname[0] = URI;
                                if (dtResult.Rows.Count > 0)
                                {
                                    foreach (System.Data.DataColumn DC in dtResult.Columns)
                                    {
                                        if (this.radioButtonFamily.Checked)
                                        {
                                            if (DC.ColumnName == FamilyColumn) // "Family name")
                                            {
                                                if (!dtResult.Rows[0][FamilyColumn].Equals(System.DBNull.Value)
                                                    && dtResult.Rows[0][FamilyColumn].ToString().Length > 0)
                                                {
                                                    R["Family from " + Webservice + ""] =
                                                        dtResult.Rows[0][FamilyColumn];
                                                    if ((R["Family from " + Webservice + ""].ToString() !=
                                                         R["FamilyCache"].ToString()
                                                         || R["FamilyCache"].Equals(System.DBNull.Value)))
                                                    {
                                                        R["OK"] = 1;
                                                        iDifference++;
                                                    }
                                                }
                                            }
                                        }
                                        else if (this.radioButtonOrder.Checked)
                                        {
                                            if (DC.ColumnName == OrderColum)
                                            {
                                                if (!dtResult.Rows[0][OrderColum].Equals(System.DBNull.Value)
                                                    && dtResult.Rows[0][OrderColum].ToString().Length > 0)
                                                {
                                                    R["Order from " + Webservice] = dtResult.Rows[0][OrderColum];
                                                    if ((R["Order from " + Webservice + ""].ToString() !=
                                                         R["OrderCache"].ToString()
                                                         || R["OrderCache"].Equals(System.DBNull.Value)))
                                                    {
                                                        R["OK"] = 1;
                                                        iDifference++;
                                                    }
                                                }
                                            }
                                        }
                                        else if (this.radioButtonHierarchy.Checked)
                                        {
                                            if (DC.ColumnName == HierarchyColumn)
                                            {
                                                if (!dtResult.Rows[0][HierarchyColumn].Equals(System.DBNull.Value)
                                                    && dtResult.Rows[0][HierarchyColumn].ToString().Length > 0)
                                                {
                                                    R["Hierarchy from " + Webservice + ""] =
                                                        dtResult.Rows[0][HierarchyColumn];
                                                    if ((R["Hierarchy from " + Webservice + ""].ToString() !=
                                                         R["HierarchyCache"].ToString()
                                                         || R["HierarchyCache"].Equals(System.DBNull.Value)))
                                                    {
                                                        R["OK"] = 1;
                                                        iDifference++;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        if (this.progressBarSynColTaxFamOrdDatabase.Value < this.progressBarSynColTaxFamOrdDatabase.Maximum)
                            this.progressBarSynColTaxFamOrdDatabase.Value++;
                    }
                    catch (System.Exception ex)
                    {
                        MessageBox.Show("An error occurred when trying to synchronize with the webservice: " + ex.Message, "SynchronizeError", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                    this.dataGridViewSynColTaxFamOrd.DataSource = this._dtSynColTaxHierarchy;
                    this.dataGridViewSynColTaxFamOrd.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                    this.labelSynColTaxFamOrdCheck.Text = iDifference.ToString() + " differences found";

                }
                else
                    System.Windows.Forms.MessageBox.Show("For\r\n" + this.comboBoxSynColTaxFamOrdDatabase.Text + "\r\navailable in future version");
            }
            try
            {
                this.dataGridViewSynColTaxFamOrd.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.ColumnHeader);
                this.dataGridViewSynColTaxFamOrd.Columns[0].ReadOnly = false;
                this.dataGridViewSynColTaxFamOrd.Columns[1].ReadOnly = true;
                this.dataGridViewSynColTaxFamOrd.Columns[2].ReadOnly = true;
                this.dataGridViewSynColTaxFamOrd.Columns[3].ReadOnly = true;
                this.dataGridViewSynColTaxFamOrd.ReadOnly = false;
            }
            catch (System.Exception ex)
            {
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void checkBoxSynColTaxFamOrdIncludeAccNr_Click(object sender, EventArgs e)
        {
            if (this.checkBoxSynColTaxFamOrdIncludeAccNr.Checked) this.buttonSynColTaxFamOrdCheckDataset.Visible = true;
            else this.buttonSynColTaxFamOrdCheckDataset.Visible = false;
        }

        private void buttonSynColTaxFamOrdCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSynColTaxFamOrd.SelectedRows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewSynColTaxFamOrd.SelectedRows[0];
            bool OK = true;
            try { string test = R.Cells["CollectionSpecimenID"].Value.ToString(); }
            catch { OK = false; }
            if (OK)
            {
                if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
                {
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                else
                    this.DialogResult = DialogResult.Cancel;
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            }
        }

        private string SqlFromClauseSynColTaxFamOrd()
        {
            string SQL = "";
            string BaseURL = "";
            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DataBaseURIs().TryGetValue(this.comboBoxSynColTaxFamOrdDatabase.Text, out BaseURL))
            {
                int TaxProjectID = 0;
                if (this.comboBoxSynColTaxFamOrdTaxonProject.Visible && this.comboBoxSynColTaxFamOrdTaxonProject.SelectedIndex == -1)
                {
                    //System.Windows.Forms.MessageBox.Show("Please select a project");
                    return "";
                }
                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColTaxFamOrdTaxonProject.SelectedItem;
                if (this.comboBoxSynColTaxFamOrdTaxonProject.Visible && !int.TryParse(R["ProjectID"].ToString(), out TaxProjectID))
                    return "";

                string HierarchyList = "";
                if (this.radioButtonFamily.Checked)
                    HierarchyList += "HierarchyFamilyList";
                else if (this.radioButtonOrder.Checked)
                    HierarchyList = "HierarchyOrderList";
                else
                    HierarchyList = "HierarchyList";
                string TaxonomicGroup = "";
                System.Data.DataRowView tt = (System.Data.DataRowView)this.comboBoxSynColTaxFamOrdTaxonomicGroup.SelectedItem;
                TaxonomicGroup = tt[0].ToString();
                SQL += " FROM IdentificationUnit AS U INNER JOIN " +
                    "Identification AS I ON U.CollectionSpecimenID = I.CollectionSpecimenID AND  " +
                    "U.IdentificationUnitID = I.IdentificationUnitID AND  " +
                    "U.LastIdentificationCache = I.TaxonomicName INNER JOIN " +
                    "CollectionProject AS P ON U.CollectionSpecimenID = P.CollectionSpecimenID INNER JOIN " +
                    "ProjectList AS PL ON P.ProjectID = PL.ProjectID INNER JOIN " +
                    "CollectionSpecimen AS S ON U.CollectionSpecimenID = S.CollectionSpecimenID AND  " +
                    "P.CollectionSpecimenID = S.CollectionSpecimenID " +
                    "WHERE (U.TaxonomicGroup = N'" + TaxonomicGroup + "') " +
                    "AND I.NameURI LIKE '" + BaseURL + "%' "; // +
                if (this.radioButtonHierarchy.Checked && this.textBoxTaxonHierarchyRestriction.Text.Length > 0)
                    SQL += " AND U.HierarchyCache LIKE '" + this.textBoxTaxonHierarchyRestriction.Text + "%'" ;
                if (this.checkBoxSynColTaxFamOrdEmpty.Checked)
                {
                    SQL += " AND U.";
                    if (this.radioButtonFamily.Checked)
                        SQL += "FamilyCache";
                    else if (this.radioButtonOrder.Checked)
                        SQL += "OrderCache";
                    else
                        SQL += "HierarchyCache";
                    SQL += " IS NULL ";
                }
                if (this.textBoxSynColTaxTaxonRestriction.Text.Length > 0)
                {
                    SQL += " AND U.LastIdentificationCache LIKE '" + this.textBoxSynColTaxTaxonRestriction.Text + "%' ";
                }

                if (this.comboBoxSynColTaxFamOrdProject.SelectedIndex > 0)
                {
                    int ProjectID = 0;
                    if (this.comboBoxSynColTaxFamOrdProject.SelectedItem != null)
                    {
                        System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColTaxFamOrdProject.SelectedItem;
                        if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                            SQL += " AND P.ProjectID = " + ProjectID.ToString();
                    }
                }
            }
            else
            {
                try { 
                DwbServiceEnums.DwbService currentDwbService =
                    getCurrentService(this.comboBoxSynColTaxFamOrdDatabase.SelectedItem.ToString());
                IDwbWebservice<DwbSearchResult, DwbSearchResultItem, DwbEntity> _api =
                    DwbServiceProviderAccessor.GetDwbWebservice(currentDwbService);
                BaseURL = _api?.GetBaseAddress() ?? string.Empty;

                if (_api != null) {
                    SQL += " FROM IdentificationUnit AS U INNER JOIN " +
                    "Identification AS I ON U.CollectionSpecimenID = I.CollectionSpecimenID AND  " +
                    "U.IdentificationUnitID = I.IdentificationUnitID AND  " +
                    "U.LastIdentificationCache = I.TaxonomicName INNER JOIN " +
                    "CollectionProject AS P ON U.CollectionSpecimenID = P.CollectionSpecimenID INNER JOIN " +
                    "ProjectList AS PL ON P.ProjectID = PL.ProjectID INNER JOIN " +
                    "CollectionSpecimen AS S ON U.CollectionSpecimenID = S.CollectionSpecimenID AND  " +
                    "P.CollectionSpecimenID = S.CollectionSpecimenID " +
                    "WHERE (U.TaxonomicGroup = N'" + this.comboBoxSynColTaxFamOrdTaxonomicGroup.Text + "') " +
                    "AND I.NameURI LIKE '" + BaseURL + "%' ";

                    if (this.comboBoxSynColTaxFamOrdProject.SelectedIndex > -1)
                    {
                        int ProjectID = 0;
                        if (this.comboBoxSynColTaxFamOrdProject.SelectedItem != null)
                        {
                            System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColTaxFamOrdProject.SelectedItem;
                            if (int.TryParse(R["ProjectID"].ToString(), out ProjectID))
                                SQL += " AND P.ProjectID = " + ProjectID.ToString();
                        }
                        //if (!int.TryParse(this.comboBoxSynColTaxFamOrdProject.SelectedValue.ToString(), out ProjectID))
                        //    SQL += "";
                        //else
                        //    SQL += " AND P.ProjectID = " + ProjectID.ToString();
                    }
				}
                }
                catch (System.Exception ex)
                {
                    MessageBox.Show("An error occurred: " + ex.Message);
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
            return SQL;
        }

        private void comboBoxSynColTaxFamOrdTaxonProject_DropDown(object sender, EventArgs e)
        {
            try
            {
                if (this.comboBoxSynColTaxFamOrdDatabase.SelectedItem == null)
                {
                    MessageBox.Show("No Database or Service was selected.");
                    return;
                } 
                string SelectedDatabase = this.comboBoxSynColTaxFamOrdDatabase.SelectedItem.ToString();
                string ConnectionString = DiversityWorkbench.Settings.ConnectionString;
                string Database = this.comboBoxSynColTaxFamOrdDatabase.Text;
                string LinkedServer = "";
                foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnections())
                {
                    if (KV.Value.DisplayText == SelectedDatabase)
                    {
                        ConnectionString = KV.Value.ConnectionString;
                        Database = KV.Value.DatabaseName;
                        LinkedServer = KV.Value.LinkedServer;
                    }
                }
                string Prefix = Database + ".dbo.";
                if (LinkedServer.Length > 0)
                    Prefix = "[" + LinkedServer + "]." + Prefix;
                System.Data.DataTable dt = new DataTable();
                string SQL = "/*SELECT NULL AS ProjectID, NULL AS Project " +
                    "UNION */" +
                    "SELECT ProjectID, Project " +
                    "FROM " + Prefix + "ProjectList " +
                    "ORDER BY Project";
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, ConnectionString);
                ad.Fill(dt);
                this.comboBoxSynColTaxFamOrdTaxonProject.DataSource = dt;
                this.comboBoxSynColTaxFamOrdTaxonProject.DisplayMember = "Project";
                this.comboBoxSynColTaxFamOrdTaxonProject.ValueMember = "ProjectID";
            }
            catch
            {
            }
        }

        private void comboBoxSynColTaxFamOrdDatabase_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.labelSynColTaxFamOrdDatabase.Text = "Taxonomy database:";
            string x = this.comboBoxSynColTaxFamOrdDatabase.SelectedItem.ToString();
            if (x.StartsWith("DiversityTaxonNames") || x.IndexOf("].DiversityTaxonNames") > -1)
            {
                //this.panelSynColTaxFamOrdMaxRecords.Visible = false;
                this.labelSynColTaxFamOrdTaxonProject.Visible = true;
                this.comboBoxSynColTaxFamOrdTaxonProject.Visible = true;
                this.radioButtonHierarchy.Enabled = true;
            }
            else
            {
                this.panelSynColTaxFamOrdMaxRecords.Visible = true;
                this.labelSynColTaxFamOrdTaxonProject.Visible = false;
                this.comboBoxSynColTaxFamOrdTaxonProject.Visible = false;
                // Ariane Hierarchy always enabled for webservices? 
                //if (x == "CatalogueOfLife")
                //    this.radioButtonHierarchy.Enabled = true;
                //else
                //    this.radioButtonHierarchy.Enabled = false;
                if (x.IndexOf("].DiversityTaxonNames_") > -1)
                    this.labelSynColTaxFamOrdDatabase.Text += "  " + x.Substring(x.IndexOf("].DiversityTaxonNames_") + "].DiversityTaxonNames_".Length);
                //System.Windows.Forms.MessageBox.Show("For external webservies this function will be available in a future version");
            }
        }

        private void buttonSynColTaxFamOrdCheckAll_Click(object sender, EventArgs e)
        {
            // #173
            if (this._dtSynColTaxHierarchy != null && this._dtSynColTaxHierarchy.Rows.Count > 0)
                foreach (System.Data.DataRow R in this._dtSynColTaxHierarchy.Rows)
                    R[0] = true;
            else System.Windows.Forms.MessageBox.Show("Nothing to check");
        }

        private void buttonSynColTaxFamOrdCheckNone_Click(object sender, EventArgs e)
        {
            // #173
            if (this._dtSynColTaxHierarchy != null && this._dtSynColTaxHierarchy.Rows.Count > 0)
                foreach (System.Data.DataRow R in this._dtSynColTaxHierarchy.Rows)
                R[0] = false;
            else System.Windows.Forms.MessageBox.Show("Nothing to uncheck");
        }

        private void buttonSynColTaxFamOrdUpdate_Click(object sender, EventArgs e)
        {
            string Message = "";
            if (isTaxWebService(this.comboBoxSynColTaxFamOrdDatabase.Text))
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                this.progressBarSynColTaxFamOrdDatabase.Visible = true;
                this.progressBarSynColTaxFamOrdDatabase.Value = 0;
                this.progressBarSynColTaxFamOrdDatabase.Maximum = this._dtSynColTaxHierarchy.Rows.Count;
                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand("", con);
                try
                {
                    con.Open();
                    foreach (System.Data.DataRow R in this._dtSynColTaxHierarchy.Rows)
                    {
                        bool OK = false;
                        if (bool.TryParse(R["OK"].ToString(), out OK) && OK)
                        {
                            string SQL = "UPDATE U SET ";
                            string NewValue = R[3].ToString();
                            if (this.radioButtonFamily.Checked) SQL += "U.FamilyCache = N'" + NewValue + "'";
                            else if (this.radioButtonOrder.Checked) SQL += "U.OrderCache = N'" + NewValue + "'";
                            else if (this.radioButtonHierarchy.Checked) SQL += "U.HierarchyCache = N'" + NewValue + "'";
                            SQL += this.SqlFromClauseSynColTaxFamOrd();
                            SQL += " AND I.NameURI = '" + R["NameURI"] + "'";
                            try
                            {
                                C.CommandText = SQL;
                                C.ExecuteNonQuery();
                            }
                            catch (Exception ex)
                            {
                                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                                Message += ex.Message + "\r\n";
                            }
                            finally
                            {
                            }
                        }
                        if (this.progressBarSynColTaxFamOrdDatabase.Value < this.progressBarSynColTaxFamOrdDatabase.Maximum)
                            this.progressBarSynColTaxFamOrdDatabase.Value++;
                    }
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    Message += ex.Message + "\r\n";
                }
                finally
                {
                    con.Close();
                }
                this.dataGridViewSynColTaxFamOrd.DataSource = null;
                System.Windows.Forms.MessageBox.Show("Update finished");
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
            else
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand("", con);
                con.Open();
                this.progressBarSynColTaxFamOrdDatabase.Value = 0;
                this.progressBarSynColTaxFamOrdDatabase.Maximum = this._dtSynColTaxHierarchy.Rows.Count;
                foreach (System.Data.DataRow R in this._dtSynColTaxHierarchy.Rows)
                {
                    bool OK = false;
                    if (bool.TryParse(R["OK"].ToString(), out OK) && OK)
                    {
                        string SQL = "UPDATE U SET ";
                        if (this.radioButtonFamily.Checked)
                            SQL += "U.FamilyCache = N'" + R["Family in DiversityTaxonNames"].ToString().Replace("'", "''") + "'";
                        else if (this.radioButtonOrder.Checked)
                            SQL += "U.OrderCache = N'" + R["Order in DiversityTaxonNames"].ToString().Replace("'", "''") + "'";
                        else
                            SQL += "U.HierarchyCache = N'" + R["Hierarchy in DiversityTaxonNames"].ToString().Replace("'", "''") + "'";
                        SQL += this.SqlFromClauseSynColTaxFamOrd();
                        SQL += " AND U.LastIdentificationCache = N'" + R["Last identification in DiversityCollection"].ToString().Replace("'", "''") + "'";
                        //SQL += " AND U.FamilyCache = '" + R["Family in DiversityCollection"] + "'";
                        SQL += " AND I.NameURI = '" + R[4].ToString() + "'";
                        //SQL += " AND I.NameURI = '" + R["NameURI"] + "'";
                        try
                        {
                            C.CommandText = SQL;
                            C.ExecuteNonQuery();
                        }
                        catch (Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                            Message += ex.Message + "\r\n";
                        }
                        finally
                        {
                        }
                    }
                    if (this.progressBarSynColTaxFamOrdDatabase.Value < this.progressBarSynColTaxFamOrdDatabase.Maximum)
                        this.progressBarSynColTaxFamOrdDatabase.Value++;
                }
                con.Close();
                con.Dispose();
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
            if (Message.Length > 0)
            {
                System.Windows.Forms.MessageBox.Show("Update failed:\r\n\r\n" + Message);
            }
            else
                System.Windows.Forms.MessageBox.Show("Update finished");
            this.dataGridViewSynColTaxFamOrd.DataSource = null;
        }

        private void radioButtonHierarchy_CheckedChanged(object sender, EventArgs e)
        {
            this.panelTaxonHierarchyType.Visible = this.radioButtonHierarchy.Checked;
            this.tableLayoutPanelTaxonHierarchy.Visible = this.radioButtonHierarchy.Checked;
            //if (this.radioButtonHierarchy.Checked)
            //{
            //    this.panelTaxonHierarchyType.Visible = true;
            //}
            //else
            //    this.panelTaxonHierarchyType.Visible = false;
        }

        #endregion

        #region Synchronize within DiversityCollection
        /*
        SELECT     IdentificationUnit.LastIdentificationCache, IdentificationUnit_1.FamilyCache AS Family, IdentificationUnit_1.OrderCache AS [Order], 
        IdentificationUnit.TaxonomicGroup, ProjectList.Project, CollectionSpecimen.AccessionNumber, IdentificationUnit.CollectionSpecimenID
        FROM         IdentificationUnit INNER JOIN
        CollectionProject ON IdentificationUnit.CollectionSpecimenID = CollectionProject.CollectionSpecimenID INNER JOIN
        IdentificationUnit AS IdentificationUnit_1 ON IdentificationUnit.TaxonomicGroup = IdentificationUnit_1.TaxonomicGroup AND 
        SUBSTRING(IdentificationUnit.LastIdentificationCache, 1, CHARINDEX(' ', IdentificationUnit.LastIdentificationCache)) 
        = SUBSTRING(IdentificationUnit_1.LastIdentificationCache, 1, CHARINDEX(' ', IdentificationUnit_1.LastIdentificationCache)) INNER JOIN
        CollectionSpecimen ON IdentificationUnit.CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID AND 
        CollectionProject.CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID INNER JOIN
        ProjectList ON CollectionProject.ProjectID = ProjectList.ProjectID
        WHERE     (IdentificationUnit.FamilyCache IS NULL) AND (IdentificationUnit.OrderCache IS NULL) AND (CHARINDEX(' ', IdentificationUnit.LastIdentificationCache) 
        > 1) AND (NOT (IdentificationUnit_1.FamilyCache IS NULL)) AND (NOT (IdentificationUnit_1.OrderCache IS NULL)) AND 
        (NOT (IdentificationUnit.LastIdentificationCache IS NULL))
        ORDER BY IdentificationUnit.LastIdentificationCache, Family
        AND (CollectionProject.ProjectID = 600)


        SELECT     IdentificationUnit.LastIdentificationCache, IdentificationUnit_1.FamilyCache AS Family, IdentificationUnit_1.OrderCache AS [Order], 
        IdentificationUnit.TaxonomicGroup, ProjectList.Project
        FROM         IdentificationUnit INNER JOIN
        CollectionProject ON IdentificationUnit.CollectionSpecimenID = CollectionProject.CollectionSpecimenID INNER JOIN
        IdentificationUnit AS IdentificationUnit_1 ON IdentificationUnit.TaxonomicGroup = IdentificationUnit_1.TaxonomicGroup AND 
        SUBSTRING(IdentificationUnit.LastIdentificationCache, 1, CHARINDEX(' ', IdentificationUnit.LastIdentificationCache)) 
        = SUBSTRING(IdentificationUnit_1.LastIdentificationCache, 1, CHARINDEX(' ', IdentificationUnit_1.LastIdentificationCache)) INNER JOIN
        ProjectList ON CollectionProject.ProjectID = ProjectList.ProjectID
        WHERE     (IdentificationUnit.FamilyCache IS NULL) AND (IdentificationUnit.OrderCache IS NULL)
        GROUP BY IdentificationUnit.TaxonomicGroup, IdentificationUnit.LastIdentificationCache, IdentificationUnit_1.FamilyCache, IdentificationUnit_1.OrderCache, 
        ProjectList.Project
        HAVING      (CHARINDEX(' ', IdentificationUnit.LastIdentificationCache) > 1) AND (NOT (IdentificationUnit_1.FamilyCache IS NULL)) AND 
        (NOT (IdentificationUnit_1.OrderCache IS NULL)) AND (NOT (IdentificationUnit.LastIdentificationCache IS NULL))
        ORDER BY IdentificationUnit.LastIdentificationCache, Family

        
        SELECT     IdentificationUnit.LastIdentificationCache, IdentificationUnit_1.FamilyCache AS Family, IdentificationUnit_1.OrderCache AS [Order], 
        IdentificationUnit.TaxonomicGroup
        FROM         IdentificationUnit INNER JOIN
        IdentificationUnit AS IdentificationUnit_1 ON IdentificationUnit.TaxonomicGroup = IdentificationUnit_1.TaxonomicGroup AND 
        SUBSTRING(IdentificationUnit.LastIdentificationCache, 1, CHARINDEX(' ', IdentificationUnit.LastIdentificationCache)) 
        = SUBSTRING(IdentificationUnit_1.LastIdentificationCache, 1, CHARINDEX(' ', IdentificationUnit_1.LastIdentificationCache)) INNER JOIN
        CollectionProject ON IdentificationUnit.CollectionSpecimenID = CollectionProject.CollectionSpecimenID INNER JOIN
        ProjectList ON CollectionProject.ProjectID = ProjectList.ProjectID
        WHERE     (IdentificationUnit.FamilyCache IS NULL) AND (IdentificationUnit.OrderCache IS NULL)
        GROUP BY IdentificationUnit.TaxonomicGroup, IdentificationUnit.LastIdentificationCache, IdentificationUnit_1.FamilyCache, 
        IdentificationUnit_1.OrderCache
        HAVING      (CHARINDEX(' ', IdentificationUnit.LastIdentificationCache) > 1) AND (NOT (IdentificationUnit_1.FamilyCache IS NULL)) AND 
        (NOT (IdentificationUnit_1.OrderCache IS NULL)) AND (NOT (IdentificationUnit.LastIdentificationCache IS NULL))
        ORDER BY IdentificationUnit.LastIdentificationCache, Family
         * */
        private void checkBoxSynFamOrdIncludeAccNr_Click(object sender, EventArgs e)
        {
            if (this.checkBoxSynFamOrdIncludeAccNr.Checked) this.buttonSynFamOrdCheckDataset.Visible = true;
            else this.buttonSynFamOrdCheckDataset.Visible = false;
        }

        private void buttonSynFamOrdCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSynFamOrd.SelectedRows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewSynFamOrd.SelectedRows[0];
            bool OK = true;
            try { string test = R.Cells["CollectionSpecimenID"].Value.ToString(); }
            catch { OK = false; }
            if (OK)
            {
                if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
                {
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                else
                    this.DialogResult = DialogResult.Cancel;
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            }
        }

        private void buttonSynFamOrdCheck_Click(object sender, EventArgs e)
        {
            string Target = "Family";
            if (this.radioButtonSynFamOrdOrder.Checked)
                Target = "Order";
            string UnitTableToUpdate = "U";
            string UnitTableSource = "S";
            System.Data.DataTable _dtFamOrd = new DataTable();
            bool setColumnWidth = true;
            if (this.dataGridViewSynFamOrd.ColumnCount > 1) setColumnWidth = false;
            string SQL = "SELECT DISTINCT ";
            SQL += UnitTableToUpdate + ".LastIdentificationCache, ";
            if (Target == "Family") SQL += UnitTableSource + ".FamilyCache AS Family, ";
            else SQL += UnitTableSource + ".OrderCache AS [Order], ";
            SQL += UnitTableSource + ".TaxonomicGroup ";
            if (this.comboBoxSynFamOrdProject.SelectedIndex == 0) SQL += ", ProjectList.Project";
            if (this.checkBoxSynFamOrdIncludeAccNr.Checked) SQL += ", CollectionSpecimen.AccessionNumber, " + UnitTableToUpdate + ".CollectionSpecimenID ";
            SQL += this.SqlFromClauseSynFamOrd(Target, UnitTableToUpdate, UnitTableSource);
            SQL += " ORDER BY " + UnitTableToUpdate + ".LastIdentificationCache, [" + Target + "]";
            Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            ad.Fill(_dtFamOrd);
            this.dataGridViewSynFamOrd.DataSource = _dtFamOrd;
            if (_dtFamOrd.Rows.Count > 0)
            {
                this.labelSynFamOrdCheck.Text = _dtFamOrd.Rows.Count.ToString() + " differences found";
                this.buttonSynFamOrdUpdate.Enabled = true;
            }
            else
            {
                this.labelSynFamOrdCheck.Text = "No differences found";
                this.buttonSynFamOrdUpdate.Enabled = false;
            }
            if (this.dataGridViewSynFamOrd.ColumnCount > 0 && setColumnWidth)
            {
                this.dataGridViewSynFamOrd.Columns[0].Width = (int)this.dataGridViewSynFamOrd.Width * 3 / 8;
            }
        }

        private void buttonSynFamOrdUpdate_Click(object sender, EventArgs e)
        {
            string Target = "Family";
            if (this.radioButtonSynFamOrdOrder.Checked)
                Target = "Order";
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            string SQL = "UPDATE U SET ";
            if (Target == "Family") SQL += " U.FamilyCache = S.FamilyCache ";
            else SQL += " U.OrderCache = S.OrderCache ";
            SQL += this.SqlFromClauseSynFamOrd(Target, "U", "S");
            Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
            try
            {
                con.Open();
                string Message = C.ExecuteScalar()?.ToString();
                System.Windows.Forms.MessageBox.Show(Message);
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
                con.Close();
            }
        }

        private string SqlFromClauseSynFamOrd(string Target, string TableForUpdate, string TableSource)
        {

            string SQL = "";
            //string BaseURL = "";
            //string SqlOrder = "";
            SQL += " FROM IdentificationUnit AS " + TableForUpdate + " INNER JOIN " +
            "CollectionProject ON " + TableForUpdate + ".CollectionSpecimenID = CollectionProject.CollectionSpecimenID INNER JOIN " +
            "IdentificationUnit AS " + TableSource + " ON " + TableForUpdate + ".TaxonomicGroup = " + TableSource + ".TaxonomicGroup AND  " +
            "SUBSTRING(" + TableForUpdate + ".LastIdentificationCache, 1, CHARINDEX(' ', " + TableForUpdate + ".LastIdentificationCache))  " +
            "= SUBSTRING(" + TableSource + ".LastIdentificationCache, 1, CHARINDEX(' ', " + TableSource + ".LastIdentificationCache)) INNER JOIN " +
            "CollectionSpecimen ON " + TableForUpdate + ".CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID AND  " +
            "CollectionProject.CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID INNER JOIN " +
            "ProjectList ON CollectionProject.ProjectID = ProjectList.ProjectID " +
            "WHERE (NOT (" + TableForUpdate + ".LastIdentificationCache IS NULL)) ";
            if (Target == "Family")
                SQL += " AND (" + TableForUpdate + ".FamilyCache IS NULL) AND (" + TableSource + ".FamilyCache <> '') ";
            else
                SQL += " AND (" + TableForUpdate + ".OrderCache IS NULL)  AND (" + TableSource + ".OrderCache <> '') ";
            SQL += " AND (CHARINDEX(' ', " + TableForUpdate + ".LastIdentificationCache) > 1) ";
            if (this.comboBoxSynFamOrdProject.SelectedIndex > -1)
            {
                int ProjectID = 0;
                if (this.comboBoxSynFamOrdProject.SelectedItem != null)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynFamOrdProject.SelectedItem;
                    if (int.TryParse(R["ProjectID"].ToString(), out ProjectID))
                        SQL += " AND CollectionProject.ProjectID = " + ProjectID.ToString();
                }
                //if (!int.TryParse(this.comboBoxSynFamOrdProject.SelectedValue.ToString(), out ProjectID))
                //    SQL += "";
                //else
                //    SQL += " AND CollectionProject.ProjectID = " + ProjectID.ToString();
            }
            //else 
            //    SQL += 
            if (this.comboBoxSynFamOrdTaxonomicGroup.Text.Length > 0)
                SQL += " AND " + TableForUpdate + ".TaxonomicGroup = '" + this.comboBoxSynFamOrdTaxonomicGroup.Text + "'";

            return SQL;
        }

        #endregion

        #endregion

        #region Remove wrong NameURI

        private void buttonRemoveNameURICheckDataset_Click(object sender, EventArgs e)
        {

        }

        private void buttonRemoveNameURISelectAll_Click(object sender, EventArgs e)
        {

        }

        private void buttonRemoveNameURIStartSearch_Click(object sender, EventArgs e)
        {

        }

        private void buttonRemoveNameURISelectNone_Click(object sender, EventArgs e)
        {

        }

        private void buttonRemoveNameURIStartUpdate_Click(object sender, EventArgs e)
        {

        }

        private void comboBoxRemoveNameURITaxonDB_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.labelRemoveNameURITaxonDB.Text = "Taxonomy database:";
            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DatabaseList().Contains(comboBoxRemoveNameURITaxonDB.SelectedItem.ToString()))
            {
                this.labelRemoveNameURITaxonomicGroup.Visible = false;
                this.comboBoxRemoveNameURITaxonomicGroup.Visible = false;
                if (comboBoxRemoveNameURITaxonDB.Text.IndexOf("].DiversityTaxonNames_") > -1)
                {
                    this.labelRemoveNameURITaxonDB.Text += "  " + comboBoxRemoveNameURITaxonDB.Text.Substring(comboBoxRemoveNameURITaxonDB.Text.IndexOf("].DiversityTaxonNames_") + "].DiversityTaxonNames_".Length);
                }
            }
            else
            {
                this.labelRemoveNameURITaxonomicGroup.Visible = true;
                this.comboBoxRemoveNameURITaxonomicGroup.Visible = true;
                if (comboBoxRemoveNameURITaxonDB.Text.IndexOf("].DiversityTaxonNames_") > -1)
                {
                    this.labelRemoveNameURITaxonDB.Text += "  " + comboBoxRemoveNameURITaxonDB.Text.Substring(comboBoxRemoveNameURITaxonDB.Text.IndexOf("].DiversityTaxonNames_") + "].DiversityTaxonNames_".Length);
                }
            }
            DiversityWorkbench.DatabaseService x = new DiversityWorkbench.DatabaseService(comboBoxRemoveNameURITaxonDB.SelectedItem.ToString());
            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DatabaseServices().Contains(x))
            {
                this.comboBoxRemoveNameURITaxonProject.Visible = true;
                this.labelRemoveNameURITaxonProject.Visible = true;
            }
            else
            {
                this.comboBoxRemoveNameURITaxonProject.Visible = false;
                this.labelRemoveNameURITaxonProject.Visible = false;
                this.comboBoxRemoveNameURITaxonProject.SelectedIndex = -1;
            }
        }

        private void checkBoxRemoveNameURIIncludeAccNr_Click(object sender, EventArgs e)
        {

        }

        private void comboBoxRemoveNameURITaxonProject_DropDown(object sender, EventArgs e)
        {

        }

        #endregion

        #endregion

        #region Exsiccata

        private void comboBoxSynColExsDB_SelectionChangeCommitted(object sender, EventArgs e)
        {
            string DB = this.comboBoxSynColExsDB.SelectedItem.ToString();
            DiversityWorkbench.ServerConnection S = null;
            foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityExsiccatae"].ServerConnections())
            {
                if (KV.Value.DisplayText == DB)
                {
                    S = KV.Value;
                    break;
                }
            }
            if (S != null)
            {
                this._PrefixDB_ExsDB = "";
                if (S.LinkedServer.Length > 0)
                    this._PrefixDB_ExsDB = "[" + S.LinkedServer + "].";
                this._PrefixDB_ExsDB += S.DatabaseName + ".dbo.";
                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                string SQL = "SELECT BaseURL FROM " + this._PrefixDB_ExsDB + "ViewBaseURL";
                try
                {
                    con.Open();
                    Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                    this._BaseURL_ExsDB = C.ExecuteScalar()?.ToString() ?? string.Empty;
                }
                catch (System.Exception ex)
                {
                    System.Windows.Forms.MessageBox.Show("The selected database needs to be updated. Please turn to your administrator");
                    this._BaseURL_ExsDB = "";
                    return;
                };
            }
            else
                this._PrefixDB_ExsDB = "";
        }

        private void comboBoxSynColExsDB_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.labelSynColExsDB.Text = "Database:";
            DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityExsiccatae"].ServerConnectionList()[this.comboBoxSynColExsDB.SelectedItem.ToString()];
            if (SC.LinkedServer.Length > 0)
                this.labelSynColExsDB.Text += SC.DatabaseName;
        }

        private string _PrefixDB_ExsDB = "";
        private string _BaseURL_ExsDB = "";

        private void buttonSynColExsCheck_Click(object sender, EventArgs e)
        {
            try
            {
                if (this._PrefixDB_ExsDB.Length > 0 && this._BaseURL_ExsDB.Length > 0)
                {
                    bool setColumnWidth = true;
                    if (this.dataGridViewSynColExs.ColumnCount > 1) setColumnWidth = false;
                    string SQL = "SELECT ";
                    if (!this.checkBoxSynColExsIncludeAccNr.Checked) SQL += " DISTINCT ";
                    SQL += "E.ExsAbbreviation as [ExsAbbreviation in DiversityExsiccatae], " +
                        " S.ExsiccataAbbreviation as [ExsiccataAbbreviation in DiversityCollection]";
                    if (this.checkBoxSynColExsIncludeAccNr.Checked) SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";
                    SQL += " FROM CollectionProject AS P INNER JOIN " + this._PrefixDB_ExsDB + "Exsiccata AS E INNER JOIN " +
                        " CollectionSpecimen AS S ON '" + this._BaseURL_ExsDB +
                        "' + cast(E.ExsiccataID as varchar) = S.ExsiccataURI AND  " +
                        " E.ExsAbbreviation <> S.ExsiccataAbbreviation  ON " +
                        " P.CollectionSpecimenID = S.CollectionSpecimenID ";
                    if (this.comboBoxSynColExsProject.SelectedIndex > -1)
                    {
                        int ProjectID = 0;
                        if (this.comboBoxSynColExsProject.SelectedItem != null)
                        {
                            System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColExsProject.SelectedItem;
                            if (int.TryParse(R["ProjectID"].ToString(), out ProjectID))
                                SQL += " WHERE P.ProjectID = " + ProjectID.ToString();
                            else
                                return;
                        }
                        //if (!int.TryParse(this.comboBoxSynColExsProject.SelectedValue.ToString(), out ProjectID))
                        //    return;
                        //else
                        //    SQL += " WHERE P.ProjectID = " + ProjectID.ToString();
                    }
                    SQL += " ORDER BY E.ExsAbbreviation";

                    if (this._dtSynColExs == null) this._dtSynColExs = new DataTable();
                    else this._dtSynColExs.Clear();
                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(this._dtSynColExs);
                    this.dataGridViewSynColExs.DataSource = this._dtSynColExs;
                    if (this._dtSynColExs.Rows.Count > 0)
                    {
                        this.labelSynColExsCheck.Text = this._dtSynColExs.Rows.Count.ToString() + " differences found";
                        this.buttonSynColExsUpdate.Enabled = true;
                    }
                    else
                    {
                        this.labelSynColExsCheck.Text = "No differences found";
                        this.buttonSynColExsUpdate.Enabled = false;
                    }
                    if (this.dataGridViewSynColTax.ColumnCount > 0 && setColumnWidth)
                    {
                        this.dataGridViewSynColExs.Columns[0].Width = (int)this.dataGridViewSynColExs.Width * 3 / 8;
                        this.dataGridViewSynColExs.Columns[1].Width = (int)this.dataGridViewSynColExs.Width * 3 / 8;
                    }
                    this.dataGridViewSynColExs.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);

                }
                else
                {
                    System.Windows.Forms.MessageBox.Show("No valid database selected");
                }







                //string DB = this.comboBoxSynColExsDB.SelectedItem.ToString();// = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseList();
                //string ConnectionString = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityExsiccatae"].ServerConnectionList()[DB].ConnectionString;
                //Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(ConnectionString);
                //con.Open();
                //string SQL = "SELECT dbo.BaseURL()";
                //string BaseURL = "";
                //try
                //{
                //    Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                //    BaseURL = C.ExecuteScalar()?.ToString();
                //}
                //catch { }

                //bool setColumnWidth = true;
                //if (this.dataGridViewSynColExs.ColumnCount > 1) setColumnWidth = false;
                //string SqlOrderBy = "";
                //SQL = "SELECT ";
                //if (!this.checkBoxSynColExsIncludeAccNr.Checked) SQL += " DISTINCT ";
                //SQL += "DiversityExsiccatae.dbo.Exsiccata.ExsAbbreviation as [ExsAbbreviation in DiversityExsiccatae], " +
                //    " CollectionSpecimen.ExsiccataAbbreviation as [ExsiccataAbbreviation in DiversityCollection]";
                //if (this.checkBoxSynColExsIncludeAccNr.Checked) SQL += ", CollectionSpecimen.AccessionNumber, CollectionSpecimen.CollectionSpecimenID ";
                //SQL += " FROM  CollectionProject P INNER JOIN DiversityExsiccatae.dbo.Exsiccata INNER JOIN " +
                //    " CollectionSpecimen ON DiversityExsiccatae.dbo.BaseURL()  " +
                //    "+ cast(DiversityExsiccatae.dbo.Exsiccata.ExsiccataID as varchar) = CollectionSpecimen.ExsiccataURI AND  " +
                //    " DiversityExsiccatae.dbo.Exsiccata.ExsAbbreviation <> CollectionSpecimen.ExsiccataAbbreviation  ON " +
                //    " CollectionProject.CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID " +
                //    " WHERE ";

                //SqlOrderBy = " ORDER BY DiversityExsiccatae.dbo.Exsiccata.ExsAbbreviation";
                //if (this.comboBoxSynColExsProject.SelectedIndex > 0)
                //{
                //    int ProjectID = 0;
                //    if (!int.TryParse(this.comboBoxSynColExsProject.SelectedValue.ToString(), out ProjectID))
                //        return;
                //    else
                //        SQL += " WHERE CollectionProject.ProjectID = " + ProjectID.ToString();
                //}
                //SQL += SqlOrderBy;
                //if (this._dtSynColExs == null) this._dtSynColExs = new DataTable();
                //else this._dtSynColExs.Clear();
                //Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                //ad.Fill(this._dtSynColExs);
                //this.dataGridViewSynColExs.DataSource = this._dtSynColExs;
                //if (this._dtSynColExs.Rows.Count > 0)
                //{
                //    this.labelSynColExsCheck.Text = this._dtSynColExs.Rows.Count.ToString() + " differences found";
                //    this.buttonSynColExsUpdate.Enabled = true;
                //}
                //else
                //{
                //    this.labelSynColExsCheck.Text = "No differences found";
                //    this.buttonSynColExsUpdate.Enabled = false;
                //}
                //if (this.dataGridViewSynColTax.ColumnCount > 0 && setColumnWidth)
                //{
                //    this.dataGridViewSynColExs.Columns[0].Width = (int)this.dataGridViewSynColExs.Width * 3 / 8;
                //    this.dataGridViewSynColExs.Columns[1].Width = (int)this.dataGridViewSynColExs.Width * 3 / 8;
                //}
                //this.dataGridViewSynColExs.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
            }
            catch (System.Exception ex)
            {
            }
        }

        private void buttonSynColExsUpdate_Click(object sender, EventArgs e)
        {
            bool OK = true;
            string SQL = "UPDATE S SET S.ExsiccataAbbreviation = E.ExsAbbreviation " +
                "FROM CollectionProject AS P INNER JOIN " + this._PrefixDB_ExsDB + "Exsiccata AS E INNER JOIN " +
                "CollectionSpecimen AS S ON '" + this._BaseURL_ExsDB +
                "'+ cast(E.ExsiccataID as varchar) = S.ExsiccataURI AND  " +
                "E.ExsAbbreviation <> S.ExsiccataAbbreviation  ON " +
                "P.CollectionSpecimenID = S.CollectionSpecimenID ";
            if (this.comboBoxSynColExsProject.SelectedIndex > 0)
            {
                int ProjectID = 0;
                if (this.comboBoxSynColExsProject.SelectedItem != null)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColExsProject.SelectedItem;
                    if (int.TryParse(R["ProjectID"].ToString(), out ProjectID))
                        SQL += " AND P.ProjectID = " + ProjectID.ToString();
                    else
                        return;
                }
                //if (!int.TryParse(this.comboBoxSynColExsProject.SelectedValue.ToString(), out ProjectID))
                //    return;
                //else
                //    SQL += " WHERE P.ProjectID = " + ProjectID.ToString();
            }
            Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
            string Message = "";
            try
            {
                con.Open();
                C.ExecuteScalar().ToString();
            }
            catch (Exception ex)
            {
                OK = false;
                Message = ex.Message;
            }
            finally
            {
                if (OK)
                {
                    System.Windows.Forms.MessageBox.Show("Update finished");
                    this.dataGridViewSynColExs.DataSource = null;
                }
                else
                    System.Windows.Forms.MessageBox.Show("Update failed");
                con.Close();
            }
            if (Message.Length > 0)
                System.Windows.Forms.MessageBox.Show(Message);
        }

        private void buttonSynColExsCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSynColExs.SelectedRows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewSynColExs.SelectedRows[0];
            if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
            {
                this.DialogResult = DialogResult.OK;
                this.Close();
            }
            else
                this.DialogResult = DialogResult.Cancel;
        }

        private void checkBoxSynColExsIncludeAccNr_CheckedChanged(object sender, EventArgs e)
        {
            if (this.checkBoxSynColExsIncludeAccNr.Checked)
                this.buttonSynColExsCheckDataset.Visible = true;
            else
                this.buttonSynColExsCheckDataset.Visible = false;
        }

        #endregion

        #region Geography

        private void switchSynColGazPlaceToCountry()
        {
            DiversityWorkbench.Settings.GazetteerHierarchyPlaceToCountry = !DiversityWorkbench.Settings.GazetteerHierarchyPlaceToCountry;
            this.radioButtonSynColGazPlaceToCountry.Checked = DiversityWorkbench.Settings.GazetteerHierarchyPlaceToCountry;
            this.radioButtonSynColGazCountryToPlace.Checked = !DiversityWorkbench.Settings.GazetteerHierarchyPlaceToCountry;
            this.radioButtonGazetteerPlaceToCountry.Checked = DiversityWorkbench.Settings.GazetteerHierarchyPlaceToCountry;
            this.radioButtonGazetteerCountryToPlace.Checked = !DiversityWorkbench.Settings.GazetteerHierarchyPlaceToCountry;
        }

        #region Gazetteer via Link

        string _GazetteerBaseURL;

        private string GazetteerBaseURL
        {
            get
            {
                if (this._GazetteerBaseURL == null)
                {
                    DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].DataBaseURIs().TryGetValue(this.comboBoxSynColGazDatabase.Text, out this._GazetteerBaseURL);
                }
                return _GazetteerBaseURL;
            }
            //set { _GazetteerBaseURL = value; }
        }

        private void comboBoxSynColGazDatabase_SelectionChangeCommitted(object sender, EventArgs e)
        {
            this.ResetGazetteer();

            this.labelSynColGazDatabase.Text = "Database:";
            DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList()[this.comboBoxSynColGazDatabase.SelectedItem.ToString()];
            if (SC.LinkedServer.Length > 0)
                this.labelSynColGazDatabase.Text += SC.DatabaseName;
        }

        private void comboBoxSynColGazProject_SelectionChangeCommitted(object sender, EventArgs e)
        {
            this.ResetGazetteer();
        }

        private void comboBoxSynColGazTarget_SelectionChangeCommitted(object sender, EventArgs e)
        {
            this.ResetGazetteer();
            try
            {
                string Type = this.comboBoxSynColGazTarget.SelectedItem.ToString();
                bool shownCountryFields = false;
                if (Type == _SynColGazType.Country.ToString()) shownCountryFields = true;
                this.comboBoxSynColGazCountry.Visible = shownCountryFields;
                this.labelSynColGazCountry.Visible = shownCountryFields;
                this.checkBoxSynColGazCountryNote.Visible = shownCountryFields;
                this.textBoxSynColGazCountryNotes.Visible = shownCountryFields;
                if (shownCountryFields) this.fillCountryList();
                if (Type == _SynColGazType.Place.ToString())
                {
                    this.radioButtonSynColGazCountryToPlace.Visible = true;
                    this.radioButtonSynColGazPlaceToCountry.Visible = true;
                }
                else
                {
                    this.radioButtonSynColGazCountryToPlace.Visible = false;
                    this.radioButtonSynColGazPlaceToCountry.Visible = false;
                }
            }
            catch (System.Exception ex) { }
        }

        private void ResetGazetteer()
        {
            this._dtSynColGaz = new DataTable();
            this.dataGridViewSynColGaz.DataSource = null;
            this.buttonSynColGazUpdate.Enabled = false;
            this._GazetteerBaseURL = null;
        }

        private void radioButtonSynColGazPlaceToCountry_Click(object sender, EventArgs e)
        {
            this.switchSynColGazPlaceToCountry();
        }

        private void radioButtonSynColGazCountryToPlace_Click(object sender, EventArgs e)
        {
            this.switchSynColGazPlaceToCountry();
        }

        private void buttonSynColGazCheck_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            string Message = "";
            try
            {
                if (this.comboBoxSynColGazDatabase.SelectedItem == null)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a gazetteer database");
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                    return;
                }
                if (this.GazetteerBaseURL.Length == 0) // BaseURL == null || BaseURL.Length == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Connection to " + this.comboBoxSynColTaxDatabase.Text + " not established");
                    SourceForSynchronisation = SynchronisationSource.NoConnection;
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                    return;
                }
                bool OK = true;
                if (this.comboBoxSynColGazTarget.SelectedIndex == -1) OK = false;
                if (!OK)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a target of the comparision");
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                    return;
                }
                string SelectedType = this.comboBoxSynColGazTarget.SelectedItem.ToString();

                string SQL = this.SqlGazetteerSelect(this.GazetteerBaseURL);
                this._dtSynColGaz = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
                ad.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                try
                {
                    this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                    this.dataGridViewSynColGaz.DataSource = null;
                    ad.Fill(this._dtSynColGaz);
                    if (this._dtSynColGaz.Rows.Count > 0)
                    {
                        this.progressBarSynColGaz.Minimum = 0;
                        this.progressBarSynColGaz.Maximum = this._dtSynColGaz.Rows.Count;
                        this.progressBarSynColGaz.Value = 0;
                        System.Collections.Generic.List<System.Data.DataRow> RowsToRemove = new List<DataRow>();
                        string DB = this.comboBoxSynColGazDatabase.SelectedItem.ToString();// = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseList();
                        DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList()[DB];
                        string Prefix = "dbo.";
                        if (SC.LinkedServer.Length > 0)
                            Prefix = "[" + SC.LinkedServer + "]." + SC.DatabaseName + ".dbo.";
                        string ConnectionString = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList()[DB].ConnectionString;
                        Microsoft.Data.SqlClient.SqlConnection conGaz = new Microsoft.Data.SqlClient.SqlConnection(ConnectionString);
                        Microsoft.Data.SqlClient.SqlCommand cGaz = new Microsoft.Data.SqlClient.SqlCommand("", conGaz);
                        System.Data.DataTable dtGaz = new DataTable();
                        Microsoft.Data.SqlClient.SqlDataAdapter adGaz = new Microsoft.Data.SqlClient.SqlDataAdapter("", ConnectionString);
                        conGaz.Open();
                        foreach (System.Data.DataRow R in this._dtSynColGaz.Rows)
                        {
                            try
                            {
                                string Link = R["Link to Gazetteer"].ToString();
                                string ID = DiversityWorkbench.WorkbenchUnit.getIDFromURI(Link);
                                int iTest;
                                if (!int.TryParse(ID, out iTest))
                                {
                                    Message += "The URI\r\n" + Link + "\r\nis not valid\r\n\r\n";
                                    R[0] = false;
                                    continue;
                                }
                                if (SelectedType == _SynColGazType.Place.ToString())
                                {
                                    try
                                    {
                                        cGaz.CommandText = "SELECT ";
                                        if (DiversityWorkbench.Settings.GazetteerHierarchyPlaceToCountry)
                                            cGaz.CommandText += "N.Name + CASE WHEN RTRIM(C.HierarchyPlaceToCountry) <> '' THEN '" + DiversityWorkbench.Settings.GazetteerHierarchySeparator + "' + REPLACE(C.HierarchyPlaceToCountry, '|', '" + DiversityWorkbench.Settings.GazetteerHierarchySeparator + "') ELSE '' END";
                                        else
                                            cGaz.CommandText += "CASE WHEN RTRIM(C.HierarchyCountryToPlace) <> '' THEN REPLACE(C.HierarchyCountryToPlace, '|', '" + DiversityWorkbench.Settings.GazetteerHierarchySeparator + "') + '" + DiversityWorkbench.Settings.GazetteerHierarchySeparator + "' ELSE '' END + N.Name";
                                        cGaz.CommandText += " FROM " + Prefix + "GeoName N, " + Prefix + "GeoCache C " +
                                            "WHERE C.PlaceID = N.PlaceID AND N.NameID = " + ID;
                                        string PlaceName = cGaz.ExecuteScalar().ToString();
                                        R["Place name in Gazetteer"] = PlaceName;
                                        if (R["Place name in Gazetteer"].ToString() == R["Place name in Collection"].ToString())
                                            RowsToRemove.Add(R);
                                    }
                                    catch (System.Exception ex)
                                    {
                                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex, cGaz.CommandText);
                                    }
                                }
                                else if (SelectedType == _SynColGazType.Coordinates.ToString())
                                {
                                    try
                                    {
                                        dtGaz.Clear();
                                        adGaz.SelectCommand.CommandText = "SELECT P.Latitude AS Lat, " +
                                            "P.Longitude AS Long, P.Geography AS Geo " +
                                            "FROM " + Prefix + "ViewGeoPlace AS P INNER JOIN " +
                                            Prefix + "GeoName AS N ON P.PlaceID = N.PlaceID " +
                                            "WHERE N.NameID = " + ID;
                                        adGaz.Fill(dtGaz);
                                        if (dtGaz.Rows.Count > 0)
                                        {
                                            if (!dtGaz.Rows[0]["Lat"].Equals(System.DBNull.Value))
                                                R["Latitude in Gazetteer"] = float.Parse(dtGaz.Rows[0]["Lat"].ToString());
                                            if (!dtGaz.Rows[0]["Long"].Equals(System.DBNull.Value))
                                                R["Longitude in Gazetteer"] = float.Parse(dtGaz.Rows[0]["Long"].ToString());
                                            if (!dtGaz.Rows[0]["Geo"].Equals(System.DBNull.Value))
                                                R["Geography in Gazetteer"] = dtGaz.Rows[0]["Geo"].ToString();
                                        }
                                        if (R["Latitude in Gazetteer"].ToString() == R["Latitude in Collection"].ToString() &&
                                            R["Longitude in Gazetteer"].ToString() == R["Longitude in Collection"].ToString() &&
                                            R["Geography in Gazetteer"].ToString() == R["Geography in Collection"].ToString())
                                        {
                                            RowsToRemove.Add(R);
                                        }
                                        else
                                        {
                                            bool isEqual = true;
                                            // CheckGeography
                                            string[] ColGeo = R["Geography in Collection"].ToString().Split(new char[] { ' ' });
                                            string[] GazGeo = R["Geography in Gazetteer"].ToString().Split(new char[] { ' ' });
                                            if (GazGeo.Length == ColGeo.Length)
                                            {
                                                for (int i = 0; i < ColGeo.Length; i++)
                                                {
                                                    if (GazGeo[i] == ColGeo[i])
                                                        continue;
                                                    else
                                                    {
                                                        float fGaz;
                                                        float fCol;
                                                        if (float.TryParse(ColGeo[i].Replace("(", "").Replace(")", ""), out fCol) &&
                                                            float.TryParse(GazGeo[i].Replace("(", "").Replace(")", ""), out fGaz))
                                                        {
                                                            if (fGaz == fCol)
                                                                continue;
                                                            else
                                                            {
                                                                isEqual = false;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            if (isEqual)
                                            {
                                                float fLatCol = 0;
                                                float fLonCol = 0;
                                                float fLatGaz = 0;
                                                float fLonGaz = 0;
                                                if (float.TryParse(R["Latitude in Gazetteer"].ToString(), out fLatGaz) &&
                                                    float.TryParse(R["Longitude in Gazetteer"].ToString(), out fLonGaz) &&
                                                    float.TryParse(R["Latitude in Collection"].ToString(), out fLatCol) &&
                                                    float.TryParse(R["Longitude in Collection"].ToString(), out fLonCol))
                                                {
                                                    if ((fLatCol != fLatGaz ||
                                                        fLonCol != fLonGaz) &&
                                                        fLatGaz != 0 &&
                                                        fLonGaz != 0)
                                                        isEqual = false;
                                                }
                                                else
                                                {
                                                    if (fLonGaz != 0 && fLatGaz != 0)
                                                        isEqual = false;
                                                }
                                            }
                                            if (isEqual)
                                                RowsToRemove.Add(R);
                                        }
                                    }
                                    catch (System.Exception ex)
                                    {
                                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                                    }
                                }
                            }
                            catch (System.Exception ex)
                            {
                                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                            }
                            if (this.progressBarSynColGaz.Value < this.progressBarSynColGaz.Maximum)
                                this.progressBarSynColGaz.Value++;
                        }
                        conGaz.Close();
                        conGaz.Dispose();
                        foreach (System.Data.DataRow R in RowsToRemove)
                            R.Delete();
                        this._dtSynColGaz.AcceptChanges();
                        this.dataGridViewSynColGaz.DataSource = this._dtSynColGaz;
                        this.labelSynColGazCheck.Text = this._dtSynColGaz.Rows.Count.ToString() + " differences found";
                        this.buttonSynColGazUpdate.Enabled = true;
                        this.dataGridViewSynColGaz.Columns[0].AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells;
                        this.dataGridViewSynColGaz.ReadOnly = false;
                        foreach (System.Windows.Forms.DataGridViewColumn C in this.dataGridViewSynColGaz.Columns)
                        {
                            C.ReadOnly = true;
                        }
                        this.dataGridViewSynColGaz.Columns[0].ReadOnly = false;
                        if (SelectedType == _SynColGazType.Place.ToString())
                        {
                            int iW = (int)(this.dataGridViewSynColGaz.Width / 3);
                            this.dataGridViewSynColGaz.Columns[1].Width = iW;
                            this.dataGridViewSynColGaz.Columns[2].Width = iW;
                            this.dataGridViewSynColGaz.Columns[3].Width = (int)(iW / 2);
                            this.dataGridViewSynColGaz.Columns[4].Width = 30;
                            this.dataGridViewSynColGaz.Columns[5].Width = 30;
                        }
                        else if (SelectedType == _SynColGazType.Coordinates.ToString())
                        {
                            int iC = (int)(this.dataGridViewSynColGaz.Width / 10);
                            for (int i = 1; i < 9; i++)
                            {
                                this.dataGridViewSynColGaz.Columns[i].Width = iC;
                            }
                            this.dataGridViewSynColGaz.Columns[9].Width = 30;
                            this.dataGridViewSynColGaz.Columns[10].Width = 30;
                        }
                    }
                    else
                    {
                        this.labelSynColGazCheck.Text = "No differences found";
                        this.buttonSynColGazUpdate.Enabled = false;
                    }
                    if (this.checkBoxSynColGazIncludeAccNr.Checked)
                        this.buttonSynColGazCheckDataset.Visible = true;
                    else
                        this.buttonSynColGazCheckDataset.Visible = false;
                }
                catch (System.Exception ex)
                {
                    Message += ex.Message;
                }
                finally
                {
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                }
            }
            catch (Exception ex)
            {
                Message += ex.Message;
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;

            if (Message.Length > 0)
                System.Windows.Forms.MessageBox.Show(Message);

            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonSynColGazUpdate_Click(object sender, EventArgs e)
        {
            int i = 0;
            try
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                string SQL = "";
                this.progressBarSynColGaz.Minimum = 0;
                this.progressBarSynColGaz.Maximum = this._dtSynColGaz.Rows.Count;
                this.progressBarSynColGaz.Value = 0;
                foreach (System.Data.DataRow R in this._dtSynColGaz.Rows)
                {
                    if (R[0].ToString().ToLower() == "true")
                    {
                        SQL = this.SqlGazetteerUpdate(R);
                        if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL))
                            i++;
                    }
                    if (this.progressBarSynColGaz.Value < this.progressBarSynColGaz.Maximum)
                        this.progressBarSynColGaz.Value++;
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
                System.Windows.Forms.MessageBox.Show(i.ToString() + " datasets updated");
            }
            this.ResetGazetteer();




            return;
            bool OK = true;
            if (this.comboBoxSynColGazTarget.SelectedIndex == -1) OK = false;
            if (!OK)
            {
                System.Windows.Forms.MessageBox.Show("Please select a target of the comparision");
                return;
            }
            string SelectedType = this.comboBoxSynColGazTarget.SelectedItem.ToString();
            Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            try
            {
                con.Open();
                string SQL = "";
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColGaz.Rows)
                {
                    if (R.Cells[0].Value.ToString().ToLower() == "true")
                    {
                        SQL = this.SqlGazetteerUpdate(R);

                        if (SelectedType == _SynColGazType.Coordinates.ToString())
                        {
                            SQL += " AND L.Location2 = '" + R.Cells[8].Value.ToString() + "'";
                            if (this.checkBoxSynColGazIncludeAccNr.Checked)
                                SQL += " AND S.CollectionSpecimenID = " + R.Cells[7].Value.ToString();
                        }
                        else if (SelectedType == _SynColGazType.Place.ToString())
                        {
                            SQL += " AND L.Location2 = '" + R.Cells[5].Value.ToString() + "'";
                            if (this.checkBoxSynColGazIncludeAccNr.Checked)
                                SQL += " AND S.CollectionSpecimenID = " + R.Cells[4].Value.ToString();
                        }
                        else if (SelectedType == _SynColGazType.Country.ToString() || SelectedType == _SynColGazType.Nation.ToString())
                        {
                            SQL += " AND L.Location2 = '" + R.Cells[5].Value.ToString() + "'";
                            if (this.checkBoxSynColGazIncludeAccNr.Checked)
                                SQL += " AND S.CollectionSpecimenID = " + R.Cells[4].Value.ToString();
                            if (this.checkBoxSynColGazCountrySingle.Checked)
                                SQL += " AND E.CountryCache = '" + "";
                        }
                        else if (SelectedType == _SynColGazType.Geography.ToString())
                        {
                            //string x = R.Cells[6].Value.ToString();

                            SQL += " AND L.Location2 = '" + R.Cells[6].Value.ToString() + "'";
                            if (this.checkBoxSynColGazIncludeAccNr.Checked)
                                SQL += " AND S.CollectionSpecimenID = " + R.Cells[4].Value.ToString();
                        }
                        try
                        {
                            C.CommandText = SQL;
                            C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                            C.ExecuteNonQuery();
                            foreach (System.Windows.Forms.DataGridViewCell Cell in R.Cells)
                                Cell.Style.BackColor = System.Drawing.Color.LightGreen;
                            //R.Cells[0].Style.BackColor = System.Drawing.Color.LightGreen;
                        }
                        catch (Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                            foreach (System.Windows.Forms.DataGridViewCell Cell in R.Cells)
                                Cell.Style.BackColor = System.Drawing.Color.Pink;
                            //R.Cells[0].Style.BackColor = System.Drawing.Color.Pink;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
                System.Windows.Forms.MessageBox.Show("Update finished");
                //this.dataGridViewSynColGaz.DataSource = null;
                con.Close();
            }

        }

        private void buttonSynColGazCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSynColGaz.SelectedRows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewSynColGaz.SelectedRows[0];
            bool OK = true;
            try { string test = R.Cells["CollectionSpecimenID"].Value.ToString(); }
            catch { OK = false; }
            if (OK)
            {
                if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
                {
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                else
                    this.DialogResult = DialogResult.Cancel;
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            }
        }

        #region Country

        private void fillCountryList()
        {
            if (this.comboBoxSynColGazCountry.DataSource == null)
            {
                string SQL = "SELECT DISTINCT N.Name AS NameEn " +
                    "FROM GeoName AS N INNER JOIN " +
                    "GeoPlace AS P ON N.PlaceID = P.PlaceID AND N.NameID = P.PreferredNameID " +
                    "WHERE (P.PlaceType = N'nation') " +
                    "ORDER BY N.Name";
                //string SQL = "SELECT NameEn FROM DiversityGazetteer.dbo.GeoCountries WHERE (PlaceID > 1) GROUP BY NameEn ORDER BY NameEn";
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                System.Data.DataTable dt = new DataTable();
                try
                {
                    ad.Fill(dt);
                    this.comboBoxSynColGazCountry.DataSource = dt;
                    this.comboBoxSynColGazCountry.DisplayMember = "NameEn";
                    this.comboBoxSynColGazCountry.ValueMember = "NameEn";
                }
                catch { }
            }
        }

        private void fillCountryCacheList()
        {
            if (this.comboBoxSynColGazCountry.DataSource == null)
            {
                string SQL = "SELECT DISTINCT N.Name AS NameEn " +
                    "FROM GeoName AS N INNER JOIN " +
                    "GeoPlace AS P ON N.PlaceID = P.PlaceID AND N.NameID = P.PreferredNameID " +
                    "WHERE (P.PlaceType = N'nation') " +
                    "ORDER BY N.Name";
                //string SQL = "SELECT NameEn FROM DiversityGazetteer.dbo.GeoCountries WHERE (PlaceID > 1) GROUP BY NameEn ORDER BY NameEn";
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                System.Data.DataTable dt = new DataTable();
                try
                {
                    ad.Fill(dt);
                    this.comboBoxSynColGazCountry.DataSource = dt;
                    this.comboBoxSynColGazCountry.DisplayMember = "NameEn";
                    this.comboBoxSynColGazCountry.ValueMember = "NameEn";
                }
                catch { }
            }
        }

        private void checkBoxSynColGazCountryNote_CheckedChanged(object sender, EventArgs e)
        {
            this.setCountryNote();
        }

        private void dataGridViewSynColGaz_RowHeaderMouseClick(object sender, DataGridViewCellMouseEventArgs e)
        {
            this.setCountryNote();
        }

        private void setCountryNote()
        {
            if (checkBoxSynColGazCountryNote.Checked)
            {
                if (this.dataGridViewSynColGaz.SelectedRows.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a dataset");
                    return;
                }
                System.Windows.Forms.DataGridViewRow R = this.dataGridViewSynColGaz.SelectedRows[0];
                bool OK = true;
                string CountryInDivColl = "";
                try { CountryInDivColl = R.Cells["Country in DiversityCollection"].Value.ToString(); }
                catch { OK = false; }
                if (OK && CountryInDivColl.Length > 0)
                    this.textBoxSynColGazCountryNotes.Text = "Ori. Country: " + CountryInDivColl;
                else
                    System.Windows.Forms.MessageBox.Show("Country is empty");
            }
            else
                this.textBoxSynColGazCountryNotes.Text = "";
        }

        private void checkBoxSynColGazCountrySingle_CheckedChanged(object sender, EventArgs e)
        {
            this.textBoxSynColGazCountryNotes.Enabled = this.checkBoxSynColGazCountrySingle.Checked;
            this.comboBoxSynColGazCountry.Enabled = this.checkBoxSynColGazCountrySingle.Checked;
            this.checkBoxSynColGazCountryNote.Enabled = this.checkBoxSynColGazCountrySingle.Checked;
        }

        private string SqlGazetteerCountryFromAndWhere()
        {
            string DB = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].DatabaseList()[0];
            string SQL = "FROM CollectionEvent E, CollectionProject P, CollectionSpecimen S , CollectionEventLocalisation L , " +
                "" + DB + ".dbo.GeoName AS N, " +
                "" + DB + ".dbo.GeoPlace AS NP, " + DB + ".dbo.GeoPlace AS PC, " +
                "" + DB + ".dbo.GeoName AS NC " +
                "WHERE (L.LocalisationSystemID = 7)   " +
                " AND P.CollectionSpecimenID = S.CollectionSpecimenID " +
                "AND E.CollectionEventID = S.CollectionEventID " +
                "and CAST(L.Location2 AS varchar(255)) = DiversityGazetteer_Geo.dbo.BaseURL() + CAST(N.NameID AS VARCHAR) " +
                "and E.CollectionEventID = L.CollectionEventID " +
                "AND E.CountryCache <> NC.Name " +
                "and PC.PreferredNameID = NC.NameID " +
                "AND PC.PlaceID = NC.PlaceID " +
                "and NP.CountryPlaceID_Cache = PC.PlaceID " +
                "and N.NameID = CAST(substring(L.Location2, len(DiversityGazetteer_Geo.dbo.BaseURL()) + 1, 255) as int) " +
                "and ISNUMERIC(substring(L.Location2, len(DiversityGazetteer_Geo.dbo.BaseURL()) + 1, 255)) = 1 " +
                "and N.PlaceID = NP.PlaceID  ";
            return SQL;

            /*
             * SELECT CAST(1 AS BIT) AS OK,  NC.Name AS [Country in Gazetteer] , E.CountryCache AS [Country in Collection] , 
            CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) 
            END AS AccessionNumbers, COUNT(*) AS Number , L.Location2 AS [Link to Gazetteer] 
            FROM CollectionEvent E, CollectionProject P, CollectionSpecimen S , CollectionEventLocalisation L ,
            DiversityGazetteer_Geo.dbo.GeoName AS N,
            DiversityGazetteer_Geo.dbo.GeoPlace AS NP, DiversityGazetteer_Geo.dbo.GeoPlace AS PC,
            DiversityGazetteer_Geo.dbo.GeoName AS NC
            WHERE (L.LocalisationSystemID = 7)   
            AND P.ProjectID = -4 
            AND P.CollectionSpecimenID = S.CollectionSpecimenID 
            AND E.CollectionEventID = S.CollectionEventID
            and CAST(L.Location2 AS varchar(255)) = DiversityGazetteer_Geo.dbo.BaseURL() + CAST(N.NameID AS VARCHAR) 
            and E.CollectionEventID = L.CollectionEventID 
            AND E.CountryCache <> NC.Name 
            and PC.PreferredNameID = NC.NameID 
            AND PC.PlaceID = NC.PlaceID
            and NP.CountryPlaceID_Cache = PC.PlaceID 
            and N.NameID = CAST(substring(L.Location2, len(DiversityGazetteer_Geo.dbo.BaseURL()) + 1, 255) as int)
            and ISNUMERIC(substring(L.Location2, len(DiversityGazetteer_Geo.dbo.BaseURL()) + 1, 255)) = 1
            and N.PlaceID = NP.PlaceID
            GROUP BY NC.Name, L.Location2 , E.CountryCache  
            ORDER BY NC.Name , E.CountryCache 


             * */
        }

        #endregion

        private string SqlGazetteerPlaceFromAndWhere(string BaseURL)
        {
            //string DB = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].DatabaseList()[0];
            string SQL = "FROM CollectionEventLocalisation L INNER JOIN CollectionProject P INNER JOIN " +
            "CollectionSpecimen S ON P.CollectionSpecimenID = S.CollectionSpecimenID ON  " +
            "L.CollectionEventID = S.CollectionEventID " +
            "WHERE L.LocalisationSystemID IN (7, 18, 19, 20, 21) " +
            "AND L.Location2 LIKE '" + BaseURL + "%' ";
            return SQL;
        }

        private string SqlGazetteerPlaceFromAndWhere()
        {
            string DB = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].DatabaseList()[0];
            string SQL = "FROM CollectionEventLocalisation L INNER JOIN " + DB +
            ".dbo.GeoName G ON cast(L.Location2 as varchar(255)) = " + DB + ".dbo.BaseURL() + CAST(G.NameID AS VARCHAR)  " +
            "INNER JOIN CollectionProject P INNER JOIN " +
            "CollectionSpecimen S ON P.CollectionSpecimenID = S.CollectionSpecimenID ON  " +
            "L.CollectionEventID = S.CollectionEventID " +
            "WHERE (L.LocalisationSystemID = 7) " +
            "AND G.NameID = CAST(substring(L.Location2, len(" + DB + ".dbo.BaseURL()) + 1, 255) as int)" +
            "AND L.Location1 <> G.HierarchyCache ";
            return SQL;
        }

        private string SqlGazetteerGeographyFromAndWhere()
        {
            string DB = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].DatabaseList()[0];
            string SQL = "FROM " + DB + ".dbo.GeoPlace AS GP INNER JOIN " +
                "CollectionEventLocalisation L INNER JOIN " +
                DB + ".dbo.GeoName AS GN ON CAST(L.Location2 AS varchar(255)) = " + DB + ".dbo.BaseURL() + CAST(GN.NameID AS VARCHAR) INNER JOIN " +
                "CollectionProject P INNER JOIN " +
                "CollectionSpecimen S ON P.CollectionSpecimenID = S.CollectionSpecimenID ON  " +
                "L.CollectionEventID = S.CollectionEventID ON GP.PlaceID = GN.PlaceID " +
                "WHERE (L.LocalisationSystemID = 7) " +
                "AND GN.PlaceID = GP.PlaceID AND GN.NameID = CAST(substring(L.Location2, len(" + DB + ".dbo.BaseURL()) + 1, 255) as int) " +
                "and (GP.Geography.ToString() <> L.Geography.ToString() or L.Geography IS NULL) ";
            return SQL;
        }

        private string SqlGazetteerCoordinatesFromAndWhere()
        {
            string DB = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].DatabaseList()[0];
            string SQL = "FROM " + DB + ".dbo.GeoPlace AS GP INNER JOIN " +
                "CollectionEventLocalisation L INNER JOIN " +
                DB + ".dbo.GeoName AS GN ON CAST(L.Location2 AS varchar(255)) = " + DB + ".dbo.BaseURL() + CAST(GN.NameID AS VARCHAR) INNER JOIN " +
                "CollectionProject P INNER JOIN " +
                "CollectionSpecimen S ON P.CollectionSpecimenID = S.CollectionSpecimenID ON  " +
                "L.CollectionEventID = S.CollectionEventID ON GP.PlaceID = GN.PlaceID " +
                "WHERE (L.LocalisationSystemID = 7) " +
                "AND GN.PlaceID = GP.PlaceID AND GN.NameID = CAST(substring(L.Location2, len(" + DB + ".dbo.BaseURL()) + 1, 255) as int)" +
                "and (GP.Geography.EnvelopeCenter().Lat <> 0) " +
                "and (GP.Geography.EnvelopeCenter().Long <> 0) " +
                "and ((L.AverageLatitudeCache is null OR L.AverageLatitudeCache <> GP.Geography.EnvelopeCenter().Lat) " +
                "or (L.AverageLongitudeCache is null OR L.AverageLongitudeCache <>GP.Geography.EnvelopeCenter().Long))";
            return SQL;
        }

        private string SqlGazetteerCoordinatesFromAndWhereForUpdate(string BaseURL)
        {
            string SQL = "FROM CollectionEventLocalisation L INNER JOIN CollectionProject P INNER JOIN " +
            "CollectionSpecimen S ON P.CollectionSpecimenID = S.CollectionSpecimenID ON  " +
            "L.CollectionEventID = S.CollectionEventID " +
            "WHERE L.LocalisationSystemID IN (7, 18, 19, 20, 21) " +
            "AND L.Location2 LIKE '" + BaseURL + "%' ";
            return SQL;
        }

        private string SqlGazetteerCoordinatesFromAndWhereForUpdate()
        {
            string DB = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].DatabaseList()[0];
            string SQL = "FROM " + DB + ".dbo.GeoPlace AS GP INNER JOIN " +
                "CollectionEventLocalisation AS L INNER JOIN " +
                DB + ".dbo.GeoName AS GN ON CAST(L.Location2 AS varchar(255)) = DiversityGazetteer_Geo.dbo.BaseURL() + CAST(GN.NameID AS VARCHAR) " +
                "INNER JOIN CollectionProject AS P INNER JOIN " +
                "CollectionSpecimen AS S ON P.CollectionSpecimenID = S.CollectionSpecimenID ON L.CollectionEventID = S.CollectionEventID ON GP.PlaceID = GN.PlaceID " +
                "WHERE (L.LocalisationSystemID = 7) " +
                "AND GN.PlaceID = GP.PlaceID AND GN.NameID = CAST(substring(L.Location2, len(" + DB + ".dbo.BaseURL()) + 1, 255) as int)";
            return SQL;
        }

        private string SqlGazetteerNationFromAndWhere()
        {
            string DB = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].DatabaseList()[0];
            string SQL = "FROM CollectionEvent E, CollectionProject P, CollectionSpecimen S , CollectionEventLocalisation L , " +
                "" + DB + ".dbo.GeoName AS N, " +
                "" + DB + ".dbo.GeoPlace AS NP, " + DB + ".dbo.GeoPlace AS PC, " +
                "" + DB + ".dbo.GeoName AS NC " +
                "WHERE (L.LocalisationSystemID = 7)   " +
                " AND P.CollectionSpecimenID = S.CollectionSpecimenID " +
                "AND E.CollectionEventID = S.CollectionEventID " +
                "and CAST(L.Location2 AS varchar(255)) = DiversityGazetteer_Geo.dbo.BaseURL() + CAST(N.NameID AS VARCHAR) " +
                "and E.CollectionEventID = L.CollectionEventID " +
                "AND E.CountryCache <> NC.Name " +
                "and PC.PreferredNameID = NC.NameID " +
                "AND PC.PlaceID = NC.PlaceID " +
                "and NP.SuperiorPlaceID = PC.PlaceID  AND (PC.PlaceType = N'nation') and (NP.CountryPlaceID_Cache IS NULL) " +
                "and N.NameID = CAST(substring(L.Location2, len(DiversityGazetteer_Geo.dbo.BaseURL()) + 1, 255) as int) " +
                "and ISNUMERIC(substring(L.Location2, len(DiversityGazetteer_Geo.dbo.BaseURL()) + 1, 255)) = 1 " +
                "and N.PlaceID = NP.PlaceID  ";
            return SQL;

        }

        private string SqlGazetteerSelect(string BaseURL)
        {
            string SQL = "SELECT ";
            if (this.checkBoxSynColGazTopRestriction.Checked)
                SQL += " TOP " + this.numericUpDownSynColGazTopRestriction.Value.ToString() + " ";
            SQL += " CAST(1 AS BIT) AS OK, ";
            string SqlOrderBy = "";
            string SqlGroupBy = "";
            string Type = this.comboBoxSynColGazTarget.Text;
            switch (Type)
            {
                case "Place": // Place name
                    SQL += " '' AS [Place name in Gazetteer], " +
                        "L.Location1 AS [Place name in Collection]";
                    if (this.checkBoxSynColGazIncludeAccNr.Checked)
                        SQL += ", S.AccessionNumber, S.CollectionSpecimenID AS ID ";
                    else
                        SQL += ", CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) END AS AccessionNumbers, COUNT(*) AS No ";
                    SQL += ", L.Location2 AS [Link to Gazetteer] ";
                    SQL += this.SqlGazetteerPlaceFromAndWhere(BaseURL);
                    SqlOrderBy = "ORDER BY [Place name in Collection] ";
                    if (!this.checkBoxSynColGazIncludeAccNr.Checked)
                        SqlGroupBy = " GROUP BY L.Location1, L.Location2 ";
                    break;

                case "Nation":  //Nation//
                    //if (this.checkBoxSynColGazCountrySingle.Checked)
                    //{
                    //    SQL += " NC.Name AS [Country in Gazetteer] " +
                    //    ", E.CountryCache AS [Country in Collection] ";
                    //    if (this.checkBoxSynColGazIncludeAccNr.Checked)
                    //        SQL += ", S.AccessionNumber, S.CollectionSpecimenID AS ID ";
                    //    else
                    //        SQL += ", CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) END AS AccessionNumbers, COUNT(*) AS Number ";
                    //    SQL += ", L.Location2 AS [Link to Gazetteer] ";
                    //    SQL += this.SqlGazetteerNationFromAndWhere();
                    //    if (!this.checkBoxSynColGazIncludeAccNr.Checked)
                    //        SqlGroupBy = " GROUP BY E.CountryCache, NC.Name, L.Location2 ";
                    //    SqlOrderBy = " ORDER BY E.CountryCache ";
                    //}
                    //else
                    //{
                    //    SQL += " NC.Name AS [Country in Gazetteer] " +
                    //    ", E.CountryCache AS [Country in Collection] ";
                    //    SqlGroupBy += " GROUP BY NC.Name, L.Location2 " +
                    //    ", E.CountryCache ";
                    //    SqlOrderBy += " ORDER BY NC.Name " +
                    //    ", E.CountryCache ";
                    //    if (this.checkBoxSynColGazIncludeAccNr.Checked)
                    //    {
                    //        SQL += ", S.AccessionNumber, S.CollectionSpecimenID AS ID ";
                    //        SqlGroupBy += ", S.AccessionNumber, S.CollectionSpecimenID, L.Location2 ";
                    //    }
                    //    else
                    //        SQL += ", CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) END AS AccessionNumbers, COUNT(*) AS Number ";
                    //    SQL += ", L.Location2 AS [Link to Gazetteer] ";
                    //    SQL += this.SqlGazetteerNationFromAndWhere();
                    //}
                    break;
                case "Country":  //Country//
                    //if (this.checkBoxSynColGazCountrySingle.Checked)
                    //{
                    //    SQL += " NC.Name AS [Country in Gazetteer] " +
                    //    ", E.CountryCache AS [Country in Collection] ";
                    //    if (this.checkBoxSynColGazIncludeAccNr.Checked)
                    //        SQL += ", S.AccessionNumber, S.CollectionSpecimenID AS ID ";
                    //    else
                    //        SQL += ", CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) END AS AccessionNumbers, COUNT(*) AS Number ";
                    //    SQL += ", L.Location2 AS [Link to Gazetteer] ";
                    //    SQL += this.SqlGazetteerCountryFromAndWhere();
                    //    if (!this.checkBoxSynColGazIncludeAccNr.Checked)
                    //        SqlGroupBy = " GROUP BY E.CountryCache, NC.Name, L.Location2 ";
                    //    SqlOrderBy = " ORDER BY E.CountryCache ";
                    //}
                    //else
                    //{
                    //    SQL += " NC.Name AS [Country in Gazetteer] " +
                    //    ", E.CountryCache AS [Country in Collection] ";
                    //    SqlGroupBy += " GROUP BY NC.Name, L.Location2 " +
                    //    ", E.CountryCache ";
                    //    SqlOrderBy += " ORDER BY NC.Name " +
                    //    ", E.CountryCache ";
                    //    if (this.checkBoxSynColGazIncludeAccNr.Checked)
                    //    {
                    //        SQL += ", S.AccessionNumber, S.CollectionSpecimenID AS ID ";
                    //        SqlGroupBy += ", S.AccessionNumber, S.CollectionSpecimenID, L.Location2 ";
                    //    }
                    //    else
                    //        SQL += ", CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) END AS AccessionNumbers, COUNT(*) AS Number ";
                    //    SQL += ", L.Location2 AS [Link to Gazetteer] ";
                    //    SQL += this.SqlGazetteerCountryFromAndWhere();
                    //}
                    break;
                case "Coordinates": // Coordinates
                    SQL += " L.Location1 AS [Place name in Collection], " +
                        "L.AverageLatitudeCache AS [Latitude in Collection], CAST(0 AS float) AS [Latitude in Gazetteer], " +
                        "L.AverageLongitudeCache AS [Longitude in Collection], CAST(0 AS float) AS [Longitude in Gazetteer], " +
                        "L.Geography.ToString() AS [Geography in Collection], '' AS [Geography in Gazetteer] ";
                    if (this.checkBoxSynColGazIncludeAccNr.Checked)
                        SQL += ", S.AccessionNumber, S.CollectionSpecimenID AS ID ";
                    else
                        SQL += ", CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) END AS AccessionNumbers, COUNT(*) AS No ";
                    SQL += ", L.Location2 AS [Link to Gazetteer] ";
                    SQL += this.SqlGazetteerPlaceFromAndWhere(BaseURL);
                    if (!this.checkBoxSynColGazIncludeAccNr.Checked)
                        SqlGroupBy = " GROUP BY L.Location1, L.Location2, " +
                        "L.AverageLatitudeCache, L.AverageLongitudeCache, L.Geography.ToString() ";
                    SqlOrderBy = " ORDER BY L.Location1";
                    break;
                case "Geography": // Geography
                    //SQL += " L.Location1 AS [Place name in Collection], " +
                    //    "L.Geography.ToString() AS [Geography in Collection], GP.Geography.ToString() AS [Geography in Gazetteer] ";
                    //if (this.checkBoxSynColGazIncludeAccNr.Checked)
                    //    SQL += ", S.AccessionNumber, S.CollectionSpecimenID AS ID ";
                    //else
                    //    SQL += ", CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) END AS AccessionNumbers, COUNT(*) AS Anzahl ";
                    //SQL += ", L.Location2 AS [Link to Gazetteer] ";
                    //SQL += this.SqlGazetteerGeographyFromAndWhere();
                    //if (!this.checkBoxSynColGazIncludeAccNr.Checked)
                    //    SqlGroupBy = " GROUP BY L.Location1, L.Location2, " +
                    //    "GP.Geography.ToString(), L.Geography.ToString() ";
                    //SqlOrderBy = " ORDER BY L.Location1";
                    break;
            }
            if (this.comboBoxSynColGazProject.SelectedIndex > 0)
            {
                int ProjectID = 0;
                if (this.comboBoxSynColGazProject.SelectedItem != null)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColGazProject.SelectedItem;
                    if (int.TryParse(R["ProjectID"].ToString(), out ProjectID))
                        SQL += " AND P.ProjectID = " + ProjectID.ToString();
                }
                //if (int.TryParse(this.comboBoxSynColGazProject.SelectedValue.ToString(), out ProjectID))
                //    SQL += " AND P.ProjectID = " + ProjectID.ToString();
                else
                {
                    System.Windows.Forms.MessageBox.Show("Please select a project");
                    return "";
                }
            }
            else
                SQL += " AND P.ProjectID IN (SELECT ProjectID FROM ProjectList) ";
            SQL += SqlGroupBy;
            SQL += SqlOrderBy;
            return SQL;
        }

        private string SqlGazetteerSelect()
        {
            string SQL = "SELECT ";
            if (this.checkBoxSynColGazTopRestriction.Checked)
                SQL += " TOP " + this.numericUpDownSynColGazTopRestriction.Value.ToString() + " ";
            SQL += " CAST(1 AS BIT) AS OK, ";
            string SqlOrderBy = "";
            string SqlGroupBy = "";
            string Type = this.comboBoxSynColGazTarget.Text;
            switch (Type)
            {
                case "Place": // Place name
                    SQL += " G.HierarchyCache AS [Place name in Gazetteer], " +
                        "L.Location1 AS [Place name in Collection]";
                    if (this.checkBoxSynColGazIncludeAccNr.Checked)
                        SQL += ", S.AccessionNumber, S.CollectionSpecimenID AS ID ";
                    else
                        SQL += ", CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) END AS AccessionNumbers, COUNT(*) AS Number ";
                    SQL += ", L.Location2 AS [Link to Gazetteer] ";
                    SQL += this.SqlGazetteerPlaceFromAndWhere();
                    SqlOrderBy = "ORDER BY G.HierarchyCache ";
                    if (!this.checkBoxSynColGazIncludeAccNr.Checked)
                        SqlGroupBy = " GROUP BY G.HierarchyCache, " +
                        "L.Location1, L.Location2 ";
                    break;

                case "Nation":  //Nation//
                    if (this.checkBoxSynColGazCountrySingle.Checked)
                    {
                        SQL += " NC.Name AS [Country in Gazetteer] " +
                        ", E.CountryCache AS [Country in Collection] ";
                        if (this.checkBoxSynColGazIncludeAccNr.Checked)
                            SQL += ", S.AccessionNumber, S.CollectionSpecimenID AS ID ";
                        else
                            SQL += ", CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) END AS AccessionNumbers, COUNT(*) AS Number ";
                        SQL += ", L.Location2 AS [Link to Gazetteer] ";
                        SQL += this.SqlGazetteerNationFromAndWhere();
                        if (!this.checkBoxSynColGazIncludeAccNr.Checked)
                            SqlGroupBy = " GROUP BY E.CountryCache, NC.Name, L.Location2 ";
                        SqlOrderBy = " ORDER BY E.CountryCache ";
                    }
                    else
                    {
                        SQL += " NC.Name AS [Country in Gazetteer] " +
                        ", E.CountryCache AS [Country in Collection] ";
                        SqlGroupBy += " GROUP BY NC.Name, L.Location2 " +
                        ", E.CountryCache ";
                        SqlOrderBy += " ORDER BY NC.Name " +
                        ", E.CountryCache ";
                        if (this.checkBoxSynColGazIncludeAccNr.Checked)
                        {
                            SQL += ", S.AccessionNumber, S.CollectionSpecimenID AS ID ";
                            SqlGroupBy += ", S.AccessionNumber, S.CollectionSpecimenID, L.Location2 ";
                        }
                        else
                            SQL += ", CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) END AS AccessionNumbers, COUNT(*) AS Number ";
                        SQL += ", L.Location2 AS [Link to Gazetteer] ";
                        SQL += this.SqlGazetteerNationFromAndWhere();
                    }
                    break;
                case "Country":  //Country//
                    if (this.checkBoxSynColGazCountrySingle.Checked)
                    {
                        SQL += " NC.Name AS [Country in Gazetteer] " +
                        ", E.CountryCache AS [Country in Collection] ";
                        if (this.checkBoxSynColGazIncludeAccNr.Checked)
                            SQL += ", S.AccessionNumber, S.CollectionSpecimenID AS ID ";
                        else
                            SQL += ", CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) END AS AccessionNumbers, COUNT(*) AS Number ";
                        SQL += ", L.Location2 AS [Link to Gazetteer] ";
                        SQL += this.SqlGazetteerCountryFromAndWhere();
                        if (!this.checkBoxSynColGazIncludeAccNr.Checked)
                            SqlGroupBy = " GROUP BY E.CountryCache, NC.Name, L.Location2 ";
                        SqlOrderBy = " ORDER BY E.CountryCache ";
                    }
                    else
                    {
                        SQL += " NC.Name AS [Country in Gazetteer] " +
                        ", E.CountryCache AS [Country in Collection] ";
                        SqlGroupBy += " GROUP BY NC.Name, L.Location2 " +
                        ", E.CountryCache ";
                        SqlOrderBy += " ORDER BY NC.Name " +
                        ", E.CountryCache ";
                        if (this.checkBoxSynColGazIncludeAccNr.Checked)
                        {
                            SQL += ", S.AccessionNumber, S.CollectionSpecimenID AS ID ";
                            SqlGroupBy += ", S.AccessionNumber, S.CollectionSpecimenID, L.Location2 ";
                        }
                        else
                            SQL += ", CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) END AS AccessionNumbers, COUNT(*) AS Number ";
                        SQL += ", L.Location2 AS [Link to Gazetteer] ";
                        SQL += this.SqlGazetteerCountryFromAndWhere();
                    }
                    break;
                case "Coordinates": // Coordinates
                    SQL += " L.Location1 AS [Place name in Collection], " +
                        "L.AverageLatitudeCache AS [Latitude in Collection], GP.Geography.EnvelopeCenter().Lat AS [Latitude in Gazetteer], " +
                        "L.AverageLongitudeCache AS [Longitude in Collection], GP.Geography.EnvelopeCenter().Long AS [Longitude in Gazetteer] ";
                    if (this.checkBoxSynColGazIncludeAccNr.Checked)
                        SQL += ", S.AccessionNumber, S.CollectionSpecimenID AS ID ";
                    else
                        SQL += ", CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) END AS AccessionNumbers, COUNT(*) AS Anzahl ";
                    SQL += ", L.Location2 AS [Link to Gazetteer] ";
                    SQL += this.SqlGazetteerCoordinatesFromAndWhere();
                    if (!this.checkBoxSynColGazIncludeAccNr.Checked)
                        SqlGroupBy = " GROUP BY L.Location1, L.Location2, " +
                        "GP.Geography.EnvelopeCenter().Lat, GP.Geography.EnvelopeCenter().Long, " +
                        "L.AverageLatitudeCache, L.AverageLongitudeCache ";
                    SqlOrderBy = " ORDER BY L.Location1";
                    break;
                case "Geography": // Geography
                    SQL += " L.Location1 AS [Place name in Collection], " +
                        "L.Geography.ToString() AS [Geography in Collection], GP.Geography.ToString() AS [Geography in Gazetteer] ";
                    if (this.checkBoxSynColGazIncludeAccNr.Checked)
                        SQL += ", S.AccessionNumber, S.CollectionSpecimenID AS ID ";
                    else
                        SQL += ", CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) END AS AccessionNumbers, COUNT(*) AS Anzahl ";
                    SQL += ", L.Location2 AS [Link to Gazetteer] ";
                    SQL += this.SqlGazetteerGeographyFromAndWhere();
                    if (!this.checkBoxSynColGazIncludeAccNr.Checked)
                        SqlGroupBy = " GROUP BY L.Location1, L.Location2, " +
                        "GP.Geography.ToString(), L.Geography.ToString() ";
                    SqlOrderBy = " ORDER BY L.Location1";
                    break;
            }
            if (this.comboBoxSynColGazProject.SelectedIndex > 0)
            {
                int ProjectID = 0;
                if (this.comboBoxSynColGazProject.SelectedItem != null)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColGazProject.SelectedItem;
                    if (int.TryParse(R["ProjectID"].ToString(), out ProjectID))
                        SQL += " AND P.ProjectID = " + ProjectID.ToString();
                }
                //if (int.TryParse(this.comboBoxSynColGazProject.SelectedValue.ToString(), out ProjectID))
                //    SQL += " AND P.ProjectID = " + ProjectID.ToString();
                else
                {
                    System.Windows.Forms.MessageBox.Show("Please select a project");
                    return "";
                }
            }
            else
                SQL += " AND P.ProjectID IN (SELECT ProjectID FROM ProjectList) ";
            SQL += SqlGroupBy;
            SQL += SqlOrderBy;
            return SQL;
        }

        private string SqlGazetteerUpdate(System.Data.DataRow R)
        {
            string SQL = "UPDATE ";
            string Type = this.comboBoxSynColGazTarget.Text;
            //if (this.checkBoxSynColGazTopRestriction.Checked)
            //    SQL += " TOP (" + this.numericUpDownSynColGazTopRestriction.Value.ToString() + ") ";
            switch (Type)
            {
                case "Place": // Place name
                    SQL += " CollectionEventLocalisation SET Location1 = N'" + R["Place name in Gazetteer"].ToString().Replace("'", "''") + "' ";
                    SQL += this.SqlGazetteerPlaceFromAndWhere(this.GazetteerBaseURL);
                    SQL += " AND L.Location2 = N'" + R["Link to Gazetteer"].ToString() + "'";
                    SQL += " AND L.Location1 <> N'" + R["Place name in Gazetteer"].ToString().Replace("'", "''") + "' ";
                    break;

                case "Country":  //Country//
                    //if (this.checkBoxSynColGazCountrySingle.Checked)
                    //{
                    //    SQL += " CollectionEvent SET CountryCache = '" + this.comboBoxSynColGazCountry.Text + "' ";
                    //    if (this.checkBoxSynColGazCountryNote.Checked && this.textBoxSynColGazCountryNotes.Text.Length > 0)
                    //        SQL += ", Notes = CASE WHEN Notes IS NULL THEN '' ELSE Notes + '. ' END + '" + this.textBoxSynColGazCountryNotes.Text + "' ";
                    //}
                    //else
                    //{
                    //    SQL += " CollectionEvent SET CountryCache = NC.Name ";
                    //}
                    //SQL += this.SqlGazetteerCountryFromAndWhere();
                    break;
                case "Nation":  //Country//
                    //if (this.checkBoxSynColGazCountrySingle.Checked)
                    //{
                    //    SQL += " CollectionEvent SET CountryCache = '" + this.comboBoxSynColGazCountry.Text + "' ";
                    //    if (this.checkBoxSynColGazCountryNote.Checked && this.textBoxSynColGazCountryNotes.Text.Length > 0)
                    //        SQL += ", Notes = CASE WHEN Notes IS NULL THEN '' ELSE Notes + '. ' END + '" + this.textBoxSynColGazCountryNotes.Text + "' ";
                    //}
                    //else
                    //{
                    //    SQL += " CollectionEvent SET CountryCache = NC.Name ";
                    //}
                    //SQL += this.SqlGazetteerNationFromAndWhere();
                    break;
                case "Coordinates": // Coordinates
                    SQL += " CollectionEventLocalisation SET " +
                        "AverageLatitudeCache = " + R["Latitude in Gazetteer"].ToString() + ", " +
                        "AverageLongitudeCache = " + R["Longitude in Gazetteer"].ToString() + ", " +
                        "Geography = '" + R["Geography in Gazetteer"].ToString() + "' ";
                    SQL += this.SqlGazetteerCoordinatesFromAndWhereForUpdate(this.GazetteerBaseURL);
                    SQL += " AND L.Location2 = '" + R["Link to Gazetteer"].ToString() + "'";
                    break;
                case "Geography": // Geography
                    //SQL += " CollectionEventLocalisation SET Geography = GP.Geography ";
                    //SQL += this.SqlGazetteerGeographyFromAndWhere();
                    break;
            }
            if (this.comboBoxSynColGazProject.SelectedIndex > 0)
            {
                int ProjectID = 0;
                if (this.comboBoxSynColGazProject.SelectedItem != null)
                {
                    System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColGazProject.SelectedItem;
                    if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                        SQL += " AND P.ProjectID = " + ProjectID.ToString();
                }
                //if (int.TryParse(this.comboBoxSynColGazProject.SelectedValue.ToString(), out ProjectID))
                //    SQL += " AND P.ProjectID = " + ProjectID.ToString();
                else
                {
                    System.Windows.Forms.MessageBox.Show("Please select a project");
                    return "";
                }
            }
            else
                SQL += " AND P.ProjectID IN (SELECT ProjectID FROM ProjectList) ";
            return SQL;
        }

        private string SqlGazetteerUpdate(System.Windows.Forms.DataGridViewRow R)
        {
            string SQL = "UPDATE ";
            string Type = this.comboBoxSynColGazTarget.Text;
            if (this.checkBoxSynColGazTopRestriction.Checked)
                SQL += " TOP (" + this.numericUpDownSynColGazTopRestriction.Value.ToString() + ") ";
            switch (Type)
            {
                case "Place": // Place name
                    SQL += " CollectionEventLocalisation SET Location1 = G.HierarchyCache ";
                    SQL += this.SqlGazetteerPlaceFromAndWhere();
                    break;

                case "Country":  //Country//
                    if (this.checkBoxSynColGazCountrySingle.Checked)
                    {
                        SQL += " CollectionEvent SET CountryCache = '" + this.comboBoxSynColGazCountry.Text + "' ";
                        if (this.checkBoxSynColGazCountryNote.Checked && this.textBoxSynColGazCountryNotes.Text.Length > 0)
                            SQL += ", Notes = CASE WHEN Notes IS NULL THEN '' ELSE Notes + '. ' END + '" + this.textBoxSynColGazCountryNotes.Text + "' ";
                    }
                    else
                    {
                        SQL += " CollectionEvent SET CountryCache = NC.Name ";
                    }
                    SQL += this.SqlGazetteerCountryFromAndWhere();
                    break;
                case "Nation":  //Country//
                    if (this.checkBoxSynColGazCountrySingle.Checked)
                    {
                        SQL += " CollectionEvent SET CountryCache = '" + this.comboBoxSynColGazCountry.Text + "' ";
                        if (this.checkBoxSynColGazCountryNote.Checked && this.textBoxSynColGazCountryNotes.Text.Length > 0)
                            SQL += ", Notes = CASE WHEN Notes IS NULL THEN '' ELSE Notes + '. ' END + '" + this.textBoxSynColGazCountryNotes.Text + "' ";
                    }
                    else
                    {
                        SQL += " CollectionEvent SET CountryCache = NC.Name ";
                    }
                    SQL += this.SqlGazetteerNationFromAndWhere();
                    break;
                case "Coordinates": // Coordinates
                    SQL += " CollectionEventLocalisation SET " +
                        "AverageLatitudeCache = GP.Geography.EnvelopeCenter().Lat, " +
                        "AverageLongitudeCache = GP.Geography.EnvelopeCenter().Long ";
                    SQL += this.SqlGazetteerCoordinatesFromAndWhereForUpdate();
                    break;
                case "Geography": // Geography
                    SQL += " CollectionEventLocalisation SET Geography = GP.Geography ";
                    SQL += this.SqlGazetteerGeographyFromAndWhere();
                    break;
            }
            if (this.comboBoxSynColGazProject.SelectedIndex > 0)
            {
                int ProjectID = 0;
                if (this.comboBoxSynColGazProject.SelectedItem != null)
                {
                    System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColGazProject.SelectedItem;
                    if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                        SQL += " AND P.ProjectID = " + ProjectID.ToString();
                }
                //if (int.TryParse(this.comboBoxSynColGazProject.SelectedValue.ToString(), out ProjectID))
                //    SQL += " AND P.ProjectID = " + ProjectID.ToString();
                else
                {
                    System.Windows.Forms.MessageBox.Show("Please select a project");
                    return "";
                }
            }
            else
                SQL += " AND P.ProjectID IN (SELECT ProjectID FROM ProjectList) ";
            return SQL;
        }

        private void buttonSynColGazCheckAll_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColGaz.Rows)
            {
                R.Cells[0].Value = true;
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonSynColGazCheckNone_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColGaz.Rows)
            {
                R.Cells[0].Value = false;
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void checkBoxSynColGazTopRestriction_CheckedChanged(object sender, EventArgs e)
        {
            if (this.checkBoxSynColGazTopRestriction.Checked)
                this.numericUpDownSynColGazTopRestriction.Enabled = true;
            else this.numericUpDownSynColGazTopRestriction.Enabled = false;
        }

        #endregion

        #region Gazetteer via Text

        private System.Data.DataTable _DtGazetteer;

        private System.Collections.Generic.Dictionary<string, System.Data.DataTable> _GazetteerSynonyms;

        private bool GazetteerViaTextCanStart()
        {
            bool OK = true;
            try
            {
                if (this.comboBoxGazetteerDatabase.SelectedItem == null)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a gazetteer database");
                    return false;
                }
                if (this.GazetteerViaTextConnectionString().Length == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a database");
                    return false;
                }
                if (this.comboBoxGazetteerForProject.SelectedItem == null)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a project");
                    return false;
                }
            }
            catch (System.Exception ex)
            {
                OK = false;
            }
            return OK;
        }

        private void radioButtonGazetteerCountryToPlace_Click(object sender, EventArgs e)
        {
            this.switchSynColGazPlaceToCountry();
        }

        private void radioButtonGazetteerPlaceToCountry_Click(object sender, EventArgs e)
        {
            this.switchSynColGazPlaceToCountry();
        }

        private string GazetteerViaTextConnectionString()
        {
            string DB = this.comboBoxGazetteerDatabase.SelectedItem.ToString();// = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseList();
            string ConnectionString = "";
            ConnectionString = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList()[DB].ConnectionString;
            return ConnectionString;
        }

        private void buttonGazetteerStartQuery_Click(object sender, EventArgs e)
        {
            if (!GazetteerViaTextCanStart())
                return;
            try
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                int ProjectID = 0;
                if (this.comboBoxGazetteerForProject.SelectedItem != null)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxGazetteerForProject.SelectedItem;
                    int.TryParse(R["ProjectID"].ToString(), out ProjectID);
                }
                string SQL = "SELECT DISTINCT CAST(0 AS bit) AS OK, L.Location1 AS [Place in Collection]";
                if ((this.comboBoxGazetteerCountry.SelectedValue != null && this.comboBoxGazetteerCountry.SelectedValue.ToString().Length > 0)
                    || (this.comboBoxGazetteerCountry.Text != null && this.comboBoxGazetteerCountry.Text.Length > 0))
                    SQL += ", E.CountryCache AS [Country in Collection] ";
                SQL += ", '' AS [Place in Gazeteer], " +
                    "CAST(0 as float) AS Latitude, cast(0 as float) AS Longitude , CAST(1 as int) AS [Number of synonyms] , cast('' as varchar(255)) AS URI ";
                if (this.checkBoxGazetteerAddAccNr.Checked)
                    SQL += " , CASE WHEN S.AccessionNumber IS NULL OR RTRIM(S.AccessionNumber) = '' THEN '[ID: ' + CAST(S.CollectionSpecimenID AS varchar) + ']' ELSE S.AccessionNumber END AS AccessionNumber, " +
                        "S.CollectionSpecimenID ";
                SQL += ", L.LocalisationSystemID FROM CollectionEvent AS E INNER JOIN " +
                    " CollectionEventLocalisation AS L ON E.CollectionEventID = L.CollectionEventID INNER JOIN " +
                    " CollectionSpecimen AS S ON E.CollectionEventID = S.CollectionEventID INNER JOIN " +
                    " CollectionProject AS CP ON S.CollectionSpecimenID = CP.CollectionSpecimenID " +
                    //" INNER JOIN LocalisationSystem LS ON L.LocalisationSystemID = LS.LocalisationSystemID " +
                    //" WHERE (LS.LocalisationSystemID = 7 OR LS.LocalisationSystemParentID = 7) " +
                    " WHERE L.LocalisationSystemID = " + this.comboBoxGazetteerLocalisationSystem.SelectedValue.ToString() +
                    " AND (L.Location2 IS NULL OR RTRIM(L.Location2) = '') and CP.ProjectID = " + ProjectID.ToString();
                if (this.comboBoxGazetteerCountry.SelectedValue != null && this.comboBoxGazetteerCountry.SelectedValue.ToString().Length > 0)
                {
                    if (this.comboBoxGazetteerCountry.SelectedValue.ToString().EndsWith("*") || this.comboBoxGazetteerCountry.SelectedValue.ToString().EndsWith("%"))
                        SQL += " AND E.CountryCache LIKE '" + this.SqlValueLike(this.comboBoxGazetteerCountry.SelectedValue.ToString().Trim(), SqlValueType.QueryRestriction) + "' ";
                    else
                        SQL += " AND E.CountryCache = '" + this.comboBoxGazetteerCountry.SelectedValue.ToString().Trim() + "' ";
                }
                else if (this.comboBoxGazetteerCountry.Text != null && this.comboBoxGazetteerCountry.Text.Length > 0)
                {
                    if (this.comboBoxGazetteerCountry.Text.EndsWith("*") || this.comboBoxGazetteerCountry.Text.EndsWith("%"))
                        SQL += " AND E.CountryCache LIKE '" + this.SqlValueLike(this.comboBoxGazetteerCountry.Text.Trim(), SqlValueType.QueryRestriction) + "' ";
                    else
                        SQL += " AND E.CountryCache = '" + this.comboBoxGazetteerCountry.Text.Trim() + "' ";
                }
                SQL += " ORDER BY [Place in Collection] ";
                this.progressBarGazetteer.Visible = false;
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                this._DtGazetteer = new DataTable();
                ad.Fill(this._DtGazetteer);
                this.SearchForLinksToGazetteer();
                this.dataGridViewGazetteer.DataSource = this._DtGazetteer;
                this.dataGridViewGazetteer.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                this.dataGridViewGazetteer.AllowUserToDeleteRows = false;
                this.dataGridViewGazetteer.AllowUserToAddRows = false;
                for (int i = 1; i < this.dataGridViewGazetteer.Columns.Count; i++)
                {
                    this.dataGridViewGazetteer.Columns[i].ReadOnly = true;
                }
                foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewGazetteer.Rows)
                {
                    if (R.Cells["Number of synonyms"].Value.ToString() != "1")
                    {
                        foreach (System.Windows.Forms.DataGridViewCell C in R.Cells)
                            C.Style.BackColor = System.Drawing.Color.LightBlue;
                    }
                }
                if (this.checkBoxGazetteerAddAccNr.Checked)
                    this.dataGridViewGazetteer.Columns[8].Visible = false;
                this.buttonGazetteerSelectFromList.Visible = false;
                if (this._DtGazetteer.Rows.Count > 0)
                    this.buttonGazetteerStartUpdate.Enabled = true;
                else
                {
                    this.buttonGazetteerStartUpdate.Enabled = false;
                }
            }
            catch (System.Exception ex)
            {
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
        }

        private void SearchForLinksToGazetteer()
        {
            this._GazetteerSynonyms = new Dictionary<string, DataTable>();
            string SQL = "";
            try
            {
                DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList()[this.comboBoxGazetteerDatabase.Text];
                this.progressBarSynColGaz.Maximum = this._DtGazetteer.Rows.Count;
                this.progressBarSynColGaz.Minimum = 0;
                this.progressBarSynColGaz.Value = 0;
                this.progressBarSynColGaz.Visible = true;
                string Prefix = SC.DatabaseName + ".dbo.";
                if (SC.LinkedServer.Length > 0)
                    Prefix = "[" + SC.LinkedServer + "]." + Prefix;
                foreach (System.Data.DataRow R in this._DtGazetteer.Rows)
                {
                    SQL = "SELECT ";
                    if (DiversityWorkbench.Settings.GazetteerHierarchyPlaceToCountry)
                        SQL += "N.Name + CASE WHEN RTRIM(C.HierarchyPlaceToCountry) <> '' THEN '" + DiversityWorkbench.Settings.GazetteerHierarchySeparator + "' + REPLACE(C.HierarchyPlaceToCountry, '|', '" + DiversityWorkbench.Settings.GazetteerHierarchySeparator + "') ELSE '' END";
                    else
                        SQL += "CASE WHEN RTRIM(C.HierarchyCountryToPlace) <> '' THEN REPLACE(C.HierarchyCountryToPlace, '|', '" + DiversityWorkbench.Settings.GazetteerHierarchySeparator + "') + '" + DiversityWorkbench.Settings.GazetteerHierarchySeparator + "' ELSE '' END + N.Name";

                    SQL += " AS Name, U.BaseURL + CAST(N.NameID AS varchar) AS URI, " +
                        "P.Latitude AS Latitude,  " +
                        "P.Longitude AS Longitude, P.PlaceType AS [Type] " +
                        "FROM " +
                        Prefix + "ViewBaseURL U, " +
                        Prefix + "GeoName AS N INNER JOIN " +
                        Prefix + "ViewGeoPlace AS P ON N.PlaceID = P.PlaceID INNER JOIN " +
                        Prefix + "GeoProject AS R ON N.NameID = R.NameID INNER JOIN " +
                        Prefix + "GeoCache AS C ON N.PlaceID = C.PlaceID " +
                        "WHERE ((N.Name = N'" + R["Place in Collection"].ToString().Replace("'", "''") + "') " +
                        "OR (N.HierarchyCache = N'" + R["Place in Collection"].ToString().Replace("'", "''") + "'))  ";
                    if (this.GazetteerProject() != null)
                        SQL += " AND R.ProjectID =  " + this.GazetteerProject().ToString();
                    if (this.comboBoxGazetteerCountryInGazetteer.Text.Length > 0)
                    {
                        SQL += " AND C.Country = '" + this.comboBoxGazetteerCountryInGazetteer.Text + "' ";
                    }
                    SQL += " ORDER BY Name";
                    System.Data.DataTable dtGazSyn = new DataTable();
                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, this.GazetteerViaTextConnectionString());
                    ad.Fill(dtGazSyn);
                    if (dtGazSyn.Rows.Count == 0)
                    {
                        R.Delete();
                    }
                    else
                    {
                        try
                        {
                            R["Place in Gazeteer"] = dtGazSyn.Rows[0]["Name"].ToString();
                            double Lat;
                            if (double.TryParse(dtGazSyn.Rows[0]["Latitude"].ToString(), out Lat))
                                R["Latitude"] = Lat;
                            if (double.TryParse(dtGazSyn.Rows[0]["Longitude"].ToString(), out Lat))
                                R["Longitude"] = Lat;
                            R["URI"] = dtGazSyn.Rows[0]["URI"].ToString();
                            R["Number of synonyms"] = dtGazSyn.Rows.Count;
                            if (dtGazSyn.Rows.Count > 1)
                            {
                                this._GazetteerSynonyms.Add(R["Place in Collection"].ToString(), dtGazSyn);
                                R["OK"] = false;
                            }
                            else
                                R["OK"] = true;
                        }
                        catch (System.Exception ex)
                        {
                        }
                    }
                    if (this.progressBarSynColGaz.Value < this.progressBarSynColGaz.Maximum)
                    {
                        this.progressBarSynColGaz.Value++;
                        System.Windows.Forms.Application.DoEvents();
                    }
                }
                this._DtGazetteer.AcceptChanges();
            }
            catch (System.Exception ex)
            {
            }
        }

        private void buttonGazetteerStartUpdate_Click(object sender, EventArgs e)
        {
            this.progressBarSynColGaz.Visible = true;
            this.progressBarSynColGaz.Minimum = 0;
            this.progressBarSynColGaz.Maximum = this._DtGazetteer.Rows.Count;
            this.progressBarSynColGaz.Value = 0;
            int ProjectID = 0;
            if (this.comboBoxGazetteerForProject.SelectedItem != null)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxGazetteerForProject.SelectedItem;
                int.TryParse(R["ProjectID"].ToString(), out ProjectID);
            }
            this._DtGazetteer.AcceptChanges();
            int i = 0;
            foreach (System.Data.DataRow R in this._DtGazetteer.Rows)
            {
                try
                {
                    if (R[0].ToString().ToLower() == "true")
                    {
                        string URI = R["URI"].ToString();
                        float Latitude = 0;
                        float Longitude = 0;
                        float.TryParse(R["Latitude"].ToString(), out Latitude);
                        float.TryParse(R["Longitude"].ToString(), out Longitude);
                        string Name = R["Place in Gazeteer"].ToString();
                        string SQL = "UPDATE L SET L.Location1 = '" + Name.Replace("'", "''") + "', L.Location2 = '" + URI + "' ";
                        if (Latitude != 0 && Longitude != 0)
                            SQL += ", L.AverageLatitudeCache = " + Latitude.ToString().Replace(",", ".") + ", L.AverageLongitudeCache = " + Longitude.ToString().Replace(",", ".");
                        SQL += " FROM CollectionEventLocalisation AS L INNER JOIN " +
                            " CollectionSpecimen AS S ON L.CollectionEventID = S.CollectionEventID INNER JOIN " +
                            " CollectionProject AS CP ON S.CollectionSpecimenID = CP.CollectionSpecimenID " +
                            " WHERE L.LocalisationSystemID = " + R["LocalisationSystemID"].ToString() +
                            " AND (L.Location2 IS NULL OR RTRIM(L.Location2) = '') " +
                            " and CP.ProjectID = " + ProjectID.ToString() + " " +
                            " and L.Location1 = '" + R["Place in Collection"].ToString().Replace("'", "''") + "' ";
                        string Message = "";
                        if (!DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL, ref Message, DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout))
                        {
                            if (System.Windows.Forms.MessageBox.Show("Update for " + R["Place in Collection"].ToString() + " failed:\r\n\r\n" + Message + "\r\nStop updates?", "Stop?", MessageBoxButtons.YesNo, MessageBoxIcon.Stop) == System.Windows.Forms.DialogResult.Yes)
                                break;
                        }
                        else i++;
                    }
                }
                catch (System.Exception ex)
                {
                    System.Windows.Forms.MessageBox.Show("Update for " + R["Place in Collection"].ToString() + " failed");
                }
                if (this.progressBarSynColGaz.Value < this.progressBarSynColGaz.Maximum)
                    this.progressBarSynColGaz.Value++;
            }
            System.Windows.Forms.MessageBox.Show("Update finished:\r\n" + i.ToString() + " datasets updated");
            this.buttonGazetteerStartUpdate.Enabled = false;
            this.dataGridViewGazetteer.DataSource = null;
        }

        private int _GazetteerSuccessfullUpdates;
        private int _GazetteerFailures;

        private bool GazetteerUpdate(System.Data.DataRow R, ref string Error)
        {
            bool UpdateSuccessful = true;
            try
            {
                int CollectionSpecimenID;
                if (!int.TryParse(R["CollectionSpecimenID"].ToString(), out CollectionSpecimenID))
                    return false;
                string URI = R["URI"].ToString();
                float Latitude = 0;
                float Longitude = 0;
                float.TryParse(R["Latitude"].ToString(), out Latitude);
                float.TryParse(R["Longitude"].ToString(), out Longitude);
                int ProjectID = 0;
                if (this.comboBoxGazetteerForProject.SelectedItem != null)
                {
                    System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxGazetteerForProject.SelectedItem;
                    int.TryParse(RP["ProjectID"].ToString(), out ProjectID);
                }
                string HierachyCache = R["Hierarchy"].ToString();
                string SQL = "UPDATE L SET L.Location1 = '" + HierachyCache.Replace("'", "''") + "', L.Location2 = '" + URI + "' ";
                if (Latitude != 0 && Longitude != 0)
                    SQL += ", L.AverageLatitudeCache = " + Latitude.ToString() + ", L.AverageLongitudeCache = " + Longitude.ToString();
                SQL += "FROM CollectionEventLocalisation AS L INNER JOIN " +
                    " CollectionSpecimen AS S ON L.CollectionEventID = S.CollectionEventID INNER JOIN " +
                    " CollectionProject AS CP ON S.CollectionSpecimenID = CP.CollectionSpecimenID " +
                    " WHERE (L.LocalisationSystemID = 7) AND (L.Location2 IS NULL) " +
                    " and CP.ProjectID = " + ProjectID.ToString() + " " +
                    " and S.CollectionSpecimenID = " + CollectionSpecimenID.ToString();
                if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL, ref Error))
                {
                    this._GazetteerSuccessfullUpdates++;
                    UpdateSuccessful = true;
                }
                else
                {
                    this._GazetteerFailures++;
                    UpdateSuccessful = false;
                }
            }
            catch (System.Exception ex)
            {
                return false;
            }
            return UpdateSuccessful;
        }

        private void buttonGazetteerCheckDataset_Click(object sender, EventArgs e)
        {
            if (this._DtGazetteer != null && this.dataGridViewGazetteer.SelectedCells != null)
            {
                int i = this.dataGridViewGazetteer.SelectedCells[0].RowIndex;
                System.Data.DataRow R = this._DtGazetteer.Rows[i];
                int ID;
                if (int.TryParse(R["CollectionSpecimenID"].ToString(), out ID))
                {
                    DiversityCollection.Forms.FormCollectionSpecimen f = new Forms.FormCollectionSpecimen(ID, false, false);
                    f.setViewMode(Forms.FormCollectionSpecimen.ViewMode.SingleInspectionMode);
                    f.Width = this.Width - 10;
                    f.Height = this.Height - 10;
                    f.ShowDialog();
                }
            }
        }

        private void comboBoxGazetteerHierarchyCacheStart_DropDown(object sender, EventArgs e)
        {
            try
            {
                //"@HierarchyCache +  substring([HierarchyCache], LEN(@HierarchyCache)+1, CHARINDEX(',', substring([HierarchyCache], LEN(@HierarchyCache)+1, 255))) "
                string SQL = "SELECT distinct substring([HierarchyCache], 1, CHARINDEX(',', [HierarchyCache])) AS HierarchyCache ";
                if (this.comboBoxGazetteerHierarchyCacheStart.Text.Length > 0)
                    SQL = "SELECT distinct '" + this.comboBoxGazetteerHierarchyCacheStart.Text + "' + substring([HierarchyCache], LEN('" + this.comboBoxGazetteerHierarchyCacheStart.Text + "')+1, CHARINDEX(',', substring([HierarchyCache], LEN('" + this.comboBoxGazetteerHierarchyCacheStart.Text + "')+1, 255))) AS HierarchyCache ";
                SQL += "FROM [" + this.comboBoxGazetteerDatabase.Text + "].[dbo].[GeoName] N " +
                    "where rtrim(N.[HierarchyCache]) <> '' ";
                if (this.comboBoxGazetteerHierarchyCacheStart.Text.Length > 0)
                    SQL += " AND N.[HierarchyCache] LIKE '" + this.comboBoxGazetteerHierarchyCacheStart.Text + "%'";
                SQL += "order by HierarchyCache";
                System.Data.DataTable dt = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                this.comboBoxGazetteerHierarchyCacheStart.DataSource = dt;
                this.comboBoxGazetteerHierarchyCacheStart.DisplayMember = "HierarchyCache";
                this.comboBoxGazetteerHierarchyCacheStart.ValueMember = "HierarchyCache";
            }
            catch (System.Exception ex) { }
        }

        private void checkBoxGazetteerAddAccNr_CheckedChanged(object sender, EventArgs e)
        {
            //if (this.checkBoxGazetteerAddAccNr.Checked)
            //    this.buttonGazetteerCheckDataset.Enabled = true;
            //else this.buttonGazetteerCheckDataset.Enabled = false;
            this.dataGridViewGazetteer.DataSource = null;
            this.buttonGazetteerStartUpdate.Enabled = false;
        }

        private void buttonGazetteerCheckAll_Click(object sender, EventArgs e)
        {
            // #173
            if (this._DtGazetteer != null)
            {
                if (this._DtGazetteer.Rows.Count > 0)
                foreach (System.Data.DataRow R in this._DtGazetteer.Rows)
                    R[0] = 1;
                else System.Windows.Forms.MessageBox.Show("No data to check");
            }
        }

        private void buttonGazetteerAcceptUnique_Click(object sender, EventArgs e)
        {
            if (this._DtGazetteer != null)
            {
                // #173
                if (this._DtGazetteer.Rows.Count > 0)
                foreach (System.Data.DataRow R in this._DtGazetteer.Rows)
                {
                    if (R["Number of places"].ToString() == "1")
                        R[0] = 1;
                    else
                        R[0] = 0;
                }
                else
                {
                    System.Windows.Forms.MessageBox.Show("No data to check");
                }
            }
        }

        private void buttonGazetteerCheckNone_Click(object sender, EventArgs e)
        {
            // #173
            if (this._DtGazetteer != null && this._DtGazetteer.Rows.Count > 0)
            {
                foreach (System.Data.DataRow R in this._DtGazetteer.Rows)
                    R[0] = 0;
            }
            else System.Windows.Forms.MessageBox.Show("No data to check");
        }

        private void buttonGazetteerSelectFromList_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.dataGridViewGazetteer.Rows.Count == 0)
                    return;
                string Name = this.dataGridViewGazetteer.Rows[this.dataGridViewGazetteer.SelectedCells[0].RowIndex].Cells[1].Value.ToString();
                if (this._GazetteerSynonyms.ContainsKey(Name))
                {
                    int i = this.dataGridViewGazetteer.SelectedCells[0].RowIndex;
                    string Message = "Please select the valid name from the list:\r\n" + Name;
                    DiversityWorkbench.Forms.FormSelectTableRow f = new DiversityWorkbench.Forms.FormSelectTableRow(this._GazetteerSynonyms[Name], Message);//, 2, "1", System.Drawing.Color.LightGreen, System.Drawing.Color.LightPink);
                    f.dataGridView.Columns[1].Visible = false;
                    //f.dataGridView.Columns[0].HeaderText = "Name in Gazetteer";
                    //f.dataGridView.Columns[2].Width = 70;
                    f.dataGridView.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                    f.Width = 770;
                    f.dataGridView.Columns[0].Width = f.Width - 370;
                    int Height = (f.dataGridView.Rows[0].Height * (this._GazetteerSynonyms[Name].Rows.Count + 1)) + 100;
                    f.Height = Height;
                    f.ForeColor = System.Drawing.Color.DarkBlue;
                    f.StartPosition = FormStartPosition.CenterParent;
                    f.ShowDialog();
                    if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                    {
                        System.Data.DataRow Rselected = f.SelectedRow;
                        this._DtGazetteer.Rows[i]["OK"] = true;
                        this._DtGazetteer.Rows[i]["Place in Gazeteer"] = Rselected["Name"].ToString();
                        this._DtGazetteer.Rows[i]["URI"] = Rselected["URI"].ToString();
                        this._DtGazetteer.Rows[i]["Latitude"] = Rselected["Latitude"].ToString();
                        this._DtGazetteer.Rows[i]["Longitude"] = Rselected["Longitude"].ToString();
                    }
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        private void dataGridViewGazetteer_CellClick(object sender, DataGridViewCellEventArgs e)
        {
            if (this.dataGridViewGazetteer.Rows[this.dataGridViewGazetteer.SelectedCells[0].RowIndex].Cells[5].Value.ToString() != "1")
                this.buttonGazetteerSelectFromList.Visible = true;
            else
                this.buttonGazetteerSelectFromList.Visible = false;
        }

        private void comboBoxGazetteerDatabase_SelectionChangeCommitted(object sender, EventArgs e)
        {
            string SQL = "SELECT CAST(NULL AS int) AS ProjectID, '' AS Project UNION SELECT ProjectID, Project FROM ProjectProxy ORDER BY Project";
            string DB = this.comboBoxGazetteerDatabase.SelectedItem.ToString();
            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList()[DB].LinkedServer.Length > 0)
            {
                SQL = "SELECT CAST(NULL AS int) AS ProjectID, '' AS Project UNION SELECT ProjectID, Project FROM " + DB + ".dbo.ProjectProxy ORDER BY Project";
            }
            System.Data.DataTable dtProject = new DataTable();
            Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, this.GazetteerViaTextConnectionString());
            ad.Fill(dtProject);
            this.comboBoxGazetteerProject.DataSource = dtProject;
            this.comboBoxGazetteerProject.DisplayMember = "Project";
            this.comboBoxGazetteerProject.ValueMember = "ProjectID";

            this.labelGazetteerDatabase.Text = "Database:\r\n";
            DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList()[this.comboBoxGazetteerDatabase.SelectedItem.ToString()];
            if (SC.LinkedServer.Length > 0)
                this.labelGazetteerDatabase.Text += SC.DatabaseName;
        }

        private int? GazetteerProject()
        {
            if (this.comboBoxGazetteerProject.SelectedIndex > 0)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxGazetteerProject.SelectedItem;
                int P = int.Parse(R["ProjectID"].ToString());
                return P;
            }
            else return null;
        }

        private void comboBoxGazetteerCountry_DropDown(object sender, EventArgs e)
        {
            if (this.comboBoxGazetteerForProject.SelectedValue == null)
            {
                System.Windows.Forms.MessageBox.Show("Please select a project");
                return;
            }
            string SQL = "SELECT NULL AS CountryCache " +
                " UNION " +
                " SELECT DISTINCT E.CountryCache " +
                " FROM CollectionEvent E, CollectionSpecimen S, CollectionProject P " +
                " WHERE CountryCache <> '' " +
                " AND E.CollectionEventID = S.CollectionEventID " +
                " AND S.CollectionSpecimenID = P.CollectionSpecimenID " +
                " AND P.ProjectID = " + this.comboBoxGazetteerForProject.SelectedValue.ToString() +
                " ORDER BY CountryCache";
            try
            {
                System.Data.DataTable dt = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                this.comboBoxGazetteerCountry.DataSource = dt;
                this.comboBoxGazetteerCountry.DisplayMember = "CountryCache";
                this.comboBoxGazetteerCountry.ValueMember = "CountryCache";
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void comboBoxGazetteerCountryInGazetteer_DropDown(object sender, EventArgs e)
        {
            DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList()[this.comboBoxGazetteerDatabase.Text];
            string Prefix = SC.DatabaseName + ".dbo.";
            if (SC.LinkedServer.Length > 0)
                Prefix = "[" + SC.LinkedServer + "]." + Prefix;
            string SQL = "SELECT DISTINCT C.Country " +
                "FROM " + Prefix + "GeoCache AS C ";
            if (this.comboBoxGazetteerCountryInGazetteer.Text.Length > 0)
                SQL += " WHERE C.Country LIKE '" + this.comboBoxGazetteerCountryInGazetteer.Text + "%' ";
            SQL += "ORDER BY C.Country";
            System.Data.DataTable dt = new DataTable();
            Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, this.GazetteerViaTextConnectionString());
            ad.Fill(dt);
            this.comboBoxGazetteerCountryInGazetteer.DataSource = dt;
            this.comboBoxGazetteerCountryInGazetteer.DisplayMember = "Country";
            this.comboBoxGazetteerCountryInGazetteer.ValueMember = "Country";
        }

        #endregion

        #region TK25 - moved to section Coordinates, not included any more, obsolete

        private void comboBoxSynColGazTK25Database_SelectionChangeCommitted(object sender, EventArgs e)
        {
            this.ResetTK25();

            this.labelSynColGazTK25Database.Text = "Database:";
            DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList()[this.comboBoxSynColGazTK25Database.SelectedItem.ToString()];
            if (SC.LinkedServer.Length > 0)
                this.labelSynColGazTK25Database.Text += SC.DatabaseName;
        }

        private void comboBoxSynColGazTK25Project_SelectionChangeCommitted(object sender, EventArgs e)
        {
            this.ResetTK25();
        }

        private void checkBoxSynColGazTK25Restrict_CheckedChanged(object sender, EventArgs e)
        {
            this.ResetTK25();
        }

        private void buttonSynColGazTK25Search_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            try
            {
                bool OK = true;

                string SQL = "SELECT ";
                if (this.checkBoxSynColGazTK25Restrict.Checked)
                    SQL += " TOP " + this.numericUpDownSynColGazTK25Restrict.Value.ToString() + " ";
                SQL += " CAST(1 AS bit) AS OK, L.Location1 AS [TK25], L.Location2 AS [Quadrant], " +
                        " L.AverageLatitudeCache AS [Latitude in Collection], CAST(0 AS float) AS [Latitude in Gazetteer], " +
                        " L.AverageLongitudeCache AS [Longitude in Collection], CAST(0 AS float) AS [Longitude in Gazetteer], " +
                        " L.Geography.ToString() AS [Geography in Collection], '' AS [Geography in Gazetteer] ";
                SQL += ", CASE WHEN MIN(S.AccessionNumber) = MAX(S.AccessionNumber) THEN MAX(S.AccessionNumber) ELSE MIN(S.AccessionNumber) + ' - ' + MAX(S.AccessionNumber) END AS AccessionNumbers, COUNT(*) AS Anzahl ";
                SQL += this.SqlGazetteerTK25FromAndWhere();
                SQL += " GROUP BY L.Location1, L.Location2, " +
                    "L.AverageLatitudeCache, L.AverageLongitudeCache, L.Geography.ToString() ";
                SQL += " ORDER BY L.Location1, L.Location2";

                this._dtSynColGazTK25 = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
                ad.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                try
                {
                    this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                    this.dataGridViewSynColGazTK25.DataSource = null;
                    ad.Fill(this._dtSynColGazTK25);
                    if (this._dtSynColGazTK25.Rows.Count > 0)
                    {
                        this.progressBarSynColGaz.Minimum = 0;
                        this.progressBarSynColGaz.Maximum = this._dtSynColGazTK25.Rows.Count;
                        this.progressBarSynColGaz.Value = 0;
                        System.Collections.Generic.List<System.Data.DataRow> RowsToRemove = new List<DataRow>();
                        string DB = this.comboBoxSynColGazTK25Database.SelectedItem.ToString();// = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseList();
                        string ConnectionString = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList()[DB].ConnectionString;
                        Microsoft.Data.SqlClient.SqlConnection conGaz = new Microsoft.Data.SqlClient.SqlConnection(ConnectionString);
                        Microsoft.Data.SqlClient.SqlCommand cGaz = new Microsoft.Data.SqlClient.SqlCommand("", conGaz);
                        //System.Data.DataTable dtGaz = new DataTable();
                        //Microsoft.Data.SqlClient.SqlDataAdapter adGaz = new Microsoft.Data.SqlClient.SqlDataAdapter("", ConnectionString);
                        conGaz.Open();
                        foreach (System.Data.DataRow R in this._dtSynColGazTK25.Rows)
                        {
                            cGaz.CommandText = "SELECT [dbo].[TK25] ('" + R["TK25"].ToString() + "' ,'" + R["Quadrant"].ToString() + "').ToString()";
                            R["Geography in Gazetteer"] = cGaz.ExecuteScalar().ToString();
                            cGaz.CommandText = "SELECT [dbo].[TK25] ('" + R["TK25"].ToString() + "' ,'" + R["Quadrant"].ToString() + "').EnvelopeCenter().Lat";
                            R["Latitude in Gazetteer"] = cGaz.ExecuteScalar().ToString();
                            cGaz.CommandText = "SELECT [dbo].[TK25] ('" + R["TK25"].ToString() + "' ,'" + R["Quadrant"].ToString() + "').EnvelopeCenter().Long";
                            R["Longitude in Gazetteer"] = cGaz.ExecuteScalar().ToString();
                            //dtGaz.Clear();
                            //adGaz.SelectCommand.CommandText = "SELECT [dbo].[TK25] ('" + R["TK25"].ToString() + "' ,'" + R["Quadrant"].ToString() + "').ToString()";
                            if (this.progressBarSynColGaz.Value < this.progressBarSynColGaz.Maximum)
                                this.progressBarSynColGaz.Value++;
                        }
                        conGaz.Close();
                        conGaz.Dispose();
                        foreach (System.Data.DataRow R in RowsToRemove)
                            R.Delete();
                        this._dtSynColGazTK25.AcceptChanges();
                        this.dataGridViewSynColGazTK25.DataSource = this._dtSynColGazTK25;
                        this.labelSynColGazTK25Result.Text = this._dtSynColGazTK25.Rows.Count.ToString() + " differences found";
                        this.buttonSynColGazTK25Update.Enabled = true;
                        this.dataGridViewSynColGazTK25.Columns[0].AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells;
                        this.dataGridViewSynColGazTK25.ReadOnly = false;
                        foreach (System.Windows.Forms.DataGridViewColumn C in this.dataGridViewSynColGaz.Columns)
                        {
                            C.ReadOnly = true;
                        }
                        this.dataGridViewSynColGazTK25.Columns[0].ReadOnly = false;
                    }
                    else
                    {
                        this.labelSynColGazTK25Result.Text = "No differences found";
                        this.buttonSynColGazTK25Update.Enabled = false;
                    }
                }
                catch (System.Exception ex) { }
                finally
                {
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                }
            }
            catch (System.Exception ex)
            {
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private string SqlGazetteerTK25FromAndWhere()
        {
            string SQL = " FROM CollectionEventLocalisation L  " +
                " INNER JOIN CollectionProject P INNER JOIN " +
                " CollectionSpecimen S ON P.CollectionSpecimenID = S.CollectionSpecimenID ON  " +
                " L.CollectionEventID = S.CollectionEventID " +
                " WHERE (L.LocalisationSystemID = 3) " +
                " AND P.ProjectID = " + this.comboBoxSynColGazTK25Project.SelectedValue.ToString();
            if (this.checkBoxSynColGazTK25RestrictToEmpty.Checked)
                SQL += " AND L.Geography IS NULL ";
            return SQL;
        }

        private void buttonSynColGazTK25selectAll_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColGazTK25.Rows)
            {
                R.Cells[0].Value = true;
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonSynColGazTK25selectNone_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColGazTK25.Rows)
            {
                R.Cells[0].Value = false;
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonSynColGazTK25Update_Click(object sender, EventArgs e)
        {
            try
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                string SQL = "";
                this.progressBarSynColGaz.Minimum = 0;
                this.progressBarSynColGaz.Maximum = this._dtSynColGazTK25.Rows.Count;
                this.progressBarSynColGaz.Value = 0;
                foreach (System.Data.DataRow R in this._dtSynColGazTK25.Rows)
                {
                    if (R[0].ToString().ToLower() == "true")
                    {
                        SQL = this.SqlGazetteerTK25Update(R);
                        DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL);
                    }
                    if (this.progressBarSynColGaz.Value < this.progressBarSynColGaz.Maximum)
                        this.progressBarSynColGaz.Value++;
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
                System.Windows.Forms.MessageBox.Show(this.progressBarSynColGaz.Value.ToString() + " datasets updated");
            }
            this.ResetTK25();
        }

        private string SqlGazetteerTK25Update(System.Data.DataRow R)
        {
            string SQL = "UPDATE L SET " +
                "AverageLatitudeCache = " + R["Latitude in Gazetteer"].ToString() + ", " +
                "AverageLongitudeCache = " + R["Longitude in Gazetteer"].ToString() + ", " +
                "Geography = '" + R["Geography in Gazetteer"].ToString() + "' ";
            SQL += this.SqlGazetteerTK25FromAndWhere();
            SQL += " AND L.Location1 = '" + R["TK25"].ToString() + "'";
            SQL += " AND L.Location2 = '" + R["Quadrant"].ToString() + "'";
            return SQL;
        }

        private void ResetTK25()
        {
            this.buttonSynColGazTK25Update.Enabled = false;
            this.dataGridViewSynColGazTK25.DataSource = null;
        }

        #endregion

        #endregion

        #region References

        private System.Collections.Generic.Dictionary<System.Data.DataRow, System.Data.DataTable> _SynColRefViaTextRowsToDecide;

        private void buttonSynColRefCheck_Click(object sender, EventArgs e)
        {
            try
            {
                string Table = this.comboBoxReferenceTable.Text;
                string SQL = "SELECT DISTINCT ";
                // Column for selection
                SQL += " cast(1 as bit) AS OK, ";
                // Column for title of reference
                SQL += " T." + SynColReferenceDisplayColumn + " AS [Reference in ";
                if (this.checkBoxSynColRefAnnotation.Checked) SQL += "Annotation], ";
                else SQL += this.comboBoxReferenceTable.Text + "], ";
                // Column for title in module or number of titles
                if (this.radioButtonSynColRefViaID.Checked)
                    SQL += "'' AS [Reference in DiversityReferences], ";
                else
                    SQL += "0 AS [Titles in DiversityReferences], ";
                // Column for URI
                SQL += "T." + this.SynColReferenceLinkColumn + " ";
                SQL += this.FromClauseForReferences;
                this._dtSynColRef = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(this._dtSynColRef);
                this.dataGridViewSynColRef.Columns.Clear();
                this.dataGridViewSynColRef.DataSource = null;
                this.dataGridViewSynColRef.DataSource = this._dtSynColRef;
                foreach (System.Windows.Forms.DataGridViewColumn Col in this.dataGridViewSynColRef.Columns)
                {
                    Col.ReadOnly = true;
                    Col.SortMode = DataGridViewColumnSortMode.NotSortable;
                }
                this.dataGridViewSynColRef.Columns[0].ReadOnly = false;
                this.progressBarSynColRef.Value = 0;
                this.progressBarSynColRef.Maximum = this._dtSynColRef.Rows.Count;

                System.Collections.Generic.List<System.Data.DataRow> RowsToDelete = new List<DataRow>();
                string RefConnectionString = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityReferences"].ServerConnectionList()[this.comboBoxSynColRefDatabase.Text].ConnectionString;
                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(RefConnectionString);
                Microsoft.Data.SqlClient.SqlDataAdapter adViaText = new Microsoft.Data.SqlClient.SqlDataAdapter("", con);
                con.Open();
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand("", con);


                try
                {
                    if (this._dtSynColRef.Rows.Count > 0)
                    {
                        this._SynColRefViaTextRowsToDecide = new Dictionary<DataRow, DataTable>();
                        DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityReferences"].ServerConnectionList()[this.comboBoxSynColRefDatabase.Text];
                        string Prefix = SC.DatabaseName + ".dbo.";
                        if (SC.LinkedServer.Length > 0)
                            Prefix = "[" + SC.LinkedServer + "]." + Prefix;
                        foreach (System.Data.DataRow R in this._dtSynColRef.Rows)
                        {
                            if (this.radioButtonSynColRefViaID.Checked)
                            {
                                string RefID = DiversityWorkbench.WorkbenchUnit.getIDFromURI(R[3].ToString());
                                SQL = "SELECT T.RefDescription_Cache FROM " + Prefix + "ReferenceTitle T " +
                                    " WHERE T.RefID = " + RefID;
                                string RefDescription = "";
                                try
                                {
                                    C.CommandText = SQL;
                                    RefDescription = C.ExecuteScalar()?.ToString() ?? string.Empty;
                                }
                                catch (System.Exception ex)
                                {
                                    //RowsToDelete.Add(R);
                                }


                                if (RefDescription.Trim() == R[1].ToString().Trim() || RefDescription.Length == 0)
                                {
                                    RowsToDelete.Add(R);
                                }
                                else
                                {
                                    R[2] = RefDescription.Trim();
                                    if (R[2].ToString().Length == 0)
                                        RowsToDelete.Add(R);
                                }
                            }
                            else
                            {
                                System.Data.DataTable dt = new DataTable();
                                SQL = "SELECT U.BaseURL + CAST(T.RefID AS varchar) AS URL, Ref_Type_Enum.Label AS Type, T.Title, T.DateYear AS [Year], T.SourceTitle AS [Source title], T.SeriesTitle AS [Series title], T.Periodical, T.Volume, T.Issue, " +
                                    "T.Pages, T.Publisher, T.PublPlace AS [Publication place], T.Edition, T.Language, MIN(P.Project) AS Project " +
                                    "FROM " +
                                    Prefix + "ViewBaseURL AS U, " +
                                    Prefix + "ReferenceTitle AS T INNER JOIN " +
                                    Prefix + "Ref_Type_Enum ON T.RefType = Ref_Type_Enum.RefType INNER JOIN " +
                                    Prefix + "ReferenceProject ON T.RefID = ReferenceProject.RefID INNER JOIN " +
                                    Prefix + "ProjectProxy AS P ON ReferenceProject.ProjectID = P.ProjectID " +
                                    "WHERE T.RefDescription_Cache = N'" + R[1].ToString() + "' " +
                                    "GROUP BY U.BaseURL + CAST(T.RefID AS varchar), T.Title, T.DateYear, T.SourceTitle, T.SeriesTitle, T.Periodical, T.Volume, T.Issue, T.Pages, T.Publisher, T.PublPlace,  " +
                                    "T.Edition, T.Language, Ref_Type_Enum.Label ";
                                adViaText.SelectCommand.CommandText = SQL;
                                adViaText.Fill(dt);
                                if (dt.Rows.Count == 1)
                                {
                                    R[0] = true;
                                    R[2] = 1;
                                    R[3] = dt.Rows[0][0].ToString();
                                }
                                else if (dt.Rows.Count == 0)
                                {
                                    RowsToDelete.Add(R);
                                }
                                else
                                {
                                    R[0] = false;
                                    R[2] = dt.Rows.Count;
                                    this._SynColRefViaTextRowsToDecide.Add(R, dt);
                                }
                            }
                            //C.CommandText = SQL;
                            if (this.progressBarSynColRef.Value < this.progressBarSynColRef.Maximum)
                                this.progressBarSynColRef.Value++;
                        }
                    }
                }
                catch (System.Exception ex)
                {
                }
                finally
                {
                    con.Close();
                    con.Dispose();
                }

                if (RowsToDelete.Count > 0)
                {
                    foreach (System.Data.DataRow R in RowsToDelete)
                        R.Delete();
                }
                this._dtSynColRef.AcceptChanges();

                this.dataGridViewSynColRef.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                if (this._dtSynColRef.Rows.Count > 0)
                {
                    if (this.radioButtonSynColRefViaID.Checked)
                        this.labelSynColRefCheck.Text = this._dtSynColRef.Rows.Count.ToString() + " differences found";
                    else
                        this.labelSynColRefCheck.Text = this._dtSynColRef.Rows.Count.ToString() + " congruences found";
                    this.buttonSynColRefUpdate.Enabled = true;
                }
                else
                {
                    if (this.radioButtonSynColRefViaID.Checked)
                        this.labelSynColRefCheck.Text = "No differences found";
                    else
                        this.labelSynColRefCheck.Text = "No congruences found";
                    this.buttonSynColRefUpdate.Enabled = false;
                }
            }
            catch (System.Exception ex) { }
        }

        private void buttonSynColRefUpdate_Click(object sender, EventArgs e)
        {
            string Table = this.comboBoxReferenceTable.Text;

            this.dataGridViewSynColRef.DataSource = this._dtSynColRef;
            this.progressBarSynColRef.Value = 0;
            this.progressBarSynColRef.Maximum = this._dtSynColRef.Rows.Count;

            Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand("", con);
            con.Open();

            try
            {
                foreach (System.Data.DataRow R in this._dtSynColRef.Rows)
                {
                    if (R[0].ToString().ToLower() == "true")
                    {
                        string SQL = "UPDATE T ";
                        if (this.radioButtonSynColRefViaID.Checked)
                        {
                            SQL += "SET T." + SynColReferenceDisplayColumn + " = N'" + R[2].ToString() + "' ";
                            SQL += this.FromClauseForReferences;
                            SQL += " AND T." + SynColReferenceDisplayColumn + " = N'" + R[1].ToString() + "' " +
                                " AND T." + this.SynColReferenceLinkColumn + " = N'" + R[3].ToString() + "'";
                        }
                        else
                        {
                            SQL += "SET T." + this.SynColReferenceLinkColumn + " = N'" + R[3].ToString() + "' ";
                            SQL += this.FromClauseForReferences;
                            SQL += " AND T." + SynColReferenceDisplayColumn + " = N'" + R[1].ToString() + "' " +
                                " AND (T." + this.SynColReferenceLinkColumn + " IS NULL OR T." + this.SynColReferenceLinkColumn + " = '')";
                        }
                        C.CommandText = SQL;
                        C.ExecuteNonQuery();

                    }
                    if (this.progressBarSynColRef.Value < this.progressBarSynColRef.Maximum)
                        this.progressBarSynColRef.Value++;
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
                System.Windows.Forms.MessageBox.Show("Update finished");
                this.dataGridViewSynColRef.DataSource = null;
                con.Close();
            }
        }

        private void buttonSynColRefCheckDataset_Click(object sender, EventArgs e)
        {

        }

        private string _SynColRefBaseURL;
        private string SynColRefBaseURL()
        {
            if (this._SynColRefBaseURL == null)
            {
                string DB = this.comboBoxSynColRefDatabase.SelectedItem.ToString();// = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseList();
                string ConnectionString = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityReferences"].ServerConnectionList()[DB].ConnectionString;
                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(ConnectionString);
                con.Open();
                string SQL = "SELECT dbo.BaseURL()";
                try
                {
                    Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                    this._SynColRefBaseURL = C.ExecuteScalar()?.ToString() ?? string.Empty;
                }
                catch { }
            }
            return this._SynColRefBaseURL;
        }

        private string FromClauseForReferences
        {
            get
            {
                string Table = this.comboBoxReferenceTable.Text;
                string SQL = "";
                if (this.comboBoxReferenceTable.Text.Length == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select the table that should be checked");
                    return "";
                }
                if (this.checkBoxSynColRefAnnotation.Checked)
                {
                    SQL = " FROM Annotation AS T, CollectionProject P, ";
                    switch (Table)
                    {
                        case "IdentificationUnit":
                            SQL += " IdentificationUnit U " +
                                " WHERE T.ReferencedTable = 'IdentificationUnit' " +
                                " AND T.ReferencedID = U.IdentificationUnitID " +
                                " AND U.CollectionSpecimenID = P.CollectionSpecimenID ";
                            break;
                        case "CollectionSpecimen":
                            SQL += " CollectionSpecimen S " +
                                " WHERE T.ReferencedTable = 'CollectionSpecimen' " +
                                " AND T.ReferencedID = S.CollectionSpecimenID " +
                                " AND S.CollectionSpecimenID = P.CollectionSpecimenID";
                            break;
                        case "CollectionSpecimenPart":
                            SQL += " CollectionSpecimenPart S " +
                                " WHERE T.ReferencedTable = 'CollectionSpecimenPart' " +
                                " AND T.ReferencedID = S.SpecimenPartID " +
                                " AND S.CollectionSpecimenID = P.CollectionSpecimenID";
                            break;
                        case "CollectionEvent":
                            SQL += " CollectionSpecimen S, CollectionEvent E " +
                                " WHERE T.ReferencedTable = 'CollectionEvent' " +
                                " AND T.ReferencedID = E.CollectionEventID " +
                                " AND S.CollectionEventID = E.CollectionEventID " +
                                " AND S.CollectionSpecimenID = P.CollectionSpecimenID";
                            break;
                    }
                    SQL += " AND P.ProjectID = " + this.comboBoxSynColRefProject.SelectedValue.ToString();
                    if (this.radioButtonSynColRefViaID.Checked)
                        SQL += " AND T." + this.SynColReferenceLinkColumn + " LIKE '" + this.SynColRefBaseURL() + "%' ";
                    else
                        SQL += " AND (T." + this.SynColReferenceLinkColumn + " IS NULL OR T." + this.SynColReferenceLinkColumn + " = '') " +
                            " AND T." + SynColReferenceDisplayColumn + " <> ''";
                }
                else
                {
                    SQL = " FROM " + Table + " AS T, CollectionProject P ";
                    switch (Table)
                    {
                        case "Identification":
                        case "CollectionSpecimen":
                        case "CollectionSpecimenReference":
                            SQL += " WHERE T.CollectionSpecimenID = P.CollectionSpecimenID";
                            break;
                        case "CollectionEvent":
                            SQL += ", CollectionSpecimen S " +
                                " WHERE S.CollectionEventID = T.CollectionEventID " +
                                " AND S.CollectionSpecimenID = P.CollectionSpecimenID";
                            break;
                    }
                    SQL += " AND P.ProjectID = " + this.comboBoxSynColRefProject.SelectedValue.ToString();
                    if (this.radioButtonSynColRefViaID.Checked)
                        SQL += " AND T." + this.SynColReferenceLinkColumn + " LIKE '" + this.SynColRefBaseURL() + "%' ";
                    else
                        SQL += " AND (T." + this.SynColReferenceLinkColumn + " IS NULL OR T." + this.SynColReferenceLinkColumn + " = '')" +
                            " AND T." + SynColReferenceDisplayColumn + " <> ''";
                }
                return SQL;
            }
        }

        private void buttonSynColRefSelectNone_Click(object sender, EventArgs e)
        {
            // #173
            if (this.dataGridViewSynColRef.DataSource == null) return;

            // nicht sichtbar: erst bei Bedarf - normalerweise wird man alle aktualisieren wollen
            try
            {
                System.Data.DataTable dt = (System.Data.DataTable)this.dataGridViewSynColRef.DataSource;
                foreach (System.Data.DataRow R in dt.Rows)
                {
                    R[0] = false;
                }
            }
            catch (System.Exception ex) { }
        }

        private void buttonSynColRefSelectAll_Click(object sender, EventArgs e)
        {
            // #173
            if (this.dataGridViewSynColRef.DataSource == null) return;

            // nicht sichtbar: erst bei Bedarf - normalerweise wird man alle aktualisieren wollen
            try
            {
                System.Data.DataTable dt = (System.Data.DataTable)this.dataGridViewSynColRef.DataSource;
                foreach (System.Data.DataRow R in dt.Rows)
                {
                    R[0] = true;
                }
            }
            catch (System.Exception ex) { }
        }

        private string SynColReferenceDisplayColumn
        {
            get
            {
                string SQL = "";
                if (this.checkBoxSynColRefAnnotation.Checked)
                    SQL = "ReferenceDisplayText";
                else
                {
                    switch (this.comboBoxReferenceTable.Text)
                    {
                        default:
                            SQL += "ReferenceTitle";
                            break;
                    }
                }
                return SQL;
            }
        }

        private string SynColReferenceLinkColumn
        {
            get
            {
                string SQL = "";
                switch (this.comboBoxReferenceTable.Text)
                {
                    default:
                        SQL += "ReferenceURI";
                        break;
                }
                return SQL;
            }
        }

        private void comboBoxSynColRefDatabase_SelectionChangeCommitted(object sender, EventArgs e)
        {
            try
            {
                if (this._SynColRefBaseURL != null)
                    this._SynColRefBaseURL = null;
                if (this._dtSynColRef != null)
                    this._dtSynColRef.Clear();
                this.dataGridViewSynColRef.DataSource = null;
                this.buttonSynColRefUpdate.Enabled = false;

                this.labelSynColRefDatabase.Text = "Database:";
                DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityReferences"].ServerConnectionList()[this.comboBoxSynColRefDatabase.SelectedItem.ToString()];
                if (SC.LinkedServer.Length > 0)
                    this.labelSynColRefDatabase.Text += SC.DatabaseName;
            }
            catch (System.Exception ex)
            {
            }
        }

        private void comboBoxReferenceTable_SelectionChangeCommitted(object sender, EventArgs e)
        {
            if (this._dtSynColRef != null)
                this._dtSynColRef.Clear();
            this.dataGridViewSynColRef.DataSource = null;
            this.buttonSynColRefUpdate.Enabled = false;
        }

        private void comboBoxSynColRefProject_SelectionChangeCommitted(object sender, EventArgs e)
        {
            if (this._dtSynColRef != null)
                this._dtSynColRef.Clear();
            this.dataGridViewSynColRef.DataSource = null;
            this.buttonSynColRefUpdate.Enabled = false;
        }

        private void checkBoxSynColRefAnnotation_CheckedChanged(object sender, EventArgs e)
        {
            this.comboBoxReferenceTable.Items.Clear();
            this.comboBoxReferenceTable.Items.Add("CollectionEvent");
            if (this._dtSynColRef != null)
                this._dtSynColRef.Clear();
            this.buttonSynColRefUpdate.Enabled = false;
            this.dataGridViewSynColRef.DataSource = null;
            if (this.checkBoxSynColRefAnnotation.Checked)
            {
                this.comboBoxReferenceTable.Items.Add("CollectionSpecimen");
                this.comboBoxReferenceTable.Items.Add("CollectionSpecimenPart"); ;
                this.comboBoxReferenceTable.Items.Add("IdentificationUnit");
                this.labelReferenceTable.Text = "Annotations of:";
                this.comboBoxReferenceTable.BackColor = System.Drawing.SystemColors.Info;
            }
            else
            {
                this.comboBoxReferenceTable.Items.Add("CollectionSpecimenReference");
                //this.comboBoxReferenceTable.Items.Add("Identification");
                this.labelReferenceTable.Text = "Table";
                this.comboBoxReferenceTable.BackColor = System.Drawing.Color.White;
            }
            this.comboBoxReferenceTable.Text = "";
        }

        private void radioButtonSynColRefViaID_Click(object sender, EventArgs e)
        {
            this.setSynColRefTarget();
        }

        private void radioButtonSynColRefViaText_Click(object sender, EventArgs e)
        {
            this.setSynColRefTarget();
        }

        private void setSynColRefTarget()
        {
            if (this._dtSynColRef != null)
                this._dtSynColRef.Clear();
            this.dataGridViewSynColRef.DataSource = null;
            this.buttonSynColRefUpdate.Enabled = false;
            this.buttonSynColRefSelectValid.Visible = !this.radioButtonSynColRefViaID.Checked;
            if (this.radioButtonSynColRefViaID.Checked)
                this.buttonSynColRefCheck.Text = "Check for differences";
            else this.buttonSynColRefCheck.Text = "Search for congruence";
        }

        private void buttonSynColRefSelectValid_Click(object sender, EventArgs e)
        {
            try
            {
                int i = this.dataGridViewSynColRef.SelectedCells[0].RowIndex;
                System.Data.DataRow R = this._dtSynColRef.Rows[i];
                if (this._SynColRefViaTextRowsToDecide != null && _SynColRefViaTextRowsToDecide.ContainsKey(R))
                {
                    string Message = "Please select the valid reference from the list";
                    DiversityWorkbench.Forms.FormSelectTableRow f = new DiversityWorkbench.Forms.FormSelectTableRow(this._SynColRefViaTextRowsToDecide[R], Message);//, 2, "1", System.Drawing.Color.LightGreen, System.Drawing.Color.LightPink);
                    f.dataGridView.Columns[0].Visible = false;
                    f.dataGridView.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                    f.Width = 1470;
                    int Height = (f.dataGridView.Rows[0].Height * (this._SynColRefViaTextRowsToDecide[R].Rows.Count + 1)) + 100;
                    f.Height = Height;
                    f.ForeColor = System.Drawing.Color.DarkBlue;
                    f.StartPosition = FormStartPosition.CenterParent;
                    f.ShowDialog();
                    if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                    {
                        R[0] = true;
                        R[3] = f.SelectedRow[0].ToString();
                    }
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        #endregion

        #region Agents

        #region Via URI

        private void comboBoxSynColAgeDatabase_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.labelSynColAgeDatabase.Text = "Database:";
            DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityAgents"].ServerConnectionList()[this.comboBoxSynColAgeDatabase.SelectedItem.ToString()];
            if (SC.LinkedServer.Length > 0)
                this.labelSynColAgeDatabase.Text += SC.DatabaseName;
        }

        private void buttonSynColAgeCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSynColAge.SelectedRows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewSynColAge.SelectedRows[0];
            bool OK = true;
            try { string test = R.Cells["CollectionSpecimenID"].Value.ToString(); }
            catch { OK = false; }
            if (OK)
            {
                if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
                {
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                else
                    this.DialogResult = DialogResult.Cancel;
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            }
        }

        private void buttonSynColAgeCheck_Click(object sender, EventArgs e)
        {
            if (this.comboBoxSynColAgeTable.Text.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select the table that should be checked");
                return;
            }
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            string DB = this.comboBoxSynColAgeDatabase.SelectedItem.ToString();// = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseList();
            DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityAgents"].ServerConnectionList()[DB];
            //string ConnectionString = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityAgents"].ServerConnectionList()[DB].ConnectionString;
            Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(SC.ConnectionString);
            con.Open();
            string SQL = "SELECT dbo.BaseURL()";
            if (SC.LinkedServer.Length > 0)
                SQL = "SELECT BaseURL FROM [" + SC.LinkedServer + "].[" + SC.DatabaseName + "].dbo.ViewBaseURL";
            string BaseURL = "";
            try
            {
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                BaseURL = C.ExecuteScalar()?.ToString();
            }
            catch { }
            string Table = this.comboBoxSynColAgeTable.Text;
            SQL = "SELECT cast(1 as bit) AS OK, ";
            //if (!this.checkBoxSynColAgeIncludeAccNr.Checked) SQL += " DISTINCT cast(1 as bit) AS OK,";
            SQL += " A." + this.SynColAgentDisplayColumn;
            SQL += " AS [";
            switch (Table)
            {
                case "Collection":
                    SQL += "Administrator of the collection";
                    break;
                case "CollectionAgent":
                    SQL += "Name of the collector";
                    break;
                case "CollectionEventLocalisation":
                case "CollectionEventProperty":
                case "CollectionSpecimenProcessing":
                case "IdentificationUnitAnalysis":
                case "Identification":
                    SQL += "Name of the responsible person";
                    break;
                case "CollectionSpecimen":
                    SQL += "Name of the depositor";
                    break;
                case "Transaction":
                    SQL += this.comboBoxSynColAgeColumn.Text;
                    break;
                case "CollectionSpecimenImage":
                    SQL += "Name of the creator";
                    break;
            }
            SQL += " in DiversityCollection] ";
            SQL += ", ";
            SQL += " '' AS [Name of the agent in the module DiversityAgents], ";
            SQL += this.SynColAgentLinkColumn;
            SQL += " AS URI ";
            if (this.checkBoxSynColAgeIncludeAccNr.Visible && this.checkBoxSynColAgeIncludeAccNr.Checked)
                SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";
            SQL += " FROM [" + Table + "] AS A ";
            int ProjectID = 0;
            //if (int.TryParse(this.comboBoxSynColAgeProject.SelectedValue.ToString(), out ProjectID)
            //    && Table != "Collection" && Table != "Transaction")
            //    SQL += ", CollectionProject P ";
            if (this.comboBoxSynColAgeProject.SelectedItem != null)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColAgeProject.SelectedItem;
                if (int.TryParse(R["ProjectID"].ToString(), out ProjectID)
                && Table != "Collection" && Table != "Transaction")
                    SQL += ", CollectionProject P ";
            }
            if (this.checkBoxSynColAgeIncludeAccNr.Visible && this.checkBoxSynColAgeIncludeAccNr.Checked)
                SQL += ", CollectionSpecimen S ";
            SQL += " WHERE A." + this.SynColAgentLinkColumn;
            SQL += " LIKE '" + BaseURL + "%' ";
            if (Table != "Collection" && Table != "Transaction")
                SQL += " AND P.ProjectID = " + ProjectID.ToString() + " AND P.CollectionSpecimenID = A.CollectionSpecimenID";

            if (this.checkBoxSynColAgeIncludeAccNr.Visible && this.checkBoxSynColAgeIncludeAccNr.Checked)
                SQL += " AND A.CollectionSpecimenID = S.CollectionSpecimenID ";
            SQL += " GROUP BY " + this.SynColAgentDisplayColumn + ", " + this.SynColAgentLinkColumn;
            if (this.checkBoxSynColAgeIncludeAccNr.Visible && this.checkBoxSynColAgeIncludeAccNr.Checked)
                SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";

            this._dtSynColAge = new DataTable();
            try
            {
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
                ad.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                ad.Fill(this._dtSynColAge);
                this.dataGridViewSynColAge.DataSource = this._dtSynColAge;
                this.dataGridViewSynColAge.Columns[0].Width = 30;
                this.dataGridViewSynColAge.ReadOnly = false;
                this.dataGridViewSynColAge.Columns[0].ReadOnly = false;
                this.dataGridViewSynColAge.Columns[1].ReadOnly = true;
                this.dataGridViewSynColAge.Columns[2].ReadOnly = true;
                this.dataGridViewSynColAge.Columns[3].ReadOnly = true;
                if (this._dtSynColAge.Rows.Count > 0)
                {
                    this.CompareAgentWithSource();
                    if (this._dtSynColAge.Rows.Count > 0)
                    {
                        this.labelSynColAgeCheck.Text = this._dtSynColAge.Rows.Count.ToString() + " differences found";
                        this.buttonSynColAgeUpdate.Enabled = true;
                        for (int i = 1; i < this.dataGridViewSynColAge.ColumnCount; i++)
                        {
                            this.dataGridViewSynColAge.Columns[i].Width = (int)(this.dataGridViewSynColAge.Width - this.dataGridViewSynColAge.RowHeadersWidth - 20) / this.dataGridViewSynColAge.ColumnCount;
                        }
                    }
                    else
                    {
                        this.labelSynColAgeCheck.Text = "No differences found";
                        this.buttonSynColAgeUpdate.Enabled = false;
                    }
                    //this.labelSynColAgeCheck.Text = this._dtSynColAge.Rows.Count.ToString() + " differences found";
                    //this.buttonSynColAgeUpdate.Enabled = true;
                    //if (this._dtSynColAge.Columns.Count > 0)
                    //{
                    //    for (int i = 1; i < this.dataGridViewSynColAge.ColumnCount; i++)
                    //    {
                    //        this.dataGridViewSynColAge.Columns[i].Width = (int)(this.dataGridViewSynColAge.Width - this.dataGridViewSynColAge.RowHeadersWidth - 20) / this.dataGridViewSynColAge.ColumnCount;
                    //    }
                    //}
                }
                else
                {
                    this.labelSynColAgeCheck.Text = "No differences found";
                    this.buttonSynColAgeUpdate.Enabled = false;
                }
            }
            catch (System.Exception ex)
            {
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;

        }

        private string SynColAgentDisplayColumn
        {
            get
            {
                string SQL = "";
                switch (this.comboBoxSynColAgeTable.Text)
                {
                    case "Collection":
                        SQL += "AdministrativeContactName";
                        break;
                    case "CollectionAgent":
                        SQL += "CollectorsName";
                        break;
                    case "CollectionEventLocalisation":
                    case "CollectionEventProperty":
                    case "CollectionSpecimenProcessing":
                    case "IdentificationUnitAnalysis":
                    case "Identification":
                        SQL += "ResponsibleName";
                        break;
                    case "CollectionSpecimen":
                        SQL += "DepositorsName";
                        break;
                    case "Transaction":
                        SQL += this.comboBoxSynColAgeColumn.Text;
                        break;
                    case "CollectionSpecimenImage":
                        SQL += "CreatorAgent";
                        break;
                }
                return SQL;
            }
        }

        private string SynColAgentLinkColumn
        {
            get
            {
                string SQL = "";
                switch (this.comboBoxSynColAgeTable.Text)
                {
                    case "Collection":
                        SQL += "AdministrativeContactAgentURI";
                        break;
                    case "CollectionAgent":
                        SQL += "CollectorsAgentURI";
                        break;
                    case "CollectionEventLocalisation":
                    case "IdentificationUnitAnalysis":
                    case "CollectionSpecimenProcessing":
                    case "Identification":
                    case "CollectionEventProperty":
                        SQL += "ResponsibleAgentURI";
                        break;
                    case "CollectionSpecimen":
                        SQL += "DepositorsAgentURI";
                        break;
                    case "Transaction":
                        switch (this.comboBoxSynColAgeColumn.Text)
                        {
                            case "ToTransactionPartnerName":
                                SQL += "ToTransactionPartnerAgentURI";
                                break;
                            case "FromTransactionPartnerName":
                                SQL += "FromTransactionPartnerAgentURI";
                                break;
                            case "ResponsibleName":
                                SQL += "ResponsibleAgentURI";
                                break;
                        }
                        break;
                    case "CollectionSpecimenImage":
                        SQL += "CreatorAgentURI";
                        break;
                }
                return SQL;
            }
        }

        private void CompareAgentWithSource()
        {
            string DB = this.comboBoxSynColAgeDatabase.SelectedItem.ToString();// = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseList();
            string ConnectionString = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityAgents"].ServerConnectionList()[DB].ConnectionString;
            Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(ConnectionString);
            con.Open();
            //string SQL = "SELECT dbo.DefaultAgentNameDisplayType()";
            DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityAgents"].ServerConnectionList()[this.comboBoxSynColAgeDatabase.SelectedItem.ToString()];
            string Prefix = SC.DatabaseName + ".dbo.";
            if (SC.LinkedServer.Length > 0)
                Prefix = "[" + SC.LinkedServer + "]." + Prefix;
            string SQL = "SELECT DefaultAgentNameDisplayType from " + Prefix + "ViewDefaultAgentNameDisplayType";
            string DefaultAgentNameDisplayType = "";
            try
            {
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                DefaultAgentNameDisplayType = C.ExecuteScalar()?.ToString() ?? string.Empty;
            }
            catch { }
            if (DefaultAgentNameDisplayType == "") DefaultAgentNameDisplayType = "Ii, G.";

            this.progressBarSynColAge.Value = 0;
            this.progressBarSynColAge.Maximum = this._dtSynColAge.Rows.Count;
            foreach (System.Data.DataRow R in this._dtSynColAge.Rows)
            {
                R[2] = this.AgentNameFromDiversityAgent(R[3].ToString(), DefaultAgentNameDisplayType, con);
                if (R[1].ToString() == R[2].ToString())
                    R.Delete();
                if (this.progressBarSynColAge.Value < this.progressBarSynColAge.Maximum)
                    this.progressBarSynColAge.Value++;
            }
            this._dtSynColAge.AcceptChanges();
            con.Close();
        }

        private void buttonSynColAgeUpdate_Click(object sender, EventArgs e)
        {
            string Table = this.comboBoxSynColAgeTable.Text;
            this.progressBarSynColAge.Value = 0;
            this.progressBarSynColAge.Maximum = this._dtSynColAge.Rows.Count;
            int iOK = 0;
            int iFailed = 0;
            foreach (System.Data.DataRow R in this._dtSynColAge.Rows)
            {
                if (R[0].ToString().ToLower() == "true")
                {
                    string SQL = "UPDATE T SET T." + this.SynColAgentDisplayColumn + " = N'" + R[2].ToString().Replace("''", "'") + "' " +
                        " FROM [" + Table + "] T ";
                    int ProjectID = 0;
                    //if (int.TryParse(this.comboBoxSynColAgeProject.SelectedValue.ToString(), out ProjectID)
                    //    && Table != "Collection" && Table != "Transaction")
                    //    SQL += ", CollectionProject P ";
                    if (this.comboBoxSynColAgeProject.SelectedItem != null)
                    {
                        System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColAgeProject.SelectedItem;
                        if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID)
                        && Table != "Collection" && Table != "Transaction")
                            SQL += ", CollectionProject P ";
                    }
                    SQL += " WHERE T." + this.SynColAgentDisplayColumn + " = N'" + R[1].ToString().Replace("'", "''") + "' " +
                        " AND T." + this.SynColAgentLinkColumn + " = '" + R[3].ToString() + "' ";
                    if (Table != "Collection" && Table != "Transaction")
                        SQL += " AND P.ProjectID = " + ProjectID.ToString() + " AND P.CollectionSpecimenID = T.CollectionSpecimenID";
                    if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL))
                        iOK++;
                    else iFailed++;
                }
                if (this.progressBarSynColAge.Value < this.progressBarSynColAge.Maximum)
                    this.progressBarSynColAge.Value++;
            }
            this._dtSynColAge.Clear();
            this.buttonSynColAgeUpdate.Enabled = false;
            System.Windows.Forms.MessageBox.Show("Update for " + iOK.ToString() + " datasets done, for " + iFailed.ToString() + " datasets failed");
            this.labelSynColAgeCheck.Text = "Update for " + iOK.ToString() + " datasets done";
            //string Table = this.comboBoxSynColAgeTable.Text;
            //int ProjectID;
            //if (this.comboBoxSynColAgeTable.Text.Length == 0)
            //{
            //    System.Windows.Forms.MessageBox.Show("Please select the table that should be checked");
            //    return;
            //}
            //string SQL = "UPDATE [" + Table + "] SET ";
            //switch (Table)
            //{
            //    case "Collection":
            //        SQL += "AdministrativeContactName";
            //        break;
            //    case "CollectionAgent":
            //        SQL += "CollectorsName";
            //        break;
            //    case "CollectionSpecimenProcessing":
            //    case "CollectionEventLocalisation":
            //    case "CollectionEventProperty":
            //    case "Identification":
            //    case "IdentificationUnitAnalysis":
            //        SQL += "ResponsibleName";
            //        break;
            //    case "CollectionSpecimen":
            //        SQL += "DepositorsName";
            //        break;
            //    case "Transaction":
            //        SQL += this.comboBoxSynColAgeColumn.Text;
            //        break;
            //    case "CollectionSpecimenImage":
            //        SQL += "CreatorAgent";
            //        break;
            //}
            //SQL += " = N.AgentName " +
            //    FromClauseForAgents;
            //SQL += FromUpdateRestrictionForAgents;

            //Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
            //Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
            //try
            //{
            //    this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            //    con.Open();
            //    C.ExecuteNonQuery();
            //    System.Windows.Forms.MessageBox.Show("Update finished");
            //    //string Message = C.ExecuteScalar()?.ToString();
            //    //System.Windows.Forms.MessageBox.Show(Message);
            //}
            //catch (Exception ex)
            //{
            //    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            //    System.Windows.Forms.MessageBox.Show("Update failed: " + ex.Message);
            //}
            //finally
            //{
            //    this.Cursor = System.Windows.Forms.Cursors.Default;
            //    this.dataGridViewSynColAge.DataSource = null;
            //    con.Close();
            //}
        }

        //private string FromClauseForAgentRelatedColumns
        //{
        //    get
        //    {
        //        //string SQL = "SELECT " + this.comboBoxSynColAgeDatabase.Text + ".dbo.DefaultAgentNameDisplayType()";
        //        //string DefaultAgentNameDisplayType = "";
        //        //Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
        //        //try
        //        //{
        //        //    con.Open();
        //        //    Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
        //        //    DefaultAgentNameDisplayType = C.ExecuteScalar()?.ToString();
        //        //    con.Close();
        //        //}
        //        //catch { }
        //        //if (DefaultAgentNameDisplayType == "") DefaultAgentNameDisplayType = "Ii, G.";
        //        string Table = this.comboBoxSynColAgeTable.Text;
        //        int ProjectID;
        //        if (this.comboBoxSynColAgeTable.Text.Length == 0)
        //        {
        //            System.Windows.Forms.MessageBox.Show("Please select the table that should be checked");
        //            return "";
        //        }
        //        string SQL = " FROM [" + Table + "] AS A ";
        //        switch (Table)
        //        {
        //            case "IdentificationUnitAnalysis":
        //            case "CollectionSpecimenProcessing":
        //            case "Identification":
        //            case "CollectionSpecimenImage":
        //            case "CollectionAgent":
        //                SQL += "  INNER JOIN CollectionSpecimen AS S ON A.CollectionSpecimenID = S.CollectionSpecimenID ";
        //                if (int.TryParse(this.comboBoxSynColAgeProject.SelectedValue.ToString(), out ProjectID))
        //                    SQL += " INNER JOIN CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID ";
        //                break;
        //            case "CollectionEventLocalisation":
        //            case "CollectionEventProperty":
        //                SQL += " INNER JOIN CollectionEvent AS E ON A.CollectionEventID = E.CollectionEventID INNER JOIN CollectionSpecimen S ON E.CollectionEventID = S.CollectionEventID ";
        //                if (int.TryParse(this.comboBoxSynColAgeProject.SelectedValue.ToString(), out ProjectID))
        //                    SQL += " INNER JOIN CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID ";
        //                break;
        //            case "CollectionSpecimen":
        //                if (int.TryParse(this.comboBoxSynColAgeProject.SelectedValue.ToString(), out ProjectID))
        //                    SQL += " INNER JOIN CollectionProject AS P ON A.CollectionSpecimenID = P.CollectionSpecimenID ";
        //                break;
        //            case "Collection":
        //            case "Transaction":
        //                break;
        //        }
        //        //}
        //        SQL += " INNER JOIN " + this.comboBoxSynColAgeDatabase.Text + ".dbo.AgentNames('" + DefaultAgentNameDisplayType + "') N ON A.";
        //        switch (Table)
        //        {
        //            case "Collection":
        //                SQL += "AdministrativeContactAgentURI";
        //                break;
        //            case "CollectionAgent":
        //                SQL += "CollectorsAgentURI";
        //                break;
        //            case "CollectionEventLocalisation":
        //            case "IdentificationUnitAnalysis":
        //            case "CollectionSpecimenProcessing":
        //            case "Identification":
        //            case "CollectionEventProperty":
        //                SQL += "ResponsibleAgentURI";
        //                break;
        //            case "CollectionSpecimen":
        //                SQL += "DepositorsAgentURI";
        //                break;
        //            case "Transaction":
        //                switch (this.comboBoxSynColAgeColumn.Text)
        //                {
        //                    case "ToTransactionPartnerName":
        //                        SQL += "ToTransactionPartnerAgentURI";
        //                        break;
        //                    case "FromTransactionPartnerName":
        //                        SQL += "FromTransactionPartnerAgentURI";
        //                        break;
        //                    case "ResponsibleName":
        //                        SQL += "ResponsibleAgentURI";
        //                        break;
        //                }
        //                break;
        //            case "CollectionSpecimenImage":
        //                SQL += "CreatorAgentURI";
        //                break;
        //        }
        //        SQL += " = " + this.comboBoxSynColAgeDatabase.Text + ".dbo.BaseURL() + CAST(N.AgentID AS VARCHAR) " +
        //            "AND N.AgentName <> A.";
        //        switch (Table)
        //        {
        //            case "Collection":
        //                SQL += "AdministrativeContactName";
        //                break;
        //            case "CollectionAgent":
        //                SQL += "CollectorsName";
        //                break;
        //            case "CollectionEventLocalisation":
        //            case "CollectionEventProperty":
        //            case "CollectionSpecimenProcessing":
        //            case "IdentificationUnitAnalysis":
        //            case "Identification":
        //                SQL += "ResponsibleName";
        //                break;
        //            case "CollectionSpecimen":
        //                SQL += "DepositorsName";
        //                break;
        //            case "Transaction":
        //                SQL += this.comboBoxSynColAgeColumn.Text;
        //                break;
        //            case "CollectionSpecimenImage":
        //                SQL += "CreatorAgent";
        //                break;
        //        }
        //        if (int.TryParse(this.comboBoxSynColAgeProject.SelectedValue.ToString(), out ProjectID)
        //            && Table != "Collection" && Table != "Transaction")
        //            SQL += " WHERE P.ProjectID = " + ProjectID.ToString();
        //        return SQL;
        //    }
        //}

        private string AgentNameFromDiversityAgent(string URI, string DefaultAgentNameDisplayType, Microsoft.Data.SqlClient.SqlConnection con)
        {
            DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityAgents"].ServerConnectionList()[this.comboBoxSynColAgeDatabase.SelectedItem.ToString()];
            string Prefix = SC.DatabaseName + ".dbo.";
            if (SC.LinkedServer.Length > 0)
                Prefix = "[" + SC.LinkedServer + "]." + Prefix;
            string Agent = "";
            //string SQL = "select AgentName from dbo.AgentNames('Ii, G.') N where N.AgentID = " + DiversityWorkbench.WorkbenchUnit.getIDFromURI(URI);
            string SQL = "select AgentName from " + Prefix + "ViewAgentNames N where N.AgentID = " + DiversityWorkbench.WorkbenchUnit.getIDFromURI(URI);
            try
            {
                //TODO Ariane evtl. auf folgendes umstellen
                //string databaseName = SC.DatabaseName;
                //string processedDatabaseName = databaseName.Replace("diversity", "", StringComparison.OrdinalIgnoreCase).Trim();
                //string agentId = DiversityWorkbench.WorkbenchUnit.getIDFromURIAndDatabase(URI, processedDatabaseName);
                //if (string.IsNullOrEmpty(agentId))
                //    return Agent;
                //string SQL = "select AgentName from " + Prefix + "ViewAgentNames N where N.AgentID = " +
                //             agentId;

                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                Agent = C.ExecuteScalar()?.ToString() ?? string.Empty;
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex, URI);
            }
            return Agent;
        }

        //private string FromClauseForAgents
        //{
        //    get
        //    {
        //        string SQL = "SELECT " + this.comboBoxSynColAgeDatabase.Text + ".dbo.DefaultAgentNameDisplayType()";
        //        string DefaultAgentNameDisplayType = "";
        //        Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
        //        try
        //        {
        //            con.Open();
        //            Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
        //            DefaultAgentNameDisplayType = C.ExecuteScalar()?.ToString();
        //            con.Close();
        //        }
        //        catch { }
        //        if (DefaultAgentNameDisplayType == "") DefaultAgentNameDisplayType = "Ii, G.";
        //        string Table = this.comboBoxSynColAgeTable.Text;
        //        int ProjectID;
        //        if (this.comboBoxSynColAgeTable.Text.Length == 0)
        //        {
        //            System.Windows.Forms.MessageBox.Show("Please select the table that should be checked");
        //            return "";
        //        }
        //        SQL = " FROM [" + Table + "] AS A ";
        //        switch (Table)
        //        {
        //            case "IdentificationUnitAnalysis":
        //            case "CollectionSpecimenProcessing":
        //            case "Identification":
        //            case "CollectionSpecimenImage":
        //            case "CollectionAgent":
        //                SQL += "  INNER JOIN CollectionSpecimen AS S ON A.CollectionSpecimenID = S.CollectionSpecimenID ";
        //                if (int.TryParse(this.comboBoxSynColAgeProject.SelectedValue.ToString(), out ProjectID))
        //                    SQL += " INNER JOIN CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID ";
        //                break;
        //            case "CollectionEventLocalisation":
        //            case "CollectionEventProperty":
        //                SQL += " INNER JOIN CollectionEvent AS E ON A.CollectionEventID = E.CollectionEventID INNER JOIN CollectionSpecimen S ON E.CollectionEventID = S.CollectionEventID ";
        //                if (int.TryParse(this.comboBoxSynColAgeProject.SelectedValue.ToString(), out ProjectID))
        //                    SQL += " INNER JOIN CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID ";
        //                break;
        //            case "CollectionSpecimen":
        //                if (int.TryParse(this.comboBoxSynColAgeProject.SelectedValue.ToString(), out ProjectID))
        //                    SQL += " INNER JOIN CollectionProject AS P ON A.CollectionSpecimenID = P.CollectionSpecimenID ";
        //                break;
        //            case "Collection":
        //            case "Transaction":
        //                break;
        //        }
        //        //}
        //        SQL += " INNER JOIN " + this.comboBoxSynColAgeDatabase.Text + ".dbo.AgentNames('" + DefaultAgentNameDisplayType + "') N ON A.";
        //        switch (Table)
        //        {
        //            case "Collection":
        //                SQL += "AdministrativeContactAgentURI";
        //                break;
        //            case "CollectionAgent":
        //                SQL += "CollectorsAgentURI";
        //                break;
        //            case "CollectionEventLocalisation":
        //            case "IdentificationUnitAnalysis":
        //            case "CollectionSpecimenProcessing":
        //            case "Identification":
        //            case "CollectionEventProperty":
        //                SQL += "ResponsibleAgentURI";
        //                break;
        //            case "CollectionSpecimen":
        //                SQL += "DepositorsAgentURI";
        //                break;
        //            case "Transaction":
        //                switch (this.comboBoxSynColAgeColumn.Text)
        //                {
        //                    case "ToTransactionPartnerName":
        //                        SQL += "ToTransactionPartnerAgentURI";
        //                        break;
        //                    case "FromTransactionPartnerName":
        //                        SQL += "FromTransactionPartnerAgentURI";
        //                        break;
        //                    case "ResponsibleName":
        //                        SQL += "ResponsibleAgentURI";
        //                        break;
        //                }
        //                break;
        //            case "CollectionSpecimenImage":
        //                SQL += "CreatorAgentURI";
        //                break;
        //        }
        //        SQL += " = " + this.comboBoxSynColAgeDatabase.Text + ".dbo.BaseURL() + CAST(N.AgentID AS VARCHAR) " +
        //            "AND N.AgentName <> A.";
        //        switch (Table)
        //        {
        //            case "Collection":
        //                SQL += "AdministrativeContactName";
        //                break;
        //            case "CollectionAgent":
        //                SQL += "CollectorsName";
        //                break;
        //            case "CollectionEventLocalisation":
        //            case "CollectionEventProperty":
        //            case "CollectionSpecimenProcessing":
        //            case "IdentificationUnitAnalysis":
        //            case "Identification":
        //                SQL += "ResponsibleName";
        //                break;
        //            case "CollectionSpecimen":
        //                SQL += "DepositorsName";
        //                break;
        //            case "Transaction":
        //                SQL += this.comboBoxSynColAgeColumn.Text;
        //                break;
        //            case "CollectionSpecimenImage":
        //                SQL += "CreatorAgent";
        //                break;
        //        }
        //        if (int.TryParse(this.comboBoxSynColAgeProject.SelectedValue.ToString(), out ProjectID)
        //            && Table != "Collection" && Table != "Transaction")
        //            SQL += " WHERE P.ProjectID = " + ProjectID.ToString();
        //        return SQL;
        //    }
        //}

        //private string FromUpdateRestrictionForAgents
        //{
        //    get
        //    {
        //        string SQL = "";
        //        foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColAge.Rows)
        //        {
        //            if (R.Cells[0].Value.ToString().ToLower() == "false")
        //            {
        //                if (SQL.Length == 0)
        //                {
        //                    SQL = " WHERE A.";
        //                    string Table = this.comboBoxSynColAgeTable.Text;
        //                    switch (Table)
        //                    {
        //                        case "Collection":
        //                            SQL += "AdministrativeContactName";
        //                            break;
        //                        case "CollectionAgent":
        //                            SQL += "CollectorsName";
        //                            break;
        //                        case "CollectionSpecimenProcessing":
        //                        case "CollectionEventLocalisation":
        //                        case "CollectionEventProperty":
        //                        case "Identification":
        //                        case "IdentificationUnitAnalysis":
        //                            SQL += "ResponsibleName";
        //                            break;
        //                        case "CollectionSpecimen":
        //                            SQL += "DepositorsName";
        //                            break;
        //                        case "Transaction":
        //                            SQL += this.comboBoxSynColAgeColumn.Text;
        //                            break;
        //                        case "CollectionSpecimenImage":
        //                            SQL += "CreatorAgent";
        //                            break;
        //                    }
        //                    SQL += " NOT IN (";
        //                }
        //                else SQL += ", ";
        //                SQL += "'" + DiversityWorkbench.Forms.FormFunctions.SqlRemoveHyphens(R.Cells[2].Value.ToString()) + "'";
        //            }
        //        }
        //        if (SQL.Length > 0) SQL += ")";
        //        return SQL;
        //    }
        //}

        private void comboBoxSynColAgeTable_SelectedIndexChanged(object sender, EventArgs e)
        {
            bool ShowTransaction = false;
            if (this.comboBoxSynColAgeTable.Text == "Transaction")
                ShowTransaction = true;
            this.comboBoxSynColAgeColumn.Visible = ShowTransaction;
            this.labelSynColAgeColumn.Visible = ShowTransaction;
            if (ShowTransaction) this.comboBoxSynColAgeColumn.SelectedIndex = 0;
            bool ShowCheckDataset = !ShowTransaction;
            if (this.comboBoxSynColAgeTable.Text == "Collection"
                || this.comboBoxSynColAgeTable.Text == "CollectionEventLocalisation"
                || this.comboBoxSynColAgeTable.Text == "CollectionEventProperty")
                ShowCheckDataset = false;
            this.checkBoxSynColAgeIncludeAccNr.Checked = false;
            this.checkBoxSynColAgeIncludeAccNr.Visible = ShowCheckDataset;
        }

        private void checkBoxSynColAgeIncludeAccNr_CheckedChanged(object sender, EventArgs e)
        {
            if (this.checkBoxSynColAgeIncludeAccNr.Checked) this.buttonSynColAgeCheckDataset.Visible = true;
            else this.buttonSynColAgeCheckDataset.Visible = false;
        }

        private void buttonSynColAgeCheckAll_Click(object sender, EventArgs e)
        {
            // erst bei Bedarf - normalerweise wird man alle aktualisieren wollen
            // #173
            if (this._dtSynColAge != null && this._dtSynColAge.Rows.Count > 0)
            foreach (System.Data.DataRow R in this._dtSynColAge.Rows)
                R[0] = true;
            else System.Windows.MessageBox.Show("Please search for data first before selecting all data", "No dataset available", System.Windows.MessageBoxButton.OK, System.Windows.MessageBoxImage.Information);
        }

        private void buttonSynColAgeCheckNone_Click(object sender, EventArgs e)
        {
            // erst bei Bedarf - normalerweise wird man alle aktualisieren wollen
            // #173
            if (this._dtSynColAge != null && this._dtSynColAge.Rows.Count > 0)
                foreach (System.Data.DataRow R in this._dtSynColAge.Rows)
                R[0] = false;
            else System.Windows.MessageBox.Show("Please search for data first before deselecting all data", "No dataset available", System.Windows.MessageBoxButton.OK, System.Windows.MessageBoxImage.Information);
        }

        #endregion

        #region Via Text

        private bool _SynColAgeTextCheckWithLike = false;
        private Microsoft.Data.SqlClient.SqlConnection _sqlConnectionSynColAgeText;

        private Microsoft.Data.SqlClient.SqlConnection sqlConnectionSynColAgeText
        {
            get
            {
                if (_sqlConnectionSynColAgeText == null)
                {
                    _sqlConnectionSynColAgeText = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
                    _sqlConnectionSynColAgeText.Open();
                }
                return _sqlConnectionSynColAgeText;
            }
        }

        private void initSynColAgeText()
        {
            this.tabControlSynColAgeText.TabPages.Remove(this.tabPageSynColAgeTextCollisions);
        }

        private void buttonSynColAgeTextCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSynColAgeText.SelectedRows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewSynColAgeText.SelectedRows[0];
            bool OK = true;
            try { string test = R.Cells["CollectionSpecimenID"].Value.ToString(); }
            catch { OK = false; }
            if (OK)
            {
                if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
                {
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                else
                    this.DialogResult = DialogResult.Cancel;
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            }
        }

        private void buttonSynColAgeTextCheck_Click(object sender, EventArgs e)
        {
            try
            {
                // Getting the sessionID
                string SqlSession = "SELECT r.session_id FROM sys.dm_exec_requests r JOIN sys.dm_exec_sessions s ON r.session_id = s.session_id WHERE is_user_process = 1";
                int SessionID;
                string TempTableAlias = "#AgentName";
                //if (int.TryParse(DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SqlSession), out SessionID))
                //{
                //    TempTableAlias = "#AgentName_" + SessionID.ToString();
                //}
                this.SynColAgeText_ResetCollision();
                this.tabPageSynColAgeTextUpdates.Text = "Identical names in DiversityAgents";
                string Table = this.comboBoxSynColAgeTextTable.Text;
                if (this.comboBoxSynColAgeTextTable.Text.Length == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select the table that should be checked");
                    return;
                }
                string SQL = "SELECT ";
                //if (!this.checkBoxSynColAgeTextIncludeAccNr.Checked) SQL += " DISTINCT ";
                if (!this.checkBoxSynColAgeTextIncludeAccNr.Checked || this.checkBoxSynColAgeTextCheckUnique.Checked)
                {
                    SQL += " CASE WHEN COUNT(*) = 1 AND A.AgentName LIKE '% %' THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END  AS OK ";
                }
                else
                {
                    SQL += " CAST(1 AS BIT) AS OK ";
                }
                SQL += " , A.AgentName AS [AgentName in DiversityAgents], ";
                SQL += this.SynColAgeText_TableColumn();

                SQL += " AS [Agent in " + this.comboBoxSynColAgeTextTable.Text + "] ";
                if (this.checkBoxSynColAgeTextIncludeAccNr.Visible && this.checkBoxSynColAgeTextIncludeAccNr.Checked)
                    SQL += ", CollectionSpecimen.AccessionNumber, CollectionSpecimen.CollectionSpecimenID ";
                if (this.checkBoxSynColAgeTextCheckUnique.Checked)
                {
                    SQL += ", CASE WHEN COUNT(*) = 1 AND A.AgentName LIKE '% %' THEN B.BaseURL + CAST(MIN(A.AgentID) as varchar)  ELSE NULL END AS AgentURI";
                    SQL += " " + this.SynColAgeText_FromClause().Replace("#AgentName", TempTableAlias);
                }
                else
                {
                    SQL += " " + this.SynColAgeText_FromClause();
                    // Markus 31.5.23: Bugfix - missing group by clause
                    if (!this.checkBoxSynColAgeTextIncludeAccNr.Checked || this.checkBoxSynColAgeTextCheckUnique.Checked)
                        SQL += " GROUP BY A.AgentName, " + this.SynColAgeText_TableColumn();
                }

                DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityAgents"].ServerConnectionList()[this.comboBoxSynColAgeTextDatabase.Text];
                if (SC.LinkedServer.Length == 0 && !this.comboBoxSynColAgeTextDisplaytype.SelectedValue.Equals(System.DBNull.Value))
                {
                    string SqlAgent = "declare @A table (AgentID int, AgentName nvarchar(500)); " +
                        "insert into @A(AgentID, AgentName) " +
                        "select A.AgentID, A.AgentName from " + SC.DatabaseName + ".dbo.AgentNames('" +
                        this.comboBoxSynColAgeTextDisplaytype.SelectedValue.ToString() + "') AS A ";
                    if (this.comboBoxSynColAgeTextDatabaseProject.SelectedItem != null)
                    {
                        if (SC.LinkedServer.Length > 0)
                            SqlAgent += " INNER JOIN [" + SC.LinkedServer + "]." + SC.DatabaseName + ".dbo.AgentProject AP ON A.AgentID = AP.AgentID ";
                        else
                            SqlAgent += " INNER JOIN " + SC.DatabaseName + ".dbo.AgentProject AP ON A.AgentID = AP.AgentID ";
                        int AgentProjectID;
                        System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColAgeTextDatabaseProject.SelectedItem;
                        if (int.TryParse(R["ProjectID"].ToString(), out AgentProjectID))
                            SqlAgent += " AND AP.ProjectID = " + AgentProjectID.ToString();
                    }
                    if (this.checkBoxSynColAgeTextCheckUnique.Checked)
                    {
                        string SqlUnique = "begin try " +
                            "drop table " + TempTableAlias + "; " +
                            "end try " +
                            "begin catch end catch " +
                            "create table " + TempTableAlias + " (AgentName nvarchar(500), AgentID int) " + //, CONSTRAINT [PK_#AgentNames] PRIMARY KEY CLUSTERED (	AgentName ASC)) " +
                            "declare @A table(AgentID int, AgentName nvarchar(500)); " +
                            "insert into @A(AgentID, AgentName) select A.AgentID, A.AgentName from " + SC.DatabaseName + ".dbo.AgentNames('" +
                            this.comboBoxSynColAgeTextDisplaytype.SelectedValue.ToString() + "') AS A " +
                            "INNER JOIN " + SC.DatabaseName + ".dbo.AgentProject AP ON A.AgentID = AP.AgentID ";
                        int AgentProjectID;
                        System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColAgeTextDatabaseProject.SelectedItem;
                        if (int.TryParse(R["ProjectID"].ToString(), out AgentProjectID))
                            SqlUnique += " AND AP.ProjectID = " + AgentProjectID.ToString();
                        //SqlUnique += "; insert into #AgentName(AgentID, AgentName) select MIN(A.AgentID), A.AgentName from @A A  GROUP BY A.AgentName HAVING COUNT(*) = 1; ";
                        SqlUnique += "; insert into " + TempTableAlias + "(AgentID, AgentName) select A.AgentID, A.AgentName from @A A; ";
                        // #120
                        SQL = SqlUnique + SQL + " GROUP BY A.AgentName, " + this.SynColAgeText_TableColumn() + ", B.BaseURL ";
                        if (this.checkBoxSynColAgeTextIncludeAccNr.Visible && this.checkBoxSynColAgeTextIncludeAccNr.Checked)
                            SQL += ", CollectionSpecimen.AccessionNumber, CollectionSpecimen.CollectionSpecimenID ";
                        SQL += " ORDER BY A.AgentName";                   
                    }
                    else
                        SQL = SqlAgent + "; "+ SQL;

                }
                this._dtSynColAgeText = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, this.sqlConnectionSynColAgeText);
                ad.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                try
                {
                    ad.Fill(this._dtSynColAgeText);
                }
                catch (Exception ex)
                {
                    System.Windows.Forms.MessageBox.Show(ex.Message);
                }
                this.dataGridViewSynColAgeText.DataSource = this._dtSynColAgeText;
                this.dataGridViewSynColAgeText.Columns[1].ReadOnly = true;
                this.dataGridViewSynColAgeText.Columns[2].ReadOnly = true;
                if (this.dataGridViewSynColAgeText.Columns.Count > 3)
                    this.dataGridViewSynColAgeText.Columns[3].ReadOnly = true;
                if (this.dataGridViewSynColAgeText.Columns.Count > 4)
                    this.dataGridViewSynColAgeText.Columns[4].Visible = false;
                this.dataGridViewSynColAgeText.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                if (this._dtSynColAgeText.Rows.Count > 0)
                {
                    this.labelSynColAgeTextCheck.Text = this._dtSynColAgeText.Rows.Count.ToString() + " matches found";
                    this.buttonSynColAgeTextUpdate.Enabled = true;
                }
                else
                {
                    this.labelSynColAgeTextCheck.Text = "No match found";
                    this.buttonSynColAgeTextUpdate.Enabled = false;
                }
                this.labelSynColAgeTextCheckSimilarResult.Text = "";
                this._SynColAgeTextCheckWithLike = false;
            }
            catch (System.Exception ex) { }
        }

        private void buttonSynColAgeTextUpdate_Click(object sender, EventArgs e)
        {
            try
            {
                string Table = this.comboBoxSynColAgeTextTable.Text;
                if (this.comboBoxSynColAgeTextTable.Text.Length == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select the table that should be checked");
                    return;
                }
                if (_dtSynColAgeTextCollisions == null) _dtSynColAgeTextCollisions = new DataTable();
                this._dtSynColAgeTextCollisions.Clear();
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                string SQL = "UPDATE [" + Table + "] SET " + SynColAgeText_TableColumn(true);
                if (this._SynColAgeTextCheckWithLike)
                {
                    string Error = "";
                    int u = 0;
                    int i = 0;
                    int f = 0;
                    int c = 0;
                    foreach (System.Data.DataRow R in this._dtSynColAgeText.Rows)
                    {
                        if (bool.Parse(R[0].ToString()) && R["AgentURI"].ToString().Length > 0)
                        {
                            string AgentInDA = R[1].ToString();
                            string AgentOld = R[2].ToString(); 
                            string SqlUpdate = SQL + " = '" + R["AgentURI"].ToString() + "' ";
                            if (AgentOld != AgentInDA)
                                SqlUpdate += ", " + this.SynColAgeText_TableColumn() + " = '" + AgentInDA + "' ";
                            // Markus 2.8.24: % entfernt - es wird nur das genommen was im Textfeld steht
                            SqlUpdate += SynColAgeText_FromClause(true, null, true) +
                                //" AND " + this.SynColAgeText_TableColumn() + " LIKE N'%" + this.SqlValueLike(AgentOld, SqlValueType.ColumnContent) + "%' ";
                                " AND " + this.SynColAgeText_TableColumn() + " LIKE N'" + this.SqlValueLike(AgentOld, SqlValueType.ColumnContent) + "' ";
                            //Markus 26.4.23 - Pruefung nur bei Aenderung
                            if (AgentOld != AgentInDA)
                            {
                                SqlUpdate += "AND NOT EXISTS (SELECT * FROM CollectionAgent AS AA WHERE AA.CollectorsName = '" + AgentInDA + "' AND AA.CollectionSpecimenID = CollectionProject.CollectionSpecimenID)";
                                if (this.SynColAgeText_CheckCollision(Table, AgentInDA, AgentOld) > 0)
                                {
                                    c++;
                                }
                                else if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SqlUpdate, ref Error))
                                    u++;
                            }
                            else if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SqlUpdate, ref Error))
                            {
                                u++;
                            }
                            else
                            {
                                f++;
                            }
                        }
                        else
                            i++;
                    }
                    string Message = "";
                    if (u > 0)
                        Message = u.ToString() + " agents updated\r\n";
                    if (i > 0)
                        Message += i.ToString() + " agents ignored\r\n";
                    if (f > 0)
                        Message += f.ToString() + " updates failed\r\n";
                    Message += this.SynColAgeText_CheckCollision();
                    if (Error.Length == 0 && f == 0)
                        System.Windows.Forms.MessageBox.Show(Message + "\r\nUpdate finished");
                    else
                        System.Windows.Forms.MessageBox.Show(Message + "Update failed: " + Error);
                    this._dtSynColAgeText.Clear();
                }
                else
                {
                    if (this.tabControlSynColAgeText.TabPages.Contains(this.tabPageSynColAgeTextCollisions))
                        this.tabControlSynColAgeText.TabPages.Remove(this.tabPageSynColAgeTextCollisions);
                    DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityAgents"].ServerConnectionList()[this.comboBoxSynColAgeTextDatabase.Text];
                    if (SC.LinkedServer.Length == 0)
                    {
                        if (Table == "IdentificationUnitAnalysis" &&
                            !this.checkBoxSynColAgeTextIncludeAccNr.Checked &&
                            !this.comboBoxSynColAgeTextDisplaytype.SelectedValue.Equals(System.DBNull.Value))
                        {
                            // special treatment due to timeout in large databases esp. BayernFlora
                            SQL = "declare @A table (AgentID int, AgentName nvarchar(500)); " +
                                "insert into @A(AgentID, AgentName) " +
                                "select L.AgentID, L.AgentName from " + SC.DatabaseName + ".dbo.AgentNames('" +
                                this.comboBoxSynColAgeTextDisplaytype.SelectedValue.ToString() + "') AS L, DiversityAgents_BayernFlora.dbo.AgentProject AP WHERE L.AgentID = AP.AgentID; " +
                                " DECLARE @B nvarchar(500); " +
                                " SET @B = (SELECT " + SC.DatabaseName + ".dbo.BaseURL()); " +
                                " UPDATE T SET T.ResponsibleAgentURI = @B + CAST(A.AgentID AS VARCHAR)" +
                                " FROM " + Table + " AS T " +
                                " INNER JOIN CollectionProject P ON T.CollectionSpecimenID = P.CollectionSpecimenID " +
                                " INNER JOIN @A A ON T.ResponsibleName = A.AgentName " +
                                " WHERE (T.ResponsibleAgentURI IS NULL OR T.ResponsibleAgentURI = '') " +
                                " AND P.ProjectID = 948 ";
                            this.progressBarSynColAgeText.Value = 0;
                            this.progressBarSynColAgeText.Maximum = this.DatasetRestrictionListForTextAgents.Count;
                            this.progressBarSynColAgeText.Visible = true;
                            Microsoft.Data.SqlClient.SqlConnection c = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
                            Microsoft.Data.SqlClient.SqlCommand Com = new Microsoft.Data.SqlClient.SqlCommand(SQL, c);
                            Com.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                            string ErrorMessage = "";
                            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                            c.Open();
                            foreach (string A in this.DatasetRestrictionListForTextAgents)
                            {
                                try
                                {
                                    Com.CommandText = SQL + " AND T.ResponsibleName = " + A;
                                    Com.ExecuteNonQuery();
                                    if (this.progressBarSynColAgeText.Value < this.progressBarSynColAgeText.Maximum)
                                        this.progressBarSynColAgeText.Value++;
                                    System.Windows.Forms.Application.DoEvents();
                                }
                                catch (System.Exception ex)
                                {
                                    ErrorMessage += "Update for " + A + " failed:\r\n" + ex.Message + "\r\n";
                                }
                            }
                            Com.Dispose();
                            c.Close();
                            c.Dispose();
                            this.Cursor = System.Windows.Forms.Cursors.Default;
                            if (ErrorMessage.Length == 0)
                                System.Windows.Forms.MessageBox.Show("Update finished");
                            else
                                System.Windows.Forms.MessageBox.Show("Update failed: " + ErrorMessage);
                            return;
                        }
                        else
                        {
                            SQL += " = " + SC.DatabaseName + ".dbo.BaseURL() + CAST(A.AgentID AS VARCHAR) " +
                                SynColAgeText_FromClause(this._SynColAgeTextCheckWithLike) + SynColAgeText_DatasetRestriction;
                            if (!this.comboBoxSynColAgeTextDisplaytype.SelectedValue.Equals(System.DBNull.Value))
                            {
                                string SqlAgent = "declare @A table (AgentID int, AgentName nvarchar(500)); " +
                                    "insert into @A(AgentID, AgentName) " +
                                    "select A.AgentID, A.AgentName from " + SC.DatabaseName + ".dbo.AgentNames('" +
                                    this.comboBoxSynColAgeTextDisplaytype.SelectedValue.ToString() + "') AS A ";
                                if (SC.LinkedServer.Length > 0)
                                    SqlAgent += " INNER JOIN [" + SC.LinkedServer + "]." + SC.DatabaseName + ".dbo.AgentProject AP ON A.AgentID = AP.AgentID ";
                                else
                                    SqlAgent += " INNER JOIN " + SC.DatabaseName + ".dbo.AgentProject AP ON A.AgentID = AP.AgentID ";
                                SQL = SqlAgent + SQL;
                            }
                        }
                    }
                    else
                    {
                        SQL += " = (SELECT BaseURL FROM [" + SC.LinkedServer + "].[" + SC.DatabaseName + "].dbo.ViewBaseURL) + CAST(A.AgentID AS VARCHAR) " +
                            SynColAgeText_FromClause() + SynColAgeText_DatasetRestriction;
                    }
                    string Error = "";
                    Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
                    Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, this.sqlConnectionSynColAgeText);
                    C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                    try
                    {
                        this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                        con.Open();
                        C.ExecuteNonQuery();
                    }
                    catch (Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                        Error = ex.Message;
                    }
                    finally
                    {
                        this.Cursor = System.Windows.Forms.Cursors.Default;
                        this.dataGridViewSynColAgeText.DataSource = null;
                        con.Close();
                    }
                    if (Error.Length == 0)
                        System.Windows.Forms.MessageBox.Show("Update finished");
                    else
                        System.Windows.Forms.MessageBox.Show("Update failed: " + Error);
                }
            }
            catch(System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private string SynColAgeText_FromClause(bool Like = false, System.Data.DataRow dataRow = null, bool ForUpdateWithKnownAgentURI = false, bool ForCollisionCheck = false)
        {
            //get
            {
                string Table = this.comboBoxSynColAgeTextTable.Text;
                int ProjectID;
                if (this.comboBoxSynColAgeTextTable.Text.Length == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select the table that should be checked");
                    return "";
                }
                string SQL = " FROM ";
                if (dataRow == null)
                {
                    switch (Table)
                    {
                        case "IdentificationUnitAnalysis":
                        case "CollectionSpecimenProcessing":
                        case "Identification":
                        case "CollectionSpecimenImage":
                        case "CollectionAgent":
                            SQL += Table + " INNER JOIN CollectionSpecimen ON " + Table + ".CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID ";
                            if (this.comboBoxSynColAgeTextProject.SelectedItem != null)
                            {
                                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColAgeTextProject.SelectedItem;
                                if (int.TryParse(R["ProjectID"].ToString(), out ProjectID))
                                    SQL += " INNER JOIN CollectionProject ON CollectionSpecimen.CollectionSpecimenID = CollectionProject.CollectionSpecimenID ";
                            }
                            break;
                        case "CollectionEventLocalisation":
                        case "CollectionEventProperty":
                            SQL += Table + " INNER JOIN CollectionSpecimen ON " + Table + ".CollectionEventID = CollectionSpecimen.CollectionEventID ";
                            if (this.comboBoxSynColAgeTextProject.SelectedItem != null)
                            {
                                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColAgeTextProject.SelectedItem;
                                if (int.TryParse(R["ProjectID"].ToString(), out ProjectID))
                                    SQL += " INNER JOIN CollectionProject ON CollectionSpecimen.CollectionSpecimenID = CollectionProject.CollectionSpecimenID ";
                            }
                            break;
                        case "CollectionSpecimen":
                            SQL += Table;
                            if (this.comboBoxSynColAgeTextProject.SelectedItem != null)
                            {
                                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColAgeTextProject.SelectedItem;
                                if (int.TryParse(R["ProjectID"].ToString(), out ProjectID))
                                    SQL += " INNER JOIN CollectionProject ON CollectionSpecimen.CollectionSpecimenID = CollectionProject.CollectionSpecimenID ";
                            }
                            break;
                        case "Collection":
                        case "Transaction":
                            SQL += "[" + Table + "]";
                            break;
                    }
                    if (!ForUpdateWithKnownAgentURI)
                        SQL += " INNER JOIN ";
                }
                if (!ForUpdateWithKnownAgentURI)
                {
                    DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityAgents"].ServerConnectionList()[this.comboBoxSynColAgeTextDatabase.Text];
                    if (SC.LinkedServer.Length > 0)
                    {
                        if (this.comboBoxSynColAgeTextDisplaytype.SelectedValue.Equals(System.DBNull.Value))
                        {
                            SQL += " [" + SC.LinkedServer + "]." + SC.DatabaseName + ".dbo.Agent A ";
                        }
                        else
                        {
                            SQL += " [" + SC.LinkedServer + "]." + SC.DatabaseName + ".dbo.ViewAgentNames A ";
                        }
                    }
                    else
                    {
                        if (this.comboBoxSynColAgeTextDisplaytype.SelectedValue.Equals(System.DBNull.Value))
                        {
                            SQL += "  " + SC.DatabaseName + ".dbo.Agent A ";
                        }
                        else if (this.checkBoxSynColAgeTextCheckUnique.Checked)
                        {
                            SQL += " #AgentName A ";
                        }
                        else
                        {
                            SQL += " @A A ";
                        }
                    }
                    if (dataRow == null)
                    {
                        SQL += " ON A.AgentName ";
                        if (Like)
                            SQL += " LIKE '" + this.SqlValueLike( this.textBoxSynColAgeTextCheckSimilar.Text, SqlValueType.QueryRestriction) + "' ";
                        else if (this.checkBoxSynColAgeTextCheckUnique.Checked)
                        {
                            SQL += " COLLATE Latin1_General_CI_AS  = [" + Table + "]." + this.SynColAgeTextColumn(Table) + " COLLATE Latin1_General_CI_AS ";
                        }
                        else
                            SQL += " = " + this.SynColAgeText_TableColumn();
                        //SQL += this.SynColAgeText_TableColumn();
                        if (Like)
                        {
                            //SQL += " + '%' ";
                            if (this.textBoxSynColAgeTextCheckSimilar.Text.Length > 0)
                            {
                                SQL += " AND [" + Table + "].[" + this.SynColAgeTextColumn(Table); ;
                                SQL += "] LIKE '" + this.SqlValueLike( this.textBoxSynColAgeTextCheckSimilar.Text, SqlValueType.QueryRestriction) + "' ";
                            }
                        }
                    }

                    SQL += " CROSS JOIN ";
                    if (SC.LinkedServer.Length > 0)
                    {
                        SQL += " [" + SC.LinkedServer + "]." + SC.DatabaseName;
                    }
                    else
                    {
                        SQL += SC.DatabaseName;
                    }
                    SQL += ".dbo.ViewBaseURL AS B ";
                }
                if (dataRow == null)
                {
                    SQL += " WHERE " + SynColAgeText_TableColumn() + " <> '' ";
                    if (!ForCollisionCheck)
                        SQL += " AND (" + SynColAgeText_TableColumn(true) + " IS NULL OR " + SynColAgeText_TableColumn(true) + " = '') ";
                    if (this.comboBoxSynColAgeProject.SelectedItem != null
                        && Table != "Collection" && Table != "Transaction")
                    {
                        System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColAgeProject.SelectedItem;
                        if (int.TryParse(R["ProjectID"].ToString(), out ProjectID)
                        && Table != "Collection" && Table != "Transaction")
                            SQL += " AND CollectionProject.ProjectID = " + ProjectID.ToString();
                    }
                    if (this.comboBoxSynColAgeTextDatabaseProject.SelectedItem != null)
                    {
                        /// Verschoben zur Tabelle Agent @A
                        //System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColAgeTextDatabaseProject.SelectedItem;
                        //if (int.TryParse(R["ProjectID"].ToString(), out ProjectID))
                        //    SQL += " AND AP.ProjectID = " + ProjectID.ToString();
                    }
                }
                else
                {
                    SQL += " WHERE A.AgentName LIKE '%" + this.SqlValueLike(dataRow[2].ToString(), SqlValueType.ColumnContent) + "%' OR  A.AgentName LIKE '" + this.SqlValueLike(this.textBoxSynColAgeTextCheckSimilar.Text, SqlValueType.QueryRestriction) + "'";
                }
                return SQL;
            }
        }

        private string SynColAgeTextColumn(string Table)
        {
            string Column = "";
            if (this.comboBoxSynColAgeTextColumn.Visible && this.comboBoxSynColAgeTextColumn.SelectedItem != null)
            {
                Column = this.comboBoxSynColAgeTextColumn.SelectedItem.ToString();
            }
            else
            {
                switch (Table)
                {
                    case "CollectionSpecimenImage":
                        Column = "CreatorAgent";
                        break;
                    case "CollectionAgent":
                        Column = "CollectorsName";
                        break;
                    case "CollectionSpecimenProcessing":
                    case "IdentificationUnitAnalysis":
                    case "Identification":
                    case "CollectionEventLocalisation":
                    case "CollectionEventProperty":
                        Column = "ResponsibleName";
                        break;
                    case "CollectionSpecimen":
                        Column = "DepositorsName";
                        break;
                    case "Collection":
                        Column = "AdministrativeContactName";
                        break;
                }
            }
            return Column;
        }

        private string SynColAgeText_DatasetRestriction
        {
            get
            {
                System.Data.DataRow[] rr = this._dtSynColAgeText.Select("OK = 1");
                if (rr.Length == 0)
                    return " AND 1 = 0";
                string SQL = " AND ";
                if (rr.Length <= this._dtSynColAgeText.Rows.Count)
                {
                    string Table = this.comboBoxSynColAgeTextTable.Text;
                    string SqlAgentRestriction = "";
                    string SqlSpecimenRestriction = "";
                    foreach (System.Data.DataRow R in rr)
                    {
                        if (SqlAgentRestriction.Length > 0) SqlAgentRestriction += ", ";
                        SqlAgentRestriction += "'" + R[1].ToString().Replace("'", "''") + "'";
                        if (this.checkBoxSynColAgeTextIncludeAccNr.Checked)
                        {
                            if (SqlSpecimenRestriction.Length > 0) SqlSpecimenRestriction += ", ";
                            SqlSpecimenRestriction += R["CollectionSpecimenID"].ToString();
                        }
                    }
                    string TableColumn = "";
                    switch (Table)
                    {
                        case "Collection":
                            TableColumn = "AdministrativeContactName";
                            break;
                        case "CollectionAgent":
                            TableColumn = "CollectorsName";
                            break;
                        case "CollectionEventLocalisation":
                        case "CollectionEventProperty":
                        case "CollectionSpecimenProcessing":
                        case "IdentificationUnitAnalysis":
                        case "Identification":
                            TableColumn = "ResponsibleName";
                            break;
                        case "CollectionSpecimen":
                            TableColumn = "DepositorsName";
                            break;
                        case "Transaction":
                            TableColumn = this.comboBoxSynColAgeTextColumn.Text;
                            break;
                        case "CollectionSpecimenImage":
                            SQL += "CreatorAgent";
                            break;
                    }
                    SQL += "[" + Table + "].[" + TableColumn + "] IN (" + SqlAgentRestriction + ")";
                    if (SqlSpecimenRestriction.Length > 0)
                        SQL += " AND [" + Table + "].CollectionSpecimenID IN (" + SqlSpecimenRestriction + ")";
                }
                return SQL;
            }

        }

        private System.Collections.Generic.List<string> DatasetRestrictionListForTextAgents
        {
            get
            {
                System.Collections.Generic.List<string> List = new List<string>();
                System.Data.DataRow[] rr = this._dtSynColAgeText.Select("OK = 1");
                if (rr.Length == 0)
                    return List;
                if (rr.Length <= this._dtSynColAgeText.Rows.Count)
                {
                    foreach (System.Data.DataRow R in rr)
                    {
                        List.Add("'" + R[1].ToString().Replace("'", "''") + "'");
                    }
                }
                return List;
            }

        }

        #region Parameter selection
        private void comboBoxSynColAgeTextTable_SelectedIndexChanged(object sender, EventArgs e)
        {
            bool ShowTransaction = false;
            if (this.comboBoxSynColAgeTextTable.Text == "Transaction") ShowTransaction = true;
            this.comboBoxSynColAgeTextColumn.Visible = ShowTransaction;
            this.labelSynColAgeTextColumn.Visible = ShowTransaction;
            if (ShowTransaction) this.comboBoxSynColAgeTextColumn.SelectedIndex = 0;
            bool ShowCheckDataset = !ShowTransaction;
            if (this.comboBoxSynColAgeTextTable.Text == "Collection"
                || this.comboBoxSynColAgeTextTable.Text == "CollectionEventLocalisation"
                || this.comboBoxSynColAgeTextTable.Text == "CollectionEventProperty")
                ShowCheckDataset = false;
            this.checkBoxSynColAgeTextIncludeAccNr.Checked = false;
            this.checkBoxSynColAgeTextIncludeAccNr.Visible = ShowCheckDataset;
        }

        private void checkBoxSynColAgeTextIncludeAccNr_CheckedChanged(object sender, EventArgs e)
        {
            try
            {
                if (this.checkBoxSynColAgeTextIncludeAccNr.Checked) this.buttonSynColAgeTextCheckDataset.Visible = true;
                else this.buttonSynColAgeTextCheckDataset.Visible = false;
                if (this._dtSynColAgeText != null)
                    this._dtSynColAgeText.Clear();
                this.labelSynColAgeTextCheck.Text = "";
                this.labelSynColAgeTextCheckSimilarResult.Text = "";
            }
            catch(System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
        }

        private void comboBoxSynColAgeTextDatabaseProject_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (this._dtSynColAgeText != null)
                this._dtSynColAgeText.Clear();
        }

        private void comboBoxSynColAgeTextDatabase_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (this._dtSynColAgeText != null)
                this._dtSynColAgeText.Clear();
            string Database = this.comboBoxSynColAgeTextDatabase.SelectedItem.ToString();
            foreach (DiversityWorkbench.DatabaseService DS in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityAgents"].DatabaseServices())
            {
                if (DS.DisplayText == Database)
                {
                    DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityAgents"].ServerConnectionList()[Database];// new DiversityWorkbench.ServerConnection(DiversityWorkbench.Settings.ConnectionString);
                    //SC.DatabaseName = DS.DatabaseName;
                    //if (DS.Server.Length > 0)
                    //    SC.DatabaseServer = DS.Server;
                    if (SC.ConnectionString.Length > 0)
                    {
                        string SQL = "SELECT ProjectID, Project " +
                            "FROM ProjectProxy " +
                            "ORDER BY Project ";
                        if (SC.LinkedServer.Length > 0)
                            SQL = "SELECT ProjectID, Project FROM [" + SC.LinkedServer + "].[" + SC.DatabaseName + "].dbo.ProjectProxy P ORDER BY Project";
                        System.Data.DataTable dt = new DataTable();
                        Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, SC.ConnectionString);
                        ad.Fill(dt);
                        this.comboBoxSynColAgeTextDatabaseProject.DataSource = dt;
                        this.comboBoxSynColAgeTextDatabaseProject.DisplayMember = "Project";
                        this.comboBoxSynColAgeTextDatabaseProject.ValueMember = "ProjectID";
                        if (SC.LinkedServer.Length > 0)
                        {
                            this.labelSynColAgeTextDatabase.Text = "Database:  " + SC.DatabaseName;
                        }
                    }
                    else this.labelSynColAgeTextDatabase.Text = "Database:";
                    break;
                }
            }
        }

        #endregion

        #region List selection
        private void buttonSynColAgeTextCheckAll_Click(object sender, EventArgs e)
        {
            try
            {
                System.Data.DataTable dt = (System.Data.DataTable)this.dataGridViewSynColAgeText.DataSource;
                // #173
                if (dt != null && dt.Rows.Count > 0)
                {
                    foreach (System.Data.DataRow R in dt.Rows)
                    {
                        R[0] = true;
                    }
                }
            }
            catch (System.Exception ex) { }
        }

        private void buttonSynColAgeTextCheckNone_Click(object sender, EventArgs e)
        {
            try
            {
                //# 173
                System.Data.DataTable dt = (System.Data.DataTable)this.dataGridViewSynColAgeText.DataSource;
                if (dt != null && dt.Rows.Count > 0)
                {
                    foreach (System.Data.DataRow R in dt.Rows)
                    {
                        R[0] = false;
                    }
                }
            }
            catch (System.Exception ex) { }
        }

        #endregion

        #region Collision

        private void SynColAgeText_ResetCollision()
        {
            this.dataGridViewSynColAgeTextCollisions.DataSource = null;
            if (this.tabControlSynColAgeText.TabPages.Contains(this.tabPageSynColAgeTextCollisions))
                this.tabControlSynColAgeText.TabPages.Remove(this.tabPageSynColAgeTextCollisions);
        }

        private string SynColAgeText_CheckCollision()
        {
            string Message = "";
            try
            {
                if (_dtSynColAgeTextCollisions != null && _dtSynColAgeTextCollisions.Rows.Count > 0)
                {
                    this.dataGridViewSynColAgeTextCollisions.DataSource = _dtSynColAgeTextCollisions;
                    Message = this._dtSynColAgeTextCollisions.Rows.Count.ToString() + " collisions detected\r\n";
                    if (!this.tabControlSynColAgeText.TabPages.Contains(this.tabPageSynColAgeTextCollisions))
                        this.tabControlSynColAgeText.TabPages.Add(this.tabPageSynColAgeTextCollisions);
                }
                else
                {
                    this.dataGridViewSynColAgeTextCollisions.DataSource = null;
                    if (this.tabControlSynColAgeText.TabPages.Contains(this.tabPageSynColAgeTextCollisions))
                        this.tabControlSynColAgeText.TabPages.Remove(this.tabPageSynColAgeTextCollisions);
                }
            }
            catch (System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
            return Message;
        }

        private int SynColAgeText_CheckCollision(string Table, string AgentInDA, string AgentOld)
        {
            int Count = 0;
            try
            {
                string SqlCollision = SynColAgeText_FromClause(true, null, true, true);
                // Markus 30.4.24: Test of tabelle vorhanden
                if (SqlCollision.IndexOf("CollectionAgent") == -1)
                {
                    SqlCollision = SqlCollision.Replace(" WHERE ", " INNER JOIN [CollectionAgent] ON  CollectionAgent.CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID WHERE ");
                }

                SqlCollision = SqlCollision.Replace(" WHERE ", " INNER JOIN [CollectionAgent] AA ON  CollectionAgent.CollectionSpecimenID = AA.CollectionSpecimenID " +
                    "AND CollectionAgent.CollectorsName <> AA.CollectorsName AND AA.CollectorsName = '" + AgentOld + "' WHERE ");
                SqlCollision += " AND " + this.SynColAgeText_TableColumn() + " = N'" + AgentInDA + "' ";
                string SQL = "SELECT COUNT(*) " + SqlCollision;
                if (int.TryParse(DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL), out Count) && Count > 0)
                {
                    if (DiversityWorkbench.Forms.FormFunctions.SqlFillTable("SELECT [" + Table + "].* " + SqlCollision, ref _dtSynColAgeTextCollisions))
                    {
                        this.dataGridViewSynColAgeTextCollisions.DataSource = _dtSynColAgeTextCollisions;
                    }
                }
            }
            catch(System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
            return Count;
        }

        private void buttonSynColAgeTextCollisionsCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSynColAgeTextCollisions.SelectedCells.Count > 0)
            {
                System.Data.DataRow R = this._dtSynColAgeTextCollisions.Rows[this.dataGridViewSynColAgeTextCollisions.SelectedCells[0].RowIndex];
                int ID;
                if (int.TryParse(R[0].ToString(), out ID))
                {
                    this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                    DiversityCollection.Forms.FormCollectionSpecimen form = new Forms.FormCollectionSpecimen(ID, false, false, Forms.FormCollectionSpecimen.ViewMode.SingleInspectionMode);
                    form.Width = this.Width - 20;
                    form.Height = this.Height - 20;
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                    form.ShowDialog();
                }
            }
        }

        #endregion


        #region LIKE

        private string SynColAgeText_SelectClause(bool Like = false, System.Data.DataRow dataRow = null)
        {
            string SQL = "";
            try
            {
                DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityAgents"].ServerConnectionList()[this.comboBoxSynColAgeTextDatabase.Text];
                //string Table = this.comboBoxSynColAgeTextTable.Text;
                SQL = "SELECT ";
                if (!this.checkBoxSynColAgeTextIncludeAccNr.Checked && !Like)
                    SQL += " DISTINCT ";
                if (dataRow == null)
                {
                    if (this.checkBoxSynColAgeTextIncludeAccNr.Checked)
                        SQL += " CASE WHEN MIN(A.AgentName)  LIKE '%' + [" + this.comboBoxSynColAgeTextTable.Text + "].[" + this.SynColAgeTextColumn(this.comboBoxSynColAgeTextTable.Text) + "] +'%'  AND COUNT(*) = 1 THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END AS OK ";
                    else
                        SQL += " case when MIN(A.AgentName)  LIKE '%' + [" + this.comboBoxSynColAgeTextTable.Text + "].[" + this.SynColAgeTextColumn(this.comboBoxSynColAgeTextTable.Text) + "] +'%'  AND MIN(B.BaseURL + cast (A.AgentID AS varchar)) = MAX(B.BaseURL + cast (A.AgentID AS varchar)) then CAST(1 AS BIT) ELSE CAST(0 AS BIT) end AS OK ";
                    SQL += ", MIN(A.AgentName) AS [AgentName in DiversityAgents], " + this.SynColAgeText_TableColumn();
                    SQL += " AS [Agent in " + this.comboBoxSynColAgeTextTable.Text + "] ";
                    if (this.checkBoxSynColAgeTextIncludeAccNr.Visible && this.checkBoxSynColAgeTextIncludeAccNr.Checked)
                        SQL += ", CollectionSpecimen.AccessionNumber, CollectionSpecimen.CollectionSpecimenID ";
                    if (Like)
                    {
                        if (this.checkBoxSynColAgeTextIncludeAccNr.Checked)
                            SQL += ", CASE when MIN(A.AgentName)  LIKE '%' + [" + this.comboBoxSynColAgeTextTable.Text + "].[" + this.SynColAgeTextColumn(this.comboBoxSynColAgeTextTable.Text) + "] +'%'  AND count(*) = 1 then MIN(B.BaseURL + cast (A.AgentID AS varchar)) else '' end AS [AgentURI] ";
                        else
                            SQL += ",  case when MIN(A.AgentName)  LIKE '%' + [" + this.comboBoxSynColAgeTextTable.Text + "].[" + this.SynColAgeTextColumn(this.comboBoxSynColAgeTextTable.Text) + "] +'%'  AND MIN(B.BaseURL + cast (A.AgentID AS varchar)) = MAX(B.BaseURL + cast (A.AgentID AS varchar)) then MIN(B.BaseURL + cast (A.AgentID AS varchar)) else '' end AS [AgentURI] ";
                    }
                    SQL += " " + this.SynColAgeText_FromClause(Like, dataRow);
                    if (Like)
                    {
                        SQL += " group by " + this.SynColAgeText_TableColumn();
                        if (this.checkBoxSynColAgeTextIncludeAccNr.Visible && this.checkBoxSynColAgeTextIncludeAccNr.Checked)
                            SQL += ", CollectionSpecimen.AccessionNumber, CollectionSpecimen.CollectionSpecimenID ";
                    }
                    if (!this.checkBoxSynColAgeTextIncludeAccNr.Checked 
                        && this.comboBoxSynColAgeTextTable.Text.ToLower() != "collection"
                        && this.comboBoxSynColAgeTextTable.Text.ToLower() != "collectionagent" // Markus 21.4.23: Gruppierung nur wenn AccNr included
                        && this.comboBoxSynColAgeTextTable.Text.ToLower() != "transaction"
                        && (!Like && this.comboBoxSynColAgeTextTable.Text.ToLower() == "identification" && !this.checkBoxSynColAgeTextIncludeAccNr.Checked)) // #119
                        SQL += ", CollectionSpecimen.AccessionNumber, CollectionSpecimen.CollectionSpecimenID ";
                }
                else
                {
                    if (Like)
                    {
                        SQL += " A.AgentName, B.BaseURL + cast (A.AgentID AS varchar) AS [AgentURI] ";
                        SQL += " " + this.SynColAgeText_FromClause(Like, dataRow);
                    }
                    else
                    {

                    }
                }
                //string Database = this.comboBoxSynColAgeTextDatabase.Text;
                //if (Database.IndexOf(" ") > -1)
                //    Database = Database.Substring(0, Database.IndexOf(" "));
                if (SC.LinkedServer.Length == 0 && !this.comboBoxSynColAgeTextDisplaytype.SelectedValue.Equals(System.DBNull.Value))
                {
                    string SqlAgent = "declare @A table (AgentID int, AgentName nvarchar(500)); " +
                        "insert into @A(AgentID, AgentName) " +
                        "select A.AgentID, A.AgentName from " + SC.DatabaseName + ".dbo.AgentNames('" +
                        this.comboBoxSynColAgeTextDisplaytype.SelectedValue.ToString() + "') AS A ";
                    if (this.comboBoxSynColAgeTextDatabaseProject.SelectedItem != null)
                    {
                        if (SC.LinkedServer.Length > 0)
                            SqlAgent += " INNER JOIN [" + SC.LinkedServer + "]." + SC.DatabaseName + ".dbo.AgentProject AP ON A.AgentID = AP.AgentID ";
                        else
                            SqlAgent += " INNER JOIN " + SC.DatabaseName + ".dbo.AgentProject AP ON A.AgentID = AP.AgentID ";
                        int AgentProjectID;
                        System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColAgeTextDatabaseProject.SelectedItem;
                        if (int.TryParse(R["ProjectID"].ToString(), out AgentProjectID))
                            SqlAgent += " AND AP.ProjectID = " + AgentProjectID.ToString();
                    }

                    SQL = SqlAgent + "; " + SQL;
                }
            }
            catch (System.Exception ex) { }
            return SQL;
        }

        private string SynColAgeText_TableColumn(bool UriColumn = false)
        {
            string SQL = "";
            string Table = this.comboBoxSynColAgeTextTable.Text;
            SQL += "[" + Table + "].";
            switch (Table)
            {
                case "Collection":
                    if (UriColumn)
                        SQL += "AdministrativeContactAgentURI";
                    else
                        SQL += "AdministrativeContactName";
                    break;
                case "CollectionAgent":
                    if (UriColumn)
                        SQL += "CollectorsAgentURI";
                    else
                        SQL += "CollectorsName";
                    break;
                case "CollectionEventLocalisation":
                case "CollectionEventProperty":
                case "CollectionSpecimenProcessing":
                case "IdentificationUnitAnalysis":
                case "Identification":
                    if (UriColumn)
                        SQL += "ResponsibleAgentURI";
                    else
                        SQL += "ResponsibleName";
                    break;
                case "CollectionSpecimen":
                    if (UriColumn)
                        SQL += "DepositorsAgentURI";
                    else
                        SQL += "DepositorsName";
                    break;
                case "Transaction":
                    if (UriColumn)
                        switch (this.comboBoxSynColAgeTextColumn.Text)
                        {
                            case "ToTransactionPartnerName":
                                SQL += "ToTransactionPartnerAgentURI";
                                break;
                            case "FromTransactionPartnerName":
                                SQL += "FromTransactionPartnerAgentURI";
                                break;
                            case "ResponsibleName":
                                SQL += "ResponsibleAgentURI";
                                break;
                        }
                    else
                        SQL += this.comboBoxSynColAgeTextColumn.Text;
                    break;
                case "CollectionSpecimenImage":
                    if (UriColumn)
                        SQL += "CreatorAgentURI";
                    else
                        SQL += "CreatorAgent";
                    break;
            }
            return SQL;
        }

        private void buttonSynColAgeTextCheckSimilar_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.comboBoxSynColAgeTextTable.Text.Length == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select the table that should be checked");
                    return;
                }
                if (this.textBoxSynColAgeTextCheckSimilar.Text.Length < 3)
                {
                    System.Windows.Forms.MessageBox.Show("Please give at least 3 characters for comparision");
                    return;
                }

                this.SynColAgeText_ResetCollision();
                this.tabPageSynColAgeTextUpdates.Text = "Names similar to \"" + this.textBoxSynColAgeTextCheckSimilar.Text + "\" in DiversityAgents";
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;

                string SQL = this.SynColAgeText_SelectClause(true); 
                this._dtSynColAgeText = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
                ad.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                try
                {
                    ad.Fill(this._dtSynColAgeText);
                }
                catch (Exception ex)
                {
                    System.Windows.Forms.MessageBox.Show(ex.Message);
                }
                this.dataGridViewSynColAgeText.DataSource = this._dtSynColAgeText;
                if (this._dtSynColAgeText.Rows.Count > 0)
                {
                    this.dataGridViewSynColAgeText.Columns[1].ReadOnly = true;
                    this.dataGridViewSynColAgeText.Columns[2].ReadOnly = true;
                    if (this.dataGridViewSynColAgeText.Columns.Count > 3)
                        this.dataGridViewSynColAgeText.Columns[3].ReadOnly = true;
                    if (this.dataGridViewSynColAgeText.Columns.Count > 4)
                        this.dataGridViewSynColAgeText.Columns[4].Visible = false;
                    this.dataGridViewSynColAgeText.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                    this.labelSynColAgeTextCheckSimilarResult.Text = this._dtSynColAgeText.Rows.Count.ToString() + " matches found";
                    this.buttonSynColAgeTextUpdate.Enabled = true;
                }
                else
                {
                    this.dataGridViewSynColAgeText.DataSource = this._dtSynColAgeText;
                    this.labelSynColAgeTextCheckSimilarResult.Text = "No match found";
                    this.buttonSynColAgeTextUpdate.Enabled = false;
                }
                this.labelSynColAgeTextCheck.Text = "";
                this._SynColAgeTextCheckWithLike = true;

            }
            catch (System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonSynColAgeTextSelect_Click(object sender, EventArgs e)
        {
            try
            {
                if (!_SynColAgeTextCheckWithLike && !this.checkBoxSynColAgeTextCheckUnique.Checked)
                {
                    System.Windows.Forms.MessageBox.Show("Resticted to search for similar names");
                    return;
                }
                bool RowWithoutLinkSelected = this.dataGridViewSynColAgeText.SelectedRows.Count == 1;
                if (RowWithoutLinkSelected)// && this.dataGridViewSynColAgeText.SelectedRows != null && this.dataGridViewSynColAgeText.SelectedRows.Count > 0)
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.dataGridViewSynColAgeText.SelectedRows[0].DataBoundItem;
                    //string Column = this.SynColAgeText_TableColumn(true).Substring(this.SynColAgeText_TableColumn(true).IndexOf(".") + 1);
                    if (R["AgentURI"].ToString() != "")
                        RowWithoutLinkSelected = false;
                    if (RowWithoutLinkSelected)
                    {
                        System.Data.DataTable dtSelect = new DataTable();
                        string SQL = this.SynColAgeText_SelectClause(true, R.Row);
                        DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dtSelect, sqlConnectionSynColAgeText);
                        DiversityWorkbench.Forms.FormGetRowFromTable f = new DiversityWorkbench.Forms.FormGetRowFromTable("Valid agent", "Please select the valid agent from the list", dtSelect);
                        DiversityWorkbench.Agent A = new DiversityWorkbench.Agent(DiversityWorkbench.Settings.ServerConnection);
                        f.SetDetailLinkColumn("AgentURI", A);
                        f.ShowDialog();
                        if (f.SeletedRows().Count == 1 && f.DialogResult == DialogResult.OK)
                        {
                            R.BeginEdit();
                            R["AgentURI"] = f.SeletedRow()[1].ToString();
                            R[0] = true;
                            R[1] = f.SeletedRow()[0].ToString();
                            R.EndEdit();
                        }
                    }
                }
                else
                    RowWithoutLinkSelected = false;
                if (!RowWithoutLinkSelected)
                    System.Windows.Forms.MessageBox.Show("Please select a row missing a valid link");
            }
            catch(System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private enum SqlValueType { ColumnContent, QueryRestriction, TableColumn }

        private string SqlValueLike(string Value, SqlValueType type)
        {
            switch(type)
            {
                case SqlValueType.ColumnContent:
                    return Value.Replace("[", "[ [ ]").Replace("'", "''");
                case SqlValueType.QueryRestriction:
                    return Value.Replace("*", "%").Replace("'", "''");
                case SqlValueType.TableColumn:
                    return Value.Replace("'", "''");
            }
            return Value;
        }

        #endregion


        #endregion

        #region Split collectors

        private void initSplitCollectors()
        {
            this.SynColAgeSplit_ResetCollision();
            this.comboBoxSynColAgeSplitCollectors.Items.Add(", ");
        }

        private void buttonColAgeSplitCollectorsCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSynColAgeSplitCollectors.SelectedRows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            this.SynColAgeSplit_ResetCollision();
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewSynColAgeSplitCollectors.SelectedRows[0];
            bool OK = true;
            try { string test = R.Cells["CollectionSpecimenID"].Value.ToString(); }
            catch { OK = false; }
            if (OK)
            {
                if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
                {
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                else
                    this.DialogResult = DialogResult.Cancel;
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before searching for possible splits");
            }
        }

        private string AgentSplitCollector1() { return "RTRIM(LTRIM(SUBSTRING(A.CollectorsName, 1, PATINDEX('%" + this.comboBoxSynColAgeSplitCollectors.Text + "%', A.CollectorsName) - 1)))"; }
        private string AgentSplitCollector2() { return "RTRIM(LTRIM(SUBSTRING(A.CollectorsName, PATINDEX('%" + this.comboBoxSynColAgeSplitCollectors.Text + "%', A.CollectorsName) + LEN('" + this.comboBoxSynColAgeSplitCollectors.Text + "') - 0, 500)))"; }

        private void buttonColAgeSplitCollectorsSearch_Click(object sender, EventArgs e)
        {
            this.SplitCollectorsSearch();
        }

        private void SplitCollectorsSearch(bool ResetCollisions = true)
        {
            try
            {
                if (ResetCollisions)
                    this.SynColAgeSplit_ResetCollision();
                string OK = "CASE WHEN LEN(" + this.AgentSplitCollector1() + ") < 1 OR LEN(" + this.AgentSplitCollector2() + ") < 1 THEN 0 ELSE 1 END ";
                string SQL = "SELECT ";
                if (!this.checkBoxColAgeSplitCollectorsIncludeAccNr.Checked)
                    SQL += "DISTINCT";
                SQL += " CAST(" + OK + " AS BIT) AS OK, A.CollectorsName AS Collectors, " +
                    this.AgentSplitCollector1() + " AS [Collector 1], " +
                    this.AgentSplitCollector2() + " AS [Collector 2] ";
                if (this.checkBoxColAgeSplitCollectorsIncludeAccNr.Checked)
                {
                    SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";
                }
                SQL += this.CollectorsSplitFromClause;
                this._dtSynColAgeSplit = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(this._dtSynColAgeSplit);
                this.dataGridViewSynColAgeSplitCollectors.DataSource = this._dtSynColAgeSplit;
                if (this.checkBoxColAgeSplitCollectorsIncludeAccNr.Checked)
                    this.buttonColAgeSplitCollectorsCheckDataset.Visible = true;
                else this.buttonColAgeSplitCollectorsCheckDataset.Visible = false;
                if (this._dtSynColAgeSplit.Rows.Count > 0)
                    this.buttonColAgeSplitCollectorsStart.Enabled = true;
                else this.buttonColAgeSplitCollectorsStart.Enabled = false;
                for (int i = 1; i < this.dataGridViewSynColAgeSplitCollectors.Columns.Count; i++)
                {
                    if (i == 2 || i == 3) continue;
                    this.dataGridViewSynColAgeSplitCollectors.Columns[i].ReadOnly = true;
                }
                this.dataGridViewSynColAgeSplitCollectors.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonColAgeSplitCollectorsStart_Click(object sender, EventArgs e)
        {
            this.SplitCollectors();
            return;

            int UpdatedDatasets = 0;
            int Collisions = 0;
            string Split_1 = "";
            string Split_2 = "";
            bool NotAllCollectorsSelected = false;
            string SelectedCollectors = "";
            string SelectedCollectionSpecimenID = "";
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColAgeSplitCollectors.Rows)
            {
                if (R.Cells[0].Value.ToString().ToLower() == "true")
                {
                    if (SelectedCollectors.Length > 0) SelectedCollectors += ", ";
                    SelectedCollectors += "'" + R.Cells[1].Value.ToString() + "'";
                    if (this.checkBoxColAgeSplitCollectorsIncludeAccNr.Checked)
                    {
                        if (SelectedCollectionSpecimenID.Length > 0) SelectedCollectionSpecimenID += ", ";
                        SelectedCollectionSpecimenID += R.Cells[5].Value.ToString();
                    }
                    UpdatedDatasets++;
                }
                else NotAllCollectorsSelected = true;
            }

            string SQL = this.CollectorsSplitFromClause;
            if (NotAllCollectorsSelected && SelectedCollectors.Length > 0)
            {
                SQL += " AND A.CollectorsName IN (" + SelectedCollectors + ")";
                if (this.checkBoxColAgeSplitCollectorsIncludeAccNr.Checked && SelectedCollectionSpecimenID.Length > 0)
                    SQL += " AND A.CollectionSpecimenID IN (" + SelectedCollectionSpecimenID + ")";
            }
            else if (NotAllCollectorsSelected && SelectedCollectors.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }
            // Markus 21.4.23: Bereits vorhandene Sammler mit gleichem Namen wuerden kollidieren
            SQL += "AND NOT EXISTS (SELECT * FROM CollectionAgent AS AA WHERE AA.CollectorsName = " + AgentSplitCollector2() + " AND AA.CollectionSpecimenID = P.CollectionSpecimenID)";
            string SqlInsert = "INSERT INTO CollectionAgent " +
                "(CollectionSpecimenID, CollectorsName, CollectorsNumber, Notes, DataWithholdingReason) " +
                "SELECT A.CollectionSpecimenID, " + this.AgentSplitCollector2() + " AS CollectorsName, A.CollectorsNumber, " +
                "A.Notes, A.DataWithholdingReason " + SQL;
            string SqlUpdate = " UPDATE A SET CollectorsName = " + this.AgentSplitCollector1() + SQL;
            Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            string SqlFinal = "BEGIN TRY BEGIN TRANSACTION " + SqlInsert + ";" + SqlUpdate + "; SELECT " + UpdatedDatasets.ToString() + "; COMMIT TRANSACTION END TRY BEGIN CATCH ROLLBACK TRANSACTION; SELECT 'Update failed'; END CATCH;";
            Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SqlFinal, con);
            string Message = "";
            try
            {
                con.Open();
                Message = C.ExecuteScalar()?.ToString() ?? string.Empty;
                Message += this.SynColAgeSplit_CheckCollision();
                this.labelSynColPlotCheck.Text = "";
            }
            catch (Exception ex)
            {
            }
            finally
            {
                if (Message.Length > 0 && Message.IndexOf(' ') > -1)
                    System.Windows.Forms.MessageBox.Show(Message + "\r\nPlease check collectors");
                else
                {
                    System.Windows.Forms.MessageBox.Show("Update of " + UpdatedDatasets.ToString() + " datasets finished");
                }
                this.dataGridViewSynColAgeSplitCollectors.DataSource = null;
                con.Close();
            }
        }

        private int _SplitCollectorsUpdates = 0;
        private int _SplitCollectorsCollisions = 0;
        private void SplitCollectors()
        {
            try
            {
                this.progressBarColAgeSplitCollectors.Value = 0;
                this.progressBarColAgeSplitCollectors.Maximum = this.SplitCollectorsCount();

                if (this._dtSynColAgeSplit != null)
                {
                    //this._dtSynColAgeSplit.AcceptChanges();

                    _SplitCollectorsUpdates = 0;
                    _SplitCollectorsCollisions = 0;
                    this._dtSynColAgeSplitCollisions = new DataTable();

                    string Message = "";
                    using (Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString))
                    {
                        con.Open();
                        string SQL = "begin try create table ##Result(Split int, Failed int); " +
                            "insert into ##Result(Split, Failed) Values(0, 0); end try begin catch end catch;";
                        Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                        C.ExecuteNonQuery();
                        foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColAgeSplitCollectors.Rows)
                        {
                            if (R.Cells[0].Value.ToString().ToLower() == "true")
                            {
                                System.Data.DataRow dataRow = this._dtSynColAgeSplit.Rows[R.Cells[0].RowIndex];
                                this.SplitCollectors(dataRow, ref Message, con);
                                if (this.progressBarColAgeSplitCollectors.Value < this.progressBarColAgeSplitCollectors.Maximum)
                                    this.progressBarColAgeSplitCollectors.Value++;
                            }
                        }
                        C.CommandText = "select top 1 Split from ##Result";
                        int.TryParse(C.ExecuteScalar()?.ToString(), out _SplitCollectorsUpdates);
                        C.CommandText = "select top 1 Failed from ##Result";
                        int.TryParse(C.ExecuteScalar()?.ToString(), out _SplitCollectorsCollisions);
                        con.Close();
                    }
                    //if (Message.Length > 0) Message = "Failed splits:\r\n" + Message;
                    if (_SplitCollectorsCollisions > 0) Message = _SplitCollectorsCollisions + " collisions\r\n" + Message;
                    if (_SplitCollectorsUpdates > 0) Message = _SplitCollectorsUpdates + " collector splits successful\r\n" + Message;
                    System.Windows.Forms.MessageBoxIcon messageBoxIcon = MessageBoxIcon.Information;
                    if (_SplitCollectorsCollisions > 0) messageBoxIcon = MessageBoxIcon.Error;
                    System.Windows.Forms.MessageBox.Show(Message, "finished",MessageBoxButtons.OK, messageBoxIcon);
                    if (_dtSynColAgeSplitCollisions.Rows.Count > 0)
                        this.SynColAgeSplit_CheckCollision();
                    this.SplitCollectorsSearch(false);
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
            }
        }

        private int SplitCollectorsCount()
        {
            int i = 0;
            if (dataGridViewSynColAgeSplitCollectors.DataSource != null && dataGridViewSynColAgeSplitCollectors.Rows.Count > 0)
            {
                foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColAgeSplitCollectors.Rows)
                {
                    if (R.Cells[0].Value.ToString().ToLower() == "true")
                    {
                        i++;
                    }
                }
            }
            return i;
        }

        private string CollectorsSplitFromClause
        {
            get
            {
                string SQL = "FROM CollectionAgent AS A INNER JOIN " +
                   "CollectionProject AS P ON A.CollectionSpecimenID = P.CollectionSpecimenID ";
                if (this.checkBoxColAgeSplitCollectorsIncludeAccNr.Checked)
                {
                    SQL = "FROM CollectionAgent AS A INNER JOIN " +
                        "CollectionProject AS P ON A.CollectionSpecimenID = P.CollectionSpecimenID INNER JOIN " +
                        "CollectionSpecimen AS S ON A.CollectionSpecimenID = S.CollectionSpecimenID AND P.CollectionSpecimenID = S.CollectionSpecimenID";
                }
                SQL += " WHERE P.ProjectID = " + this.comboBoxSynColAgeSplitCollectorsProject.SelectedValue.ToString() +
                    " AND (A.CollectorsAgentURI IS NULL OR A.CollectorsAgentURI = '') AND (A.CollectorsName LIKE N'%" + this.comboBoxSynColAgeSplitCollectors.Text + "%')" +
                    " AND " + this.AgentSplitCollector1() + " <> " + this.AgentSplitCollector2();
                return SQL;
            }
        }


        private void SplitCollectors(System.Data.DataRow R, ref string Message, Microsoft.Data.SqlClient.SqlConnection con)
        {
            try
            {
                string SQL = "select top 1 Failed from ##Result";
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                int i = 0;
                int.TryParse(C.ExecuteScalar()?.ToString(), out i);

                SQL = this.SplitCollectorsFromClause(R["Collectors"].ToString());
                if (this.checkBoxColAgeSplitCollectorsIncludeAccNr.Checked && R.Table.Columns.Contains("CollectionSpecimenID"))
                    SQL += " AND A.CollectionSpecimenID = " + R["CollectionSpecimenID"].ToString() + " ";

                string SqlInsert = "INSERT INTO CollectionAgent " +
                    "(CollectionSpecimenID, CollectorsName, CollectorsNumber, Notes, DataWithholdingReason) " +
                    "SELECT A.CollectionSpecimenID, '" + R[2].ToString() + "' AS CollectorsName, A.CollectorsNumber, " +
                    "A.Notes, A.DataWithholdingReason " + SQL;
                string SqlUpdate = " UPDATE A SET CollectorsName = '" + R[3].ToString() + "' " + SQL;
                string SqlFinal = "BEGIN TRY BEGIN TRANSACTION " + SqlInsert + ";" + SqlUpdate + "; UPDATE ##Result SET Split = Split + 1; "+
                    "COMMIT TRANSACTION END TRY BEGIN CATCH ROLLBACK TRANSACTION; UPDATE ##Result SET Failed = Failed + 1; END CATCH; ";
                C.CommandText = SqlFinal;
                C.ExecuteNonQuery();

                C.CommandText = "select top 1 Failed from ##Result";
                int f;
                if (int.TryParse(C.ExecuteScalar()?.ToString(), out f) && f > i)
                    this.SynColAgeSplit_CheckCollision(R);

                //try
                //{
                //    string Result = C.ExecuteScalar()?.ToString();
                //    int i;
                //    if (int.TryParse(Result, out i) && i != 20)
                //    {
                //        _SplitCollectorsUpdates++;

                //    }
                //    else
                //    {
                //        int Collision = this.SynColAgeSplit_CheckCollision(R);
                //        if (Collision > 0)
                //            _SplitCollectorsCollisions += Collision;
                //            //Message += Collision + "\r\n";
                //    }
                //    //this.labelSynColPlotCheck.Text = "";
                //}
                //catch (Exception ex)
                //{
                //    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                //}
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private string SplitCollectorsFromClause(string Collectors)
        {
            string SQL = "FROM CollectionAgent AS A INNER JOIN " +
               "CollectionProject AS P ON A.CollectionSpecimenID = P.CollectionSpecimenID ";
            SQL += " AND P.ProjectID = " + this.comboBoxSynColAgeSplitCollectorsProject.SelectedValue.ToString() +
                " AND (A.CollectorsAgentURI IS NULL OR A.CollectorsAgentURI = '') " +
                " AND (A.CollectorsName = N'" + Collectors + "')";
            return SQL;
        }

        private void buttonColAgeSplitCollectorsNone_Click(object sender, EventArgs e)
        {
            //#173
            if (this._dtSynColAgeSplit == null || this._dtSynColAgeSplit.Rows.Count == 0) return;
            foreach (System.Data.DataRow R in this._dtSynColAgeSplit.Rows)
                R[0] = false;
        }

        private void buttonColAgeSplitCollectorsAll_Click(object sender, EventArgs e)
        {
            // #173
            if (this._dtSynColAgeSplit == null || this._dtSynColAgeSplit.Rows.Count == 0) return;
            foreach (System.Data.DataRow R in this._dtSynColAgeSplit.Rows)
                R[0] = true;
        }

        private void checkBoxColAgeSplitCollectorsIncludeAccNr_Click(object sender, EventArgs e)
        {
            this.buttonColAgeSplitCollectorsCheckDataset.Visible = this.checkBoxColAgeSplitCollectorsIncludeAccNr.Checked;
            if (this._dtSynColAgeSplit != null)
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                this.SplitCollectorsSearch();
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
        }

        #region Collision

        private void SynColAgeSplit_ResetCollision()
        {
            this.dataGridViewSynColAgeSplitCollisions.DataSource = null;
            this._dtSynColAgeSplitCollisions = new DataTable();
            if (this.tabControlSynColAgeSplit.TabPages.Contains(this.tabPageSynColAgeSplitCollisions))
                this.tabControlSynColAgeSplit.TabPages.Remove(this.tabPageSynColAgeSplitCollisions);
        }

        private string SynColAgeSplit_CheckCollision()
        {
            string Message = "";
            try
            {
                if (_dtSynColAgeSplitCollisions != null && _dtSynColAgeSplitCollisions.Rows.Count > 0)
                {
                    this.dataGridViewSynColAgeSplitCollisions.DataSource = _dtSynColAgeSplitCollisions;
                    Message = this._dtSynColAgeSplitCollisions.Rows.Count.ToString() + " collisions detected\r\n";
                    if (!this.tabControlSynColAgeSplit.TabPages.Contains(this.tabPageSynColAgeSplitCollisions))
                        this.tabControlSynColAgeSplit.TabPages.Add(this.tabPageSynColAgeSplitCollisions);
                }
                else
                {
                    this.dataGridViewSynColAgeSplitCollisions.DataSource = null;
                    if (this.tabControlSynColAgeSplit.TabPages.Contains(this.tabPageSynColAgeSplitCollisions))
                        this.tabControlSynColAgeSplit.TabPages.Remove(this.tabPageSynColAgeSplitCollisions);
                }
            }
            catch (System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
            return Message;
        }


        private int SynColAgeSplit_CheckCollision(System.Data.DataRow R)
        {
            int Count = 0;
            try
            {
                string SqlCollision = SplitCollectorsFromClause(R["Collectors"].ToString());
                SqlCollision += " INNER JOIN [CollectionAgent] AA ON  A.CollectionSpecimenID = AA.CollectionSpecimenID " +
                    "AND A.CollectorsName <> AA.CollectorsName AND (AA.CollectorsName = '" + R[2].ToString() + "' ";
                SqlCollision += " OR AA.CollectorsName = N'" + R[3].ToString() + "') ";
                if (this.checkBoxColAgeSplitCollectorsIncludeAccNr.Checked && R.Table.Columns.Contains("CollectionSpecimenID"))
                    SqlCollision += " AND A.CollectionSpecimenID = " + R["CollectionSpecimenID"].ToString();
                string SQL = "SELECT COUNT(*) " + SqlCollision;
                if (int.TryParse(DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL), out Count) && Count > 0)
                {
                    if (_dtSynColAgeSplitCollisions == null) _dtSynColAgeSplitCollisions = new DataTable();
                    if (DiversityWorkbench.Forms.FormFunctions.SqlFillTable("SELECT AA.* " + SqlCollision, ref _dtSynColAgeSplitCollisions))
                    {
                        this.dataGridViewSynColAgeSplitCollisions.DataSource = _dtSynColAgeSplitCollisions;
                    }
                }
            }
            catch (System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
            return Count;
        }

        private void buttonSynColAgeSplitCollisionsCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSynColAgeSplitCollisions.SelectedCells.Count > 0)
            {
                System.Data.DataRow R = this._dtSynColAgeSplitCollisions.Rows[this.dataGridViewSynColAgeSplitCollisions.SelectedCells[0].RowIndex];
                int ID;
                if (int.TryParse(R[0].ToString(), out ID))
                {
                    this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                    DiversityCollection.Forms.FormCollectionSpecimen form = new Forms.FormCollectionSpecimen(ID, false, false, Forms.FormCollectionSpecimen.ViewMode.SingleInspectionMode);
                    form.Width = this.Width - 20;
                    form.Height = this.Height - 20;
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                    form.ShowDialog();
                }
            }
        }

        #endregion

        #endregion

        #endregion

        #region Sampling plots

        private Microsoft.Data.SqlClient.SqlConnection _ConnectionForSamplingPlotSynchronisation;

        private Microsoft.Data.SqlClient.SqlConnection ConnectionForSamplingPlotSynchronisation
        {
            get
            {
                if (this._ConnectionForSamplingPlotSynchronisation == null)
                {
                    this._ConnectionForSamplingPlotSynchronisation = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
                    //this.initSamplingPlotList();
                }
                return _ConnectionForSamplingPlotSynchronisation;
            }
            set { _ConnectionForSamplingPlotSynchronisation = value; }
        }

        private bool initSamplingPlotList()
        {
            bool OK = true;
            try
            {
                string SQL = "begin try drop table #SamplingPlotList end try begin catch end catch; " +
                    "create table #SamplingPlotList " +
                    "([PlotID] [int] Primary key , " +
                    "[PartOfPlotID] [int] NULL, " +
                    "[PlotIdentifier] [nvarchar](500) NOT NULL, " +
                    "[PlotGeography_Cache] [geography] NULL, " +
                    "[PlotGeometry_Cache] [geometry] NULL, " +
                    "[PlotDescription] [nvarchar](max) NULL, " +
                    "[InternalNotes] [nvarchar](max) NULL, " +
                    "[DisplayText] [nvarchar](max) NOT NULL, " +
                    "[URL] varchar(500) NOT NULL); " +
                    "insert into #SamplingPlotList " +
                    "(PlotID, PartOfPlotID, PlotIdentifier, PlotGeography_Cache, PlotGeometry_Cache, PlotDescription, InternalNotes, DisplayText, URL) " +
                    "SELECT S.PlotID, S.PartOfPlotID, S.PlotIdentifier, S.PlotGeography_Cache, S.PlotGeometry_Cache, S.PlotDescription, S.InternalNotes, S.DisplayText, B.BaseURL + CAST(S.PlotID AS varchar) " +
                    "from " + this.SamplingPlotSynchronisationDatabaseWithPrefix() + "ViewSamplingPlotList S, " + this.SamplingPlotSynchronisationDatabaseWithPrefix() + "ViewBaseURL B; ";
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, ConnectionForSamplingPlotSynchronisation);
                if (this.ConnectionForSamplingPlotSynchronisation.State == ConnectionState.Closed)
                    this.ConnectionForSamplingPlotSynchronisation.Open();
                C.ExecuteNonQuery();
            }
            catch (System.Exception ex)
            {
                OK = false;
            }
            return OK;
        }

        private string SamplingPlotSynchronisationDatabaseWithPrefix()
        {
            string DBwithPrefix = "";
            if (this._ServerConnectionForSamplingPlotSynchronisation != null)
            {
                if (this._ServerConnectionForSamplingPlotSynchronisation.LinkedServer != null
                    && this._ServerConnectionForSamplingPlotSynchronisation.LinkedServer.Length > 0)
                    DBwithPrefix = "[" + this._ServerConnectionForSamplingPlotSynchronisation.LinkedServer + "].";
                DBwithPrefix += this._ServerConnectionForSamplingPlotSynchronisation.DatabaseName + ".dbo.";
            }
            return DBwithPrefix;
        }

        private DiversityWorkbench.ServerConnection _ServerConnectionForSamplingPlotSynchronisation;

        private void comboBoxSynColPlotDatabase_SelectionChangeCommitted(object sender, EventArgs e)
        {
            this._ServerConnectionForSamplingPlotSynchronisation = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversitySamplingPlots"].ServerConnectionList()[this.comboBoxSynColPlotDatabase.SelectedItem.ToString()];
            this.labelSynColPlotDatabase.Text = this._ServerConnectionForSamplingPlotSynchronisation.DatabaseName;
            this.initSamplingPlotList();
        }

        private void comboBoxSynColPlotDatabase_SelectedIndexChanged(object sender, EventArgs e)
        {
        }

        private void buttonSynColPlotCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSynColPlot.SelectedRows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewSynColPlot.SelectedRows[0];
            if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
            {
                this.DialogResult = DialogResult.OK;
                this.Close();
            }
            else
                this.DialogResult = DialogResult.Cancel;
        }

        private void buttonSynColPlotCheck_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            this.labelSynColPlotCheck.BackColor = System.Drawing.SystemColors.Control;
            this.labelSynColPlotCheck.ForeColor = System.Drawing.Color.Black;
            try
            {
                bool setColumnWidth = true;
                string Database = this._ServerConnectionForSamplingPlotSynchronisation.DatabaseName;// SC.DatabaseName;
                if (Database.Length == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a database");
                    return;
                }
                string Objekt = this.SamplingPlotTarget;
                if (Objekt.Length == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a target");
                    return;
                }
                if (this.SamplingPlotProject == null)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a project");
                    return;
                }

                int ProjectID = (int)this.SamplingPlotProject;

                string SQL = "SELECT DISTINCT ";
                if (this.dataGridViewSynColPlot.ColumnCount > 1) setColumnWidth = false;
                string SqlOrderBy = "";
                switch (Objekt)
                {
                    case "Plot":
                        SQL += " L.Location2 AS URL , cast(1 as bit) as OK, L.Location1 AS [Plot in Collection], S.DisplayText AS [Plot in SamplingPlots] ";
                        break;
                    case "Cached coordinates":
                    case "Geography":
                        SQL += " L.Location2 AS URL , cast(1 as bit) as OK, L.Location1 AS [Plot in Collection], " +
                            "L.Geography.ToString() AS [Geography in Collection], S.Geography AS [Geography in SamplingPlots], " +
                            "L.AverageLatitudeCache AS [Latitude in Collection], S.Latitude AS [Latitude in SamplingPlots], " +
                            "L.AverageLongitudeCache AS [Longitude in Collection], S.Longitude AS [Longitude in SamplingPlots]";
                        break;
                }
                if (this.checkBoxSynColPlotIncludeAccNr.Checked)
                    SQL += ", C.AccessionNumber, C.CollectionSpecimenID ";
                SQL += this.SamplingPlotsFromClause;
                SqlOrderBy = " ORDER BY L.Location1";
                SQL += SqlOrderBy;
                this._dtSynColPlot = new DataTable();
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, this.ConnectionForSamplingPlotSynchronisation);// con);
                if (this.ConnectionForSamplingPlotSynchronisation.State == ConnectionState.Closed)
                    this.ConnectionForSamplingPlotSynchronisation.Open();
                C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(C);

                ad.Fill(this._dtSynColPlot);
                this.dataGridViewSynColPlot.Columns.Clear();
                this.dataGridViewSynColPlot.DataSource = this._dtSynColPlot;
                this.dataGridViewSynColPlot.Columns[0].Width = 30;
                this.dataGridViewSynColPlot.ReadOnly = false;
                this.dataGridViewSynColPlot.Columns[0].Visible = false;
                this.dataGridViewSynColPlot.Columns[1].ReadOnly = false;
                this.dataGridViewSynColPlot.Columns[2].ReadOnly = true;
                this.dataGridViewSynColPlot.Columns[3].ReadOnly = true;
                switch (Objekt)
                {
                    case "Plot":
                        if (this.checkBoxSynColPlotIncludeAccNr.Checked)
                        {
                            this.dataGridViewSynColPlot.Columns[4].ReadOnly = true;
                            this.dataGridViewSynColPlot.Columns[5].ReadOnly = true;
                        }
                        break;
                    case "Cached coordinates":
                    case "Geography":
                        if (this.checkBoxSynColPlotIncludeAccNr.Checked)
                        {
                            this.dataGridViewSynColPlot.Columns[4].ReadOnly = true;
                            this.dataGridViewSynColPlot.Columns[5].ReadOnly = true;
                            this.dataGridViewSynColPlot.Columns[6].ReadOnly = true;
                        }
                        break;
                }
                if (this._dtSynColPlot.Rows.Count > 0)
                {
                    this.labelSynColPlotCheck.Text = this._dtSynColPlot.Rows.Count.ToString() + " differences found";
                    this.buttonSynColPlotStart.Enabled = true;
                }
                else
                {
                    this.labelSynColPlotCheck.Text = "No differences found";
                    this.buttonSynColPlotStart.Enabled = false;
                }
                this.dataGridViewSynColPlot.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.ColumnHeader);
                //if (this.dataGridViewSynColTax.ColumnCount > 0 && setColumnWidth)
                //{
                //    this.dataGridViewSynColPlot.Columns[0].Width = (int)this.dataGridViewSynColPlot.Width * 3 / 8;
                //    this.dataGridViewSynColPlot.Columns[1].Width = (int)this.dataGridViewSynColPlot.Width * 3 / 8;
                //}
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                if (ex.Message.ToLower().IndexOf("timeout") != -1)
                {
                    this.labelSynColPlotCheck.Text = "Timeout expired";
                    this.labelSynColPlotCheck.BackColor = System.Drawing.Color.Red;
                    this.labelSynColPlotCheck.ForeColor = System.Drawing.Color.White;
                }
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonSynColPlotStart_Click(object sender, EventArgs e)
        {
            //System.Windows.Forms.MessageBox.Show("available in future version");
            //return;
            int UpdatedDatasets = 0;
            bool NotAllPlotsSelected = false;
            string SelectedPlotURIs = "";
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColPlot.Rows)
            {
                if (R.Cells[1].Value.ToString().ToLower() == "true")
                {
                    if (SelectedPlotURIs.Length > 0) SelectedPlotURIs += ", ";
                    SelectedPlotURIs += "'" + R.Cells[0].Value.ToString() + "'";
                    UpdatedDatasets++;
                }
                else NotAllPlotsSelected = true;
            }

            string SQL = "UPDATE L SET ";
            switch (this.SamplingPlotTarget)
            {
                case "Plot":
                    SQL += "L.Location1 = S.DisplayText ";
                    break;
                case "Cached coordinates":
                case "Geography":
                    SQL += " L.Geography = geography::STGeomFromText(S.Geography, 4326), " +
                        "L.AverageLatitudeCache = S.Latitude, " +
                        "L.AverageLongitudeCache = S.Longitude ";
                    break;
            }
            SQL += this.SamplingPlotsFromClause;
            if (NotAllPlotsSelected && SelectedPlotURIs.Length > 0)
                SQL += " AND L.Location2 IN (" + SelectedPlotURIs + ")";
            else if (NotAllPlotsSelected && SelectedPlotURIs.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }
            //Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, this.ConnectionForSamplingPlotSynchronisation);// con);
            C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
            string Message = "";
            try
            {
                //con.Open();
                if (this.ConnectionForSamplingPlotSynchronisation.State == ConnectionState.Closed)
                    this.ConnectionForSamplingPlotSynchronisation.Open();
                this.labelSynColPlotCheck.Text = "";
                C.ExecuteNonQuery();
                Message = "Update of " + UpdatedDatasets.ToString() + " dataset(s) finished";
            }
            catch (Exception ex)
            {
                Message = "Update failed (" + ex.Message + ")";
            }
            finally
            {
                this.dataGridViewSynColPlot.DataSource = null;
                //con.Close();
            }
            if (Message.Length > 0 && Message.IndexOf(' ') > -1)
                System.Windows.Forms.MessageBox.Show(Message);
        }

        private string SamplingPlotsFromClause
        {
            get
            {
                string SQL = " FROM ";// Prefix;
                if (SamplingPlotTarget == "Geography" || SamplingPlotTarget == "Cached coordinates")
                {
                    SQL += this.SamplingPlotSynchronisationDatabaseWithPrefix() + "ViewSamplingPlotGeoInfo";
                }
                else SQL += "#SamplingPlotList";// "ViewSamplingPlotList ";
                SQL += " AS S, ";// " + this.SamplingPlotSynchronisationDatabaseWithPrefix() /*Prefix*/ + "ViewBaseURL AS U, ";
                SQL += " CollectionEventLocalisation AS L , CollectionSpecimen AS C , CollectionProject AS P  " +
                    " WHERE L.LocalisationSystemID = 13 " +
                    //" AND L.Location2 LIKE U.BaseURL + '%' " +
                    " AND P.ProjectID = " + this.SamplingPlotProject.ToString() +
                    " AND S.URL = L.Location2 " +
                    //" AND (U.BaseURL + cast(S.PlotID as varchar)) = L.Location2 " +
                    " AND C.CollectionSpecimenID = P.CollectionSpecimenID " +
                    " AND L.CollectionEventID = C.CollectionEventID ";
                switch (SamplingPlotTarget)
                {
                    case "Cached coordinates":
                        SQL += "AND (round(L.AverageLatitudeCache, 4) <> round(S.Latitude, 4) " +
                            "or round(L.AverageLongitudeCache, 4) <> round(S.Longitude, 4)" +
                            "or (not L.AverageLatitudeCache is null and S.Latitude is null) " +
                            "or (L.AverageLatitudeCache is null and not S.Latitude is null)) ";
                        break;
                    case "Geography":
                        SQL += "AND CASE WHEN L.Geography IS NULL THEN '' ELSE L.Geography.ToString() END <> S.Geography ";
                        break;
                    case "Plot":
                        SQL += "AND (L.Location1 COLLATE DATABASE_DEFAULT <> S.DisplayText COLLATE DATABASE_DEFAULT OR L.Location1 IS NULL) ";
                        break;
                }
                return SQL;
            }
        }

        private string SamplingPlotTarget
        {
            get
            {
                return this.comboBoxSynColPlot.Text;
            }
        }

        private string SamplingPlotDatabase
        {
            get
            {
                return this.comboBoxSynColPlotDatabase.Text;
            }
        }

        private int? SamplingPlotProject
        {
            get
            {
                if (this.comboBoxSynColPlotProject.SelectedIndex == -1)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a project");
                    return null;
                }
                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColPlotProject.SelectedItem;
                int ProjectID = 0;
                if (this.comboBoxSynColPlotProject.SelectedItem != null)
                {
                    System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColPlotProject.SelectedItem;
                    if (!int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                        return null;
                }
                else if (!int.TryParse(this.comboBoxSynColPlotProject.SelectedValue.ToString(), out ProjectID))
                    return null;
                return ProjectID;
            }
        }

        private void checkBoxSynColPlotIncludeAccNr_CheckedChanged(object sender, EventArgs e)
        {
            if (this.checkBoxSynColPlotIncludeAccNr.Checked) this.buttonSynColPlotCheckDataset.Visible = true;
            else this.buttonSynColPlotCheckDataset.Visible = false;
        }

        private void buttonSynColPlotGeographySearch_Click(object sender, EventArgs e)
        {
            try
            {
                string Database = this.SamplingPlotDatabase;
                if (Database.Length == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a database");
                    return;
                }

                string SQL = "declare @IDs varchar(8000); " +
                    "set @IDs = ''; " +
                    "declare @TabIDs table (ID int  Primary key); " +
                    "insert into @TabIDs  " +
                    "SELECT DISTINCT S.PlotID  " +
                    "FROM " + this.SamplingPlotDatabase + ".dbo.SamplingPlot AS S , CollectionEventLocalisation AS L   " +
                    "WHERE L.LocalisationSystemID = 13  AND L.Location2 LIKE " + this.SamplingPlotDatabase + ".dbo.BaseURL() + '%' " +
                    "AND (" + this.SamplingPlotDatabase + ".dbo.BaseURL() + cast(S.PlotID as varchar)) = L.Location2  " +
                    "while (select COUNT(*) from @TabIDs ) > 0 AND LEN(@IDs) < 7990 " +
                    "begin " +
                    "if (@IDs <> '') " +
                    "begin set @IDs = @IDs + ',' end " +
                    "set @IDs = @IDs + cast((select MIN(ID) from @TabIDs) as varchar) " +
                    "delete t from @TabIDs t where t.ID = (select MIN(ID) from @TabIDs) " +
                    "end " +
                    "SELECT DISTINCT S.PlotID, L.Location2 AS URL , cast(CASE WHEN L.Geography IS NULL then 1 else 0 end as bit) as OK, L.Location1 AS [Plot in Collection], L.Geography.ToString() AS [Geography in Collection], " +
                    "S.Geography.ToString() AS [Geography in SamplingPlots], L.AverageLatitudeCache AS [Latitude in Collection], S.Geography.EnvelopeCenter().Lat  " +
                    "AS [Latitude in SamplingPlots], L.AverageLongitudeCache AS [Longitude in Collection], S.Geography.EnvelopeCenter().Long AS [Longitude in SamplingPlots] " +
                    "FROM " + this.SamplingPlotDatabase + ".dbo.SamplingPlotGeography(@IDs) AS S , CollectionEventLocalisation AS L   " +
                    "WHERE L.LocalisationSystemID = 13  " +
                    "AND (" + this.SamplingPlotDatabase + ".dbo.BaseURL() + cast(S.PlotID as varchar)) = L.Location2   " +
                    "AND CASE WHEN L.Geography IS NULL THEN '' ELSE L.Geography.ToString() END <> S.Geography.ToString() ORDER BY L.Location1 ";

                this._dtSynColPlot = new DataTable();

                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(C);

                ad.Fill(this._dtSynColPlot);
                this.dataGridViewSynColPlot.Columns.Clear();
                this.dataGridViewSynColPlot.DataSource = this._dtSynColPlot;
                this.dataGridViewSynColPlot.ReadOnly = false;
                this.dataGridViewSynColPlot.Columns[0].Visible = false;
                this.dataGridViewSynColPlot.Columns[1].Visible = false;
                this.dataGridViewSynColPlot.Columns[2].ReadOnly = false;
                this.dataGridViewSynColPlot.Columns[3].ReadOnly = true;
                this.dataGridViewSynColPlot.Columns[4].ReadOnly = true;
                this.buttonSynColPlotStart.Enabled = false;
                if (this._dtSynColPlot.Rows.Count > 0)
                {
                    this.labelSynColPlotCheck.Text = this._dtSynColPlot.Rows.Count.ToString() + " differences found";
                    this.buttonSynColPlotGeographyUpdate.Enabled = true;
                }
                else
                {
                    this.labelSynColPlotCheck.Text = "No differences found";
                    this.buttonSynColPlotGeographyUpdate.Enabled = false;
                }
                this.dataGridViewSynColPlot.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.ColumnHeader);
            }
            catch (System.Exception ex) { }
        }

        private void buttonSynColPlotGeographyUpdate_Click(object sender, EventArgs e)
        {
            try
            {
                DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversitySamplingPlots"].ServerConnectionList()[this.SamplingPlotDatabase];
                string PlotIDs = "";
                foreach (System.Data.DataRow R in this._dtSynColPlot.Rows)
                {
                    bool Update;
                    if (bool.TryParse(R["OK"].ToString(), out Update) && Update)
                    {
                        if (PlotIDs.Length > 0) PlotIDs += ",";
                        PlotIDs += R[0].ToString();
                    }
                }
                string SQL = "UPDATE L SET L.Geography = S.Geography, L.AverageLatitudeCache = S.Geography.EnvelopeCenter().Lat " +
                    ", L.AverageLongitudeCache = S.Geography.EnvelopeCenter().Long " +
                    "FROM " + this.SamplingPlotDatabase + ".dbo.SamplingPlotGeography(" + PlotIDs + ") AS S , CollectionEventLocalisation AS L " +
                    "WHERE L.LocalisationSystemID = 13  " +
                    "AND (" + this.SamplingPlotDatabase + ".dbo.BaseURL() + cast(S.PlotID as varchar)) = L.Location2  ";
                if (SC.LinkedServer.Length > 0)
                {
                    SQL = "UPDATE L SET L.Geography = geography::STGeomFromText('' + S.Geography + '', 4326), L.AverageLatitudeCache = S.Latitude " +
                    ", L.AverageLongitudeCache = S.Longitude " +
                    "FROM [" + SC.LinkedServer + "]." + SC.DatabaseName + ".dbo.SamplingPlotGeoInfo AS S , CollectionEventLocalisation AS L " +
                    ", [" + SC.LinkedServer + "]." + SC.DatabaseName + ".dbo.ViewBaseURL U " +
                    "WHERE L.LocalisationSystemID = 13  " +
                    "AND (U.BaseURL + cast(S.PlotID as varchar)) = L.Location2  ";
                }
                DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL);
                this.buttonSynColPlotGeographySearch_Click(null, null);
            }
            catch (System.Exception ex)
            {
            }
        }

        private void buttonSynColPlotCheckNone_Click(object sender, EventArgs e)
        {
            // #173
            if (this._dtSynColPlot == null || this._dtSynColPlot.Rows.Count == 0) return;
            foreach (System.Data.DataRow R in this._dtSynColPlot.Rows)
                R["OK"] = false;
        }

        private void buttonSynColPlotCheckAll_Click(object sender, EventArgs e)
        {
            // #173
            if (this._dtSynColPlot == null || this._dtSynColPlot.Rows.Count == 0) return;
            foreach (System.Data.DataRow R in this._dtSynColPlot.Rows)
                R["OK"] = true;
        }

        #endregion

        #region Synchronization with ScientificTerms

        #region init

        private void initSynchronization_ScientificTerms()
        {
            try
            {
                InitSynchronizeTerm_Identification_Linked();
                InitSynchronizeTerm_Identification_Text();

                InitSynchronizeTerm_EventProperty_Linked();
                InitSynchronizeTerm_EventProperty_Text();

                InitSynchronizeTerm_PartDescription_Text();
                InitSynchronizeTerm_PartDescription_Linked();
            }
            catch(System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
        }

        #endregion

        #region Common

        #region Both
        public enum SynTermTargetTable { CollectionEventProperty, CollectionSpecimenPartDescription, Identification, NULL }

        private string _SynTerms_IconSpacer = "      ";
        private void SynTerm_SetDatabaseLabelText(System.Windows.Forms.Label label, bool Linked, SynTermTargetTable Table, string Database)
        {
            if (label.Image != null)
                label.Text = _SynTerms_IconSpacer;
            label.Text += "Database:";
            if (Linked)
                label.Text += SynTerms_Linked_ServerConnection_DisplayText(Table);
            else
            {
                label.Text += SynTerms_Text_ServerConnection_DisplayText(Table);
            }
        }

        private DiversityWorkbench.ServerConnection SynTerms_ServerConnection(Dictionary<SynTermTargetTable, DiversityWorkbench.ServerConnection> Dict, SynTermTargetTable Table, string Database = "")
        {
            if (Dict == null) Dict = new Dictionary<SynTermTargetTable, DiversityWorkbench.ServerConnection>();
            if (Database.Length > 0)
            {
                if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList().ContainsKey("DiversityScientificTerms"))
                {
                    if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList().ContainsKey(Database))
                    {
                        DiversityWorkbench.ServerConnection sc = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList()[Database];
                        Dict.Add(Table, sc);
                        return Dict[Table];
                    }
                    else
                        return null;
                }
                else
                    return null;
            }
            else if (Dict.ContainsKey(Table))
            {
                return Dict[Table];
            }
            else
                return null;
        }

        private string SynTerms_ServerConnection_DisplayText(SynTermTargetTable Table, bool Linked)
        {
            string DisplayText = _SynTerms_IconSpacer + "Database:";
            DiversityWorkbench.ServerConnection SC = null;
            if (Linked) SC = SynTerms_Linked_ServerConnection(Table);
            else SC = SynTerms_Text_ServerConnection(Table);
            if (SC != null && SC.LinkedServer.Length > 0)
                DisplayText = _SynTerms_IconSpacer + SC.DatabaseName;
            return DisplayText;
        }

        private string SynTerms_DatabasePrefix(SynTermTargetTable Table, bool Linked)
        {
            string Prefix = "";
            try
            {
                Dictionary<SynTermTargetTable, DiversityWorkbench.ServerConnection> Dict = null;
                if (Linked)
                {
                    Dict = _SynTerms_Linked_ServerConnections;
                }
                else
                {
                    Dict = _SynTerms_Text_ServerConnections;
                }
                if (Dict != null && Dict.ContainsKey(Table))
                {
                    DiversityWorkbench.ServerConnection sc = Dict[Table];
                    if (sc.LinkedServer.Length > 0)
                        Prefix = "[" + sc.LinkedServer + "].";
                    Prefix += ".dbo." + sc.DatabaseName;
                }
            }
            catch(System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
            return Prefix;
        }

        private void SynTerms_OpenDetails(System.Windows.Forms.DataGridView dataGridView)
        {
            try
            {
                if (dataGridView.SelectedCells.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a dataset");
                    return;
                }
                int Position = dataGridView.SelectedCells[0].RowIndex;
                if (int.TryParse(dataGridView.Rows[Position].Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
                {
                    DiversityCollection.Forms.FormCollectionSpecimen f = new Forms.FormCollectionSpecimen(this._CollectionSpecimenID, false, false);
                    f.setViewMode(Forms.FormCollectionSpecimen.ViewMode.SingleInspectionMode);
                    f.Width = this.Width - 10;
                    f.Height = this.Height - 10;
                    f.ShowDialog();
                }
                else
                {
                    System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
                    this.DialogResult = DialogResult.Cancel;
                }
            }
            catch (System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
        }



        #endregion


        #region Linked

        private string SynTerms_Linked_FromClause(SynTermTargetTable Table, System.Data.DataRow Row = null, bool ForUpdate = false)
        {
            // Tests
            string SQL = " FROM ";
            try
            {
                SQL += Table.ToString() + " AS T INNER JOIN CollectionSpecimen S ON T";
                int ProjectID;
                switch (Table)
                {
                    case SynTermTargetTable.CollectionEventProperty:
                        SQL += ".CollectionEventID = S.CollectionEventID AND T.PropertyURI";
                        break;
                    case SynTermTargetTable.CollectionSpecimenPartDescription:
                        SQL += ".CollectionSpecimenID = S.CollectionSpecimenID AND T.DescriptionTermURI";
                        break;
                    case SynTermTargetTable.Identification:
                        SQL += ".CollectionSpecimenID = S.CollectionSpecimenID AND T.TermURI";
                        break;
                }
                SQL += " LIKE '" + this._SynTermsLinkServerConnection.BaseURL + "%' ";

                if (Row != null && Row.Table.Columns.Contains("CollectionSpecimenID"))
                {
                    SQL += " AND S.CollectionSpecimenID = " + Row["CollectionSpecimenID"].ToString();
                }

                // getting the project
                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColTermProject.SelectedItem;
                if (int.TryParse(R["ProjectID"].ToString(), out ProjectID))
                    SQL += " INNER JOIN CollectionProject P ON S.CollectionSpecimenID = P.CollectionSpecimenID AND P.ProjectID = " + ProjectID.ToString();

                SQL += " CROSS JOIN " + _SynTermsLinkServerConnection.Prefix() + "ViewBaseURL AS B";
                SQL += " INNER JOIN " + _SynTermsLinkServerConnection.Prefix() + "TermRepresentation R ON T.";
                switch (Table)
                {
                    case SynTermTargetTable.CollectionEventProperty:
                        SQL += "PropertyURI";
                        break;
                    case SynTermTargetTable.CollectionSpecimenPartDescription:
                        SQL += "DescriptionTermURI";
                        break;
                    case SynTermTargetTable.Identification:
                        SQL += "TermURI";
                        break;
                }
                SQL += " = B.BaseURL + cast(R.RepresentationID as varchar) ";

                //if (Table == SynTermTargetTable.Identification && this.comboBoxSynColTermTarget.Text == "Hierarchy")
                //{
                //    SQL += "INNER JOIN IdentificationUnit U ON T.CollectionSpecimenID = U.CollectionSpecimenID AND U.IdentificationUnitID = T.IdentificationUnitID ";
                //}
                return SQL;
            }

            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex, SQL);
                SQL = "";
            }
            return SQL;
        }

        private string SynTerms_Linked_GroupClause(SynTermTargetTable Table, bool IncludeHierarchy = false, bool IncludeAccessionNumer = false) 
        {
            // Tests
            string SQL = " ";
            try
            {
                SQL += " GROUP BY T.";
                switch (Table)
                {
                    case SynTermTargetTable.CollectionEventProperty:
                        SQL += "DisplayText, T.PropertyURI ";
                        break;
                    case SynTermTargetTable.CollectionSpecimenPartDescription:
                        SQL += "Description, T.DescriptionTermURI ";
                        break;
                    case SynTermTargetTable.Identification:
                        SQL += "VernacularTerm, T.TermURI ";
                        break;
                }
                if (IncludeHierarchy)
                {
                    switch (this.SynTermLinkTargetSelectedTable)
                    {
                        case SynTermTargetTable.CollectionEventProperty:
                            SQL += ", T.PropertyHierarchyCache ";
                            break;
                        case SynTermTargetTable.CollectionSpecimenPartDescription:
                            SQL += ", T.DescriptionHierarchyCache ";
                            break;
                        case SynTermTargetTable.Identification:
                            SQL += ", U.HierarchyCache ";
                            break;
                    }
                }

                if (IncludeAccessionNumer)
                    SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex, SQL);
                SQL = "";
            }
            return SQL;
        }

        private string SynTerms_Linked_OrderClause(SynTermTargetTable Table)
        {
            string SQL = " ";
            try
            {
                SQL += " ORDER BY T.";
                switch (Table)
                {
                    case SynTermTargetTable.CollectionEventProperty:
                        SQL += "DisplayText";
                        break;
                    case SynTermTargetTable.CollectionSpecimenPartDescription:
                        SQL += "Description";
                        break;
                    case SynTermTargetTable.Identification:
                        SQL += "VernacularTerm";
                        break;
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex, SQL);
                SQL = "";
            }
            return SQL;
        }

        private System.Collections.Generic.Dictionary<SynTermTargetTable, DiversityWorkbench.ServerConnection> _SynTerms_Linked_ServerConnections;
        private DiversityWorkbench.ServerConnection SynTerms_Linked_ServerConnection(SynTermTargetTable Table, string Database = "")
        {
            return SynTerms_ServerConnection(_SynTerms_Linked_ServerConnections, Table, Database);
        }

        private string SynTerms_Linked_ServerConnection_DisplayText(SynTermTargetTable Table)
        {
            return SynTerms_ServerConnection_DisplayText(Table, true);
        }
        #endregion

        #region Text

        private System.Collections.Generic.Dictionary<SynTermTargetTable, DiversityWorkbench.ServerConnection> _SynTerms_Text_ServerConnections;
        private DiversityWorkbench.ServerConnection SynTerms_Text_ServerConnection(SynTermTargetTable Table, string Database = "")
        {
            return SynTerms_ServerConnection(_SynTerms_Text_ServerConnections, Table, Database);
        }

        private string SynTerms_Text_ServerConnection_DisplayText(SynTermTargetTable Table)
        {
            return SynTerms_ServerConnection_DisplayText(Table, false);
        }

        private void SynTerms_Text_SetTerminologySource(SynTermTargetTable Table, string SelectedDatabase, System.Windows.Forms.ComboBox TerminologyCombobox)
        {
            try
            {
                string ConnectionString = DiversityWorkbench.Settings.ConnectionString;
                string Database = this.comboBoxSynUnitTermsTextDatabase.Text;
                string LinkedServer = "";
                foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnections())
                {
                    if (KV.Value.DisplayText == SelectedDatabase)
                    {
                        ConnectionString = KV.Value.ConnectionString;
                        Database = KV.Value.DatabaseName;
                        LinkedServer = KV.Value.LinkedServer;
                        break;
                    }
                }

                System.Data.DataTable dt = new DataTable();
                string SQL = "SELECT NULL AS ProjectID, NULL AS Project " +
                    "UNION SELECT TerminologyID AS ProjectID, DisplayText AS Project " +
                    "FROM " + this.SynTerms_DatabasePrefix(Table, false) + "Terminology " +
                    "ORDER BY Project";
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, ConnectionString);
                ad.Fill(dt);
                TerminologyCombobox.DataSource = dt;
                TerminologyCombobox.DisplayMember = "Project";
                TerminologyCombobox.ValueMember = "ProjectID";
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }


        private void SynTerms_Text_Search(DiversityWorkbench.ServerConnection serverConnection, System.Windows.Forms.DataGridView dataGridView, System.Data.DataTable dataTable, System.Windows.Forms.ProgressBar progressBar)
        {
            try
            {
                dataGridView.DataSource = null;
                dataTable = new DataTable();
                int ProjectID = 0;
                string Group = "";
                if (!this.allValuesSetForUnitTermTextSynchro(ref ProjectID, ref Group)) return;
                bool setColumnWidth = true;

                this.SynTerms_Text_Synchronize(serverConnection, progressBar);

                if (dataGridView.ColumnCount > 1)
                    setColumnWidth = true;
                if (dataGridView.ColumnCount > 0 && setColumnWidth)
                {
                    dataGridView.Columns[0].AutoSizeMode = DataGridViewAutoSizeColumnMode.ColumnHeader;
                    dataGridView.Columns[1].AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells;
                    dataGridView.Columns[2].AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells;
                }
                dataGridView.ReadOnly = false;
                for (int i = 1; i < dataGridView.ColumnCount; i++)
                {
                    dataGridView.Columns[i].ReadOnly = true;
                }
                for (int i = 0; i < dataGridView.ColumnCount; i++)
                {
                    dataGridView.Columns[i].SortMode = DataGridViewColumnSortMode.NotSortable;
                }

                this.SynTerms_Text_SetGridColors(dataGridView);
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void SynTerms_Text_Synchronize(DiversityWorkbench.ServerConnection serverConnection, System.Windows.Forms.ProgressBar progressBar)
        {
            //#173
            if (this._dtSynUnitTermsText == null || this._dtSynUnitTermsText.Rows.Count == 0) { return; }
            if (serverConnection == null || serverConnection.ConnectionString.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a database");
                return;
            }
            if (serverConnection.DatabaseName.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a database");
                return;
            }

            string Message = "";
            System.Collections.Generic.List<System.Data.DataRow> RowsToDelete = new List<DataRow>();
            System.Data.DataTable dtQueryResults = new DataTable();

            this.SynchronizeColUnitTermsTextFillList();

            progressBar.Maximum = this._dtSynUnitTermsText.Rows.Count;
            progressBar.Minimum = 0;
            progressBar.Value = 0;
            progressBar.Visible = true;
            int i = 0;

            this._SynColUnitTermsTextNameLists = new Dictionary<string, DataTable>();

            string Prefix = serverConnection.DatabaseName + ".dbo.";
            if (this.SynchronizeColUnitTermsTextLinkedServer.Length > 0)
                Prefix = "[" + this.SynchronizeColUnitTermsTextLinkedServer + "]." + Prefix;

            Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter("", serverConnection.ConnectionString);
            Microsoft.Data.SqlClient.SqlConnection conRank = new Microsoft.Data.SqlClient.SqlConnection(serverConnection.ConnectionString);
            Microsoft.Data.SqlClient.SqlCommand cmdRank = new Microsoft.Data.SqlClient.SqlCommand("", conRank);
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            string SQL = "";
            foreach (System.Data.DataRow R in this._dtSynUnitTermsText.Rows)
            {
                try
                {
                    dtQueryResults.Clear();
                    string TermInCollection = R[1].ToString();

                    SQL = "SELECT U.BaseURL + CAST(T.RepresentationID AS VARCHAR(55)) AS TermURI, T.DisplayText ";
                    if (this.checkBoxSynUnitTermsTextIncludeHierarchy.Checked)
                    {
                        SQL += ", T.HierarchyCache";
                        if (this.radioButtonSynUnitTermsTextIncludeHierarchyDown.Checked)
                            SQL += "Down";
                        SQL += " AS Hierarchy ";
                    }
                    SQL += ", LanguageCode AS [Lang.] ";
                    SQL += "FROM " + Prefix + "ViewBaseURL AS U, ";
                    SQL += Prefix + "TermRepresentation AS T, ";
                    SQL += Prefix + "Term AS TT " +
                        " WHERE TT.TermID = T.TermID AND TT.IsRankingTerm = 0 AND T.TerminologyID = " + this.comboBoxSynUnitTermsTextTermProject.SelectedValue.ToString();
                    SQL += " AND (T.DisplayText = '" + TermInCollection + "')";
                    SQL += " GROUP BY dbo.BaseURL() + CAST(T.RepresentationID AS VARCHAR(55)), T.DisplayText, U.BaseURL, T.RepresentationID, LanguageCode ";
                    if (this.checkBoxSynUnitTermsTextIncludeHierarchy.Checked)
                    {
                        SQL += ", T.HierarchyCache";
                        if (this.radioButtonSynUnitTermsTextIncludeHierarchyDown.Checked)
                            SQL += "Down";
                    }
                    SQL += " ORDER BY T.DisplayText ";
                    try
                    {
                        ad.SelectCommand.CommandText = SQL;
                        ad.Fill(dtQueryResults);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }

                    if (dtQueryResults.Rows.Count > 0)
                    {
                        if (dtQueryResults.Rows.Count > 1)
                        {
                            if (!this._SynColUnitTermsTextNameLists.ContainsKey(TermInCollection))
                                this._SynColUnitTermsTextNameLists.Add(TermInCollection, dtQueryResults.Copy());
                            if (R.Table.Columns.Contains("Similarities"))
                                R["Similarities"] = dtQueryResults.Rows.Count;
                            R[0] = false;
                        }
                        else if (R[1].ToString() == R[2].ToString())
                            R[0] = true;
                        R[2] = dtQueryResults.Rows[0]["DisplayText"].ToString();
                        R[3] = dtQueryResults.Rows[0]["TermURI"].ToString();
                        if (dtQueryResults.Columns.Contains("Hierarchy") && dtQueryResults.Rows[0]["Hierarchy"].ToString().Length > 0)
                            R[4] = dtQueryResults.Rows[0]["Hierarchy"].ToString();

                    }
                    else
                        RowsToDelete.Add(R);

                    i++;
                    if (i < progressBar.Maximum)
                        progressBar.Value = i;
                }
                catch (System.Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex, R[1].ToString());
                    RowsToDelete.Add(R);
                }
            }

            // deleting the not synchronizable
            foreach (System.Data.DataRow R in RowsToDelete)
                R.Delete();
            this._dtSynUnitTermsText.AcceptChanges();

            if (this._dtSynUnitTermsText.Rows.Count > 0)
            {
                this.labelSynUnitTermsTextResult.Text = this._dtSynUnitTermsText.Rows.Count.ToString() + " matches to " + this.comboBoxSynUnitTermsTextDatabase.Text + " found";
                this.buttonSynUnitTermsTextUpdate.Enabled = true;
                try
                {
                    foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynUnitTermsText.Rows)
                    {
                        System.Drawing.Color C = System.Drawing.Color.White;
                        if (R.Cells[0].Value.ToString().ToLower() == "false")
                        {
                            C = System.Drawing.Color.LightYellow;
                            int Sim;
                            string Value = R.Cells[4].Value.ToString();
                            if (this.checkBoxSynUnitTermsTextIncludeAccNr.Checked)
                            {
                                Value = R.Cells[6].Value.ToString();
                            }
                            if (int.TryParse(Value, out Sim) && Sim > 1)
                            {
                                C = System.Drawing.Color.LightBlue;
                            }
                            else
                            {
                                string[] TermCollection = R.Cells[1].Value.ToString().Split(new char[] { ' ' });
                                string[] TermFromDST = R.Cells[2].Value.ToString().Split(new char[] { ' ' });
                                int iTT = TermCollection.Length;
                                if (iTT > TermFromDST.Length)
                                    iTT = TermFromDST.Length;
                                for (int itt = 0; itt < iTT; itt++)
                                {
                                    if (TermCollection[itt] == TermCollection[itt].ToLower()
                                        && TermCollection[itt] != TermFromDST[itt])
                                    {
                                        string TC = TermCollection[itt].Replace(")", "").Replace("(", "");
                                        string TN = TermFromDST[itt].Replace(")", "").Replace("(", "");
                                        int iTC;
                                        int iTN;
                                        if (!int.TryParse(TC, out iTC) && !int.TryParse(TN, out iTN))
                                        {
                                            C = System.Drawing.Color.Pink;
                                            break;
                                        }
                                    }
                                    if (itt == 0
                                        && TermCollection[itt] != TermFromDST[itt])
                                    {
                                        C = System.Drawing.Color.Pink;
                                        break;
                                    }
                                }
                            }
                        }
                        else if (R.Cells[1].Value.ToString() != R.Cells[2].Value.ToString())
                            C = System.Drawing.Color.LightYellow;
                        for (int iDGV = 0; iDGV < this.dataGridViewSynUnitTermsText.Columns.Count; iDGV++)
                        {
                            R.Cells[iDGV].Style.BackColor = C;
                        }
                    }
                }
                catch (System.Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }

            }
            else
            {
                this.labelSynUnitTermsTextResult.Text = "No matches found";
                this.buttonSynUnitTermsTextUpdate.Enabled = false;
            }
            progressBar.Visible = false;
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }


        private void SynTerms_Text_SetGridColors(System.Windows.Forms.DataGridView dataGridView)
        {
            try
            {
                foreach (System.Windows.Forms.DataGridViewRow R in dataGridView.Rows)
                {
                    int Sim;
                    System.Drawing.Color Col = System.Drawing.Color.LightBlue;
                    System.Drawing.Color FCol = System.Drawing.Color.DarkBlue;
                    if (int.TryParse(R.Cells[5].Value.ToString(), out Sim) && Sim > 1)
                    {
                        for (int iDGV = 0; iDGV < dataGridView.Columns.Count; iDGV++)
                        {
                            R.Cells[iDGV].Style.BackColor = Col;
                            R.Cells[iDGV].Style.ForeColor = FCol;
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }


        #endregion


        //private bool SynTermsPrechecksPassed(ref int ProjectID)
        //{
        //    bool OK = true;
        //    try
        //    {
        //        if (this.comboBoxSynColTermDatabase.SelectedIndex == -1)
        //        {
        //            System.Windows.Forms.MessageBox.Show("Please select a database");
        //            return false;
        //        }
        //        //string Objekt = this.SamplingPlotTarget;
        //        if (this.comboBoxSynColTermTarget.SelectedIndex == -1)
        //        {
        //            System.Windows.Forms.MessageBox.Show("Please select a target");
        //            return false;
        //        }
        //        if (this.comboBoxSynColTermProject.SelectedIndex == -1)
        //        {
        //            System.Windows.Forms.MessageBox.Show("Please select a project");
        //            return false;
        //        }

        //        if (this.SynTermLinkTargetSelectedTable == SynTermTargetTable.NULL)
        //        {
        //            System.Windows.Forms.MessageBox.Show("Please select the table that should be checked");
        //            return false;
        //        }

        //        //System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColTermProject.SelectedItem;
        //        //int ProjectID = 0;
        //        if (this.comboBoxSynColTermProject.SelectedItem != null)
        //        {
        //            System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColTermProject.SelectedItem;
        //            if (!int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
        //                return false;
        //        }
        //        else return false;


        //    }
        //    catch (Exception ex)
        //    {
        //        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
        //    }
        //    return OK;
        //}


        //private SynTermTargetTable _synTermTargetTable = SynTermTargetTable.NULL;
        //private System.Collections.Generic.Dictionary<SynTermTargetTable, DiversityWorkbench.DatabaseService> _SynTermTargetDatabaseService;
        ////private DiversityWorkbench.DatabaseService SynTermTargetDatabaseService(SynTermTargetTable synTermTargetTable)
        ////{

        ////}

        //private void SynTermTarget_SetDatabase(SynTermTargetTable synTermTargetTable, string Database)
        //{
        //    DiversityWorkbench.DatabaseService database = new DiversityWorkbench.DatabaseService(Database);
        //    if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseServices().Contains(database))
        //    {
        //        this.comboBoxSynUnitTermsTermProject.Visible = true;
        //        this.labelSynUnitTermsTermProject.Visible = true;
        //    }
        //    else
        //    {
        //        this.comboBoxSynUnitTermsTermProject.Visible = false;
        //        this.labelSynUnitTermsTermProject.Visible = false;
        //        this.comboBoxSynUnitTermsTermProject.SelectedIndex = -1;
        //    }
        //}

        #endregion

        #region Vernacular terms

        #region TermURI - linked terms

        private void InitSynchronizeTerm_Identification_Linked()
        {
            //this.SynchronizeTerm_Identification_Linked.setGroupsSource(this.comboBoxSynUnitTermsTaxonomicGroup);

            //DiversityCollection.Maintenance.UserControlSynchronizeTermLinked userControlSynchronizeTermLinked = new DiversityCollection.Maintenance.UserControlSynchronizeTermLinked();
            //DiversityCollection.Maintenance.SynchronizeTermLinked synchronizeTermLinked = new DiversityCollection.Maintenance.SynchronizeTermLinked(DiversityCollection.Maintenance.SynchronizeTerm.TargetTable.Identification, userControlSynchronizeTermLinked);
            //userControlSynchronizeTermLinked.Dock = DockStyle.Fill;
            //this.tabPageSynchroTermsUri.Controls.Add(userControlSynchronizeTermLinked);

            this.tabPageSynUnitTermsLinked.Controls.Clear();
            DiversityCollection.Maintenance.SynchronizeTerm synchronizeTerm = new DiversityCollection.Maintenance.SynchronizeTerm(DiversityCollection.Maintenance.SynchronizeTerm.TargetTable.Identification, true);
            DiversityCollection.Maintenance.UserControlSynchronizeTerm userControlSynchronizeTerm = new DiversityCollection.Maintenance.UserControlSynchronizeTerm(synchronizeTerm);
            userControlSynchronizeTerm.Dock = DockStyle.Fill;
            this.tabPageSynUnitTermsLinked.Controls.Add(userControlSynchronizeTerm);

        }

        #region Obsolete

        private DiversityCollection.Maintenance.SynchronizeTerm _SynchronizeTerm_Identification_Linked;

        private DiversityCollection.Maintenance.SynchronizeTerm SynchronizeTerm_Identification_Linked
        {
            get
            {
                if (_SynchronizeTerm_Identification_Linked == null)
                {
                    _SynchronizeTerm_Identification_Linked = new DiversityCollection.Maintenance.SynchronizeTerm(DiversityCollection.Maintenance.SynchronizeTerm.TargetTable.Identification, true,
                        this.dataGridViewSynUnitTerms, this._dtSynUnitTerms, this.labelSynUnitTermsResult,
                        this.buttonSynUnitTermsUpdate);
                }
                return _SynchronizeTerm_Identification_Linked;
            }
        }


        private void comboBoxSynUnitTermsDatabase_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.labelSynUnitTermsDatabase.Text = "Scientific terms database:";
            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseList().Contains(comboBoxSynUnitTermsDatabase.SelectedItem.ToString()))
            {
                this.labelSynUnitTermsTaxonomicGroup.Visible = false;
                this.comboBoxSynUnitTermsTaxonomicGroup.Visible = false;
                if (comboBoxSynUnitTermsDatabase.Text.IndexOf("].DiversityScientificTerms_") > -1)
                {
                    this.labelSynUnitTermsDatabase.Text += "  " + comboBoxSynUnitTermsDatabase.Text.Substring(comboBoxSynUnitTermsDatabase.Text.IndexOf("].DiversityScientificTerms_") + "].DiversityScientificTerms_".Length);
                }
            }
            else
            {
                this.labelSynUnitTermsTaxonomicGroup.Visible = true;
                this.comboBoxSynUnitTermsTaxonomicGroup.Visible = true;
                if (comboBoxSynUnitTermsDatabase.Text.IndexOf("].DiversityScientificTerms_") > -1)
                {
                    this.labelSynUnitTermsDatabase.Text += "  " + comboBoxSynUnitTermsDatabase.Text.Substring(comboBoxSynUnitTermsDatabase.Text.IndexOf("].DiversityScientificTerms_") + "].DiversityScientificTerms_".Length);
                }
            }
            DiversityWorkbench.DatabaseService x = new DiversityWorkbench.DatabaseService(comboBoxSynUnitTermsDatabase.SelectedItem.ToString());
            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseServices().Contains(x))
            {
                this.comboBoxSynUnitTermsTermProject.Visible = true;
                this.labelSynUnitTermsTermProject.Visible = true;
            }
            else
            {
                this.comboBoxSynUnitTermsTermProject.Visible = false;
                this.labelSynUnitTermsTermProject.Visible = false;
                this.comboBoxSynUnitTermsTermProject.SelectedIndex = -1;
            }

        }

        private void buttonSynUnitTermsCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSynUnitTerms.SelectedRows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewSynUnitTerms.SelectedRows[0];
            bool OK = true;
            try { string test = R.Cells["CollectionSpecimenID"].Value.ToString(); }
            catch { OK = false; }
            if (OK)
            {
                if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
                {
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                else
                    this.DialogResult = DialogResult.Cancel;
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            }
        }

        private async void buttonSynUnitTermsSearch_Click(object sender, EventArgs e)
        {
            bool setColumnWidth = true;
            if (this.dataGridViewSynUnitTerms.ColumnCount > 1) setColumnWidth = false;
            if (this.comboBoxSynUnitTermsDatabase.Text.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please choose a database");
                return;
            }
            string BaseURL = "";
            string SQL = "";
            string SqlOrder = "";
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            try
            {
                if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList().ContainsKey(this.comboBoxSynUnitTermsDatabase.Text))
                {
                    DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList()[this.comboBoxSynUnitTermsDatabase.Text];
                    if (SC.LinkedServer.Length > 0)
                    {
                        SourceForSynchronisation = SynchronisationSource.ModuleOnLinkedServer;
                        BaseURL = SC.BaseURL;
                    }
                    else if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DataBaseURIs().TryGetValue(this.comboBoxSynUnitTermsDatabase.Text, out BaseURL))
                    {
                        if (BaseURL == null || BaseURL.Length == 0)
                        {
                            System.Windows.Forms.MessageBox.Show("Connection to " + this.comboBoxSynUnitTermsDatabase.Text + " not established");
                            SourceForSynchronisation = SynchronisationSource.NoConnection;
                            return;
                        }
                        string ModulBaseURL = "";
                        DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityCollection"].DataBaseURIs().TryGetValue(DiversityWorkbench.Settings.DatabaseName, out ModulBaseURL);
                        string TaxonNameServer = BaseURL.ToLower().Substring(0, BaseURL.ToLower().IndexOf("/taxonname"));
                        string CollectionServer = ModulBaseURL.ToLower().Substring(0, ModulBaseURL.ToLower().IndexOf("/collection"));
                        if (TaxonNameServer != CollectionServer)
                            SourceForSynchronisation = SynchronisationSource.ModuleOnDifferentServer;
                    }
                }
                else if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseAndServiceURIs().TryGetValue(this.comboBoxSynUnitTermsDatabase.Text, out BaseURL))
                {
                    if (BaseURL == null || BaseURL.Length == 0)
                    {
                        System.Windows.Forms.MessageBox.Show("Connection to " + this.comboBoxSynUnitTermsDatabase.Text + " not established");
                        SourceForSynchronisation = SynchronisationSource.NoConnection;
                        return;
                    }
                    else
                        SourceForSynchronisation = SynchronisationSource.Webservice;
                }

                if (BaseURL == null)
                {
                }

                switch (SourceForSynchronisation)
                {
                    case SynchronisationSource.ModuleOnLinkedServer:
                    case SynchronisationSource.ModuleOnSameServer:
                        this.SynChroniseTaxonNamesOnSameServer(BaseURL);
                        break;
                    case SynchronisationSource.ModuleOnDifferentServer:
                        this.SynchroniseTaxonNameOnDifferentServer(BaseURL);
                        break;
                    case SynchronisationSource.Webservice:
                        await this.SynchroniseTaxonNamesViaWebservice(BaseURL);
                        break;
                }
            }
            catch (System.Exception ex)
            {
            }
            try
            {
                if (this.dataGridViewSynUnitTerms.ColumnCount > 0 && setColumnWidth)
                {
                    this.dataGridViewSynUnitTerms.Columns[0].Width = 30;
                    this.dataGridViewSynUnitTerms.Columns[1].Width = (int)this.dataGridViewSynUnitTerms.Width * 3 / 8;
                    this.dataGridViewSynUnitTerms.Columns[2].Width = (int)this.dataGridViewSynUnitTerms.Width * 3 / 8;
                }
                if (this.dataGridViewSynUnitTerms.Columns.Count > 0)
                {
                    this.dataGridViewSynUnitTerms.ReadOnly = false;
                    if (this.dataGridViewSynUnitTerms.Columns.Count > 3)
                    {
                        this.dataGridViewSynUnitTerms.Columns[1].ReadOnly = true;
                        this.dataGridViewSynUnitTerms.Columns[2].ReadOnly = true;
                        this.dataGridViewSynUnitTerms.Columns[3].ReadOnly = true;
                        this.dataGridViewSynUnitTerms.Columns[3].Visible = false;
                    }
                    if (this.dataGridViewSynUnitTerms.Columns.Count > 5)
                    {
                        this.dataGridViewSynUnitTerms.Columns[4].ReadOnly = true;
                        this.dataGridViewSynUnitTerms.Columns[5].ReadOnly = true;
                    }
                }
            }
            catch (System.Exception ex)
            { }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
        }

        private void buttonSynUnitTermsSelectAll_Click(object sender, EventArgs e)
        {
            //    if (this._dtSynColTax == null || this._dtSynColTax.Rows.Count == 0)
            //        return;

            //    foreach (System.Data.DataRow R in this._dtSynColTax.Rows)
            //    {
            //        R[0] = true;
            //    }
        }

        private void buttonSynUnitTermsSelectNone_Click(object sender, EventArgs e)
        {
            //    if (this._dtSynColTax == null || this._dtSynColTax.Rows.Count == 0)
            //        return;

            //    foreach (System.Data.DataRow R in this._dtSynColTax.Rows)
            //    {
            //        R[0] = false;
            //    }
        }

        private void buttonSynUnitTermsUpdate_Click(object sender, EventArgs e)
        {
            //    if (this.comboBoxSynColTaxDatabase.Text.Length == 0)
            //    {
            //        System.Windows.Forms.MessageBox.Show("Please choose a database");
            //        return;
            //    }
            //    System.Data.DataRow[] RR = this._dtSynColTax.Select("OK = 1", "");
            //    if (RR.Length == 0)
            //    {
            //        System.Windows.Forms.MessageBox.Show("Nothing selected");
            //        return;
            //    }
            //    string BaseURL = "";
            //    string SQL = "";
            //    string Message = "";
            //    switch (this.SourceForSynchronisation)
            //    {
            //        case SynchronisationSource.ModuleOnLinkedServer:
            //        case SynchronisationSource.ModuleOnSameServer:
            //            string Prefix = "dbo.";
            //            DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnectionList()[this.comboBoxSynColTaxDatabase.Text];
            //            if (SC.LinkedServer.Length > 0)
            //                Prefix = "[" + SC.LinkedServer + "].[" + SC.DatabaseName + "].dbo.";
            //            else Prefix = "[" + SC.DatabaseName + "].dbo.";
            //            BaseURL = SC.BaseURL;
            //            try
            //            {
            //                SQL = "UPDATE I SET I.TaxonomicName = T.TaxonNameCache " +
            //                        " FROM Identification I INNER JOIN " + Prefix + "TaxonName T " +
            //                        " ON RTRIM(SUBSTRING(I.NameURI, LEN('" + BaseURL + "') + 1, 255))  " +
            //                        " = CAST(T.NameID AS varchar) AND  " +
            //                        " I.TaxonomicName <> T.TaxonNameCache " +
            //                        " INNER JOIN CollectionProject P ON I.CollectionSpecimenID = P.CollectionSpecimenID " +
            //                        " INNER JOIN CollectionSpecimen S ON I.CollectionSpecimenID = S.CollectionSpecimenID " +
            //                        " WHERE (NOT (I.NameURI IS NULL)) " +
            //                        " AND (I.NameURI LIKE '" + BaseURL + "%')";
            //                if (this.comboBoxSynColTaxProject.SelectedIndex > -1)
            //                {
            //                    int ProjectID = 0;
            //                    if (this.comboBoxSynColTaxProject.SelectedItem != null)
            //                    {
            //                        System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColTaxProject.SelectedItem;
            //                        if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
            //                            SQL += " AND P.ProjectID = " + ProjectID.ToString();
            //                        else
            //                            return;
            //                    }
            //                    else return;
            //                    //if (!int.TryParse(this.comboBoxSynColTaxProject.SelectedValue.ToString(), out ProjectID))
            //                    //    return;
            //                    //else
            //                    //    SQL += " AND P.ProjectID = " + ProjectID.ToString();
            //                }

            //                string LinkRestriction = this.LinkRestriction(this.dataGridViewSynColTax, 0, 3);
            //                if (LinkRestriction == " IS NULL ")
            //                    return;
            //                if (LinkRestriction.Length > 0)
            //                    SQL += " AND I.NameURI " + LinkRestriction;

            //                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
            //                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
            //                C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
            //                try
            //                {
            //                    this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            //                    con.Open();
            //                    //Message = 
            //                    C.ExecuteScalar();//.ToString();
            //                    System.Windows.Forms.MessageBox.Show("Update finished");
            //                }
            //                catch (Exception ex)
            //                {
            //                    Message = "Update failed: " + ex.Message;
            //                }
            //                finally
            //                {
            //                    con.Close();
            //                    this.Cursor = System.Windows.Forms.Cursors.Default;
            //                    //this.dataGridViewSynColTax.DataSource = null;
            //                }
            //                if (Message.Length > 0)
            //                {
            //                    int iTest;
            //                    if (!int.TryParse(Message, out iTest)) // some messages contain numbers returned by the server with no meaning in this routine
            //                        System.Windows.Forms.MessageBox.Show(Message);
            //                }
            //                else
            //                {
            //                    this.dataGridViewSynColTax.DataSource = null;
            //                    this.buttonSynColTaxUpdate.Enabled = false;
            //                    //System.Windows.Forms.MessageBox.Show("Update finished");
            //                }
            //            }
            //            catch (System.Exception ex)
            //            {
            //            }
            //            break;
            //        default:
            //            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DatabaseAndServiceURIs().TryGetValue(this.comboBoxSynColTaxDatabase.Text, out BaseURL))
            //            {
            //                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            //                int iError = 0;
            //                for (int i = 0; i < this.dataGridViewSynColTax.Rows.Count; i++)
            //                {
            //                    if (this.dataGridViewSynColTax.Rows[i].Cells[0].Value.ToString() == "True")
            //                    {
            //                        string Taxon = this._dtSynColTax.Rows[i][2].ToString();
            //                        if (Taxon.IndexOf("'") > -1) Taxon = Taxon.Replace("'", "''");
            //                        SQL = "UPDATE Identification SET Identification.TaxonomicName = N'" + Taxon + "' FROM Identification ";
            //                        if (this.comboBoxSynColTaxTaxonomicGroup.Text.Length > 0)
            //                            SQL += " INNER JOIN IdentificationUnit ON Identification.CollectionSpecimenID = IdentificationUnit.CollectionSpecimenID " +
            //                                " AND Identification.IdentificationUnitID = IdentificationUnit.IdentificationUnitID ";
            //                        SQL += " INNER JOIN CollectionProject ON Identification.CollectionSpecimenID = CollectionProject.CollectionSpecimenID " +
            //                            " INNER JOIN CollectionSpecimen ON Identification.CollectionSpecimenID = CollectionSpecimen.CollectionSpecimenID " +
            //                            " WHERE (Identification.NameURI = '" + this._dtSynColTax.Rows[i]["NameURI"].ToString() + "')";
            //                        if (this.comboBoxSynColTaxTaxonomicGroup.Visible && this.comboBoxSynColTaxTaxonomicGroup.Text.Length > 0)
            //                            SQL += " AND IdentificationUnit.TaxonomicGroup = '" + this.comboBoxSynColTaxTaxonomicGroup.Text + "'";
            //                        if (this.comboBoxSynColTaxProject.SelectedIndex > -1)
            //                        {
            //                            int ProjectID = 0;
            //                            if (this.comboBoxSynColTaxProject.SelectedItem != null)
            //                            {
            //                                System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColTaxProject.SelectedItem;
            //                                if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
            //                                    SQL += " AND CollectionProject.ProjectID = " + ProjectID.ToString();
            //                                else
            //                                    return;
            //                            }
            //                            else return;
            //                            //if (!int.TryParse(this.comboBoxSynColTaxProject.SelectedValue.ToString(), out ProjectID))
            //                            //    return;
            //                            //else
            //                            //    SQL += " AND CollectionProject.ProjectID = " + ProjectID.ToString();
            //                        }
            //                        if (this.checkBoxSynColTaxIncludeAccNr.Checked)
            //                            SQL += " AND CollectionSpecimen.CollectionSpecimenID = " + this._dtSynColTax.Rows[i]["CollectionSpecimenID"].ToString();
            //                        Microsoft.Data.SqlClient.SqlConnection conn = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            //                        Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, conn);
            //                        try
            //                        {
            //                            conn.Open();
            //                            C.ExecuteNonQuery();
            //                        }
            //                        catch (Exception ex)
            //                        {
            //                            iError++;
            //                            Message += ex.Message + "\r\n";
            //                        }
            //                        finally
            //                        {
            //                            conn.Close();
            //                        }
            //                    }
            //                }
            //                if (iError > 0)
            //                {
            //                    if (iError == this.dataGridViewSynColTax.Rows.Count)
            //                        System.Windows.Forms.MessageBox.Show("Update failed");
            //                    else
            //                        System.Windows.Forms.MessageBox.Show("Update failed for " + iError.ToString() + " datasets");
            //                }
            //                else
            //                {
            //                    System.Windows.Forms.MessageBox.Show("Update finished");
            //                }
            //                this.dataGridViewSynColTax.DataSource = null;
            //                this.buttonSynColTaxUpdate.Enabled = false;
            //            }
            //            break;
            //    }
            //    //this.dataGridViewSynColTax.DataSource = null;
            //    //System.Windows.Forms.MessageBox.Show("Update finished");
            //    this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void SynchroniseScientificTerms(string BaseURL)
        {
            try
            {
                string Prefix = "dbo.";
                DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList()[this.comboBoxSynUnitTermsDatabase.Text];
                if (SC.LinkedServer.Length > 0)
                    Prefix = "[" + SC.LinkedServer + "].[" + SC.DatabaseName + "].dbo.";
                else Prefix = "[" + SC.DatabaseName + "].dbo.";

                string SQL = "SELECT";
                string SqlOrder = " ORDER BY T.TaxonNameCache ";
                if (!this.checkBoxSynUnitTermsIncludeAccNr.Checked) SQL += " DISTINCT ";
                SQL += " cast(1 as bit) AS OK,";
                SQL += " I.TaxonomicName AS [TaxonomicName in DiversityCollection],  T.TaxonNameCache AS [TaxonNameCache in DiversityScientificTerms]";
                SQL += ", I.NameURI ";
                if (this.checkBoxSynUnitTermsIncludeAccNr.Checked) SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";
                SQL += " FROM Identification I INNER JOIN " + Prefix + "TaxonName T " +
                    " ON RTRIM(SUBSTRING(I.NameURI, LEN('" + BaseURL + "') + 1, 255))  " +
                    " = CAST(T.NameID AS varchar) AND  " +
                    " I.TaxonomicName <> T.TaxonNameCache ";
                if (this.comboBoxSynUnitTermsTaxonomicGroup.SelectedIndex > -1)
                {
                    SQL += " INNER JOIN IdentificationUnit U ON U.CollectionSpecimenID = I.CollectionSpecimenID AND I.IdentificationUnitID = U.IdentificationUnitID ";
                }
                SQL += " INNER JOIN CollectionProject P ON I.CollectionSpecimenID = P.CollectionSpecimenID " +
                    " INNER JOIN CollectionSpecimen S ON I.CollectionSpecimenID = S.CollectionSpecimenID " +
                    " WHERE (NOT (I.NameURI IS NULL)) " +
                    " AND (I.NameURI LIKE '" + BaseURL + "%')";
                if (this.comboBoxSynUnitTermsProject.SelectedIndex > -1)
                {
                    int ProjectID = 0;
                    if (this.comboBoxSynUnitTermsProject.SelectedItem != null)
                    {
                        System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynUnitTermsProject.SelectedItem;
                        if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                            SQL += " AND P.ProjectID = " + ProjectID.ToString();
                        else
                            return;
                    }
                    else return;
                }
                if (this.comboBoxSynUnitTermsTaxonomicGroup.SelectedIndex > -1)
                {
                    SQL += " AND U.TaxonomicGroup = '" + this.comboBoxSynUnitTermsTaxonomicGroup.SelectedValue.ToString() + "' ";
                }
                SQL += SqlOrder;
                this._dtSynUnitTerms = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));// DiversityWorkbench.Settings.TimeoutDatabase));
                ad.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;// / 1000;// DiversityWorkbench.Settings.TimeoutDatabase;
                ad.Fill(this._dtSynUnitTerms);
                this.dataGridViewSynUnitTerms.DataSource = this._dtSynUnitTerms;
                if (this._dtSynUnitTerms.Rows.Count > 0)
                {
                    this.labelSynUnitTermsResult.Text = this._dtSynUnitTerms.Rows.Count.ToString() + " differences found";
                    this.buttonSynUnitTermsUpdate.Enabled = true;
                }
                else
                {
                    this.labelSynUnitTermsResult.Text = "No differences found";
                    this.buttonSynUnitTermsUpdate.Enabled = false;
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

       
        private void checkBoxSynUnitTermsIncludeAccNr_Click(object sender, EventArgs e)
        {
            //    if (this.checkBoxSynColTaxIncludeAccNr.Checked) this.buttonSynColTaxCheckDataset.Visible = true;
            //    else this.buttonSynColTaxCheckDataset.Visible = false;

        }

        private void comboBoxSynUnitTermsTermProject_DropDown(object sender, EventArgs e)
        {
            //    try
            //    {
            //        System.Data.DataTable dt = new DataTable();
            //        string SQL = "SELECT ProjectID, Project " +
            //            "FROM " + this.comboBoxSynColTaxDatabase.Text + ".dbo.ProjectProxy " +
            //            "ORDER BY Project";
            //        Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            //        ad.Fill(dt);
            //        this.comboBoxSynColTaxTaxonNameProject.DataSource = dt;
            //        this.comboBoxSynColTaxTaxonNameProject.DisplayMember = "Project";
            //        this.comboBoxSynColTaxTaxonNameProject.ValueMember = "ProjectID";
            //    }
            //    catch
            //    {
            //    }

        }

        #endregion

        #endregion

        #region Text

        private void InitSynchronizeTerm_Identification_Text()
        {
            //this.SynchronizeTerm_Identification_Text.setGroupsSource(this.comboBoxSynUnitTermsTextTaxonomicGroup);

            //DiversityCollection.Maintenance.UserControlSynchronizeTermText userControlSynchronizeTermText = new DiversityCollection.Maintenance.UserControlSynchronizeTermText();
            //DiversityCollection.Maintenance.SynchronizeTermText synchronizeTermText = new DiversityCollection.Maintenance.SynchronizeTermText(DiversityCollection.Maintenance.SynchronizeTerm.TargetTable.Identification, userControlSynchronizeTermText);
            //userControlSynchronizeTermText.Dock = DockStyle.Fill;
            //tabPageSynchroTermsText.Controls.Add(userControlSynchronizeTermText);

            tabPageSynUnitTermsText.Controls.Clear();
            DiversityCollection.Maintenance.SynchronizeTerm synchronizeTerm = new DiversityCollection.Maintenance.SynchronizeTerm(DiversityCollection.Maintenance.SynchronizeTerm.TargetTable.Identification, false);
            DiversityCollection.Maintenance.UserControlSynchronizeTerm userControlSynchronizeTerm = new DiversityCollection.Maintenance.UserControlSynchronizeTerm(synchronizeTerm);
            userControlSynchronizeTerm.Dock = DockStyle.Fill;
            tabPageSynUnitTermsText.Controls.Add(userControlSynchronizeTerm);

        }

        #region Obsolete

        private DiversityCollection.Maintenance.SynchronizeTerm _SynchronizeTerm_Identification_Text;

        private DiversityCollection.Maintenance.SynchronizeTerm SynchronizeTerm_Identification_Text
        {
            get
            {
                if (_SynchronizeTerm_Identification_Text == null)
                {
                    _SynchronizeTerm_Identification_Text = new DiversityCollection.Maintenance.SynchronizeTerm(DiversityCollection.Maintenance.SynchronizeTerm.TargetTable.Identification, false,
                        this.dataGridViewSynUnitTermsText, this._dtSynUnitTermsText, this.labelSynUnitTermsTextResult,
                        this.buttonSynUnitTermsTextUpdate);
                }
                return _SynchronizeTerm_Identification_Text;
            }
        }



        private void comboBoxSynUnitTermsTextDatabase_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.labelSynUnitTermsTextDatabase.Text = "Database:";
            DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList()[this.comboBoxSynUnitTermsTextDatabase.SelectedItem.ToString()];
            if (SC.LinkedServer.Length > 0)
                this.labelSynUnitTermsTextDatabase.Text += SC.DatabaseName;
        }

        private void buttonSynUnitTermsTextCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSynUnitTermsText.SelectedCells.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            int Position = this.dataGridViewSynUnitTermsText.SelectedCells[0].RowIndex;
            if (int.TryParse(this.dataGridViewSynUnitTermsText.Rows[Position].Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
            {
                DiversityCollection.Forms.FormCollectionSpecimen f = new Forms.FormCollectionSpecimen(this._CollectionSpecimenID, false, false);
                f.setViewMode(Forms.FormCollectionSpecimen.ViewMode.SingleInspectionMode);
                f.Width = this.Width - 10;
                f.Height = this.Height - 10;
                f.ShowDialog();
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
                this.DialogResult = DialogResult.Cancel;
            }
        }

        private void buttonSynUnitTermsTextSearch_Click(object sender, EventArgs e)
        {
            try
            {
                this.dataGridViewSynUnitTermsText.DataSource = null;
                this._dtSynUnitTermsText = new DataTable();
                int ProjectID = 0;
                string Group = "";
                if (!this.allValuesSetForUnitTermTextSynchro(ref ProjectID, ref Group)) return;
                bool setColumnWidth = true;
                // Workbench modules
                if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DataBaseURIs().TryGetValue(this.comboBoxSynUnitTermsTextDatabase.Text, out this._SynchronizeColUnitTermsTextBaseURL))
                {
                    if (this.comboBoxSynUnitTermsTextTermProject.SelectedValue == null || this.comboBoxSynUnitTermsTextTermProject.SelectedValue == System.DBNull.Value)
                    {
                        System.Windows.Forms.MessageBox.Show("Please select a terminology in the terms database");
                        return;
                    }
                    this.SynchronizeColUnitTermsText(this.SynchronizeColUnitTermsTextDatabase, this.SynchronizeColUnitTermsTextConnectionString, this.SynchronizeColUnitTermsTextBaseURL);
                }

                if (this.dataGridViewSynUnitTermsText.ColumnCount > 1)
                    setColumnWidth = true;
                if (this.dataGridViewSynUnitTermsText.ColumnCount > 0 && setColumnWidth)
                {
                    this.dataGridViewSynUnitTermsText.Columns[0].AutoSizeMode = DataGridViewAutoSizeColumnMode.ColumnHeader;
                    this.dataGridViewSynUnitTermsText.Columns[1].AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells;
                    this.dataGridViewSynUnitTermsText.Columns[2].AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells;
                }
                this.dataGridViewSynUnitTermsText.ReadOnly = false;
                for (int i = 1; i < this.dataGridViewSynUnitTermsText.ColumnCount; i++)
                {
                    this.dataGridViewSynUnitTermsText.Columns[i].ReadOnly = true;
                }
                for (int i = 0; i < this.dataGridViewSynUnitTermsText.ColumnCount; i++)
                {
                    this.dataGridViewSynUnitTermsText.Columns[i].SortMode = DataGridViewColumnSortMode.NotSortable;
                }
                this.progressBarSynUnitTermsText.Visible = false;
                this.SynchronizeUnitTermsTextSetGridColors();
            }
            catch (System.Exception ex) { }
        }

        private void buttonSynUnitTermsTextSelectAll_Click(object sender, EventArgs e)
        {
            //# 173
            if (this._dtSynUnitTermsText == null || this._dtSynUnitTermsText.Rows.Count == 0) return;

            if (this.SynColUnitTermsTextCheckHasBeenEdited())
            {
                if (System.Windows.Forms.MessageBox.Show("Are you sure that you want to select all rows?", "Select all?", MessageBoxButtons.OKCancel) == System.Windows.Forms.DialogResult.Cancel)
                    return;
            }
            foreach (System.Data.DataRow R in this._dtSynUnitTermsText.Rows)
                R[0] = true;
        }

        private void buttonSynUnitTermsTextSelectNone_Click(object sender, EventArgs e)
        {
            //# 173
            if (this._dtSynUnitTermsText == null || this._dtSynUnitTermsText.Rows.Count == 0) return;

            if (this.SynColUnitTermsTextCheckHasBeenEdited())
            {
                if (System.Windows.Forms.MessageBox.Show("Are you sure that you want to deselect all rows?", "Deselect all?", MessageBoxButtons.OKCancel) == System.Windows.Forms.DialogResult.Cancel)
                    return;
            }
            foreach (System.Data.DataRow R in this._dtSynUnitTermsText.Rows)
                R[0] = false;
        }

        private bool SynColUnitTermsTextCheckHasBeenEdited()
        {
            bool Edited = false;
            System.Data.DataRow[] rrYes = this._dtSynUnitTermsText.Select("OK = 1", "");
            System.Data.DataRow[] rrNo = this._dtSynUnitTermsText.Select("OK = 0", "");
            if (rrNo.Length > 0 && rrYes.Length > 0)
                Edited = true;
            return Edited;
        }

        private void buttonSynUnitTermsTextUpdate_Click(object sender, EventArgs e)
        {
            try
            {
                int ProjectID = 0;
                string Group = "";
                if (!this.allValuesSetForUnitTermTextSynchro(ref ProjectID, ref Group))
                    return;

                string BaseURL = "";

                if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DataBaseURIs().TryGetValue(this.comboBoxSynUnitTermsTextDatabase.Text, out BaseURL))
                {
                    bool IsSameServer = true;
                    string SelectedDatabase = this.comboBoxSynUnitTermsTextDatabase.SelectedItem.ToString();
                    string ConnectionString = DiversityWorkbench.Settings.ConnectionString;
                    foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnections())
                    {
                        if (KV.Value.DisplayText == SelectedDatabase)
                        {
                            ConnectionString = KV.Value.ConnectionString;
                            SelectedDatabase = KV.Value.DatabaseName;
                            if (KV.Value.DatabaseServer != DiversityWorkbench.Settings.DatabaseServer)
                                IsSameServer = false;
                        }
                    }
                    string Message = this.SynchronizeColUnitTermsText_UpdateFromTableContent(Group, ProjectID);
                    if (Message.Length == 0)
                        this.buttonSynColTaxTextUpdate.Enabled = false;
                    this.labelSynColTaxCheckText.Text = "";
                }
                else
                {
                    string Message = this.SynchronizeColTaxText_UpdateFromTableContent(Group, ProjectID);
                    if (Message.Length == 0)
                        this.buttonSynColTaxTextUpdate.Enabled = false;
                    this.labelSynColTaxCheckText.Text = "";
                }
                this.SynchronizeUnitTermsTextSetGridColors();
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private bool allValuesSetForUnitTermTextSynchro(ref int ProjectID, ref string TaxonomicGroup)
        {
            try
            {
                if (this.comboBoxSynUnitTermsTextTaxonomicGroup.Text.Length == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a group");
                    return false;
                }
                else
                {
                    System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynUnitTermsTextTaxonomicGroup.SelectedItem;
                    TaxonomicGroup = R[0].ToString(); // this.comboBoxSynUnitTermsTextTaxonomicGroup.SelectedItem.ToString();
                }

                if (this.comboBoxSynUnitTermsTextProject.SelectedIndex == -1)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a project");
                    return false;
                }
                else
                {
                    if (this.comboBoxSynUnitTermsTextProject.SelectedIndex > -1)
                    {
                        if (!int.TryParse(this.comboBoxSynUnitTermsTextProject.SelectedValue.ToString(), out ProjectID))
                        {
                            System.Windows.Forms.MessageBox.Show("Please select a terminology");
                            return false;
                        }
                    }
                }

                if (this.comboBoxSynUnitTermsTextDatabase.SelectedIndex == -1)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a database");
                    return false;
                }
                else
                {
                    string SelectedDatabase = this.comboBoxSynUnitTermsTextDatabase.SelectedItem.ToString();
                    System.Collections.Generic.List<DiversityWorkbench.DatabaseService> L = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseServices();
                    foreach (DiversityWorkbench.DatabaseService DS in L)
                    {
                        if (DS.DatabaseName == SelectedDatabase && !DS.IsWebservice)
                        {
                            if (this.comboBoxSynUnitTermsTextTermProject.SelectedIndex == -1)
                            {
                                System.Windows.Forms.MessageBox.Show("Please select a terminology");
                                return false;
                            }
                            break;
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                return false;
            }

            return true;
        }

        private void SynchronizeColUnitTermsText(string SelectedDatabase, string ConnectionString, string BaseURL)
        {
            // #173
            if (this._dtSynUnitTermsText == null || this._dtSynUnitTermsText.Rows.Count == 0) return;

            string Message = "";
            System.Collections.Generic.List<System.Data.DataRow> RowsToDelete = new List<DataRow>();
            System.Data.DataTable dtQueryResults = new DataTable();

            this.SynchronizeColUnitTermsTextFillList();

            this.progressBarSynUnitTermsText.Maximum = this._dtSynUnitTermsText.Rows.Count;
            this.progressBarSynUnitTermsText.Minimum = 0;
            this.progressBarSynUnitTermsText.Value = 0;
            this.progressBarSynUnitTermsText.Visible = true;
            int i = 0;

            this._SynColUnitTermsTextNameLists = new Dictionary<string, DataTable>();

            string Prefix = SelectedDatabase + ".dbo.";
            if (this.SynchronizeColUnitTermsTextLinkedServer.Length > 0)
                Prefix = "[" + this.SynchronizeColUnitTermsTextLinkedServer + "]." + Prefix;

            Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter("", ConnectionString);
            Microsoft.Data.SqlClient.SqlConnection conRank = new Microsoft.Data.SqlClient.SqlConnection(ConnectionString);
            Microsoft.Data.SqlClient.SqlCommand cmdRank = new Microsoft.Data.SqlClient.SqlCommand("", conRank);
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            string SQL = "";
            foreach (System.Data.DataRow R in this._dtSynUnitTermsText.Rows)
            {
                try
                {
                    dtQueryResults.Clear();
                    string TermInCollection = R[1].ToString();

                    SQL = "SELECT U.BaseURL + CAST(T.RepresentationID AS VARCHAR(55)) AS TermURI, T.DisplayText ";
                    if (this.checkBoxSynUnitTermsTextIncludeHierarchy.Checked)
                    {
                        SQL += ", T.HierarchyCache";
                        if (this.radioButtonSynUnitTermsTextIncludeHierarchyDown.Checked)
                            SQL += "Down";
                        SQL += " AS Hierarchy ";
                    }
                    SQL += ", LanguageCode AS [Lang.] ";
                    SQL += "FROM " + Prefix + "ViewBaseURL AS U, ";
                    SQL += Prefix + "TermRepresentation AS T, ";
                    SQL += Prefix + "Term AS TT " +
                        " WHERE TT.TermID = T.TermID AND TT.IsRankingTerm = 0 AND T.TerminologyID = " + this.comboBoxSynUnitTermsTextTermProject.SelectedValue.ToString();
                    SQL += " AND (T.DisplayText = '" + TermInCollection + "')";
                    SQL += " GROUP BY dbo.BaseURL() + CAST(T.RepresentationID AS VARCHAR(55)), T.DisplayText, U.BaseURL, T.RepresentationID, LanguageCode ";
                    if (this.checkBoxSynUnitTermsTextIncludeHierarchy.Checked)
                    {
                        SQL += ", T.HierarchyCache";
                        if (this.radioButtonSynUnitTermsTextIncludeHierarchyDown.Checked)
                            SQL += "Down";
                    }
                    SQL += " ORDER BY T.DisplayText ";
                    try
                    {
                        ad.SelectCommand.CommandText = SQL;
                        ad.Fill(dtQueryResults);
                    }
                    catch (System.Exception ex)
                    {
                        System.Windows.Forms.MessageBox.Show(ex.Message);
                    }

                    if (dtQueryResults.Rows.Count > 0)
                    {
                        if (dtQueryResults.Rows.Count > 1)
                        {
                            if (!this._SynColUnitTermsTextNameLists.ContainsKey(TermInCollection))
                                this._SynColUnitTermsTextNameLists.Add(TermInCollection, dtQueryResults.Copy());
                            if (R.Table.Columns.Contains("Similarities"))
                                R["Similarities"] = dtQueryResults.Rows.Count;
                            R[0] = false;
                        }
                        else if (R[1].ToString() == R[2].ToString())
                            R[0] = true;
                        R[2] = dtQueryResults.Rows[0]["DisplayText"].ToString();
                        R[3] = dtQueryResults.Rows[0]["TermURI"].ToString();
                        if (dtQueryResults.Columns.Contains("Hierarchy") && dtQueryResults.Rows[0]["Hierarchy"].ToString().Length > 0)
                            R[4] = dtQueryResults.Rows[0]["Hierarchy"].ToString();

                    }
                    else
                        RowsToDelete.Add(R);

                    i++;
                    if (i < this.progressBarSynUnitTermsText.Maximum)
                        this.progressBarSynUnitTermsText.Value = i;
                }
                catch (System.Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex, R[1].ToString());
                    RowsToDelete.Add(R);
                }
            }

            // deleting the not synchronizable
            foreach (System.Data.DataRow R in RowsToDelete)
                R.Delete();
            this._dtSynUnitTermsText.AcceptChanges();

            if (this._dtSynUnitTermsText.Rows.Count > 0)
            {
                this.labelSynUnitTermsTextResult.Text = this._dtSynUnitTermsText.Rows.Count.ToString() + " matches to " + this.comboBoxSynUnitTermsTextDatabase.Text + " found";
                this.buttonSynUnitTermsTextUpdate.Enabled = true;
                try
                {
                    foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynUnitTermsText.Rows)
                    {
                        System.Drawing.Color C = System.Drawing.Color.White;
                        if (R.Cells[0].Value.ToString().ToLower() == "false")
                        {
                            C = System.Drawing.Color.LightYellow;
                            int Sim;
                            string Value = R.Cells[4].Value.ToString();
                            if (this.checkBoxSynUnitTermsTextIncludeAccNr.Checked)
                            {
                                Value = R.Cells[6].Value.ToString();
                            }
                            if (int.TryParse(Value, out Sim) && Sim > 1)
                            {
                                C = System.Drawing.Color.LightBlue;
                            }
                            else
                            {
                                string[] TermCollection = R.Cells[1].Value.ToString().Split(new char[] { ' ' });
                                string[] TermFromDST = R.Cells[2].Value.ToString().Split(new char[] { ' ' });
                                int iTT = TermCollection.Length;
                                if (iTT > TermFromDST.Length)
                                    iTT = TermFromDST.Length;
                                for (int itt = 0; itt < iTT; itt++)
                                {
                                    if (TermCollection[itt] == TermCollection[itt].ToLower()
                                        && TermCollection[itt] != TermFromDST[itt])
                                    {
                                        string TC = TermCollection[itt].Replace(")", "").Replace("(", "");
                                        string TN = TermFromDST[itt].Replace(")", "").Replace("(", "");
                                        int iTC;
                                        int iTN;
                                        if (!int.TryParse(TC, out iTC) && !int.TryParse(TN, out iTN))
                                        {
                                            C = System.Drawing.Color.Pink;
                                            break;
                                        }
                                    }
                                    if (itt == 0
                                        && TermCollection[itt] != TermFromDST[itt])
                                    {
                                        C = System.Drawing.Color.Pink;
                                        break;
                                    }
                                }
                            }
                        }
                        else if (R.Cells[1].Value.ToString() != R.Cells[2].Value.ToString())
                            C = System.Drawing.Color.LightYellow;
                        for (int iDGV = 0; iDGV < this.dataGridViewSynUnitTermsText.Columns.Count; iDGV++)
                        {
                            R.Cells[iDGV].Style.BackColor = C;
                        }
                    }
                }
                catch (System.Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }

            }
            else
            {
                this.labelSynUnitTermsTextResult.Text = "No matches found";
                this.buttonSynUnitTermsTextUpdate.Enabled = false;
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        #region Selecting of valid term if many are found

        private void dataGridViewSynUnitTermsText_CellClick(object sender, DataGridViewCellEventArgs e)
        {
            int i = this.dataGridViewSynUnitTermsText.SelectedCells[0].RowIndex;
            string Name = this._dtSynUnitTermsText.Rows[i][1].ToString();
            if (this._SynColUnitTermsTextNameLists == null)
                this._SynColUnitTermsTextNameLists = new Dictionary<string, DataTable>();
            if (this._SynColUnitTermsTextNameLists.ContainsKey(Name))
            {
                this.buttonSynUnitTermsTextCheckNameList.Visible = true;
            }
            else this.buttonSynUnitTermsTextCheckNameList.Visible = false;

            if (this.dataGridViewSynUnitTermsText.SelectedCells[0].ColumnIndex == 0)
                this.buttonSynUnitTermsTextUpdate.Enabled = true;
        }

        private void buttonSynUnitTermsTextCheckNameList_Click(object sender, EventArgs e)
        {
            int i = this.dataGridViewSynUnitTermsText.SelectedCells[0].RowIndex;
            string Name = this._dtSynUnitTermsText.Rows[i][1].ToString();
            if (this._SynColUnitTermsTextNameLists.ContainsKey(Name))
            {
                string Message = "Please select the valid term from the list:\r\n" + Name;
                DiversityWorkbench.Forms.FormSelectTableRow f = new DiversityWorkbench.Forms.FormSelectTableRow(this._SynColUnitTermsTextNameLists[Name], Message);//, 2, "1", System.Drawing.Color.LightGreen, System.Drawing.Color.LightPink);
                f.dataGridView.Columns[0].Visible = false;
                f.dataGridView.Columns[1].HeaderText = "Term in " + this.comboBoxSynUnitTermsTextDatabase.Text;
                f.dataGridView.Columns[1].Width = 300;
                f.dataGridView.Columns[2].Width = 500;
                f.dataGridView.Columns[3].Width = 40;
                f.dataGridView.RowHeadersWidth = 24;
                //if (f.dataGridView.ColumnCount > 2)
                //    f.dataGridView.Columns[2].Width = 70;
                for (int ii = 0; ii < this._SynColUnitTermsTextNameLists[Name].Columns.Count; ii++)
                    f.dataGridView.AutoResizeColumn(i, DataGridViewAutoSizeColumnMode.AllCells);
                //f.dataGridView.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                f.Width = 800;// this.Width - 120;
                //f.dataGridView.Columns[1].Width = f.Width - 140;
                int Height = (f.dataGridView.Rows[0].Height * (this._SynColUnitTermsTextNameLists[Name].Rows.Count + 1)) + 140;
                f.Height = Height;
                f.ForeColor = System.Drawing.Color.DarkBlue;
                f.StartPosition = FormStartPosition.CenterParent;
                f.ShowDialog();
                //f.MarkResults(2, "1", System.Drawing.Color.LightGreen, System.Drawing.Color.LightPink);
                if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                {
                    System.Data.DataRow Rs = f.SelectedRow;
                    System.Data.DataRow Rd = this._dtSynUnitTermsText.Rows[i];
                    Rd[0] = true; // selection
                    Rd[3] = Rs[0]; // URI
                    Rd[4] = Rs[2]; // Hierarchy
                    //if (Rd[2].ToString() != Rs[1].ToString())
                    //{
                    //    Rd[2] = Rs[1];
                    //    string URI = Rd[3].ToString().Substring(0, Rd[3].ToString().IndexOf("=") + 1) + Rs[0].ToString();
                    //    bool AdaptHierarchy = true;
                    //    if (Rd[3].ToString() == URI)
                    //        AdaptHierarchy = false;
                    //    Rd[3] = URI;
                    //    if (AdaptHierarchy)
                    //    {
                    //        bool HierarchyHasBeenAdaptedToSelection = false;
                    //        try
                    //        {
                    //            DiversityWorkbench.WebserviceIndexFungorum F = new DiversityWorkbench.WebserviceIndexFungorum();
                    //            System.Data.DataTable dtItem = new DataTable();
                    //            System.Data.DataColumn Curi = new DataColumn("_URI");
                    //            dtItem.Columns.Add(Curi);
                    //            System.Data.DataRow Ruri = dtItem.NewRow();
                    //            Ruri[0] = Rd[3];
                    //            dtItem.Rows.Add(Ruri);
                    //            F.getItemResults(URI, ref dtItem);
                    //            if (dtItem.Columns.Contains("Hierarchy"))
                    //            {
                    //                Rd["Hierarchy"] = dtItem.Rows[0]["Hierarchy"];
                    //                HierarchyHasBeenAdaptedToSelection = true;
                    //            }
                    //        }
                    //        catch (System.Exception ex) { }
                    //        if (!HierarchyHasBeenAdaptedToSelection)
                    //            System.Windows.Forms.MessageBox.Show("The hierarchy could not be adapted to the selected term");
                    //    }
                    //}
                    //Rd[0] = true;
                }
            }
        }

        private void SynchronizeUnitTermsTextSetGridColors()
        {
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynUnitTermsText.Rows)
            {
                //if (R.Cells[1].Value.ToString() != R.Cells[2].Value.ToString())
                //{
                //    int Sim;
                //    System.Drawing.Color Col = System.Drawing.Color.LightYellow;
                //    System.Drawing.Color FCol = System.Drawing.Color.Black;
                //    if (int.TryParse(R.Cells[4].Value.ToString(), out Sim) && Sim > 1)
                //    {
                //        FCol = System.Drawing.Color.DarkBlue;
                //        Col = System.Drawing.Color.LightBlue;
                //    }
                //    for (int iDGV = 0; iDGV < this.dataGridViewSynUnitTermsText.Columns.Count; iDGV++)
                //    {
                //        R.Cells[iDGV].Style.BackColor = Col;
                //        R.Cells[iDGV].Style.ForeColor = FCol;
                //    }
                //}
                //else
                {
                    int Sim;
                    System.Drawing.Color Col = System.Drawing.Color.LightBlue;
                    System.Drawing.Color FCol = System.Drawing.Color.DarkBlue;
                    if (int.TryParse(R.Cells[5].Value.ToString(), out Sim) && Sim > 1)
                    {
                        for (int iDGV = 0; iDGV < this.dataGridViewSynUnitTermsText.Columns.Count; iDGV++)
                        {
                            R.Cells[iDGV].Style.BackColor = Col;
                            R.Cells[iDGV].Style.ForeColor = FCol;
                        }
                    }
                }
            }
        }

        #endregion

        public string SynchronizeColUnitTermsTextLinkedServer
        {
            get
            {
                if (this._SynchronizeColUnitTermsTextLinkedServer == null)
                    this.setSynchronizeColUnitTermsTextDatabaseParameters();
                return _SynchronizeColUnitTermsTextLinkedServer;
            }
        }

        public string SynchronizeColUnitTermsTextDatabase
        {
            get
            {
                if (this._SynchronizeColUnitTermsTextDatabase == null)
                    this.setSynchronizeColUnitTermsTextDatabaseParameters();
                return _SynchronizeColUnitTermsTextDatabase;
            }
        }

        public string SynchronizeColUnitTermsTextConnectionString
        {
            get
            {
                if (this._SynchronizeColUnitTermsTextConnectionString == null)
                    this.setSynchronizeColUnitTermsTextDatabaseParameters();
                return _SynchronizeColUnitTermsTextConnectionString;
            }
        }

        public string SynchronizeColUnitTermsTextBaseURL
        {
            get
            {
                if (this._SynchronizeColUnitTermsTextBaseURL == null)
                    this.setSynchronizeColUnitTermsTextDatabaseParameters();
                return _SynchronizeColUnitTermsTextBaseURL;
            }
        }

        public string SynchronizeColUnitTermsTextPrefix
        {
            get
            {
                string Prefix = this.SynchronizeColUnitTermsTextDatabase + ".dbo.";
                if (this.SynchronizeColUnitTermsTextLinkedServer.Length > 0)
                    Prefix = "[" + this.SynchronizeColUnitTermsTextLinkedServer + "]." + Prefix;
                return Prefix;
            }
        }

        private void setSynchronizeColUnitTermsTextDatabaseParameters()
        {
            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DataBaseURIs().TryGetValue(this.comboBoxSynUnitTermsTextDatabase.Text, out this._SynchronizeColUnitTermsTextBaseURL))
            {
                this._SynchronizeColUnitTermsTextDatabase = this.comboBoxSynUnitTermsTextDatabase.SelectedItem.ToString();
                this._SynchronizeColUnitTermsTextConnectionString = DiversityWorkbench.Settings.ConnectionString;
                foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnections())
                {
                    if (KV.Value.DisplayText == this._SynchronizeColUnitTermsTextDatabase)
                    {
                        this._SynchronizeColUnitTermsTextConnectionString = KV.Value.ConnectionString;
                        this._SynchronizeColUnitTermsTextDatabase = KV.Value.DatabaseName;
                        this._SynchronizeColUnitTermsTextBaseURL = KV.Value.BaseURL;
                        this._SynchronizeColUnitTermsTextLinkedServer = KV.Value.LinkedServer;
                        //if (KV.Value.DatabaseServer != DiversityWorkbench.Settings.DatabaseServer)
                        //    this._SynchronizeColUnitTermsTextSameServer = false;
                    }
                }
                this.labelSynUnitTermsTextTermProject.Visible = true;
                this.comboBoxSynUnitTermsTextTermProject.Visible = true;
                this.comboBoxSynUnitTermsTextTermProject_DropDown(null, null);
            }
            
            this.dataGridViewSynUnitTermsText.DataSource = null;
            this._dtSynUnitTermsText = new DataTable();
        }

        private void checkBoxSynUnitTermsTextIncludeHierarchy_CheckedChanged(object sender, EventArgs e)
        {
            if (this.checkBoxSynUnitTermsTextIncludeHierarchy.Checked)
                this.panelSynUnitTermsTextIncludeHierarchy.Enabled = true;
            else
                this.panelSynUnitTermsTextIncludeHierarchy.Enabled = false;
        }

        private void comboBoxSynUnitTermsTextTermProject_DropDown(object sender, EventArgs e)
        {
            try
            {
                string SelectedDatabase = this.comboBoxSynUnitTermsTextDatabase.SelectedItem.ToString();
                string ConnectionString = DiversityWorkbench.Settings.ConnectionString;
                string Database = this.comboBoxSynUnitTermsTextDatabase.Text;
                string LinkedServer = "";
                foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnections())
                {
                    if (KV.Value.DisplayText == SelectedDatabase)
                    {
                        ConnectionString = KV.Value.ConnectionString;
                        Database = KV.Value.DatabaseName;
                        LinkedServer = KV.Value.LinkedServer;
                        break;
                    }
                }

                System.Data.DataTable dt = new DataTable();
                string SQL = "SELECT NULL AS ProjectID, NULL AS Project " +
                    "UNION SELECT TerminologyID AS ProjectID, DisplayText AS Project " +
                    "FROM " + this.SynchronizeColUnitTermsTextPrefix + "Terminology " +
                    "ORDER BY Project";
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, ConnectionString);
                ad.Fill(dt);
                this.comboBoxSynUnitTermsTextTermProject.DataSource = dt;
                this.comboBoxSynUnitTermsTextTermProject.DisplayMember = "Project";
                this.comboBoxSynUnitTermsTextTermProject.ValueMember = "ProjectID";
            }
            catch (System.Exception ex)
            {
            }
        }

        private void SynchronizeColUnitTermsTextFillList()
        {
            try
            {
                bool IsWebservice = false;
                foreach (DiversityWorkbench.DatabaseService DS in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseServices())
                {
                    if (DS.DisplayText == this.comboBoxSynUnitTermsTextDatabase.Text && DS.IsWebservice)
                    {
                        IsWebservice = true;
                        break;
                    }
                }
                string Source = "";
                if (!IsWebservice)
                {
                    Source = this.SynchronizeColUnitTermsTextDatabase;
                    if (this.SynchronizeColUnitTermsTextLinkedServer.Length > 0)
                        Source = this.SynchronizeColUnitTermsTextLinkedServer + "." + Source;
                }
                else Source = this.comboBoxSynUnitTermsTextDatabase.Text;

                string SQL = "SELECT ";
                string SqlOrder = " ORDER BY RTRIM(LTRIM(I.VernacularTerm)) ";
                if (!this.checkBoxSynUnitTermsTextIncludeAccNr.Checked) SQL += " DISTINCT ";
                if (this.checkBoxSynUnitTermsTextMax.Checked)
                    SQL += "TOP " + this.numericUpDownSynUnitTermsTextMax.Value.ToString();
                SQL += " CAST(1 as bit) AS OK, RTRIM(LTRIM(I.VernacularTerm)) AS [Term in DiversityCollection], '' AS [Term in " + Source + "], I.TermURI, '' AS Hierarchy, 1 AS Similarities ";
                if (this.checkBoxSynUnitTermsTextIncludeAccNr.Checked)
                    SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";
                SQL += " FROM Identification AS I ";
                if (this.comboBoxSynUnitTermsTextTaxonomicGroup.Text.Length > 0)
                    SQL += " INNER JOIN IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID " +
                        " AND I.IdentificationUnitID = U.IdentificationUnitID ";
                SQL += " INNER JOIN CollectionProject AS P ON I.CollectionSpecimenID = P.CollectionSpecimenID " +
                    " INNER JOIN CollectionSpecimen AS S ON I.CollectionSpecimenID = S.CollectionSpecimenID " +
                    " WHERE (I.TermURI IS NULL  OR I.TermURI = '') AND I.VernacularTerm <> '' ";
                if (this.comboBoxSynUnitTermsTextTaxonomicGroup.Text.Length > 0)
                {
                    System.Data.DataRowView rTerm = (System.Data.DataRowView)this.comboBoxSynUnitTermsTextTaxonomicGroup.SelectedItem;
                    SQL += " AND U.TaxonomicGroup = '" + rTerm[0].ToString() + "'";
                    //SQL += " AND U.TaxonomicGroup = '" + this.comboBoxSynUnitTermsTextTaxonomicGroup.Text + "'";
                }
                if (this.comboBoxSynUnitTermsTextProject.SelectedIndex > -1
                    || this.comboBoxSynUnitTermsTextProject.Items.Count == 1)
                {
                    int ProjectID = 0;
                    if (this.comboBoxSynUnitTermsTextProject.SelectedItem != null)
                    {
                        System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynUnitTermsTextProject.SelectedItem;
                        if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                            SQL += " AND P.ProjectID = " + ProjectID.ToString();
                        else
                            return;
                    }
                    else return;
                }
                if (this.textBoxSynUnitTermsTextStartString.Text.Length > 0)
                    SQL += " AND I.VernacularTerm LIKE '" + this.textBoxSynUnitTermsTextStartString.Text + "%' ";
                SQL += SqlOrder;
                if (this._dtSynUnitTermsText == null) this._dtSynUnitTermsText = new DataTable();
                else this._dtSynUnitTermsText.Clear();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                try
                {
                    ad.Fill(this._dtSynUnitTermsText);
                }
                catch (System.Exception ex)
                {
                    System.Windows.Forms.MessageBox.Show(ex.Message);
                }
                this.Cursor = System.Windows.Forms.Cursors.Default;
                this.dataGridViewSynUnitTermsText.DataSource = this._dtSynUnitTermsText;
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private string SynchronizeColUnitTermsText_UpdateFromTableContent(string Group, int ProjectID)
        {
            System.Collections.Generic.List<System.Data.DataRow> UpdatedRows = new List<DataRow>();
            this._dtSynUnitTermsText.AcceptChanges();
            this.progressBarSynUnitTermsText.Maximum = this._dtSynUnitTermsText.Rows.Count;
            this.progressBarSynUnitTermsText.Minimum = 0;
            this.progressBarSynUnitTermsText.Value = 0;
            this.progressBarSynUnitTermsText.Visible = true;
            int i = 0;
            string Message = "";
            Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand("", con);
            try
            {
                con.Open();
                foreach (System.Data.DataRow R in this._dtSynUnitTermsText.Rows)
                {
                    if (R.RowState == DataRowState.Unchanged && R[0].ToString().ToLower() == "true")
                    {
                        string Term = R[2].ToString();
                        if (Term.IndexOf("'") > -1)
                            Term = Term.Replace("'", "''");
                        string SQL = "UPDATE I SET I.VernacularTerm = '" + Term + "',  I.TermURI = '" + R[3].ToString() + "' " +
                            " FROM Identification I  INNER JOIN  IdentificationUnit U ON I.CollectionSpecimenID = U.CollectionSpecimenID " +
                            " AND  I.IdentificationUnitID = U.IdentificationUnitID  INNER JOIN CollectionProject P " +
                            " ON I.CollectionSpecimenID = P.CollectionSpecimenID  " +
                            " WHERE (I.TermURI IS NULL OR I.TermURI = '')  AND RTRIM(LTRIM(I.VernacularTerm)) = '" + R[1].ToString().Trim().Replace("'", "''") + "'" +
                            " AND (U.TaxonomicGroup = N'" + Group + "')" +
                            " AND P.ProjectID = " + ProjectID.ToString();
                        C.CommandText = SQL;
                        try
                        {
                            C.ExecuteNonQuery();
                            UpdatedRows.Add(R);
                        }
                        catch (System.Exception ex)
                        {
                            if (Message.Length == 0)
                                Message = "Failed taxa:\r\n\r\n";
                            Message += Term + ": " + ex.Message + "\r\n";
                            //R[0] = false;
                        }
                        if (Message.Length == 0 &&
                            this.checkBoxSynUnitTermsTextIncludeHierarchy.Checked &&
                            this._dtSynUnitTermsText.Columns.Contains("Hierarchy"))
                        {
                            SQL = "UPDATE U SET U.HierarchyCache = '" + R["Hierarchy"].ToString() + "' " +
                                " FROM Identification AS I INNER JOIN " +
                                " IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID AND I.IdentificationUnitID = U.IdentificationUnitID INNER JOIN " +
                                " CollectionProject AS P ON I.CollectionSpecimenID = P.CollectionSpecimenID " +
                                " WHERE (I.TermURI = '" + R[3].ToString() + "') AND (I.VernacularTerm = '" + R[1].ToString().Replace("'", "''") + "') " +
                                " AND (U.TaxonomicGroup = N'" + Group + "') AND (P.ProjectID = " + ProjectID.ToString() + ") ";
                            C.CommandText = SQL;
                            C.ExecuteNonQuery();
                        }
                    }
                    else
                        i--;
                    i++;
                    this.progressBarSynUnitTermsText.Value = i;
                }
                System.Windows.Forms.MessageBox.Show("Update finished");
                if (UpdatedRows.Count > 0)
                {
                    foreach (System.Data.DataRow R in UpdatedRows)
                        R.Delete();
                    this._dtSynUnitTermsText.AcceptChanges();
                }
            }
            catch (Exception ex)
            {
                //if (this.radioButtonSynColTaxTextComparePartsInsertName.Checked)
                //    System.Windows.Forms.MessageBox.Show("Insert failed:\r\n" + ex.Message);
                //else
                System.Windows.Forms.MessageBox.Show("Update failed:\r\n" + ex.Message);
            }
            finally
            {
                con.Close();
                this.progressBarSynUnitTermsText.Visible = false;
            }
            if (Message.Length > 0)
                System.Windows.Forms.MessageBox.Show(Message);
            return Message;
        }

        #endregion

        #endregion

        #endregion

        #region Site properties

        #region Obsolete Common



        //        private void InitSynTerms()
        //        {
        //#if DEBUG
        //            if (this.comboBoxSynTermsTextTable.Items.Count == 0)
        //            {
        //                this.comboBoxSynTermsTextTable.Items.Add(SynTermTargetTable.CollectionEventProperty.ToString());
        //                this.comboBoxSynTermsTextTable.Items.Add(SynTermTargetTable.CollectionSpecimenPartDescription.ToString());
        //                this.comboBoxSynTermsTextTable.Items.Add(SynTermTargetTable.Identification.ToString());
        //            }
        //            if (this.comboBoxSynColTermTable.Items.Count == 0)
        //            {
        //                this.comboBoxSynColTermTable.Items.Add(SynTermTargetTable.CollectionEventProperty);
        //                this.comboBoxSynColTermTable.Items.Add(SynTermTargetTable.CollectionSpecimenPartDescription);
        //                this.comboBoxSynColTermTable.Items.Add(SynTermTargetTable.Identification);
        //            }
        //#else
        //            this.comboBoxSynTermsTextTable.Visible = false;
        //            this.comboBoxSynColTermTable.Visible = false;
        //#endif
        //#if !DEBUG
        //            this.InitSynTermsHideForRelease();
        //#endif
        //        }

        private void InitSynTermsHideForRelease()
        {
            //this.tabControlTerms.TabPages.Remove(this.tabPageSynchroTermsText);
            //this.labelSynColTermTable.Visible = false;
            //this.comboBoxSynColTermTable.Visible = false;
        }

        private void SynTermSetCellStyle(System.Windows.Forms.DataGridView D, int From, int? To = null)
        {
            try
            {
                System.Windows.Forms.DataGridViewCellStyle S = new DataGridViewCellStyle(D.DefaultCellStyle);
                S.ForeColor = System.Drawing.Color.Blue;
                int Max = D.ColumnCount;
                if (To != null)
                    Max = (int)To;
                for (int i = From; i < Max; i++)
                {
                    D.Columns[i].DefaultCellStyle = S;
                }
            }
            catch(System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        #endregion

        #region Linked

        private void InitSynchronizeTerm_EventProperty_Linked()
        {
            tabPageSynchroTermsUri.Controls.Clear();
            DiversityCollection.Maintenance.SynchronizeTerm synchronizeTerm = new DiversityCollection.Maintenance.SynchronizeTerm(DiversityCollection.Maintenance.SynchronizeTerm.TargetTable.CollectionEventProperty, true);
            DiversityCollection.Maintenance.UserControlSynchronizeTerm userControlSynchronizeTerm = new DiversityCollection.Maintenance.UserControlSynchronizeTerm(synchronizeTerm);
            // #35
            this.helpProvider.SetHelpKeyword(userControlSynchronizeTerm, "maintenacesyncsiteproperies_linked_dc");

            userControlSynchronizeTerm.Dock = DockStyle.Fill;
            tabPageSynchroTermsUri.Controls.Add(userControlSynchronizeTerm);
        }

        #region Obsolete

        private DiversityCollection.Maintenance.SynchronizeTerm _SynchronizeTerm_EventProperty_Linked;

        private DiversityCollection.Maintenance.SynchronizeTerm SynchronizeTerm_EventProperty_Linked
        {
            get
            {
                if (_SynchronizeTerm_EventProperty_Linked == null)
                {
                    _SynchronizeTerm_EventProperty_Linked = new DiversityCollection.Maintenance.SynchronizeTerm(DiversityCollection.Maintenance.SynchronizeTerm.TargetTable.CollectionEventProperty, true,
                        this.dataGridViewSynColTerm, this._dtSynColTerm, this.labelSynColTermResult,
                        this.buttonSynColTermUpdate);
                }
                return _SynchronizeTerm_EventProperty_Linked;
            }
        }



        private DiversityWorkbench.ServerConnection _SynTermsLinkServerConnection;

        private SynTermTargetTable SynTermLinkTargetSelectedTable
        {
            get
            {
                //return this._synTermTargetTable;

                SynTermTargetTable T = SynTermTargetTable.NULL;
                //if (this.comboBoxSynColTermTable.SelectedItem == null)
                //    return T;
                //switch (this.comboBoxSynColTermTable.SelectedItem.ToString())
                //{
                //    case "CollectionEventProperty":
                //        T = SynTermTargetTable.CollectionEventProperty;
                //        break;
                //    case "CollectionSpecimenPartDescription":
                //        T = SynTermTargetTable.CollectionSpecimenPartDescription;
                //        break;
                //    case "Identification":
                //        T = SynTermTargetTable.Identification;
                //        break;
                //}
                return T;
            }
        }

        private bool SynTermsLinkPrechecksPassed(ref int ProjectID)
        {
            bool OK = true;
            try
            {
                if (this.comboBoxSynColTermDatabase.SelectedIndex == -1)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a database");
                    return false;
                }
                //string Objekt = this.SamplingPlotTarget;
                //if (this.comboBoxSynColTermTarget.SelectedIndex == -1)
                //{
                //    System.Windows.Forms.MessageBox.Show("Please select a target");
                //    return false;
                //}
                if (this.comboBoxSynColTermProject.SelectedIndex == -1)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a project");
                    return false;
                }

                if (this.SynTermLinkTargetSelectedTable == SynTermTargetTable.NULL)
                {
                    System.Windows.Forms.MessageBox.Show("Please select the table that should be checked");
                    return false;
                }

                //System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColTermProject.SelectedItem;
                //int ProjectID = 0;
                if (this.comboBoxSynColTermProject.SelectedItem != null)
                {
                    System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColTermProject.SelectedItem;
                    if (!int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                        return false;
                }
                else return false;


            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            return OK;
        }

        private void comboBoxSynColTermDatabase_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.labelSynColTermDatabase.Text = "      Database:";
            DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList()[this.comboBoxSynColTermDatabase.SelectedItem.ToString()];
            this._SynTermsLinkServerConnection = SC;
            if (SC.LinkedServer.Length > 0)
                this.labelSynColTermDatabase.Text = "      " + SC.DatabaseName;
        }

        private void buttonSynColTermCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSynColTerm.SelectedRows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewSynColTerm.SelectedRows[0];
            bool OK = true;
            try { string test = R.Cells["CollectionSpecimenID"].Value.ToString(); }
            catch { OK = false; }
            if (OK)
            {
                if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
                {
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                else
                    this.DialogResult = DialogResult.Cancel;
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            }
        }

        private void buttonSynColTermSearch_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            try
            {
                bool setColumnWidth = true;

                //string Database = this.SamplingPlotDatabase;


                int ProjectID = 0;
                if (!SynTermsLinkPrechecksPassed(ref ProjectID))
                    return;
                //if (this.comboBoxSynColTermDatabase.SelectedIndex == -1)
                //{
                //    System.Windows.Forms.MessageBox.Show("Please select a database");
                //    return;
                //}
                ////string Objekt = this.SamplingPlotTarget;
                //if (this.comboBoxSynColTermTarget.SelectedIndex == -1)
                //{
                //    System.Windows.Forms.MessageBox.Show("Please select a target");
                //    return;
                //}
                //if (this.comboBoxSynColTermProject.SelectedIndex == -1)
                //{
                //    System.Windows.Forms.MessageBox.Show("Please select a project");
                //    return;
                //}

                ////System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColTermProject.SelectedItem;
                //if (this.comboBoxSynColTermProject.SelectedItem != null)
                //{
                //    System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColTermProject.SelectedItem;
                //    if (!int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                //        return;
                //}
                //else return;

                //if (!int.TryParse(this.comboBoxSynColTermProject.SelectedValue.ToString(), out ProjectID))
                //    return;



                //string DB = this.comboBoxSynColTermDatabase.SelectedItem.ToString();// = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseList();
                //string BaseURL = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList()[DB].BaseURL;

                string SQL = "SELECT DISTINCT ";
                //if (this.checkBoxSynColTermRestriction.Checked)
                //    SQL += " TOP " + this.numericUpDownSynColTermRestriction.Value.ToString() + " ";
                if (this.dataGridViewSynColTerm.ColumnCount > 1) setColumnWidth = false;
                //string SqlOrderBy = "";
                //switch(this.comboBoxSynTermsTextTable.Text)
                //{

                //}
                switch (this.SynTermLinkTargetSelectedTable)
                {
                    case SynTermTargetTable.CollectionEventProperty:
                        SQL += " T.PropertyURI AS URL, cast(1 as bit) as OK, T.DisplayText AS [Property in Collection] ";
                        break;
                    case SynTermTargetTable.CollectionSpecimenPartDescription:
                        SQL += " T.DescriptionTermURI AS URL, cast(1 as bit) as OK, T.Description AS [Property in Collection] ";
                        break;
                    case SynTermTargetTable.Identification:
                        SQL += " T.TermURI AS URL, cast(1 as bit) as OK, T.VernacularTerm AS [Property in Collection] ";
                        break;
                }

                switch ("")//this.comboBoxSynColTermTarget.Text)
                {
                    case "Term":
                        SQL += ", '' AS [Property in ScientificTerms] ";
                        break;
                    case "Hierarchy":
                        switch (this.SynTermLinkTargetSelectedTable)
                        {
                            case SynTermTargetTable.CollectionEventProperty:
                                SQL += ", T.PropertyHierarchyCache ";
                                break;
                            case SynTermTargetTable.CollectionSpecimenPartDescription:
                                SQL += ", T.DescriptionHierarchyCache ";
                                break;
                            case SynTermTargetTable.Identification:
                                SQL += ", U.HierarchyCache ";
                                break;
                        }
                        SQL += " AS [Hierarchy in Collection], '' AS [Hierarchy in ScientificTerms]";
                        break;
                }
                if (this.checkBoxSynColPlotIncludeAccNr.Checked)
                    SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";



                SQL += SynTermsLinkFromClause();
                SQL += SynTermsLinkGroupAndOrderClause();
                //SQL += " FROM CollectionEventProperty T, CollectionSpecimen S, CollectionProject P ";
                //SQL += " WHERE T.PropertyURI LIKE '" + this._SynTermsLinkServerConnection.BaseURL + "%' " + // BaseURL + "%' " +
                //    " AND S.CollectionEventID = E.CollectionEventID " +
                //    " AND S.CollectionSpecimenID = P.CollectionSpecimenID " +
                //    " AND P.ProjectID = " + ProjectID.ToString();
                //SqlOrderBy = " ORDER BY E.DisplayText";
                //SQL += SqlOrderBy;


                this._dtSynColTerm = new DataTable();
                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(C);
                this._dtSynColTerm.Clear();
                ad.Fill(this._dtSynColTerm);

                this.progressBarSynColTerm.Value = 0;
                this.progressBarSynColTerm.Maximum = this._dtSynColTerm.Rows.Count;
                //string ConnectionString = this._SynTermsLinkServerConnection.ConnectionString;// DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList()[DB].ConnectionString;
                Microsoft.Data.SqlClient.SqlConnection conTerm = new Microsoft.Data.SqlClient.SqlConnection(this._SynTermsLinkServerConnection.ConnectionString);
                conTerm.Open();
                Microsoft.Data.SqlClient.SqlCommand Com = new Microsoft.Data.SqlClient.SqlCommand("", conTerm);
                System.Collections.Generic.List<System.Data.DataRow> RowsToRemove = new List<DataRow>();
                //DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList()[DB];
                string Prefix = this._SynTermsLinkServerConnection.Prefix();// SC.DatabaseName + ".dbo.";
                //if (SC.LinkedServer.Length > 0)
                //    Prefix = "[" + SC.LinkedServer + "]." + Prefix;
                foreach (System.Data.DataRow R in this._dtSynColTerm.Rows)
                {
                    string ID = DiversityWorkbench.WorkbenchUnit.getIDFromURI(R["URL"].ToString());
                    int i;
                    if (!int.TryParse(ID, out i))
                    {
                        RowsToRemove.Add(R);
                        continue;
                    }
                    SQL = "SELECT ";
                    switch ("")//this.comboBoxSynColTermTarget.Text)
                    {
                        case "Term":
                            SQL += " DisplayText ";
                            break;
                        case "Hierarchy":
                            SQL += " HierarchyCacheDown ";
                            break;
                    }

                    SQL += " FROM " + Prefix + "TermRepresentation AS R " +
                        "WHERE RepresentationID = " + ID;
                    Com.CommandText = SQL;
                    string Result = Com.ExecuteScalar().ToString();

                    switch ("")//this.comboBoxSynColTermTarget.Text)
                    {
                        case "Term":
                            if (Result.Length > 0)
                            {
                                if (R["Property in Collection"].ToString() == Result)
                                    RowsToRemove.Add(R);
                                else
                                {
                                    R["OK"] = true;
                                    R["Property in ScientificTerms"] = Result;
                                }
                            }
                            else
                            {
                                if (R["Property in Collection"].ToString().Length == 0)
                                    RowsToRemove.Add(R);
                                else
                                    R["OK"] = false;
                            }
                            break;
                        case "Hierarchy":
                            if (Result.Length > 0)
                            {
                                if (R["Hierarchy in Collection"].ToString() == Result)
                                    RowsToRemove.Add(R);
                                else
                                {
                                    R["OK"] = true;
                                    R["Hierarchy in ScientificTerms"] = Result;
                                }
                            }
                            else
                            {
                                if (R["Hierarchy in Collection"].ToString().Length == 0)
                                    RowsToRemove.Add(R);
                                else
                                    R["OK"] = false;
                            }
                            break;
                    }

                    if (this.progressBarSynColTerm.Value < this.progressBarSynColTerm.Maximum)
                        this.progressBarSynColTerm.Value++;
                }
                conTerm.Close();
                conTerm.Dispose();
                int iFits = RowsToRemove.Count;
                foreach (System.Data.DataRow R in RowsToRemove)
                    R.Delete();
                this._dtSynColTerm.AcceptChanges();

                this.dataGridViewSynColTerm.Columns.Clear();
                this.dataGridViewSynColTerm.DataSource = this._dtSynColTerm;
                this.dataGridViewSynColTerm.Columns[0].Width = 30;
                this.dataGridViewSynColTerm.ReadOnly = false;
                this.dataGridViewSynColTerm.Columns[0].Visible = false;
                this.dataGridViewSynColTerm.Columns[1].ReadOnly = false;
                this.dataGridViewSynColTerm.Columns[2].ReadOnly = true;
                this.dataGridViewSynColTerm.Columns[3].ReadOnly = true;
                //switch (this.comboBoxSynColTermTarget.Text)
                //{
                //    case "Term":
                //        if (this.checkBoxSynColTermIncludeAccNr.Checked)
                //        {
                //            this.dataGridViewSynColTerm.Columns[4].ReadOnly = true;
                //            this.dataGridViewSynColTerm.Columns[5].ReadOnly = true;
                //        }
                //        break;
                //    case "Hierarchy":
                //        if (this.checkBoxSynColTermIncludeAccNr.Checked)
                //        {
                //            this.dataGridViewSynColTerm.Columns[4].ReadOnly = true;
                //            this.dataGridViewSynColTerm.Columns[5].ReadOnly = true;
                //            this.dataGridViewSynColTerm.Columns[6].ReadOnly = true;
                //        }
                //        break;
                //}
                if (this._dtSynColTerm.Rows.Count > 0)
                {
                    this.labelSynColTermResult.Text = this._dtSynColTerm.Rows.Count.ToString() + " differences found";
                    if (iFits > 0)
                        this.labelSynColTermResult.Text += "\r\n" + iFits.ToString() + " where not different";
                    this.buttonSynColTermUpdate.Enabled = true;
                }
                else
                {
                    this.labelSynColTermResult.Text = "No differences found";
                    this.buttonSynColTermUpdate.Enabled = false;
                }
                this.dataGridViewSynColTerm.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.ColumnHeader);

                int Start = 3;
                //if (this.comboBoxSynColTermTarget.Text == "Hierarchy")
                //    Start++;
                this.SynTermSetCellStyle(this.dataGridViewSynColTerm, Start, Start + 1);
            }
            catch (System.Exception ex) { }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonSynColTermCheckAll_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColTerm.Rows)
            {
                R.Cells[1].Value = true;
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonSynColTermCheckNone_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColTerm.Rows)
            {
                R.Cells[1].Value = false;
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonSynColTermUpdate_Click(object sender, EventArgs e)
        {
            bool OK = true;

            int ProjectID = 0;
            if (!SynTermsLinkPrechecksPassed(ref ProjectID))
                return;
            //if (this.comboBoxSynColTermTarget.SelectedIndex == -1) OK = false;
            //if (!OK)
            //{
            //    System.Windows.Forms.MessageBox.Show("Please select a target of the comparision");
            //    return;
            //}

            string SQL = "";
            string SelectedType = "";// this.comboBoxSynColTermTarget.SelectedItem.ToString();
            Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
            try
            {
                con.Open();
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                this.progressBarSynColTerm.Value = 0;
                this.progressBarSynColTerm.Maximum = this._dtSynColTerm.Rows.Count;
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                if (this.comboBoxSynColTermProject.SelectedItem != null)
                {
                    System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColTermProject.SelectedItem;
                    if (!int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                        return;
                }
                else return;
                //if (!int.TryParse(this.comboBoxSynColTermProject.SelectedValue.ToString(), out ProjectID))
                //    return;

                SynTermTargetTable Table = SynTermLinkTargetSelectedTable;

                int i = 0;
                foreach (System.Data.DataRow R in this._dtSynColTerm.Rows)// System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynColTerm.Rows)
                {
                    if (R[1].ToString().ToLower() == "true") //R.Cells[1].Value.ToString().ToLower() == "true")
                    {

                        SQL = "UPDATE T SET "; //";

                        switch ("")//this.comboBoxSynColTermTarget.Text)
                        {
                            case "Term":
                                switch (Table)
                                {
                                    case SynTermTargetTable.CollectionEventProperty:
                                        SQL += "T.DisplayText ";
                                        break;
                                    case SynTermTargetTable.CollectionSpecimenPartDescription:
                                        SQL += "T.Description ";
                                        break;
                                    case SynTermTargetTable.Identification:
                                        SQL += "T.VernacularTerm ";
                                        break;
                                }
                                SQL += " = '" + R[3].ToString() + "' ";// + R.Cells[3].Value.ToString() + "' ";
                                break;
                            case "Hierarchy":
                                switch (Table)
                                {
                                    case SynTermTargetTable.CollectionEventProperty:
                                        SQL += "T.PropertyHierarchyCache ";
                                        break;
                                    case SynTermTargetTable.CollectionSpecimenPartDescription:
                                        SQL += "T.DescriptionHierarchyCache ";
                                        break;
                                    case SynTermTargetTable.Identification:
                                        SQL = "UPDATE U SET U.HierarchyCache ";
                                        break;
                                }
                                SQL += " = '" + R[4].ToString() + "' ";// + R.Cells[4].Value.ToString() + "' ";
                                break;
                        }
                        SQL += SynTermsLinkFromClause();


                        SQL += " WHERE ";
                        switch (Table)
                        {
                            case SynTermTargetTable.CollectionEventProperty:
                                SQL += " T.PropertyURI ";
                                break;
                            case SynTermTargetTable.CollectionSpecimenPartDescription:
                                SQL += " T.DescriptionTermURI ";
                                break;
                            case SynTermTargetTable.Identification:
                                SQL += " T.TermURI ";
                                break;
                        }
                        SQL += "  = '" + R[0].ToString() + "'";// + R.Cells[0].Value.ToString() + "'";
                        if (R.Table.Columns.Contains("CollectionSpecimenID"))
                            SQL += " AND S.CollectionSpecimenID = " + R["CollectionSpecimenID"].ToString();


                        //SQL += "' FROM CollectionEventProperty E, CollectionSpecimen S, CollectionProject P ";
                        //SQL += " WHERE S.CollectionEventID = E.CollectionEventID " +
                        //    " AND S.CollectionSpecimenID = P.CollectionSpecimenID " +
                        //    " AND P.ProjectID = " + ProjectID.ToString() +
                        //    " AND E.PropertyURI = '" + R.Cells[0].Value.ToString() + "'";


                        try
                        {
                            C.CommandText = SQL;
                            C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                            C.ExecuteNonQuery();
                            foreach (System.Windows.Forms.DataGridViewCell Cell in this.dataGridViewSynColTerm.Rows[i].Cells)
                                Cell.Style.BackColor = System.Drawing.Color.LightGreen;
                        }
                        catch (Exception ex)
                        {
                            DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                            foreach (System.Windows.Forms.DataGridViewCell Cell in this.dataGridViewSynColTerm.Rows[i].Cells)
                                Cell.Style.BackColor = System.Drawing.Color.Pink;
                        }
                    }

                    i++;
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
                System.Windows.Forms.MessageBox.Show("Update finished");
                this.dataGridViewSynColTerm.DataSource = null;
                con.Close();
            }
        }

        private void comboBoxSynColTermTarget_SelectionChangeCommitted(object sender, EventArgs e)
        {
            try
            {
                //string Type = this.comboBoxSynColTermTarget.SelectedItem.ToString();
            }
            catch (System.Exception ex) { }
        }

        private string SqlTermUpdate(System.Windows.Forms.DataGridViewRow R)
        {
            string SQL = "UPDATE ";
            //string Type = this.comboBoxSynColTermTarget.Text;
            //if (this.checkBoxSynColTermRestriction.Checked)
            //    SQL += " TOP (" + this.numericUpDownSynColTermRestriction.Value.ToString() + ") ";
            //switch (Type)
            //{
            //    case "Term": // Place name
            //        SQL += " CollectionEventProperty SET DisplayText = '" + R.Cells[2].Value.ToString() + "' ";
            //        SQL += this.SqlGazetteerPlaceFromAndWhere();
            //        break;

            //    case "Hierarchy":  //Country//
            //        SQL += " CollectionEventProperty SET PropertyHierarchyCache = '" + R.Cells[3].Value.ToString() + "' ";
            //        SQL += this.SqlGazetteerCountryFromAndWhere();
            //        break;
            //}
            if (this.comboBoxSynColTermProject.SelectedIndex > 0)
            {
                int ProjectID = 0;
                if (this.comboBoxSynColTermProject.SelectedItem != null)
                {
                    System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSynColTermProject.SelectedItem;
                    if (int.TryParse(RP[0].ToString(), out ProjectID))
                        SQL += " AND P.ProjectID = " + ProjectID.ToString();
                }
                else
                {
                    System.Windows.Forms.MessageBox.Show("Please select a project");
                    return "";
                }
            }
            else
                SQL += " AND P.ProjectID IN (SELECT ProjectID FROM ProjectList) ";
            return SQL;
        }

        private string SynTermsLinkFromClause(System.Data.DataRow Row = null, bool ForUpdate = false)
        {
            // Tests
            string SQL = " FROM ";
            try
            {
                SynTermTargetTable Table = SynTermLinkTargetSelectedTable;
                SQL += Table.ToString() + " AS T INNER JOIN CollectionSpecimen S ON T";
                int ProjectID;
                switch (Table)
                {
                    case SynTermTargetTable.CollectionEventProperty:
                        SQL += ".CollectionEventID = S.CollectionEventID AND T.PropertyURI";
                        break;
                    case SynTermTargetTable.CollectionSpecimenPartDescription:
                        SQL += ".CollectionSpecimenID = S.CollectionSpecimenID AND T.DescriptionTermURI";
                        break;
                    case SynTermTargetTable.Identification:
                        SQL += ".CollectionSpecimenID = S.CollectionSpecimenID AND T.TermURI";
                        break;
                }
                SQL += " LIKE '" + this._SynTermsLinkServerConnection.BaseURL + "%' ";

                if (Row != null && Row.Table.Columns.Contains("CollectionSpecimenID"))
                {
                    SQL += " AND S.CollectionSpecimenID = " + Row["CollectionSpecimenID"].ToString();
                }

                // getting the project
                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynColTermProject.SelectedItem;
                if (int.TryParse(R["ProjectID"].ToString(), out ProjectID))
                    SQL += " INNER JOIN CollectionProject P ON S.CollectionSpecimenID = P.CollectionSpecimenID AND P.ProjectID = " + ProjectID.ToString();

                SQL += " CROSS JOIN " + _SynTermsLinkServerConnection.Prefix() + "ViewBaseURL AS B";
                SQL += " INNER JOIN " + _SynTermsLinkServerConnection.Prefix() + "TermRepresentation R ON T.";
                switch (Table)
                {
                    case SynTermTargetTable.CollectionEventProperty:
                        SQL += "PropertyURI";
                        break;
                    case SynTermTargetTable.CollectionSpecimenPartDescription:
                        SQL += "DescriptionTermURI";
                        break;
                    case SynTermTargetTable.Identification:
                        SQL += "TermURI";
                        break;
                }
                SQL += " = B.BaseURL + cast(R.RepresentationID as varchar) ";
                //// Terminology
                //SQL += " AND R.TerminologyID = " + this.comboBoxSynTermsTextDatabaseProject.SelectedValue.ToString();
                //// No Rankging terms
                //SQL += " INNER JOIN " + _SynTermsTextServerConnection.Prefix() + "Term DST ON R.TermID = DST.TermID AND DST.IsRankingTerm = 0 ";
                // BaseURL
                //if (Table == SynTermTargetTable.Identification && this.comboBoxSynColTermTarget.Text == "Hierarchy")
                //{
                //    SQL += "INNER JOIN IdentificationUnit U ON T.CollectionSpecimenID = U.CollectionSpecimenID AND U.IdentificationUnitID = T.IdentificationUnitID ";
                //}
                //switch (Table)
                //{
                //    case SynTermTargetTables.CollectionEventProperty:
                //        SQL += " WHERE T.PropertyID = " + this.comboBoxSynTermsTextRestriction.SelectedValue.ToString();
                //        break;
                //    case SynTermTargetTables.CollectionSpecimenPartDescription:
                //        SQL += " INNER JOIN CollectionSpecimenPart CSP ON CSP.CollectionSpecimenID = T.CollectionSpecimenID AND CSP.SpecimenPartID = T.SpecimenPartID AND CSP.MaterialCategory = '" + this.comboBoxSynTermsTextRestriction.SelectedValue.ToString() + "'";
                //        break;
                //    case SynTermTargetTables.Identification:
                //        SQL += " INNER JOIN IdentificationUnit U ON U.CollectionSpecimenID = T.CollectionSpecimenID AND U.IdentificationUnitID = T.IdentificationUnitID AND U.TaxonomicGroup = '" + this.comboBoxSynTermsTextRestriction.SelectedValue.ToString() + "'";
                //        break;
                //}
                //if (!ForUpdate)
                //{
                //    SQL += " GROUP BY T.";
                //    switch (Table)
                //    {
                //        case SynTermTargetTables.CollectionEventProperty:
                //            SQL += "DisplayText";
                //            break;
                //        case SynTermTargetTables.CollectionSpecimenPartDescription:
                //            SQL += "Description";
                //            break;
                //        case SynTermTargetTables.Identification:
                //            SQL += "VernacularTerm";
                //            break;
                //    }
                //    if (this.comboBoxSynColTermTarget.Text == "Hierarchy")
                //    {
                //        switch (this.SynTermLinkTargetSelectedTable)
                //        {
                //            case SynTermTargetTables.CollectionEventProperty:
                //                SQL += ", T.PropertyHierarchyCache ";
                //                break;
                //            case SynTermTargetTables.CollectionSpecimenPartDescription:
                //                SQL += ", T.DescriptionHierarchyCache ";
                //                break;
                //            case SynTermTargetTables.Identification:
                //                SQL += ", U.HierarchyCache ";
                //                break;
                //        }
                //    }

                //    if (this.checkBoxSynColTermIncludeAccNr.Checked)
                //        SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";
                //    SQL += " ORDER BY ";
                //    switch (Table)
                //    {
                //        case SynTermTargetTables.CollectionEventProperty:
                //            SQL += "DisplayText";
                //            break;
                //        case SynTermTargetTables.CollectionSpecimenPartDescription:
                //            SQL += "Description";
                //            break;
                //        case SynTermTargetTables.Identification:
                //            SQL += "VernacularTerm";
                //            break;
                //    }
                //}

                return SQL;
            }

            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex, SQL);
                SQL = "";
            }
            return SQL;
        }

        private string SynTermsLinkGroupAndOrderClause() //System.Data.DataRow Row = null, bool ForUpdate = false)
        {
            // Tests
            string SQL = " ";
            try
            {
                SynTermTargetTable Table = SynTermLinkTargetSelectedTable;
                SQL += " GROUP BY T.";
                switch (Table)
                {
                    case SynTermTargetTable.CollectionEventProperty:
                        SQL += "DisplayText, T.PropertyURI ";
                        break;
                    case SynTermTargetTable.CollectionSpecimenPartDescription:
                        SQL += "Description, T.DescriptionTermURI ";
                        break;
                    case SynTermTargetTable.Identification:
                        SQL += "VernacularTerm, T.TermURI ";
                        break;
                }
                //if (this.comboBoxSynColTermTarget.Text == "Hierarchy")
                //{
                //    switch (this.SynTermLinkTargetSelectedTable)
                //    {
                //        case SynTermTargetTable.CollectionEventProperty:
                //            SQL += ", T.PropertyHierarchyCache ";
                //            break;
                //        case SynTermTargetTable.CollectionSpecimenPartDescription:
                //            SQL += ", T.DescriptionHierarchyCache ";
                //            break;
                //        case SynTermTargetTable.Identification:
                //            SQL += ", U.HierarchyCache ";
                //            break;
                //    }
                //}

                if (this.checkBoxSynColTermIncludeAccNr.Checked)
                    SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";
                SQL += " ORDER BY T.";
                switch (Table)
                {
                    case SynTermTargetTable.CollectionEventProperty:
                        SQL += "DisplayText";
                        break;
                    case SynTermTargetTable.CollectionSpecimenPartDescription:
                        SQL += "Description";
                        break;
                    case SynTermTargetTable.Identification:
                        SQL += "VernacularTerm";
                        break;
                }

                //return SQL;
            }

            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex, SQL);
                SQL = "";
            }
            return SQL;
        }

        #endregion

        #endregion

        #region Via Text

        private void InitSynchronizeTerm_EventProperty_Text()
        {
            try
            {
                //this.SynchronizeTerm_EventProperty_Text.setGroupsSource(this.comboBoxSynTermsTextProperty);

                tabPageSynchroTermsText.Controls.Clear();
                DiversityCollection.Maintenance.SynchronizeTerm synchronizeTerm = new DiversityCollection.Maintenance.SynchronizeTerm(DiversityCollection.Maintenance.SynchronizeTerm.TargetTable.CollectionEventProperty, false);
                DiversityCollection.Maintenance.UserControlSynchronizeTerm userControlSynchronizeTerm = new DiversityCollection.Maintenance.UserControlSynchronizeTerm(synchronizeTerm);
                // #35
                this.helpProvider.SetHelpKeyword(userControlSynchronizeTerm, "maintenacesyncsiteproperies_viatext_dc");

                userControlSynchronizeTerm.Dock = DockStyle.Fill;
                tabPageSynchroTermsText.Controls.Add(userControlSynchronizeTerm);
            }
            catch (System.Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
        }

        #region Obsolete

        private DiversityCollection.Maintenance.SynchronizeTerm _SynchronizeTerm_EventProperty_Text;

        private DiversityCollection.Maintenance.SynchronizeTerm SynchronizeTerm_EventProperty_Text
        {
            get
            {
                if (_SynchronizeTerm_EventProperty_Text == null)
                {
                    _SynchronizeTerm_EventProperty_Text = new DiversityCollection.Maintenance.SynchronizeTerm(DiversityCollection.Maintenance.SynchronizeTerm.TargetTable.CollectionEventProperty, false,
                        this.dataGridViewSynTermsText, this._dtSynTermsText, this.labelSynTermsTextResult,
                        this.buttonSynTermsTextUpdate);
                }
                return _SynchronizeTerm_EventProperty_Text;
            }
        }

        private DiversityWorkbench.ServerConnection _SynTermsTextServerConnection;

        private System.Data.DataTable _dtSynTermsText;

        #region Hierarchy
        private void checkBoxSynPartDescriptionTextIncludeHierarchy_Click(object sender, EventArgs e)
        {
            this.SynPartDescriptionTextSetHierarchy();
        }

        private void radioButtonSynPartDescriptionTextIncludeHierarchyDetailTop_CheckedChanged(object sender, EventArgs e)
        {
            this.SynPartDescriptionTextSetHierarchy();
        }

        private void radioButtonSynPartDescriptionTextIncludeHierarchyTopDetail_CheckedChanged(object sender, EventArgs e)
        {
            this.SynPartDescriptionTextSetHierarchy();
        }

        private void SynPartDescriptionTextSetHierarchy()
        {
            if (this.checkBoxSynPartDescriptionTextIncludeHierarchy.Checked)
            {
                if (this.radioButtonSynPartDescriptionTextIncludeHierarchyDetailTop.Checked)
                    SynchronizeTerm_PartDescription_Text.setHierarchy(DiversityCollection.Maintenance.SynchronizeTerm.Hierarchy.DetailTop);
                else
                    SynchronizeTerm_PartDescription_Text.setHierarchy(DiversityCollection.Maintenance.SynchronizeTerm.Hierarchy.TopDetail);
            }
            else SynchronizeTerm_PartDescription_Text.setHierarchy(DiversityCollection.Maintenance.SynchronizeTerm.Hierarchy.None);
        }

        #endregion


        private void buttonSynTermsTextCheckSingle_Click(object sender, EventArgs e)
        {
            SynchronizeTerm_PartDescription_Text.ShowDetails(this.Width, this.Height, this.Location);

            //if (this.dataGridViewSynTermsText.SelectedRows.Count == 0)
            //{
            //    System.Windows.Forms.MessageBox.Show("Please select a dataset");
            //    return;
            //}
            //System.Windows.Forms.DataGridViewRow R = this.dataGridViewSynTermsText.SelectedRows[0];
            //bool OK = true;
            //try { string test = R.Cells["CollectionSpecimenID"].Value.ToString(); }
            //catch { OK = false; }
            //if (OK)
            //{
            //    if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
            //    {
            //        this.DialogResult = DialogResult.OK;
            //        this.Close();
            //    }
            //    else
            //        this.DialogResult = DialogResult.Cancel;
            //}
            //else
            //{
            //    System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            //}
        }

        private SynTermTargetTable SynTermTextTargetSelectedTable
        {
            get
            {
                SynTermTargetTable T = SynTermTargetTable.NULL;
                //if (this.comboBoxSynTermsTextTable.SelectedItem == null)
                //    return T;
                //switch (this.comboBoxSynTermsTextTable.SelectedItem.ToString())
                //{
                //    case "CollectionEventProperty":
                //        T = SynTermTargetTable.CollectionEventProperty;
                //        break;
                //    case "CollectionSpecimenPartDescription":
                //        T = SynTermTargetTable.CollectionSpecimenPartDescription;
                //        break;
                //    case "Identification":
                //        T = SynTermTargetTable.Identification;
                //        break;
                //}
                return T;
            }
        }

        private bool SynTermsTextPrechecksPassed()
        {
            bool OK = true;
            try
            {
                if (this.SynTermTextTargetSelectedTable == SynTermTargetTable.NULL)
                {
                    System.Windows.Forms.MessageBox.Show("Please select the table that should be checked");
                    return false;
                }
                if (this.comboBoxSynTermsTextDatabaseProject.SelectedIndex == -1)
                {
                    System.Windows.Forms.MessageBox.Show("Please select the terminology that should be checked");
                    return false;
                }
                if (this.comboBoxSynTermsTextProject.SelectedIndex == -1)
                {
                    System.Windows.Forms.MessageBox.Show("Please select the project that should be checked");
                    return false;
                }
                if (this._SynTermsTextServerConnection == null || this._SynTermsTextServerConnection.ConnectionString.Length == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select the database that should be checked");
                    return false;
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            return OK;
        }

        private void buttonSynTermsTextSearch_Click(object sender, EventArgs e)
        {
            if (!SynTermsTextPrechecksPassed())
                return;

            try
            {
                SynTermTargetTable Table = SynTermTextTargetSelectedTable;
                string SQL = "SELECT ";
                //if (!this.checkBoxSynTermsTextIncludeAccNr.Checked) SQL += " DISTINCT ";
                SQL += " CASE WHEN COUNT(DISTINCT R.RepresentationID) = 1 THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END AS OK, T.";
                switch (Table)
                {
                    case SynTermTargetTable.CollectionEventProperty:
                        SQL += "DisplayText";
                        break;
                    case SynTermTargetTable.CollectionSpecimenPartDescription:
                        SQL += "Description";
                        break;
                    case  SynTermTargetTable.Identification:
                        SQL += "VernacularTerm";
                        break;
                }

                SQL += " AS [Term in " + Table.ToString() + "] ";
                SQL += ",  MIN(R.DisplayText) AS [Term in DiversityScientificTerms], ";
                SQL += "MIN(R.HierarchyCacheDown) AS Hierarchy, ";
                SQL += "COUNT(DISTINCT R.RepresentationID) AS Count, MIN(B.[BaseURL]) + CAST(MIN(R.RepresentationID) AS varchar) AS URL ";
                if (this.checkBoxSynTermsTextIncludeAccNr.Visible && this.checkBoxSynTermsTextIncludeAccNr.Checked)
                    SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";
                SQL += " " + this.SynTermsTextFromClause();

                this._dtSynTermsText = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
                ad.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                try
                {
                    ad.Fill(this._dtSynTermsText);
                }
                catch (Exception ex)
                {
                    System.Windows.Forms.MessageBox.Show(ex.Message);
                }
                this.dataGridViewSynTermsText.DataSource = this._dtSynTermsText;
                for (int i = 1; i < this.dataGridViewSynTermsText.Columns.Count; i++)
                {
                    this.dataGridViewSynTermsText.Columns[i].ReadOnly = true;
                }

                this.SynTermSetCellStyle(this.dataGridViewSynTermsText, 2, 6);
                //System.Windows.Forms.DataGridViewCellStyle S = new DataGridViewCellStyle(this.dataGridViewSynTermsText.DefaultCellStyle);
                //S.ForeColor = System.Drawing.Color.Blue;
                //for (int i = 2; i < 6; i++)
                //{
                //    this.dataGridViewSynTermsText.Columns[i].DefaultCellStyle = S;
                //}

                this.dataGridViewSynTermsText.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                if (this._dtSynTermsText.Rows.Count > 0)
                {
                    this.labelSynTermsTextResult.Text = this._dtSynTermsText.Rows.Count.ToString() + " matches found";
                    this.buttonSynTermsTextUpdate.Enabled = true;
                }
                else
                {
                    this.labelSynTermsTextResult.Text = "No match found";
                    this.buttonSynColAgeTextUpdate.Enabled = false;                
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonSynTermsTextSelectAll_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynTermsText.Rows)
            {
                R.Cells[0].Value = true;
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonSelectNone_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSynTermsText.Rows)
            {
                R.Cells[0].Value = false;
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonSynTermsTextUpdate_Click(object sender, EventArgs e)
        {
            SynchronizeTerm_PartDescription_Text.Update();

            //string Message = "";
            //foreach(System.Data.DataRow R in this._dtSynTermsText.Rows)
            //{
            //    if (R[0].ToString() == "True")
            //    {
            //        string SQL = "UPDATE T SET T.";
            //        SynTermTargetTable Table = SynTermTextTargetSelectedTable;
            //        switch (Table)
            //        {
            //            case SynTermTargetTable.CollectionEventProperty:
            //                SQL += "DisplayText = '" + R[2].ToString() + "', T.PropertyURI";
            //                break;
            //            case SynTermTargetTable.CollectionSpecimenPartDescription:
            //                SQL += "Description = '" + R[2].ToString() + "', T.DescriptionTermURI";
            //                break;
            //            case SynTermTargetTable.Identification:
            //                SQL += "VernacularTerm = '" + R[2].ToString() + "', T.TermURI";
            //                break;
            //        }
            //        SQL += " = '" + R["URL"].ToString() + "'";
            //        switch (Table)
            //        {
            //            case SynTermTargetTable.CollectionEventProperty:
            //                SQL += ", T.PropertyHierarchyCache = '" + R["Hierarchy"].ToString() + "'";
            //                break;
            //            case SynTermTargetTable.CollectionSpecimenPartDescription:
            //                SQL += ", T.DescriptionHierarchyCache = '" + R["Hierarchy"].ToString() + "'";
            //                break;
            //        }
            //        SQL += this.SynTermsTextFromClause(R, true);
            //        if (SQL.IndexOf(" WHERE ") == 0)
            //            SQL += " WHERE T.";
            //        else
            //            SQL += " AND T.";
            //        switch (Table)
            //        {
            //            case SynTermTargetTable.CollectionEventProperty:
            //                SQL += "DisplayText";
            //                break;
            //            case SynTermTargetTable.CollectionSpecimenPartDescription:
            //                SQL += "Description";
            //                break;
            //            case SynTermTargetTable.Identification:
            //                SQL += "VernacularTerm";
            //                break;
            //        }
            //        SQL += " = '" + R[1].ToString() + "'";
            //        if (Table == SynTermTargetTable.Identification)
            //        {
            //            string SqlUnit = "UPDATE U SET U.HierarchyCache = '" + R["Hierarchy"].ToString() + "'";
            //            SqlUnit += this.SynTermsTextFromClause(R, true);
            //            SqlUnit += " WHERE T.VernacularTerm = '" + R[1].ToString() + "'";
            //            DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SqlUnit, ref Message);
            //        }
            //        DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL, ref Message);
            //    }
            //}
            //this.buttonSynTermsTextSearch_Click(null, null);
        }


        private void comboBoxSynTermsTextTable_SelectedIndexChanged(object sender, EventArgs e)
        {
            System.Data.DataTable dtRestriction = new DataTable();
            string SQL = "";
            switch(SynTermTextTargetSelectedTable)
            {
                case SynTermTargetTable.NULL:
                    this.comboBoxSynTermsTextProperty.DataSource = null;
                    this.labelSynTermsTextProperty.Text = "nothing selected";
                    this.labelSynTermsTextProperty.Image = null;
                    break;
                case SynTermTargetTable.CollectionEventProperty:
                    this.labelSynTermsTextProperty.Text = "      Property";
                    this.labelSynTermsTextProperty.Image = DiversityCollection.Resource.EventProperty;
                    SQL = "SELECT PropertyID AS Value, DisplayText AS Display FROM Property ORDER BY Display";
                    goto default;
                case SynTermTargetTable.CollectionSpecimenPartDescription:
                    this.labelSynTermsTextProperty.Text = "      Material category";
                    this.labelSynTermsTextProperty.Image = DiversityCollection.Resource.Specimen;
                    SQL = "SELECT Code AS Value, DisplayText AS Display FROM CollMaterialCategory_Enum ORDER BY Display";
                    goto default;
                case SynTermTargetTable.Identification:
                    this.labelSynTermsTextProperty.Text = "      Taxonomic group";
                    this.labelSynTermsTextProperty.Image = DiversityCollection.Resource.Plant;
                    SQL = "SELECT Code AS Value, DisplayText AS Display FROM CollTaxonomicGroup_Enum ORDER BY Display";
                    goto default;
                default:
                    DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dtRestriction);
                    this.comboBoxSynTermsTextProperty.DataSource = dtRestriction;
                    this.comboBoxSynTermsTextProperty.DisplayMember = "Display";
                    this.comboBoxSynTermsTextProperty.ValueMember = "Value";
                    break;
            }
        }

        private void comboBoxSynTermsTextDatabase_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.labelSynTermsTextDatabase.Text = "      Database:";
            this._SynTermsTextServerConnection = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList()[this.comboBoxSynTermsTextDatabase.SelectedItem.ToString()];
            if (this._SynTermsTextServerConnection.LinkedServer.Length > 0)
                this.labelSynTermsTextDatabase.Text = "      " + this._SynTermsTextServerConnection.DatabaseName;
            this.setSynTermsTextTerminologies();
        }

        private string SynTermsTextFromClause(System.Data.DataRow Row = null, bool ForUpdate = false)
        {
            // Tests
            string SQL = " FROM ";
            try
            {
                SynTermTargetTable Table = SynTermTextTargetSelectedTable;
                SQL += Table.ToString() + " AS T INNER JOIN CollectionSpecimen S ON T" ;
                int ProjectID;
                switch (Table)
                {
                    case  SynTermTargetTable.CollectionEventProperty:
                        SQL += ".CollectionEventID = S.CollectionEventID AND (T.PropertyURI IS NULL OR T.PropertyURI = '') ";
                        break;
                    case SynTermTargetTable.CollectionSpecimenPartDescription:
                        SQL += ".CollectionSpecimenID = S.CollectionSpecimenID AND (T.DescriptionTermURI IS NULL OR T.DescriptionTermURI = '') ";
                        break;
                    case SynTermTargetTable.Identification:
                        SQL += ".CollectionSpecimenID = S.CollectionSpecimenID AND (T.TermURI IS NULL OR T.TermURI = '') ";
                        break;
                }
                if (Row != null && Row.Table.Columns.Contains("CollectionSpecimenID"))
                {
                    SQL += " AND S.CollectionSpecimenID = " + Row["CollectionSpecimenID"].ToString();
                }

                // getting the project
                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxSynTermsTextProject.SelectedItem;
                if (int.TryParse(R["ProjectID"].ToString(), out ProjectID))
                    SQL += " INNER JOIN CollectionProject P ON S.CollectionSpecimenID = P.CollectionSpecimenID AND P.ProjectID = " + ProjectID.ToString();

                SQL += " INNER JOIN " + _SynTermsTextServerConnection.Prefix() + "TermRepresentation R ON T.";
                switch (Table)
                {
                    case SynTermTargetTable.CollectionEventProperty:
                        SQL += "DisplayText";
                        break;
                    case SynTermTargetTable.CollectionSpecimenPartDescription:
                        SQL += "Description";
                        break;
                    case SynTermTargetTable.Identification:
                        SQL += "VernacularTerm";
                        break;
                }
                SQL += " collate database_default = R.DisplayText collate database_default AND R.LanguageCode = '" + this.comboBoxSynTermsTextDatabaseLanguage.SelectedValue.ToString()  + "' ";
                // Terminology
                SQL += " AND R.TerminologyID = " + this.comboBoxSynTermsTextDatabaseProject.SelectedValue.ToString();
                // No Rankging terms
                SQL += " INNER JOIN " + _SynTermsTextServerConnection.Prefix() + "Term DST ON R.TermID = DST.TermID AND DST.IsRankingTerm = 0 ";
                // BaseURL
                SQL += " CROSS JOIN " + _SynTermsTextServerConnection.Prefix() + "ViewBaseURL AS B";
                switch (Table)
                {
                    case SynTermTargetTable.CollectionEventProperty:
                        SQL += " WHERE T.PropertyID = " + this.comboBoxSynTermsTextProperty.SelectedValue.ToString();
                        break;
                    case SynTermTargetTable.CollectionSpecimenPartDescription:
                        SQL += " INNER JOIN CollectionSpecimenPart CSP ON CSP.CollectionSpecimenID = T.CollectionSpecimenID AND CSP.SpecimenPartID = T.SpecimenPartID AND CSP.MaterialCategory = '" + this.comboBoxSynTermsTextProperty.SelectedValue.ToString() + "'";
                        break;
                    case SynTermTargetTable.Identification:
                        SQL += " INNER JOIN IdentificationUnit U ON U.CollectionSpecimenID = T.CollectionSpecimenID AND U.IdentificationUnitID = T.IdentificationUnitID AND U.TaxonomicGroup = '" + this.comboBoxSynTermsTextProperty.SelectedValue.ToString() + "'";
                        break;
                }
                if (!ForUpdate)
                {
                    SQL += " GROUP BY T.";
                    switch (Table)
                    {
                        case SynTermTargetTable.CollectionEventProperty:
                            SQL += "DisplayText";
                            break;
                        case SynTermTargetTable.CollectionSpecimenPartDescription:
                            SQL += "Description";
                            break;
                        case SynTermTargetTable.Identification:
                            SQL += "VernacularTerm";
                            break;
                    }
                    if (this.checkBoxSynTermsTextIncludeAccNr.Checked)
                        SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";
                }

                return SQL;
            }
           
            catch(System.Exception ex)
            {
                SQL = "";
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            return SQL;
        }

        private void setSynTermsTextTerminologies()
        {
            string Prefix = "dbo.";
            if (this._SynTermsTextServerConnection.LinkedServer != null && this._SynTermsTextServerConnection.LinkedServer.Length > 0)
                Prefix = "[" + this._SynTermsTextServerConnection.LinkedServer + "].[" + this._SynTermsTextServerConnection.DatabaseName + "].dbo.";
            string SQL = "SELECT TerminologyID, DisplayText FROM " + Prefix + "Terminology ORDER BY DisplayText";
            System.Data.DataTable dt = new DataTable();
            DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dt, this._SynTermsTextServerConnection.ConnectionString);
            this.comboBoxSynTermsTextDatabaseProject.DataSource = dt;
            this.comboBoxSynTermsTextDatabaseProject.DisplayMember = "DisplayText";
            this.comboBoxSynTermsTextDatabaseProject.ValueMember = "TerminologyID";
            if (dt.Rows.Count > 0)
            {
                this.comboBoxSynTermsTextDatabaseProject.SelectedIndex = 0;
            }
            SQL = "SELECT Code, DisplayText FROM " + Prefix + "LanguageCode_Enum ORDER BY DisplayText";
            System.Data.DataTable dtLang = new DataTable();
            DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dtLang, this._SynTermsTextServerConnection.ConnectionString);
            this.comboBoxSynTermsTextDatabaseLanguage.DataSource = dtLang;
            this.comboBoxSynTermsTextDatabaseLanguage.DisplayMember = "DisplayText";
            this.comboBoxSynTermsTextDatabaseLanguage.ValueMember = "Code";
            if (dtLang.Rows.Count > 0)
            {
                this.comboBoxSynTermsTextDatabaseLanguage.SelectedIndex = 0;
            }
        }

        private int? SynTermsTextTerminologyID()
        {
            try
            {
                if (this.comboBoxSynTermsTextDatabaseProject.SelectedIndex > -1)
                {
                    int i;
                    if (int.TryParse(this.comboBoxSynTermsTextDatabaseProject.SelectedValue.ToString(), out i))
                        return i;
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            return null;
        }

        private void dataGridViewSynTermsText_RowHeaderMouseClick(object sender, DataGridViewCellMouseEventArgs e)
        {
            this.SynTermsTextSetCheckSingleButtonVisibile();
        }

        private void checkBoxSynTermsTextIncludeAccNr_CheckedChanged(object sender, EventArgs e)
        {
            this.SynTermsTextSetCheckSingleButtonVisibile();
        }

        private void SynTermsTextSetCheckSingleButtonVisibile()
        {
            if (this.checkBoxSynTermsTextIncludeAccNr.Visible &&
                this.checkBoxSynTermsTextIncludeAccNr.Checked &&
                this.dataGridViewSynTermsText.SelectedRows.Count == 1)
            {
                if (this.dataGridViewSynTermsText.SelectedCells.Count > 0)
                {
                    if(this.dataGridViewSynTermsText.SelectedCells[0].RowIndex == this.dataGridViewSynTermsText.SelectedRows[0].Index)
                        this.buttonSynTermsTextCheckSingle.Visible = true;
                    else
                        this.buttonSynTermsTextCheckSingle.Visible = false;
                }
                else
                    this.buttonSynTermsTextCheckSingle.Visible = true;
            }
            else
                this.buttonSynTermsTextCheckSingle.Visible = false;
        }

        private void dataGridViewSynTermsText_CellContentClick(object sender, DataGridViewCellEventArgs e)
        {
            this.SynTermsTextSetCheckSingleButtonVisibile();
        }

        #endregion

        #endregion

        #endregion

        #region Part description

        #region Linked

        private void InitSynchronizeTerm_PartDescription_Linked()
        {
            //this.SynchronizeTerm_Part_Linked.setGroupsSource(this.comboBoxSynPartDescriptionTextMaterial);

            tabPageSynPartDescriptionLinked.Controls.Clear();
            DiversityCollection.Maintenance.SynchronizeTerm synchronizeTerm = new DiversityCollection.Maintenance.SynchronizeTerm(DiversityCollection.Maintenance.SynchronizeTerm.TargetTable.CollectionSpecimenPartDescription, true);
            DiversityCollection.Maintenance.UserControlSynchronizeTerm userControlSynchronizeTerm = new DiversityCollection.Maintenance.UserControlSynchronizeTerm(synchronizeTerm);
            userControlSynchronizeTerm.Dock = DockStyle.Fill;
            tabPageSynPartDescriptionLinked.Controls.Add(userControlSynchronizeTerm);
        }

        #region Obsolete

        private DiversityCollection.Maintenance.SynchronizeTerm _SynchronizeTerm_Part_Linked;

        private DiversityCollection.Maintenance.SynchronizeTerm SynchronizeTerm_Part_Linked
        {
            get
            {
                if (_SynchronizeTerm_Part_Linked == null)
                {
                    _SynchronizeTerm_Part_Linked = new DiversityCollection.Maintenance.SynchronizeTerm(DiversityCollection.Maintenance.SynchronizeTerm.TargetTable.CollectionSpecimenPartDescription, true,
                        this.dataGridViewPartDesc, this._dtPartDesc, this.labelPartDescResult,
                        this.buttonSynTermsTextUpdate);
                }
                return _SynchronizeTerm_Part_Linked;
            }
        }


        private void comboBoxPartDescDatabase_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.labelPartDescDatabase.Text = "Database:";
            DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList()[this.comboBoxPartDescDatabase.SelectedItem.ToString()];
            if (SC.LinkedServer.Length > 0)
                this.labelPartDescDatabase.Text += SC.DatabaseName;
        }

        private void buttonPartDescCheckDataset_Click(object sender, EventArgs e)
        {
            SynchronizeTerm_Part_Linked.ShowDetails(this.Width, this.Height, this.Location);

            //if (this.dataGridViewPartDesc.SelectedRows.Count == 0)
            //{
            //    System.Windows.Forms.MessageBox.Show("Please select a dataset");
            //    return;
            //}
            //System.Windows.Forms.DataGridViewRow R = this.dataGridViewPartDesc.SelectedRows[0];
            //bool OK = true;
            //try { string test = R.Cells["CollectionSpecimenID"].Value.ToString(); }
            //catch { OK = false; }
            //if (OK)
            //{
            //    if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
            //    {
            //        this.DialogResult = DialogResult.OK;
            //        this.Close();
            //    }
            //    else
            //        this.DialogResult = DialogResult.Cancel;
            //}
            //else
            //{
            //    System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            //}
        }

        private void buttonPartDescSearch_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;

            SynchronizeTerm_Part_Linked.StartSearch();

            //try
            //{
            //    bool setColumnWidth = true;
            //    //string Database = this.SamplingPlotDatabase;
            //    if (this.comboBoxPartDescDatabase.SelectedIndex == -1)
            //    {
            //        System.Windows.Forms.MessageBox.Show("Please select a database");
            //        return;
            //    }
            //    //string Objekt = this.SamplingPlotTarget;
            //    if (this.comboBoxPartDescTermHierarchy.SelectedIndex == -1)
            //    {
            //        System.Windows.Forms.MessageBox.Show("Please select a target");
            //        return;
            //    }
            //    if (this.comboBoxPartDescProject.SelectedIndex == -1)
            //    {
            //        System.Windows.Forms.MessageBox.Show("Please select a project");
            //        return;
            //    }

            //    //System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxPartDescProject.SelectedItem;
            //    int ProjectID = 0;
            //    if (this.comboBoxPartDescProject.SelectedItem != null)
            //    {
            //        System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxPartDescProject.SelectedItem;
            //        if (!int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
            //            return;
            //    }
            //    else return;

            //    //if (!int.TryParse(this.comboBoxPartDescProject.SelectedValue.ToString(), out ProjectID))
            //    //    return;

            //    string DB = this.comboBoxPartDescDatabase.SelectedItem.ToString();// = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DatabaseList();
            //    string BaseURL = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList()[DB].BaseURL;

            //    string SQL = "SELECT DISTINCT ";
            //    if (this.checkBoxPartDescTop.Checked)
            //        SQL += " TOP " + this.numericUpDownPartDesc.Value.ToString() + " ";
            //    if (this.dataGridViewPartDesc.ColumnCount > 1) setColumnWidth = false;
            //    string SqlOrderBy = "";
            //    switch (this.comboBoxPartDescTermHierarchy.Text)
            //    {
            //        case "Term":
            //            SQL += " E.PropertyURI AS URL, cast(1 as bit) as OK, E.DisplayText AS [Property in Collection], " +
            //                "'' AS [Property in ScientificTerms] ";
            //            break;
            //        case "Hierarchy":
            //            SQL += " E.PropertyURI AS URL, cast(1 as bit) as OK, E.DisplayText AS [Property in Collection], E.PropertyHierarchyCache AS [Hierarchy in Collection], " +
            //                "'' AS [Hierarchy in ScientificTerms]";
            //            break;
            //    }
            //    if (this.checkBoxSynColPlotIncludeAccNr.Checked)
            //        SQL += ", S.AccessionNumber, S.CollectionSpecimenID ";
            //    SQL += " FROM CollectionSpecimenPartDescription E, CollectionSpecimen S, CollectionProject P ";
            //    SQL += " WHERE E.PropertyURI LIKE '" + BaseURL + "%' " +
            //        " AND S.CollectionEventID = E.CollectionEventID " +
            //        " AND S.CollectionSpecimenID = P.CollectionSpecimenID " +
            //        " AND P.ProjectID = " + ProjectID.ToString();
            //    SqlOrderBy = " ORDER BY E.DisplayText";
            //    SQL += SqlOrderBy;
            //    this._dtPartDesc = new DataTable();
            //    Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
            //    Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
            //    C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
            //    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(C);

            //    ad.Fill(this._dtPartDesc);
            //    this.progressBarPartDesc.Value = 0;
            //    this.progressBarPartDesc.Maximum = this._dtPartDesc.Rows.Count;
            //    string ConnectionString = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList()[DB].ConnectionString;
            //    Microsoft.Data.SqlClient.SqlConnection conTerm = new Microsoft.Data.SqlClient.SqlConnection(ConnectionString);
            //    conTerm.Open();
            //    Microsoft.Data.SqlClient.SqlCommand Com = new Microsoft.Data.SqlClient.SqlCommand("", conTerm);
            //    System.Collections.Generic.List<System.Data.DataRow> RowsToRemove = new List<DataRow>();
            //    DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList()[DB];
            //    string Prefix = SC.DatabaseName + ".dbo.";
            //    if (SC.LinkedServer.Length > 0)
            //        Prefix = "[" + SC.LinkedServer + "]." + Prefix;
            //    foreach (System.Data.DataRow R in this._dtPartDesc.Rows)
            //    {
            //        string ID = DiversityWorkbench.WorkbenchUnit.getIDFromURI(R["URL"].ToString());
            //        int i;
            //        if (!int.TryParse(ID, out i))
            //        {
            //            RowsToRemove.Add(R);
            //            continue;
            //        }
            //        SQL = "SELECT ";
            //        switch (this.comboBoxPartDescTermHierarchy.Text)
            //        {
            //            case "Term":
            //                SQL += " DisplayText ";
            //                break;
            //            case "Hierarchy":
            //                SQL += " HierarchyCache ";
            //                break;
            //        }

            //        SQL += " FROM " + Prefix + "TermRepresentation AS R " +
            //            "WHERE RepresentationID = " + ID;
            //        Com.CommandText = SQL;
            //        string Result = Com.ExecuteScalar().ToString();

            //        switch (this.comboBoxPartDescTermHierarchy.Text)
            //        {
            //            case "Term":
            //                if (Result.Length > 0)
            //                {
            //                    if (R["Property in Collection"].ToString() == Result)
            //                        RowsToRemove.Add(R);
            //                    else
            //                    {
            //                        R["OK"] = true;
            //                        R["Property in ScientificTerms"] = Result;
            //                    }
            //                }
            //                else
            //                {
            //                    if (R["Property in Collection"].ToString().Length == 0)
            //                        RowsToRemove.Add(R);
            //                    else
            //                        R["OK"] = false;
            //                }
            //                break;
            //            case "Hierarchy":
            //                if (Result.Length > 0)
            //                {
            //                    if (R["Hierarchy in Collection"].ToString() == Result)
            //                        RowsToRemove.Add(R);
            //                    else
            //                    {
            //                        R["OK"] = true;
            //                        R["Hierarchy in ScientificTerms"] = Result;
            //                    }
            //                }
            //                else
            //                {
            //                    if (R["Hierarchy in Collection"].ToString().Length == 0)
            //                        RowsToRemove.Add(R);
            //                    else
            //                        R["OK"] = false;
            //                }
            //                break;
            //        }

            //        if (this.progressBarPartDesc.Value < this.progressBarPartDesc.Maximum)
            //            this.progressBarPartDesc.Value++;
            //    }
            //    conTerm.Close();
            //    conTerm.Dispose();
            //    int iFits = RowsToRemove.Count;
            //    foreach (System.Data.DataRow R in RowsToRemove)
            //        R.Delete();
            //    this._dtPartDesc.AcceptChanges();

            //    this.dataGridViewPartDesc.Columns.Clear();
            //    this.dataGridViewPartDesc.DataSource = this._dtPartDesc;
            //    this.dataGridViewPartDesc.Columns[0].Width = 30;
            //    this.dataGridViewPartDesc.ReadOnly = false;
            //    this.dataGridViewPartDesc.Columns[0].Visible = false;
            //    this.dataGridViewPartDesc.Columns[1].ReadOnly = false;
            //    this.dataGridViewPartDesc.Columns[2].ReadOnly = true;
            //    this.dataGridViewPartDesc.Columns[3].ReadOnly = true;
            //    switch (this.comboBoxPartDescTermHierarchy.Text)
            //    {
            //        case "Term":
            //            if (this.checkBoxPartDescIncludeAccNr.Checked)
            //            {
            //                this.dataGridViewPartDesc.Columns[4].ReadOnly = true;
            //                this.dataGridViewPartDesc.Columns[5].ReadOnly = true;
            //            }
            //            break;
            //        case "Hierarchy":
            //            if (this.checkBoxPartDescIncludeAccNr.Checked)
            //            {
            //                this.dataGridViewPartDesc.Columns[4].ReadOnly = true;
            //                this.dataGridViewPartDesc.Columns[5].ReadOnly = true;
            //                this.dataGridViewPartDesc.Columns[6].ReadOnly = true;
            //            }
            //            break;
            //    }
            //    if (this._dtPartDesc.Rows.Count > 0)
            //    {
            //        this.labelPartDescResult.Text = this._dtPartDesc.Rows.Count.ToString() + " differences found";
            //        if (iFits > 0)
            //            this.labelPartDescResult.Text += "\r\n" + iFits.ToString() + " where not different";
            //        this.buttonPartDescUpdate.Enabled = true;
            //    }
            //    else
            //    {
            //        this.labelPartDescResult.Text = "No differences found";
            //        this.buttonPartDescUpdate.Enabled = false;
            //    }
            //    this.dataGridViewPartDesc.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.ColumnHeader);
            //}
            //catch (System.Exception ex) { }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonPartDescNone_Click(object sender, EventArgs e)
        {
            SynchronizeTerm_Part_Linked.DeselectAllRows();
        }

        private void buttonPartDescAll_Click(object sender, EventArgs e)
        {
            SynchronizeTerm_Part_Linked.SelectAllRows();
        }

        private void buttonPartDescUpdate_Click(object sender, EventArgs e)
        {
            SynchronizeTerm_Part_Linked.Update();
        }

        private string SqlPartDescUpdate(System.Windows.Forms.DataGridViewRow R)
        {
            string SQL = "UPDATE ";
            string Type = "Term";// this.comboBoxPartDescTermHierarchy.Text;
            //if (this.checkBoxPartDescTop.Checked)
            //    SQL += " TOP (" + this.numericUpDownPartDesc.Value.ToString() + ") ";
            switch (Type)
            {
                case "Term":
                    SQL += " CollectionEventProperty SET DisplayText = '" + R.Cells[2].Value.ToString() + "' ";
                    SQL += this.SqlGazetteerPlaceFromAndWhere();
                    break;

                case "Hierarchy":
                    SQL += " CollectionEventProperty SET PropertyHierarchyCache = '" + R.Cells[3].Value.ToString() + "' ";
                    SQL += this.SqlGazetteerCountryFromAndWhere();
                    break;
            }
            if (this.comboBoxPartDescProject.SelectedIndex > 0)
            {
                int ProjectID = 0;
                if (this.comboBoxPartDescProject.SelectedItem != null)
                {
                    System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxPartDescProject.SelectedItem;
                    if (int.TryParse(RP[0].ToString(), out ProjectID))
                        SQL += " AND P.ProjectID = " + ProjectID.ToString();
                }
                else
                {
                    System.Windows.Forms.MessageBox.Show("Please select a project");
                    return "";
                }
            }
            else
                SQL += " AND P.ProjectID IN (SELECT ProjectID FROM ProjectList) ";
            return SQL;
        }

        private void comboBoxPartDescLanguage_SelectedIndexChanged(object sender, EventArgs e)
        {
            //SynchronizeTerm_Part_Linked.setLanguage(comboBoxPartDescLanguage.SelectedValue.ToString());
        }

        private void comboBoxPartDescTerminology_SelectedIndexChanged(object sender, EventArgs e)
        {
            //SynchronizeTerm_Part_Linked.setLanguageSource(comboBoxPartDescLanguage);
        }

        private void comboBoxPartDescProject_SelectedIndexChanged(object sender, EventArgs e)
        {
            int ID;
            if (int.TryParse(comboBoxPartDescProject.SelectedValue.ToString(), out ID))
                SynchronizeTerm_Part_Linked.setProjectID(ID);
        }

        private void checkBoxPartDescTop_Click(object sender, EventArgs e)
        {
            SynchronizeTerm_Part_Linked_SetMaxResults();
        }

        private void numericUpDownPartDesc_ValueChanged(object sender, EventArgs e)
        {
            SynchronizeTerm_Part_Linked_SetMaxResults();
        }

        private void SynchronizeTerm_Part_Linked_SetMaxResults()
        {
            //if (checkBoxPartDescTop.Checked)
            //    SynchronizeTerm_Part_Linked.setMaxResults((int)this.numericUpDownPartDesc.Value);
            //else SynchronizeTerm_Part_Linked.setMaxResults(null);
        }

        private void checkBoxPartDescIncludeAccNr_Click(object sender, EventArgs e)
        {
            SynchronizeTerm_Part_Linked.IncludeAccessionNumbers(checkBoxPartDescIncludeAccNr.Checked);
        }

        #endregion

        #endregion

        #region Text

        private void InitSynchronizeTerm_PartDescription_Text()
        {
            //this.SynchronizeTerm_PartDescription_Text.setGroupsSource(this.comboBoxSynPartDescriptionTextMaterial);

            this.tabControlTerms.TabPages.Remove(this.tabPage1);
            this.tabControlTerms.TabPages.Remove(this.tabPage2);

            tabPageSynPartDescriptionText.Controls.Clear();
            DiversityCollection.Maintenance.SynchronizeTerm synchronizeTerm = new DiversityCollection.Maintenance.SynchronizeTerm(DiversityCollection.Maintenance.SynchronizeTerm.TargetTable.CollectionSpecimenPartDescription, false);
            DiversityCollection.Maintenance.UserControlSynchronizeTerm userControlSynchronizeTerm = new DiversityCollection.Maintenance.UserControlSynchronizeTerm(synchronizeTerm);
            userControlSynchronizeTerm.Dock = DockStyle.Fill;
            tabPageSynPartDescriptionText.Controls.Add(userControlSynchronizeTerm);
        }

        #region Obsolete

        private DiversityCollection.Maintenance.SynchronizeTerm _SynchronizeTerm_PartDescription_Text;
        private DiversityCollection.Maintenance.SynchronizeTerm SynchronizeTerm_PartDescription_Text
        {
            get
            {
                if (_SynchronizeTerm_PartDescription_Text == null)
                {
                    _SynchronizeTerm_PartDescription_Text = new DiversityCollection.Maintenance.SynchronizeTerm(
                        DiversityCollection.Maintenance.SynchronizeTerm.TargetTable.CollectionSpecimenPartDescription, 
                        false,
                        dataGridViewSynPartDescriptionText,
                        this._dtSynUnitTermsText,
                        this.labelSynPartDescriptionTextResult,
                        this.buttonSynPartDescriptionTextUpdate,
                        this.progressBarSynPartDescriptionText);
                }
                return _SynchronizeTerm_PartDescription_Text;
            }
        }

        private void comboBoxSynPartDescriptionTextDatabase_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.SynchronizeTerm_PartDescription_Text.setDatabase(comboBoxSynPartDescriptionTextDatabase.Text);
            this.labelSynUnitTermsTextDatabase.Text = this.SynchronizeTerm_PartDescription_Text.ServerConnection_DisplayText();// this.SynTerms_ServerConnection_DisplayText(SynTermTargetTable.CollectionSpecimenPartDescription, false); // "Database:";
            //DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].ServerConnectionList()[this.comboBoxSynUnitTermsTextDatabase.SelectedItem.ToString()];
            //if (SC.LinkedServer.Length > 0)
            //    this.labelSynUnitTermsTextDatabase.Text += SC.DatabaseName;
            this.comboBoxSynPartDescriptionTextTerminology.DataSource = null;
        }

        private void comboBoxSynPartDescriptionTextTerminology_DropDown(object sender, EventArgs e)
        {
            this.SynchronizeTerm_PartDescription_Text.setTerminologySource(comboBoxSynPartDescriptionTextTerminology);

            //if (this.comboBoxSynPartDescriptionTextTerminology.DataSource == null)
            //{
            //    comboBoxSynPartDescriptionTextTerminology.DataSource = this.SynchronizeTermPartDescriptionText.Terminologies();
            //    comboBoxSynPartDescriptionTextTerminology.DisplayMember = "Project";
            //    comboBoxSynPartDescriptionTextTerminology.ValueMember = "ProjectID";
            //}
            //this.SynTerms_Text_SetTerminologySource(SynTermTargetTable.CollectionSpecimenPartDescription, this.comboBoxSynUnitTermsTextDatabase.SelectedItem.ToString(), this.comboBoxSynUnitTermsTextTermProject);
        }

        private void buttonSynPartDescriptionTextOpenDetails_Click(object sender, EventArgs e)
        {
            this.SynchronizeTerm_PartDescription_Text.ShowDetails(this.Width, this.Height, this.Location);

            //this.SynTerms_OpenDetails(this.dataGridViewSynUnitTermsText);
        }

        private void textBoxSynPartDescriptionTextTermRestriction_TextChanged(object sender, EventArgs e)
        {
            SynchronizeTerm_PartDescription_Text.setTermRestriction(textBoxSynPartDescriptionTextTermRestriction.Text);
        }


        private void buttonSynPartDescriptionTextSearch_Click(object sender, EventArgs e)
        {
            this.SynchronizeTerm_PartDescription_Text.StartSearch();

            //try
            //{
            //    this.dataGridViewSynUnitTermsText.DataSource = null;
            //    this._dtSynUnitTermsText = new DataTable();
            //    int ProjectID = 0;
            //    string Group = "";
            //    if (!this.allValuesSetForUnitTermTextSynchro(ref ProjectID, ref Group)) return;
            //    bool setColumnWidth = true;
            //    // Workbench modules
            //    if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityScientificTerms"].DataBaseURIs().TryGetValue(this.comboBoxSynUnitTermsTextDatabase.Text, out this._SynchronizeColUnitTermsTextBaseURL))
            //    {
            //        if (this.comboBoxSynUnitTermsTextTermProject.SelectedValue == null || this.comboBoxSynUnitTermsTextTermProject.SelectedValue == System.DBNull.Value)
            //        {
            //            System.Windows.Forms.MessageBox.Show("Please select a terminology in the terms database");
            //            return;
            //        }
            //        this.SynchronizeColUnitTermsText(this.SynchronizeColUnitTermsTextDatabase, this.SynchronizeColUnitTermsTextConnectionString, this.SynchronizeColUnitTermsTextBaseURL);
            //    }

            //    if (this.dataGridViewSynUnitTermsText.ColumnCount > 1)
            //        setColumnWidth = true;
            //    if (this.dataGridViewSynUnitTermsText.ColumnCount > 0 && setColumnWidth)
            //    {
            //        this.dataGridViewSynUnitTermsText.Columns[0].AutoSizeMode = DataGridViewAutoSizeColumnMode.ColumnHeader;
            //        this.dataGridViewSynUnitTermsText.Columns[1].AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells;
            //        this.dataGridViewSynUnitTermsText.Columns[2].AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells;
            //    }
            //    this.dataGridViewSynUnitTermsText.ReadOnly = false;
            //    for (int i = 1; i < this.dataGridViewSynUnitTermsText.ColumnCount; i++)
            //    {
            //        this.dataGridViewSynUnitTermsText.Columns[i].ReadOnly = true;
            //    }
            //    for (int i = 0; i < this.dataGridViewSynUnitTermsText.ColumnCount; i++)
            //    {
            //        this.dataGridViewSynUnitTermsText.Columns[i].SortMode = DataGridViewColumnSortMode.NotSortable;
            //    }
            //    this.progressBarSynUnitTermsText.Visible = false;
            //    this.SynchronizeUnitTermsTextSetGridColors();
            //}
            //catch (System.Exception ex) { }
        }

        private void buttonSynPartDescriptionTextUpdate_Click(object sender, EventArgs e)
        {
            this.SynchronizeTerm_PartDescription_Text.Update();
        }

        private void buttonSynPartDescriptionTextSelectValid_Click(object sender, EventArgs e)
        {

        }

        private void buttonSynPartDescriptionTextSelectAll_Click(object sender, EventArgs e)
        {
            this.SynchronizeTerm_PartDescription_Text.SelectAllRows();
        }

        private void buttonSynPartDescriptionTextSelectNone_Click(object sender, EventArgs e)
        {
            this.SynchronizeTerm_PartDescription_Text.DeselectAllRows();
        }
        private void comboBoxSynPartDescriptionTextTerminology_SelectedIndexChanged(object sender, EventArgs e)
        {
            int ID;
            if (int.TryParse(this.comboBoxSynPartDescriptionTextTerminology.SelectedValue.ToString(), out ID))
            {
                this.SynchronizeTerm_PartDescription_Text.setTerminology(ID);
                this.comboBoxSynPartDescriptionTextLanguage.DataSource = this.SynchronizeTerm_PartDescription_Text.DtLanguages();
                this.comboBoxSynPartDescriptionTextLanguage.DisplayMember = "Display";
                this.comboBoxSynPartDescriptionTextLanguage.ValueMember = "Value";
            }
        }

        private void comboBoxSynPartDescriptionTextLanguage_SelectedIndexChanged(object sender, EventArgs e)
        {
            SynchronizeTerm_PartDescription_Text.setLanguage(comboBoxSynPartDescriptionTextLanguage.SelectedValue.ToString());
        }

        private void comboBoxSynPartDescriptionTextProject_SelectedIndexChanged(object sender, EventArgs e)
        {
            int ProjectID;
            if (int.TryParse(comboBoxSynPartDescriptionTextProject.SelectedValue.ToString(), out ProjectID))
                SynchronizeTerm_PartDescription_Text.setProjectID(ProjectID);
        }

        #region Max results
        private void comboBoxSynPartDescriptionTextMaterial_SelectedIndexChanged(object sender, EventArgs e)
        {
            SynchronizeTerm_PartDescription_Text.SetGroup(comboBoxSynPartDescriptionTextMaterial.SelectedValue.ToString());
        }

        private void checkBoxSynPartDescriptionTextMax_Click(object sender, EventArgs e)
        {
            SynPartDescriptionText_SetMaxResults();
        }

        #endregion

        private void numericUpDownSynPartDescriptionTextMax_ValueChanged(object sender, EventArgs e)
        {
            SynPartDescriptionText_SetMaxResults();
        }

        private void SynPartDescriptionText_SetMaxResults()
        {
            if (this.checkBoxSynPartDescriptionTextMax.Checked)
            {
                SynchronizeTerm_PartDescription_Text.setMaxResults((int)this.numericUpDownSynPartDescriptionTextMax.Value);
            }
            else SynchronizeTerm_PartDescription_Text.setMaxResults(null);
        }

        private void checkBoxSynPartDescriptionTextIncludeAccNr_Click(object sender, EventArgs e)
        {
            SynchronizeTerm_PartDescription_Text.IncludeAccessionNumbers(checkBoxSynPartDescriptionTextIncludeAccNr.Checked);
            this.buttonSynUnitTermsTextCheckDataset.Visible = checkBoxSynPartDescriptionTextIncludeAccNr.Checked;
        }

        #endregion

        #endregion

        #endregion

        #endregion

        #endregion

        #region AccessionNumber duplicates

        private void buttonAccNrDuplicatesCheck_Click(object sender, EventArgs e)
        {
            try
            {
                bool setColumnWidth = true;
                if (this.dataGridViewAccNrDuplicates.ColumnCount > 1) setColumnWidth = false;
                string SQL = "SELECT S.AccessionNumber, PP.Project, S.CollectionSpecimenID, S.CollectionEventID " +
                    "FROM ProjectProxy PP INNER JOIN " +
                    "CollectionProject P ON PP.ProjectID = P.ProjectID RIGHT OUTER JOIN " +
                    "CollectionSpecimen S ON P.CollectionSpecimenID = S.CollectionSpecimenID " +
                    "WHERE ";
                if (this.textBoxAccNrDuplicatesFilter.Text.Trim().Length > 0)
                    SQL += " S.AccessionNumber LIKE '" + this.textBoxAccNrDuplicatesFilter.Text + "' AND ";
                SQL += "(S.AccessionNumber IN " +
                    "(SELECT AccessionNumber " +
                    "FROM CollectionSpecimen AS CollectionSpecimen_1 " +
                    "GROUP BY AccessionNumber " +
                    "HAVING (COUNT(CollectionSpecimenID) > 1) AND (AccessionNumber <> N''))) ";
                if (this.comboBoxAccNrDuplicatesProject.SelectedIndex > 0)
                {
                    int ProjectID = 0;
                    if (this.comboBoxAccNrDuplicatesProject.SelectedItem != null)
                    {
                        System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxAccNrDuplicatesProject.SelectedItem;
                        if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                            SQL += " AND P.ProjectID = " + ProjectID.ToString();
                        else return;
                    }
                    else return;
                    //if (!int.TryParse(this.comboBoxAccNrDuplicatesProject.SelectedValue.ToString(), out ProjectID))
                    //    return;
                    //else
                    //    SQL += " AND P.ProjectID = " + ProjectID.ToString();
                }
                SQL += "ORDER BY S.AccessionNumber ";

                if (this._dtAccNrDuplicates == null) this._dtAccNrDuplicates = new DataTable();
                else this._dtAccNrDuplicates.Clear();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(this._dtAccNrDuplicates);
                this.dataGridViewAccNrDuplicates.DataSource = this._dtAccNrDuplicates;
                if (this._dtAccNrDuplicates.Rows.Count > 0)
                {
                    this.labelAccNrDuplicatesResult.Text = this._dtAccNrDuplicates.Rows.Count.ToString() + " duplicates found";
                }
                else
                {
                    this.labelAccNrDuplicatesResult.Text = "No duplicates found";
                }
                if (this.dataGridViewAccNrDuplicates.ColumnCount > 0 && setColumnWidth)
                {
                    this.dataGridViewAccNrDuplicates.Columns[0].Width = (int)this.dataGridViewAccNrDuplicates.Width * 3 / 8;
                    this.dataGridViewAccNrDuplicates.Columns[1].Width = (int)this.dataGridViewAccNrDuplicates.Width * 3 / 8;
                }
                this.dataGridViewAccNrDuplicates.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonAccNrDuplicatesCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewAccNrDuplicates.SelectedCells.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewAccNrDuplicates.Rows[this.dataGridViewAccNrDuplicates.SelectedCells[0].RowIndex];
            bool OK = true;
            try { string test = R.Cells["CollectionSpecimenID"].Value.ToString(); }
            catch { OK = false; }
            if (OK)
            {
                if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
                {
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                else
                    this.DialogResult = DialogResult.Cancel;
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            }
        }

        private void buttonAccNrDuplicatesCheckList_Click(object sender, EventArgs e)
        {
            // #173
            if (this.dataGridViewAccNrDuplicates.DataSource == null ||
                this.dataGridViewAccNrDuplicates.SelectedCells.Count == 0 ||
                this._dtAccNrDuplicates.Rows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("No data were selected");
                return;
            }
            foreach (System.Data.DataRow R in this._dtAccNrDuplicates.Rows)
            {
                this.CollectionSpecimenIDs.Add(int.Parse(R["CollectionSpecimenID"].ToString()));
            }
            this._ShowList = true;
            this.DialogResult = DialogResult.OK;
            this.Close();
        }

        private void buttonAccNrDuplicatesCheckSelected_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewAccNrDuplicates.DataSource == null ||
                this.dataGridViewAccNrDuplicates.SelectedCells.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("No data were selected");
                return;
            }
            foreach (System.Windows.Forms.DataGridViewCell C in this.dataGridViewAccNrDuplicates.SelectedCells)
            {
                this.CollectionSpecimenIDs.Add(int.Parse(this.dataGridViewAccNrDuplicates.Rows[C.RowIndex].Cells[2].Value.ToString()));
            }
            this._ShowList = true;
            this.DialogResult = DialogResult.OK;
            this.Close();
        }

        private void buttonAccNrDuplicatesCompareContent_Click(object sender, EventArgs e)
        {
            if (this._dtAccNrDuplicates == null || this._dtAccNrDuplicates.Rows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }
            try
            {
                System.Collections.Generic.Dictionary<string, Microsoft.Data.SqlClient.SqlDataAdapter> TableAdapter = new Dictionary<string, Microsoft.Data.SqlClient.SqlDataAdapter>();
                string AccessionNumber = this.dataGridViewAccNrDuplicates.Rows[this.dataGridViewAccNrDuplicates.SelectedCells[0].RowIndex].Cells[0].Value.ToString();// this._dtAccNrDuplicates.Rows[this.dataGridViewAccNrDuplicates.SelectedCells[0].RowIndex]["AccessionNumber"].ToString();
                string CollectionSpecimenIDs = "";
                string CollectionEventIDs = "";
                foreach (System.Data.DataRow R in this._dtAccNrDuplicates.Rows)
                {
                    if (R["AccessionNumber"].ToString().ToLower() != AccessionNumber.ToLower())
                        continue;
                    if (CollectionSpecimenIDs.Length > 0) CollectionSpecimenIDs += ", ";
                    CollectionSpecimenIDs += R["CollectionSpecimenID"].ToString();
                    if (R["CollectionEventID"].Equals(System.DBNull.Value))
                        continue;
                    if (CollectionEventIDs.Length > 0) CollectionEventIDs += ", ";
                    CollectionEventIDs += R["CollectionEventID"].ToString();
                }
                System.Collections.Generic.List<string> SpecimenTables = new List<string>();
                SpecimenTables.Add("CollectionAgent");
                SpecimenTables.Add("CollectionProject");
                SpecimenTables.Add("CollectionSpecimen");
                SpecimenTables.Add("CollectionSpecimenImage");
                SpecimenTables.Add("CollectionSpecimenImageProperty");
                SpecimenTables.Add("CollectionSpecimenPart");
                SpecimenTables.Add("CollectionSpecimenProcessing");
                SpecimenTables.Add("CollectionSpecimenRelation");
                SpecimenTables.Add("CollectionSpecimenTransaction");
                SpecimenTables.Add("Identification");
                SpecimenTables.Add("IdentificationUnit");
                SpecimenTables.Add("IdentificationUnitAnalysis");
                SpecimenTables.Add("IdentificationUnitAnalysisMethod");
                SpecimenTables.Add("IdentificationUnitAnalysisMethodParameter");
                SpecimenTables.Add("IdentificationUnitGeoAnalysis");
                SpecimenTables.Add("IdentificationUnitInPart");
                foreach (string s in SpecimenTables)
                {
                    string SQL = "SELECT * FROM " + s + " WHERE CollectionSpecimenID IN (" + CollectionSpecimenIDs + ")";
                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    TableAdapter.Add(s, ad);
                }
                System.Collections.Generic.List<string> EventTables = new List<string>();
                EventTables.Add("CollectionEvent");
                EventTables.Add("CollectionEventImage");
                EventTables.Add("CollectionEventLocalisation");
                EventTables.Add("CollectionEventMethod");
                EventTables.Add("CollectionEventParameterValue");
                EventTables.Add("CollectionEventProperty");
                foreach (string s in EventTables)
                {
                    string SQL = "SELECT * FROM " + s + " WHERE CollectionEventID IN (" + CollectionEventIDs + ")";
                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    TableAdapter.Add(s, ad);
                }
                string Title = "Compare data for AccessionNumber " + AccessionNumber;
                DiversityWorkbench.Forms.FormCompareData f = new DiversityWorkbench.Forms.FormCompareData(Title, TableAdapter);
                f.ShowDialog();
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

#endregion

#region Storage - missing unit in part

        private void buttonPrintCheckMissing_Click(object sender, EventArgs e)
        {
            try
            {
                //string SQL = "SELECT /*CAST(1 AS BIT) AS OK,*/ S.AccessionNumber AS [Accession number], U.LastIdentificationCache AS [Last identification], " +
                //    "PP.StorageLocation AS [Storage location], PP.MaterialCategory as [Material category], " +
                //    "PP.CollectionSpecimenID, U.IdentificationUnitID, PP.SpecimenPartID, 1 AS DisplayOrder " +
                //    "FROM CollectionProject AS P INNER JOIN " +
                //    "CollectionSpecimenPart AS PP ON P.CollectionSpecimenID = PP.CollectionSpecimenID INNER JOIN " +
                //    "IdentificationUnit AS U ON P.CollectionSpecimenID = U.CollectionSpecimenID  INNER JOIN " +
                //    "CollectionSpecimen S ON P.CollectionSpecimenID = S.CollectionSpecimenID" + this.PrintWhereClause;

                string SQL = "SELECT CAST(1 AS BIT) AS OK, S.AccessionNumber AS [Accession number], U.LastIdentificationCache AS [Last identification], PP.StorageLocation AS [Storage location], " +
                    "PP.MaterialCategory AS [Material category], PP.CollectionSpecimenID, U.IdentificationUnitID, PP.SpecimenPartID, 1 AS DisplayOrder " +
                    "FROM CollectionProject AS P INNER JOIN " +
                    "CollectionSpecimenPart AS PP ON P.CollectionSpecimenID = PP.CollectionSpecimenID INNER JOIN " +
                    "IdentificationUnit AS U ON P.CollectionSpecimenID = U.CollectionSpecimenID INNER JOIN " +
                    "CollectionSpecimen AS S ON P.CollectionSpecimenID = S.CollectionSpecimenID LEFT OUTER JOIN " +
                    "IdentificationUnitInPart AS UP ON PP.CollectionSpecimenID = UP.CollectionSpecimenID AND PP.SpecimenPartID = UP.SpecimenPartID AND  " +
                    "U.CollectionSpecimenID = UP.CollectionSpecimenID AND U.IdentificationUnitID = UP.IdentificationUnitID " +
                    this.PrintWhereClause;// +" AND (UP.CollectionSpecimenID IS NULL)";
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                System.Data.DataTable dt = new DataTable();
                ad.Fill(dt);
                this.dataGridViewPrint.DataSource = dt;
                //this.dataGridViewPrint.Columns[4].Visible = false;
                this.dataGridViewPrint.Columns[1].ReadOnly = true;
                this.dataGridViewPrint.Columns[2].ReadOnly = true;
                this.dataGridViewPrint.Columns[3].ReadOnly = true;
                this.dataGridViewPrint.Columns[4].ReadOnly = true;
                this.dataGridViewPrint.Columns[5].Visible = false;
                this.dataGridViewPrint.Columns[6].Visible = false;
                this.dataGridViewPrint.Columns[7].Visible = false;
                this.dataGridViewPrint.Columns[8].Visible = false;
                this.buttonPrintInsertMissing.Enabled = true;
                this.labelPrintMissing.Text = this.dataGridViewPrint.Rows.Count.ToString() + " missing units in parts found";
            }
            catch (System.Exception ex) { }
        }

        private void buttonPrintInsertMissing_Click(object sender, EventArgs e)
        {
            string SQL = "INSERT INTO IdentificationUnitInPart " +
                "(CollectionSpecimenID, IdentificationUnitID, SpecimenPartID, DisplayOrder) " +
                "SELECT PP.CollectionSpecimenID, U.IdentificationUnitID, PP.SpecimenPartID, 1 AS DisplayOrder " +
                "FROM CollectionProject AS P INNER JOIN " +
                "CollectionSpecimenPart AS PP ON P.CollectionSpecimenID = PP.CollectionSpecimenID INNER JOIN " +
                "IdentificationUnit AS U ON P.CollectionSpecimenID = U.CollectionSpecimenID INNER JOIN " +
                "CollectionSpecimen AS S ON P.CollectionSpecimenID = S.CollectionSpecimenID LEFT OUTER JOIN " +
                "IdentificationUnitInPart AS UP ON PP.CollectionSpecimenID = UP.CollectionSpecimenID AND PP.SpecimenPartID = UP.SpecimenPartID AND  " +
                "U.CollectionSpecimenID = UP.CollectionSpecimenID AND U.IdentificationUnitID = UP.IdentificationUnitID " +
                this.PrintWhereClause;// +" AND (UP.CollectionSpecimenID IS NULL)";
                                      //"FROM CollectionProject AS P INNER JOIN " +
                                      //"CollectionSpecimenPart AS PP ON P.CollectionSpecimenID = PP.CollectionSpecimenID INNER JOIN " +
                                      //"IdentificationUnit AS U ON P.CollectionSpecimenID = U.CollectionSpecimenID " + this.PrintWhereClause;
            if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL))
                System.Windows.Forms.MessageBox.Show("Missing data inserted");
            else System.Windows.Forms.MessageBox.Show("Insert failed");
            this.dataGridViewPrint.DataSource = null;
            this.buttonPrintInsertMissing.Enabled = false;
            this.labelPrintMissing.Text = "";
        }

        private string PrintWhereClause
        {
            get
            {
                string WhereClause = "";
                int ProjectID;
                if (this.comboBoxPrintProject.SelectedItem != null)
                {
                    System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxPrintProject.SelectedItem;
                    if (int.TryParse(RP["ProjectID"].ToString(), out ProjectID))
                        WhereClause = " WHERE (P.ProjectID = " + ProjectID.ToString() + ") AND (UP.CollectionSpecimenID IS NULL)";
                    else System.Windows.Forms.MessageBox.Show("Please select a project");
                }
                //if (int.TryParse(this.comboBoxPrintProject.SelectedValue.ToString(), out ProjectID))
                //{
                //    WhereClause = " WHERE (P.ProjectID = " + ProjectID.ToString() + ") AND (UP.CollectionSpecimenID IS NULL)";
                //}
                else System.Windows.Forms.MessageBox.Show("Please select a project");
                if (this.dataGridViewPrint.DataSource != null)
                {
                    try
                    {
                        string IdentificationUnitIDs = "";
                        string SpecimenPartIDs = "";
                        System.Data.DataTable dt = (System.Data.DataTable)this.dataGridViewPrint.DataSource;
                        System.Data.DataRow[] rr = dt.Select("OK = 1");
                        if (rr.Length != 0 && rr.Length < dt.Rows.Count)
                        {
                            foreach (System.Data.DataRow R in rr)
                            {
                                if (IdentificationUnitIDs.Length > 0) IdentificationUnitIDs += ", ";
                                IdentificationUnitIDs += R["IdentificationUnitID"].ToString();
                                if (SpecimenPartIDs.Length > 0) SpecimenPartIDs += ", ";
                                SpecimenPartIDs += R["SpecimenPartID"].ToString();
                            }
                        }
                        if (IdentificationUnitIDs.Length > 0)
                            WhereClause += " AND U.IdentificationUnitID IN (" + IdentificationUnitIDs + ") AND PP.SpecimenPartID IN (" + SpecimenPartIDs + ")";
                    }
                    catch (System.Exception ex) { }
                }
                return WhereClause;
            }
        }

        private void comboBoxPrintProject_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.buttonPrintCheckMissing.Enabled = true;
            this.buttonPrintInsertMissing.Enabled = false;
            this.dataGridViewPrint.DataSource = null;
        }

        private void buttonPrintCheckAll_Click(object sender, EventArgs e)
        {
            // #173
            if (this.dataGridViewPrint.DataSource == null) return;

            try
            {
                System.Data.DataTable dt = (System.Data.DataTable)this.dataGridViewPrint.DataSource;
                foreach (System.Data.DataRow R in dt.Rows)
                {
                    R[0] = true;
                }
            }
            catch (System.Exception ex) { }
        }

        private void buttonPrintCheckNone_Click(object sender, EventArgs e)
        {
            // #173
            if (this.dataGridViewPrint.DataSource == null) return;

            try
            {
                System.Data.DataTable dt = (System.Data.DataTable)this.dataGridViewPrint.DataSource;
                foreach (System.Data.DataRow R in dt.Rows)
                {
                    R[0] = false;
                }
            }
            catch (System.Exception ex) { }
            //foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewPrint.Rows)
            //{
            //    //R
            //}
        }

#endregion

#region Identifications - Bulk insert

        private void setModuleConnectionsForBulkControls()
        {
            // Agents
            DiversityWorkbench.Agent A = new DiversityWorkbench.Agent(DiversityWorkbench.Settings.ServerConnection);
            this.userControlModuleRelatedEntryBulkIdentResponsible.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;

            // Reference
            DiversityWorkbench.Reference R = new DiversityWorkbench.Reference(DiversityWorkbench.Settings.ServerConnection);
            this.userControlModuleRelatedEntryBulkIdentReference.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)R;

            // TaxonNames
            DiversityWorkbench.TaxonName T = new DiversityWorkbench.TaxonName(DiversityWorkbench.Settings.ServerConnection);
            this.userControlModuleRelatedEntryBulkNewIdentification.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)T;
            this.setIdentificationSource();

        }

        private void comboBoxBulkTaxonomicGroup_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (this.comboBoxBulkTaxonomicGroup.Text != "System.Data.DataRowView")
                this.setIdentificationSource();
        }

        private void setIdentificationSource()
        {
            if (this.comboBoxBulkTaxonomicGroup.Text.Length > 0)
            {
                string SQL = "SELECT DISTINCT LTRIM(RTRIM(I.TaxonomicName)) AS TaxonomicName, I.NameURI FROM Identification AS I INNER JOIN " +
                    "CollectionProject AS P ON I.CollectionSpecimenID = P.CollectionSpecimenID INNER JOIN " +
                    "IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID AND I.IdentificationUnitID = U.IdentificationUnitID ";
                if (this.checkBoxBulkOnlyLastIdentification.Checked)
                    SQL += " AND I.TaxonomicName = U.LastIdentificationCache ";
                SQL += "WHERE (U.TaxonomicGroup = '" + this.comboBoxBulkTaxonomicGroup.SelectedValue.ToString() + "') " +
                    "AND (P.ProjectID = " + this.comboBoxBulkProject.SelectedValue.ToString() + ") " +
                    "AND RTRIM(I.TaxonomicName) <> '' " +
                    "ORDER BY LTRIM(RTRIM(I.TaxonomicName)) ";
                System.Data.DataTable dt = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                this.comboBoxBulkOldIdentification.DataSource = dt;
                this.comboBoxBulkOldIdentification.DisplayMember = "TaxonomicName";
                this.comboBoxBulkOldIdentification.ValueMember = "NameURI";
            }
            else
                this.comboBoxBulkOldIdentification.DataSource = null;
        }

        private void buttonBulkCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewBulk.SelectedRows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewBulk.SelectedRows[0];
            bool OK = true;
            try { string test = R.Cells["CollectionSpecimenID"].Value.ToString(); }
            catch { OK = false; }
            if (OK)
            {
                if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
                {
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                else
                    this.DialogResult = DialogResult.Cancel;
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            }
        }

        private void buttonBulkIdentTest_Click(object sender, EventArgs e)
        {
            try
            {
                this.dataGridViewBulk.DataSource = null;
                System.Data.DataTable dt = new DataTable();
                string SQL = this.SqlBulkInsertTaxonNames(false);

                if (SQL.Length > 0)
                {
                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(dt);
                    this.dataGridViewBulk.DataSource = dt;
                    this.buttonBulkInsert.Enabled = true;
                }
                else this.buttonBulkInsert.Enabled = false;
            }
            catch
            {
                this.buttonBulkInsert.Enabled = false;
            }
        }

        private void buttonBulkInsert_Click(object sender, EventArgs e)
        {
            try
            {
                string SQL = this.SqlBulkInsertTaxonNames(true);

                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                con.Open();
                C.ExecuteNonQuery();
                con.Close();
                this.dataGridViewBulk.DataSource = null;
                System.Windows.Forms.MessageBox.Show("Identifications added");

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private string SqlBulkInsertTaxonNames(bool ForInsert)
        {
            string SQL = "";
            if (this.userControlModuleRelatedEntryBulkNewIdentification.textBoxValue.Text.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please enter the new name");
                return SQL;
            }
            try
            {
                string SqlSource = "SELECT ";
                if (ForInsert)
                {
                    SqlSource += " I.CollectionSpecimenID, I.IdentificationUnitID, MAX(M.IdentificationSequence) + 1" +
                    ", '" + this.userControlModuleRelatedEntryBulkNewIdentification.textBoxValue.Text + "' AS TaxonomicName " +
                    ", '" + this.userControlModuleRelatedEntryBulkNewIdentification.labelURI.Text + "' AS NameURI ";
                }
                else
                {
                    SqlSource += "DISTINCT ";
                    if (this.checkBoxBulkIncludeAccNr.Checked)
                        SqlSource += "S.CollectionSpecimenID,  S.AccessionNumber, ";
                    SqlSource += " I.TaxonomicName AS Old_Name, I.NameURI AS Old_URI, " +
                        "'" + this.userControlModuleRelatedEntryBulkNewIdentification.textBoxValue.Text + "' AS New_Name, " +
                        "'" + this.userControlModuleRelatedEntryBulkNewIdentification.labelURI.Text + "' AS New_URI ";
                }
                string SqlInsert = "INSERT INTO Identification " +
                    "( CollectionSpecimenID, IdentificationUnitID, IdentificationSequence, TaxonomicName, NameURI ";
                if (this.comboBoxBulkIdentCategory.Text.Length > 0)
                {
                    SqlSource += ", '" + this.comboBoxBulkIdentCategory.Text + "' AS IdentificationCategory ";
                    SqlInsert += ", IdentificationCategory";
                }
                if (this.textBoxBulkVernacularTerm.Text.Length > 0)
                {
                    SqlSource += ", N'" + this.textBoxBulkVernacularTerm.Text + "' AS VernacularTerm ";
                    SqlInsert += ", VernacularTerm";
                }
                if (this.textBoxBulkIdentNotes.Text.Length > 0)
                {
                    SqlSource += ", '" + this.textBoxBulkIdentNotes.Text + "' AS Notes ";
                    SqlInsert += ", Notes";
                }
                if (this.userControlDatePanelBulkIdentDate.maskedTextBoxDay.Text.Length > 0)
                {
                    SqlSource += ", '" + this.userControlDatePanelBulkIdentDate.maskedTextBoxDay.Text + "' AS IdentificationDay ";
                    SqlInsert += ", IdentificationDay";
                }
                if (this.userControlDatePanelBulkIdentDate.maskedTextBoxMonth.Text.Length > 0)
                {
                    SqlSource += ", '" + this.userControlDatePanelBulkIdentDate.maskedTextBoxMonth.Text + "' AS IdentificationMonth ";
                    SqlInsert += ", IdentificationMonth";
                }
                if (this.userControlDatePanelBulkIdentDate.maskedTextBoxYear.Text.Length > 0)
                {
                    SqlSource += ", '" + this.userControlDatePanelBulkIdentDate.maskedTextBoxYear.Text + "' AS IdentificationYear ";
                    SqlInsert += ", IdentificationYear";
                }
                if (this.userControlDatePanelBulkIdentDate.textBoxSupplement.Text.Length > 0)
                {
                    SqlSource += ", '" + this.userControlDatePanelBulkIdentDate.textBoxSupplement.Text + "' AS IdentificationDateSupplement ";
                    SqlInsert += ", IdentificationDateSupplement";
                }
                if (this.userControlModuleRelatedEntryBulkIdentReference.textBoxValue.Text.Length > 0)
                {
                    SqlSource += ", N'" + this.userControlModuleRelatedEntryBulkIdentReference.textBoxValue.Text + "' AS ReferenceTitle ";
                    SqlInsert += ", ReferenceTitle";
                }
                if (this.userControlModuleRelatedEntryBulkIdentReference.labelURI.Text.Length > 0)
                {
                    SqlSource += ", '" + this.userControlModuleRelatedEntryBulkIdentReference.labelURI.Text + "' AS ReferenceURI ";
                    SqlInsert += ", ReferenceURI";
                }
                if (this.userControlModuleRelatedEntryBulkIdentResponsible.textBoxValue.Text.Length > 0)
                {
                    SqlSource += ", N'" + this.userControlModuleRelatedEntryBulkIdentResponsible.textBoxValue.Text + "' AS ResponsibleName ";
                    SqlInsert += ", ResponsibleName";
                }
                if (this.userControlModuleRelatedEntryBulkIdentResponsible.labelURI.Text.Length > 0)
                {
                    SqlSource += ", '" + this.userControlModuleRelatedEntryBulkIdentResponsible.labelURI.Text + "' AS ResponsibleURI ";
                    SqlInsert += ", ResponsibleAgentURI";
                }
                SqlInsert += ") ";
                SqlSource += "FROM ";
                SqlSource += " Identification AS I INNER JOIN " +
                    "CollectionProject AS P ON I.CollectionSpecimenID = P.CollectionSpecimenID INNER JOIN " +
                    "IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID AND I.IdentificationUnitID = U.IdentificationUnitID  ";
                if (!ForInsert && this.checkBoxBulkIncludeAccNr.Checked)
                    SqlSource += " INNER JOIN CollectionSpecimen AS S ON U.CollectionSpecimenID = S.CollectionSpecimenID ";
                if (ForInsert)
                    SqlSource += "INNER JOIN Identification AS M ON U.CollectionSpecimenID = M.CollectionSpecimenID AND U.IdentificationUnitID = M.IdentificationUnitID ";
                SqlSource += "WHERE (U.TaxonomicGroup = '" + this.comboBoxBulkTaxonomicGroup.SelectedValue.ToString() + "') " +
                    "AND (P.ProjectID = " + this.comboBoxBulkProject.SelectedValue.ToString() + ") " +
                    "AND RTRIM(I.TaxonomicName) <> '' " +
                    "AND (I.TaxonomicName = N'" + this.comboBoxBulkOldIdentification.Text + "') ";
                if (this.checkBoxBulkOnlyLastIdentification.Checked)
                    SqlSource += "and exists (select * from Identification I1  group by I1.CollectionSpecimenID, I1.IdentificationUnitID " +
                        "having U.CollectionSpecimenID = I1.CollectionSpecimenID AND U.IdentificationUnitID = I1.IdentificationUnitID AND " +
                        "I.IdentificationSequence = MAX(I1.IdentificationSequence)) ";
                if (ForInsert)
                {
                    SQL = SqlInsert + " " + SqlSource + " GROUP BY I.CollectionSpecimenID, I.IdentificationUnitID ";
                }
                else
                {
                    SQL = SqlSource + " ORDER BY Old_Name ";
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            return SQL;
        }

        private void checkBoxBulkIncludeAccNr_Click(object sender, EventArgs e)
        {
            if (this.checkBoxBulkIncludeAccNr.Checked) this.buttonBulkCheckDataset.Visible = true;
            else this.buttonBulkCheckDataset.Visible = false;
        }

        private void checkBoxBulkOnlyLastIdentification_CheckedChanged(object sender, EventArgs e)
        {
            this.setIdentificationSource();
        }

#endregion

#region Properties

        public int CollectionSpecimenID { get { return this._CollectionSpecimenID; } }

        public System.Collections.Generic.List<int> CollectionSpecimenIDs
        {
            get
            {
                if (this._CollectionSpecimenIDs == null)
                    this._CollectionSpecimenIDs = new List<int>();
                return _CollectionSpecimenIDs;
            }
            //set { _CollectionSpecimenIDs = value; }
        }

        public bool ShowList
        {
            get { return _ShowList; }
            //set { _ShowList = value; }
        }

        public string ShowListQueryHeader
        {
            get
            {
                if (this._ShowListQueryHeader == null || this._ShowListQueryHeader.Length == 0)
                    return "Duplicates";
                else return this._ShowListQueryHeader;
            }
        }

        public string ShowListQueryDescription
        {
            get
            {
                if (this._ShowListQueryDescription == null || this._ShowListQueryDescription.Length == 0)
                    return "Duplicate accession numbers";
                else return this._ShowListQueryDescription;
            }
        }

#endregion

#region GeoNames

#region Cell styles

        private System.Windows.Forms.DataGridViewCellStyle StyleError
        {
            get
            {
                if (this._StyleError == null)
                {
                    this._StyleError = new DataGridViewCellStyle();
                    this._StyleError.BackColor = System.Drawing.Color.Red;
                    this._StyleError.SelectionBackColor = System.Drawing.Color.Red;
                    this._StyleError.ForeColor = System.Drawing.Color.Black;
                    this._StyleError.SelectionForeColor = System.Drawing.Color.Black;
                    this._StyleError.Tag = "Error";
                }
                return this._StyleError;
            }
        }

        private System.Windows.Forms.DataGridViewCellStyle StyleUpdated
        {
            get
            {
                if (this._StyleUpdated == null)
                {
                    this._StyleUpdated = new DataGridViewCellStyle();
                    this._StyleUpdated.BackColor = System.Drawing.Color.LightGreen;
                    this._StyleUpdated.SelectionBackColor = System.Drawing.Color.LightGreen;
                    this._StyleUpdated.ForeColor = System.Drawing.Color.Black;
                    this._StyleUpdated.SelectionForeColor = System.Drawing.Color.Black;
                    this._StyleUpdated.Tag = "Updated";
                }
                return this._StyleUpdated;
            }
        }

        private System.Windows.Forms.DataGridViewCellStyle StyleBlocked
        {
            get
            {
                if (this._StyleBlocked == null)
                {
                    this._StyleBlocked = new DataGridViewCellStyle();
                    this._StyleBlocked.BackColor = System.Drawing.Color.LightGray;
                    this._StyleBlocked.SelectionBackColor = System.Drawing.Color.LightGray;
                    this._StyleBlocked.ForeColor = System.Drawing.Color.DarkGray;
                    this._StyleBlocked.SelectionForeColor = System.Drawing.Color.DarkGray;
                    this._StyleBlocked.Tag = "Blocked";
                }
                return this._StyleBlocked;
            }
        }

        private System.Windows.Forms.DataGridViewCellStyle StyleOK
        {
            get
            {
                if (this._StyleOK == null)
                {
                    this._StyleOK = new DataGridViewCellStyle();
                    this._StyleOK.BackColor = System.Drawing.SystemColors.Window;
                    this._StyleOK.SelectionBackColor = System.Drawing.SystemColors.Highlight;
                    this._StyleOK.ForeColor = System.Drawing.Color.Black;
                    this._StyleOK.SelectionForeColor = System.Drawing.SystemColors.Window;
                    this._StyleOK.Tag = "";
                }
                return this._StyleOK;
            }
        }

        private System.Windows.Forms.DataGridViewCellStyle StyleNotOK
        {
            get
            {
                if (this._StyleNotOK == null)
                {
                    this._StyleNotOK = new DataGridViewCellStyle();
                    this._StyleNotOK.BackColor = System.Drawing.Color.Yellow;
                    this._StyleNotOK.SelectionBackColor = System.Drawing.Color.Yellow;
                    this._StyleNotOK.ForeColor = System.Drawing.Color.Black;
                    this._StyleNotOK.SelectionForeColor = System.Drawing.Color.Black;
                    this._StyleNotOK.Tag = "";
                }
                return this._StyleNotOK;
            }
        }

#endregion

        private void buttonQueryGeonames_Click(object sender, EventArgs e)
        {
            if (!this.GeoNamesAvailable)
            {
                System.Windows.Forms.MessageBox.Show("Webservice GeoNames currently not available.\r\nPlease try again later");
            }
            else
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                try
                {
                    int NumberOfServiceNotAvaliableEvents = 0;
                    int NumberOfServiceRequests = 0;
                    int ProjectID;

                    if (this.comboBoxSetPlaceProject.SelectedItem != null)
                    {
                        System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxSetPlaceProject.SelectedItem;
                        int.TryParse(RP["ProjectID"].ToString(), out ProjectID);
                    }
                    else
                        int.TryParse(this.comboBoxSetPlaceProject.SelectedValue.ToString(), out ProjectID);

                    string SQL = "DECLARE @OK BIT; SET @OK = 1; SELECT DISTINCT ";
                    if (this.checkBoxSetEventRestriction.Checked)
                    {
                        int max = 0;
                        if (int.TryParse(this.textBoxSetEventRestriction.Text, out max))
                            SQL += "TOP " + max.ToString();
                    }
                    SQL += " E.CollectionEventID, " + /*0*/
                        "@OK AS OK, " + /*1*/
                        "CASE WHEN E.CollectorsEventNumber IS NULL THEN '' ELSE 'Nr: ' " +
                        "+ E.CollectorsEventNumber END + ' ' + CASE WHEN E.CollectionDay IS NULL " +
                        "THEN '' ELSE CAST(E.CollectionDay AS varchar) END + '/' + CASE WHEN E.CollectionMonth IS NULL THEN '' " +
                        "ELSE CAST(E.CollectionMonth AS varchar) END + '/' + CASE WHEN E.CollectionYear IS NULL THEN '' " +
                        "ELSE CAST(E.CollectionYear AS varchar) END + ' ' + CASE WHEN E.LocalityDescription IS NULL " +
                        "THEN '' ELSE '- ' + E.LocalityDescription END AS [Collection event], " + /*2*/
                        "L.AverageLatitudeCache AS Latitude, " + /*3*/
                        "L.AverageLongitudeCache AS Longitude, " + /*4*/
                        "E.CountryCache AS [Current country], " + /*5*/
                        "'' AS [New country], " + /*6*/
                        "'' AS [Current altitude], " + /*7*/
                        "'' AS [New altitude], " + /*8*/
                        "'' AS [Current place], " + /*9*/
                        "'' AS [New place], " + /*10*/
                        "'' AS Distance, " + /*11*/
                        "'' AS Direction, " + /*12*/
                        "'' AS Accuracy, " + /*13*/
                        "'' AS Notes, " + /*14*/
                        "'' AS Error " + /*15*/
                        "FROM         CollectionEvent AS E INNER JOIN " +
                        "CollectionSpecimen AS S ON E.CollectionEventID = S.CollectionEventID INNER JOIN " +
                        "CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID INNER JOIN " +
                        "CollectionSpecimenID_UserAvailable AS UA ON S.CollectionSpecimenID = UA.CollectionSpecimenID INNER JOIN " +
                        "CollectionEventLocalisation AS L ON E.CollectionEventID = L.CollectionEventID " +
                        "WHERE     (P.ProjectID = " + ProjectID.ToString() + ") AND (L.LocalisationSystemID = 8) " +
                        "AND (NOT (L.AverageLatitudeCache IS NULL)) " +
                        "AND (NOT (L.AverageLongitudeCache IS NULL))";
                    this._dtEvents = new DataTable();
                    this._dtEvents.Clear();

                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    ad.Fill(this._dtEvents);
                    if (this._dtEvents.Rows.Count == 0)
                    {
                        System.Windows.Forms.MessageBox.Show("Nothing found");
                        return;
                    }
                    this._dtCountry = this._dtEvents.Copy();
                    this._dtAltitude = this._dtEvents.Copy();
                    this._dtPlace = this._dtEvents.Copy();
                    this.progressBarSetCountry.Maximum = this._dtEvents.Rows.Count;

                    this.progressBarSetCountry.Minimum = 0;
                    this.progressBarSetCountry.Value = 0;
                    foreach (System.Data.DataRow R in this._dtEvents.Rows)
                    {
                        if (!setLocality(R))
                            NumberOfServiceNotAvaliableEvents++;
                        NumberOfServiceRequests++;
                        if (this.progressBarSetCountry.Value < this.progressBarSetCountry.Maximum)
                            this.progressBarSetCountry.Value++;
                    }
                    this.progressBarSetCountry.Value = 0;

                    try
                    {
                        this.dataGridViewSetCountry.DataSource = this._dtCountry;
                        this.dataGridViewSetCountry.Columns[0].Visible = false; //CollectionEventID
                        this.dataGridViewSetCountry.Columns[3].Visible = false; //Latitude
                        this.dataGridViewSetCountry.Columns[4].Visible = false;
                        this.dataGridViewSetCountry.Columns[7].Visible = false;
                        this.dataGridViewSetCountry.Columns[8].Visible = false;
                        this.dataGridViewSetCountry.Columns[9].Visible = false;
                        this.dataGridViewSetCountry.Columns[10].Visible = false;
                        this.dataGridViewSetCountry.Columns[11].Visible = false;
                        this.dataGridViewSetCountry.Columns[12].Visible = false;
                        this.dataGridViewSetCountry.Columns[13].Visible = false;
                        this.dataGridViewSetCountry.Columns[14].Visible = false;
                        this.dataGridViewSetCountry.Columns[15].Visible = false;
                    }
                    catch { }

                    for (int i = 0; i < this.dataGridViewSetCountry.Columns.Count; i++)
                        if (i != 1) this.dataGridViewSetCountry.Columns[i].ReadOnly = true;

                    try
                    {
                        this.dataGridViewSetPlace.DataSource = this._dtPlace;
                        this.dataGridViewSetPlace.Columns[0].Visible = false; //CollectionEventID
                        this.dataGridViewSetPlace.Columns[0].ReadOnly = true; //CollectionEventID
                        this.dataGridViewSetPlace.Columns[2].ReadOnly = true; //LocalityDescription
                        this.dataGridViewSetPlace.Columns[3].Visible = false; //Latitude
                        this.dataGridViewSetPlace.Columns[4].Visible = false;
                        this.dataGridViewSetPlace.Columns[5].Visible = false;
                        this.dataGridViewSetPlace.Columns[6].Visible = false;
                        this.dataGridViewSetPlace.Columns[7].Visible = false;
                        this.dataGridViewSetPlace.Columns[8].Visible = false;
                        this.dataGridViewSetPlace.Columns[15].Visible = false;
                    }
                    catch { }

                    for (int i = 0; i < this.dataGridViewSetPlace.Columns.Count; i++)
                        if (i != 1) this.dataGridViewSetPlace.Columns[i].ReadOnly = true;

                    try
                    {
                        this.dataGridViewSetAltitude.DataSource = this._dtAltitude;
                        this.dataGridViewSetAltitude.Columns[0].Visible = false; //CollectionEventID
                        this.dataGridViewSetAltitude.Columns[3].Visible = false; //Latitude
                        this.dataGridViewSetAltitude.Columns[4].Visible = false;
                        this.dataGridViewSetAltitude.Columns[5].Visible = false;
                        this.dataGridViewSetAltitude.Columns[6].Visible = false;
                        this.dataGridViewSetAltitude.Columns[9].Visible = false;
                        this.dataGridViewSetAltitude.Columns[10].Visible = false;
                        this.dataGridViewSetAltitude.Columns[11].Visible = false;
                        this.dataGridViewSetAltitude.Columns[12].Visible = false;
                        this.dataGridViewSetAltitude.Columns[15].Visible = false;
                    }
                    catch { }

                    for (int i = 0; i < this.dataGridViewSetAltitude.Columns.Count; i++)
                        if (i != 1) this.dataGridViewSetAltitude.Columns[i].ReadOnly = true;

                    if (NumberOfServiceNotAvaliableEvents > 0)
                    {
                        System.Windows.Forms.MessageBox.Show("The webservice GeoNames could not be reached " + NumberOfServiceNotAvaliableEvents.ToString() + " of " + NumberOfServiceRequests.ToString() + " times.\r\nPlease repeat the query later");
                        this.dataGridViewSetCountry.Columns[15].Visible = true;
                        this.dataGridViewSetPlace.Columns[15].Visible = true;
                        this.dataGridViewSetAltitude.Columns[15].Visible = true;
                    }

                    System.Data.DataRow[] rr = this._dtCountry.Select("Error <> ''");
                    if (rr.Length > 0)
                        this.dataGridViewSetCountry.Columns[15].Visible = true;

                    System.Data.DataRow[] rrPlace = this._dtPlace.Select("Error <> ''");
                    if (rrPlace.Length > 0)
                        this.dataGridViewSetPlace.Columns[15].Visible = true;

                    System.Data.DataRow[] rrAlt = this._dtPlace.Select("Error <> ''");
                    if (rrAlt.Length > 0)
                        this.dataGridViewSetAltitude.Columns[15].Visible = true;
                }
                catch (System.Exception ex)
                {
                    System.Windows.Forms.MessageBox.Show(ex.Message);
                }
                finally
                {
                    this.Cursor = System.Windows.Forms.Cursors.Default;
                }
                this.dataGridViewSetAltitude.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                this.dataGridViewSetAltitude.Columns[2].Width = 500;
                this.dataGridViewSetCountry.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                this.dataGridViewSetCountry.Columns[2].Width = 500;
                this.dataGridViewSetPlace.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                this.dataGridViewSetPlace.Columns[2].Width = 500;

                this.setGeoNamesColorCodeAndOK(this.dataGridViewSetCountry, 1, 5, 6, 15, this.radioButtonSetCountryMissing.Checked, this.radioButtonSetCountryDifferent.Checked);
                //this.setCountryColorCodeAndOK();
                this.setGeoNamesColorCodeAndOK(this.dataGridViewSetPlace, 1, 9, 10, 15, this.radioButtonSetPlaceMissing.Checked, this.radioButtonSetPlaceDifferent.Checked);
                //this.setPlaceColorCodeAndOK();
                this.setGeoNamesColorCodeAndOK(this.dataGridViewSetAltitude, 1, 7, 8, 15, this.radioButtonSetAltitudeMissing.Checked, this.radioButtonSetAltitudeDifferent.Checked);
                //this.setAltitudeColorCode();
            }
        }

        /// <summary>
        /// Set the locality for a datarow
        /// </summary>
        /// <param name="R">The data row for which the locality should be set</param>
        /// <returns>If the webserice for retrieval of the data is available</returns>
        private bool setLocality(System.Data.DataRow R)
        {
            bool ServiceAvailable = true;
            try
            {
                double Latitude;
                double.TryParse(R["Latitude"].ToString(), out Latitude);
                double Longitude;
                double.TryParse(R["Longitude"].ToString(), out Longitude);
                int EventID;
                int.TryParse(R["CollectionEventID"].ToString(), out EventID);
                System.Collections.Generic.Dictionary<DiversityWorkbench.GeoFunctions.GeoInfo, string> GeoInfos = DiversityWorkbench.GeoFunctions.getGeoInfos(Latitude, Longitude, ref ServiceAvailable);
                this.setCountry(GeoInfos, EventID);
                this.setPlace(GeoInfos, EventID, Latitude, Longitude);
                this.setAltitude(GeoInfos, EventID);
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
            return ServiceAvailable;
        }

        private bool GeoNamesAvailable
        {
            get
            {
                try
                {
                    return DiversityWorkbench.GeoFunctions.GeoNamesAvailable;
                }
                catch { return false; }
                return false;
            }
        }

        private void linkLabelGeoNames_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            DiversityWorkbench.Forms.FormWebBrowser W = new DiversityWorkbench.Forms.FormWebBrowser(this.linkLabelGeoNames.Text);
            W.ShowDialog();
        }

#region Country

        private void setCountry(System.Collections.Generic.Dictionary<DiversityWorkbench.GeoFunctions.GeoInfo,
            string> GeoInfos, int CollectionEventID)
        {
            try
            {
                System.Data.DataRow[] rrCountry = this._dtCountry.Select("CollectionEventID = " + CollectionEventID.ToString());
                if (rrCountry.Length > 0)
                {
                    if (GeoInfos.Count > 0)
                    {
                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Country))
                        {
                            string Country = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Country];
                            rrCountry[0][6] = Country;
                        }
                        else
                        {
                            rrCountry[0]["Error"] = "Country not available";
                            if (this.dataGridViewSetCountry.Columns.Count > 14)
                                this.dataGridViewSetCountry.Columns[15].Visible = true;
                        }
                    }
                    else
                    {
                        rrCountry[0]["Error"] = "Webservice not available";
                        if (this.dataGridViewSetCountry.Columns.Count > 14)
                            this.dataGridViewSetCountry.Columns[15].Visible = true;
                    }
                }
                else
                {
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private void radioButtonSetCountryMissing_CheckedChanged(object sender, EventArgs e)
        {
            this.setGeoNamesColorCodeAndOK(this.dataGridViewSetCountry, 1, 5, 6, 15, this.radioButtonSetCountryMissing.Checked, this.radioButtonSetCountryDifferent.Checked);
        }

        private void radioButtonSetCountryDifferent_CheckedChanged(object sender, EventArgs e)
        {
            this.setGeoNamesColorCodeAndOK(this.dataGridViewSetCountry, 1, 5, 6, 15, this.radioButtonSetCountryMissing.Checked, this.radioButtonSetCountryDifferent.Checked);
        }

        private void buttonSetPlaceCheckDataset_Click(object sender, EventArgs e)
        {
            this.GeoNamesCheckDataset(this.dataGridViewSetCountry);
        }

        private void buttonSetCoutry_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            try
            {
                foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSetCountry.Rows)
                {
                    bool OK = false;
                    bool.TryParse(R.Cells[1].Value.ToString(), out OK);
                    if (!OK)
                        continue;
                    int CollectionEventID = 0;
                    if (int.TryParse(R.Cells[0].Value.ToString(), out CollectionEventID))
                    {
                        string SQL = "UPDATE CollectionEvent SET CountryCache = '" + R.Cells[6].Value.ToString() + "' " +
                            "FROM CollectionEvent " +
                            "WHERE CollectionEventID = " + CollectionEventID.ToString();
                        if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL))
                        {
                            foreach (System.Windows.Forms.DataGridViewCell Cell in R.Cells)
                                Cell.Style = this.StyleUpdated;
                        }
                        R.Cells[5].Value = R.Cells[6].Value;
                    }
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
        }

        private void dataGridViewSetCountry_CellValidated(object sender, DataGridViewCellEventArgs e)
        {
            try
            {
                if (this.dataGridViewSetCountry.SelectedCells.Count > 0
                    && this.dataGridViewSetCountry.SelectedCells[0].ColumnIndex == 1)
                {
                    bool OK = true;
                    bool.TryParse(this.dataGridViewSetCountry.Rows[this.dataGridViewSetCountry.SelectedCells[0].RowIndex].Cells[1].Value.ToString(), out OK);
                    if (!OK)
                    {
                        foreach (System.Windows.Forms.DataGridViewCell Cell in this.dataGridViewSetCountry.Rows[this.dataGridViewSetCountry.SelectedCells[0].RowIndex].Cells)
                            Cell.Style = this.StyleNotOK;
                    }
                    else
                    {
                        foreach (System.Windows.Forms.DataGridViewCell Cell in this.dataGridViewSetCountry.Rows[this.dataGridViewSetCountry.SelectedCells[0].RowIndex].Cells)
                            Cell.Style = this.StyleOK;
                    }
                }
            }
            catch { }
        }

        private void dataGridViewSetCountry_Sorted(object sender, EventArgs e)
        {
            this.setGeoNamesColorCodeAndOK(this.dataGridViewSetCountry, 1, 5, 6, 15, this.radioButtonSetCountryMissing.Checked, this.radioButtonSetCountryDifferent.Checked);
        }

        private void buttonCountrySetColumnWidth_Click(object sender, EventArgs e)
        {
            this.dataGridViewSetCountry.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
        }

#endregion

#region Place

        private void setPlace(
            System.Collections.Generic.Dictionary<DiversityWorkbench.GeoFunctions.GeoInfo, string> GeoInfos,
            int CollectionEventID,
            double Latitude,
            double Longitude)
        {
            try
            {
                string SQL = "SELECT Location1 FROM CollectionEventLocalisation WHERE LocalisationSystemID = 7 " +
                    " AND CollectionEventID = " + CollectionEventID.ToString();
                string CurrentPlace = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL, true);

                System.Data.DataRow[] rr = this._dtPlace.Select("CollectionEventID = " + CollectionEventID.ToString());
                if (GeoInfos.Count > 0)
                {
                    string Distance = "";
                    string Direction = "";
                    string Accuracy = "";
                    string Place = "";
                    string Notes = "";
                    if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.PlaceName))
                    {
                        Place = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.PlaceName];
                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.City)
                            && GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.PlaceName)
                            && GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.City] != GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.PlaceName])
                            Place += ", " + GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.City];
                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.CountrySubdivision))
                            Place += ", " + GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.CountrySubdivision];
                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Country))
                            Place += ", " + GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Country];
                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Source))
                            Notes = "Source: " + GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Source];
                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Distance))
                        {
                            Accuracy = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Distance];
                            Distance = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Distance];
                        }
                        if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Direction))
                            Direction = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Direction];

                        rr[0]["Current place"] = CurrentPlace;
                        rr[0]["New place"] = Place;
                        rr[0]["Distance"] = Distance;
                        rr[0]["Direction"] = Direction;
                        rr[0]["Accuracy"] = Accuracy;
                        rr[0]["Notes"] = Notes;
                    }
                    else
                    {
                        rr[0][15] = "Place not available";
                        if (this.dataGridViewSetPlace.Columns.Count > 13)
                            this.dataGridViewSetPlace.Columns[15].Visible = true;
                    }
                }
                else
                {
                    rr[0][15] = "Webservice not available";
                    if (this.dataGridViewSetPlace.Columns.Count > 13)
                        this.dataGridViewSetPlace.Columns[15].Visible = true;
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private void buttonSetPlaceCheckDatasetPlace_Click(object sender, EventArgs e)
        {
            this.GeoNamesCheckDataset(this.dataGridViewSetPlace);
        }

        private void radioButtonSetPlaceMissing_CheckedChanged(object sender, EventArgs e)
        {
            this.setGeoNamesColorCodeAndOK(this.dataGridViewSetPlace, 1, 9, 10, 15, this.radioButtonSetPlaceMissing.Checked, this.radioButtonSetPlaceDifferent.Checked);
        }

        private void radioButtonSetPlaceDifferent_CheckedChanged(object sender, EventArgs e)
        {
            this.setGeoNamesColorCodeAndOK(this.dataGridViewSetPlace, 1, 9, 10, 15, this.radioButtonSetPlaceMissing.Checked, this.radioButtonSetPlaceDifferent.Checked);
        }

        private void buttonInsertPlace_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            try
            {
                foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSetPlace.Rows)
                {
                    if (R.Cells[0].Style != this._StyleOK)
                        continue;
                    int CollectionEventID = 0;
                    if (int.TryParse(R.Cells[0].Value.ToString(), out CollectionEventID))
                    {
                        string Place = R.Cells[10].Value.ToString();
                        string Distance = R.Cells[11].Value.ToString();
                        string Direction = R.Cells[12].Value.ToString();
                        string Accuracy = R.Cells[13].Value.ToString();
                        string Notes = R.Cells[14].Value.ToString();
                        string Latitude = R.Cells[3].Value.ToString();
                        string Longitude = R.Cells[4].Value.ToString();
                        string SQL = "IF (SELECT COUNT(*) FROM [CollectionEventLocalisation] " +
                            " WHERE [CollectionEventID] = " + CollectionEventID.ToString() +
                            " AND [LocalisationSystemID] = 7) > 0 " +
                             "BEGIN " +
                            " UPDATE [CollectionEventLocalisation] SET [Location1] = '" + Place + "', " +
                            " [Location2] = NULL, " +
                            " [DistanceToLocation] = '" + Distance + " ', " +
                            " [DirectionToLocation] = '" + Direction + "', " +
                            " [LocationAccuracy] = '" + Accuracy + " ', " +
                            " [LocationNotes] = '" + Notes + " ', " +
                            " [AverageLatitudeCache] = " + Latitude.Replace(",", ".") + " , " +
                            " [AverageLongitudeCache] = " + Longitude.Replace(",", ".") +
                            " FROM  [CollectionEventLocalisation] WHERE [CollectionEventID] = " + CollectionEventID.ToString() +
                            " AND [LocalisationSystemID] = 7 " +
                            " END " +
                            " ELSE " +
                            " BEGIN " +
                            " INSERT INTO [CollectionEventLocalisation] ([CollectionEventID], [LocalisationSystemID] , " +
                            " [Location1],[LocationAccuracy],[LocationNotes],[DistanceToLocation]," +
                            " [DirectionToLocation],[AverageLatitudeCache],[AverageLongitudeCache]) " +
                            " VALUES (" + CollectionEventID.ToString() + ", 7, '" + Place + "', " +
                            "'" + Accuracy + "','" + Notes + "','" + Distance + "','" + Direction + "', " +
                            Latitude.Replace(",", ".") + "," + Longitude.Replace(",", ".") + ") " +
                            " END";
                        if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL))
                        {
                            foreach (System.Windows.Forms.DataGridViewCell Cell in R.Cells)
                                Cell.Style = this.StyleUpdated;
                        }
                        R.Cells[9].Value = R.Cells[10].Value;
                    }
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
        }

        private void dataGridViewSetPlace_CellValidated(object sender, DataGridViewCellEventArgs e)
        {
            try
            {
                if (this.dataGridViewSetPlace.SelectedCells.Count > 0
                    && this.dataGridViewSetPlace.SelectedCells[0].ColumnIndex == 1)
                {
                    bool OK = true;
                    bool.TryParse(this.dataGridViewSetPlace.Rows[this.dataGridViewSetPlace.SelectedCells[0].RowIndex].Cells[1].Value.ToString(), out OK);
                    if (!OK)
                    {
                        foreach (System.Windows.Forms.DataGridViewCell Cell in this.dataGridViewSetPlace.Rows[this.dataGridViewSetPlace.SelectedCells[0].RowIndex].Cells)
                            Cell.Style = this.StyleNotOK;
                    }
                    else
                    {
                        foreach (System.Windows.Forms.DataGridViewCell Cell in this.dataGridViewSetPlace.Rows[this.dataGridViewSetPlace.SelectedCells[0].RowIndex].Cells)
                            Cell.Style = this.StyleOK;
                    }
                }
            }
            catch { }
        }

        private void dataGridViewSetPlace_Sorted(object sender, EventArgs e)
        {
            this.setGeoNamesColorCodeAndOK(this.dataGridViewSetPlace, 1, 9, 10, 15, this.radioButtonSetPlaceMissing.Checked, this.radioButtonSetPlaceDifferent.Checked);
        }

        private void buttonPlaceSetColumnWidth_Click(object sender, EventArgs e)
        {
            this.dataGridViewSetPlace.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
        }

#endregion

#region Altitude

        private void setAltitude(
            System.Collections.Generic.Dictionary<DiversityWorkbench.GeoFunctions.GeoInfo, string> GeoInfos,
            int CollectionEventID)
        {
            try
            {
                string SQL = "SELECT CASE WHEN [Location1] = CAST([AverageAltitudeCache] AS varchar) " +
                    "THEN [Location1] ELSE [Location1] + CASE WHEN [Location2] IS NULL THEN '' ELSE ' - ' + [Location2] END END + " +
                    "CASE WHEN [LocationAccuracy] IS NULL THEN '' ELSE ' +- ' + [LocationAccuracy] END AS Altitude " +
                    "FROM CollectionEventLocalisation " +
                    "WHERE LocalisationSystemID = 4 AND CollectionEventID = " + CollectionEventID.ToString();
                string CurrentAltitude = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL, true);

                System.Data.DataRow[] rr = this._dtAltitude.Select("CollectionEventID = " + CollectionEventID.ToString());
                if (GeoInfos.Count > 0)
                {
                    string Altitude = "";
                    string Notes = "";
                    double Alt = 0.0;
                    if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.Altitude)
                        && double.TryParse(GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Altitude], out Alt))
                        Altitude = GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.Altitude];
                    else
                    {
                        rr[0][15] = "Altitude not available";
                        if (this.dataGridViewSetAltitude.Columns.Count > 13)
                            this.dataGridViewSetAltitude.Columns[15].Visible = true;
                    }
                    if (GeoInfos.ContainsKey(DiversityWorkbench.GeoFunctions.GeoInfo.AltitudeSource))
                        Notes = "Source: " + GeoInfos[DiversityWorkbench.GeoFunctions.GeoInfo.AltitudeSource];

                    rr[0]["Current altitude"] = CurrentAltitude;
                    rr[0]["New altitude"] = Altitude;
                    rr[0]["Notes"] = Notes;
                }
                else
                {
                    rr[0]["Error"] = "Webservice not available";
                    if (this.dataGridViewSetAltitude.Columns.Count > 13)
                        this.dataGridViewSetAltitude.Columns[15].Visible = true;
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        //private void setAltitudeColorCode()
        //{
        //    try
        //    {
        //        foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSetAltitude.Rows)
        //        {
        //            if (R.Cells[0].Style == this._StyleError
        //                || R.Cells[0].Style == this.StyleUpdated)
        //                continue;
        //            bool OK = true;
        //            bool.TryParse(R.Cells[1].Value.ToString(), out OK);
        //            if (R.Cells[15].Value != null && R.Cells[15].Value.ToString().Length > 0)
        //            {
        //                foreach (System.Windows.Forms.DataGridViewCell Cell in R.Cells)
        //                    Cell.Style = this.StyleError;
        //            }
        //            else if (!OK)
        //            {
        //                foreach (System.Windows.Forms.DataGridViewCell Cell in R.Cells)
        //                    Cell.Style = this.StyleNotOK;
        //            }
        //            else if (this.radioButtonSetAltitudeDifferent.Checked)
        //            {
        //                if (((R.Cells[7].Value == null || R.Cells[7].Value.ToString() == "")
        //                    && (R.Cells[8].Value == null || R.Cells[8].Value.ToString() == ""))
        //                    || R.Cells[7].Value.ToString() == R.Cells[8].Value.ToString())
        //                {
        //                    foreach (System.Windows.Forms.DataGridViewCell Cell in R.Cells)
        //                        Cell.Style = this.StyleBlocked;
        //                }
        //                else
        //                {
        //                    foreach (System.Windows.Forms.DataGridViewCell Cell in R.Cells)
        //                        Cell.Style = this.StyleOK;
        //                }
        //            }
        //            else if (this.radioButtonSetAltitudeMissing.Checked)
        //            {
        //                if ((R.Cells[7].Value == null || R.Cells[7].Value.ToString() == "")
        //                    && (R.Cells[8].Value != null && R.Cells[8].Value.ToString().Length > 0))
        //                {
        //                    foreach (System.Windows.Forms.DataGridViewCell Cell in R.Cells)
        //                        Cell.Style = this.StyleOK;
        //                }
        //                else
        //                {
        //                    foreach (System.Windows.Forms.DataGridViewCell Cell in R.Cells)
        //                        Cell.Style = this.StyleBlocked;
        //                }
        //            }
        //            else if (this.radioButtonSetAltitudeAll.Checked)
        //            {
        //                foreach (System.Windows.Forms.DataGridViewCell Cell in R.Cells)
        //                    Cell.Style = this.StyleOK;
        //            }
        //        }
        //    }
        //    catch (System.Exception ex)
        //    {
        //        System.Windows.Forms.MessageBox.Show(ex.Message);
        //    }
        //    //this.dataGridViewSetAltitude.AutoResizeColumns();
        //    //this.dataGridViewSetAltitude.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
        //}

        private void buttonSetAltitide_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            try
            {
                foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewSetAltitude.Rows)
                {
                    if (R.Cells[0].Style != this._StyleOK)
                        continue;
                    int CollectionEventID = 0;
                    if (int.TryParse(R.Cells[0].Value.ToString(), out CollectionEventID))
                    {
                        string Altitude = R.Cells[8].Value.ToString();
                        double Alt = 0.0;
                        double.TryParse(R.Cells[8].Value.ToString(), out Alt);
                        string Notes = R.Cells[14].Value.ToString();
                        string SQL = "IF (SELECT COUNT(*) FROM [CollectionEventLocalisation] " +
                            " WHERE [CollectionEventID] = " + CollectionEventID.ToString() +
                            " AND [LocalisationSystemID] = 4) > 0 " +
                             "BEGIN " +
                            " UPDATE [CollectionEventLocalisation] SET [Location1] = '" + Altitude + "', " +
                            " [Location2] = NULL, " +
                            " [LocationNotes] = '" + Notes + "', " +
                            " [AverageAltitudeCache] = " + Altitude +
                            " FROM  [CollectionEventLocalisation] WHERE [CollectionEventID] = " + CollectionEventID.ToString() +
                            " AND [LocalisationSystemID] = 4 " +
                            " END " +
                            " ELSE " +
                            " BEGIN " +
                            " INSERT INTO [CollectionEventLocalisation] ([CollectionEventID], [LocalisationSystemID] , " +
                            " [Location1],[LocationNotes],[AverageAltitudeCache]) " +
                            " VALUES (" + CollectionEventID.ToString() + ", 4, '" + Altitude + "', " +
                            "'" + Notes + "'," + Alt + ") " +
                            " END";
                        if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL))
                        {
                            foreach (System.Windows.Forms.DataGridViewCell Cell in R.Cells)
                                Cell.Style = this.StyleUpdated;
                        }
                        R.Cells[7].Value = R.Cells[8].Value;
                    }
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
        }

        private void buttonSetPlaceCheckDatasetAltitude_Click(object sender, EventArgs e)
        {
            this.GeoNamesCheckDataset(this.dataGridViewSetAltitude);
            //try
            //{
            //    int CollectionEventID = 0;
            //    if (this.dataGridViewSetAltitude.SelectedRows.Count == 0)
            //    {
            //        System.Windows.Forms.MessageBox.Show("Please select a row");
            //        return;
            //    }
            //    //if (this.dataGridViewSetAltitude.SelectedRows[0].Cells[0].Style != this.StyleOK)
            //    //{
            //    //    System.Windows.Forms.MessageBox.Show("Please select a valid row");
            //    //    return;
            //    //}
            //    if (int.TryParse(this.dataGridViewSetAltitude.SelectedRows[0].Cells[0].Value.ToString(), out CollectionEventID))
            //    {
            //        string SQL = "SELECT MIN(CollectionSpecimenID) AS ID " +
            //            "FROM CollectionSpecimen " +
            //            "WHERE CollectionEventID = " + CollectionEventID.ToString();
            //        if (int.TryParse(DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL), out this._CollectionSpecimenID))
            //        {
            //            this.DialogResult = DialogResult.OK;
            //            this.Close();
            //        }
            //    }
            //}
            //catch (System.Exception ex)
            //{
            //    System.Windows.Forms.MessageBox.Show(ex.Message);
            //}
        }

        private void radioButtonSetAltitudeMissing_CheckedChanged(object sender, EventArgs e)
        {
            this.setGeoNamesColorCodeAndOK(this.dataGridViewSetAltitude, 1, 7, 8, 15, this.radioButtonSetAltitudeMissing.Checked, this.radioButtonSetAltitudeDifferent.Checked);
            //this.setAltitudeColorCode();
        }

        private void radioButtonSetAltitudeDifferent_CheckedChanged(object sender, EventArgs e)
        {
            this.setGeoNamesColorCodeAndOK(this.dataGridViewSetAltitude, 1, 7, 8, 15, this.radioButtonSetAltitudeMissing.Checked, this.radioButtonSetAltitudeDifferent.Checked);
            //this.setAltitudeColorCode();
        }

        private void dataGridViewSetAltitude_CellValidated(object sender, DataGridViewCellEventArgs e)
        {
            try
            {
                if (this.dataGridViewSetAltitude.SelectedCells.Count > 0
                    && this.dataGridViewSetAltitude.SelectedCells[0].ColumnIndex == 1)
                {
                    bool OK = true;
                    bool.TryParse(this.dataGridViewSetAltitude.Rows[this.dataGridViewSetAltitude.SelectedCells[0].RowIndex].Cells[1].Value.ToString(), out OK);
                    if (!OK)
                    {
                        foreach (System.Windows.Forms.DataGridViewCell Cell in this.dataGridViewSetAltitude.Rows[this.dataGridViewSetAltitude.SelectedCells[0].RowIndex].Cells)
                            Cell.Style = this.StyleNotOK;
                    }
                    else
                    {
                        foreach (System.Windows.Forms.DataGridViewCell Cell in this.dataGridViewSetAltitude.Rows[this.dataGridViewSetAltitude.SelectedCells[0].RowIndex].Cells)
                            Cell.Style = this.StyleOK;
                    }
                }
            }
            catch { }
        }

        private void dataGridViewSetAltitude_Sorted(object sender, EventArgs e)
        {
            this.setGeoNamesColorCodeAndOK(this.dataGridViewSetAltitude, 1, 7, 8, 15, this.radioButtonSetAltitudeMissing.Checked, this.radioButtonSetAltitudeDifferent.Checked);
            //this.setAltitudeColorCode();
        }


        private void buttonAltitudeSetColumnWidth_Click(object sender, EventArgs e)
        {
            this.dataGridViewSetAltitude.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
        }

#endregion

#region Common

        private void setGeoNamesColorCodeAndOK(
            System.Windows.Forms.DataGridView Grid,
            int ColumnOK,
            int ColumnPresentValue,
            int ColumnNewValue,
            int ColumnError,
            bool IfMissing,
            bool IfDifferent)
        {
            try
            {
                foreach (System.Windows.Forms.DataGridViewRow R in Grid.Rows)
                {
                    // no changes for lines with error or already updated
                    if (R.Cells[0].Style == this._StyleError
                        || R.Cells[0].Style == this.StyleUpdated
                        || R.Cells[0].Style == this.StyleBlocked)
                        continue;

                    // getting the current setting if the row should be updated
                    bool OK = true;
                    bool.TryParse(R.Cells[ColumnOK].Value.ToString(), out OK);

                    // new OK
                    bool newOK = true;
                    // the new stye for the line
                    System.Windows.Forms.DataGridViewCellStyle NewStyle = this.StyleOK;

                    if (R.Cells[ColumnError].Value != null && R.Cells[ColumnError].Value.ToString().Length > 0) // Error
                    {
                        NewStyle = this.StyleError;
                        newOK = false;
                    }
                    else
                    {
                        // for testing
                        string Old = R.Cells[ColumnPresentValue].Value.ToString();
                        string New = R.Cells[ColumnNewValue].Value.ToString();
                        // equal values - no update needed
                        if (R.Cells[ColumnNewValue].Value.ToString() == R.Cells[ColumnPresentValue].Value.ToString()
                            && R.Cells[ColumnPresentValue].Value.ToString().Length > 0)
                        {
                            NewStyle = this.StyleBlocked;
                            newOK = false;
                        }
                        else
                        {
                            // no new values found
                            if (R.Cells[ColumnNewValue].Value.ToString().Length == 0)
                            {
                                NewStyle = this.StyleBlocked;
                                newOK = false;
                            }
                            else // values found
                            {
                                if (IfDifferent) // only if values are different
                                {
                                    if (R.Cells[ColumnNewValue].Value.ToString() != R.Cells[5].Value.ToString()
                                        && R.Cells[ColumnPresentValue].Value.ToString().Length > 0
                                        && R.Cells[ColumnNewValue].Value.ToString().Length > 0)
                                    {
                                        NewStyle = this.StyleOK;
                                        newOK = true;
                                    }
                                    else
                                    {
                                        NewStyle = this.StyleNotOK;
                                        newOK = false;
                                    }
                                }
                                else if (IfMissing) // only values are missing
                                {
                                    if (R.Cells[ColumnNewValue].Value.ToString() != R.Cells[ColumnPresentValue].Value.ToString()
                                        && R.Cells[ColumnPresentValue].Value.ToString().Length == 0
                                        && R.Cells[ColumnNewValue].Value.ToString().Length > 0)
                                    {
                                        NewStyle = this.StyleOK;
                                        newOK = true;
                                    }
                                    else
                                    {
                                        NewStyle = this.StyleNotOK;
                                        newOK = false;
                                    }
                                }
                                else
                                {
                                    NewStyle = this.StyleOK;
                                    newOK = true;
                                }
                            }
                        }
                    }
                    foreach (System.Windows.Forms.DataGridViewCell Cell in R.Cells)
                        Cell.Style = NewStyle;
                    R.Cells[ColumnOK].Value = newOK;


                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private void GeoNamesCheckDataset(System.Windows.Forms.DataGridView Grid)
        {
            try
            {
                int CollectionEventID = 0;
                if (Grid.SelectedRows.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a row");
                    return;
                }
                if (int.TryParse(Grid.SelectedRows[0].Cells[0].Value.ToString(), out CollectionEventID))
                {
                    string SQL = "SELECT MIN(CollectionSpecimenID) AS ID " +
                        "FROM CollectionSpecimen " +
                        "WHERE CollectionEventID = " + CollectionEventID.ToString();
                    if (int.TryParse(DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL), out this._CollectionSpecimenID))
                    {
                        this.CollectionSpecimenIDs.Clear();
                        this.CollectionSpecimenIDs.Add(this._CollectionSpecimenID);
                        this.DialogResult = DialogResult.OK;
                        this.Close();
                    }
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

#endregion

#endregion

#region Place & Country via Gazetteer

#region Common

        private void setGazetteerColorCodeAndOK(
            System.Windows.Forms.DataGridView Grid,
            int ColumnOK,
            int ColumnPresentValue,
            int ColumnNewValue,
            int ColumnError,
            bool IfMissing,
            bool IfDifferent)
        {
            try
            {
                foreach (System.Windows.Forms.DataGridViewRow R in Grid.Rows)
                {
                    // no changes for lines with error or already updated
                    if (R.Cells[0].Style == this._StyleError
                        || R.Cells[0].Style == this.StyleUpdated
                        || R.Cells[0].Style == this.StyleBlocked)
                        continue;

                    // getting the current setting if the row should be updated
                    bool OK = true;
                    bool.TryParse(R.Cells[ColumnOK].Value.ToString(), out OK);

                    // new OK
                    bool newOK = true;
                    // the new stye for the line
                    System.Windows.Forms.DataGridViewCellStyle NewStyle = this.StyleOK;

                    if (R.Cells[ColumnError].Value != null && R.Cells[ColumnError].Value.ToString().Length > 0) // Error
                    {
                        NewStyle = this.StyleError;
                        newOK = false;
                    }
                    else
                    {
                        // for testing
                        string Old = R.Cells[ColumnPresentValue].Value.ToString();
                        string New = R.Cells[ColumnNewValue].Value.ToString();
                        // equal values - no update needed
                        if (R.Cells[ColumnNewValue].Value.ToString() == R.Cells[ColumnPresentValue].Value.ToString()
                            && R.Cells[ColumnPresentValue].Value.ToString().Length > 0)
                        {
                            NewStyle = this.StyleBlocked;
                            newOK = false;
                        }
                        else
                        {
                            // no new values found
                            if (R.Cells[ColumnNewValue].Value.ToString().Length == 0)
                            {
                                NewStyle = this.StyleBlocked;
                                newOK = false;
                            }
                            else // values found
                            {
                                if (IfDifferent) // only if values are different
                                {
                                    if (R.Cells[ColumnNewValue].Value.ToString() != R.Cells[5].Value.ToString()
                                        && R.Cells[ColumnPresentValue].Value.ToString().Length > 0
                                        && R.Cells[ColumnNewValue].Value.ToString().Length > 0)
                                    {
                                        NewStyle = this.StyleOK;
                                        newOK = true;
                                    }
                                    else
                                    {
                                        NewStyle = this.StyleNotOK;
                                        newOK = false;
                                    }
                                }
                                else if (IfMissing) // only values are missing
                                {
                                    if (R.Cells[ColumnNewValue].Value.ToString() != R.Cells[ColumnPresentValue].Value.ToString()
                                        && R.Cells[ColumnPresentValue].Value.ToString().Length == 0
                                        && R.Cells[ColumnNewValue].Value.ToString().Length > 0)
                                    {
                                        NewStyle = this.StyleOK;
                                        newOK = true;
                                    }
                                    else
                                    {
                                        NewStyle = this.StyleNotOK;
                                        newOK = false;
                                    }
                                }
                                else
                                {
                                    NewStyle = this.StyleOK;
                                    newOK = true;
                                }
                            }
                        }
                    }
                    foreach (System.Windows.Forms.DataGridViewCell Cell in R.Cells)
                        Cell.Style = NewStyle;
                    R.Cells[ColumnOK].Value = newOK;


                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private void GetPlaceOrCountryFromGazetteer(string Point, bool ForCountry)
        {
            string SQL = "declare @Point geography; " +
                "set @Point = '" + Point + "'; " +
                "SELECT TOP (1) ";
            if (ForCountry)
                SQL += "C.Country";
            else
                SQL += "dbo.BaseURL() + cast( N.NameID as varchar), N.Name, C.HierarchyPlaceToCountry, C.HierarchyCountryToPlace";
            SQL += ", P.Geography.STDistance(@Point) AS Distance " +
                "FROM GeoPlace P INNER JOIN " +
                "GeoCache C ON P.PlaceID = C.PlaceID INNER JOIN " +
                "GeoName N ON P.PreferredNameID = N.NameID AND P.PlaceID = N.PlaceID " +
                "WHERE (P.Geography.STDistance(@Point) < " + this.numericUpDownPlaceAndCountryGazetteerSourceMaxDistance.Value.ToString() + ") " +
                "ORDER BY Distance ASC";
        }

        private string PlaceAndCountryGazetteerConnectionString()
        {
            string ConnectionString = "";
            try
            {
                DiversityWorkbench.ServerConnection SC = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList()[this.comboBoxPlaceAndCountryGazetteerSource.Text];
                ConnectionString = SC.ConnectionString;
            }
            catch (System.Exception ex)
            {
            }
            return ConnectionString;
        }

        private void comboBoxPlaceAndCountryGazetteerSource_DropDown(object sender, EventArgs e)
        {
            if (this.comboBoxPlaceAndCountryGazetteerSource.Items.Count == 0)
            {
                foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> SC in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList())
                {
                    if (SC.Value.LinkedServer.Length == 0)
                        this.comboBoxPlaceAndCountryGazetteerSource.Items.Add(SC.Key);
                }
            }
        }

#endregion

#region Place

        private System.Data.DataTable _DtPlaceAndCountryGazetteerPlace;
        public System.Data.DataTable DtPlaceAndCountryGazetteerPlace
        {
            get
            {
                if (this._DtPlaceAndCountryGazetteerPlace == null)
                    this._DtPlaceAndCountryGazetteerPlace = new DataTable();
                return _DtPlaceAndCountryGazetteerPlace;
            }
            set { _DtPlaceAndCountryGazetteerPlace = value; }
        }

        private void radioButtonPlaceAndCountryGazetteerPlaceMissing_CheckedChanged(object sender, EventArgs e)
        {

        }

        private void radioButtonPlaceAndCountryGazetteerPlaceDifferent_CheckedChanged(object sender, EventArgs e)
        {

        }

        private void buttonPlaceAndCountryGazetteerPlaceInsert_Click(object sender, EventArgs e)
        {
            // #173
            if (this.DtPlaceAndCountryGazetteerPlace == null || this.DtPlaceAndCountryGazetteerPlace.Rows.Count == 0) return;

            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            foreach (System.Data.DataRow R in this.DtPlaceAndCountryGazetteerPlace.Rows)
            {
                bool OK;
                if (bool.TryParse(R["OK"].ToString(), out OK) && OK)
                {
                    string SQL = "SELECT COUNT(*) FROM CollectionEventLocalisation L WHERE L.CollectionEventID = " + R["CollectionEventID"].ToString() + " AND L.LocalisationSystemID = 7";
                    string Result = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL);
                    string Direction = this.CardinalDirection(R["Coordinates"].ToString(), R["PointGazetteer"].ToString());
                    if (Result == "0")
                    {
                        SQL = "INSERT INTO CollectionEventLocalisation (CollectionEventID, LocalisationSystemID, Location1, Location2, DistanceToLocation) " +
                            "VALUES (" + R["CollectionEventID"].ToString() + ", 7, '" + R[3].ToString().Replace("'", "''") + "', '" + R[6].ToString() + "', '" + R[7].ToString() + "')";
                    }
                    else if (this.radioButtonPlaceAndCountryGazetteerPlaceDifferent.Checked)
                    {
                        SQL = "UPDATE L SET Location1 = '" + R[3].ToString().Replace("'", "''") + "', Location2 = '" + R[6].ToString() + "', DistanceToLocation = '" + R[7].ToString() + "' " +
                            "FROM CollectionEventLocalisation L WHERE L.CollectionEventID = " + R["CollectionEventID"].ToString() + " AND L.LocalisationSystemID = 7";
                    }
                    else
                        SQL = "";
                    if (SQL.Length > 0)
                        DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL);
                }
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        /// <summary>
        /// from https://stackoverflow.com/questions/14736464/determining-cardinal-compass-direction-between-points
        /// </summary>
        /// <param name="PointStart"></param>
        /// <param name="PointEnd"></param>
        /// <returns></returns>
        private string CardinalDirection(string PointStart, string PointEnd)
        {
            string Direction = "";
            string SQL = "declare @PointStart geography; declare @PointEnd geography; " +
                "set @PointStart = '" + PointStart + "'; set @PointEnd = '" + PointEnd + "'; " +
                "DECLARE @bearing decimal(18,12); " +
                "set @bearing = SELECT atan(([@PointEnd.Long]-[@PointStart.Long])/(10e-10+[@PointEnd.Lat]-[@PointStart.Lat]))*360/pi()/2 " +
                "+case when [@PointEnd.Lat]<[@PointStart.Lat] then 180 else 0 end " +
                "+case when [@PointEnd.Long]<[@PointStart.Long] and [@PointEnd.Lat]>[@PointStart.Lat] then 360 else 0 end); " +
                "declare @CardinalDirection varchar(2); ";
            return Direction;
        }

        private void buttonPlaceAndCountryGazetteerPlaceCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewPlaceAndCountryGazetteerPlace.SelectedRows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewPlaceAndCountryGazetteerPlace.SelectedRows[0];
            bool OK = true;
            string ID = "";
            try { ID = R.Cells["CollectionEventID"].Value.ToString(); }
            catch { OK = false; }
            if (OK)
            {
                string SQL = "SELECT MIN(CollectionSpecimenID) FROM CollectionSpecimen WHERE CollectionEventID = " + ID;
                string Message = "";
                ID = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL, ref Message);
                if (Message.Length == 0 && ID.Length > 0 && int.TryParse(ID, out this._CollectionSpecimenID))
                {
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                else
                    this.DialogResult = DialogResult.Cancel;
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            }
        }

        private void buttonPlaceAndCountryGazetteerPlaceSetWidth_Click(object sender, EventArgs e)
        {
            this.dataGridViewPlaceAndCountryGazetteerPlace.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
        }

        private void dataGridViewPlaceAndCountryGazetteerPlace_CellValidated(object sender, DataGridViewCellEventArgs e)
        {

        }

        private void dataGridViewPlaceAndCountryGazetteerPlace_Sorted(object sender, EventArgs e)
        {

        }

        private void buttonPlaceAndCountryGazetteerPlaceSearch_Click(object sender, EventArgs e)
        {
            try
            {
                this.progressBarPlaceAndCountryGazetteer.Value = 0;
                string SQL = "SELECT DISTINCT " +
                    "E.CollectionEventID, " +
                    "CAST(1 as BIT) AS OK, " +
                    "G.Location1 AS [Place in DiversityCollection], " +
                    "'' AS [Place in Gazetteer], " +
                    "E.LocalityDescription as Locality, " +
                    "L.Geography.EnvelopeCenter().ToString() AS Coordinates, " +
                    "G.Location2, " +
                    "'' AS Distance, " +
                    "'' AS PointGazetteer";
                if (this.radioButtonPlaceAndCountryGazetteerPlaceMissing.Checked)
                    SQL += "";
                else if (radioButtonPlaceAndCountryGazetteerPlaceDifferent.Checked)
                    SQL += "";
                else
                    SQL += "";
                SQL += "FROM CollectionEventLocalisation L, CollectionSpecimen S, CollectionProject P, CollectionEvent E " +
                    "LEFT OUTER JOIN CollectionEventLocalisation G ON E.CollectionEventID = G.CollectionEventID AND G.LocalisationSystemID = 7 ";
                if (this.radioButtonPlaceAndCountryGazetteerPlaceMissing.Checked)
                    SQL += " AND G.LocalisationSystemID IS NULL ";
                else if (radioButtonPlaceAndCountryGazetteerPlaceDifferent.Checked)
                    SQL += " AND (G.Location1 <> '') ";
                else
                    SQL += "";
                SQL += "WHERE E.CollectionEventID = L.CollectionEventID AND L.LocalisationSystemID = 8 AND NOT L.Geography IS NULL " +
                    "AND E.CollectionEventID = S.CollectionEventID AND S.CollectionSpecimenID = P.CollectionSpecimenID " +
                    "AND P.ProjectID = " + this.comboBoxPlaceAndCountryGazetteerProject.SelectedValue.ToString();
                //if (this.radioButtonPlaceAndCountryGazetteerPlaceMissing.Checked)
                //    SQL += " AND (E.CountryCache IS NULL OR E.CountryCache = '') ";
                //else if (radioButtonPlaceAndCountryGazetteerPlaceDifferent.Checked)
                //    SQL += " AND (E.CountryCache <> '') ";
                //else
                //    SQL += "";
                string Message = "";
                this.DtPlaceAndCountryGazetteerPlace = new DataTable();
                DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref this._DtPlaceAndCountryGazetteerPlace, ref Message);
                this.progressBarPlaceAndCountryGazetteer.Value = 0;
                this.progressBarPlaceAndCountryGazetteer.Maximum = this.DtPlaceAndCountryGazetteerPlace.Rows.Count;
                System.Collections.Generic.List<DataRow> rDelete = new List<DataRow>();
                foreach (System.Data.DataRow R in this.DtPlaceAndCountryGazetteerPlace.Rows)
                {
                    string Point = R[5].ToString();
                    SQL = "declare @Point geography; " +
                        "set @Point = '" + Point + "'; " +
                        "SELECT TOP (1) P.Geography.STDistance(@Point) AS Distance, ";
                    if (this.radioButtonPlaceAndCountryGazetteerPlaceHierarchyDirectionDown.Checked)
                        SQL += "replace(C.HierarchyCountryToPlace, '|', ', ') + ', ' + N.Name ";
                    else
                        SQL += "N.Name + ', ' + replace(C.HierarchyPlaceToCountry, '|', ', ') ";
                    SQL += ", dbo.BaseURL() + cast(N.NameID as varchar) AS Location2, " +
                        "P.Geography.EnvelopeCenter().ToString() AS PointGazetteer " +
                        "FROM GeoPlace P INNER JOIN " +
                        "GeoCache C ON P.PlaceID = C.PlaceID INNER JOIN " +
                        "GeoName N ON P.PreferredNameID = N.NameID AND P.PlaceID = N.PlaceID " +
                        "WHERE (P.Geography.STDistance(@Point) < " + this.numericUpDownPlaceAndCountryGazetteerSourceMaxDistance.Value.ToString() + "000) " +
                        "ORDER BY Distance ASC";
                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, PlaceAndCountryGazetteerConnectionString());
                    System.Data.DataTable dt = new DataTable();
                    try
                    {
                        ad.Fill(dt);
                    }
                    catch (System.Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                    string Place = "";
                    string Link = "";
                    string Distance = "";
                    string PointGazetteer = "";
                    if (dt.Rows.Count == 1)
                    {
                        Place = dt.Rows[0][1].ToString();
                        Link = dt.Rows[0]["Location2"].ToString();
                        Distance = dt.Rows[0][0].ToString();
                        PointGazetteer = dt.Rows[0]["PointGazetteer"].ToString();
                        float fDist;
                        if (float.TryParse(Distance, out fDist))
                        {
                            fDist = fDist / 1000;
                            Distance = fDist.ToString() + " km";
                        }
                    }
                    R[3] = Place;
                    R["Location2"] = Link;
                    R["Distance"] = Distance;
                    R["PointGazetteer"] = PointGazetteer;
                    if (radioButtonPlaceAndCountryGazetteerPlaceDifferent.Checked)
                    {
                        if (R[3].ToString().Length == 0 || R[3].ToString() == R[4].ToString())
                            rDelete.Add(R);
                    }
                    else
                    {
                        if (R[3].ToString().Length == 0)
                            rDelete.Add(R);
                    }
                    if (this.progressBarPlaceAndCountryGazetteer.Value < this.progressBarPlaceAndCountryGazetteer.Maximum)
                    {
                        this.progressBarPlaceAndCountryGazetteer.Value++;
                        System.Windows.Forms.Application.DoEvents();
                    }
                }
                this.progressBarPlaceAndCountryGazetteer.Value = 0;
                foreach (System.Data.DataRow R in rDelete)
                    R.Delete();
                this.DtPlaceAndCountryGazetteerPlace.AcceptChanges();
                this.dataGridViewPlaceAndCountryGazetteerPlace.DataSource = this.DtPlaceAndCountryGazetteerPlace;
                this.dataGridViewPlaceAndCountryGazetteerPlace.Columns[0].Visible = false;
                this.dataGridViewPlaceAndCountryGazetteerPlace.Columns[2].ReadOnly = true;
                this.dataGridViewPlaceAndCountryGazetteerPlace.Columns[3].ReadOnly = true;
                this.dataGridViewPlaceAndCountryGazetteerPlace.Columns[4].ReadOnly = true;
                this.dataGridViewPlaceAndCountryGazetteerPlace.Columns[5].ReadOnly = true;
                this.dataGridViewPlaceAndCountryGazetteerPlace.Columns[6].ReadOnly = true;
                this.dataGridViewPlaceAndCountryGazetteerPlace.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
            }
            catch (System.Exception ex)
            {
            }
        }

#endregion

#region Country

        private System.Data.DataTable _DtPlaceAndCountryGazetteerCountry;

        public System.Data.DataTable DtPlaceAndCountryGazetteerCountry
        {
            get
            {
                if (this._DtPlaceAndCountryGazetteerCountry == null)
                    this._DtPlaceAndCountryGazetteerCountry = new DataTable();
                return _DtPlaceAndCountryGazetteerCountry;
            }
            set { _DtPlaceAndCountryGazetteerCountry = value; }
        }

        private void buttonPlaceAndCountryGazetteerCountrySetCountries_Click(object sender, EventArgs e)
        {
            // #173
            if (this.DtPlaceAndCountryGazetteerCountry == null || this.DtPlaceAndCountryGazetteerCountry.Rows.Count == 0) return;

            this.progressBarPlaceAndCountryGazetteer.Value = 0;
            this.progressBarPlaceAndCountryGazetteer.Maximum = this.DtPlaceAndCountryGazetteerCountry.Rows.Count;
            foreach (System.Data.DataRow R in this.DtPlaceAndCountryGazetteerCountry.Rows)
            {
                bool OK;
                if (bool.TryParse(R["OK"].ToString(), out OK) && OK)
                {
                    string SQL = "UPDATE E SET E.CountryCache = '" + R[3].ToString() + "' FROM CollectionEvent E WHERE E.CollectionEventID = " + R["CollectionEventID"].ToString();
                    DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL);
                }
                this.progressBarPlaceAndCountryGazetteer.Value++;
            }
        }

        private void buttonPlaceAndCountryGazetteerCountryCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewPlaceAndCountryGazetteerCountry.SelectedRows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewPlaceAndCountryGazetteerCountry.SelectedRows[0];
            bool OK = true;
            string ID = "";
            try { ID = R.Cells["CollectionEventID"].Value.ToString(); }
            catch { OK = false; }
            if (OK)
            {
                string SQL = "SELECT MIN(CollectionSpecimenID) FROM CollectionSpecimen WHERE CollectionEventID = " + ID;
                string Message = "";
                ID = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL, ref Message);
                if (Message.Length == 0 && ID.Length > 0 && int.TryParse(ID, out this._CollectionSpecimenID))
                {
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                else
                    this.DialogResult = DialogResult.Cancel;
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            }
        }

        private void buttonPlaceAndCountryGazetteerCountrySetWidth_Click(object sender, EventArgs e)
        {
            this.dataGridViewPlaceAndCountryGazetteerCountry.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
        }

        private void radioButtonPlaceAndCountryGazetteerCountryMissing_CheckedChanged(object sender, EventArgs e)
        {
            this.dataGridViewPlaceAndCountryGazetteerCountry.DataSource = null;
            this._DtPlaceAndCountryGazetteerCountry = null;
        }

        private void radioButtonPlaceAndCountryGazetteerCountryDifferent_CheckedChanged(object sender, EventArgs e)
        {
            this.dataGridViewPlaceAndCountryGazetteerCountry.DataSource = null;
            this._DtPlaceAndCountryGazetteerCountry = null;
        }

        private void dataGridViewPlaceAndCountryGazetteerCountry_CellValidated(object sender, DataGridViewCellEventArgs e)
        {

        }

        private void dataGridViewPlaceAndCountryGazetteerCountry_Sorted(object sender, EventArgs e)
        {

        }

        private void buttonPlaceAndCountryGazetteerCountrySearch_Click(object sender, EventArgs e)
        {
            try
            {
                string SQL = "SELECT DISTINCT E.CollectionEventID, CAST(1 as BIT) AS OK, E.CountryCache AS [Country in DiversityCollection], '' AS [Country in Gazetteer], E.LocalityDescription as Locality, L.Geography.EnvelopeCenter().ToString() AS Coordinates ";
                if (this.radioButtonPlaceAndCountryGazetteerCountryMissing.Checked)
                    SQL += "";
                else if (radioButtonPlaceAndCountryGazetteerCountryDifferent.Checked)
                    SQL += "";
                else
                    SQL += "";
                SQL += "FROM CollectionEvent E, CollectionEventLocalisation L, CollectionSpecimen S, CollectionProject P " +
                    "WHERE E.CollectionEventID = L.CollectionEventID AND L.LocalisationSystemID = 8 AND NOT L.Geography IS NULL AND E.CollectionEventID = S.CollectionEventID AND S.CollectionSpecimenID = P.CollectionSpecimenID AND P.ProjectID = " + this.comboBoxPlaceAndCountryGazetteerProject.SelectedValue.ToString();
                if (this.radioButtonPlaceAndCountryGazetteerCountryMissing.Checked)
                    SQL += " AND (E.CountryCache IS NULL OR E.CountryCache = '') ";
                else if (radioButtonPlaceAndCountryGazetteerCountryDifferent.Checked)
                    SQL += " AND (E.CountryCache <> '') ";
                else
                    SQL += "";
                string Message = "";
                this.DtPlaceAndCountryGazetteerCountry = new DataTable();
                DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref this._DtPlaceAndCountryGazetteerCountry, ref Message);
                this.progressBarPlaceAndCountryGazetteer.Value = 0;
                this.progressBarPlaceAndCountryGazetteer.Maximum = this.DtPlaceAndCountryGazetteerCountry.Rows.Count;
                System.Collections.Generic.List<DataRow> rDelete = new List<DataRow>();
                foreach (System.Data.DataRow R in this.DtPlaceAndCountryGazetteerCountry.Rows)
                {
                    string Point = R[5].ToString();
                    string Country = this.GetCountryFromGazetteer(Point);
                    R[3] = Country;
                    if (radioButtonPlaceAndCountryGazetteerCountryDifferent.Checked)
                    {
                        if (R[3].ToString().Length == 0 || R[3].ToString() == R[4].ToString())
                            rDelete.Add(R);
                    }
                    else
                    {
                        if (R[3].ToString().Length == 0)
                            rDelete.Add(R);
                    }
                    if (this.progressBarPlaceAndCountryGazetteer.Value < this.progressBarPlaceAndCountryGazetteer.Maximum)
                        this.progressBarPlaceAndCountryGazetteer.Value++;
                }
                foreach (System.Data.DataRow R in rDelete)
                    R.Delete();
                this.DtPlaceAndCountryGazetteerCountry.AcceptChanges();
                this.dataGridViewPlaceAndCountryGazetteerCountry.DataSource = this.DtPlaceAndCountryGazetteerCountry;
                this.dataGridViewPlaceAndCountryGazetteerCountry.Columns[0].Visible = false;
                this.dataGridViewPlaceAndCountryGazetteerCountry.Columns[2].ReadOnly = true;
                this.dataGridViewPlaceAndCountryGazetteerCountry.Columns[3].ReadOnly = true;
                this.dataGridViewPlaceAndCountryGazetteerCountry.Columns[4].ReadOnly = true;
                this.dataGridViewPlaceAndCountryGazetteerCountry.Columns[5].ReadOnly = true;
                this.dataGridViewPlaceAndCountryGazetteerCountry.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
            }
            catch (System.Exception ex)
            {
            }
        }

        private string GetCountryFromGazetteer(string Point)
        {
            string SQL = "declare @Point geography; " +
                "set @Point = '" + Point + "'; " +
                "SELECT TOP (1) P.Geography.STDistance(@Point) AS Distance, C.Country" +
                "FROM GeoPlace P INNER JOIN " +
                "GeoCache C ON P.PlaceID = C.PlaceID INNER JOIN " +
                "GeoName N ON P.PreferredNameID = N.NameID AND P.PlaceID = N.PlaceID " +
                "WHERE (P.Geography.STDistance(@Point) < " + this.numericUpDownPlaceAndCountryGazetteerSourceMaxDistance.Value.ToString() + "000) " +
                "ORDER BY Distance ASC";
            Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, PlaceAndCountryGazetteerConnectionString());
            System.Data.DataTable dt = new DataTable();
            ad.Fill(dt);
            string Country = "";
            if (dt.Rows.Count == 1)
                Country = dt.Rows[0][1].ToString();
            return Country;
        }

#endregion

#endregion

#region Coordinates

#region Adding

        private void buttonAddCoordinatesConvert_Click(object sender, EventArgs e)
        {
            try
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                int ProjectID = 0;
                if (this.comboBoxAddCoordinatesProject.SelectedItem != null)
                {
                    System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxAddCoordinatesProject.SelectedItem;
                    int.TryParse(RP["ProjectID"].ToString(), out ProjectID);
                }

                if (this.comboBoxAddCoordinatesSource.SelectedItem == null)
                {
                    System.Windows.Forms.MessageBox.Show("Please select the source coordinate system");
                    return;
                }
                int SourceCoordinateSystemID;
                LookupTable.CoordinateSystem SourceCoordinate = (LookupTable.CoordinateSystem)this.comboBoxAddCoordinatesSource.SelectedItem;
                int.TryParse(LookupTable.CoordinateLocalisationSystemIDs[SourceCoordinate].ToString(), out SourceCoordinateSystemID);

                if (this.comboBoxAddCoordinatesResult.SelectedItem == null)
                {
                    System.Windows.Forms.MessageBox.Show("Please select the result coordinate system");
                    return;
                }
                int ResultCoordinateSystemID;
                LookupTable.CoordinateSystem ResultCoordinate = (LookupTable.CoordinateSystem)this.comboBoxAddCoordinatesResult.SelectedItem;
                int.TryParse(LookupTable.CoordinateLocalisationSystemIDs[ResultCoordinate].ToString(), out ResultCoordinateSystemID);

                string SourceLabel_x = "";
                if (SourceCoordinate == LookupTable.CoordinateSystem.GaussKrüger)
                    SourceLabel_x = "R";
                else if (SourceCoordinate == LookupTable.CoordinateSystem.UTM)
                    SourceLabel_x = "East";
                else SourceLabel_x = "Longitude";

                string SourceLabel_y = "";
                if (SourceCoordinate == LookupTable.CoordinateSystem.GaussKrüger)
                    SourceLabel_y = "H";
                else if (SourceCoordinate == LookupTable.CoordinateSystem.UTM)
                    SourceLabel_y = "North";
                else SourceLabel_y = "Latitude";

                string ResultLabel_x = "";
                if (ResultCoordinate == LookupTable.CoordinateSystem.GaussKrüger)
                    ResultLabel_x = "R";
                else if (ResultCoordinate == LookupTable.CoordinateSystem.UTM)
                    ResultLabel_x = "East";
                else ResultLabel_x = "Longitude";

                string ResultLabel_y = "";
                if (ResultCoordinate == LookupTable.CoordinateSystem.GaussKrüger)
                    ResultLabel_y = "H";
                else if (ResultCoordinate == LookupTable.CoordinateSystem.UTM)
                    ResultLabel_y = "North";
                else ResultLabel_y = "Latitude";

                string SQL = "SELECT ";
                if (this.checkBoxAddCoordinatesMax.Checked)
                {
                    int max = 0;
                    if (int.TryParse(this.textBoxAddCoordinatesMax.Text, out max))
                        SQL += "TOP " + max.ToString();
                }
                SQL += " L.CollectionEventID, CAST(1 as bit) AS OK, " +
                    "L.Location2 AS [" + SourceCoordinate.ToString() + " " + SourceLabel_y + "], " +
                    "0.0 AS [" + ResultCoordinate.ToString() + " " + ResultLabel_y + "], " +
                    "L.Location1 AS [" + SourceCoordinate.ToString() + " " + SourceLabel_x + "], " +
                    "0.0 AS [" + ResultCoordinate.ToString() + " " + ResultLabel_x + "], " +
                    "L.LocationAccuracy AS [Accuracy] " +
                    "FROM CollectionEventLocalisation AS L INNER JOIN " +
                    "CollectionSpecimen AS S ON L.CollectionEventID = S.CollectionEventID INNER JOIN " +
                    "CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID INNER JOIN " +
                    "CollectionSpecimenID_UserAvailable AS UA ON S.CollectionSpecimenID = UA.CollectionSpecimenID " +
                    "WHERE (P.ProjectID = " + ProjectID.ToString() + ") " +
                    "AND (L.LocalisationSystemID = " + SourceCoordinateSystemID.ToString() + ") " +
                    "AND (NOT (L.CollectionEventID IN (SELECT CollectionEventID " +
                    "FROM CollectionEventLocalisation WHERE (LocalisationSystemID = " + ResultCoordinateSystemID.ToString() + "))))";
                this._dtCoordinates = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(this._dtCoordinates);
                foreach (System.Data.DataRow R in this._dtCoordinates.Rows)
                {
                    if (!this.ConvertCoordinates(R))
                        break;
                }
                this.dataGridViewAddCoordinates.DataSource = null;
                this.dataGridViewAddCoordinates.DataSource = this._dtCoordinates;
                this.dataGridViewAddCoordinates.Columns[0].Visible = false;
                this.dataGridViewAddCoordinates.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                this._ResultCoordinateSystem = ResultCoordinate;
                for (int i = 2; i < this.dataGridViewAddCoordinates.Columns.Count; i++)
                    this.dataGridViewAddCoordinates.Columns[i].ReadOnly = true;
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
        }

        private void buttonAddCoordinatesAll_Click(object sender, EventArgs e)
        {
            // #173
            if(this._dtCoordinates == null || this._dtCoordinates.Rows.Count == 0) return;

            foreach (System.Data.DataRow R in this._dtCoordinates.Rows)
            {
                if (R[3].ToString().Length > 0 && R[5].ToString().Length > 0)
                {
                    R["OK"] = true;
                }
            }
        }

        private void buttonAddCoordinatesNone_Click(object sender, EventArgs e)
        {
            // #173
            if(this._dtCoordinates == null || this._dtCoordinates.Rows.Count == 0) return;

            foreach (System.Data.DataRow R in this._dtCoordinates.Rows)
            {
                R["OK"] = false;
            }
        }

        private string AddCoordinatesRecordingMethod()
        {
            if (this.checkBoxAddCoordinatesRecordingMethod.Visible &&
                this.checkBoxAddCoordinatesRecordingMethod.Checked &&
                this.textBoxAddCoordinatesRecordingMethod.Text.Length > 0)
                return this.textBoxAddCoordinatesRecordingMethod.Text;
            else return "";
        }

        private string UTMzone()
        {
            if (this.comboBoxAddCoordinatesSourceZone.SelectedItem == null)
                return "";
            return this.comboBoxAddCoordinatesSourceZone.SelectedItem.ToString();
        }

        private int? RoundAddedCoordinates()
        {
            if (this.checkBoxAddCoordinatesRound.Checked)
                return (int)this.numericUpDownAddCoordinatesRound.Value;
            else
                return null;
        }
        //private bool _AddUTMzone = false;
        private bool ConvertCoordinates(System.Data.DataRow R)
        {
            try
            {
                bool ConversionSuccessfull = true;
                LookupTable.CoordinateSystem SourceCoordinate = (LookupTable.CoordinateSystem)this.comboBoxAddCoordinatesSource.SelectedItem;
                LookupTable.CoordinateSystem ResultCoordinate = (LookupTable.CoordinateSystem)this.comboBoxAddCoordinatesResult.SelectedItem;
                GeoConversion.GeoCon GeoConverter = new GeoConversion.GeoCon();
                double xOri = 0;
                double yOri = 0;
                double xResult = 0;
                double yResult = 0;
                string AccuracyOri = R[6].ToString();
                if (!this.checkBoxAddCoordinatesKeepAccuracy.Checked)
                    AccuracyOri = "";
                DiversityWorkbench.GeoCoordinate Coordinate = new DiversityWorkbench.GeoCoordinate();
                string UTMzone = "";
                //bool AddUTMzone = false;
                if (SourceCoordinate != LookupTable.CoordinateSystem.GaussKrüger && SourceCoordinate != LookupTable.CoordinateSystem.UTM)
                {
                    if (!double.TryParse(R[4].ToString(), out xOri) || !double.TryParse(R[2].ToString(), out yOri))
                    {
                        DiversityWorkbench.GeoFunctions.ConvertDegreeToNumeric(R[2].ToString(), R[4].ToString(), ref Coordinate, ref ConversionSuccessfull);
                        xOri = Coordinate.NumericEW;
                        yOri = Coordinate.NumericNS;
                    }
                    else
                    {
                        Coordinate.NumericEW = xOri;
                        Coordinate.NumericNS = yOri;
                        Coordinate.NumericIsOriginalValue = true;
                        DiversityWorkbench.GeoFunctions.AccuracySetValues(ref Coordinate, ref ConversionSuccessfull);
                    }
                }
                else if (SourceCoordinate == LookupTable.CoordinateSystem.UTM)
                {
                    string X = R[4].ToString();
                    if (X.IndexOf(" ") > -1)
                    {
                        UTMzone = X.Substring(0, X.IndexOf(" "));
                        X = X.Substring(X.IndexOf(" ")).Trim();
                    }
                    else
                    {
                        if (this.UTMzone().Length == 0)
                        {
                            System.Windows.Forms.MessageBox.Show("The UTM zone is not specified in the data. Please select the UTM zone.", "No zone", MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return false;
                        }
                        //if (!_AddUTMzone)
                        //{
                        //    if (System.Windows.Forms.MessageBox.Show("Should the UTM zone be written into the source data if missing?", "Add zone?", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
                        //    {
                        //        _AddUTMzone = true;
                        //    }
                        //}
                    }
                    double.TryParse(X, out xOri);
                    double.TryParse(R[2].ToString(), out yOri);
                }
                else
                {
                    double.TryParse(R[4].ToString(), out xOri);
                    double.TryParse(R[2].ToString(), out yOri);
                }
                if (ConversionSuccessfull)
                {
                    switch (SourceCoordinate)
                    {
                        case LookupTable.CoordinateSystem.UTM:
                            switch (ResultCoordinate)
                            {
                                case LookupTable.CoordinateSystem.WGS84:
                                    // convert UTM to WGS84
                                    if (UTMzone.Length == 0)
                                    {
                                        UTMzone = this.UTMzone();
                                        //if (_AddUTMzone) AddUTMzone = true;
                                    }
                                    ConversionSuccessfull = GeoConverter.CoordWgs84UtmToGeo(UTMzone, xOri, yOri, ref xResult, ref yResult);
                                    int iAccuracy = 7;
                                    if (xOri % 1 > 0 && yOri % 1 > 0) iAccuracy++;
                                    // get Accuracy
                                    if (ConversionSuccessfull)
                                    {
                                        DiversityWorkbench.GeoCoordinate GC = new DiversityWorkbench.GeoCoordinate();
                                        GC.NumericEW = System.Math.Round(xResult, iAccuracy - 2);
                                        GC.NumericNS = System.Math.Round(yResult, iAccuracy - 2);
                                        GC.NumericIsOriginalValue = true;
                                        DiversityWorkbench.GeoFunctions.AccuracySetValues(ref GC, ref ConversionSuccessfull);
                                        //TODO:
                                        Coordinate.AccuracyText = GC.AccuracyText;
                                    }
                                    if(this.RoundAddedCoordinates() != null)
                                    {
                                        xResult = System.Math.Round(xResult, (int)this.RoundAddedCoordinates());
                                        yResult = System.Math.Round(yResult, (int)this.RoundAddedCoordinates());
                                    }
                                    //xOri = xResult;
                                    //yOri = yResult;
                                    //if (ConversionSuccessfull)
                                    //{
                                    //    ConversionSuccessfull = GeoConverter.DatumPotsdamToWgs84(xOri, yOri, ref xResult, ref yResult);
                                    //    if (ConversionSuccessfull)
                                    //    {
                                    //        DiversityWorkbench.GeoCoordinate GC = new DiversityWorkbench.GeoCoordinate();
                                    //        GC.NumericEW = System.Math.Round(xResult, iAccuracy - 2);
                                    //        GC.NumericNS = System.Math.Round(yResult, iAccuracy - 2);
                                    //        GC.NumericIsOriginalValue = true;
                                    //        DiversityWorkbench.GeoFunctions.AccuracySetValues(ref GC, ref ConversionSuccessfull);
                                    //        //TODO:
                                    //        Coordinate.AccuracyText = GC.AccuracyText;
                                    //    }
                                    //}
                                    break;
                            }
                            break;
                        case LookupTable.CoordinateSystem.GaussKrüger:
                            switch (ResultCoordinate)
                            {
                                case LookupTable.CoordinateSystem.PotsdamDatum:
                                    // convert GK to PD
                                    ConversionSuccessfull = GeoConverter.CoordPotsdamGkToGeo(xOri, yOri, ref xResult, ref yResult);
                                    break;
                                case LookupTable.CoordinateSystem.WGS84:
                                    // convert GK to PD
                                    ConversionSuccessfull = GeoConverter.CoordPotsdamGkToGeo(xOri, yOri, ref xResult, ref yResult);
                                    int iAccuracy = 7;
                                    if (xOri % 1 > 0 && yOri % 1 > 0) iAccuracy++;
                                    // convert PD to WGS84
                                    xOri = xResult;
                                    yOri = yResult;
                                    if (ConversionSuccessfull)
                                    {
                                        ConversionSuccessfull = GeoConverter.DatumPotsdamToWgs84(xOri, yOri, ref xResult, ref yResult);
                                        if (ConversionSuccessfull)
                                        {
                                            DiversityWorkbench.GeoCoordinate GC = new DiversityWorkbench.GeoCoordinate();
                                            GC.NumericEW = System.Math.Round(xResult, iAccuracy - 2);
                                            GC.NumericNS = System.Math.Round(yResult, iAccuracy - 2);
                                            GC.NumericIsOriginalValue = true;
                                            DiversityWorkbench.GeoFunctions.AccuracySetValues(ref GC, ref ConversionSuccessfull);
                                            //TODO:
                                            Coordinate.AccuracyText = GC.AccuracyText;
                                        }
                                    }
                                    break;
                            }
                            break;
                        case LookupTable.CoordinateSystem.PotsdamDatum:
                            switch (ResultCoordinate)
                            {
                                case LookupTable.CoordinateSystem.GaussKrüger:
                                    // convert PD to GK
                                    ConversionSuccessfull = GeoConverter.CoordPotsdamGeoToGk(xOri, yOri, ref xResult, ref yResult);
                                    break;
                                case LookupTable.CoordinateSystem.WGS84:
                                    // convert PD to GWS84
                                    ConversionSuccessfull = GeoConverter.DatumPotsdamToWgs84(xOri, yOri, ref xResult, ref yResult);
                                    break;
                            }
                            break;
                        case LookupTable.CoordinateSystem.WGS84:
                            switch (ResultCoordinate)
                            {
                                case LookupTable.CoordinateSystem.GaussKrüger:
                                    // convert WGS84 to PD
                                    ConversionSuccessfull = GeoConverter.DatumWgs84ToPotsdam(xOri, yOri, ref xResult, ref yResult);
                                    // convert PD to GK
                                    xOri = xResult;
                                    yOri = yResult;
                                    if (ConversionSuccessfull)
                                        ConversionSuccessfull = GeoConverter.CoordPotsdamGeoToGk(xOri, yOri, ref xResult, ref yResult);
                                    break;
                                case LookupTable.CoordinateSystem.PotsdamDatum:
                                    // convert WGS84 to PD
                                    GeoConverter.DatumWgs84ToPotsdam(xOri, yOri, ref xResult, ref yResult);
                                    break;
                            }
                            break;
                    }
                }
                if (ConversionSuccessfull)
                {
                    R[5] = xResult;
                    R[3] = yResult;
                    if (!this.checkBoxAddCoordinatesKeepAccuracy.Checked)
                        R[6] = Coordinate.AccuracyText;
                    //if (SourceCoordinate == LookupTable.CoordinateSystem.UTM && AddUTMzone && _AddUTMzone && UTMzone.Length > 0 && R[4].ToString().IndexOf(" ") == -1)
                    //    R[4] = UTMzone + " " + R[4].ToString();
                }
                else
                {
                    R["OK"] = false;
                    R[5] = System.DBNull.Value;
                    R[3] = System.DBNull.Value;
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
            return true;
        }

        private void buttonAddCoordinatesInsert_Click(object sender, EventArgs e)
        {
            // #173
            if (this._dtCoordinates == null || this._dtCoordinates.Rows.Count == 0) return;

            int i = 0;
            int iMax = 0;
            try
            {
                iMax = this._dtCoordinates.Rows.Count;
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                foreach (System.Data.DataRow R in this._dtCoordinates.Rows)
                {
                    bool Selected = true;
                    if (bool.TryParse(R[1].ToString(), out Selected) && Selected)
                    {
                        double Latitude = 0.0;
                        double Longitude = 0.0;
                        int CollectionEventID = 0;
                        int.TryParse(R[0].ToString(), out CollectionEventID);
                        int LocalisationSystemID = DiversityCollection.LookupTable.CoordinateLocalisationSystemIDs[this._ResultCoordinateSystem];
                        if (double.TryParse(R[5].ToString(), out Longitude) &&
                            double.TryParse(R[3].ToString(), out Latitude))
                        {
                            string SQL = "INSERT INTO CollectionEventLocalisation ([CollectionEventID],[LocalisationSystemID]" +
                                ",[Location1],[Location2]";
                            if (this._ResultCoordinateSystem == LookupTable.CoordinateSystem.WGS84)
                                SQL += ",[AverageLatitudeCache],[AverageLongitudeCache], [LocationAccuracy], [Geography]";
                            SQL += ", RecordingMethod) VALUES (" + CollectionEventID.ToString() + "," + LocalisationSystemID.ToString() + "," +
                                "'" + Longitude.ToString() + "', '" + Latitude.ToString() + "'";
                            if (this._ResultCoordinateSystem == LookupTable.CoordinateSystem.WGS84)
                                SQL += "," + Latitude + ", " + Longitude + ", '" + R[6].ToString() + "', geography::STPointFromText('POINT(" + Longitude.ToString() + " " + Latitude.ToString() + ")', 4326)";
                            SQL += ", '" + this.AddCoordinatesRecordingMethod() + "')";
                            bool OK = DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL);
                            if (OK)
                                i++;
                        }
                    }
                }

            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
            string Message = i.ToString() + " Coordinates inserted";
            if (i != iMax)
                Message = i.ToString() + " of " + iMax.ToString() + " Coordinates inserted";
            System.Windows.Forms.MessageBox.Show(Message);
        }

        private void comboBoxAddCoordinatesResult_DropDown(object sender, EventArgs e)
        {
            try
            {
                if (this.comboBoxAddCoordinatesSource.SelectedItem == null)
                {
                    System.Windows.Forms.MessageBox.Show("Please select the original coordinate type first");
                    return;
                }
                this.comboBoxAddCoordinatesResult.Items.Clear();
                LookupTable.CoordinateSystem SelectedSource = (LookupTable.CoordinateSystem)this.comboBoxAddCoordinatesSource.SelectedItem;
                if (SelectedSource == LookupTable.CoordinateSystem.UTM)
                    this.comboBoxAddCoordinatesResult.Items.Add(LookupTable.CoordinateSystem.WGS84);
                else
                {
                    if (SelectedSource != LookupTable.CoordinateSystem.GaussKrüger)
                        this.comboBoxAddCoordinatesResult.Items.Add(LookupTable.CoordinateSystem.GaussKrüger);
                    if (SelectedSource != LookupTable.CoordinateSystem.PotsdamDatum)
                        this.comboBoxAddCoordinatesResult.Items.Add(LookupTable.CoordinateSystem.PotsdamDatum);
                    if (SelectedSource != LookupTable.CoordinateSystem.WGS84)
                        this.comboBoxAddCoordinatesResult.Items.Add(LookupTable.CoordinateSystem.WGS84);
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private void comboBoxAddCoordinatesSource_SelectedIndexChanged(object sender, EventArgs e)
        {
            LookupTable.CoordinateSystem SelectedSource = (LookupTable.CoordinateSystem)this.comboBoxAddCoordinatesSource.SelectedItem;
            if (SelectedSource == LookupTable.CoordinateSystem.UTM) this.comboBoxAddCoordinatesSourceZone.Width = 44;
            else this.comboBoxAddCoordinatesSourceZone.Width = 0;
            if(!this.checkBoxAddCoordinatesRecordingMethod.Visible)
            {
                this.checkBoxAddCoordinatesRecordingMethod.Visible = true;
                this.checkBoxAddCoordinatesRecordingMethod.Checked = true;
            }
            this.textBoxAddCoordinatesRecordingMethod.Visible = true;
            this.textBoxAddCoordinatesRecordingMethod.Text = "Calculated from " + SelectedSource.ToString();
        }

        private void comboBoxAddCoordinatesSourceZone_DropDown(object sender, EventArgs e)
        {
            int i = 0;
            int s = 0;
            if (this.comboBoxAddCoordinatesSourceZone.Items.Count == 0)
            {
                for (int Zone = 1; Zone < 60; Zone++)
                {
                    for (char Band = 'A'; Band <= 'Z'; Band++)
                    {
                        this.comboBoxAddCoordinatesSourceZone.Items.Add(Zone.ToString() + Band);
                        if (Zone.ToString() + Band == "32U") s = i;
                        i++;
                    }
                }
                this.comboBoxAddCoordinatesSourceZone.SelectedIndex = s;
            }
        }

        private void comboBoxAddCoordinatesResult_SelectedIndexChanged(object sender, EventArgs e)
        {
            LookupTable.CoordinateSystem ResultSource = (LookupTable.CoordinateSystem)this.comboBoxAddCoordinatesResult.SelectedItem;
            this.numericUpDownAddCoordinatesRound.Visible = ResultSource == LookupTable.CoordinateSystem.WGS84;
            this.checkBoxAddCoordinatesRound.Visible = ResultSource == LookupTable.CoordinateSystem.WGS84;
            this.labelAddCoordinatesRound.Visible = ResultSource == LookupTable.CoordinateSystem.WGS84;
            this.checkBoxAddCoordinatesRound.Checked = ResultSource == LookupTable.CoordinateSystem.WGS84;
        }

#endregion

#region Calculation

        private void buttonCalculateCoordinatesStart_Click(object sender, EventArgs e)
        {
            int FailedConversion = 0;
            try
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                int ProjectID = 0;
                if (this.comboBoxCalculateCoordinatesProject.SelectedItem != null)
                {
                    System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxCalculateCoordinatesProject.SelectedItem;
                    int.TryParse(RP["ProjectID"].ToString(), out ProjectID);
                }
                //int.TryParse(this.comboBoxCalculateCoordinatesProject.SelectedValue.ToString(), out ProjectID);

                int CoordinateSystemID;
                LookupTable.CoordinateSystem Coordinate = (LookupTable.CoordinateSystem)this.comboBoxCalculateCoordinatesType.SelectedItem;
                int.TryParse(LookupTable.CoordinateLocalisationSystemIDs[Coordinate].ToString(), out CoordinateSystemID);
                string SQL = "SELECT ";
                if (this.checkBoxCalculateCoordinatesMaxResults.Checked)
                {
                    int max = 0;
                    if (int.TryParse(this.textBoxCalculateCoordinatesMaxResults.Text, out max))
                        SQL += "TOP " + max.ToString();
                }
                SQL += " L.CollectionEventID, " +
                    "L.Location1 AS [" + Coordinate.ToString() + " Longitude], " +
                    "L.AverageLongitudeCache AS [Result WGS84 Longitude], " +
                    "L.Location2 AS [" + Coordinate.ToString() + " Latitude], " +
                    "L.AverageLatitudeCache AS [Result WGS84 Latitude], " +
                    "L.LocationNotes AS [Notes], " +
                    "L.LocationAccuracy AS [Accuracy] " +
                    "FROM CollectionEventLocalisation AS L INNER JOIN " +
                    "CollectionSpecimen AS S ON L.CollectionEventID = S.CollectionEventID INNER JOIN " +
                    "CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID INNER JOIN " +
                    "CollectionSpecimenID_UserAvailable AS UA ON S.CollectionSpecimenID = UA.CollectionSpecimenID " +
                    "WHERE (P.ProjectID = " + ProjectID.ToString() + ") " +
                    "AND (L.AverageLatitudeCache IS NULL OR L.AverageLatitudeCache = 0) AND (L.AverageLongitudeCache IS NULL OR L.AverageLongitudeCache = 0) " +
                    "AND (L.LocalisationSystemID = " + CoordinateSystemID.ToString() + ") " +
                    "AND ((L.CollectionEventID IN (SELECT CollectionEventID " +
                    "FROM CollectionEventLocalisation WHERE (LocalisationSystemID = " + CoordinateSystemID.ToString() + "))))";
                this._dtCoordinateCalculation = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(this._dtCoordinateCalculation);
                foreach (System.Data.DataRow R in this._dtCoordinateCalculation.Rows)
                {
                    if (!this.CalculateCoordinates(R))
                    {
                        FailedConversion++;
                    }
                }
                this.dataGridViewCalculateCoordinates.DataSource = null;
                this.dataGridViewCalculateCoordinates.DataSource = this._dtCoordinateCalculation;
                this.dataGridViewCalculateCoordinates.Columns[0].Visible = false;
                this.dataGridViewCalculateCoordinates.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
            if (FailedConversion > 0)
                System.Windows.Forms.MessageBox.Show(FailedConversion.ToString() + " conversions failed");
        }

        private bool CalculateCoordinates(System.Data.DataRow R)
        {
            try
            {
                bool ConversionSuccessfull = true;
                double xResult;
                double yResult;
                DiversityWorkbench.GeoCoordinate Coordinate = new DiversityWorkbench.GeoCoordinate();
                //Longitude.Direction = DiversityWorkbench.GeoFunctions.GeoDirection.Longitude;
                DiversityWorkbench.GeoFunctions.ConvertDegreeToNumeric(R[1].ToString(), R[3].ToString(), ref Coordinate, ref ConversionSuccessfull);
                if (!ConversionSuccessfull) return false;
                else
                {
                    xResult = Coordinate.NumericNS;
                    yResult = Coordinate.NumericEW;
                }
                //DiversityWorkbench.GeoCoordinate Latitude = new DiversityWorkbench.GeoCoordinate();
                //Latitude.Direction = DiversityWorkbench.GeoFunctions.GeoDirection.Latitude;
                //double yResult = DiversityWorkbench.GeoFunctions.ConvertDegreeToNumeric(R[1].ToString(), ref Latitude, ref ConversionSuccessfull);
                //if (!ConversionSuccessfull) return false;
                if (xResult != 0.0 && yResult != 0.0)
                {
                    if (ConversionSuccessfull)
                    {
                        R[2] = xResult;
                        R[4] = yResult;
                        R[5] = "[Ori.val.: " + R[3].ToString() + ", " + R[1].ToString() + "]";
                        R[6] = Coordinate.AccuracyText;
                    }
                    else
                    {
                        R[4] = System.DBNull.Value;
                        R[2] = System.DBNull.Value;
                    }
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
                return false;
            }
            return true;
        }

        private void buttonCalculateCoordinatesInsert_Click(object sender, EventArgs e)
        {
            int i = 0;
            int iMax = 0;
            try
            {
                LookupTable.CoordinateSystem Coordinate = (LookupTable.CoordinateSystem)this.comboBoxCalculateCoordinatesType.SelectedItem;
                iMax = this._dtCoordinateCalculation.Rows.Count;
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                foreach (System.Data.DataRow R in this._dtCoordinateCalculation.Rows)
                {
                    double Latitude = 0.0;
                    double Longitude = 0.0;
                    int CollectionEventID = 0;
                    int.TryParse(R[0].ToString(), out CollectionEventID);
                    int LocalisationSystemID = DiversityCollection.LookupTable.CoordinateLocalisationSystemIDs[Coordinate];
                    // Markus 20230310: Bugfix - inserting missing ,
                    string Notes = "";
                    if (!R[5].Equals(System.DBNull.Value)) Notes = R[5].ToString();
                    Notes = Notes.Replace("'", "''");
                    if (double.TryParse(R[2].ToString(), out Longitude) &&
                        double.TryParse(R[4].ToString(), out Latitude))
                    {
                        string Accuracy = R[6].ToString();
                        string SQL = "UPDATE CollectionEventLocalisation SET " +
                            "[Location1] = '" + Longitude.ToString() + "',  [Location2] = '" + Latitude.ToString() + "'" +
                            ", [LocationNotes] = '" + Notes + "'"; // + DiversityWorkbench.Forms.FormFunctions.SqlRemoveHyphens(R[5].ToString()) + "'";
                        if (Coordinate == LookupTable.CoordinateSystem.WGS84)
                            SQL += ", [AverageLatitudeCache] = " + Latitude.ToString() + ", [AverageLongitudeCache] = " + Longitude.ToString() +
                                ", [LocationAccuracy] = CASE WHEN [LocationAccuracy] IS NULL OR [LocationAccuracy] = '' THEN '" + Accuracy + "' ELSE [LocationAccuracy] END";
                        SQL += " WHERE CollectionEventID = " + CollectionEventID.ToString() + " AND LocalisationSystemID = " + LocalisationSystemID.ToString();
                        bool OK = DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL);
                        if (OK)
                            i++;
                    }
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
            string Message = i.ToString() + " Coordinates updated";
            if (i != iMax)
                Message = i.ToString() + " of " + iMax.ToString() + " Coordinates updated";
            System.Windows.Forms.MessageBox.Show(Message);
        }

#endregion

#region Parsing

        private System.Data.DataTable _dtCoordinateParser;

        private System.Collections.Generic.List<string> _CoordiateParser;
        public List<string> CoordiateParser
        {
            get
            {
                if (_CoordiateParser == null)
                {
                    _CoordiateParser = new List<string>();
                    _CoordiateParser.Add("...°..'..'' E  ..°..'..'' N");
                }
                return _CoordiateParser;
            }
            set
            {
                _CoordiateParser = value;
            }
        }


        private void buttonParseCoordinatesStart_Click(object sender, EventArgs e)
        {
            int FailedConversion = 0;
            try
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                int ProjectID = 0;
                if (this.comboBoxParseCoordinatesProject.SelectedItem != null)
                {
                    System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxParseCoordinatesProject.SelectedItem;
                    int.TryParse(RP["ProjectID"].ToString(), out ProjectID);
                }

                string SQL = "SELECT ";
                if (this.checkBoxParseCoordinatesMaxResults.Checked)
                {
                    int max = 0;
                    if (int.TryParse(this.checkBoxParseCoordinatesMaxResults.Text, out max))
                        SQL += "TOP " + max.ToString();
                }
                SQL += " L.CollectionEventID, " +
                    "L.Location1 AS [current Longitude], " +
                    "'' AS [parsed Longitude], " +
                    "L.AverageLongitudeCache AS [Result WGS84 Longitude], " +
                    "L.Location2 AS [current Latitude], " +
                    "'' AS [parsed Latitude], " +
                    "L.AverageLatitudeCache AS [Result WGS84 Latitude], " +
                    "L.LocationNotes AS [Notes], " +
                    "L.LocationAccuracy AS [Accuracy] " +
                    "FROM CollectionEventLocalisation AS L INNER JOIN " +
                    "CollectionSpecimen AS S ON L.CollectionEventID = S.CollectionEventID INNER JOIN " +
                    "CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID INNER JOIN " +
                    "CollectionSpecimenID_UserAvailable AS UA ON S.CollectionSpecimenID = UA.CollectionSpecimenID " +
                    "WHERE (P.ProjectID = " + ProjectID.ToString() + ") " +
                    "AND (L.AverageLatitudeCache IS NULL OR L.AverageLatitudeCache = 0) AND (L.AverageLongitudeCache IS NULL OR L.AverageLongitudeCache = 0) " +
                    "AND (L.LocalisationSystemID = 8) ";
                if (this.comboBoxCalculateCoordinatesType.SelectedIndex == 0)
                    SQL += "AND L.Location1 like '%°%' ";
                this._dtCoordinateParser = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(this._dtCoordinateParser);
                foreach (System.Data.DataRow R in this._dtCoordinateParser.Rows)
                {
                    if (!this.ParseCoordinates(R))
                    {
                        FailedConversion++;
                    }
                }
                this.dataGridViewParseCoordinates.DataSource = null;
                this.dataGridViewParseCoordinates.DataSource = this._dtCoordinateParser;
                this.dataGridViewParseCoordinates.Columns[0].Visible = false;
                this.dataGridViewParseCoordinates.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
            if (FailedConversion > 0)
                System.Windows.Forms.MessageBox.Show(FailedConversion.ToString() + " conversions failed");
        }

        private void buttonParseCoordinatesUpdateCoordinates_Click(object sender, EventArgs e)
        {
            int i = 0;
            int iMax = 0;
            try
            {
                iMax = this._dtCoordinateParser.Rows.Count;
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                foreach (System.Data.DataRow R in this._dtCoordinateParser.Rows)
                {
                    double Latitude = 0.0;
                    double Longitude = 0.0;
                    int CollectionEventID = 0;
                    int.TryParse(R[0].ToString(), out CollectionEventID);
                    int LocalisationSystemID = 8;
                    if (double.TryParse(R[2].ToString(), out Longitude) &&
                        double.TryParse(R[4].ToString(), out Latitude))
                    {
                        string Accuracy = R[6].ToString();
                        string SQL = "UPDATE CollectionEventLocalisation SET " +
                            "[Location1] = '" + Longitude.ToString() + "',  [Location2] = '" + Latitude.ToString() + "'" +
                            ",[LocationNotes] = '" + DiversityWorkbench.Forms.FormFunctions.SqlRemoveHyphens(R[5].ToString()) + "'" +
                            ",[AverageLatitudeCache] = " + Latitude.ToString() + ",[AverageLongitudeCache] = " + Longitude.ToString() +
                            "[LocationAccuracy] = CASE WHEN [LocationAccuracy] IS NULL OR [LocationAccuracy] = '' THEN '" + Accuracy + "' ELSE [LocationAccuracy] END" +
                            " WHERE CollectionEventID = " + CollectionEventID.ToString() + " AND LocalisationSystemID = " + LocalisationSystemID.ToString();
                        bool OK = DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL);
                        if (OK)
                            i++;
                    }
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
            finally
            {
                this.Cursor = System.Windows.Forms.Cursors.Default;
            }
            string Message = i.ToString() + " Coordinates updated";
            if (i != iMax)
                Message = i.ToString() + " of " + iMax.ToString() + " Coordinates updated";
            System.Windows.Forms.MessageBox.Show(Message);
        }

        private bool ParseCoordinates(System.Data.DataRow R)
        {
            try
            {
                bool ConversionSuccessfull = true;
                GeoConversion.GeoCon Converter = new GeoConversion.GeoCon();
                double xResult = 0;
                double yResult = 0;
                string strResult = xResult.ToString("F8", System.Globalization.CultureInfo.InvariantCulture);
                if (!Converter.ConvertCoordinateToDecimal(R[1].ToString(), ref xResult))
                    ConversionSuccessfull = false;
                if (!Converter.ConvertCoordinateToDecimal(R[3].ToString(), ref yResult))
                    ConversionSuccessfull = false;
                if (ConversionSuccessfull && xResult != 0.0 && yResult != 0.0)
                {
                    R[2] = xResult;
                    R[4] = yResult;
                    R[5] = "[Ori.val.: " + R[3].ToString() + ", " + R[1].ToString() + "]";
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
                return false;
            }
            return true;
        }

#endregion

#region Differences in Geography, values or cache values

        private void initCheckGeography()
        {
            try
            {
                this.comboBoxCheckGeographyTypeOfComparision.Items.Clear();
                foreach (System.Collections.Generic.KeyValuePair<GeographyComparisionType, string> KV in this.GeographyComparisionTypes)
                    this.comboBoxCheckGeographyTypeOfComparision.Items.Add(KV.Value);

                System.Data.DataTable dt = DiversityCollection.LookupTable.DtLocalisationSystemNew;
                foreach (System.Data.DataRow R in dt.Rows)
                {
                    if (R["LocalisationSystemID"].ToString() == "8"
                        /*|| R["LocalisationSystemID"].ToString() == "13"
                        || R["LocalisationSystemID"].ToString() == "7"
                        || R["LocalisationSystemID"].ToString() == "18"
                        || R["LocalisationSystemID"].ToString() == "19"
                        || R["LocalisationSystemID"].ToString() == "20"
                        || R["LocalisationSystemID"].ToString() == "21"*/)
                        continue;
                    else
                        R.Delete();
                }
                dt.AcceptChanges();
                this.comboBoxCheckGeographySystem.DataSource = dt;
                this.comboBoxCheckGeographySystem.DisplayMember = "DisplayText";
                this.comboBoxCheckGeographySystem.ValueMember = "LocalisationSystemID";
            }
            catch (System.Exception ex)
            {
            }
        }

        private void comboBoxCheckGeographyTypeOfComparision_SelectionChangeCommitted(object sender, EventArgs e)
        {
            GeographyComparisionType Type = GeographyComparisionType.ValueToGeo;
            foreach (System.Collections.Generic.KeyValuePair<GeographyComparisionType, string> KV in this.GeographyComparisionTypes)
            {
                if (KV.Value == this.comboBoxCheckGeographyTypeOfComparision.SelectedItem.ToString())
                {
                    Type = KV.Key;
                    break;
                }
            }
            this.comboBoxCheckGeographyTypeOfComparisionBase.Visible = Type == GeographyComparisionType.ValueToCache;
            switch (Type)
            {
                case GeographyComparisionType.ValueToGeo:
                    this.labelCheckGeographyTypeDescription.Text = "Writing the values into the geography if the geography is missing or a POINT datum with differing values";
                    break;
                case GeographyComparisionType.ValueToCache:
                    this.labelCheckGeographyTypeDescription.Text = "Writing the values into the cache values for latitude and longitude if these are missing or contain differing values";// "Available in upcoming version";
                    this.initGeographyTypeOfComparisionBasis();
                    break;
                case GeographyComparisionType.GeoToCache:
                    this.labelCheckGeographyTypeDescription.Text = "Writing the geography into the cache values for latitude and longitude if these are missing or contain differing values";// "Available in upcoming version";
                    break;
            }
        }

        private GeographyTypeOfComparisionBase geographyTypeOfComparisionBase
        {
            get
            {
                if(this.comboBoxCheckGeographyTypeOfComparisionBase.SelectedItem != null)
                {
                    if (GeographyTypeOfComparisionBasis.ContainsValue(this.comboBoxCheckGeographyTypeOfComparisionBase.SelectedItem.ToString()))
                    {
                        foreach(System.Collections.Generic.KeyValuePair<GeographyTypeOfComparisionBase, string> KV in GeographyTypeOfComparisionBasis)
                        {
                            if (KV.Value == this.comboBoxCheckGeographyTypeOfComparisionBase.SelectedItem.ToString())
                                return KV.Key;
                        }
                    }
                }
                return GeographyTypeOfComparisionBase.None;
            }
        }

        private void initGeographyTypeOfComparisionBasis()
        {
            if (this.comboBoxCheckGeographyTypeOfComparisionBase.Items.Count == 0)
            {
                this.comboBoxCheckGeographyTypeOfComparisionBase.Items.Add(GeographyTypeOfComparisionBasis[GeographyTypeOfComparisionBase.Float]);
                this.comboBoxCheckGeographyTypeOfComparisionBase.Items.Add(GeographyTypeOfComparisionBasis[GeographyTypeOfComparisionBase.Text]);
            }
        }
        private enum GeographyTypeOfComparisionBase { Float, Text, None }

        private System.Collections.Generic.Dictionary<GeographyTypeOfComparisionBase, string> GeographyTypeOfComparisionBasis
        {
            get
            {
                System.Collections.Generic.Dictionary<GeographyTypeOfComparisionBase, string> dict = new Dictionary<GeographyTypeOfComparisionBase, string>();
                dict.Add(GeographyTypeOfComparisionBase.Float, "Compare NUMERIC values");
                dict.Add(GeographyTypeOfComparisionBase.Text, "Compare TEXT values");
                return dict;
            }
        }

        private enum GeographyComparisionType { ValueToCache, ValueToGeo, CacheToGeo, MissingGeo, GeoToCache }
        System.Collections.Generic.Dictionary<GeographyComparisionType, string> _GeographyComparisionTypes;
        private System.Collections.Generic.Dictionary<GeographyComparisionType, string> GeographyComparisionTypes
        {
            get
            {
                if (this._GeographyComparisionTypes == null)
                {
                    this._GeographyComparisionTypes = new Dictionary<GeographyComparisionType, string>();
                    //this._GeographyComparisionTypes.Add(GeographyComparisionType.GeoToCache, "Geography -> Cache values");
                    this._GeographyComparisionTypes.Add(GeographyComparisionType.ValueToCache, "Values -> Cache values");
                    this._GeographyComparisionTypes.Add(GeographyComparisionType.ValueToGeo, "Values -> Geography");
                    //this._GeographyComparisionTypes.Add(GeographyComparisionType.CacheToGeo, "Values -> Geography");
                    //this._GeographyComparisionTypes.Add(GeographyComparisionType.ValueToGeo, "Values -> Geography");
                    //Values <-> Geography
                    //Cache values <-> Geography
                    //Wrong cache values
                    //Missing geography
                }
                return this._GeographyComparisionTypes;
            }
        }

        private System.Data.DataTable _DtCheckGeography;

        private void buttonCheckGeographySearch_Click(object sender, EventArgs e)
        {
            this.FindDiffenencesInGeographyAndCacheValues();
        }

        private void buttonCheckGeographyCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewCheckGeography.SelectedCells.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }
            string SQL = "SELECT MIN(CollectionSpecimenID) FROM CollectionSpecimen WHERE CollectionEventID = " +
                this.dataGridViewCheckGeography.Rows[this.dataGridViewCheckGeography.SelectedCells[0].RowIndex].Cells[0].Value.ToString();
            int CollectionSpecimenID;
            if (int.TryParse(DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL), out CollectionSpecimenID))
            {
                DiversityCollection.Forms.FormCollectionSpecimen f = new Forms.FormCollectionSpecimen(CollectionSpecimenID, false, false);
                f.setViewMode(Forms.FormCollectionSpecimen.ViewMode.SingleInspectionMode);
                f.Width = this.Width - 10;
                f.Height = this.Height - 10;
                f.ShowDialog();
            }
            //System.Windows.Forms.MessageBox.Show("Available in upcoming version");
            return;
        }

        private void FindDiffenencesInGeographyAndCacheValues()
        {
            if (this.comboBoxCheckGeographyTypeOfComparision.SelectedItem == null)
            {
                System.Windows.Forms.MessageBox.Show("Please select the type of comparision");
                return;
            }
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            this.dataGridViewCheckGeography.Columns.Clear();
            this._DtCheckGeography = new DataTable();
            GeographyComparisionType Type = GeographyComparisionType.ValueToGeo;
            foreach (System.Collections.Generic.KeyValuePair<GeographyComparisionType, string> KV in this.GeographyComparisionTypes)
            {
                if (KV.Value == this.comboBoxCheckGeographyTypeOfComparision.SelectedItem.ToString())
                {
                    Type = KV.Key;
                    break;
                }
            }
            string SQL = "SELECT E.CollectionEventID, ";

            /*
            
SELECT E.CollectionEventID, CAST(case when (not E.Geography IS NULL and (len(E.Geography.ToString()) > Len(Location2) + len(Location1) + 8) or ISNUMERIC(Location1) = 0) then 0 else 1 end AS BIT) AS OK, 
E.Location1 AS Longitude, E.Location2 AS Latitude  , E.Geography.ToString() AS [Geography] 
FROM CollectionEventLocalisation E, CollectionSpecimen S, CollectionProject P 
WHERE E.LocalisationSystemID  = 8 
AND E.Location1 <> '' and 
E.Location2 <> ''  
AND E.Geography IS NULL
AND E.CollectionEventID = S.CollectionEventID  AND P.CollectionSpecimenID = S.CollectionSpecimenID  AND P.ProjectID = 909

UNION

SELECT E.CollectionEventID,  CAST(case when (len(E.Geography.ToString()) > Len(Location2) + len(Location1) + 8) then 0 else 1 end AS BIT) AS OK, 
E.Location1 AS Longitude, E.Location2 AS Latitude  , E.Geography.ToString() AS [Geography] 
FROM CollectionEventLocalisation E, CollectionSpecimen S, CollectionProject P 
WHERE E.LocalisationSystemID  = 8 
AND E.Location1 <> '' and 
E.Location2 <> ''  
AND E.Geography.ToString() like 'Point%'
AND substring(REPLACE(E.Location2,',', '.'),1, len(cast(E.Geography.Lat as varchar))-1) <> substring(REPLACE(cast(E.Geography.Lat as varchar),',', '.'), 1, len(cast(E.Geography.Lat as varchar))-1) 
AND substring(REPLACE(E.Location1,',', '.'),1, len(cast(E.Geography.Long as varchar))-1) <> substring(REPLACE(cast(E.Geography.Long as varchar),',', '.'), 1, len(cast(E.Geography.Long as varchar))-1) 
AND E.Geography.ToString() NOT like 'Point%(% % %'           
AND E.CollectionEventID = S.CollectionEventID  AND P.CollectionSpecimenID = S.CollectionSpecimenID  AND P.ProjectID = 909

ORDER BY [Geography]

             * */
            switch (Type)
            {
                case GeographyComparisionType.ValueToGeo:
                    switch (this.comboBoxCheckGeographySystem.SelectedValue.ToString())
                    {
                        case "7":
                            SQL += " CAST(case when not E.Geography IS NULL and (len(cast(E.Geography.Lat as varchar)) > len(cast(E.AverageLatitudeCache as varchar)) or len(cast(E.Geography.Long as varchar)) > len(cast(E.AverageLongitudeCache as varchar))) then 0 else 1 end AS BIT) AS OK,  E.AverageLongitudeCache AS Longitude, E.AverageLatitudeCache AS Latitude";
                            break;
                        default:
                            SQL += " CAST(case when not E.Geography IS NULL and (len(E.Geography.ToString()) > Len(Location2) + len(Location1) + 8) then 0 else 1 end AS BIT) AS OK, " +
                                "E.Location1 AS Longitude, E.Location2 AS Latitude  ";
                            break;
                    }
                    SQL += ", E.Geography.ToString() AS Geography " +
                        "FROM CollectionEventLocalisation E, CollectionSpecimen S, CollectionProject P " +
                        "WHERE E.LocalisationSystemID ";
                    switch (this.comboBoxCheckGeographySystem.SelectedValue.ToString())
                    {
                        case "7":
                            SQL += " IN (7, 18, 19, 20, 21) " +
                                " AND E.AverageLatitudeCache <> 0 AND E.AverageLongitudeCache <> 0 " +
                                "AND (E.Geography IS NULL " +
                                " OR (E.Geography.ToString() like 'Point%' " +
                                "     AND REPLACE(E.AverageLatitudeCache,',', '.') <> REPLACE(cast(E.Geography.Lat as varchar),',', '.') " +
                                "     AND REPLACE(E.AverageLongitudeCache,',', '.') <> REPLACE(cast(E.Geography.Long as varchar),',', '.') " +
                                "    )" +
                                ") ";
                            break;
                        default:
                            SQL = "SELECT E.CollectionEventID, CAST(case when (not E.Geography IS NULL and (len(E.Geography.ToString()) > Len(Location2) + len(Location1) + 8) or ISNUMERIC(Location1) = 0) then 0 else 1 end AS BIT) AS OK, " +
                                "E.Location1 AS Longitude, E.Location2 AS Latitude  , E.Geography.ToString() AS [Geography]  " +
                                "FROM CollectionEventLocalisation E, CollectionSpecimen S, CollectionProject P  " +
                                "WHERE E.LocalisationSystemID  = " + this.comboBoxCheckGeographySystem.SelectedValue.ToString() + " " +
                                "AND E.Location1 <> '' and  " +
                                "E.Location2 <> ''   " +
                                "AND E.Geography IS NULL " +
                                "AND E.CollectionEventID = S.CollectionEventID  AND P.CollectionSpecimenID = S.CollectionSpecimenID  AND P.ProjectID = " + this.comboBoxCheckGeographyProject.SelectedValue.ToString() + " " +
                                "UNION " +
                                "SELECT E.CollectionEventID,  CAST(case when (len(E.Geography.ToString()) > Len(Location2) + len(Location1) + 8) then 0 else 1 end AS BIT) AS OK,  " +
                                "E.Location1 AS Longitude, E.Location2 AS Latitude  , E.Geography.ToString() AS [Geography]  " +
                                "FROM CollectionEventLocalisation E, CollectionSpecimen S, CollectionProject P  " +
                                "WHERE E.LocalisationSystemID  = " + this.comboBoxCheckGeographySystem.SelectedValue.ToString() + " " +
                                "AND E.Location1 <> '' and  " +
                                "E.Location2 <> ''   " +
                                "AND E.Geography.ToString() like 'Point%' " +
                                "AND substring(REPLACE(E.Location2,',', '.'),1, len(cast(E.Geography.Lat as varchar))-1) <> substring(REPLACE(cast(E.Geography.Lat as varchar),',', '.'), 1, len(cast(E.Geography.Lat as varchar))-1)  " +
                                "AND substring(REPLACE(E.Location1,',', '.'),1, len(cast(E.Geography.Long as varchar))-1) <> substring(REPLACE(cast(E.Geography.Long as varchar),',', '.'), 1, len(cast(E.Geography.Long as varchar))-1)  " +
                                "AND E.Geography.ToString() NOT like 'Point%(% % %' " +
                                "AND E.CollectionEventID = S.CollectionEventID  AND P.CollectionSpecimenID = S.CollectionSpecimenID ";
                            break;
                    }
                    SQL += " AND E.CollectionEventID = S.CollectionEventID " +
                        " AND P.CollectionSpecimenID = S.CollectionSpecimenID " +
                        " AND P.ProjectID = " + this.comboBoxCheckGeographyProject.SelectedValue.ToString() + " " +
                        " ORDER BY [Geography]";
                    break;
                case GeographyComparisionType.ValueToCache:
                    SQL += " CAST(1 AS bit) AS OK, E.Location2 AS Latitude, E.AverageLatitudeCache, E.Location1 AS Longitude, E.AverageLongitudeCache FROM CollectionEventLocalisation E, CollectionSpecimen S, CollectionProject P " +
                        "WHERE E.LocalisationSystemID = " + this.comboBoxCheckGeographySystem.SelectedValue.ToString();
                    SQL += " AND E.CollectionEventID = S.CollectionEventID " +
                        " AND P.CollectionSpecimenID = S.CollectionSpecimenID " +
                        " AND P.ProjectID = " + this.comboBoxCheckGeographyProject.SelectedValue.ToString();
                    switch(geographyTypeOfComparisionBase)
                    {
                        case GeographyTypeOfComparisionBase.Float:
                            SQL += " AND (cast(replace(E.Location2, ',', '.') as float) <> E.AverageLatitudeCache OR cast(replace(E.Location1, ',', '.') as float) <> E.AverageLongitudeCache ";
                            break;
                        default:
                            SQL += " AND (E.Location2 <> CAST(E.AverageLatitudeCache AS nvarchar(255)) OR E.Location1 <> CAST(E.AverageLongitudeCache AS nvarchar(255)) ";
                            break;
                    }
                    SQL += " OR (E.Location1 <> '' and E.AverageLongitudeCache IS NULL) " +
                        " OR (E.Location2 <> '' and E.AverageLatitudeCache IS NULL))";
                    break;
            }
            try
            {
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(this._DtCheckGeography);
                this.dataGridViewCheckGeography.DataSource = this._DtCheckGeography;
                this.dataGridViewCheckGeography.Columns[0].Visible = false;
                for (int i = 2; i < this.dataGridViewCheckGeography.Columns.Count; i++)
                {
                    this.dataGridViewCheckGeography.Columns[i].ReadOnly = true;
                    this.dataGridViewCheckGeography.Columns[i].SortMode = DataGridViewColumnSortMode.Automatic;
                }
                this.dataGridViewCheckGeography.AllowUserToDeleteRows = false;
                this.dataGridViewCheckGeography.AllowUserToOrderColumns = false;
                this.dataGridViewCheckGeography.AllowUserToAddRows = false;
                this.dataGridViewCheckGeography.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                this.labelCheckGeographyMessage.Text = this.dataGridViewCheckGeography.Rows.Count.ToString() + " differences found";
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex, SQL);
            }

            //string Type = this.comboBoxCheckGeographyTypeOfComparision.SelectedItem.ToString();
            //switch (Type)
            //{
            //    case "Values <-> Geography":

            //        break;
            //}
            /*
             * Wrong cache values:
            SELECT  E.AverageLatitudeCache, E.Location2, E.AverageLongitudeCache, E.Location1, *
            FROM CollectionEventLocalisation E, CollectionSpecimen S, CollectionProject P
            WHERE E.CollectionEventID = S.CollectionEventID
            AND S.CollectionSpecimenID = P.CollectionSpecimenID
            AND (NOT E.AverageLatitudeCache between -90 and 90
            OR NOT E.AverageLongitudeCache between -180 and 180)
            AND P.ProjectID = 3
            */

            /*
             * Differences between Cache and Geography
            SELECT  E.Geography.Lat, E.AverageLatitudeCache, E.Location2, E.Geography.Long, E.AverageLongitudeCache, E.Location1, *
            FROM CollectionEventLocalisation E, CollectionSpecimen S, CollectionProject P
            WHERE E.CollectionEventID = S.CollectionEventID
            AND S.CollectionSpecimenID = P.CollectionSpecimenID
            AND E.Geography.ToString() <> geography::STPointFromText('POINT(' + replace(cast(E.[AverageLongitudeCache] as varchar), ',', '.')+' ' +replace(cast(E.[AverageLatitudeCache] as varchar), ',', '.')+')', 4326).ToString()
            AND E.Geography.ToString() LIKE 'POINT%'
            AND E.AverageLatitudeCache between -90 and 90
            AND E.AverageLongitudeCache between -180 and 180
            AND P.ProjectID = 3
             * */

            /*
             * Abweichende Vorzeichen
            SELECT  E.Geography.Lat, E.AverageLatitudeCache, E.Location2, E.Geography.Long, E.AverageLongitudeCache, E.Location1, *
            FROM CollectionEventLocalisation E, CollectionSpecimen S, CollectionProject P
            WHERE E.CollectionEventID = S.CollectionEventID
            AND S.CollectionSpecimenID = P.CollectionSpecimenID
            AND E.Geography.ToString() LIKE 'POINT%'
            AND E.AverageLatitudeCache between -90 and 90
            AND E.AverageLongitudeCache between -180 and 180
            AND (SIGN(E.Geography.Lat) <> SIGN(E.Geography.Lat)
            OR SIGN(E.Geography.Long) <> SIGN(E.Geography.Long))
            AND P.ProjectID = 3
             * */


            //string SQL = "";
            string SqlCheckGeographyWhereClause = "";
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonCheckGeographyUpdate_Click(object sender, EventArgs e)
        {
            if (this._DtCheckGeography == null)
                return;

            this.progressBarCheckGeography.Maximum = this._DtCheckGeography.Rows.Count;
            this.progressBarCheckGeography.Value = 0;
            int i = 0;
            int f = 0;
            GeographyComparisionType Type = GeographyComparisionType.ValueToGeo;
            foreach (System.Collections.Generic.KeyValuePair<GeographyComparisionType, string> KV in this.GeographyComparisionTypes)
            {
                if (KV.Value == this.comboBoxCheckGeographyTypeOfComparision.SelectedItem.ToString())
                {
                    Type = KV.Key;
                    break;
                }
            }
            foreach (System.Data.DataRow R in this._DtCheckGeography.Rows)
            {
                if (R["OK"].ToString().ToLower() == "true")
                {
                    string CollectionEventID = R[0].ToString();
                    string Latitude = R["Latitude"].ToString();
                    string Longitude = R["Longitude"].ToString();
                    string SQL = "UPDATE CollectionEventLocalisation SET ";
                    switch (Type)
                    {
                        case GeographyComparisionType.ValueToCache:
                            SQL += " AverageLatitudeCache = " + Latitude.Replace(",", ".") + ",  AverageLongitudeCache = " + Longitude.Replace(",", ".") + // Markus 13.11.23: Bugfix - hier muss auch , durch . ersetzt werden
                                " WHERE CollectionEventID = " + CollectionEventID + " AND LocalisationSystemID = " + this.comboBoxCheckGeographySystem.SelectedValue.ToString();
                            break;
                        case GeographyComparisionType.ValueToGeo:
                            SQL += "Geography = geography::STGeomFromText('POINT (" + Longitude.Replace(",", ".") + " " + Latitude.Replace(",", ".") + ")', 4326) " +
                                " WHERE CollectionEventID = " + CollectionEventID + " AND LocalisationSystemID = " + this.comboBoxCheckGeographySystem.SelectedValue.ToString();
                            break;
                    }
                    if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL))
                        i++;
                    else f++;
                }
                this.progressBarCheckGeography.Value++;
            }
            string Message = "Update for " + i.ToString() + " datasets finished";
            if (f > 0)
            {
                Message = "Update for " + f.ToString() + " datasets failed";
                if (i > 0) Message += "\r\nfor " + i.ToString() + " datasets successful";
            }
            else
                System.Windows.Forms.MessageBox.Show(Message);
            this.dataGridViewCheckGeography.DataSource = null;
        }

        private void buttonCheckGeographyAll_Click(object sender, EventArgs e)
        {
            // #173
            if (this._DtCheckGeography == null || this._DtCheckGeography.Rows.Count == 0)
                return;
            foreach (System.Data.DataRow R in this._DtCheckGeography.Rows)
                R["OK"] = true;
        }

        private void buttonCheckGeographyNone_Click(object sender, EventArgs e)
        {
            // #173
            if (this._DtCheckGeography == null || this._DtCheckGeography.Rows.Count == 0)
                return;
            foreach (System.Data.DataRow R in this._DtCheckGeography.Rows)
                R["OK"] = false;
        }

#endregion

#region Geography outside an area

        private System.Collections.Generic.List<string> _GeographyInAreaPlaceTypes;
        private System.Data.DataTable _dtGeographyInAreaCountry;
        private System.Data.DataTable _dtGeographyInArea;
        //private int _GeographyInAreaPlaceID;
        private string _GeographyInAreaPlaceGeography;
        private string _GeographyInAreaPlace;

        private int GeographyInAreaProjectID()
        {
            System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxGeographyInAreaProject.SelectedItem;
            int ProjectID;
            int.TryParse(R["ProjectID"].ToString(), out ProjectID);
            return ProjectID;
        }

        private void initGeographyInArea()
        {
            if (this._GeographyInAreaPlaceTypes == null)
            {
                this._GeographyInAreaPlaceTypes = new List<string>();
                this._GeographyInAreaPlaceTypes.Add("nation");
                this._GeographyInAreaPlaceTypes.Add("Bundesland");
                this._GeographyInAreaPlaceTypes.Add("Kreis");
            }
            this.listBoxGeographyInAreaPlaceTypes.Items.Clear();
            foreach (string s in this._GeographyInAreaPlaceTypes)
                this.listBoxGeographyInAreaPlaceTypes.Items.Add(s);
        }

        private void comboBoxGeographyInAreaProject_SelectedIndexChanged(object sender, EventArgs e)
        {
            this._dtGeographyInAreaCountry = null;
            this._dtGeographyInAreaLocalisationSystem = null;
            this.comboBoxGeographyInAreaCountry.DataSource = null;
        }

        private void comboBoxGeographyInAreaCountry_DropDown(object sender, EventArgs e)
        {
            try
            {
                if (this.comboBoxGeographyInAreaCountry.DataSource == null ||
                    this._dtGeographyInAreaCountry == null)
                {
                    string SQL = "SELECT DISTINCT E.CountryCache " +
                        "FROM CollectionEvent AS E INNER JOIN " +
                        "CollectionSpecimen AS S ON E.CollectionEventID = S.CollectionEventID INNER JOIN " +
                        "CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID " +
                        "WHERE P.ProjectID = " + this.GeographyInAreaProjectID().ToString() + " " +
                        "ORDER BY E.CountryCache";
                    string Message = "";
                    this._dtGeographyInAreaCountry = new DataTable();
                    DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref this._dtGeographyInAreaCountry, ref Message);
                    this.comboBoxGeographyInAreaCountry.DataSource = this._dtGeographyInAreaCountry;
                    this.comboBoxGeographyInAreaCountry.DisplayMember = "CountryCache";
                    this.comboBoxGeographyInAreaCountry.ValueMember = "CountryCache";
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        private void buttonGeographyInAreaPlaceTypesAdd_Click(object sender, EventArgs e)
        {
            string Prefix = "";
            if (this.GeographyInAreaSourceServerConnection != null)
                Prefix = this.GeographyInAreaSourceServerConnection.Prefix();
            string SQL = "SELECT [Code]  FROM " + Prefix + "PlaceType_Enum ";
            if (this._GeographyInAreaPlaceTypes.Count > 0)
            {
                string WhereClause = "";
                foreach (string s in this._GeographyInAreaPlaceTypes)
                {
                    if (WhereClause.Length > 0)
                        WhereClause += ", ";
                    WhereClause += "'" + s + "'";
                }
                SQL += " WHERE Code NOT IN (" + WhereClause + ")";
            }
            SQL += " ORDER BY Code";
            System.Data.DataTable dt = new DataTable();
            string Error = "";
            DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dt, ref Error);
            DiversityWorkbench.Forms.FormGetStringFromList f = new DiversityWorkbench.Forms.FormGetStringFromList(dt, "Please select a type");
            f.ShowDialog();
            if (f.DialogResult == System.Windows.Forms.DialogResult.OK && f.SelectedString.Length > 0)
            {
                this._GeographyInAreaPlaceTypes.Add(f.SelectedString);
                this.initGeographyInArea();
            }
        }

        private void buttonGeographyInAreaPlaceTypeRemove_Click(object sender, EventArgs e)
        {
            if (this.listBoxGeographyInAreaPlaceTypes.SelectedItem != null)
            {
                this._GeographyInAreaPlaceTypes.Remove(this.listBoxGeographyInAreaPlaceTypes.SelectedItem.ToString());
                this.initGeographyInArea();
            }
        }

        private System.Data.DataTable _dtGeographyInAreaLocalisationSystem;

        private void comboBoxGeographyInAreaLocalisationSystem_DropDown(object sender, EventArgs e)
        {
            try
            {
                if (this._dtGeographyInAreaLocalisationSystem == null)
                {
                    this._dtGeographyInAreaLocalisationSystem = new DataTable();
                    string SQL = "SELECT NULL AS LocalisationSystemID, NULL AS LocalisationSystemName " +
                        "UNION " +
                        "SELECT DISTINCT L.LocalisationSystemID, L.LocalisationSystemName " +
                        "FROM LocalisationSystem AS L INNER JOIN " +
                        "CollectionEventLocalisation AS E ON L.LocalisationSystemID = E.LocalisationSystemID INNER JOIN " +
                        "CollectionSpecimen AS S INNER JOIN " +
                        "CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID ON E.CollectionEventID = S.CollectionEventID " +
                        "WHERE P.ProjectID = " + this.GeographyInAreaProjectID().ToString() + " " +
                        "ORDER BY LocalisationSystemName";
                    string Message = "";
                    DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref this._dtGeographyInAreaLocalisationSystem, ref Message);
                    this.comboBoxGeographyInAreaLocalisationSystem.DataSource = this._dtGeographyInAreaLocalisationSystem;
                    this.comboBoxGeographyInAreaLocalisationSystem.DisplayMember = "LocalisationSystemName";
                    this.comboBoxGeographyInAreaLocalisationSystem.ValueMember = "LocalisationSystemID";
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        private DiversityWorkbench.ServerConnection GeographyInAreaSourceServerConnection
        {
            get
            {
                try
                {
                    System.Collections.Generic.Dictionary<string, DiversityWorkbench.ServerConnection> DD = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList();
                    return DD[this.comboBoxGeographyInAreaSource.SelectedItem.ToString()];
                }
                catch (System.Exception ex)
                {
                    return null;
                }
            }
        }

        private void comboBoxGeographyInAreaSource_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (this.GeographyInAreaSourceServerConnection != null &&
                this.GeographyInAreaSourceServerConnection.DatabaseName.Length > 0)
                this.labelGeographyInAreaSource.Text = "Source: " + this.GeographyInAreaSourceServerConnection.DatabaseName;
        }

        private void buttonGeographyInAreaFindPlace_Click(object sender, EventArgs e)
        {
            try
            {
                string SQL = "";
                string Prefix = this.GeographyInAreaSourceServerConnection.Prefix();
                foreach (string s in this._GeographyInAreaPlaceTypes)
                {
                    if (SQL.Length > 0) SQL += ", ";
                    SQL += "N'" + s + "'";
                }
                if (SQL.Length > 0)
                {
                    SQL = "SELECT N.Name, P.Geography " +
                        "FROM " + Prefix + "GeoName AS N INNER JOIN " +
                        "" + Prefix + "ViewGeoPlace AS P ON N.PlaceID = P.PlaceID AND N.NameID = P.PreferredNameID " +
                        "WHERE (P.PlaceType IN (" + SQL + ")) and (P.Geography LIKE 'MultiPolygon%' OR P.Geography LIKE 'Polygon%')";
                    this._GeographyInAreaPlaceGeography = "";
                    System.Data.DataTable dt = new DataTable();
                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, this.GeographyInAreaSourceServerConnection.ConnectionString);
                    ad.Fill(dt);
                    if (dt.Rows.Count > 0)
                    {
                        DiversityWorkbench.Forms.FormGetStringFromList f = new DiversityWorkbench.Forms.FormGetStringFromList(dt, "Name", "Geography", "Place", "Please select a place for comparision");
                        f.ShowDialog();
                        if (f.DialogResult == System.Windows.Forms.DialogResult.OK)
                        {
                            this._GeographyInAreaPlaceGeography = f.SelectedValue;
                            this._GeographyInAreaPlace = f.SelectedString;
                            this.labelGeographyInAreaPlace.Text = f.SelectedString;
                        }
                    }
                    else
                        System.Windows.Forms.MessageBox.Show("No valid places found");
                }
                else
                    System.Windows.Forms.MessageBox.Show("Please select at least on place type");
            }
            catch (System.Exception ex)
            {
            }
        }

        private void buttonGeographyInAreaStartSearch_Click(object sender, EventArgs e)
        {
            try
            {
                if (this._GeographyInAreaPlace.Length == 0 || this._GeographyInAreaPlaceGeography.Length == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please choose an area for comparision");
                    return;
                }
                string Prefix = "";
                if (this.GeographyInAreaSourceServerConnection != null)
                    Prefix = this.GeographyInAreaSourceServerConnection.Prefix();
                string SQL = "SELECT ";
                if (this.checkBoxGeographyInAreaTop.Checked)
                    SQL += " TOP " + this.maskedTextBoxGeographyInAreaTop.Text;
                SQL += " MAX(S.CollectionSpecimenID) AS CollectionSpecimenID, " +
                    "E.LocalityDescription AS [Locality], E.CountryCache AS [Country], " +
                    "Y.DisplayText AS [Localisation], " +
                    "L.Location1 AS [Location 1], L.Location2 AS [Location 2] " +
                    "FROM CollectionEvent AS E INNER JOIN " +
                    "CollectionSpecimen AS S ON E.CollectionEventID = S.CollectionEventID INNER JOIN " +
                    "CollectionProject AS P ON P.CollectionSpecimenID = S.CollectionSpecimenID INNER JOIN " +
                    "CollectionEventLocalisation AS L ON E.CollectionEventID = L.CollectionEventID INNER JOIN " +
                    "LocalisationSystem AS Y ON Y.LocalisationSystemID = L.LocalisationSystemID " +
                    "WHERE P.ProjectID = " + this.comboBoxGeographyInAreaProject.SelectedValue.ToString() + " " +
                    "and geography::STGeomFromText('" + this._GeographyInAreaPlaceGeography + "', 4326).STDisjoint(L.Geography) = 1 " +
                    "AND NOT L.Geography IS NULL ";
                if (this.comboBoxGeographyInAreaCountry.SelectedIndex > 0)
                    SQL += " AND E.CountryCache = '" + this.comboBoxGeographyInAreaCountry.SelectedValue.ToString() + "' ";
                if (this.comboBoxGeographyInAreaLocalisationSystem.SelectedIndex > 0)
                    SQL += " AND L.LocalisationSystemID = " + this.comboBoxGeographyInAreaLocalisationSystem.SelectedValue.ToString() + " ";
                if (this.textBoxGeographyInAreaLocalityDescriptio.Text.Length > 0)
                {
                    if (this.textBoxGeographyInAreaLocalityDescriptio.Text.IndexOf("%") > -1 ||
                        this.textBoxGeographyInAreaLocalityDescriptio.Text.IndexOf("_") > -1)
                        SQL += " AND E.LocalityDescription LIKE '" + this.SqlValueLike( this.textBoxGeographyInAreaLocalityDescriptio.Text, SqlValueType.QueryRestriction) + "' ";
                    else
                        SQL += " AND E.LocalityDescription = '" + this.SqlValueLike(this.textBoxGeographyInAreaLocalityDescriptio.Text, SqlValueType.QueryRestriction) + "' ";
                }
                SQL += "GROUP BY E.LocalityDescription, E.CountryCache, L.Location1, L.Location2, Y.DisplayText";
                string Message = "";
                this._dtGeographyInArea = new DataTable();
                DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref this._dtGeographyInArea, ref Message);
                if (Message.Length > 0)
                    System.Windows.Forms.MessageBox.Show(Message.Substring(0, 2000));
                else
                {
                    this.dataGridViewGeographyInArea.DataSource = this._dtGeographyInArea;
                    this.dataGridViewGeographyInArea.Columns[0].Visible = false;
                    this.labelGeographyInAreaResult.Text = this._dtGeographyInArea.Rows.Count.ToString() + " coordinates outside " + this._GeographyInAreaPlace;
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        private void buttonGeographyInAreaCheckDataset_Click(object sender, EventArgs e)
        {
            int Position = this.dataGridViewGeographyInArea.SelectedCells[0].RowIndex;
            if (int.TryParse(this.dataGridViewGeographyInArea.Rows[Position].Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
            {
                DiversityCollection.Forms.FormCollectionSpecimen f = new Forms.FormCollectionSpecimen(this._CollectionSpecimenID, false, false);
                f.setViewMode(Forms.FormCollectionSpecimen.ViewMode.SingleInspectionMode);
                f.Width = this.Width - 10;
                f.Height = this.Height - 10;
                f.ShowDialog();
            }
        }

        private void buttonGeographyInAreaEditResults_Click(object sender, EventArgs e)
        {
            if (this._dtGeographyInArea == null ||
                this._dtGeographyInArea.Rows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }
            if (this._CollectionSpecimenIDs == null)
                this._CollectionSpecimenIDs = new List<int>();
            this._CollectionSpecimenIDs.Clear();
            if (this.dataGridViewGeographyInArea.SelectedRows.Count == 0)
            {
                foreach (System.Data.DataRow R in this._dtGeographyInArea.Rows)
                {
                    if (this._CollectionSpecimenIDs.Contains(int.Parse(R["CollectionSpecimenID"].ToString())))
                        continue;
                    this.CollectionSpecimenIDs.Add(int.Parse(R["CollectionSpecimenID"].ToString()));
                }
            }
            else
            {
                foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewGeographyInArea.SelectedRows)
                {
                    if (this._CollectionSpecimenIDs.Contains(int.Parse(R.Cells[0].Value.ToString())))
                        continue;
                    this.CollectionSpecimenIDs.Add(int.Parse(R.Cells[0].Value.ToString()));
                }
            }
            this._ShowList = true;
            this._ShowListQueryHeader = "Outside area";
            this._ShowListQueryDescription = "Coordinates outside " + this._GeographyInAreaPlace;
            this.DialogResult = DialogResult.OK;
            this.Close();
        }

#endregion

#endregion

#region Coordinates for TK25

        private int? _TK25Differences;
        private System.Data.DataTable _DtTK25;
        private string _TK25SourceDatabaseConnectionString;
        private string _TK25BaseURL;
        private string _TK25Module = "DiversityGazetteer";

        private void setTK25DatabaseParameters()
        {
            //if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()[this._TK25Module].DataBaseURIs().TryGetValue(this.comboBoxTK25Source.Text, out this._TK25BaseURL))
            //{
            //    this._TK25SourceDatabaseConnectionString = this.comboBoxTK25Source.SelectedItem.ToString();
            //    this._SynchronizeColTaxTextConnectionString = DiversityWorkbench.Settings.ConnectionString;
            //    this._SynchronizeColTaxTextSameServer = true;
            //    foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnections())
            //    {
            //        if (KV.Value.DisplayText == this._SynchronizeColTaxTextTaxonDatabase)
            //        {
            //            this._SynchronizeColTaxTextConnectionString = KV.Value.ConnectionString;
            //            this._SynchronizeColTaxTextTaxonDatabase = KV.Value.DatabaseName;
            //            this._SynchronizeColTaxTextBaseURL = KV.Value.BaseURL;
            //            if (KV.Value.DatabaseServer != DiversityWorkbench.Settings.DatabaseServer)
            //                this._SynchronizeColTaxTextSameServer = false;
            //        }
            //    }
            //    this.labelSynColTaxTextTaxonNameProjec.Visible = true;
            //    this.comboBoxSynColTaxTextTaxonNameProject.Visible = true;
            //    this.comboBoxSynColTaxTextTaxonNameProject_DropDown(null, null);
            //    this.radioButtonSynColTaxTextCompareParts.Enabled = true;
            //    this.numericUpDownSynColTaxTextCompareParts.Enabled = true;
            //    this.panelSynColTaxTextCompareParts.Enabled = true;
            //}
            //else
            //{
            //    this.labelSynColTaxTextTaxonNameProjec.Visible = false;
            //    this.comboBoxSynColTaxTextTaxonNameProject.Visible = false;
            //    this.radioButtonSynColTaxTextCompareParts.Enabled = false;
            //    this.numericUpDownSynColTaxTextCompareParts.Enabled = false;
            //    this.panelSynColTaxTextCompareParts.Enabled = false;
            //}
            //this.dataGridViewSynColTaxText.DataSource = null;
            //this._dtSynColTaxText = new DataTable();
            //this.radioButtonSynColTaxTextCompareAll.Checked = true;
        }

        private void buttonTK25Search_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.TK25SourceConnectionString.Length == 0)
                {
                    System.Windows.Forms.MessageBox.Show("No valid source found");
                    return;
                }
                string TopSql = "";
                if (this.checkBoxTK25RestrictLines.Checked)
                    TopSql = "TOP " + this.numericUpDownTK25Lines.Value.ToString();
                string SQL = "SELECT DISTINCT " + TopSql + " CAST(1 AS bit) AS OK, L.CollectionEventID, L.LocalisationSystemID, L.Location1 AS TK25, L.Location2 AS Quadrant, L.Geography.ToString() AS [Geography in DiversityCollection],  " +
                    "L.AverageLatitudeCache AS [Latitude in DiversityCollection], L.AverageLongitudeCache AS [Longitude in DiversityCollection], CAST(NULL AS float) AS Latitude, CAST(NULL AS float) AS Longitude, CAST(NULL AS varchar(500)) AS Geography "
                    + this.SqlFromClauseTK25;
                SQL += " ORDER BY TK25, Quadrant ";
                this._DtTK25 = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(this._DtTK25);
                this.GetCoordinatesForTK25();
                this.dataGridViewTK25.DataSource = this._DtTK25;
                this.dataGridViewTK25.AllowUserToAddRows = false;
                this.dataGridViewTK25.Columns[0].Width = 30;
                this.dataGridViewTK25.Columns[1].Visible = false;
                this.dataGridViewTK25.Columns[2].Visible = false;
                for (int ii = 3; ii < this.dataGridViewTK25.Columns.Count; ii++)
                    this.dataGridViewTK25.Columns[ii].ReadOnly = true;
                _TK25Differences = 0;
                foreach (System.Data.DataRow R in this._DtTK25.Rows)
                {
                    if (R.RowState != DataRowState.Deleted)
                    {
                        if (R["Geography in DiversityCollection"].ToString() != R["Geography"].ToString())
                            _TK25Differences++;
                    }
                }
                //_TK25Differences = i
                //SQL = "SELECT COUNT(DISTINCT L.CollectionEventID) " + this.SqlFromClauseTK25;
                //if (int.TryParse(DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL), out i))
                //    _TK25Differences = i;
                //else _TK25Differences = null;
                if (_TK25Differences != null)
                    this.labelTK25Message.Text = _TK25Differences.ToString() + " differences found";
                else
                    this.labelTK25Message.Text = "";
                if (_TK25Differences != null && _TK25Differences > 0)
                {
                    this.buttonTK25CheckDataset.Enabled = true;
                    this.buttonTK25Update.Enabled = true;
                }
                else
                {
                    this.buttonTK25CheckDataset.Enabled = false;
                    this.buttonTK25Update.Enabled = false;
                }
            }
            catch (System.Exception ex) { }
        }

        private void GetCoordinatesForTK25()
        {
            // #173
            if (this._DtTK25 == null || this._DtTK25.Rows.Count == 0)
                return;

            string ConnectionString = this.TK25SourceConnectionString;
            this.progressBarTK25.Value = 0;
            this.progressBarTK25.Maximum = this._DtTK25.Rows.Count;
            System.Collections.Generic.List<System.Data.DataRow> RowsToRemove = new List<DataRow>();
            foreach (System.Data.DataRow R in this._DtTK25.Rows)
            {
                try
                {
                    float Lat = 0;
                    float Long = 0;
                    string Geo = "";
                    System.Collections.Generic.Dictionary<string, DiversityWorkbench.ServerConnection> DD = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList();
                    string LinkedServer = DD[this.comboBoxTK25Source.SelectedItem.ToString()].LinkedServer;

                    if (DiversityWorkbench.Forms.FormTK25.GetGeographyOfTK25(R["TK25"].ToString(), R["Quadrant"].ToString(), DD[this.comboBoxTK25Source.SelectedItem.ToString()], ref Geo, ref Lat, ref Long))
                    {
                        if (Lat == 0 || Long == 0 || Geo.Length == 0)
                        {
                            R["OK"] = false;
                        }
                        else
                        {
                            R["Latitude"] = Lat;
                            R["Longitude"] = Long;
                            R["Geography"] = Geo;
                        }
                        if (R["Geography in DiversityCollection"].ToString() == R["Geography"].ToString() &&
                            R["Latitude in DiversityCollection"].ToString() == R["Latitude"].ToString() &&
                             R["Longitude in DiversityCollection"].ToString() == R["Longitude"].ToString())
                        {
                            R["OK"] = false;
                        }
                        if (R["OK"].ToString().ToLower() == "false")
                            RowsToRemove.Add(R);
                        else
                        {
                        }
                    }
                    else
                    {
                        R["OK"] = false;
                        RowsToRemove.Add(R);
                    }
                    if (this.progressBarTK25.Value < this.progressBarTK25.Maximum)
                        this.progressBarTK25.Value++;
                }
                catch (System.Exception ex) { }
            }
            foreach (System.Data.DataRow r in RowsToRemove)
                r.Delete();
        }

        private void buttonTK25CheckDataset_Click(object sender, EventArgs e)
        {
            int EventID;
            if (int.TryParse(this._DtTK25.Rows[this.dataGridViewTK25.SelectedCells[0].RowIndex]["CollectionEventID"].ToString(), out EventID))
            {
                string SQL = "SELECT MIN(S.CollectionSpecimenID) FROM CollectionSpecimen S, CollectionSpecimenID_UserAvailable A WHERE S.CollectionEventID = " + EventID.ToString() +
                    " AND S.CollectionSpecimenID = A.CollectionSpecimenID";
                int SpecimenID;
                if (int.TryParse(DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL), out SpecimenID))
                {
                    this._CollectionSpecimenID = SpecimenID;
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
            }
        }

        private string TK25SourceConnectionString
        {
            get
            {
                try
                {
                    string ConnectionString = "";
                    System.Collections.Generic.Dictionary<string, DiversityWorkbench.ServerConnection> DD = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList();
                    string SelectedItem = this.comboBoxTK25Source.SelectedItem.ToString();
                    if (DD.ContainsKey(SelectedItem))
                        ConnectionString = DD[SelectedItem].ConnectionString;
                    else
                    {
                        SelectedItem = SelectedItem.Substring(0, SelectedItem.IndexOf(" ")).Trim();
                        if (DD.ContainsKey(SelectedItem))
                            ConnectionString = DD[SelectedItem].ConnectionString;
                    }
                    return ConnectionString;
                }
                catch (System.Exception ex)
                {
                    return "";
                }


                //string ConnectionString = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()[this._TK25Module].ServerConnection.ConnectionString;

                //System.Collections.Generic.Dictionary<string, DiversityWorkbench.ServerConnection> SCL = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()[this._TK25Module].ServerConnectionList();
                //if (SCL.Count > 0)
                //{
                //    foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KV in SCL)
                //    {
                //        if (KV.Value.ConnectionIsValid)
                //        {
                //            ConnectionString = KV.Value.ConnectionString;
                //            break;
                //        }
                //    }
                //}
            }
        }

        private string SqlFromClauseTK25
        {
            get
            {
                string SQL = "";
                try
                {
                    SQL = " FROM CollectionEventLocalisation AS L INNER JOIN " +
                        "CollectionSpecimen AS S ON L.CollectionEventID = S.CollectionEventID INNER JOIN " +
                        "CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID " +
                        "WHERE     (L.LocalisationSystemID = 3) AND (P.ProjectID = " + this.comboBoxTK25Project.SelectedValue.ToString() + ") ";
                    if (this.checkBoxTK25RestrictToEmpty.Checked)
                        SQL += " AND L.Geography IS NULL ";
                }
                catch { }
                return SQL;
            }
        }

        private void buttonTK25Update_Click(object sender, EventArgs e)
        {
            // #173
            if (this._DtTK25 == null || this._DtTK25.Rows.Count == 0) return;

            try
            {
                string SQL = "";
                this.progressBarTK25.Value = 0;
                this.progressBarTK25.Maximum = this._DtTK25.Rows.Count;
                string Message = "";
                int iFailed = 0;
                int iSuccess = 0;
                int i = 0;
                this._DtTK25.AcceptChanges();
                foreach (System.Data.DataRow R in this._DtTK25.Rows)
                {
                    if (R["OK"].ToString() == "True")
                    {
                        SQL = "UPDATE L SET L.Geography = geography::STGeomFromText('" + R["Geography"].ToString() + "', 4326)"
                            + ", L.AverageLatitudeCache = " + R["Latitude"].ToString()
                            + ", L.AverageLongitudeCache = " + R["Longitude"].ToString() + this.SqlFromClauseTK25
                            + " AND L.CollectionEventID = " + R["CollectionEventID"].ToString();
                        if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL))
                        {
                            iSuccess++;
                            this.dataGridViewTK25.Rows[i].DefaultCellStyle.BackColor = System.Drawing.Color.LightGreen;
                        }
                        else
                        {
                            iFailed++;
                            this.dataGridViewTK25.Rows[i].DefaultCellStyle.BackColor = System.Drawing.Color.Pink;
                        }
                    }
                    if (this.progressBarTK25.Value < this.progressBarTK25.Maximum)
                        this.progressBarTK25.Value++;
                    i++;
                }
                if (iFailed > 0)
                    Message = "Update for " + iFailed.ToString() + " datasets failed\r\n";
                if (iSuccess > 0)
                    Message += iSuccess.ToString() + " datasets updated";
                System.Windows.MessageBox.Show(Message);
            }
            catch (System.Exception ex)
            {
            }
        }

#endregion

#region TK25 for coordinates

        private System.Data.DataTable _DtTK25forCoordinates;

        private void initTK25forCoordinates()
        {
            this.comboBoxTK25forCoordinatesQuadrant.SelectedIndex = 1;
        }

        private void comboBoxTK25forCoordinatesSource_DropDown(object sender, EventArgs e)
        {
            this.initTK25Database();
        }

        private void buttonTK25forCoordinatesSearch_Click(object sender, EventArgs e)
        {
            try
            {
                string SQL = "SELECT DISTINCT ";
                if (this.checkBoxTK25forCoordinatesRestrictToTop.Checked)
                    SQL += " TOP " + this.numericUpDownTK25forCoordinatesRestrictToTop.Value.ToString();
                SQL += " CAST(1 AS bit) AS OK, W.CollectionEventID, CAST('' AS varchar(4)) AS TK25, CAST('' AS varchar(4)) AS Quadrant, CAST('' AS nvarchar(400)) AS TK25_Name, " +
                    "CAST(0 AS float) AS CenterLatitude, CAST(0 AS float) AS CenterLongitude, CAST('' as varchar(500)) AS Geography, " +
                    "W.Geography.Lat AS Latitude, W.Geography.Long AS Longitude " +
                    "FROM CollectionEventLocalisation AS W INNER JOIN " +
                    "CollectionSpecimen AS S ON W.CollectionEventID = S.CollectionEventID INNER JOIN " +
                    "CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID " +
                    "LEFT OUTER JOIN CollectionEventLocalisation T ON T.CollectionEventID = S.CollectionEventID AND T.LocalisationSystemID = 3 " +
                    "WHERE (NOT (W.Geography IS NULL)) AND (W.LocalisationSystemID = 8) " +
                    "AND P.ProjectID = " + this.comboBoxTK25forCoordinatesProject.SelectedValue.ToString() +
                    "  AND T.CollectionEventID IS NULL";
                if (this.checkBoxTK25forCoordinatesRestrictToLatitude.Checked &&
                    this.textBoxTK25forCoordinatesRestrictToLatFrom.Text.Length > 0 &&
                    this.textBoxTK25forCoordinatesRestrictToLatTo.Text.Length > 0)
                    SQL += " AND W.Geography.EnvelopeCenter().Lat BETWEEN " + this.textBoxTK25forCoordinatesRestrictToLatFrom.Text + " AND " + this.textBoxTK25forCoordinatesRestrictToLatTo.Text + " ";
                if (this.checkBoxTK25forCoordinatesRestrictToLongitude.Checked &&
                    this.textBoxTK25forCoordinatesRestrictToLongFrom.Text.Length > 0 &&
                    this.textBoxTK25forCoordinatesRestrictToLongTo.Text.Length > 0)
                    SQL += " AND W.Geography.EnvelopeCenter().Long BETWEEN " + this.textBoxTK25forCoordinatesRestrictToLongFrom.Text + " AND " + this.textBoxTK25forCoordinatesRestrictToLongTo.Text + " ";
                if (this._DtTK25forCoordinates == null)
                    this._DtTK25forCoordinates = new DataTable();
                else
                    this._DtTK25forCoordinates.Clear();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityWorkbench.Settings.TimeoutDatabase));
                ad.SelectCommand.CommandTimeout = DiversityWorkbench.Settings.TimeoutDatabase;
                ad.Fill(this._DtTK25forCoordinates);
                this.progressBarTK25forCoordinates.Maximum = this._DtTK25forCoordinates.Rows.Count;
                this.progressBarTK25forCoordinates.Value = 0;
                this.dataGridViewTK25forCoordinates.DataSource = this._DtTK25forCoordinates;
                for (int i = 1; i < this._DtTK25forCoordinates.Columns.Count; i++)
                {
                    this.dataGridViewTK25forCoordinates.Columns[i].ReadOnly = true;
                }
                this.dataGridViewTK25forCoordinates.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                this.FindTK25forCoordintes();
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private void FindTK25forCoordintes()
        {
            // #173
            if (this._DtTK25forCoordinates == null || this._DtTK25forCoordinates.Rows.Count == 0) return;

            System.Collections.Generic.List<System.Data.DataRow> RowsToRemove = new List<DataRow>();
            string Message = "";
            int iNoTK = 0;
            int iTK = 0;
            foreach (System.Data.DataRow R in this._DtTK25forCoordinates.Rows)
            {
                if (this.progressBarTK25forCoordinates.Value < this.progressBarTK25forCoordinates.Maximum)
                    this.progressBarTK25forCoordinates.Value++;
                string SQL = "SELECT TOP 1 PlaceID, SuperiorPlaceID, Polygon, TK25, TK25_Name, (Lat1 + Lat2) / 2 AS CenterLatitude, (Lon1 + Lon3) / 2 AS CenterLongitude " +
                    ", Point1, Point2, Point3, Point4 " +
                    "FROM " + TK25SourcePrefix() + "ViewTK25 AS T " +
                    "WHERE (" + R["Latitude"].ToString() + " BETWEEN Lat2 AND Lat1) AND (" + R["Longitude"].ToString() + " BETWEEN Lon1 AND Lon4) ";
                System.Data.DataTable dt = new DataTable();
                try
                {
                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, this._TK25ServerConnection.ConnectionString);
                    ad.Fill(dt);

                    // the outline of the plot
                    if (dt.Rows.Count > 0)
                    {
                        R["TK25"] = dt.Rows[0]["TK25"];
                        R["TK25_Name"] = dt.Rows[0]["TK25_Name"];
                        R["CenterLatitude"] = dt.Rows[0]["CenterLatitude"];
                        R["CenterLongitude"] = dt.Rows[0]["CenterLongitude"];
                        R["Geography"] = dt.Rows[0]["Polygon"];
                        float Longitude;
                        float Latitude;
                        if (float.TryParse(R["Longitude"].ToString(), out Longitude) &&
                            float.TryParse(R["Latitude"].ToString(), out Latitude))
                        {
                            int Depth = this.QuadrantLevel;
                            System.Drawing.RectangleF Quadrant = new RectangleF();
                            R["Quadrant"] = DiversityWorkbench.Gazetteer.QuadrantForTK25(Longitude, Latitude,
                                dt.Rows[0]["Point1"].ToString(),
                                dt.Rows[0]["Point2"].ToString(),
                                dt.Rows[0]["Point3"].ToString(),
                                dt.Rows[0]["Point4"].ToString(),
                                ref Depth,
                                ref Quadrant);
                            //POLYGON ((11.3319926263951 48.1990697376023, 11.331995182559 48.0990806099573, 11.4986393139198 48.0990825581473, 11.4986366173793 48.1990717269082, 11.3319926263951 48.1990697376023))

                            string Polygon = "POLYGON " +
                                "((" + (Quadrant.X).ToString() + " " + (Quadrant.Y + Quadrant.Height).ToString() +
                                ", " + (Quadrant.X).ToString() + " " + (Quadrant.Y).ToString() +
                                ", " + (Quadrant.X + Quadrant.Width).ToString() + " " + (Quadrant.Y).ToString() +
                                ", " + (Quadrant.X + Quadrant.Width).ToString() + " " + (Quadrant.Y + Quadrant.Height).ToString() +
                                ", " + (Quadrant.X).ToString() + " " + (Quadrant.Y + Quadrant.Height).ToString() + "))";
                            R["Geography"] = Polygon;
                            R["CenterLatitude"] = (Quadrant.Y + Quadrant.Height / 2).ToString();
                            R["CenterLongitude"] = (Quadrant.X + Quadrant.Width / 2).ToString();
                            iTK++;
                        }
                        else
                        {
                            RowsToRemove.Add(R);
                        }
                    }
                    else
                    {
                        RowsToRemove.Add(R);
                    }
                }
                catch (System.Exception ex)
                {
                    RowsToRemove.Add(R);
                }
            }
            foreach (System.Data.DataRow R in RowsToRemove)
            {
                R.Delete();
                iNoTK++;
            }
            this._DtTK25forCoordinates.AcceptChanges();
            this.labelTK25forCoordinatesSearch.Text = (iNoTK + iTK).ToString() + " Checked\r\n" +
                iTK.ToString() + " TK25 found\r\n" +
                iNoTK.ToString() + " without corresponding TK25";
        }

        private void buttonTK25forCoordinatesCheckAll_Click(object sender, EventArgs e)
        {
            // #173
            if (this._DtTK25forCoordinates == null || this._DtTK25forCoordinates.Rows.Count == 0) return;

            foreach (System.Data.DataRow R in this._DtTK25forCoordinates.Rows)
            {
                R["OK"] = true;
            }
        }

        private void buttonTK25forCoordinatesCheckNone_Click(object sender, EventArgs e)
        {
            // #173
            if (this._DtTK25forCoordinates == null || this._DtTK25forCoordinates.Rows.Count == 0) return;

            foreach (System.Data.DataRow R in this._DtTK25forCoordinates.Rows)
            {
                R["OK"] = false;
            }
        }

        private void buttonTK25forCoordinatesCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewTK25forCoordinates.SelectedRows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewTK25forCoordinates.SelectedRows[0];
            bool OK = true;
            string CollectionEventID = "";
            try { CollectionEventID = R.Cells["CollectionEventID"].Value.ToString(); }
            catch { OK = false; }
            if (OK)
            {
                string SQL = "SELECT MIN(CollectionSpecimenID) FROM CollectionSpecimen WHERE CollectionEventID = " + CollectionEventID;
                string CollectionSpecimenID = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL);
                if (int.TryParse(CollectionSpecimenID, out this._CollectionSpecimenID))
                {
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                else
                    this.DialogResult = DialogResult.Cancel;
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            }

        }

        private void buttonTK25forCoordinatesStartInsert_Click(object sender, EventArgs e)
        {
            // #173
            if (this._DtTK25forCoordinates == null || this._DtTK25forCoordinates.Rows.Count == 0) return;

            try
            {
                this.progressBarTK25forCoordinates.Value = 0;
                int iSkipped = 0;
                System.Collections.Generic.List<System.Data.DataRow> RowsInserted = new List<DataRow>();
                foreach (System.Data.DataRow R in this._DtTK25forCoordinates.Rows)
                {
                    if (this.progressBarTK25forCoordinates.Value < this.progressBarTK25forCoordinates.Maximum)
                        this.progressBarTK25forCoordinates.Value++;
                    if (R["OK"].ToString() == "0")
                    {
                        iSkipped++;
                        continue;
                    }
                    string SQL = "INSERT INTO CollectionEventLocalisation " +
                        "(CollectionEventID, LocalisationSystemID, Location1, Location2, LocationNotes, Geography, AverageLatitudeCache, AverageLongitudeCache) " +
                        "VALUES (" + R["CollectionEventID"].ToString() +
                        ", 3 " +
                        ", '" + R["TK25"].ToString() + "' " +
                        ", '" + R["Quadrant"].ToString() + "' " +
                        ", '" + R["TK25_Name"].ToString() + "' " +
                        ", geography::STGeomFromText('" + R["Geography"].ToString() + "', 4326) " +
                        ", " + R["CenterLatitude"].ToString() +
                        ", " + R["CenterLongitude"].ToString() + ")";
                    if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL))
                        RowsInserted.Add(R);
                }
                foreach (System.Data.DataRow R in RowsInserted)
                    R.Delete();
                this._DtTK25forCoordinates.AcceptChanges();
                string Message = "";
                if (this._DtTK25forCoordinates.Rows.Count > 0)
                    Message = "Insert failed for " + this._DtTK25forCoordinates.Rows.Count.ToString() + " Rows";
                else
                    Message = "Insert done";
                if (iSkipped > 0)
                    Message += "\r\n" + iSkipped.ToString() + " skipped";
                this.progressBarTK25forCoordinates.Value = 0;
                System.Windows.Forms.MessageBox.Show(Message);
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                this.progressBarTK25forCoordinates.Value = 0;
            }
        }

        private int QuadrantLevel
        {
            get
            {
                int i = 1;
                switch (this.comboBoxTK25forCoordinatesQuadrant.Text)
                {
                    case "1":
                        i = 0;
                        break;
                    case "1/4":
                        i = 1;
                        break;
                    case "1/16":
                        i = 2;
                        break;
                    case "1/64":
                        i = 3;
                        break;
                    case "1/256":
                        i = 4;
                        break;
                    case "1/1024":
                        i = 5;
                        break;
                }
                return i;
            }
        }

#region TK25 source Database

        private string _TK25ConnectionString;

        private static string _TK25SourcePrefix;
        private static string TK25SourcePrefix()
        {
            return _TK25SourcePrefix;
        }

        private DiversityWorkbench.ServerConnection _TK25ServerConnection;

        private bool initTK25Database()
        {
            try
            {
                if (this._TK25ConnectionString == null)
                    this._TK25ConnectionString = DiversityWorkbench.Settings.ConnectionString;
                if (this._TK25ConnectionString != null && this._TK25ConnectionString.Length > 0)
                {
                    DiversityWorkbench.ServerConnection SC = new DiversityWorkbench.ServerConnection(this._TK25ConnectionString);
                    DiversityWorkbench.Gazetteer G = new DiversityWorkbench.Gazetteer(SC);                //G.DatabaseList();
                    string Service = G.ServiceName();

                    this.comboBoxTK25forCoordinatesSource.Items.Clear();
                    int i = 0;
                    foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.ServerConnection> KVconn in DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList())
                    {
                        if (!this.comboBoxTK25forCoordinatesSource.Items.Contains(KVconn.Value.DisplayText))
                        {
                            bool OK = false;
                            string SQL = "SELECT COUNT(*) FROM " + KVconn.Value.Prefix() + "ViewTK25";
                            string Result = "";
                            Result = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL);
                            int ii = 0;
                            if (int.TryParse(Result, out ii) && ii > 0)
                                OK = true;
                            if (OK)
                            {
                                this.comboBoxTK25forCoordinatesSource.Items.Add(KVconn.Value.DisplayText);
                                if (KVconn.Value.ConnectionString == this._TK25ConnectionString)
                                    this.comboBoxTK25forCoordinatesSource.SelectedIndex = i;
                                i++;
                            }
                        }
                    }
                    if (this.comboBoxTK25forCoordinatesSource.SelectedIndex == -1)
                    {
                        this._TK25ConnectionString = G.ServerConnection.ConnectionString;
                    }
                    else
                    {
                        System.Collections.Generic.Dictionary<string, DiversityWorkbench.ServerConnection> DD = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList();
                        this._TK25ServerConnection = DD[this.comboBoxTK25forCoordinatesSource.SelectedItem.ToString()];
                        _TK25SourcePrefix = this._TK25ServerConnection.Prefix();
                    }
                }
                if (this.comboBoxTK25forCoordinatesSource.Items.Count > 0)
                    return true;
                else return false;
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                return false;
            }
        }

        private void comboBoxDatabase_SelectionChangeCommitted(object sender, EventArgs e)
        {
            try
            {
                System.Collections.Generic.Dictionary<string, DiversityWorkbench.ServerConnection> DD = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityGazetteer"].ServerConnectionList();
                this._TK25ServerConnection = DD[this.comboBoxTK25forCoordinatesSource.SelectedItem.ToString()];
                _TK25SourcePrefix = this._TK25ServerConnection.Prefix();
            }
            catch (System.Exception ex) { }

        }

#endregion

#endregion

#region Coordinates outside TK25

        private System.Data.DataTable _DtOutsideTK25;

        private void buttonOutsideTK25Search_Click(object sender, EventArgs e)
        {
            string SQL = "";
            try
            {
                SQL = "SELECT ";
                if (this.checkBoxOutsideTK25Restriction.Checked && this.numericUpDownOutsideTK25Restriction.Value > 0)
                    SQL += " TOP " + this.numericUpDownOutsideTK25Restriction.Value.ToString();
                SQL += " S.CollectionSpecimenID, W.Geography.ToString() AS WGS84, T.Geography.ToString() AS TK25, E.LocalityDescription " +
                    "FROM CollectionEventLocalisation AS T INNER JOIN " +
                    "CollectionEventLocalisation AS W ON T.CollectionEventID = W.CollectionEventID INNER JOIN " +
                    "CollectionEvent AS E ON T.CollectionEventID = E.CollectionEventID AND W.CollectionEventID = E.CollectionEventID INNER JOIN " +
                    "CollectionSpecimen AS S ON E.CollectionEventID = S.CollectionEventID INNER JOIN " +
                    "CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID " +
                    "WHERE (T.LocalisationSystemID = 3) AND (W.LocalisationSystemID = 8) AND (W.Geography.STWithin(T.Geography) = 0) AND (T.Geography.ToString() LIKE 'POLYGON %') ";
                SQL += " AND P.ProjectID = " + this.comboBoxOutsideTK25Project.SelectedValue.ToString();
                this._DtOutsideTK25 = new DataTable();
                string Message = "";
                DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref this._DtOutsideTK25, ref Message);
                if (Message.Length == 0)
                {
                    this.dataGridViewOutsideTK25.DataSource = this._DtOutsideTK25;
                    this.dataGridViewOutsideTK25.Columns[0].Visible = false;
                    System.Windows.Forms.MessageBox.Show(this._DtOutsideTK25.Rows.Count.ToString() + " coordinates outside TK25 detected");
                    this.labelOutsideTK25Result.Text = this._DtOutsideTK25.Rows.Count.ToString() + " coordinates outside TK25";
                }
                else
                    System.Windows.Forms.MessageBox.Show(Message);
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex, SQL);
            }
        }

        private void buttonOutsideTK25Check_Click(object sender, EventArgs e)
        {
            try
            {
                if (this._DtOutsideTK25 == null || this._DtOutsideTK25.Rows.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Nothing selected");
                    return;
                }
                this._CollectionSpecimenIDs = new List<int>();
                foreach (System.Data.DataRow R in this._DtOutsideTK25.Rows)
                {
                    this._CollectionSpecimenIDs.Add(int.Parse(R[0].ToString()));
                }
                this.DialogResult = System.Windows.Forms.DialogResult.OK;
                this._ShowListQueryDescription = "WGS84 Coordinates outside TK25";
                this._ShowListQueryHeader = "WGS84 <> TK25";
                this._ShowList = true;
                this.Close();
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonOutsideTK25Update_Click(object sender, EventArgs e)
        {

        }

#endregion

#region Sampling plot to locality

        private int? _SamplingPlotToLocalityDifferences;

        private System.Data.DataTable _dtSamplingPlotToLocality;

        private void buttonSamplingPlotToLocalitySearch_Click(object sender, EventArgs e)
        {
            string SQL = "SELECT /* DISTINCT CAST(1 AS bit) AS OK,*/ E.LocalityDescription AS [Locality of collection event], L.Location1 AS [Sampling plot] /*, E.CollectionEventID */ " +
                this.SqlWhereClauseSamplingPlotToLocality;
            this._dtSamplingPlotToLocality = new DataTable();
            Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            ad.Fill(_dtSamplingPlotToLocality);
            this.dataGridViewSamplingPlotToLocality.DataSource = _dtSamplingPlotToLocality;
            this.dataGridViewSamplingPlotToLocality.AllowUserToAddRows = false;
            SQL = "SELECT COUNT(DISTINCT E.CollectionEventID) " + this.SqlWhereClauseSamplingPlotToLocality;
            int i = 0;
            if (int.TryParse(DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL), out i))
                _SamplingPlotToLocalityDifferences = i;
            else _SamplingPlotToLocalityDifferences = null;
            if (_SamplingPlotToLocalityDifferences != null)
                this.labelSamplingPlotToLocalityResult.Text = _SamplingPlotToLocalityDifferences.ToString() + " differences found";
            else
                this.labelSamplingPlotToLocalityResult.Text = "";
            if (i > 0 && _SamplingPlotToLocalityDifferences != null)
                this.buttonSamplingPlotToLocalityStart.Enabled = true;
            else
                this.buttonSamplingPlotToLocalityStart.Enabled = false;
        }

        private void buttonSamplingPlotToLocalityCheckDataset_Click(object sender, EventArgs e)
        {

        }

        private bool IsSelectionSamplingPlotToLocalityChanged()
        {
            System.Data.DataRow[] rr = this._dtSamplingPlotToLocality.Select("OK = 0");
            if (rr.Length > 0)
                return true;
            else return false;
        }

        private void buttonSamplingPlotToLocalityStart_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSamplingPlotToLocality.DataSource == null &&
                _SamplingPlotToLocalityDifferences != null)
            {
                System.Windows.Forms.MessageBox.Show("Please search for differences before you try to update");
                return;
            }
            string SQL = "UPDATE E SET E.LocalityDescription = ";
            if (this.checkBoxSamplingPlotToLocalityAttach.Checked)
                SQL += " CASE WHEN E.LocalityDescription IS NULL THEN '' ELSE RTRIM(E.LocalityDescription) + CASE WHEN RTRIM(E.LocalityDescription) LIKE '%.' THEN '' ELSE '.' END + ' ' END + ";
            SQL += " L.Location1 " + this.SqlWhereClauseSamplingPlotToLocality;
            if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL))
            {
                string Message = this._SamplingPlotToLocalityDifferences.ToString() + " datasets updated";
                System.Windows.Forms.MessageBox.Show(Message);
                this.labelSamplingPlotToLocalityResult.Text = Message;
                this.dataGridViewSamplingPlotToLocality.DataSource = null;
            }
            else System.Windows.Forms.MessageBox.Show("Update failed");
        }

        private string SqlWhereClauseSamplingPlotToLocality
        {
            get
            {
                string SQL = "";
                try
                {
                    SQL = " FROM CollectionEvent AS E INNER JOIN " +
                    " CollectionSpecimen AS S ON E.CollectionEventID = S.CollectionEventID INNER JOIN " +
                    " CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID INNER JOIN " +
                    " CollectionEventLocalisation AS L ON E.CollectionEventID = L.CollectionEventID " +
                    " WHERE (L.LocalisationSystemID = 13) " +
                    " AND (E.LocalityDescription <> L.Location1 OR E.LocalityDescription IS NULL AND L.Location1 <> '') " +
                    " AND (P.ProjectID = " + this.comboBoxSamplingPlotToLocalityProject.SelectedValue.ToString() + ") ";
                    if (this.checkBoxSamplingPlotToLocalityAttach.Checked)
                        SQL += " AND (E.LocalityDescription IS NULL OR E.LocalityDescription NOT LIKE '%' + L.Location1) ";
                    if (this.checkBoxSamplingPlotToLocalityRestrictToEmpty.Checked)
                        SQL += " AND (E.LocalityDescription IS NULL OR RTRIM(E.LocalityDescription) = '') ";
                }
                catch { }
                return SQL;
            }
        }

        private void checkBoxSamplingPlotToLocalityRestrictToEmpty_CheckedChanged(object sender, EventArgs e)
        {
            this.dataGridViewSamplingPlotToLocality.DataSource = null;
            this.buttonSamplingPlotToLocalityStart.Enabled = false;
        }

        private void checkBoxSamplingPlotToLocalityAttach_CheckedChanged(object sender, EventArgs e)
        {
            this.dataGridViewSamplingPlotToLocality.DataSource = null;
            this.buttonSamplingPlotToLocalityStart.Enabled = false;
        }

#endregion

#region Event method parameters

        private void buttonEventMethodParametersFind_Click(object sender, EventArgs e)
        {
            this.FindMissingMethodParameters();
        }

        private void FindMissingMethodParameters()
        {
            this.buttonEventMethodParametersCheckDataset.Visible = false;
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            try
            {
                string SQL = "SELECT M.DisplayText AS Method, P.DisplayText AS Parameter, cast(COUNT(*) AS varchar) + ' x' AS Quantity";
                SQL += this.MissingMethodParametersFromClause();
                SQL += " GROUP BY M.DisplayText, P.DisplayText " +
                " ORDER BY M.DisplayText, P.DisplayText ";
                System.Data.DataTable dt = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dt);
                this.dataGridViewEventMethodParameters.DataSource = dt;
            }
            catch (System.Exception ex)
            {
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonEventMethodParametersCheckDataset_Click(object sender, EventArgs e)
        {
            System.Windows.Forms.MessageBox.Show("Available in upcoming version");
        }

        private void buttonEventMethodParametersStartInsert_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            try
            {
                string SQL = "INSERT INTO [CollectionEventParameterValue] " +
                    "([CollectionEventID] ,[MethodID] ,[ParameterID]) " +
                    "SELECT  DISTINCT   EM.CollectionEventID, EM.MethodID, P.ParameterID ";
                SQL += this.MissingMethodParametersFromClause();
                if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL))
                {
                    System.Windows.Forms.MessageBox.Show("Missing parameters inserted");
                    this.dataGridViewEventMethodParameters.DataSource = null;
                }
                else
                    System.Windows.Forms.MessageBox.Show("Insert failed");
            }
            catch (System.Exception ex)
            {
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void comboBoxEventMethodParametersMethod_SelectionChangeCommitted(object sender, EventArgs e)
        {
            this.dataGridViewEventMethodParameters.DataSource = null;
        }

        private void comboBoxEventMethodParametersProject_SelectionChangeCommitted(object sender, EventArgs e)
        {
            this.dataGridViewEventMethodParameters.DataSource = null;
        }

        private string MissingMethodParametersFromClause()
        {
            string SQL = " FROM Parameter AS P LEFT OUTER JOIN " +
                "CollectionEventMethod AS EM INNER JOIN  " +
                "Method AS M ON EM.MethodID = M.MethodID INNER JOIN " +
                "CollectionSpecimen AS S INNER JOIN " +
                "CollectionProject AS SP ON S.CollectionSpecimenID = SP.CollectionSpecimenID ON EM.CollectionEventID = S.CollectionEventID ON P.MethodID = M.MethodID " +
                "WHERE (NOT (EM.MethodID IS NULL)) ";
            if (this.comboBoxEventMethodParametersProject.SelectedIndex > -1)
            {
                int ProjectID = 0;
                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxEventMethodParametersProject.SelectedItem;
                if (int.TryParse(R["ProjectID"].ToString(), out ProjectID))
                    SQL += " AND SP.ProjectID = " + ProjectID.ToString();
            }
            if (this.comboBoxEventMethodParametersMethod.SelectedIndex > -1)
            {
                int MethodID = 0;
                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxEventMethodParametersMethod.SelectedItem;
                if (int.TryParse(R["MethodID"].ToString(), out MethodID))
                    SQL += " AND M.MethodID = " + MethodID.ToString();
            }
            SQL += " AND NOT EXISTS ( SELECT * FROM CollectionEventParameterValue AS EMP where EM.CollectionEventID = EMP.CollectionEventID AND EM.MethodID = EMP.MethodID and  " +
            " P.ParameterID = EMP.ParameterID AND P.MethodID = EMP.MethodID AND P.MethodID = M.MethodID) ";
            return SQL;
        }

#endregion

#region Collection date

        private void buttonCollectionDateSearch_Click(object sender, EventArgs e)
        {
            this.GetMissingOrInvalidCollectionDate();
        }

        private void buttonCollectionDateUpdate_Click(object sender, EventArgs e)
        {
            string SQL = "UPDATE E SET E.CollectionDay = E.CollectionDay FROM CollectionEvent E " + this.WhereClauseCollectionDate(true);
            DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL);
            this.GetMissingOrInvalidCollectionDate();
        }

        private void GetMissingOrInvalidCollectionDate()
        {
            try
            {
                string ColumnList = "CollectionEventID AS ID, CollectorsEventNumber AS Number, CollectionDate AS [Date], CollectionDay AS [Day], CollectionMonth AS [Month], CollectionYear AS [Year], " +
                    "CollectionEndDay AS [End day], CollectionEndMonth AS [End month], CollectionEndYear AS [End year], CollectionDateSupplement AS Supplement, " +
                    "CollectionDateCategory AS Category, CollectionTime AS [Time], CollectionTimeSpan AS [Time span], DataWithholdingReasonDate AS [Withhold date], " +
                    "LocalityDescription AS Locality, LocalityVerbatim AS [Locality verbatim], HabitatDescription AS Habitat, ReferenceTitle AS Reference, " +
                    "ReferenceURI AS [Reference URI], ReferenceDetails AS [Reference Details], CollectingMethod AS [Collecting method], Notes, CountryCache AS Country, " +
                    "DataWithholdingReason AS Withhold, LogCreatedWhen AS [Created when], LogCreatedBy AS [Created by], LogUpdatedWhen AS [Updated when], " +
                    "LogUpdatedBy AS [Updated by]";
                string SQL = "SET DATEFORMAT ymd; SELECT " + this.CollectionDateTopClause() + " " + ColumnList + " FROM CollectionEvent E" + this.WhereClauseCollectionDate(true);
                System.Data.DataTable dtCollectionDate = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(dtCollectionDate);
                this.dataGridViewCollectionDate.DataSource = dtCollectionDate;
                if (dtCollectionDate.Rows.Count > 0)
                    this.buttonCollectionDateUpdate.Enabled = true;
                else this.buttonCollectionDateUpdate.Enabled = false;

                SQL = "SET DATEFORMAT ymd; SELECT " + this.CollectionDateTopClause() + " " + ColumnList + " FROM CollectionEvent E" + this.WhereClauseCollectionDate(false);
                System.Data.DataTable dtCollectionDateInvalid = new DataTable();
                ad.SelectCommand.CommandText = SQL;
                ad.Fill(dtCollectionDateInvalid);
                this.dataGridViewCollectionDateInvalid.DataSource = dtCollectionDateInvalid;

                SQL = "SET DATEFORMAT ymd; SELECT " + this.CollectionDateTopClause() + " " + ColumnList + " FROM CollectionEvent E"
                    + this.WhereClauseCollectionDate(false).Replace("e.CollectionDay", "e.CollectionEndDay").Replace("e.CollectionMonth", "e.CollectionEndMonth").Replace("e.CollectionYear", "e.CollectionEndYear");
                System.Data.DataTable dtCollectionEndDateInvalid = new DataTable();
                ad.SelectCommand.CommandText = SQL;
                ad.Fill(dtCollectionEndDateInvalid);
                this.dataGridViewCollectionEndDateInvalid.DataSource = dtCollectionEndDateInvalid;
                bool ShowEndDate = false;
                if (dtCollectionEndDateInvalid.Rows.Count > 0) ShowEndDate = true;
                this.buttonCheckCollectionEndDateInvalid.Visible = ShowEndDate;
                this.dataGridViewCollectionEndDateInvalid.Visible = ShowEndDate;
                this.labelCollectionEndDateInvalid.Visible = ShowEndDate;

                this.buttonCheckCollectionDateInvalid.Enabled = false;
            }
            catch (System.Exception ex)
            {
            }
        }

        private string WhereClauseCollectionDate(bool Valid)
        {
            string SQL = " where (e.CollectionDate is null " +
                "and not e.CollectionDay is null " +
                "and not e.CollectionMonth is null " +
                "and not e.CollectionYear is null " +
                "and isdate(CONVERT(nvarchar(10), cast(e.CollectionYear as varchar) + '-' + cast(e.CollectionMonth as varchar) + '-' + cast(e.CollectionDay as varchar), 126)) = ";
            if (Valid) SQL += "1)";
            else SQL += "0) OR e.CollectionDay < 1 OR e.CollectionDay > 31 OR e.CollectionMonth < 1 OR e.CollectionMonth > 12 " +
                "OR (e.CollectionYear < 1000 and e.CollectionDate is null) " +
                "OR (e.CollectionYear < 1000 and not e.CollectionDate is null and year(e.CollectionDate) > " + (System.DateTime.Now.Year + 1).ToString() + ") " +
                "OR e.CollectionYear > " + (System.DateTime.Now.Year + 1).ToString();
            return SQL;
        }

        private string CollectionDateTopClause()
        {
            if (this.checkBoxCollectionDateRestriction.Checked && this.numericUpDownCollectionDateRestriction.Value > 0)
            {
                return "TOP " + this.numericUpDownCollectionDateRestriction.Value.ToString();
            }
            return "";
        }

        private void buttonCheckCollectionDateInvalid_Click(object sender, EventArgs e)
        {
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewCollectionDateInvalid.Rows[this.dataGridViewCollectionDateInvalid.SelectedCells[0].RowIndex];
            string SQL = "SELECT MIN(CollectionSpecimenID) FROM CollectionSpecimen WHERE CollectionEventID = " + R.Cells[0].Value.ToString();
            string ID = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL);
            if (int.TryParse(ID, out this._CollectionSpecimenID))
            {
                this.DialogResult = DialogResult.OK;
                this.Close();
            }
            else
                System.Windows.Forms.MessageBox.Show("No valid ID found");
        }

        private void dataGridViewCollectionDateInvalid_CellContentClick(object sender, DataGridViewCellEventArgs e)
        {
            this.buttonCheckCollectionDateInvalid.Enabled = true;
        }

        private void dataGridViewCollectionEndDateInvalid_CellContentClick(object sender, DataGridViewCellEventArgs e)
        {
            this.buttonCheckCollectionEndDateInvalid.Enabled = true;
        }

        private void buttonCheckCollectionEndDateInvalid_Click(object sender, EventArgs e)
        {
            System.Windows.Forms.DataGridViewRow R = this.dataGridViewCollectionEndDateInvalid.Rows[this.dataGridViewCollectionEndDateInvalid.SelectedCells[0].RowIndex];
            string SQL = "SELECT MIN(CollectionSpecimenID) FROM CollectionSpecimen WHERE CollectionEventID = " + R.Cells[0].Value.ToString();
            string ID = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL);
            if (int.TryParse(ID, out this._CollectionSpecimenID))
            {
                this.DialogResult = DialogResult.OK;
                this.Close();
            }
            else
                System.Windows.Forms.MessageBox.Show("No valid ID found");
        }

#endregion

#region Images

#region Sequence

        private void comboBoxImagesProject_SelectionChangeCommitted(object sender, EventArgs e)
        {
            this.resetImages();
        }

        private void buttonImagesSearch_Click(object sender, EventArgs e)
        {
            try
            {
                string SQL = this.ImageSequenceTable();

                System.Data.DataTable dt = new DataTable();
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));// DiversityWorkbench.Settings.TimeoutDatabase));
                ad.SelectCommand.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;// DiversityWorkbench.Settings.TimeoutDatabase;
                ad.Fill(dt);
                this.dataGridViewImages.DataSource = dt;
                if (dt.Rows.Count > 0)
                {
                    this.buttonImagesStartUpdate.Enabled = true;
                    this.labelImagesResult.Text = dt.Rows.Count.ToString() + " images found that may be sorted";
                }
                else
                {
                    this.buttonImagesStartUpdate.Enabled = false;
                    this.labelImagesResult.Text = "No images found that may be sorted";
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private void buttonImagesStartUpdate_Click(object sender, EventArgs e)
        {
            string SQL = this.ImageSequenceTable();
            SQL += "; UPDATE C SET C.DisplayOrder = I.NewDisplayOrder from @Images I, CollectionSpecimenImage C " +
                "WHERE C.CollectionSpecimenID = I.ID " +
                "AND C.URI = I.URI";
            string Message = "";
            if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL, ref Message, DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout))// DiversityWorkbench.Settings.TimeoutDatabase))
            {
                System.Windows.Forms.MessageBox.Show("Update finished");
                this.dataGridViewImages.DataSource = null;
            }
            else
                System.Windows.Forms.MessageBox.Show("Update failed:\r\n" + Message);
        }

        private string ImageSequenceTable()
        {
            string SQL = "DECLARE @Images Table " +
                "(OldDisplayOrder int, " +
                "NewDisplayOrder int, " +
                "ID int, " +
                "URI varchar(255), " +
                "CreationDate datetime); " +
                "INSERT INTO @Images(OldDisplayOrder, NewDisplayOrder, ID, URI, CreationDate) " +
                "SELECT   I.DisplayOrder AS [Current sequence], " +
                this.ImageSequence() + " AS [New sequence], " +
                "I.CollectionSpecimenID, I.URI, I.LogCreatedWhen  " +
                "FROM         CollectionSpecimenImage AS I INNER JOIN " +
                "CollectionProject AS P ON I.CollectionSpecimenID = P.CollectionSpecimenID " +
                "WHERE     (P.ProjectID = " + this.comboBoxImagesProject.SelectedValue.ToString() + ") " +
                "AND (I.CollectionSpecimenID IN " +
                "(SELECT     CollectionSpecimenID  " +
                "FROM          CollectionSpecimenImage " +
                "GROUP BY CollectionSpecimenID " +
                "HAVING      (COUNT(*) > 1))) " +
                "ORDER BY I.CollectionSpecimenID, I.URI desc; " +
                "DECLARE @ImageGroup Table ( " +
                "Abzug int, " +
                "ID int); " +
                "INSERT INTO @ImageGroup " +
                "SELECT  max(M.NewDisplayOrder)- count(*) as Abzug,  M.ID  " +
                "FROM @Images M " +
                "Group by M.ID; " +
                "UPDATE I SET  I.NewDisplayOrder = I.NewDisplayOrder - G.Abzug  " +
                "from @ImageGroup G, @Images I " +
                "where G.ID = I.ID; " +
                "SELECT  I.OldDisplayOrder AS [Old displayorder], I.NewDisplayOrder AS [New displayorder], " +
                "I.ID, I.URI, I.CreationDate FROM @Images I ORDER BY I.ID, I.NewDisplayOrder;";
            return SQL;
        }

        private string ImageSequence()
        {
            string SQL = "ROW_NUMBER() OVER(ORDER BY  I.CollectionSpecimenID, ";
            if (this.radioButtonImagesDateAsc.Checked)
                SQL += "I.LogCreatedWhen ASC";
            else if (this.radioButtonImagesDateDesc.Checked)
                SQL += "I.LogCreatedWhen DESC";
            else if (this.radioButtonImagesUriAscending.Checked)
                SQL += "I.URI ASC";
            else if (this.radioButtonImagesUriDesc.Checked)
                SQL += "I.URI DESC";
            SQL += ") ";
            return SQL;
        }

        private void radioButtonImagesUriDesc_Click(object sender, EventArgs e)
        {
            this.resetImages();
        }

        private void radioButtonImagesUriAscending_Click(object sender, EventArgs e)
        {
            this.resetImages();
        }

        private void radioButtonImagesDateDesc_Click(object sender, EventArgs e)
        {
            this.resetImages();
        }

        private void radioButtonImagesDateAsc_Click(object sender, EventArgs e)
        {
            this.resetImages();
        }

        private void resetImages()
        {
            this.dataGridViewImages.DataSource = null;
            this.buttonImagesSearch.Enabled = true;
            this.buttonImagesStartUpdate.Enabled = false;
        }

        private void textBoxImagesTimeout_TextChanged(object sender, EventArgs e)
        {
            if (this.textBoxImagesTimeout.Text != (DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout).ToString())// DiversityWorkbench.Settings.TimeoutDatabaseInSeconds ).ToString())
            {
                int T;
                if (int.TryParse(this.textBoxImagesTimeout.Text, out T))
                {
                    DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout = T; // DiversityWorkbench.Settings.TimeoutDatabaseInSeconds = T;
                    DiversityCollection.Forms.FormMaintenanceSettings.Default.Save();
                }
                else
                {
                    System.Windows.Forms.MessageBox.Show(this.textBoxImagesTimeout.Text + " is not a valid number");
                    this.textBoxImagesTimeout.Text = (DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout).ToString();//  DiversityWorkbench.Settings.TimeoutDatabaseInSeconds).ToString();
                }
            }
        }

#endregion

#region Path

        private System.Collections.Generic.Dictionary<string, System.Drawing.Image> _ImageSoureTables;
        private System.Collections.Generic.List<string> _ImageExtensions;

        private void initImageExtenionCheck()
        {
            // Remove after finished development
            this.tabControlImages.TabPages.Remove(this.tabPageImageCheckExtension);
            return;

            this._ImageSoureTables = new Dictionary<string, Image>();
            this._ImageSoureTables.Add("CollectionEventImage", DiversityCollection.Resource.Event);
            this._ImageSoureTables.Add("CollectionEventSeriesImage", DiversityCollection.Resource.EventSeries);
            this._ImageSoureTables.Add("CollectionSpecimenImage", DiversityCollection.Resource.CollectionSpecimen);
            this._ImageSoureTables.Add("CollectionImage", DiversityCollection.Resource.Collection);
            foreach (System.Collections.Generic.KeyValuePair<string, Image> KV in this._ImageSoureTables)
                this.comboBoxImageCheckExtensionSourceTable.Items.Add(KV.Key);
            this._ImageExtensions = new List<string>();
            this._ImageExtensions.Add("*.htm, *.html");
            foreach (string s in this._ImageExtensions)
                this.comboBoxImageExtension.Items.Add(s);
        }

        private void comboBoxImagePathSourceTable_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.pictureBoxImageCheckExtensionSourceTable.Image = this._ImageSoureTables[this.comboBoxImageCheckExtensionSourceTable.SelectedItem.ToString()];
        }

        private void buttonImagePathSearch_Click(object sender, EventArgs e)
        {
            string SQL = "SELECT CAST(1 AS bit) AS [OK], * FROM " + this.comboBoxImageCheckExtensionSourceTable.SelectedItem.ToString() + " AS T ";

            string Extension = this.comboBoxImageExtension.SelectedItem.ToString();
            switch (Extension)
            {
                case "*.htm, *.html":
                    SQL += "WHERE T.URI LIKE '%htm' OR  T.URI LIKE '%html'";
                    break;
            }
        }

        private void buttonImagePathEdit_Click(object sender, EventArgs e)
        {

        }

#endregion

#endregion

#region Unit

#region Retrieval

        private void initRetrievalType()
        {
            DiversityWorkbench.EnumTable.SetEnumTableAsDatasource(this.comboBoxCheckRetrievalType, "CollRetrievalType_Enum", DiversityWorkbench.Settings.Connection, false);
        }

        private System.Data.DataTable _DtCheckRetrievalType;

        private void buttonCheckRetrievalSearch_Click(object sender, EventArgs e)
        {
            if (this.comboBoxCheckRetrievalProject.SelectedIndex == -1)
            {
                System.Windows.Forms.MessageBox.Show("Please select a project");
                return;
            }
            string SQL = "SELECT U.CollectionSpecimenID, U.IdentificationUnitID, CAST(1 as bit) AS OK, " +
                "CASE WHEN S.AccessionNumber IS NULL THEN '[ID: ' + CAST(U.CollectionSpecimenID AS varchar) + ']' ELSE S.AccessionNumber END AS [Accession number], " +
                "U.LastIdentificationCache AS [Last identification], U.FamilyCache AS [Family], U.OrderCache AS [Order], U.HierarchyCache AS [Hierarchy], " +
                "U.TaxonomicGroup AS [Taxonomic group] " +
                "FROM IdentificationUnit AS U INNER JOIN " +
                "CollectionSpecimen AS S ON U.CollectionSpecimenID = S.CollectionSpecimenID INNER JOIN " +
                "CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID LEFT OUTER JOIN " +
                "IdentificationUnitInPart ON U.CollectionSpecimenID = IdentificationUnitInPart.CollectionSpecimenID AND U.IdentificationUnitID = IdentificationUnitInPart.IdentificationUnitID " +
                "WHERE (P.ProjectID = " + this.comboBoxCheckRetrievalProject.SelectedValue.ToString() + ") " +
                "AND (U.RetrievalType IS NULL OR U.RetrievalType = '') " +
                "AND (IdentificationUnitInPart.CollectionSpecimenID IS NULL) " +
                "ORDER BY AccessionNumber, U.LastIdentificationCache";
            if (this._DtCheckRetrievalType == null)
                this._DtCheckRetrievalType = new DataTable();
            else
                this._DtCheckRetrievalType.Clear();
            string Message = "";
            DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref this._DtCheckRetrievalType, ref Message);
            this.dataGridViewCheckRetrieval.DataSource = this._DtCheckRetrievalType;
            this.dataGridViewCheckRetrieval.Columns[0].Visible = false;
            this.dataGridViewCheckRetrieval.Columns[1].Visible = false;
            this.dataGridViewCheckRetrieval.Columns[2].ReadOnly = false;
            this.dataGridViewCheckRetrieval.Columns[2].Width = 24;
            this.dataGridViewCheckRetrieval.ReadOnly = false;
            for (int i = 3; i < this.dataGridViewCheckRetrieval.Columns.Count; i++)
                this.dataGridViewCheckRetrieval.Columns[i].ReadOnly = true;
        }

        private void buttonCheckRetrievalInspect_Click(object sender, EventArgs e)
        {
            if (this._DtCheckRetrievalType == null ||
                this._DtCheckRetrievalType.Rows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }
            int Position = this.dataGridViewCheckRetrieval.SelectedCells[0].RowIndex;
            if (int.TryParse(this.dataGridViewCheckRetrieval.Rows[Position].Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
            {
                DiversityCollection.Forms.FormCollectionSpecimen f = new Forms.FormCollectionSpecimen(this._CollectionSpecimenID, false, false);
                f.setViewMode(Forms.FormCollectionSpecimen.ViewMode.SingleInspectionMode);
                f.Width = this.Width - 10;
                f.Height = this.Height - 10;
                f.ShowDialog();
            }
        }

        private void buttonCheckRetrievalEditResults_Click(object sender, EventArgs e)
        {
            if (this._DtCheckRetrievalType == null ||
                this._DtCheckRetrievalType.Rows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }
            if (this._CollectionSpecimenIDs == null)
                this._CollectionSpecimenIDs = new List<int>();
            this._CollectionSpecimenIDs.Clear();
            if (this.dataGridViewCheckRetrieval.SelectedRows.Count == 0)
            {
                foreach (System.Data.DataRow R in this._DtCheckRetrievalType.Rows)
                {
                    if (this._CollectionSpecimenIDs.Contains(int.Parse(R["CollectionSpecimenID"].ToString())))
                        continue;
                    this.CollectionSpecimenIDs.Add(int.Parse(R["CollectionSpecimenID"].ToString()));
                }
            }
            else
            {
                foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewCheckRetrieval.SelectedRows)
                {
                    if (this._CollectionSpecimenIDs.Contains(int.Parse(R.Cells[0].Value.ToString())))
                        continue;
                    this.CollectionSpecimenIDs.Add(int.Parse(R.Cells[0].Value.ToString()));
                }
            }
            this._ShowList = true;
            this._ShowListQueryHeader = "Retrieval type";
            this._ShowListQueryDescription = "Missing retrieval type for observations";
            this.DialogResult = DialogResult.OK;
            this.Close();
        }

        private void buttonCheckRetrievalTypeAll_Click(object sender, EventArgs e)
        {
            if (this._DtCheckRetrievalType == null ||
                this._DtCheckRetrievalType.Rows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }
            foreach (System.Data.DataRow R in this._DtCheckRetrievalType.Rows)
            {
                R["OK"] = 1;
            }
        }

        private void buttonCheckRetrievalTypeNone_Click(object sender, EventArgs e)
        {
            if (this._DtCheckRetrievalType == null ||
                this._DtCheckRetrievalType.Rows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }
            foreach (System.Data.DataRow R in this._DtCheckRetrievalType.Rows)
            {
                R["OK"] = 0;
            }
        }

        private void buttonCheckRetrievalTypeInsert_Click(object sender, EventArgs e)
        {
            if (this._DtCheckRetrievalType == null ||
                this._DtCheckRetrievalType.Rows.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Nothing selected");
                return;
            }
            else
            {
                string SQL = "";
                foreach (System.Data.DataRow R in this._DtCheckRetrievalType.Rows)
                {
                    if (R["OK"].ToString() == "False")
                        continue;
                    if (SQL.Length > 0)
                        SQL += ", ";
                    SQL += R["IdentificationUnitID"].ToString();
                }
                SQL = "UPDATE U SET RetrievalType = '" + this.comboBoxCheckRetrievalType.SelectedValue.ToString() + "' " +
                    "FROM IdentificationUnit U WHERE U.IdentificationUnitID IN (" + SQL + ")";
                if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL))
                {
                    System.Windows.Forms.MessageBox.Show("Retrieval type set");
                    this.buttonCheckRetrievalSearch_Click(null, null);
                }
                else
                    System.Windows.Forms.MessageBox.Show("Update failed");
            }
        }

#endregion

#endregion

#region LastIdentificationCache

        private void SynchronizeLastIdentification()
        {
            string SQL = "SELECT        I.CollectionSpecimenID, I.IdentificationUnitID, U.LastIdentificationCache, I.TaxonomicName, I.IdentificationDay " +
                "-- update I set I.IdentificationDay = I.IdentificationDay " +
                "FROM            Identification AS I INNER JOIN " +
                "IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID AND I.IdentificationUnitID = U.IdentificationUnitID AND  " +
                "I.TaxonomicName <> U.LastIdentificationCache " +
                "and I.TaxonomicName <> '' " +
                "where exists(select * from Identification M group by m.CollectionSpecimenID, m.IdentificationUnitID having max(M.IdentificationSequence) = I.IdentificationSequence and M.CollectionSpecimenID = I.CollectionSpecimenID and M.IdentificationUnitID = I.IdentificationUnitID)";

        }

        private static readonly string _SynchronizeLastIdentificationFromClause = " FROM Identification AS I INNER JOIN " +
            "IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID AND I.IdentificationUnitID = U.IdentificationUnitID AND  " +
            "I.TaxonomicName <> U.LastIdentificationCache " +
            "and I.TaxonomicName <> '' " +
            "where exists(select * from Identification M group by m.CollectionSpecimenID, m.IdentificationUnitID having max(M.IdentificationSequence) = I.IdentificationSequence and M.CollectionSpecimenID = I.CollectionSpecimenID and M.IdentificationUnitID = I.IdentificationUnitID)";

        private void buttonLastIdentificationCacheSearch_Click(object sender, EventArgs e)
        {
            System.Data.DataTable dt = new DataTable();
            string SQL = "SELECT  U.LastIdentificationCache, I.TaxonomicName " + DiversityCollection.Forms.FormMaintenance._SynchronizeLastIdentificationFromClause;
            Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            ad.Fill(dt);
            this.dataGridViewLastIdentificationCache.DataSource = dt;
            this.dataGridViewLastIdentificationCache.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
        }

        private void buttonLastIdentificationCacheUpdate_Click(object sender, EventArgs e)
        {
            DiversityCollection.Forms.FormMaintenance.SynchronizeLastIdentificationCache();
            this.dataGridViewLastIdentificationCache.DataSource = null;
        }

        public static void SynchronizeLastIdentificationCache()
        {
            string SQL = "update I set I.IdentificationDay = I.IdentificationDay " + DiversityCollection.Forms.FormMaintenance._SynchronizeLastIdentificationFromClause;
            DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL);
        }

#endregion

#region Storage location to last identification

        private System.Data.DataTable _DtStorageLocation;

        private void buttonSetStorageLocationSearch_Click(object sender, EventArgs e)
        {

            try
            {
                if (this._DtStorageLocation == null)
                    this._DtStorageLocation = new DataTable();
                else
                    this._DtStorageLocation.Clear();
                string SQL = "SELECT CAST(1 as bit) AS OK, U.LastIdentificationCache AS [Last identification], S.StorageLocation AS [Storage location], S.CollectionSpecimenID, S.SpecimenPartID " +
                    " , C.AccessionNumber " +
                    " FROM CollectionSpecimen AS C INNER JOIN IdentificationUnit AS U ON U.CollectionSpecimenID = C.CollectionSpecimenID" +
                    " INNER JOIN IdentificationUnitInPart AS US ON U.CollectionSpecimenID = US.CollectionSpecimenID " +
                    " AND U.IdentificationUnitID = US.IdentificationUnitID INNER JOIN " +
                    " CollectionSpecimenPart AS S ON US.CollectionSpecimenID = S.CollectionSpecimenID " +
                    " AND US.SpecimenPartID = S.SpecimenPartID AND (U.LastIdentificationCache <> S.StorageLocation OR (S.StorageLocation IS NULL AND U.LastIdentificationCache <> '')) " +
                    " INNER JOIN CollectionProject AS P ON U.CollectionSpecimenID = P.CollectionSpecimenID " +
                    " WHERE P.ProjectID = " + this.comboBoxSetStorageLocationProject.SelectedValue.ToString() +
                    " and exists(select * from IdentificationUnitInPart UIP " +
                    " where S.SpecimenPartID = UIP.SpecimenPartID " +
                    " group by UIP.CollectionSpecimenID " +
                    " having MIN(UIP.DisplayOrder) = US.DisplayOrder) " +
                    " order by U.LastIdentificationCache ";
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                ad.Fill(this._DtStorageLocation);
                this.dataGridViewSetStorageLocation.DataSource = this._DtStorageLocation;
                this.dataGridViewSetStorageLocation.Columns[0].SortMode = DataGridViewColumnSortMode.NotSortable;
                this.dataGridViewSetStorageLocation.Columns[0].Width = 30;
                this.dataGridViewSetStorageLocation.Columns[1].SortMode = DataGridViewColumnSortMode.NotSortable;
                this.dataGridViewSetStorageLocation.Columns[1].ReadOnly = true;
                this.dataGridViewSetStorageLocation.Columns[2].SortMode = DataGridViewColumnSortMode.NotSortable;
                this.dataGridViewSetStorageLocation.Columns[2].ReadOnly = true;
                this.dataGridViewSetStorageLocation.Columns[3].Visible = false;
                this.dataGridViewSetStorageLocation.Columns[4].Visible = false;
                this.dataGridViewSetStorageLocation.Columns[5].ReadOnly = true;
                this.dataGridViewSetStorageLocation.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                this.buttonSetStorageLocationUpdate.Enabled = true;

            }
            catch (Exception)
            {

                //throw;
            }
        }

        private void buttonSetStorageLocationAll_Click(object sender, EventArgs e)
        {
            // #173
            if (this._DtStorageLocation == null) return;

            foreach (System.Data.DataRow R in this._DtStorageLocation.Rows)
            {
                R[0] = true;
            }
        }

        private void buttonSetStorageLocationNone_Click(object sender, EventArgs e)
        {
            // #173
            if (this._DtStorageLocation == null) return;

            foreach (System.Data.DataRow R in this._DtStorageLocation.Rows)
            {
                R[0] = false;
            }
        }

        private void buttonSetStorageLocationUpdate_Click(object sender, EventArgs e)
        {
            int iOK = 0;
            int iFailed = 0;
            foreach (System.Data.DataRow R in this._DtStorageLocation.Rows)
            {
                if (R[0].ToString().ToLower() == "true")
                {
                    string SQL = "UPDATE P SET StorageLocation = '" + SqlValueLike(R[1].ToString(), SqlValueType.TableColumn) + "' " +
                        " FROM CollectionSpecimenPart P " +
                        " WHERE P.SpecimenPartID = " + R["SpecimenPartID"].ToString();
                    if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL))
                        iOK++;
                    else iFailed++;
                }
            }
            System.Windows.MessageBox.Show("Update finished, " + iOK.ToString() + " datasets corrected. " + iFailed.ToString() + " updates failed");
            this.dataGridViewSetStorageLocation.DataSource = null;
            this.buttonSetStorageLocationUpdate.Enabled = false;
        }

        private void buttonSetStorageLocationCheckDataset_Click(object sender, EventArgs e)
        {
            if (this.dataGridViewSetStorageLocation.SelectedCells.Count == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a dataset");
                return;
            }
            int Position = this.dataGridViewSetStorageLocation.SelectedCells[0].RowIndex;
            if (int.TryParse(this.dataGridViewSetStorageLocation.Rows[Position].Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                DiversityCollection.Forms.FormCollectionSpecimen f = new Forms.FormCollectionSpecimen(this._CollectionSpecimenID, false, false);
                f.Width = this.Width - 10;
                f.Height = this.Height - 10;
                f.setViewMode(Forms.FormCollectionSpecimen.ViewMode.SingleInspectionMode);
                this.Cursor = System.Windows.Forms.Cursors.Default;
                f.ShowDialog();
                //this.DialogResult = DialogResult.OK;
                //this.Close();
            }
            //else
            //{
            //    System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
            //    this.DialogResult = DialogResult.Cancel;
            //}
        }

#endregion

#region Accepted names

        private void initAcceptedNames()
        {
        }

        private void initAcceptedNamesTaxonomyProjects()
        {
            try
            {
                string SQL = "SELECT P.ProjectID, P.Project " +
                    "FROM " + AcceptedNameTaxonomyPrefix() + "ProjectList AS P INNER JOIN " +
                    AcceptedNameTaxonomyPrefix() + "TaxonAcceptedName AS A ON P.ProjectID = A.ProjectID " +
                    "GROUP BY P.ProjectID, P.Project " +
                    "ORDER BY P.Project";
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, AcceptedNameTaxonomyConnectionString());
                System.Data.DataTable dt = new DataTable();
                ad.Fill(dt);
                this.comboBoxAcceptedNameTaxonomySourceProject.DataSource = dt;
                this.comboBoxAcceptedNameTaxonomySourceProject.DisplayMember = "Project";
                this.comboBoxAcceptedNameTaxonomySourceProject.ValueMember = "ProjectID";
            }
            catch (System.Exception ex)
            {
            }
        }

        private string AcceptedNameTaxonomyConnectionString()
        {
            string ConnectionString = "";
            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnections().ContainsKey(comboBoxAcceptedNameTaxonomySource.SelectedItem.ToString()))
            {
                ConnectionString = DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnections()[comboBoxAcceptedNameTaxonomySource.SelectedItem.ToString()].ConnectionString;
            }
            return ConnectionString;
        }

        private string AcceptedNameTaxonomyPrefix()
        {
            string Prefix = "";
            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnections().ContainsKey(comboBoxAcceptedNameTaxonomySource.SelectedItem.ToString()))
            {
                if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnections()[comboBoxAcceptedNameTaxonomySource.SelectedItem.ToString()].LinkedServer.Length > 0)
                    Prefix = "[" + DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnections()[comboBoxAcceptedNameTaxonomySource.SelectedItem.ToString()].LinkedServer + "].";
                Prefix += "[" + DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnections()[comboBoxAcceptedNameTaxonomySource.SelectedItem.ToString()].DatabaseName + "].[dbo].";
            }
            return Prefix;
        }

        private bool AcceptedNamesPreconditionsOK()
        {
            if (this.comboBoxAcceptedNameTaxonomySource.Text.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please choose a taxonomy database");
                return false;
            }
            if (this.comboBoxAcceptedNameProject.SelectedIndex == -1)
            {
                System.Windows.Forms.MessageBox.Show("Please choose a project");
                return false;
            }
            if (this.comboBoxAcceptedNameTaxonomySourceProject.SelectedIndex == -1)
            {
                System.Windows.Forms.MessageBox.Show("Please choose a taxonomy project");
                return false;
            }
            return true;
        }

        private void buttonAcceptedNameCheckDataset_Click(object sender, EventArgs e)
        {
            if (AcceptedNamesPreconditionsOK())
            {
                if (this.dataGridViewAcceptedName.SelectedCells.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a dataset");
                    return;
                }
                System.Windows.Forms.DataGridViewRow R = this.dataGridViewAcceptedName.Rows[this.dataGridViewAcceptedName.SelectedCells[0].RowIndex];
                bool OK = true;
                try { string test = R.Cells["CollectionSpecimenID"].Value.ToString(); }
                catch { OK = false; }
                if (OK)
                {
                    if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
                    {
                        this.DialogResult = DialogResult.OK;
                        this.Close();
                    }
                    else
                        this.DialogResult = DialogResult.Cancel;
                }
                else
                {
                    //System.Windows.Forms.MessageBox.Show("Dataset in database can only be checked if you include the accession number before checking for differences");
                }
            }
        }

        private void buttonAcceptedNameSearch_Click(object sender, EventArgs e)
        {
            if (AcceptedNamesPreconditionsOK())
            {
                try
                {
                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(this.AcceptedNamesSql(false), this.AcceptedNameTaxonomyConnectionString());
                    System.Data.DataTable dt = new DataTable();
                    ad.Fill(dt);
                    this.dataGridViewAcceptedName.DataSource = dt;
                    this.dataGridViewAcceptedName.Columns[0].Visible = false;
                    this.dataGridViewAcceptedName.Columns[1].Visible = false;
                    this.dataGridViewAcceptedName.Columns[2].Visible = false;
                    for (int i = 4; i < this.dataGridViewAcceptedName.Columns.Count; i++)
                        this.dataGridViewAcceptedName.Columns[i].ReadOnly = true;
                    this.dataGridViewAcceptedName.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                    this.buttonAcceptedNameStartInsert.Enabled = true;
                    this.buttonAcceptedNameCheckDataset.Enabled = true;
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
            }
        }

        private void checkBoxAcceptedNameIncludeAccessionNumber_CheckedChanged(object sender, EventArgs e)
        {
            this.buttonAcceptedNameCheckDataset.Visible = this.checkBoxAcceptedNameIncludeAccessionNumber.Checked;
        }

        private void comboBoxAcceptedNameProject_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.AcceptedNamesReset();
        }

        private void comboBoxAcceptedNameTaxonomicGroup_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.AcceptedNamesReset();
        }

        private void comboBoxAcceptedNameTaxonomySource_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].DatabaseList().Contains(comboBoxAcceptedNameTaxonomySource.SelectedItem.ToString()))
            {
                this.initAcceptedNamesTaxonomyProjects();
                this.buttonAcceptedNameSearch.Enabled = true;
            }
            else if (DiversityWorkbench.WorkbenchUnit.GlobalWorkbenchUnitList()["DiversityTaxonNames"].ServerConnections().ContainsKey(comboBoxAcceptedNameTaxonomySource.SelectedItem.ToString()))
            {
                this.initAcceptedNamesTaxonomyProjects();
                this.buttonAcceptedNameSearch.Enabled = true;
            }
            else
            {
                //System.Windows.Forms.MessageBox.Show("Available in upcoming version");
                this.buttonAcceptedNameSearch.Enabled = false;
                //this.labelSynColTaxTaxonomicGroup.Visible = true;
                //this.comboBoxSynColTaxTaxonomicGroup.Visible = true;
            }
        }

        private void comboBoxAcceptedNameTaxonomySourceProject_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.AcceptedNamesReset();
        }

        private void AcceptedNamesReset()
        {
            this.buttonAcceptedNameCheckDataset.Enabled = false;
            this.buttonAcceptedNameStartInsert.Enabled = false;
        }

        private void buttonAcceptedNameStartInsert_Click(object sender, EventArgs e)
        {
            try
            {
                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(this.AcceptedNameTaxonomyConnectionString());
                Microsoft.Data.SqlClient.SqlCommand COM = new Microsoft.Data.SqlClient.SqlCommand(this.AcceptedNamesSql(true), con);
                con.Open();
                COM.ExecuteNonQuery();
                con.Close();
                con.Dispose();
                System.Windows.Forms.MessageBox.Show("Insert finished");
                this.dataGridViewAcceptedName.DataSource = null;
                this.AcceptedNamesReset();
            }
            catch (System.Exception ex)
            {
            }
        }

        private string AcceptedNamesSql(bool ForInsert)
        {
            string SQL = "";
            if (ForInsert)
                SQL += "INSERT INTO " + DiversityWorkbench.Settings.DatabaseName + ".dbo.Identification(CollectionSpecimenID, IdentificationUnitID, IdentificationSequence, TaxonomicName, Notes, IdentificationCategory, NameURI) ";
            SQL += "SELECT I.CollectionSpecimenID, I.IdentificationUnitID, I.IdentificationSequence + 1 AS IdentificationSequence, ";
            if (!ForInsert)
                SQL += "CAST(1 as bit) AS OK,  I.TaxonomicName AS [Synonym], ";
            SQL += " A.TaxonNameCache as [Accepted name], '" + this.textBoxAcceptedNameNotes.Text + "' AS Notes, 'renaming' AS Category, ";
            if (!ForInsert)
                SQL += "I.NameURI AS [NameURI of synonym], ";
            SQL += "B.BaseURL + cast(A.NameID as varchar)  AS [NameURI of accepted name] " +
                "FROM " + this.AcceptedNameTaxonomyPrefix() + "ViewBaseURL B,  " +
                this.AcceptedNameTaxonomyPrefix() + "TaxonName S, " +
                this.AcceptedNameTaxonomyPrefix() + "TaxonName A, " +
                this.AcceptedNameTaxonomyPrefix() + "TaxonSynonymyAcceptedNameID SA, " +
                DiversityWorkbench.Settings.DatabaseName + ".dbo.CollectionProject P, " +
                DiversityWorkbench.Settings.DatabaseName + ".dbo.Identification AS I INNER JOIN " +
                DiversityWorkbench.Settings.DatabaseName + ".dbo.IdentificationUnit AS U ON I.CollectionSpecimenID = U.CollectionSpecimenID AND I.IdentificationUnitID = U.IdentificationUnitID AND " +
                "I.TaxonomicName = U.LastIdentificationCache " +
                "WHERE B.BaseURL + cast(SA.NameID as varchar) = I.NameURI " +
                "and U.TaxonomicGroup = '" + this.comboBoxAcceptedNameTaxonomicGroup.SelectedValue.ToString() + "' " +
                " and SA.ProjectID = " + this.comboBoxAcceptedNameTaxonomySourceProject.SelectedValue.ToString() +
                " and S.NameID = SA.NameID " +
                "and A.NameID = SA.AcceptedNameID " +
                "and P.CollectionSpecimenID = I.CollectionSpecimenID " +
                "and P.ProjectID = " + this.comboBoxAcceptedNameProject.SelectedValue.ToString();
            if (ForInsert)
                SQL += this.AcceptedNamesInsertRestriction();
            return SQL;
        }

        private string AcceptedNamesInsertRestriction()
        {
            string SQL = "";
            string SqlYes = "";
            string SqlNo = "";
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewAcceptedName.Rows)
            {
                if (R.Cells[3].Value.ToString().ToUpper() == "TRUE")
                {
                    if (SqlYes.Length > 0) SqlYes += ", ";
                    SqlYes += R.Cells[1].Value.ToString();
                }
                else
                {
                    if (SqlNo.Length > 0) SqlNo += ", ";
                    SqlNo += R.Cells[1].Value.ToString();
                }
            }
            if (SqlNo.Length == 0)
                return "";
            if (SqlYes.Length > 0)
                SQL += " AND I.IdentificationUnitID IN (" + SqlYes + ") ";
            if (SqlNo.Length > 0)
                SQL += " AND I.IdentificationUnitID NOT IN (" + SqlNo + ") ";
            return SQL;
        }

        private void buttonAcceptedNameCheckAll_Click(object sender, EventArgs e)
        {
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewAcceptedName.Rows)
            {
                R.Cells[3].Value = true;
            }
        }

        private void buttonAcceptedNameCheckNone_Click(object sender, EventArgs e)
        {
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewAcceptedName.Rows)
            {
                R.Cells[3].Value = false;
            }
        }

#endregion

#region Nagoya

        // Liste der laender:
        // https://api.cbd.int/api/v2013/countries
        // Info fuer ein Land:
        // https://api.cbd.int/api/v2013/countries/GB
        // Infos zu ABS
        // https://www.cbd.int/abs/

        private void initNagoya()
        {
#if !NAGOYA_TEST
            /// TODO: wieder einblenden wenn Dirk Neumann entgueltige Anweisungen liefert
            this.tabControlMain.TabPages.Remove(this.tabPageRegulations);
            return;
#endif

            bool OK = DiversityWorkbench.Forms.FormFunctions.Permissions("CollectionEventRegulation", "Insert");
            if (OK)
            {
                //string SQL = "SELECT DISTINCT [Code] " +
                //    "FROM [dbo].[RegulationType_Enum] " +
                //    "ORDER BY Code ";
                //System.Data.DataTable dt = new DataTable();
                //Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                //ad.Fill(dt);
                //this.comboBoxNagoyaType.DataSource = dt;
                //this.comboBoxNagoyaType.DisplayMember = "Code";
                //this.comboBoxNagoyaType.ValueMember = "Code";
            }
            else
            {
                this.tabControlMain.TabPages.Remove(this.tabPageRegulations);
            }
        }

        private System.Data.DataTable _DtNagoyaCountryList;

        private System.Data.DataTable DtNagoyaCountryList()
        {
            if (this._DtNagoyaCountryList == null)
            {
                this._DtNagoyaCountryList = new DataTable();
                string SQL = "SELECT DISTINCT CountryCache " +
                    "FROM CollectionEvent E, CollectionSpecimen S, CollectionProject P " +
                    "WHERE (CountryCache <> N'') " +
                    "AND S.CollectionEventID = E.CollectionEventID " +
                    "AND S.CollectionSpecimenID = P.CollectionSpecimenID " +
                    "AND P.ProjectID = " + this.comboBoxNagoyaProject.SelectedValue.ToString() +
                    " ORDER BY CountryCache";
                string Message = "";
                DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref this._DtNagoyaCountryList, ref Message);
            }
            return this._DtNagoyaCountryList;
        }

        private void comboBoxNagoyaCountry_DropDown(object sender, EventArgs e)
        {
            if (this.comboBoxNagoyaCountry.DataSource == null)
            {
                this.comboBoxNagoyaCountry.DataSource = this.DtNagoyaCountryList();
                this.comboBoxNagoyaCountry.ValueMember = "CountryCache";
                this.comboBoxNagoyaCountry.DisplayMember = "CountryCache";

                //System.Data.DataTable dt = DiversityWorkbench.Gazetteer.Countries();
                //if (dt.Rows.Count > 0)
                //{
                //    this.comboBoxNagoyaCountry.DataSource = dt;
                //    this.comboBoxNagoyaCountry.ValueMember = dt.Columns[0].ColumnName;
                //    this.comboBoxNagoyaCountry.DisplayMember = dt.Columns[1].ColumnName;
                //}
            }
        }

        private void buttonNagoyaURI_Click(object sender, EventArgs e)
        {

        }

        private System.Data.DataTable _DtNagoya;

        private void buttonNagoyaSearch_Click(object sender, EventArgs e)
        {
            if (!this.NagoyaParametersComplete())
                return;
            try
            {
                string SQL = "SELECT E.CollectionEventID, CAST(1 as bit) AS OK, E.LocalityDescription, E.LocalityVerbatim, E.HabitatDescription, E.CollectorsEventNumber, E.CollectionYear, E.CollectionMonth, E.CollectionDay, E.CollectionDateSupplement, " +
                    "E.CollectionEndDay, E.CollectionEndMonth, E.CollectionEndYear, E.CollectionTime, E.CollectionTimeSpan, E.ReferenceTitle, E.ReferenceDetails, E.CollectingMethod, E.Notes, E.DataWithholdingReason,  " +
                    "E.DataWithholdingReasonDate " + this.NagoyaFromClause(true, false);
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                this._DtNagoya = new DataTable();
                ad.Fill(this._DtNagoya);
                this.dataGridViewNagoya.DataSource = this._DtNagoya;
                this.dataGridViewNagoya.Columns[0].Visible = false;
                //this.dataGridViewNagoya.Columns[1].Visible = false;

                /// TODO: sobald ansteuern einzelner Datensaetze moeglich ist wieder aktivieren
                for (int i = 2; i < this.dataGridViewNagoya.Columns.Count; i++)
                    this.dataGridViewNagoya.Columns[i].ReadOnly = true;

                //for (int i = 0; i < this.dataGridViewNagoya.Columns.Count; i++)
                //    this.dataGridViewNagoya.Columns[i].ReadOnly = true;
                this.dataGridViewNagoya.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                if (this._DtNagoya.Rows.Count > 0)
                    this.buttonNagoyaStart.Enabled = true;

            }
            catch (System.Exception ex)
            {
            }
        }

        private bool NagoyaParametersComplete()
        {
            bool OK = true;
            if (this.textBoxRegulation.Text.Length == 0)
            {
                OK = false;
                System.Windows.Forms.MessageBox.Show("Please select a regluation");
            }
            if (this.comboBoxNagoyaProject.SelectedValue == null)
            {
                OK = false;
                System.Windows.Forms.MessageBox.Show("Please select a project");
            }
            if (!this.checkBoxNagoyaCollectionDate.Checked && !this.checkBoxNagoyaAccessionDate.Checked)
            {
                OK = false;
                System.Windows.Forms.MessageBox.Show("Please choose any starting date for the query");
            }
            if (this.comboBoxNagoyaCountry.Text.Length == 0)
            {
                OK = false;
                System.Windows.Forms.MessageBox.Show("Please choose or enter the country");
            }
            if (this.checkBoxNagoyaCollectionDate.Checked)
            {
                if (this.maskedTextBoxNagoyaCollectionDateFromYear.Text.Length > 0)
                {
                    System.DateTime DT;
                    string Date = this.maskedTextBoxNagoyaCollectionDateFromDay.Text + "." + this.maskedTextBoxNagoyaCollectionDateFromMonth.Text + "." + this.maskedTextBoxNagoyaCollectionDateFromYear.Text;
                    System.Globalization.CultureInfo CI = new System.Globalization.CultureInfo("de-DE");
                    if (!System.DateTime.TryParse(Date,
                        CI, System.Globalization.DateTimeStyles.AssumeLocal, out DT))
                    {
                        System.Windows.Forms.MessageBox.Show(Date + " is not a valid date");
                        return false;
                    }
                }
                if (this.maskedTextBoxNagoyaCollectionDateToYear.Text.Length > 0)
                {
                    System.DateTime DT;
                    string Date = this.maskedTextBoxNagoyaCollectionDateToDay.Text + "." + this.maskedTextBoxNagoyaCollectionDateToMonth.Text + "." + this.maskedTextBoxNagoyaCollectionDateToYear.Text;
                    System.Globalization.CultureInfo CI = new System.Globalization.CultureInfo("de-DE");
                    if (!System.DateTime.TryParse(Date,
                        CI, System.Globalization.DateTimeStyles.AssumeLocal, out DT))
                    {
                        System.Windows.Forms.MessageBox.Show(Date + " is not a valid date");
                        return false;
                    }
                }
            }
            if (this.checkBoxNagoyaAccessionDate.Checked)
            {
                if (this.maskedTextBoxNagoyaAccessionDateFromYear.Text.Length > 0)
                {
                    System.DateTime DT;
                    string Date = this.maskedTextBoxNagoyaAccessionDateFromDay.Text + "." + this.maskedTextBoxNagoyaAccessionDateFromMonth.Text + "." + this.maskedTextBoxNagoyaAccessionDateFromYear.Text;
                    System.Globalization.CultureInfo CI = new System.Globalization.CultureInfo("de-DE");
                    if (!System.DateTime.TryParse(Date,
                        CI, System.Globalization.DateTimeStyles.AssumeLocal, out DT))
                    {
                        System.Windows.Forms.MessageBox.Show(Date + " is not a valid date");
                        return false;
                    }
                }
                if (this.maskedTextBoxNagoyaAccessionDateFromYear.Text.Length > 0)
                {
                    System.DateTime DT;
                    string Date = this.maskedTextBoxNagoyaAccessionDateToDay.Text + "." + this.maskedTextBoxNagoyaAccessionDateToMonth.Text + "." + this.maskedTextBoxNagoyaAccessionDateToYear.Text;
                    System.Globalization.CultureInfo CI = new System.Globalization.CultureInfo("de-DE");
                    if (!System.DateTime.TryParse(Date,
                        CI, System.Globalization.DateTimeStyles.AssumeLocal, out DT))
                    {
                        System.Windows.Forms.MessageBox.Show(Date + " is not a valid date");
                        return false;
                    }
                }
            }
            return OK;
        }

        private void buttonNagoyaCheckAll_Click(object sender, EventArgs e)
        {
            //System.Windows.Forms.MessageBox.Show("Available in upcoming version");
            //return;

            if (this._DtNagoya != null)
            {
                foreach (System.Data.DataRow R in this._DtNagoya.Rows)
                    R[1] = true;
            }
        }

        private void buttonNagoyaCheckNone_Click(object sender, EventArgs e)
        {
            //System.Windows.Forms.MessageBox.Show("Available in upcoming version");
            //return;

            if (this._DtNagoya != null)
            {
                foreach (System.Data.DataRow R in this._DtNagoya.Rows)
                    R[1] = false;
            }
        }

        private string _Regulation = "";

        private string NagoyaFromClause(bool SearchOnly, bool ForUpdate)
        {
            string SQL = " FROM ";
            if (ForUpdate)
                SQL += " ExternalIdentifier I,";
            SQL += " CollectionEvent AS E, " +
                " CollectionSpecimen AS S, " +
                " CollectionProject AS P " +
                " WHERE P.ProjectID = " + this.comboBoxNagoyaProject.SelectedValue.ToString() + " " +
                " AND E.CountryCache = N'" + this.comboBoxNagoyaCountry.Text.ToString() + "' ";
            if (this.checkBoxNagoyaCollectionDate.Checked)
            {

                // From
                if (this.maskedTextBoxNagoyaCollectionDateFromYear.Text.Length > 0)
                {
                    SQL += this.NagoyaDateRestriction(this.maskedTextBoxNagoyaCollectionDateFromYear.Text, this.maskedTextBoxNagoyaCollectionDateFromMonth.Text, this.maskedTextBoxNagoyaCollectionDateFromDay.Text, true);
                }
                // To
                if (this.maskedTextBoxNagoyaCollectionDateToYear.Text.Length > 0)
                {
                    SQL += this.NagoyaDateRestriction(this.maskedTextBoxNagoyaCollectionDateToYear.Text, this.maskedTextBoxNagoyaCollectionDateToMonth.Text, this.maskedTextBoxNagoyaCollectionDateToDay.Text, false);
                }
            }
            SQL += " AND E.CollectionEventID = S.CollectionEventID " +
                " AND S.CollectionSpecimenID = P.CollectionSpecimenID ";
            if (this.checkBoxNagoyaAccessionDate.Checked)
            {
                // From
                if (this.maskedTextBoxNagoyaAccessionDateFromYear.Text.Length > 0)
                {
                    SQL += this.NagoyaDateRestriction(this.maskedTextBoxNagoyaAccessionDateFromYear.Text, this.maskedTextBoxNagoyaAccessionDateFromMonth.Text, this.maskedTextBoxNagoyaAccessionDateFromDay.Text, true);
                }
                // To
                if (this.maskedTextBoxNagoyaAccessionDateToYear.Text.Length > 0)
                {
                    SQL += this.NagoyaDateRestriction(this.maskedTextBoxNagoyaAccessionDateToYear.Text, this.maskedTextBoxNagoyaAccessionDateToMonth.Text, this.maskedTextBoxNagoyaAccessionDateToDay.Text, true);
                }
            }
            SQL += " AND E.CollectionEventID NOT IN (SELECT CollectionEventID FROM CollectionEventRegulation WHERE Regulation = '" + _Regulation.ToString().Replace("'", "''") + "')";
            return SQL;
        }

        private string NagoyaDateRestriction(string Year, string Month, string Day, bool IsFrom)
        {
            string SQL = "";
            if (Year.Length > 0)
            {
                SQL += " AND E.CollectionYear ";
                if (IsFrom)
                    SQL += " >= ";
                else
                    SQL += " <= ";
                SQL += Year;
                if (Month.Length > 0)
                {
                    SQL += " AND (E.CollectionMonth IS NULL OR CONVERT(DATETIME, cast(E.CollectionYear as varchar) + '-' + cast(E.CollectionMonth as varchar) + '-1', 102) ";
                    if (IsFrom)
                        SQL += " >= ";
                    else
                        SQL += " <= ";
                    SQL += "CONVERT(DATETIME, '" + Year + "-" + Month + "-";
                    if (IsFrom)
                        SQL += "01";
                    else
                        SQL += this.NagoyaEndDay(Month);
                    SQL += "', 102))";
                    if (Day.Length > 0)
                    {
                        SQL += " AND (E.CollectionDay IS NULL OR CONVERT(DATETIME, cast(E.CollectionYear as varchar) + '-' + cast(E.CollectionMonth as varchar) + '-' + cast(E.CollectionDay as varchar), 102)";
                        if (IsFrom)
                        {
                            SQL += " >= ";
                        }
                        else
                        {
                            SQL += " <= ";
                        }
                        SQL += "CONVERT(DATETIME, '" + Year + "-" + Month + "-" + Day + "', 102))";
                    }
                }
            }
            return SQL;
        }

        private string NagoyaEndDay(string Month)
        {
            int iMonth = int.Parse(Month);
            string Day = "";
            switch (iMonth)
            {
                case 1:
                case 3:
                case 5:
                case 7:
                case 8:
                case 10:
                case 12:
                    Day = "31";
                    break;
                case 2:
                    Day = "28";
                    break;
                case 4:
                case 6:
                case 9:
                case 11:
                    Day = "30";
                    break;
            }
            return Day;
        }

        private void buttonNagoyaStart_Click(object sender, EventArgs e)
        {
            if (this._Regulation == "")
            {
                System.Windows.Forms.MessageBox.Show("Please select a regulation");
                return;
            }
            string Message = "";
            int iReg = 0;
            int iRegFail = 0;
            int iHold = 0;
            int iHoldFail = 0;
            foreach (System.Data.DataRow R in this._DtNagoya.Rows)
            {
                bool OK = false;
                if (bool.TryParse(R["OK"].ToString(), out OK) && OK)
                {
                    string SQL = "INSERT INTO CollectionEventRegulation " +
                        "(CollectionEventID, Regulation) " +
                        "VALUES (" + R["CollectionEventID"].ToString() + ", '" + _Regulation.ToString().Replace("'", "''") + "')";
                    if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL, ref Message))
                    {
                        iReg++;
                        if (this.textBoxNagoyaWithholdSpecimen.Text.Trim().Length > 0)
                        {
                            SQL = "UPDATE S  " +
                                "SET S.DataWithholdingReason = N'" + this.textBoxNagoyaWithholdSpecimen.Text.Trim().Replace("'", "''") + "' " +
                                "FROM CollectionSpecimen S, CollectionEvent E " +
                                "WHERE S.CollectionEventID = E.CollectionEventID " +
                                "AND E.CollectionEventID = " + R["CollectionEventID"].ToString() +
                                " AND (S.DataWithholdingReason IS NULL OR S.DataWithholdingReason = '')";
                            if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL, ref Message))
                                iHold++;
                            else
                                iHoldFail++;
                        }
                    }
                    else
                        iRegFail++;
                }
            }
            if (iHoldFail > 0)
                Message = "Data withholding reason\r\n" + this.textBoxNagoyaWithholdSpecimen.Text.Trim() + "\r\nfor " +
                    iHoldFail.ToString() + " specimen failed\r\n";
            if (iHold > 0)
                Message = "Data withholding reason\r\n" + this.textBoxNagoyaWithholdSpecimen.Text.Trim() + "\r\nfor " +
                    iHold.ToString() + " specimen inserted\r\n";
            if (iRegFail > 0)
                Message = "Regulation\r\n" + this.textBoxRegulation.Text.Trim() + "\r\nfor " +
                    iRegFail.ToString() + " collection events failed\r\n";
            if (iReg > 0)
                Message = "Regulation\r\n" + this.textBoxRegulation.Text.Trim() + "\r\nfor " +
                    iReg.ToString() + " collection events inserted\r\n";
            if (iHoldFail == 0 && iRegFail == 0)
            {
                System.Windows.Forms.MessageBox.Show("Insert of regulation successfull:\r\n" + Message);
            }
            else
            {
                System.Windows.Forms.MessageBox.Show("Insert of regulation failed:\r\n" + Message);
            }
            this._DtNagoya.Rows.Clear();
            this.buttonNagoyaStart.Enabled = false;
            //string SQL = "INSERT INTO CollectionEventRegulation " +
            //    "(CollectionEventID, Regulation) " +
            //    "SELECT E.CollectionEventID, '" + _Regulation.ToString().Replace("'", "''") + "'" +
            //    this.NagoyaFromClause(false, this.checkBoxNagoyaReplaceExisting.Checked);
            //string Message = "";
            //bool InsertFailed = true;
            //if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL, ref Message))
            //{
            //    System.Windows.Forms.MessageBox.Show("Restrictions inserted");
            //    InsertFailed = false;
            //}
            //else
            //    System.Windows.Forms.MessageBox.Show("Insert failed: " + Message);
            //if (!InsertFailed && this.textBoxNagoyaWithholdSpecimen.Text.Length > 0)
            //{
            //    SQL = "SELECT COUNT(DISTINCT S.CollectionSpecimenID) " + this.NagoyaFromClause(true, false) + " AND (S.DataWithholdingReason IS NULL OR S.DataWithholdingReason = '')";
            //    string CountWithhold = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL);
            //    if (CountWithhold != "0")
            //    {
            //        SQL = "UPDATE S  " +
            //            "SET S.DataWithholdingReason = N'" + this.textBoxNagoyaWithholdSpecimen.Text.Replace("'", "''") + "' " +
            //            this.NagoyaFromClause(true, false) + " AND (S.DataWithholdingReason IS NULL OR S.DataWithholdingReason = '')";
            //        if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL, ref Message))
            //        {
            //            System.Windows.Forms.MessageBox.Show("Data withholding reason entered for " + CountWithhold + " specimen");
            //        }
            //        else
            //            System.Windows.Forms.MessageBox.Show("Writing data withholding reason failed: " + Message);
            //    }
            //}

        }

        private void dateTimePickerNagoyaCollectionDate_CloseUp(object sender, EventArgs e)
        {
            this.maskedTextBoxNagoyaCollectionDateFromYear.Text = this.dateTimePickerNagoyaCollectionDate.Value.Year.ToString();
            this.maskedTextBoxNagoyaCollectionDateFromMonth.Text = this.dateTimePickerNagoyaCollectionDate.Value.Month.ToString();
            this.maskedTextBoxNagoyaCollectionDateFromDay.Text = this.dateTimePickerNagoyaCollectionDate.Value.Day.ToString();
        }

        private void dateTimePickerNagoyaCollectionDateTo_CloseUp(object sender, EventArgs e)
        {
            this.maskedTextBoxNagoyaCollectionDateToYear.Text = this.dateTimePickerNagoyaCollectionDateTo.Value.Year.ToString();
            this.maskedTextBoxNagoyaCollectionDateToMonth.Text = this.dateTimePickerNagoyaCollectionDateTo.Value.Month.ToString();
            this.maskedTextBoxNagoyaCollectionDateToDay.Text = this.dateTimePickerNagoyaCollectionDateTo.Value.Day.ToString();
        }

        private void dateTimePickerNagoyaAccessionDate_CloseUp(object sender, EventArgs e)
        {
            this.maskedTextBoxNagoyaAccessionDateFromYear.Text = this.dateTimePickerNagoyaAccessionDate.Value.Year.ToString();
            this.maskedTextBoxNagoyaAccessionDateFromMonth.Text = this.dateTimePickerNagoyaAccessionDate.Value.Month.ToString();
            this.maskedTextBoxNagoyaAccessionDateFromDay.Text = this.dateTimePickerNagoyaAccessionDate.Value.Day.ToString();
        }

        private void dateTimePickerNagoyaAccessionDateTo_CloseUp(object sender, EventArgs e)
        {
            this.maskedTextBoxNagoyaAccessionDateToYear.Text = this.dateTimePickerNagoyaAccessionDateTo.Value.Year.ToString();
            this.maskedTextBoxNagoyaAccessionDateToMonth.Text = this.dateTimePickerNagoyaAccessionDateTo.Value.Month.ToString();
            this.maskedTextBoxNagoyaAccessionDateToDay.Text = this.dateTimePickerNagoyaAccessionDateTo.Value.Day.ToString();
        }

        private void buttonSearchForRegulation_Click(object sender, EventArgs e)
        {
            System.Data.DataTable dtReg = new DataTable();
            string Message = "";
            string SQL = "SELECT TransactionTitle FROM TransactionRegulation ORDER BY TransactionTitle";
            DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dtReg, ref Message);
            DiversityWorkbench.Forms.FormGetStringFromList f = new DiversityWorkbench.Forms.FormGetStringFromList(dtReg, "Please select a regulation");
            //DiversityCollection.Forms.FormRegulation f = new Forms.FormRegulation(null, true);
            f.ShowDialog();
            if (f.DialogResult == System.Windows.Forms.DialogResult.OK && f.SelectedString.Length > 0)
            {
                this._Regulation = f.SelectedString;
                this.textBoxRegulation.Text = this._Regulation;
            }
        }

        private void textBoxNagoyaWithholdSpecimen_TextChanged(object sender, EventArgs e)
        {
            if (this.textBoxNagoyaWithholdSpecimen.Text.Trim().Length > 0)
                this.pictureBoxNagoyaWithhold.Image = DiversityCollection.Resource.Stop3;
            else
                this.pictureBoxNagoyaWithhold.Image = DiversityCollection.Resource.Stop3Grey;
        }

#endregion

#region Orphaned data

#region Unrelated event data - new version

        private void initEvent()
        {
            // old version
            this.tabControlCollectionEvent.TabPages.Remove(this.tabPageRemoveEvents);
            bool CanRemove = this.FormFunctions.getObjectPermissions("CollectionEvent", "DELETE");

            //MW 20200924 - verschoben nach OrphanedData
            //if (!CanRemove && this.tabControlCollectionEvent.TabPages.Contains(this.tabPageRemoveUnrelated))
            //    this.tabControlCollectionEvent.TabPages.Remove(this.tabPageRemoveUnrelated);

            comboBoxCheckGeographyTypeOfComparisionBase.Visible = false;
        }

        private System.Collections.Generic.SortedDictionary<int, string> UnrelatedEventDataTables()
        {
            System.Collections.Generic.SortedDictionary<int, string> L = new SortedDictionary<int, string>();
            L.Add(1, "CollectionEventParameterValue");
            L.Add(2, "CollectionEventMethod");
            L.Add(3, "CollectionEventRegulation");
            L.Add(4, "CollectionEventImage");
            L.Add(5, "CollectionEventLocalisation");
            L.Add(6, "CollectionEventProperty");
            L.Add(7, "CollectionEvent");
            return L;
        }

        private void buttonFindUnrelatedEventData_Click(object sender, EventArgs e)
        {
            this.FindUnrelatedEventData();
            System.Windows.Forms.MessageBox.Show("Search finished");
        }

        private void FindUnrelatedEventData()
        {
            string SQL = "";
            this.labelUnrelatedEventDataResult.Text = "";
            this.buttonDeleteUnrelatedEventData.Enabled = false;
            try
            {
                foreach (System.Collections.Generic.KeyValuePair<int, string> KV in this.UnrelatedEventDataTables())
                {
                    SQL = "SELECT * FROM " + KV.Value + this.SqlUnrelatedEventDataWhereClause();
                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    System.Data.DataTable dt = new DataTable();
                    try
                    {
                        ad.Fill(dt);
                    }
                    catch (System.Exception ex)
                    {
                        DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                    }
                    if (dt.Rows.Count > 0 && this.UnrelatedEventTables.ContainsKey(KV.Value))
                    {
                        this.labelUnrelatedEventDataResult.Text += "\r\n" + this.UnrelatedEventTables[KV.Value] + ": " + dt.Rows.Count.ToString() + "\r\n";
                        this.buttonDeleteUnrelatedEventData.Enabled = true;
                    }
                    this.dataGridViewUnrelatedEventDataEvent.DataSource = dt;
                    switch (KV.Value)
                    {
                        case "CollectionEvent":
                            this.dataGridViewUnrelatedEventDataEvent.DataSource = dt;
                            break;
                        case "CollectionEventProperty":
                            this.dataGridViewUnrelatedEventDataHabitat.DataSource = dt;
                            break;
                        case "CollectionEventLocalisation":
                            this.dataGridViewUnrelatedEventDataLocality.DataSource = dt;
                            break;
                        case "CollectionEventImage":
                            this.dataGridViewUnrelatedEventDataImage.DataSource = dt;
                            break;
                        case "CollectionEventRegulation":
                            this.dataGridViewUnrelatedEventDataRegulations.DataSource = dt;
                            break;
                        case "CollectionEventMethod":
                            this.dataGridViewUnrelatedEventDataMethods.DataSource = dt;
                            break;
                        case "CollectionEventParameterValue":
                            this.dataGridViewUnrelatedEventDataParameter.DataSource = dt;
                            break;
                    }
                }
                //this.buttonDeleteUnrelatedEventData.Enabled = true;
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex, SQL);
            }
        }

        private System.Collections.Generic.Dictionary<string, string> _UnrelatedEventTables;
        private System.Collections.Generic.Dictionary<string, string> UnrelatedEventTables
        {
            get
            {
                if (this._UnrelatedEventTables == null)
                {
                    this._UnrelatedEventTables = new Dictionary<string, string>();
                    foreach (System.Collections.Generic.KeyValuePair<int, string> KV in this.UnrelatedEventDataTables())
                    {
                        string DisplayText = KV.Value;
                        if (DisplayText == "CollectionEvent")
                            DisplayText = "Events";
                        else
                        {
                            DisplayText = DisplayText.Replace("CollectionEvent", "");
                            DisplayText = DisplayText.Replace("Property", "Habitat");
                            DisplayText = DisplayText.Replace("Value", "");
                            DisplayText += "s";
                        }
                        this._UnrelatedEventTables.Add(KV.Value, DisplayText);
                    }
                }
                return this._UnrelatedEventTables;
            }
        }

        private void buttonDeleteUnrelatedEventData_Click(object sender, EventArgs e)
        {
            try
            {
                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                con.Open();
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand("", con);
                foreach (System.Collections.Generic.KeyValuePair<int, string> KV in this.UnrelatedEventDataTables())
                {
                    C.CommandText = "DELETE T FROM " + KV.Value + this.SqlUnrelatedEventDataWhereClause();
                    C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                    C.ExecuteNonQuery();
                }
                con.Close();
                con.Dispose();
                C.Dispose();
                this.buttonDeleteUnrelatedEventData.Enabled = false;
                this.FindUnrelatedEventData();
                System.Windows.Forms.MessageBox.Show("Data removed");
            }
            catch (Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
        }

        private string SqlUnrelatedEventDataWhereClause()
        {
            string SQL = " T WHERE T.CollectionEventID IN (SELECT E.CollectionEventID FROM CollectionEvent AS E LEFT OUTER JOIN " +
                        "CollectionSpecimen AS S ON E.CollectionEventID = S.CollectionEventID " +
                        "WHERE (S.CollectionSpecimenID IS NULL)";
            if (this.checkBoxUnrelatedEventDataRestrictToUser.Checked)
                SQL += " AND E.LogCreatedBy = User_Name() ";
            if (this.checkBoxUnrelatedEventDataRestrictDate.Checked)
                SQL += " AND E.LogCreatedWhen between CONVERT(DATETIME, '" + this.dateTimePickerUnrelatedEventDataRestrictDateMin.Value.Year.ToString() +
                    "-" + this.dateTimePickerUnrelatedEventDataRestrictDateMin.Value.Month.ToString() +
                    "-" + this.dateTimePickerUnrelatedEventDataRestrictDateMin.Value.Day.ToString() + "', 102) AND " +
                    "CONVERT(DATETIME, '" + this.dateTimePickerUnrelatedEventDataRestrictDateMax.Value.Year.ToString() +
                    "-" + this.dateTimePickerUnrelatedEventDataRestrictDateMax.Value.Month.ToString() +
                    "-" + this.dateTimePickerUnrelatedEventDataRestrictDateMax.Value.Day.ToString() + "', 102)";
            SQL += ")";
            return SQL;
        }

#endregion

#region Unrelated events - old version

        private void buttonUnrelatedEvents_Click(object sender, EventArgs e)
        {
            //string SQL = "SELECT CASE WHEN E.LogCreatedBy = USER_NAME() THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END AS OK, * FROM  CollectionEvent E " + this.SqlUnrelatedEventWhereClause;
            string SQL = "SELECT CASE WHEN E.LogCreatedBy = USER_NAME() THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END AS [Delete], E.* " +
                "FROM CollectionEvent " + this.SqlUnrelatedEventWhereClause;
            Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            System.Data.DataTable dt = new DataTable();
            try
            {
                this.Cursor = Cursors.WaitCursor;
                ad.Fill(dt);
                this.dataGridViewUnrelatedEvents.DataSource = dt;
                int i = this.dataGridViewUnrelatedEvents.Rows.Count;
                this.labelUnrelatedEvents.Text = i.ToString() + " collection events with no relation to specimen";

                SQL = "SELECT CASE WHEN E.LogCreatedBy = USER_NAME() THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END AS [Delete], E.* FROM  CollectionEventLocalisation " + this.SqlUnrelatedEventWhereClause;
                ad.SelectCommand.CommandText = SQL;
                System.Data.DataTable dtLoc = new DataTable();
                ad.Fill(dtLoc);
                this.dataGridViewUnrelatedLocations.DataSource = dtLoc;
                i = this.dataGridViewUnrelatedLocations.Rows.Count;
                this.labelUnrelatedLocations.Text = i.ToString() + " unrelated localisations";

                SQL = "SELECT    CASE WHEN E.LogCreatedBy = USER_NAME() THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END AS [Delete], E.* FROM  CollectionEventProperty " + this.SqlUnrelatedEventWhereClause;
                ad.SelectCommand.CommandText = SQL;
                System.Data.DataTable dtProp = new DataTable();
                ad.Fill(dtProp);
                this.dataGridViewUnrelatedEventProperty.DataSource = dtProp;
                i = this.dataGridViewUnrelatedEventProperty.Rows.Count;
                this.labelUnrelatedEventProperty.Text = i.ToString() + " unrelated event properties";

                SQL = "SELECT    CASE WHEN E.LogCreatedBy = USER_NAME() THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END AS [Delete], E.* FROM  CollectionEventImage " + this.SqlUnrelatedEventWhereClause;
                ad.SelectCommand.CommandText = SQL;
                System.Data.DataTable dtImage = new DataTable();
                ad.Fill(dtImage);
                this.dataGridViewUnrelatedEventImage.DataSource = dtImage;
                i = this.dataGridViewUnrelatedEventImage.Rows.Count;
                this.labelUnrelatedEventImage.Text = i.ToString() + " unrelated event images";

                this.dataGridViewUnrelatedEvents.Columns[0].AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells;
                this.dataGridViewUnrelatedLocations.Columns[0].AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells;
                this.dataGridViewUnrelatedEventProperty.Columns[0].AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells;
                this.dataGridViewUnrelatedEventImage.Columns[0].AutoSizeMode = DataGridViewAutoSizeColumnMode.AllCells;

                this.dataGridViewUnrelatedEvents.ReadOnly = false;
                this.dataGridViewUnrelatedLocations.ReadOnly = false;
                this.dataGridViewUnrelatedEventProperty.ReadOnly = false;
                this.dataGridViewUnrelatedEventImage.ReadOnly = false;

                for (int c = 0; c < this.dataGridViewUnrelatedEvents.Columns.Count; c++)
                {
                    if (c == 0) this.dataGridViewUnrelatedEvents.Columns[c].ReadOnly = false;
                    else this.dataGridViewUnrelatedEvents.Columns[c].ReadOnly = true;
                }

                for (int c = 0; c < this.dataGridViewUnrelatedLocations.Columns.Count; c++)
                {
                    if (c == 0) this.dataGridViewUnrelatedLocations.Columns[c].ReadOnly = false;
                    else this.dataGridViewUnrelatedLocations.Columns[c].ReadOnly = true;
                }

                for (int c = 0; c < this.dataGridViewUnrelatedEventProperty.Columns.Count; c++)
                {
                    if (c == 0) this.dataGridViewUnrelatedEventProperty.Columns[c].ReadOnly = false;
                    else this.dataGridViewUnrelatedEventProperty.Columns[c].ReadOnly = true;
                }

                for (int c = 0; c < this.dataGridViewUnrelatedEventImage.Columns.Count; c++)
                {
                    if (c == 0) this.dataGridViewUnrelatedEventImage.Columns[c].ReadOnly = false;
                    else this.dataGridViewUnrelatedEventImage.Columns[c].ReadOnly = true;
                }

            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.Cursor = Cursors.Default;
            }
        }

#region SQL clause

        private string _SqlUnrelatedEventWhereClause;

        private string SqlUnrelatedEventWhereClause
        {
            get
            {
                if (this._SqlUnrelatedEventWhereClause == null)
                {
                    _SqlUnrelatedEventWhereClause = " AS E LEFT OUTER JOIN " +
                        "CollectionSpecimen AS S ON E.CollectionEventID = S.CollectionEventID " +
                        "WHERE (S.CollectionSpecimenID IS NULL)";
                }
                return _SqlUnrelatedEventWhereClause;
            }
        }

#endregion

#region Delete buttons

        private void buttonUnrelatedEventsDelete_Click(object sender, EventArgs e)
        {
            string IDs = "";
            int iID = 0;
            try
            {
                foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewUnrelatedEvents.Rows)
                {
                    bool IsSelected;
                    if (bool.TryParse(R.Cells[0].Value.ToString(), out IsSelected) && IsSelected && R.Cells[1].Value.ToString().Trim().Length > 0)
                    {
                        if (IDs.Length > 0) IDs += ", ";
                        IDs += R.Cells[1].Value.ToString();
                        iID++;
                    }
                }
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show("To many items, only first part will be deleted");
            }
            IDs = IDs.Trim();
            if (IDs.EndsWith(","))
                IDs = IDs.Substring(0, IDs.Length - 1);
            if (this.dataGridViewUnrelatedLocations.Rows.Count > 0 ||
                this.dataGridViewUnrelatedEventProperty.Rows.Count > 0 ||
                this.dataGridViewUnrelatedEventImage.Rows.Count > 0)
            {
                if (System.Windows.Forms.MessageBox.Show("Do you want to delete datasets for localisation, site property and images dependent on the SELECTED EVENTS?", "Delete dependets data?", MessageBoxButtons.OKCancel) == DialogResult.OK)
                {
                    this.deleteUnrelatedEventDependentData("CollectionEventLocalisation", this.dataGridViewUnrelatedLocations, this.labelUnrelatedLocations, IDs, iID);
                    this.deleteUnrelatedEventDependentData("CollectionEventProperty", this.dataGridViewUnrelatedEventProperty, this.labelUnrelatedEventProperty, IDs, iID);
                    this.deleteUnrelatedEventDependentData("CollectionEventImage", this.dataGridViewUnrelatedEventImage, this.labelUnrelatedEventImage, IDs, iID);
                }
            }
            string SQL = "DELETE E FROM  CollectionEvent " + this.SqlUnrelatedEventWhereClause +
            "AND (E.CollectionEventID NOT IN " +
            "(SELECT CollectionEventID " +
            "FROM CollectionEventLocalisation))  " +
            "AND (E.CollectionEventID NOT IN " +
            "(SELECT CollectionEventID " +
            "FROM CollectionEventImage))  " +
            "AND (E.CollectionEventID NOT IN " +
            "(SELECT CollectionEventID " +
            "FROM CollectionEventProperty)) " +
            "AND E.CollectionEventID IN (" + IDs + ")";
            Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
            Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
            con.Open();
            try
            {
                this.Cursor = Cursors.WaitCursor;
                C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                C.ExecuteNonQuery();
                System.Windows.Forms.MessageBox.Show(iID.ToString() + " unrelated collection events deleted");
                int i = this.dataGridViewUnrelatedEvents.Rows.Count;
                this.dataGridViewUnrelatedEvents.Columns.Clear();
                this.buttonUnrelatedEvents_Click(null, null);
                //this.labelUnrelatedEvents.Text = i.ToString() + " events deleted";
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.Cursor = Cursors.Default;
            }
        }

        private void buttonUnrelatedLocations_Click(object sender, EventArgs e)
        {
            this.deleteUnrelatedEventDependentData("CollectionEventLocalisation", this.dataGridViewUnrelatedLocations, this.labelUnrelatedLocations, "", 0);
        }

        private void buttonUnrelatedEventProperty_Click(object sender, EventArgs e)
        {
            this.deleteUnrelatedEventDependentData("CollectionEventProperty", this.dataGridViewUnrelatedEventProperty, this.labelUnrelatedEventProperty, "", 0);
        }

        private void buttonUnrelatedEventImage_Click(object sender, EventArgs e)
        {
            this.deleteUnrelatedEventDependentData("CollectionEventImage", this.dataGridViewUnrelatedEventImage, this.labelUnrelatedEventImage, "", 0);
        }

        private void deleteUnrelatedEventDependentData(string Table, System.Windows.Forms.DataGridView DataGridView, System.Windows.Forms.Label Label, string IDs, int iID)
        {
            string SQL = "";
            Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
            Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
            try
            {
                int i = 0;
                this.Cursor = Cursors.WaitCursor;
                con.Open();
                if (IDs.Length > 0 && iID > 0)
                {
                    i = iID;
                    SQL = "DELETE FROM " + Table + " WHERE CollectionEventID IN ( " + IDs + ")";
                    C.CommandText = SQL;
                    C.ExecuteNonQuery();
                }
                else
                {
                    foreach (System.Windows.Forms.DataGridViewRow R in DataGridView.Rows)
                    {
                        bool IsSelected;
                        if (bool.TryParse(R.Cells[0].Value.ToString(), out IsSelected) && IsSelected && R.Cells[1].Value.ToString().Trim().Length > 0)
                        {
                            SQL = "DELETE FROM " + Table + " WHERE CollectionEventID = " + R.Cells[1].Value.ToString().Trim();
                            switch (Table)
                            {
                                case "CollectionEventLocalisation":
                                    SQL += " AND LocalisationSystemID = " + R.Cells[2].Value.ToString().Trim();
                                    break;
                                case "CollectionEventProperty":
                                    SQL += " AND PropertyID = " + R.Cells[2].Value.ToString().Trim();
                                    break;
                                case "CollectionEventImage":
                                    SQL += " AND URI = '" + R.Cells[2].Value.ToString().Trim() + "'";
                                    break;
                            }
                            i++;
                            C.CommandText = SQL;
                            C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
                            C.ExecuteNonQuery();
                        }
                    }
                }
                DataGridView.Columns.Clear();
                Label.Text = i.ToString() + " datasets deleted";
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            finally
            {
                this.Cursor = Cursors.Default;
            }
        }

#endregion

        private void buttonUnrelatedEventsSelectNone_Click(object sender, EventArgs e)
        {
            this.setGridSelection(false, this.dataGridViewUnrelatedEvents);
        }

        private void buttonUnrelatedEventsSelectAll_Click(object sender, EventArgs e)
        {
            this.setGridSelection(true, this.dataGridViewUnrelatedEvents);
        }

        private void buttonUnrelatedLocationsNone_Click(object sender, EventArgs e)
        {
            this.setGridSelection(false, this.dataGridViewUnrelatedLocations);
        }

        private void buttonUnrelatedLocationsAll_Click(object sender, EventArgs e)
        {
            this.setGridSelection(true, this.dataGridViewUnrelatedLocations);
        }

        private void buttonUnrelatedEventPropertyNone_Click(object sender, EventArgs e)
        {
            this.setGridSelection(false, this.dataGridViewUnrelatedEventProperty);
        }

        private void buttonUnrelatedEventPropertyAll_Click(object sender, EventArgs e)
        {
            this.setGridSelection(true, this.dataGridViewUnrelatedEventProperty);
        }

        private void buttonUnrelatedEventImageNone_Click(object sender, EventArgs e)
        {
            this.setGridSelection(false, this.dataGridViewUnrelatedEventImage);
        }

        private void buttonUnrelatedEventImageAll_Click(object sender, EventArgs e)
        {
            this.setGridSelection(true, this.dataGridViewUnrelatedEventImage);
        }

        private void setGridSelection(bool IsSelected, System.Windows.Forms.DataGridView Grid)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            try
            {
                System.Data.DataTable dt = (System.Data.DataTable)Grid.DataSource;
                foreach (System.Data.DataRow R in dt.Rows)
                    R[0] = IsSelected;
            }
            catch (System.Exception ex)
            {
            }
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

#endregion

#region Unrelated event series

        private void initEventSeries()
        {
            bool CanRemove = this.FormFunctions.getObjectPermissions("CollectionEventseries", "DELETE");
            if (!CanRemove)
                this.tabControlMain.TabPages.Remove(this.tabPageUnrelatedEventSeries);
        }

        private void buttonUnrelatedEventSeriesList_Click(object sender, EventArgs e)
        {
            //string SQL = "SELECT CASE WHEN LogCreatedBy = USER_NAME() THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END AS OK, * " +
            //"FROM CollectionEventSeries " + this.SqlUnrelatedEventSeriesWhereClause;
            string SQL = "SELECT CASE WHEN S.LogCreatedBy = USER_NAME() THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END AS [Delete], S.SeriesID, S.SeriesParentID, S.Description, S.SeriesCode, " +
                "S.Geography, S.Notes, S.DateStart, S.DateEnd, S.LogCreatedWhen, S.LogCreatedBy, S.LogUpdatedWhen, S.LogUpdatedBy, S.RowGUID " +
                "FROM CollectionEventSeries AS S LEFT OUTER JOIN " +
                "CollectionEventSeries AS SC ON S.SeriesID = SC.SeriesParentID LEFT OUTER JOIN " +
                "CollectionEvent AS E ON S.SeriesID = E.SeriesID " +
                "where E.SeriesID IS NULL and SC.SeriesID is null";
            Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionStringWithTimeout(DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout));
            Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
            C.CommandTimeout = DiversityCollection.Forms.FormMaintenanceSettings.Default.Timeout;
            Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(C);
            System.Data.DataTable dt = new DataTable();
            try
            {
                this.Cursor = Cursors.WaitCursor;
                ad.Fill(dt);
                this.dataGridViewUnrelatedEventSeries.DataSource = dt;
                this.dataGridViewUnrelatedEventSeries.AutoResizeColumns();
                int i = this.dataGridViewUnrelatedEventSeries.Rows.Count;
                this.labelUnrelatedEventSeries.Text = i.ToString() + " event series with no relation to collection events or other series";
                if (i > 0)
                {
                    this.buttonUnrelatedEventSeriesDelete.Enabled = true;
                }
                else
                {
                    this.buttonUnrelatedEventSeriesDelete.Enabled = false;
                }
                //SQL = "SELECT CASE WHEN LogCreatedBy = USER_NAME() THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END AS [Delete], * FROM CollectionEventSeriesImage " + this.SqlUnrelatedEventSeriesWhereClause;
                SQL = "SELECT CASE WHEN I.LogCreatedBy = USER_NAME() THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END AS [Delete], I.SeriesID, I.URI, " +
                    "I.ResourceURI, I.ImageType, I.Description, I.Title, I.IPR, I.CreatorAgent, I.CreatorAgentURI, I.CopyrightStatement, I.LicenseType, " +
                    "I.InternalNotes, I.LicenseHolder, I.LicenseHolderAgentURI, I.LicenseYear, I.Notes, I.DataWithholdingReason, I.LogCreatedWhen, " +
                    "I.LogCreatedBy, I.LogUpdatedWhen, I.LogUpdatedBy, I.RowGUID " +
                    "FROM CollectionEventSeriesImage AS I LEFT OUTER JOIN " +
                    "CollectionEventSeries AS S ON I.SeriesID = S.SeriesParentID LEFT OUTER JOIN " +
                    "CollectionEvent AS E ON I.SeriesID = E.SeriesID " +
                    "WHERE (E.SeriesID IS NULL) AND (S.SeriesParentID IS NULL)";
                ad.SelectCommand.CommandText = SQL;
                System.Data.DataTable dtImage = new DataTable();
                ad.Fill(dtImage);
                this.dataGridViewUnrelatedEventSeriesImage.DataSource = dtImage;
                for (int c = 1; c < this.dataGridViewUnrelatedEventSeriesImage.Columns.Count; c++)
                    this.dataGridViewUnrelatedEventSeriesImage.Columns[c].ReadOnly = true;
                this.dataGridViewUnrelatedEventSeriesImage.AutoResizeColumns();
                i = this.dataGridViewUnrelatedEventSeriesImage.Rows.Count;
                this.labelUnrelatedEventSeriesImage.Text = i.ToString() + " unrelated series images";
                if (i > 0)
                {
                    this.buttonUnrelatedEventSeriesImage.Enabled = true;
                }
                else
                {
                    this.buttonUnrelatedEventSeriesImage.Enabled = false;
                }
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex, SQL);
            }
            finally
            {
                this.Cursor = Cursors.Default;
            }
        }

        private void buttonUnrelatedEventSeriesAll_Click(object sender, EventArgs e)
        {
            this.setUnrelatedEventSeriesSelection(true);
        }

        private void buttonUnrelatedEventSeriesNone_Click(object sender, EventArgs e)
        {
            this.setUnrelatedEventSeriesSelection(false);
        }

        private void setUnrelatedEventSeriesSelection(bool IsSelected)
        {
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewUnrelatedEventSeries.Rows)
            {
                R.Cells[0].Value = IsSelected;
            }
        }

        private void buttonUnrelatedEventSeriesDelete_Click(object sender, EventArgs e)
        {
            string IDs = "";
            int i = 0;
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewUnrelatedEventSeries.Rows)
            {
                bool IsSelected;
                if (bool.TryParse(R.Cells[0].Value.ToString(), out IsSelected) && IsSelected && R.Cells[1].Value.ToString().Trim().Length > 0)
                {
                    if (IDs.Length > 0) IDs += ", ";
                    IDs += R.Cells[1].Value.ToString();
                    i++;
                }
            }
            if (IDs.Length > 0)
            {
                string SQL = "DELETE " +
                "FROM  CollectionEventSeries WHERE SeriesID IN (" + IDs + ")";// +this.SqlUnrelatedEventSeriesWhereClause;
                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                con.Open();
                try
                {
                    this.Cursor = Cursors.WaitCursor;
                    C.ExecuteNonQuery();
                    this.dataGridViewUnrelatedEventSeries.Columns.Clear();
                    this.labelUnrelatedEventSeries.Text = "";
                    this.buttonUnrelatedEventSeriesList_Click(null, null);
                    System.Windows.Forms.MessageBox.Show(i.ToString() + " collection event series deleted");
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
                finally
                {
                    this.Cursor = Cursors.Default;
                }
            }
            else
                System.Windows.Forms.MessageBox.Show("No series selected");
        }

        private void buttonUnrelatedEventSeriesImage_Click(object sender, EventArgs e)
        {
            string IDs = "";
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewUnrelatedEventSeriesImage.Rows)
            {
                bool IsSelected;
                if (bool.TryParse(R.Cells[0].Value.ToString(), out IsSelected) && IsSelected && R.Cells[1].Value.ToString().Trim().Length > 0)
                {
                    if (IDs.Length > 0) IDs += ", ";
                    IDs += R.Cells[1].Value.ToString();
                }
            }
            if (IDs.Length > 0)
            {
                string SQL = "DELETE FROM CollectionEventSeriesImage WHERE SeriesID IN (" + IDs + ")";// + this.SqlUnrelatedEventSeriesWhereClause;
                Microsoft.Data.SqlClient.SqlConnection con = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                Microsoft.Data.SqlClient.SqlCommand C = new Microsoft.Data.SqlClient.SqlCommand(SQL, con);
                con.Open();
                try
                {
                    this.Cursor = Cursors.WaitCursor;
                    C.ExecuteNonQuery();
                    int i = this.dataGridViewUnrelatedEventSeriesImage.Rows.Count;
                    this.dataGridViewUnrelatedEventSeriesImage.Columns.Clear();
                    this.labelUnrelatedEventSeriesImage.Text = i.ToString() + " event images deleted";
                    System.Windows.Forms.MessageBox.Show("Images deleted");
                }
                catch (Exception ex)
                {
                    DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
                }
                finally
                {
                    this.Cursor = Cursors.Default;
                }
            }
            else
                System.Windows.Forms.MessageBox.Show("No images selected");
        }

        private void buttonUnrelatedEventSeriesImageAll_Click(object sender, EventArgs e)
        {
            this.setUnrelatedEventSeriesImageSelection(true);
        }

        private void buttonUnrelatedEventSeriesImageNone_Click(object sender, EventArgs e)
        {
            this.setUnrelatedEventSeriesImageSelection(false);
        }

        private void setUnrelatedEventSeriesImageSelection(bool IsSelected)
        {
            foreach (System.Windows.Forms.DataGridViewRow R in this.dataGridViewUnrelatedEventSeriesImage.Rows)
            {
                R.Cells[0].Value = IsSelected;
            }
        }

        //private string SqlUnrelatedEventSeriesWhereClause
        //{
        //    get
        //    {
        //        return "WHERE (SeriesID NOT IN " +
        //            "(SELECT SeriesID " +
        //            "FROM  CollectionEvent " +
        //            "WHERE (NOT (SeriesID IS NULL))))  " +
        //            "AND (SeriesID NOT IN " +
        //            "(SELECT  SeriesParentID " +
        //            "FROM  CollectionEventSeries " +
        //            "WHERE (NOT (SeriesParentID IS NULL))))"; // +
        //    }
        //}

        #endregion

        #region ReferencedTables

        
        #region Annotations

        private void buttonAnnotationsFind_Click(object sender, EventArgs e)
        {
            this.ReferencedDataFind("Annotation", this.AnnotationReferencedTables, this.tabControlAnnotations, this.labelAnnotationsResult, this.buttonAnnotationsDelete);
            //try
            //{
            //    this.tabControlAnnotations.TabPages.Clear();
            //    this.labelAnnotationsResult.Text = "";
            //    foreach (System.Collections.Generic.KeyValuePair<string, string> KV in this.AnnotationReferencedTables)
            //    {
            //        string SQL = "SELECT A.* FROM [dbo].[Annotation] A " + this.ReferencedTableOrphanedDataFromClause("Annotation", KV.Key, KV.Value);
            //            //"WHERE NOT EXISTS (" +
            //            //"SELECT * FROM [" + KV.Key + "] R " +
            //            //"WHERE A.ReferencedID = R." + KV.Value + " " +
            //            //"AND A.[ReferencedTable] = '" + KV.Key + "' )" +
            //            //"AND A.[ReferencedTable] = '" + KV.Key + "'";
            //        Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            //        System.Data.DataTable dt = new DataTable();
            //        ad.Fill(dt);
            //        if (dt.Rows.Count > 0)
            //        {
            //            this.ReferencedDataShowTabs(KV.Key, dt, this.tabControlAnnotations, this.labelAnnotationsResult);
            //            //System.Windows.Forms.TabPage T = new TabPage(KV.Key);
            //            //System.Windows.Forms.DataGridView DGV = new DataGridView();
            //            //DGV.AllowUserToAddRows = false;
            //            //DGV.AllowUserToDeleteRows = false;
            //            //DGV.ReadOnly = true;
            //            //T.Controls.Add(DGV);
            //            //DGV.Dock = DockStyle.Fill;
            //            //DGV.DataSource = dt;
            //            //string DisplayText = KV.Key;
            //            //if (DisplayText == "CollectionSpecimen")
            //            //    DisplayText = "Specimen";
            //            //else if (DisplayText == "CollectionSpecimenPart")
            //            //    DisplayText = "Part";
            //            //else if (DisplayText == "IdentificationUnit")
            //            //    DisplayText = "Unit";
            //            //else if (DisplayText == "CollectionEvent")
            //            //    DisplayText = "Event";
            //            //this.labelAnnotationsResult.Text += "\r\n" + DisplayText + ": " + dt.Rows.Count.ToString() + "\r\n";
            //            //this.tabControlAnnotations.TabPages.Add(T);
            //            this.buttonAnnotationsDelete.Enabled = true;
            //        }
            //    }
            //    System.Windows.Forms.MessageBox.Show("Search finished");
            //}
            //catch (System.Exception ex)
            //{
            //    System.Windows.Forms.MessageBox.Show(ex.Message);
            //}
        }

        private void buttonAnnotationsDelete_Click(object sender, EventArgs e)
        {
            this.ReferencedDataDelete("Annotation", this.AnnotationReferencedTables, this.tabControlAnnotations, this.labelAnnotationsResult, this.buttonAnnotationsDelete);
            //string Message = "";
            //try
            //{
            //    foreach (System.Collections.Generic.KeyValuePair<string, string> KV in this.AnnotationReferencedTables)
            //    {
            //        string SQL = "DELETE A FROM [dbo].[Annotation] A " + this.ReferencedTableOrphanedDataFromClause("Annotation", KV.Key, KV.Value);
            //            //"WHERE NOT EXISTS (" +
            //            //"SELECT * FROM [" + KV.Key + "] R " +
            //            //"WHERE A.ReferencedID = R." + KV.Value + " " +
            //            //"AND A.[ReferencedTable] = '" + KV.Key + "' )";
            //        DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL, ref Message);
            //    }
            //    this.tabControlAnnotations.TabPages.Clear();
            //    this.labelAnnotationsResult.Text = "";
            //}
            //catch (System.Exception ex)
            //{
            //    Message = "Removal failed\r\n" + Message;
            //}
            //if (Message.Length == 0)
            //    Message = "Data removed";
            //System.Windows.Forms.MessageBox.Show(Message);
            //this.buttonAnnotationsDelete.Enabled = false;
        }

        private System.Collections.Generic.Dictionary<string, string> _AnnotationReferencedTables;

        public System.Collections.Generic.Dictionary<string, string> AnnotationReferencedTables
        {
            get
            {
                if (this._AnnotationReferencedTables == null)
                {
                    this._AnnotationReferencedTables = new Dictionary<string, string>();
                    string SQL = "SELECT DISTINCT [ReferencedTable] FROM [dbo].[Annotation] ORDER BY [ReferencedTable]";
                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    System.Data.DataTable dt = new DataTable();
                    ad.Fill(dt);
                    foreach (System.Data.DataRow R in dt.Rows)
                    {
                        SQL = "select case when min(c.name) is null then '' else min(c.name) end from sys.columns c, sys.tables t where c.is_identity = 1 " +
                        "and c.object_id = t.object_id and t.name = '" + R[0].ToString() + "'";
                        string ID = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL);
                        if (ID.Length == 0)
                        {
                            SQL = "SELECT TOP 1 COLUMN_NAME " +
                                "FROM INFORMATION_SCHEMA.COLUMNS AS C  " +
                                "WHERE (TABLE_NAME = 'CollectionSpecimenPart') AND (EXISTS  " +
                                "(SELECT *  " +
                                "FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE AS K INNER JOIN " +
                                "INFORMATION_SCHEMA.TABLE_CONSTRAINTS AS T ON K.CONSTRAINT_NAME = T.CONSTRAINT_NAME  " +
                                "WHERE (T.CONSTRAINT_TYPE = 'PRIMARY KEY') AND (K.COLUMN_NAME = C.COLUMN_NAME) AND (K.TABLE_NAME = C.TABLE_NAME))) " +
                                "AND C.DATA_TYPE = 'int'";
                            ID = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL);
                        }
                        this._AnnotationReferencedTables.Add(R[0].ToString(), ID);
                    }
                    ad.Dispose();
                    dt.Dispose();
                }
                return _AnnotationReferencedTables;
            }
            //set { _AnnotationReferencedTables = value; }
        }



#endregion

        #region Identifier

        private void buttonIdentifierFind_Click(object sender, EventArgs e)
        {
            this.ReferencedDataFind("ExternalIdentifier", this.IdentifierReferencedTables, this.tabControlIdentifier, this.labelIdentifierResult, this.buttonIdentifierDelete);
            //try
            //{
            //    this.tabControlIdentifier.TabPages.Clear();
            //    this.labelIdentifierResult.Text = "";
            //    foreach (System.Collections.Generic.KeyValuePair<string, string> KV in this.IdentifierReferencedTables)
            //    {
            //        string SQL = "SELECT A.* " + this.ReferencedTableOrphanedDataFromClause("ExternalIdentifier", KV.Key, KV.Value);
            //            //"FROM [dbo].[ExternalIdentifier] A " +
            //            //"WHERE NOT EXISTS (" +
            //            //"SELECT * FROM [" + KV.Key + "] R " +
            //            //"WHERE A.ReferencedID = R." + KV.Value + " " +
            //            //"AND A.[ReferencedTable] = '" + KV.Key + "' )" +
            //            //"AND A.[ReferencedTable] = '" + KV.Key + "'";
            //        Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
            //        System.Data.DataTable dt = new DataTable();
            //        ad.Fill(dt);
            //        if (dt.Rows.Count > 0)
            //        {
            //            this.ReferencedDataShowTabs(KV.Key, dt, this.tabControlIdentifier, this.labelIdentifierResult);
            //            //System.Windows.Forms.TabPage T = new TabPage(KV.Key);
            //            //System.Windows.Forms.DataGridView DGV = new DataGridView();
            //            //DGV.AllowUserToAddRows = false;
            //            //DGV.AllowUserToDeleteRows = false;
            //            //DGV.ReadOnly = true;
            //            //T.Controls.Add(DGV);
            //            //DGV.Dock = DockStyle.Fill;
            //            //DGV.DataSource = dt;
            //            //string DisplayText = KV.Key;
            //            //if (DisplayText == "CollectionSpecimen")
            //            //    DisplayText = "Specimen";
            //            //else if (DisplayText == "CollectionSpecimenPart")
            //            //    DisplayText = "Part";
            //            //else if (DisplayText == "IdentificationUnit")
            //            //    DisplayText = "Unit";
            //            //else if (DisplayText == "CollectionEvent")
            //            //    DisplayText = "Event";
            //            //this.labelIdentifierResult.Text += "\r\n" + DisplayText + ": " + dt.Rows.Count.ToString() + "\r\n";
            //            //this.tabControlIdentifier.TabPages.Add(T);
            //            this.buttonIdentifierDelete.Enabled = true;
            //        }
            //    }
            //    System.Windows.Forms.MessageBox.Show("Search finished");
            //}
            //catch (System.Exception ex)
            //{
            //    System.Windows.Forms.MessageBox.Show(ex.Message);
            //}
        }

        private void buttonIdentifierDelete_Click(object sender, EventArgs e)
        {
            this.ReferencedDataDelete("ExternalIdentifier", this.IdentifierReferencedTables, this.tabControlIdentifier, this.labelIdentifierResult, this.buttonIdentifierDelete);
            //string Message = "";
            //try
            //{
            //    foreach (System.Collections.Generic.KeyValuePair<string, string> KV in this.IdentifierReferencedTables)
            //    {
            //        string SQL = "DELETE A " + this.ReferencedTableOrphanedDataFromClause("ExternalIdentifier", KV.Key, KV.Value);
            //            //"FROM [dbo].[ExternalIdentifier] A " +
            //            //"WHERE NOT EXISTS (" +
            //            //"SELECT * FROM [" + KV.Key + "] R " +
            //            //"WHERE A.ReferencedID = R." + KV.Value + " " +
            //            //"AND A.[ReferencedTable] = '" + KV.Key + "' )";
            //        DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL, ref Message);
            //    }
            //    this.tabControlIdentifier.TabPages.Clear();
            //    this.labelIdentifierResult.Text = "";
            //}
            //catch (System.Exception ex)
            //{
            //    Message = "Removal failed\r\n" + Message;
            //}
            //if (Message.Length == 0)
            //    Message = "Data removed";
            //System.Windows.Forms.MessageBox.Show(Message);
            //this.buttonIdentifierDelete.Enabled = false;
        }

        private System.Collections.Generic.Dictionary<string, string> _IdentifierReferencedTables;

        public System.Collections.Generic.Dictionary<string, string> IdentifierReferencedTables
        {
            get
            {
                if (this._IdentifierReferencedTables == null)
                {
                    this._IdentifierReferencedTables = new Dictionary<string, string>();
                    string SQL = "SELECT DISTINCT [ReferencedTable] FROM [dbo].[ExternalIdentifier] ORDER BY [ReferencedTable]";
                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    System.Data.DataTable dt = new DataTable();
                    ad.Fill(dt);
                    foreach (System.Data.DataRow R in dt.Rows)
                    {
                        SQL = "select case when min(c.name) is null then '' else min(c.name) end from sys.columns c, sys.tables t where c.is_identity = 1 " +
                        "and c.object_id = t.object_id and t.name = '" + R[0].ToString() + "'";
                        string ID = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL);
                        if (ID.Length == 0)
                        {
                            SQL = "SELECT TOP 1 COLUMN_NAME " +
                                "FROM INFORMATION_SCHEMA.COLUMNS AS C  " +
                                "WHERE (TABLE_NAME = 'CollectionSpecimenPart') AND (EXISTS  " +
                                "(SELECT *  " +
                                "FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE AS K INNER JOIN " +
                                "INFORMATION_SCHEMA.TABLE_CONSTRAINTS AS T ON K.CONSTRAINT_NAME = T.CONSTRAINT_NAME  " +
                                "WHERE (T.CONSTRAINT_TYPE = 'PRIMARY KEY') AND (K.COLUMN_NAME = C.COLUMN_NAME) AND (K.TABLE_NAME = C.TABLE_NAME))) " +
                                "AND C.DATA_TYPE = 'int'";
                            ID = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL);
                        }
                        this._IdentifierReferencedTables.Add(R[0].ToString(), ID);
                    }
                    ad.Dispose();
                    dt.Dispose();
                }
                return _IdentifierReferencedTables;
            }
            //set { _IdentifierReferencedTables = value; }
        }

        #endregion

        private void ReferencedDataFind(string TargetTable, System.Collections.Generic.Dictionary<string, string> ReferencedTables, System.Windows.Forms.TabControl tabControl, System.Windows.Forms.Label label, System.Windows.Forms.Button button)
        {
            try
            {
                tabControl.TabPages.Clear();
                label.Text = "";
                foreach (System.Collections.Generic.KeyValuePair<string, string> KV in ReferencedTables)
                {
                    //string SQL = "SELECT A.* FROM [dbo].[" + TargetTable + "] A " + this.ReferencedTableOrphanedDataFromClause(TargetTable, KV.Key, KV.Value);
                    // Markus Bugfix 17.7.24
                    string SQL = "SELECT *  " + this.ReferencedTableOrphanedDataFromClause(TargetTable, KV.Key, KV.Value);
                    Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(SQL, DiversityWorkbench.Settings.ConnectionString);
                    System.Data.DataTable dt = new DataTable();
                    ad.Fill(dt);
                    if (dt.Rows.Count > 0)
                    {
                        this.ReferencedDataShowTabs(KV.Key, dt, tabControl, label);
                        button.Enabled = true;
                    }
                }
                System.Windows.Forms.MessageBox.Show("Search finished");
            }
            catch (System.Exception ex)
            {
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }

        }

        private void ReferencedDataDelete(string TargetTable, System.Collections.Generic.Dictionary<string, string> ReferencedTables, System.Windows.Forms.TabControl tabControl, System.Windows.Forms.Label label, System.Windows.Forms.Button button)
        {
            string Message = "";
            try
            {
                foreach (System.Collections.Generic.KeyValuePair<string, string> KV in ReferencedTables)
                {
                    string SQL = "DELETE A " + this.ReferencedTableOrphanedDataFromClause(TargetTable, KV.Key, KV.Value);
                    DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL, ref Message);
                }
                tabControl.TabPages.Clear();
                label.Text = "";
            }
            catch (System.Exception ex)
            {
                Message = "Removal failed\r\n" + Message;
            }
            if (Message.Length == 0)
                Message = "Data removed";
            System.Windows.Forms.MessageBox.Show(Message);
            button.Enabled = false;
        }
        private string ReferencedTableOrphanedDataFromClause(string ReferencedTable, string TargetTable, string TargetColumn)
        {
            string SQL = " FROM [dbo].[" + ReferencedTable + "] A " +
                "WHERE NOT EXISTS (" +
                "SELECT * FROM [" + TargetTable + "] R " +
                "WHERE A.ReferencedID = R." + TargetColumn + " " +
                "AND A.[ReferencedTable] = '" + TargetTable + "' )" +
                "AND A.[ReferencedTable] = '" + TargetTable + "'";
            return SQL;
        }


        private void ReferencedDataShowTabs(string TargetTable, System.Data.DataTable dt, System.Windows.Forms.TabControl tabControl, System.Windows.Forms.Label label)
        {
            System.Windows.Forms.TabPage T = new TabPage(TargetTable);
            System.Windows.Forms.DataGridView DGV = new DataGridView();
            DGV.AllowUserToAddRows = false;
            DGV.AllowUserToDeleteRows = false;
            DGV.ReadOnly = true;
            T.Controls.Add(DGV);
            DGV.Dock = DockStyle.Fill;
            DGV.DataSource = dt;
            string DisplayText = TargetTable;
            if (DisplayText == "CollectionSpecimen")
                DisplayText = "Specimen";
            else if (DisplayText == "CollectionSpecimenPart")
                DisplayText = "Part";
            else if (DisplayText == "IdentificationUnit")
                DisplayText = "Unit";
            else if (DisplayText == "CollectionEvent")
                DisplayText = "Event";
            label.Text += "\r\n" + DisplayText + ": " + dt.Rows.Count.ToString() + "\r\n";
            tabControl.TabPages.Add(T);
        }

        #endregion

        #region Relation
        private void buttonOrphanedRelationFind_Click(object sender, EventArgs e)
        {
            this.OrphanedRelationsFind();
        }

        private void buttonOrphanedRelationDelete_Click(object sender, EventArgs e)
        {
            this.OrphanedRelationsDelete();
        }

        private bool OrphanedRelationsFind()
        {
            bool OK = true;
            try
            {
                this.OrphanedRelationsReset();
                foreach (string S in this.OrphanedRelationSources())
                {
                    System.Windows.Forms.TabPage T = new TabPage("BaseURL: " + S);
                    System.Windows.Forms.DataGridView DGV = new DataGridView();
                    DGV.AllowUserToAddRows = false;
                    DGV.AllowUserToDeleteRows = false;
                    DGV.ReadOnly = true;
                    DGV.RowHeadersVisible = false;
                    //DGV.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
                    DGV.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.AllCells;
                    T.Controls.Add(DGV);
                    DGV.Dock = DockStyle.Fill;
                    System.Data.DataTable dt = this.OrphanedRelations();
                    DGV.DataSource = dt;
                    //DGV.AutoResizeColumn(0, DataGridViewAutoSizeColumnMode.AllCells);
                    //DGV.AutoResizeColumn(1, DataGridViewAutoSizeColumnMode.AllCells);
                    //DGV.AutoResizeColumn(2, DataGridViewAutoSizeColumnMode.AllCells);
                    this.labelOrphanedRelationResult.Text = "Found: \r\n" + dt.Rows.Count.ToString() + "";
                    this.tabControlOrphanedRelation.TabPages.Add(T);
                    this.buttonOrphanedRelationDelete.Enabled = true;
                }
                System.Windows.Forms.MessageBox.Show("Search finished");
            }
            catch (System.Exception ex)
            {
                OK = false;
                System.Windows.Forms.MessageBox.Show(ex.Message);
            }
            return OK;
        }

        private bool OrphanedRelationsDelete()
        {
            bool OK = true;
            string Message = "";
            try
            {
                string SQL = "DELETE R " + this.OrphanedRelationsFromClause();
                DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL, ref Message);
                this.OrphanedRelationsReset();
            }
            catch (System.Exception ex)
            {
                Message = "Removal failed\r\n" + Message;
                OK = false;
            }
            if (Message.Length == 0)
                Message = "Data removed";
            System.Windows.Forms.MessageBox.Show(Message);
            this.buttonOrphanedRelationDelete.Enabled = false;
            return OK;
        }

        private System.Collections.Generic.List<string> _OrphanedRelationSources;
        private System.Collections.Generic.List<string> OrphanedRelationSources()
        {
            if (this._OrphanedRelationSources == null)
            {
                _OrphanedRelationSources = new List<string>();
                string SQL = "SELECT distinct reverse(substring(reverse([RelatedSpecimenURI]), charindex('/', reverse([RelatedSpecimenURI])), 255)) FROM [CollectionSpecimenRelation] R " +
                "inner join ViewBaseURL V on reverse(substring(reverse([RelatedSpecimenURI]), charindex('/', reverse([RelatedSpecimenURI])), 255)) = V.BaseURL " +
                " where R.IsInternalRelationCache = 1";
                System.Data.DataTable dt = new DataTable();
                DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dt);
                foreach (System.Data.DataRow R in dt.Rows)
                    _OrphanedRelationSources.Add(R[0].ToString());
            }
            return _OrphanedRelationSources;
        }

        private System.Data.DataTable OrphanedRelations()
        {
            System.Data.DataTable dt = new DataTable();
            string SQL = "SELECT distinct A.AccessionNumber, R.RelatedSpecimenDisplayText AS RelatedSpecimen, R.RelatedSpecimenURI AS URI /*, R.CollectionSpecimenID*/ " + this.OrphanedRelationsFromClause();
            DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dt);
            return dt;
        }

        private string OrphanedRelationsFromClause()
        {
            string SQL = "FROM CollectionSpecimenRelation R " +
                "left outer join CollectionSpecimen S on cast(S.CollectionSpecimenID as varchar) = reverse(substring(reverse([RelatedSpecimenURI]), 1, charindex('/', reverse([RelatedSpecimenURI])) - 1)) " +
                "inner join ViewBaseURL V on reverse(substring(reverse([RelatedSpecimenURI]), charindex('/', reverse([RelatedSpecimenURI])), 255)) = V.BaseURL " +
                "inner join CollectionSpecimen A on R.CollectionSpecimenID = A.CollectionSpecimenID " +
                "inner join CollectionSpecimenID_CanEdit E on R.CollectionSpecimenID = E.CollectionSpecimenID " +
                "where R.IsInternalRelationCache = 1 " +
                "and S.CollectionSpecimenID is null";
            return SQL;
        }

        private void OrphanedRelationsReset()
        {
            foreach(System.Windows.Forms.TabPage tabPage in this.tabControlOrphanedRelation.TabPages)
            {
                foreach(System.Windows.Forms.Control control in tabPage.Controls)
                {
                    control.Dispose();
                }
                tabPage.Dispose();
            }
            this.tabControlOrphanedRelation.TabPages.Clear();
            this.labelOrphanedRelationResult.Text = string.Empty;
        }

#endregion

#endregion

#region Analysis

#region init and setting the controls

        private void initAnalysis()
        {
            this.setModuleConnectionForAnalysis();
        }

        private void setModuleConnectionForAnalysis()
        {
            // TaxonNames
            DiversityWorkbench.TaxonName T = new DiversityWorkbench.TaxonName(DiversityWorkbench.Settings.ServerConnection);
            this.userControlModuleRelatedEntryAnalysisIdentification.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)T;
            this.setIdentificationSource();

            // Agents
            DiversityWorkbench.Agent A = new DiversityWorkbench.Agent(DiversityWorkbench.Settings.ServerConnection);
            this.userControlModuleRelatedEntryAnalysisResponsible.IWorkbenchUnit = (DiversityWorkbench.IWorkbenchUnit)A;
        }

        private void setAnalysisControls()
        {
            if (this.radioButtonAnalysisRestrictToLastNumber.Checked)
            {
                this.checkBoxAnalysisIncrementLastNumber.Enabled = true;
                this.checkBoxAnalysisNewNumber.Enabled = false;
                this.textBoxAnalysisNewNumber.Enabled = false;
                this.textBoxAnalysisRestrictToNumber.Enabled = false;
            }
            else
            {
                this.checkBoxAnalysisIncrementLastNumber.Enabled = false;
                this.textBoxAnalysisRestrictToNumber.Enabled = true;
                //this.checkBoxAnalysisNewNumber.Enabled = true; // erst sinnvoll, wenn 2 Möglichkeit realisiert
                this.textBoxAnalysisNewNumber.Enabled = true;
            }
        }

        private void buttonAnalysisCheckNumbers_Click(object sender, EventArgs e)
        {
            try
            {
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(this.AnalysisSqlSelect(true), DiversityWorkbench.Settings.ConnectionString);
                this._DtAnalysis = new DataTable();
                ad.Fill(this._DtAnalysis);
                this.dataGridViewAnalysis.DataSource = this._DtAnalysis;
                this.buttonAnalysisStartInsert.Enabled = false;
            }
            catch (System.Exception ex)
            {
            }
        }

        private void radioButtonAnalysisRestrictToNumber_Click(object sender, EventArgs e)
        {
            this.setAnalysisControls();
        }

        private void checkBoxAnalysisNewNumber_Click(object sender, EventArgs e)
        {
            this.setAnalysisControls();
        }

        private void radioButtonAnalysisRestrictToLastNumber_Click(object sender, EventArgs e)
        {
            this.setAnalysisControls();
        }

        private void checkBoxAnalysisIncrementLastNumber_Click(object sender, EventArgs e)
        {
            this.setAnalysisControls();
        }

        private void checkBoxAnalysisRestrictToResult_Click(object sender, EventArgs e)
        {
            this.comboBoxAnalysisRestrictToResult.Enabled = this.checkBoxAnalysisRestrictToResult.Checked;
        }

#endregion

#region Analysis and results

        private void comboBoxAnalysis_DropDown(object sender, EventArgs e)
        {
            if (this.comboBoxAnalysisTaxonomicGroup.SelectedIndex == -1)
            {
                System.Windows.Forms.MessageBox.Show("Please select a taxonomic group");
                return;
            }
            else
            {
                string TaxonomicGroup = this.comboBoxAnalysisTaxonomicGroup.SelectedValue.ToString();
                this.comboBoxAnalysis.DataSource = DiversityCollection.LookupTable.Analysis(TaxonomicGroup);
                this.comboBoxAnalysis.DisplayMember = "DisplayText";
                this.comboBoxAnalysis.ValueMember = "AnalysisID";
                this.comboBoxAnalysisNewResult.DataSource = null;
                this.comboBoxAnalysisNewResult.Text = "";
                this.comboBoxAnalysisRestrictToResult.DataSource = null;
                this.comboBoxAnalysisRestrictToResult.Text = "";
            }
        }

        private void comboBoxAnalysisNewResult_DropDown(object sender, EventArgs e)
        {
            this.SetAnalysisResults(this.comboBoxAnalysisNewResult);
        }

        private void comboBoxAnalysisRestrictToResult_DropDown(object sender, EventArgs e)
        {
            this.SetAnalysisResults(this.comboBoxAnalysisRestrictToResult);
        }

        private void SetAnalysisResults(System.Windows.Forms.ComboBox CB)
        {
            try
            {
                int AnalysisID = int.Parse(this.comboBoxAnalysis.SelectedValue.ToString());
                string SQL = "SELECT AnalysisID, AnalysisResult " +
                    " FROM AnalysisResult " +
                    " WHERE AnalysisID = " + AnalysisID.ToString() +
                    " ORDER BY AnalysisResult";
                System.Data.DataTable dt = new DataTable();
                string Message = "";
                DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dt, ref Message);
                if (dt.Rows.Count > 0)
                {
                    CB.DataSource = dt;
                    CB.DisplayMember = "AnalysisResult";
                    CB.ValueMember = "AnalysisID";
                }
            }
            catch (System.Exception ex)
            {
            }
        }

#endregion

#region Check dataset

        private void dataGridViewAnalysis_Click(object sender, EventArgs e)
        {
            this.buttonAnalysisCheckDataset.Visible = true;
        }

        private void buttonAnalysisCheckDataset_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.dataGridViewAnalysis.SelectedCells.Count == 0)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a dataset");
                    return;
                }
                System.Windows.Forms.DataGridViewRow R = this.dataGridViewAnalysis.Rows[this.dataGridViewAnalysis.SelectedCells[0].RowIndex];
                if (int.TryParse(R.Cells["CollectionSpecimenID"].Value.ToString(), out this._CollectionSpecimenID))
                {
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                else
                    this.DialogResult = DialogResult.Cancel;
            }
            catch (System.Exception ex)
            {
            }
        }

#endregion

#region testing and inserting the data

        private bool AnalysisValuesSet()
        {
            bool OK = true;
            if (this.comboBoxAnalysisTaxonomicGroup.SelectedIndex == -1)
            {
                System.Windows.Forms.MessageBox.Show("Please select a taxonomic group");
                this.comboBoxAnalysisTaxonomicGroup.BackColor = System.Drawing.Color.Pink;
                OK = false;
            }
            else
                this.comboBoxAnalysisTaxonomicGroup.BackColor = System.Drawing.SystemColors.Window;

            if (this.comboBoxAnalysisProject.SelectedIndex == -1)
            {
                System.Windows.Forms.MessageBox.Show("Please select a project");
                this.comboBoxAnalysisProject.BackColor = System.Drawing.Color.Pink;
                OK = false;
            }
            else
                this.comboBoxAnalysisProject.BackColor = System.Drawing.SystemColors.Window;

            if (this.comboBoxAnalysis.SelectedIndex == -1)
            {
                System.Windows.Forms.MessageBox.Show("Please select an analysis");
                this.comboBoxAnalysis.BackColor = System.Drawing.Color.Pink;
                OK = false;
            }
            else
                this.comboBoxAnalysis.BackColor = System.Drawing.SystemColors.Window;

            if (this.comboBoxAnalysisNewResult.Text.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please enter a result");
                this.comboBoxAnalysisNewResult.BackColor = System.Drawing.Color.Pink;
                OK = false;
            }
            else
                this.comboBoxAnalysisNewResult.BackColor = System.Drawing.SystemColors.Window;

            if (this.checkBoxAnalysisNewNumber.Checked && this.textBoxAnalysisNewNumber.Text.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please enter a number for the new analysis");
                this.textBoxAnalysisNewNumber.BackColor = System.Drawing.Color.Pink;
                OK = false;
            }
            else
                this.textBoxAnalysisNewNumber.BackColor = System.Drawing.SystemColors.Window;

            if (this.radioButtonAnalysisRestrictToNumber.Checked && this.textBoxAnalysisRestrictToNumber.Text.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please enter the number to which the analysis should be restricted");
                this.textBoxAnalysisRestrictToNumber.BackColor = System.Drawing.Color.Pink;
                OK = false;
            }
            else
                this.textBoxAnalysisRestrictToNumber.BackColor = System.Drawing.SystemColors.Window;

            if (this.checkBoxAnalysisRestrictToResult.Checked && this.comboBoxAnalysisRestrictToResult.Text.Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please enter the number to which the analysis should be restricted");
                this.comboBoxAnalysisRestrictToResult.BackColor = System.Drawing.Color.Pink;
                OK = false;
            }
            else
                this.comboBoxAnalysisRestrictToResult.BackColor = System.Drawing.SystemColors.Window;

            return OK;
        }

        private string AnalysisSqlInsert()
        {
            string SQL = "INSERT INTO [dbo].[IdentificationUnitAnalysis] " +
               "([CollectionSpecimenID] " +
               ",[IdentificationUnitID] " +
               ",[AnalysisID] " +
               ",[AnalysisNumber] " +
               ",[AnalysisResult] " +
               //",[ExternalAnalysisURI] " +
               ",[ResponsibleName] " +
               ",[ResponsibleAgentURI] " +
               ",[AnalysisDate] " +
               ",[SpecimenPartID] " +
               ",[Notes])" +
               this.AnalysisSqlSelect(false);
            return SQL;
        }

        private string AnalysisSqlSelect(bool ForNumberCheck)
        {
            string SQL = "SELECT ";
            if (ForNumberCheck)
                SQL += "DISTINCT AnalysisNumber ";
            else
            {
                SQL += "A.[CollectionSpecimenID] " +
                ",A.[IdentificationUnitID] " +
                ",A.[AnalysisID] " +
                ", '" + this.textBoxAnalysisNewNumber.Text + "' AS AnalysisNumber " +
                //",A.[AnalysisNumber] " +
                ", '" + this.comboBoxAnalysisNewResult.Text + "' AS AnalysisResult " +
                //",A.[AnalysisResult] " +
                //",A.[ExternalAnalysisURI] " +
                ", '" + this.userControlModuleRelatedEntryAnalysisResponsible.textBoxValue.Text + "' AS ResponsibleName" +
                //",A.[ResponsibleName] " +
                ", '" + this.userControlModuleRelatedEntryAnalysisResponsible.labelURI.Text + "' AS ResponsibleAgentURI " +
                //",A.[ResponsibleAgentURI] " +
                ", getdate()  AS AnalysisDate " +
                //",A.[AnalysisDate] " +
                ",A.[SpecimenPartID] " +
                ", '" + this.textBoxAnalysisNotes.Text + "' AS Notes ";
                //",A.[Notes] " +
            }
            SQL += "FROM [dbo].[IdentificationUnitAnalysis] A " +
            ", CollectionProject P " +
            ", IdentificationUnit U " +
            ", Identification I " +
            "WHERE A.CollectionSpecimenID = P.CollectionSpecimenID " +
            "AND P.ProjectID = " + this.comboBoxAnalysisProject.SelectedValue.ToString() +
            "AND U.IdentificationUnitID = A.IdentificationUnitID " +
            "AND U.TaxonomicGroup = '" + this.comboBoxAnalysisTaxonomicGroup.SelectedValue.ToString() + "'  " +
            "AND U.IdentificationUnitID = I.IdentificationUnitID ";
            if (this.userControlModuleRelatedEntryAnalysisIdentification.textBoxValue.Text.Length > 0)
                SQL += "AND I.TaxonomicName = '" + this.userControlModuleRelatedEntryAnalysisIdentification.textBoxValue.Text + "' ";
            if (this.userControlModuleRelatedEntryAnalysisIdentification.labelURI.Text.Length > 0)
                SQL += "AND I.NameURI = '" + this.userControlModuleRelatedEntryAnalysisIdentification.labelURI.Text + "' ";
            if (this.textBoxAnalysisRestrictToNumber.Text.Length > 0 && !ForNumberCheck)
                SQL += "AND A.AnalysisNumber = '" + this.textBoxAnalysisRestrictToNumber.Text + "' ";
            if (this.comboBoxAnalysisRestrictToResult.Text.Length > 0)
                SQL += "AND A.AnalysisResult = '" + this.comboBoxAnalysisRestrictToResult.Text + "' ";
            if (!ForNumberCheck)
            {
                SQL += "GROUP BY A.[CollectionSpecimenID] " +
                   ",A.[IdentificationUnitID] " +
                   ",A.[AnalysisID] " +
                   ",A.[SpecimenPartID]";
            }
            return SQL;
        }

        private System.Data.DataTable _DtAnalysis;

        private void buttonAnalysisTest_Click(object sender, EventArgs e)
        {
            this.buttonAnalysisStartInsert.Enabled = false;
            if (this.AnalysisValuesSet())
            {
                Microsoft.Data.SqlClient.SqlDataAdapter ad = new Microsoft.Data.SqlClient.SqlDataAdapter(this.AnalysisSqlSelect(false), DiversityWorkbench.Settings.ConnectionString);
                this._DtAnalysis = new DataTable();
                ad.Fill(this._DtAnalysis);
                this.dataGridViewAnalysis.DataSource = this._DtAnalysis;
                if (this._DtAnalysis.Rows.Count > 0)
                    this.buttonAnalysisStartInsert.Enabled = true;
            }
        }

        private void buttonAnalysisStartInsert_Click(object sender, EventArgs e)
        {
            string Message = "";
            if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(this.AnalysisSqlInsert(), ref Message))
                System.Windows.Forms.MessageBox.Show("Insert successful");
            else
                System.Windows.Forms.MessageBox.Show("Insert failed: " + Message);
        }

#endregion

#endregion

#region Merge events

        private System.Data.DataTable _DtMergeEventsMain;
        private string _MergeEventsProjectID;
        private DiversityCollection.UserControls.UserControl_Event _UCMergeEvents;
        private Microsoft.Data.SqlClient.SqlDataAdapter _sqlDataAdapterEvent;
        private DiversityCollection.Datasets.DataSetCollectionSpecimen.CollectionEventDataTable _DtMergeEvents;
        private System.Windows.Forms.BindingSource _collectionMergeEventBindingSource;

        private void tabControlCollectionEvent_Selecting(object sender, TabControlCancelEventArgs e)
        {
            this.initMergeEvents();
        }

        private void initMergeEvents()
        {
            try
            {
                this.numericUpDownMergeEventsRestrictYear.Value = System.DateTime.Now.Year;
                this.numericUpDownMergeEventsRestrictYear.Maximum = System.DateTime.Now.Year + 1;

                string SQL = "select C.COLUMN_NAME from INFORMATION_SCHEMA.COLUMNS C where C.TABLE_NAME = 'CollectionEvent' ";
                System.Data.DataTable dt = new DataTable();
                string Message = "";
                DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dt, ref Message);
                this.checkedListBoxMergeEventsIncludeEvent.Items.Clear();
                foreach (System.Data.DataRow R in dt.Rows)
                {
                    if (!this.MergeEventsExclusionColumns().Contains(R[0].ToString()) && !R[0].ToString().StartsWith("xx"))
                        this.checkedListBoxMergeEventsIncludeEvent.Items.Add(R[0].ToString(), true);
                }

                System.Data.DataRow[] rr = DiversityCollection.LookupTable.DtLocalisationSystem.Select("", "DisplayText, LocalisationSystemID");
                this.checkedListBoxMergeEventsIncludeLocalisation.Items.Clear();
                foreach (System.Data.DataRow R in rr)// DiversityCollection.LookupTable.DtLocalisationSystem.Rows)
                {
                    this.checkedListBoxMergeEventsIncludeLocalisation.Items.Add(R["LocalisationSystemID"].ToString() + " = " + R["DisplayText"].ToString(), true);
                }

                this.checkedListBoxMergeEventsIncludeProperty.Items.Clear();
                foreach (System.Data.DataRow R in DiversityCollection.LookupTable.DtProperty.Rows)
                {
                    this.checkedListBoxMergeEventsIncludeProperty.Items.Add(R["PropertyID"].ToString() + " = " + R["PropertyName"].ToString(), true);
                }

                this.checkedListBoxMergeEventsIncludeMethods.Items.Clear();
                foreach (System.Data.DataRow R in DiversityCollection.LookupTable.DtMethodEvent.Rows)
                {
                    this.checkedListBoxMergeEventsIncludeMethods.Items.Add(R["MethodID"].ToString() + " = " + R["DisplayText"].ToString(), true);
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void comboBoxMergeEventsProject_SelectionChangeCommitted(object sender, EventArgs e)
        {
            this.buttonMergeEventsSearch.Enabled = true;
        }

        private void buttonMergeEventsSearch_Click(object sender, EventArgs e)
        {
            try
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                this.treeViewMergeEvents.Nodes.Clear();
                System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxMergeEventsProject.SelectedItem;
                _MergeEventsProjectID = RP["ProjectID"].ToString();
                string SQL = this.MergeEventsSql(_MergeEventsProjectID);
                _DtMergeEventsMain = new DataTable();
                string Message = "";
                DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref _DtMergeEventsMain, ref Message);
                this.progressBarMergeEvents.Minimum = 0;
                this.progressBarMergeEvents.Maximum = _DtMergeEventsMain.Rows.Count;
                this.progressBarMergeEvents.Value = 0;
                this.progressBarMergeEvents.Visible = true;
                foreach (System.Data.DataRow R in _DtMergeEventsMain.Rows)
                {
                    if (this.progressBarMergeEvents.Value < this.progressBarMergeEvents.Maximum)
                    {
                        this.progressBarMergeEvents.Value++;
                        System.Windows.Forms.Application.DoEvents();
                    }
                    System.Collections.Generic.List<string> MergedEventIDs = new List<string>();
                    string Title = R["CollectionEventID"].ToString() + "  =  " + this.MergeEventsNodeText(R["CollectionEventID"].ToString());
                    System.Windows.Forms.TreeNode N = new TreeNode(Title, 37, 37);
                    N.Tag = R["CollectionEventID"].ToString();
                    N.Checked = true;
                    this.treeViewMergeEvents.Nodes.Add(N);
                    this.MergeEventsAddSpecimen(R["CollectionEventID"].ToString(), N, false);
                    SQL = this.MergeEventsSql(_MergeEventsProjectID, R["CollectionEventID"].ToString(), MergedEventIDs);
                    string Result = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL);
                    if (MergedEventIDs.Contains(Result))
                    {
                        continue;
                    }
                    else
                    {
                        System.Windows.Forms.TreeNode NC = new TreeNode(Result, 1, 1);
                        NC.Tag = Result;
                        NC.Checked = true;
                        N.Nodes.Add(NC);
                        this.MergeEventsAddSpecimen(Result, NC, true);
                        while (!MergedEventIDs.Contains(Result) && Result.Length > 0)
                        {
                            MergedEventIDs.Add(Result);
                            SQL = this.MergeEventsSql(_MergeEventsProjectID, R["CollectionEventID"].ToString(), MergedEventIDs);
                            Result = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL);
                            if (Result == R["CollectionEventID"].ToString() || Result.Length == 0)
                                continue;
                            else if (MergedEventIDs.Contains(Result))
                                break;
                            else
                            {
                                System.Windows.Forms.TreeNode NN = new TreeNode(Result, 1, 1);
                                NN.Checked = true;
                                NN.Tag = Result;
                                N.Nodes.Add(NN);
                                this.MergeEventsAddSpecimen(Result, NN, true);
                            }
                        }
                    }
                }
                this.progressBarMergeEvents.Visible = false;
                this.treeViewMergeEvents.ExpandAll();
                this.Cursor = System.Windows.Forms.Cursors.Default;
                if (this.treeViewMergeEvents.Nodes.Count > 0)
                    this.buttonMergeEvents.Enabled = true;
                else
                    System.Windows.Forms.MessageBox.Show("No events with matching information detected.");
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void MergeEventsAddSpecimen(string EventID, System.Windows.Forms.TreeNode N, bool CheckSpecimen)
        {
            string SQL = "SELECT CASE WHEN [AccessionNumber] IS NULL THEN '[ID: ' + CAST([CollectionSpecimenID] AS varchar) + ']' ELSE [AccessionNumber] END AS Specimen, CollectionSpecimenID  " +
                "FROM CollectionSpecimen AS s " +
                "WHERE CollectionEventID = " + EventID;
            System.Data.DataTable dt = new DataTable();
            string Message = "";
            DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dt, ref Message);
            foreach (System.Data.DataRow R in dt.Rows)
            {
                System.Windows.Forms.TreeNode T = new TreeNode(R[0].ToString(), 0, 0);
                N.Nodes.Add(T);
                T.Checked = CheckSpecimen;
                T.Tag = R[1].ToString();
                if (!CheckSpecimen)
                    T.ForeColor = System.Drawing.Color.Gray;
            }
        }

        private string MergeEventsSql(string ProjectID = "", string MinCollectionEventID = "", System.Collections.Generic.List<string> EventIDs = null)
        {
            string SQL = "SELECT ";
            if (MinCollectionEventID.Length > 0)
                SQL += " TOP 1 MAX";
            else
            {
                SQL += " DISTINCT ";
                if (this.checkBoxMergeEventsRestrictCount.Checked)
                    SQL += " TOP " + this.numericUpDownMergeEventsRestrictCount.Value.ToString();
                SQL += " MIN";
            }
            SQL += "(E.CollectionEventID) AS CollectionEventID " +
                "FROM CollectionEvent AS E " +
                "INNER JOIN CollectionSpecimen AS S ON E.CollectionEventID = S.CollectionEventID  " +
                "INNER JOIN CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID ";
            if (this.checkBoxMergeEventsIncludeImages.Checked)
                SQL += "LEFT OUTER JOIN CollectionEventImage AS I ON E.CollectionEventID = I.CollectionEventID ";
            foreach (System.Object o in this.checkedListBoxMergeEventsIncludeLocalisation.CheckedItems)
            {
                string ID = o.ToString();
                ID = ID.Substring(0, ID.IndexOf("=") - 1).Trim();
                string Alias = "L_" + ID;
                SQL += " LEFT OUTER JOIN CollectionEventLocalisation AS " + Alias + " ON E.CollectionEventID = " + Alias + ".CollectionEventID AND " + Alias + ".LocalisationSystemID = " + ID;
            }
            foreach (System.Object o in this.checkedListBoxMergeEventsIncludeProperty.CheckedItems)
            {
                string ID = o.ToString();
                ID = ID.Substring(0, ID.IndexOf("=") - 1).Trim();
                string Alias = "P_" + ID;
                SQL += " LEFT OUTER JOIN CollectionEventProperty AS " + Alias + " ON E.CollectionEventID = " + Alias + ".CollectionEventID AND " + Alias + ".PropertyID = " + ID;
            }
            foreach (System.Object o in this.checkedListBoxMergeEventsIncludeMethods.CheckedItems)
            {
                string ID = o.ToString();
                ID = ID.Substring(0, ID.IndexOf("=") - 1).Trim();
                string Alias = "M_" + ID;
                SQL += " LEFT OUTER JOIN CollectionEventMethod AS " + Alias + " ON E.CollectionEventID = " + Alias + ".CollectionEventID AND " + Alias + ".MethodID = " + ID;
            }

            //if (this.checkBoxMergeEventsIncludeLocalisation.Checked)
            //    SQL += "LEFT OUTER JOIN CollectionEventLocalisation AS L ON E.CollectionEventID = L.CollectionEventID ";
            //if (this.checkBoxMergeEventsIncludeMethods.Checked)
            //    SQL += "LEFT OUTER JOIN CollectionEventMethod M ON E.CollectionEventID = M.CollectionEventID ";
            //if (this.checkBoxMergeEventsIncludeProperty.Checked)
            //    SQL += "LEFT OUTER JOIN CollectionEventProperty H ON E.CollectionEventID = H.CollectionEventID ";
            bool RestrictToProjectList = true;
            if (ProjectID.Length > 0 || this.checkBoxMergeEventsRestrictYear.Checked || this.checkBoxMergeEventsRestrictCountry.Checked)
            {
                SQL += " WHERE 1 = 1";
                if (ProjectID.Length > 0)
                { 
                    SQL += " AND P.ProjectID = " + ProjectID;
                    RestrictToProjectList = false;
                }
                if (this.checkBoxMergeEventsRestrictYear.Checked)
                    SQL += " AND E.CollectionYear = " + this.numericUpDownMergeEventsRestrictYear.Value.ToString();
                if (this.checkBoxMergeEventsRestrictCountry.Checked && this.comboBoxMergeEventsRestrictCountry.SelectedValue.ToString().Length > 0)
                    SQL += " AND E.CountryCache = '" + this.comboBoxMergeEventsRestrictCountry.SelectedValue.ToString() + "' ";
            }
            if (RestrictToProjectList)
            {
                SQL += " AND P.ProjectID IN (SELECT ProjectID FROM ProjectList) ";
            }
            if (EventIDs != null && EventIDs.Count > 0)
            {
                string IDs = "";
                foreach (string ID in EventIDs)
                {
                    if (IDs.Length > 0)
                        IDs += ", ";
                    IDs += ID;
                }
                SQL += " AND E.CollectionEventID NOT IN (" + IDs + ") ";
            }
            SQL += " GROUP BY " + this.MergeEventsEventColumns("E");
            ///*E.Version,*/ E.SeriesID, E.CollectorsEventNumber, E.CollectionDate, E.CollectionDay, E.CollectionMonth, E.CollectionYear, E.CollectionEndDay, E.CollectionEndMonth, E.CollectionEndYear, E.CollectionDateSupplement, " +
            //"E.CollectionDateCategory, E.CollectionTime, E.CollectionTimeSpan, E.LocalityDescription, E.LocalityVerbatim, E.HabitatDescription, E.ReferenceTitle, E.ReferenceURI, E.ReferenceDetails, E.CollectingMethod, E.Notes,  " +
            //"E.CountryCache, E.DataWithholdingReason, E.DataWithholdingReasonDate";
            foreach (System.Object o in this.checkedListBoxMergeEventsIncludeLocalisation.CheckedItems)
            {
                string ID = o.ToString();
                ID = ID.Substring(0, ID.IndexOf("=") - 1).Trim();
                string Alias = "L_" + ID;
                SQL += this.MergeEventsTableColumn("CollectionEventLocalisation", Alias);
            }
            foreach (System.Object o in this.checkedListBoxMergeEventsIncludeProperty.CheckedItems)
            {
                string ID = o.ToString();
                ID = ID.Substring(0, ID.IndexOf("=") - 1).Trim();
                string Alias = "P_" + ID;
                SQL += this.MergeEventsTableColumn("CollectionEventProperty", Alias);
            }
            foreach (System.Object o in this.checkedListBoxMergeEventsIncludeMethods.CheckedItems)
            {
                string ID = o.ToString();
                ID = ID.Substring(0, ID.IndexOf("=") - 1).Trim();
                string Alias = "M_" + ID;
                SQL += this.MergeEventsTableColumn("CollectionEventMethod", Alias);
            }
            if (this.checkBoxMergeEventsIncludeImages.Checked)
                SQL += ", I.URI, I.ResourceURI, I.ImageType, I.Notes,  " +
                "I.Title, I.IPR, I.CreatorAgent, I.CreatorAgentURI, I.CopyrightStatement, I.LicenseType, I.InternalNotes, I.LicenseHolder, I.LicenseHolderAgentURI, I.LicenseYear, I.DataWithholdingReason";            //if (this.checkBoxMergeEventsIncludeLocalisation.Checked)
            //    SQL += ", L.LocalisationSystemID, L.Location1, L.Location2, L.LocationAccuracy, L.LocationNotes, L.DeterminationDate, L.DistanceToLocation,  " +
            //    "L.DirectionToLocation, L.ResponsibleName, L.ResponsibleAgentURI, L.RecordingMethod, L.AverageAltitudeCache, L.AverageLatitudeCache, L.AverageLongitudeCache";

            //if (this.checkBoxMergeEventsIncludeMethods.Checked)
            //    SQL += ", M.MethodID,";
            //if (this.checkBoxMergeEventsIncludeProperty.Checked)
            //    SQL += "H.PropertyID, " +
            //    "H.DisplayText, H.PropertyURI, H.PropertyHierarchyCache, H.PropertyValue, H.ResponsibleName, H.ResponsibleAgentURI, H.Notes, H.AverageValueCache ";
            if (MinCollectionEventID.Length == 0)
                SQL += " HAVING(COUNT(DISTINCT E.CollectionEventID) > 1) ";
            else
                SQL += " HAVING(MIN(E.CollectionEventID) = " + MinCollectionEventID + ")";
            if (MinCollectionEventID.Length > 0)
                SQL += " ORDER BY CollectionEventID DESC ";
            return SQL;
        }

        private string MergeEventsEventColumns(string Alias)
        {
            string Columns = "";
            foreach (System.Object o in this.checkedListBoxMergeEventsIncludeEvent.CheckedItems)
            {
                if (Columns.Length > 0)
                    Columns += ", ";
                Columns += Alias + "." + o.ToString();
            }
            return Columns;
        }

        private string MergeEventsTableColumn(string Table, string Alias)
        {
            string Columns = "";
            string SQL = "select C.COLUMN_NAME from INFORMATION_SCHEMA.COLUMNS C where C.TABLE_NAME = '" + Table + "'";
            System.Data.DataTable dt = new DataTable();
            string Message = "";
            DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dt, ref Message);
            foreach (System.Data.DataRow R in dt.Rows)
            {
                if (!this.MergeEventsExclusionColumns().Contains(R[0].ToString()))
                {
                    Columns += ", " + Alias + "." + R[0].ToString();
                }
            }
            return Columns;
        }

        private System.Collections.Generic.List<string> MergeEventsExclusionColumns()
        {
            System.Collections.Generic.List<string> L = new List<string>();
            L.Add("CollectionEventID");
            L.Add("Version");
            L.Add("CollectionDate");
            L.Add("RowGUID");
            L.Add("LogUpdatedBy");
            L.Add("LogUpdatedWhen");
            L.Add("LogCreatedBy");
            L.Add("LogCreatedWhen");
            L.Add("Description");
            L.Add("Geography");
            L.Add("PropertyHierarchyCache");
            return L;
        }

        private string MergeEventsSql(string Table, string Alias, System.Collections.Generic.List<string> NotEqualColumns, System.Collections.Generic.List<string> ExcludeColumns, bool ForGroupBy = false)
        {
            string SQL = "";
            System.Data.DataTable dt = new DataTable();
            string Message = "";
            DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dt, ref Message);
            foreach (System.Data.DataRow R in dt.Rows)
            {
                string C = R[0].ToString();
                if (ExcludeColumns.Contains(C))
                    continue;
                if (SQL.Length > 0)
                    SQL += " AND ";
                if (NotEqualColumns.Contains(C))
                    SQL += Alias + "." + C + " <> " + Alias + "2." + C;
                else
                    SQL += "(" + Alias + "." + C + " = " + Alias + "2." + C + " OR (" + Alias + "." + C + " IS NULL AND " + Alias + "2." + C + " IS NULL ))";
            }
            return SQL;
        }

        private string MergeEventsNodeText(string EventID)
        {
            string Title = "";
            try
            {
                string SQL = "SELECT * FROM CollectionEvent E WHERE E.CollectionEventID = " + EventID;
                string Message = "";
                System.Data.DataTable dt = new DataTable("CollectionEvent");
                DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dt, ref Message);
                if (dt.Rows.Count == 1)
                {
                    System.Data.DataRow _DataRow = dt.Rows[0];
                    Title = DiversityCollection.HierarchyNode.DisplayText(_DataRow);
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            return Title;
        }

        private void treeViewMergeEvents_AfterSelect(object sender, TreeViewEventArgs e)
        {
            try
            {
                if (this.treeViewMergeEvents.SelectedNode.Tag != null && this.treeViewMergeEvents.SelectedNode.Nodes.Count > 0 && this.treeViewMergeEvents.SelectedNode.ImageIndex > 0)
                {
                    this._DtMergeEvents = new Datasets.DataSetCollectionSpecimen.CollectionEventDataTable();
                    string WhereClause = " WHERE CollectionEventID = " + this.treeViewMergeEvents.SelectedNode.Tag.ToString();
                    this.FormFunctions.initSqlAdapter(ref this._sqlDataAdapterEvent, DiversityCollection.CollectionSpecimen.SqlEvent + WhereClause, this._DtMergeEvents);
                    if (this._UCMergeEvents == null && this._DtMergeEvents != null)
                    {
                        this._UCMergeEvents = new UserControls.UserControl_Event();
                        this._UCMergeEvents.setReadOnly();
                        this._collectionMergeEventBindingSource = new System.Windows.Forms.BindingSource(this.components);
                        ((System.ComponentModel.ISupportInitialize)(this._collectionMergeEventBindingSource)).BeginInit();
                        this._collectionMergeEventBindingSource.DataSource = this._DtMergeEvents;
                        //this._collectionMergeEventBindingSource.DataMember = "CollectionEvent";
                        ((System.ComponentModel.ISupportInitialize)(this._collectionMergeEventBindingSource)).EndInit();
                        this._UCMergeEvents.setSource(this._collectionMergeEventBindingSource);
                    }
                    if (this._collectionMergeEventBindingSource != null)
                        this._collectionMergeEventBindingSource.DataSource = this._DtMergeEvents;
                    if (this.panelMergeEventsEventControl.Controls.Count == 0)
                    {
                        this.panelMergeEventsEventControl.Controls.Add(this._UCMergeEvents);
                        this._UCMergeEvents.Dock = DockStyle.Fill;
                    }
                    if (this.treeViewMergeEvents.SelectedNode.Nodes.Count == 0 && this.treeViewMergeEvents.SelectedNode.ImageIndex == 0 && this.treeViewMergeEvents.SelectedNode.Tag != null)
                    {
                        this.buttonMergeEventsShowDetails.Enabled = true;
                        this.buttonMergeEventsInspect.Enabled = false;
                        this.buttonMergeEventsTransferMissing.Enabled = false;
                    }
                    else
                    {
                        this.buttonMergeEventsShowDetails.Enabled = false;
                        this.buttonMergeEventsInspect.Enabled = true;
                        if (this.treeViewMergeEvents.SelectedNode == this.treeViewMergeEvents.Nodes[0])
                            this.buttonMergeEventsTransferMissing.Enabled = false;
                        else
                            this.buttonMergeEventsTransferMissing.Enabled = true;
                    }
                }
                else if (this.treeViewMergeEvents.SelectedNode.Nodes.Count == 0 && this.treeViewMergeEvents.SelectedNode.ImageIndex == 0 && this.treeViewMergeEvents.SelectedNode.Tag != null)
                {
                    this.buttonMergeEventsShowDetails.Enabled = true;
                    this.buttonMergeEventsInspect.Enabled = false;
                    this.buttonMergeEventsTransferMissing.Enabled = false;
                }
                else
                {
                    this.buttonMergeEventsShowDetails.Enabled = false;
                    this.buttonMergeEventsInspect.Enabled = false;
                    this.buttonMergeEventsTransferMissing.Enabled = false;
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonMergeEventsShowDetails_Click(object sender, EventArgs e)
        {
            int ID;
            if (int.TryParse(this.treeViewMergeEvents.SelectedNode.Tag.ToString(), out ID))
            {
                DiversityCollection.Forms.FormCollectionSpecimen f = new Forms.FormCollectionSpecimen(ID, false, false, Forms.FormCollectionSpecimen.ViewMode.SingleInspectionMode, true);
                f.Show();
            }
        }

        private void buttonMergeEvents_Click(object sender, EventArgs e)
        {
            string NewEventID = "";
            string ReplacedID = "";
            try
            {
                foreach (System.Windows.Forms.TreeNode T in this.treeViewMergeEvents.Nodes)
                {
                    if (T.Checked)
                    {
                        NewEventID = T.Tag.ToString();
                        foreach (System.Windows.Forms.TreeNode C in T.Nodes)
                        {
                            if (C.Checked && C.Tag != null)
                            {
                                ReplacedID = C.Tag.ToString();
                                foreach (System.Windows.Forms.TreeNode S in C.Nodes)
                                {
                                    if (S.Checked)
                                    {
                                        string SQL = "UPDATE S SET CollectionEventID = " + NewEventID +
                                            " FROM CollectionSpecimen S, CollectionProject P " +
                                            " WHERE S.CollectionSpecimenID = P.CollectionSpecimenID " +
                                            " AND S.CollectionEventID = " + ReplacedID +
                                            " AND S.CollectionSpecimenID = " + S.Tag.ToString() +
                                            " AND P.ProjectID = " + this._MergeEventsProjectID;
                                        DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL);
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
            this.treeViewMergeEvents.Nodes.Clear();
        }

        private void treeViewMergeEvents_NodeMouseClick(object sender, TreeNodeMouseClickEventArgs e)
        {
            try
            {
                System.Windows.Forms.TreeNode TN = e.Node;
                // Specimen in MergeEvents
                if (TN.ForeColor == System.Drawing.Color.Gray)
                {
                    TN.Checked = false;
                    return;
                }

                bool OK = TN.Checked;
                foreach (System.Windows.Forms.TreeNode N in TN.Nodes)
                {
                    if (N.Tag == null) // Specimen in MergeEvents
                        continue;
                    N.Checked = OK;
                    foreach (System.Windows.Forms.TreeNode nn in N.Nodes)
                        nn.Checked = OK;
                }
                if (OK)
                {
                    if (TN.Parent != null)
                    {
                        TN.Parent.Checked = true;
                        if (TN.Parent.Parent != null)
                            TN.Parent.Parent.Checked = true;
                    }
                }
            }
            catch (System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonMergeEventsIncludeLocalisationAll_Click(object sender, EventArgs e)
        {
            for (int i = 0; i < checkedListBoxMergeEventsIncludeLocalisation.Items.Count; i++)
            {
                checkedListBoxMergeEventsIncludeLocalisation.SetItemChecked(i, true);
            }
        }

        private void buttonMergeEventsIncludeLocalisationNone_Click(object sender, EventArgs e)
        {
            for (int i = 0; i < checkedListBoxMergeEventsIncludeLocalisation.Items.Count; i++)
            {
                checkedListBoxMergeEventsIncludeLocalisation.SetItemChecked(i, false);
            }
        }

        private void comboBoxMergeEventsRestrictCountry_DropDown(object sender, EventArgs e)
        {
            System.Data.DataRowView RP = (System.Data.DataRowView)this.comboBoxMergeEventsProject.SelectedItem;
            _MergeEventsProjectID = RP["ProjectID"].ToString();
            string SQL = "SELECT DISTINCT E.CountryCache " +
                "FROM CollectionEvent AS E";
            if (_MergeEventsProjectID.Length > 0)
                SQL += " INNER JOIN CollectionSpecimen AS S ON E.CollectionEventID = S.CollectionEventID " +
                    "INNER JOIN CollectionProject AS P ON S.CollectionSpecimenID = P.CollectionSpecimenID " +
                    "WHERE P.ProjectID = " + _MergeEventsProjectID;
            if (this.comboBoxMergeEventsRestrictCountry.Text.Length > 0)
            {
                if (_MergeEventsProjectID.Length > 0)
                    SQL += " AND ";
                else
                    SQL += " WHERE ";
                SQL += " E.CountryCache LIKE '" + this.comboBoxMergeEventsRestrictCountry.Text + "%'";
            }
            SQL += " ORDER BY CountryCache";
            System.Data.DataTable dtCountry = new DataTable();
            string Message = "";
            DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dtCountry, ref Message);
            this.comboBoxMergeEventsRestrictCountry.DataSource = dtCountry;
            this.comboBoxMergeEventsRestrictCountry.DisplayMember = "CountryCache";
            this.comboBoxMergeEventsRestrictCountry.ValueMember = "CountryCache";

        }


        private void buttonMergeEventsIncludeMethodsNone_Click(object sender, EventArgs e)
        {
            for (int i = 0; i < this.checkedListBoxMergeEventsIncludeMethods.Items.Count; i++)
            {
                checkedListBoxMergeEventsIncludeMethods.SetItemChecked(i, false);
            }
        }

        private void buttonMergeEventsIncludeMethodsAll_Click(object sender, EventArgs e)
        {
            for (int i = 0; i < this.checkedListBoxMergeEventsIncludeMethods.Items.Count; i++)
            {
                checkedListBoxMergeEventsIncludeMethods.SetItemChecked(i, true);
            }
        }

        private void buttonMergeEventsIncludePropertyNone_Click(object sender, EventArgs e)
        {
            for (int i = 0; i < this.checkedListBoxMergeEventsIncludeProperty.Items.Count; i++)
            {
                checkedListBoxMergeEventsIncludeProperty.SetItemChecked(i, false);
            }
        }

        private void buttonMergeEventsIncludePropertyAll_Click(object sender, EventArgs e)
        {
            for (int i = 0; i < this.checkedListBoxMergeEventsIncludeProperty.Items.Count; i++)
            {
                checkedListBoxMergeEventsIncludeProperty.SetItemChecked(i, true);
            }
        }

        private void buttonMergeEventsTransferMissing_Click(object sender, EventArgs e)
        {
            int TargetID;
            string Message = "";
            if (int.TryParse(this.treeViewMergeEvents.SelectedNode.Parent.Tag.ToString(), out TargetID))
            {
                int SourceID;
                if (int.TryParse(this.treeViewMergeEvents.SelectedNode.Tag.ToString(), out SourceID))
                {
                    System.Collections.Generic.List<string> TT = new List<string>();
                    TT.Add("CollectionEvent");
                    TT.Add("CollectionEventImage");
                    TT.Add("CollectionEventLocalisation");
                    TT.Add("CollectionEventMethod");
                    TT.Add("CollectionEventParameterValue");
                    TT.Add("CollectionEventProperty");
                    TT.Add("CollectionEventRegulation");
                    foreach (string T in TT)
                    {
                        Message += this.MergeEventsTransferMissingData(SourceID, TargetID, T);
                        if (Message.Length > 0)
                            Message += "\r\n\r\n";
                    }
                }
            }
            if (Message.Length == 0)
                System.Windows.Forms.MessageBox.Show("Data copied");
            else
                System.Windows.Forms.MessageBox.Show("Error during copy:\r\n\r\n" + Message);
        }

        private string MergeEventsTransferMissingData(int SourceID, int TargetID, string Table)
        {
            string Message = "";
            // Update missing content
            DiversityWorkbench.Data.Table T = new DiversityWorkbench.Data.Table(Table, DiversityWorkbench.Settings.ConnectionString);
            // Update existing data
            foreach (System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.Data.Column> C in T.Columns)
            {
                if (T.PrimaryKeyColumnList.Contains(C.Key))
                    continue;
                if (C.Key.ToLower() == "rowguid" ||
                    C.Key.ToLower().StartsWith("logcreated") ||
                    C.Key.ToLower().StartsWith("logupdated") ||
                    C.Key.ToLower().StartsWith("loginserted"))
                    continue;

                string SQL = "UPDATE T SET T." + C.Key + " = S." + C.Key + " FROM " + T.Name + " AS T, " + T.Name + " AS S " +
                    " WHERE (T." + C.Key + " IS NULL ";
                if (C.Value.DataType != "xml" && C.Value.DataType != "geography")
                    SQL += " OR T." + C.Key + " = ''";
                SQL += " ) ";
                SQL += " AND T.CollectionEventID = " + TargetID.ToString();
                SQL += " AND S.CollectionEventID = " + SourceID.ToString();
                foreach (string P in T.PrimaryKeyColumnList)
                {
                    if (P == "CollectionEventID")
                    {
                        continue;
                    }
                    else
                        SQL += " AND T." + P + " = S." + P;
                }
                int ErrorCode = 0;
                DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL, ref Message, ref ErrorCode);
                if (Message.Length > 0)
                { }
            }
            if (T.PrimaryKeyColumnList.Count > 1)
            {
                string SqlInsert = "";
                string SqlValues = "";
                string SQL = "";
                foreach(System.Collections.Generic.KeyValuePair<string, DiversityWorkbench.Data.Column> C in T.Columns)
                {
                    if (C.Key.ToLower() == "rowguid" ||
                        C.Key.ToLower().StartsWith("logcreated") ||
                        C.Key.ToLower().StartsWith("logupdated") ||
                        C.Key.ToLower().StartsWith("loginserted"))
                        continue;
                    if (SqlInsert.Length > 0)
                        SqlInsert += ", ";
                    SqlInsert += C.Key;
                    if (SqlValues.Length > 0)
                        SqlValues += ", ";
                    if (C.Key == "CollectionEventID")
                        SqlValues += TargetID.ToString();
                    else
                        SqlValues += C.Key;
                }
                SQL = "INSERT INTO " + Table + " (" + SqlInsert + ") SELECT " + SqlValues + " FROM " + Table + " AS S WHERE CollectionEventID = " + SourceID +
                    " AND NOT EXISTS (SELECT * FROM " + Table + " T WHERE T.CollectionEventID = " + TargetID.ToString();
                foreach (string P in T.PrimaryKeyColumnList)
                {
                    if (P == "CollectionEventID")
                        continue;
                    SQL += " AND T." + P + " = S." + P;
                }
                    SQL += " )";
                int ErrorCode = 0;
                DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL, ref Message, ref ErrorCode);
                if (Message.Length > 0)
                { }
            }
            return Message;
        }

        private void buttonMergeEventsInspect_Click(object sender, EventArgs e)
        {
            try
            {
                int SourceID;
                if (int.TryParse(this.treeViewMergeEvents.SelectedNode.Tag.ToString(), out SourceID))
                {
                    DiversityCollection.Forms.FormCollectionEvent f = new Forms.FormCollectionEvent(SourceID, true, false, true);
                    f.Show();
                }
            }
            catch(System.Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonMergeEventsIncludeEventNone_Click(object sender, EventArgs e)
        {
            for (int i = 0; i < this.checkedListBoxMergeEventsIncludeEvent.Items.Count; i++)
            {
                checkedListBoxMergeEventsIncludeEvent.SetItemChecked(i, false);
            }
        }

        private void buttonMergeEventsIncludeEventAll_Click(object sender, EventArgs e)
        {
            for (int i = 0; i < this.checkedListBoxMergeEventsIncludeEvent.Items.Count; i++)
            {
                checkedListBoxMergeEventsIncludeEvent.SetItemChecked(i, true);
            }
        }

        private void buttonMergeEventsIncludeNone_Click(object sender, EventArgs e)
        {
            for (int i = 0; i < this.checkedListBoxMergeEventsIncludeEvent.Items.Count; i++)
            {
                checkedListBoxMergeEventsIncludeEvent.SetItemChecked(i, false);
            }
            for (int i = 0; i < this.checkedListBoxMergeEventsIncludeMethods.Items.Count; i++)
            {
                checkedListBoxMergeEventsIncludeMethods.SetItemChecked(i, false);
            }
            for (int i = 0; i < this.checkedListBoxMergeEventsIncludeProperty.Items.Count; i++)
            {
                checkedListBoxMergeEventsIncludeProperty.SetItemChecked(i, false);
            }
            for (int i = 0; i < checkedListBoxMergeEventsIncludeLocalisation.Items.Count; i++)
            {
                checkedListBoxMergeEventsIncludeLocalisation.SetItemChecked(i, false);
            }
        }

#endregion

#region Tools

#region Remove C0 codes

#region Parameter

        private int _PositionRemoveHexSigns = 1;
        private System.Collections.Generic.List<int> _RemoveHexSignsExcluded;
        private System.Collections.Generic.Dictionary<string, System.Collections.Generic.List<string>> _RemoveHexSignTableColumns;
        private string _RemoveHexSignTable = "";
        private string _RemoveHexSignColumn = "";
        private bool _RemoveHexSignSingleEnabled = true;
        private int _RemoveHexSignAllCount = 0;

#endregion

#region Single table

        private void comboBoxRemoveHexSignsTable_DropDown(object sender, EventArgs e)
        {
            if (this.comboBoxRemoveHexSignsTable.DataSource == null)
            {
                //string SQL = "select distinct T.TABLE_NAME from INFORMATION_SCHEMA.TABLES T, " +
                //    "INFORMATION_SCHEMA.COLUMNS C " +
                //    "where T.TABLE_TYPE = 'BASE TABLE' " +
                //    "and T.TABLE_NAME = C.TABLE_NAME " +
                //    "and T.TABLE_NAME not like '%_log' " +
                //    "and T.TABLE_NAME not like '%_Enum' " +
                //    "and t.TABLE_NAME not like 'Cache%' " +
                //    "and t.TABLE_NAME not like 'Tool%' " +
                //    "and t.TABLE_NAME not like '%proxy%' " +
                //    "and t.TABLE_NAME not like '%project%' " +
                //    "and T.TABLE_NAME not in ('ApplicationSearchSelectionStrings', 'dtproperties', 'sysdiagrams', 'AnonymCollector', 'AnalysisTaxonomicGroup', 'ProcessingMaterialCategory', 'MethodForProcessing', 'MethodForAnalysis', 'ReplicationPublisher', 'ImportStatus') " +
                //    "and c.DATA_TYPE in ('nvarchar', 'varchar') " +
                //    "order by t.TABLE_NAME";
                //System.Data.DataTable dt = new DataTable();
                //DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dt);
                System.Data.DataTable dt = this.RemoveHexSignTables();
                this.comboBoxRemoveHexSignsTable.DataSource = dt;
                this.comboBoxRemoveHexSignsTable.DisplayMember = "TABLE_NAME";
                this.comboBoxRemoveHexSignsTable.ValueMember = "TABLE_NAME";
                this.comboBoxRemoveHexSignsColumn.DataSource = null;
            }
        }

        private void comboBoxRemoveHexSignsTable_SelectedIndexChanged(object sender, EventArgs e)
        {
            this.comboBoxRemoveHexSignsColumn.DataSource = null;
        }

        private void comboBoxRemoveHexSignsColumn_DropDown(object sender, EventArgs e)
        {
            if (this.comboBoxRemoveHexSignsColumn.DataSource == null)
            {
                if (this.comboBoxRemoveHexSignsTable.SelectedItem == null)
                {
                    System.Windows.Forms.MessageBox.Show("Please select a table");
                    return;
                }
                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxRemoveHexSignsTable.SelectedItem;
                //string SQL = "select distinct C.COLUMN_NAME from INFORMATION_SCHEMA.COLUMNS C " +
                //    "where c.DATA_TYPE in ('nvarchar', 'varchar') " +
                //    "and c.COLUMN_NAME not like 'log%By' " +
                //    "and c.TABLE_NAME = '" + R[0].ToString() + "' " +
                //    "order by c.COLUMN_NAME";
                //System.Data.DataTable dt = new DataTable();
                //DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dt);
                System.Data.DataTable dt = this.RemoveHexSignTableColumns(R[0].ToString());
                this.comboBoxRemoveHexSignsColumn.DataSource = dt;
                this.comboBoxRemoveHexSignsColumn.DisplayMember = "COLUMN_NAME";
                this.comboBoxRemoveHexSignsColumn.ValueMember = "COLUMN_NAME";
            }
        }

        private void buttonRemoveHexSignsStartQuery_Click(object sender, EventArgs e)
        {
            if (this.RemoveHexSignsTable().Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a table");
                return;
            }
            if (this.RemoveHexSignsColumn().Length == 0)
            {
                System.Windows.Forms.MessageBox.Show("Please select a column");
                return;
            }
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            this._PositionRemoveHexSigns = 1;
            this.InitRemoveHexSignsExcluded();
            this.progressBarRemoveHexSigns.Value = 0;
            this.progressBarRemoveHexSigns.Maximum = 33;
            this.RemoveHexSignsQuery();
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private bool RemoveHexSignSingleEnabled
        {
            get
            {
                return this._RemoveHexSignSingleEnabled;
            }
            set
            {
                this._RemoveHexSignSingleEnabled = value;
                this.comboBoxRemoveHexSignsColumn.Enabled = value;
                this.comboBoxRemoveHexSignsTable.Enabled = value;
                this.buttonRemoveHexSignsStartQuery.Enabled = value;
                if (value)
                {
                    this._RemoveHexSignColumn = "";
                    this._RemoveHexSignTable = "";
                }
            }
        }

#endregion
        private void InitRemoveHexSignsExcluded()
        {
            this._RemoveHexSignsExcluded = new List<int>();
            this._RemoveHexSignsExcluded.Add(9);
            this._RemoveHexSignsExcluded.Add(10);
            this._RemoveHexSignsExcluded.Add(13);
            this.labelRemoveHexSignsExcluded.Text = "Excluded: 9, 10, 13";
        }

        private System.Data.DataTable RemoveHexSignTables()
        {
            string SQL = "select distinct T.TABLE_NAME from INFORMATION_SCHEMA.TABLES T, " +
                "INFORMATION_SCHEMA.COLUMNS C " +
                "where T.TABLE_TYPE = 'BASE TABLE' " +
                "and T.TABLE_NAME = C.TABLE_NAME " +
                "and T.TABLE_NAME not like '%_log' " +
                "and T.TABLE_NAME not like '%[_]log%' " +
                "and T.TABLE_NAME not like 'xx_%' " +
                "and T.TABLE_NAME not like '%_Enum' " +
                "and t.TABLE_NAME not like 'Cache%' " +
                "and t.TABLE_NAME not like 'Tool%' " +
                "and t.TABLE_NAME not like '%proxy%' " +
                "and t.TABLE_NAME not like '%project%' " +
                "and T.TABLE_NAME not in ('ApplicationSearchSelectionStrings', 'dtproperties', 'sysdiagrams', 'AnonymCollector', 'AnalysisTaxonomicGroup', 'ProcessingMaterialCategory', 'MethodForProcessing', 'MethodForAnalysis', 'ReplicationPublisher', 'ImportStatus') " +
                "and c.DATA_TYPE in ('nvarchar', 'varchar') " +
                "order by t.TABLE_NAME";
            System.Data.DataTable dt = new DataTable();
            DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dt);
            return dt;
        }

        private System.Data.DataTable RemoveHexSignTableColumns(string TableName)
        {
            string SQL = "select distinct C.COLUMN_NAME from INFORMATION_SCHEMA.COLUMNS C " +
                "where c.DATA_TYPE in ('nvarchar', 'varchar') " +
                "and c.COLUMN_NAME not like 'log%By' " +
                "and c.TABLE_NAME = '" + TableName + "' " +
                "and c.COLUMN_NAME not in (select u.COLUMN_NAME from INFORMATION_SCHEMA.CONSTRAINT_COLUMN_USAGE u " +
                "where u.TABLE_NAME = '" + TableName + "' ) " +
                "order by c.COLUMN_NAME";
            System.Data.DataTable dt = new DataTable();
            DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dt);
            return dt;
        }

        private string RemoveHexSignsTable()
        {
            if (this._RemoveHexSignTable.Length > 0)
                return this._RemoveHexSignTable;

            if (this.comboBoxRemoveHexSignsTable.SelectedItem != null)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxRemoveHexSignsTable.SelectedItem;
                return R[0].ToString();
            }
            return "";
        }

        private string RemoveHexSignsColumn()
        {
            if (this._RemoveHexSignColumn.Length > 0)
                return this._RemoveHexSignColumn;

            if (this.comboBoxRemoveHexSignsColumn.SelectedItem != null)
            {
                System.Data.DataRowView R = (System.Data.DataRowView)this.comboBoxRemoveHexSignsColumn.SelectedItem;
                return R[0].ToString();
            }
            return "";
        }

        private bool RemoveHexSignsQuery()
        {
            bool CharDetected = false;
            int Start = this._PositionRemoveHexSigns;
            for (int i = Start; i < 32; i++)
            {
                this._PositionRemoveHexSigns = i;
                if (this._RemoveHexSignsExcluded != null && this._RemoveHexSignsExcluded.Contains(i))
                    continue;
                this.labelRemoveHexSignsState.Text = "Searching for CHAR(" + i.ToString() + ")";
                System.Windows.Forms.Application.DoEvents();
                string SQL = "select count(*) from [" + this.RemoveHexSignsTable() +
                    "] where [" + this.RemoveHexSignsColumn() + "] like '%' + char(" + i.ToString() + ") + '%'";
                string Result = DiversityWorkbench.Forms.FormFunctions.SqlExecuteScalar(SQL);
                if (Result != "0" && Result.Length > 0)
                {
                    this.labelRemoveHexSignsState.Text = Result + " datasets found for CHAR(" + i.ToString() + ")";
                    this.setRemoveHexSignsSource();
                    CharDetected = true;
                    break;
                }
                if (this.RemoveHexSignSingleEnabled)
                    this.progressBarRemoveHexSigns.Value++;
            }
            if (this._PositionRemoveHexSigns == 31)
            {
                this.dataGridViewRemoveHexSigns.DataSource = null;
                if (this.RemoveHexSignSingleEnabled)
                {
                    this.buttonRemoveHexSignsIgnoreSign.Enabled = false;
                    this.buttonRemoveHexSignsUpdate.Enabled = false;
                    this.progressBarRemoveHexSigns.Value = 0;
                    System.Windows.Forms.MessageBox.Show("Search finished");
                }
                else
                {
                    //this.RemoveHexSignAllTables();
                }
            }
            return CharDetected;
        }

        private void setRemoveHexSignsSource()
        {
            try
            {
                this.buttonRemoveHexSignsUpdate.Enabled = true;
                this.buttonRemoveHexSignsIgnoreSign.Enabled = true;
                string SQL = "select replace(t." + this.RemoveHexSignsColumn() + ", char(" + this._PositionRemoveHexSigns.ToString() + ") , nchar(9632)) AS [" + this.RemoveHexSignsColumn() + " Original Value], " +
                    "replace(t." + this.RemoveHexSignsColumn() + ", char(" + this._PositionRemoveHexSigns.ToString() + "), '') AS [" + this.RemoveHexSignsColumn() + " Corrected Value] " +
                    "from " + this.RemoveHexSignsTable() + " t " +
                    "where t." + this.RemoveHexSignsColumn() + " like '%' + char(" + this._PositionRemoveHexSigns.ToString() + ") + '%'";
                System.Data.DataTable dt = new DataTable();
                DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref dt);
                this.dataGridViewRemoveHexSigns.DataSource = dt;
                this.buttonRemoveHexSignsAllStop.Enabled = true;
                this.buttonRemoveHexSignsAll.Enabled = true;
            }
            catch (Exception ex)
            {
                DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex);
            }
        }

        private void buttonRemoveHexSignsUpdate_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            this.RemoveHexSign();
            this.dataGridViewRemoveHexSigns.DataSource = null;
            this.buttonRemoveHexSignsUpdate.Enabled = false;
            this.buttonRemoveHexSignsIgnoreSign.Enabled = false;
            if (this.RemoveHexSignSingleEnabled)
                this.RemoveHexSignsQuery();
            else
                this.RemoveHexSignAllTables();
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void RemoveHexSign()
        {
            string SQL = "update t set " + this.RemoveHexSignsColumn() + " = " +
               "replace(t." + this.RemoveHexSignsColumn() + ", char(" + this._PositionRemoveHexSigns.ToString() + "), '') " +
               "from " + this.RemoveHexSignsTable() + " t " +
               "where t." + this.RemoveHexSignsColumn() + " like '%' + char(" + this._PositionRemoveHexSigns.ToString() + ") + '%'";
            DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(SQL);
            System.Windows.Forms.MessageBox.Show("CHAR(" + this._PositionRemoveHexSigns.ToString() + ") removed");
        }

        private void buttonRemoveHexSignsIgnoreSign_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            if (this._RemoveHexSignsExcluded == null)
                this._RemoveHexSignsExcluded = new List<int>();
            this._RemoveHexSignsExcluded.Add(this._PositionRemoveHexSigns);
            if (this.labelRemoveHexSignsExcluded.Text.Length == 0)
                this.labelRemoveHexSignsExcluded.Text = "Excluded: " + this._PositionRemoveHexSigns.ToString();
            else
                this.labelRemoveHexSignsExcluded.Text += ", " + this._PositionRemoveHexSigns.ToString();
            this._PositionRemoveHexSigns++;
            if (this.RemoveHexSignSingleEnabled)
                this.RemoveHexSignsQuery();
            else
                this.RemoveHexSignAllTables();
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

#region All tables

        private void buttonRemoveHexSignsAll_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            this.RemoveHexSignSingleEnabled = false;
            this.buttonRemoveHexSignsUpdate.Enabled = false;
            this.buttonRemoveHexSignsIgnoreSign.Enabled = false;
            this.InitRemoveHexSignsExcluded();
            this._RemoveHexSignAllCount = this.RemoveHexSignGetAllTables();
            this.progressBarRemoveHexSigns.Maximum = this._RemoveHexSignAllCount;
            this.progressBarRemoveHexSigns.Value = 0;
            if (_RemoveHexSignAllTablesDone == null)
                _RemoveHexSignAllTablesDone = new List<string>();
            _RemoveHexSignAllTablesDone.Clear();
            this.RemoveHexSignAllTables();
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void buttonRemoveHexSignsAllStop_Click(object sender, EventArgs e)
        {
            if (this._RemoveHexSignTableColumns != null)
                this._RemoveHexSignTableColumns.Clear();
            this.RemoveHexSignSingleEnabled = true;
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private int RemoveHexSignGetAllTables()
        {
            if (this._RemoveHexSignTableColumns == null)
                this._RemoveHexSignTableColumns = new Dictionary<string, List<string>>();
            this._RemoveHexSignTableColumns.Clear();

            int iColCount = 0;
            System.Data.DataTable dt = this.RemoveHexSignTables();
            foreach (System.Data.DataRow R in dt.Rows)
            {
                System.Data.DataTable dtCol = this.RemoveHexSignTableColumns(R[0].ToString());
                System.Collections.Generic.List<string> L = new List<string>();
                foreach (System.Data.DataRow C in dtCol.Rows)
                {
                    L.Add(C[0].ToString());
                    iColCount++;
                }
                this._RemoveHexSignTableColumns.Add(R[0].ToString(), L);
            }

            return iColCount;
        }

        private System.Collections.Generic.List<string> _RemoveHexSignAllTablesDone = new List<string>();

        private void RemoveHexSignAllTables()
        {
            int Position = 0;
            bool Stop = false;
            this.buttonRemoveHexSignsAllStop.Enabled = false;
            this.buttonRemoveHexSignsAll.Enabled = false;
            foreach (System.Collections.Generic.KeyValuePair<string, System.Collections.Generic.List<string>> KV in this._RemoveHexSignTableColumns)
            {
                // getting to start table
                if (this._RemoveHexSignTable.Length == 0)
                    this._RemoveHexSignTable = KV.Key;
                if (_RemoveHexSignAllTablesDone.Contains(KV.Key))
                {
                    Position += KV.Value.Count;
                    continue;
                }
                else
                {
                    this._RemoveHexSignTable = KV.Key;
                }
                this._RemoveHexSignTable = KV.Key;
                this._RemoveHexSignColumn = "";
                System.Collections.Generic.List<string> ColumnsDone = new List<string>();
                foreach (string C in KV.Value)
                {
                    // getting to start column
                    if (this._RemoveHexSignColumn.Length == 0)
                        this._RemoveHexSignColumn = C;
                    Position++;
                    if (ColumnsDone.Contains(C))
                    {
                        continue;
                    }
                    else
                    {
                        this._RemoveHexSignColumn = C;
                    }
                    if (Position <= this.progressBarRemoveHexSigns.Maximum)
                        this.progressBarRemoveHexSigns.Value = Position;
                    this.RemoveHexSignAllPosition(KV.Key, C);

                    //this._RemoveHexSignColumn = C;
                    this._PositionRemoveHexSigns = 1;
                    if (this.RemoveHexSignsQuery())
                    {
                        Stop = true;
                        break;
                    }
                    ColumnsDone.Add(this._RemoveHexSignColumn);
                }
                if (Stop)
                    break;
                _RemoveHexSignAllTablesDone.Add(KV.Key);

            }
            if (!Stop)
            {
                System.Windows.Forms.MessageBox.Show("Query finished");
                this.buttonRemoveHexSignsAllStop.Enabled = true;
                this.buttonRemoveHexSignsAll.Enabled = true;

            }
        }

        private void RemoveHexSignAllPosition(string Table, string Column)
        {
            this._RemoveHexSignColumn = Column;
            this.comboBoxRemoveHexSignsColumn.Text = Column;
            this._RemoveHexSignTable = Table;
            this.comboBoxRemoveHexSignsTable.Text = Table;
            System.Windows.Forms.Application.DoEvents();
        }


        #endregion

        #endregion

        #endregion

        #region References

        private void initReferences()
        {
            _ReferencesTransferIdentification = new DiversityCollection.Maintenance.ReferencesTransfer(DiversityCollection.Maintenance.ReferencesTransfer.Target.Identification);
            _ReferencesTransferIdentification.initProjectCombobox(this.comboBoxReferencesIdentificationProject);

            _ReferencesTransferSpecimen = new DiversityCollection.Maintenance.ReferencesTransfer(DiversityCollection.Maintenance.ReferencesTransfer.Target.Specimen);
            _ReferencesTransferSpecimen.initProjectCombobox(this.comboBoxReferencesSpecimenProject);
        }

        #region Specimen

        private DiversityCollection.Maintenance.ReferencesTransfer _ReferencesTransferSpecimen;
        private void buttonReferencesSpecimenSearch_Click(object sender, EventArgs e)
        {
            _ReferencesTransferSpecimen.setDatagridSource(this.dataGridViewReferencesSpecimen);
            this.labelReferencesSpecimenResult.Text = _ReferencesTransferSpecimen.ResultCount.ToString() + " datasets for transfer detected";
        }

        private void buttonReferencesSpecimenUpdate_Click(object sender, EventArgs e)
        {
            string Message = _ReferencesTransferSpecimen.TransferData(this.dataGridViewReferencesSpecimen);
            System.Windows.Forms.MessageBox.Show(Message);
        }

        private void comboBoxReferencesSpecimenProject_SelectedIndexChanged(object sender, EventArgs e)
        {
            System.Data.DataRowView r = (System.Data.DataRowView)this.comboBoxReferencesSpecimenProject.SelectedItem;
            int ID;
            if (int.TryParse(r.Row["ProjectID"].ToString(), out ID))
                _ReferencesTransferSpecimen.SetProjectID(ID);
            else _ReferencesTransferSpecimen.SetProjectID(null);
        }

        private void buttonReferencesSpecimenDetails_Click(object sender, EventArgs e)
        {
            // #173
            if (this.dataGridViewReferencesSpecimen.DataSource == null) return;

            int ID;
            int Row = this.dataGridViewReferencesSpecimen.SelectedCells[0].RowIndex;
            if (int.TryParse(this.dataGridViewReferencesSpecimen.Rows[Row].Cells[0].Value.ToString(), out ID))
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                DiversityCollection.Forms.FormCollectionSpecimen f =_ReferencesTransferSpecimen.ShowDetails(ID);
                f.StartPosition = FormStartPosition.CenterParent;
                f.Width = this.Width - 10;
                f.Height = this.Height - 10;
                this.Cursor = System.Windows.Forms.Cursors.Default;
                f.ShowDialog();
            }
            else System.Windows.Forms.MessageBox.Show("Please select the data you want to see");
        }

        #region Match
        private void radioButtonReferencesSpecimenMatchExistence_Click(object sender, EventArgs e)
        {
            ReferencesTransferSpecimenSetMatch();
        }

        private void radioButtonTitle_Click(object sender, EventArgs e)
        {
            ReferencesTransferSpecimenSetMatch();
        }

        private void radioButtonReferencesSpecimenMatchUri_Click(object sender, EventArgs e)
        {
            ReferencesTransferSpecimenSetMatch();
        }

        private void radioButtonReferencesSpecimenMatchAll_Click(object sender, EventArgs e)
        {
            ReferencesTransferSpecimenSetMatch();
        }

        private void ReferencesTransferSpecimenSetMatch()
        {
            if (radioButtonReferencesSpecimenMatchExistence.Checked) _ReferencesTransferSpecimen.setMatch(DiversityCollection.Maintenance.ReferencesTransfer.Match.Existence);
            else if (radioButtonReferencesSpecimenMatchUri.Checked) _ReferencesTransferSpecimen.setMatch(DiversityCollection.Maintenance.ReferencesTransfer.Match.URI);
            else if (radioButtonReferencesSpecimenMatchAll.Checked) _ReferencesTransferSpecimen.setMatch(DiversityCollection.Maintenance.ReferencesTransfer.Match.AllColumns);
            else _ReferencesTransferSpecimen.setMatch(DiversityCollection.Maintenance.ReferencesTransfer.Match.Title);
        }

        #endregion

        #endregion

        #region Identification

        private DiversityCollection.Maintenance.ReferencesTransfer _ReferencesTransferIdentification;

        private void buttonReferencesIdentificationSearch_Click(object sender, EventArgs e)
        {
            _ReferencesTransferIdentification.setDatagridSource(this.dataGridViewReferencesIdentification);
            this.labelReferencesIdentificationResult.Text = _ReferencesTransferIdentification.ResultCount.ToString() + " datasets for transfer detected";
        }

        private void buttonReferencesIdentificationDetails_Click(object sender, EventArgs e)
        {
            int ID;
            int Row = this.dataGridViewReferencesIdentification.SelectedCells[0].RowIndex;
            if (int.TryParse(this.dataGridViewReferencesIdentification.Rows[Row].Cells[0].Value.ToString(), out ID))
            {
                this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
                DiversityCollection.Forms.FormCollectionSpecimen f = _ReferencesTransferIdentification.ShowDetails(ID);
                f.StartPosition = FormStartPosition.CenterParent;
                f.Width = this.Width - 10;
                f.Height = this.Height - 10;
                this.Cursor = System.Windows.Forms.Cursors.Default;
                f.ShowDialog();
            }
            else System.Windows.Forms.MessageBox.Show("Please select the data you want to see");
        }

        private void buttonReferencesIdentificationTransfer_Click(object sender, EventArgs e)
        {
            string Message = _ReferencesTransferIdentification.TransferData(this.dataGridViewReferencesIdentification);
            System.Windows.Forms.MessageBox.Show(Message);
        }

        private void comboBoxReferencesIdentificationProject_SelectedIndexChanged(object sender, EventArgs e)
        {
            System.Data.DataRowView r = (System.Data.DataRowView)this.comboBoxReferencesIdentificationProject.SelectedItem;
            int ID;
            if (int.TryParse(r.Row["ProjectID"].ToString(), out ID))
                _ReferencesTransferIdentification.SetProjectID(ID);
            else _ReferencesTransferIdentification.SetProjectID(null);
        }

        #region Match
        private void radioButtonReferencesIdentificationMatchExistence_Click(object sender, EventArgs e)
        {
            ReferencesTransferIdentificationSetMatch();
        }

        private void radioButtonReferencesIdentificationMatchTitle_Click(object sender, EventArgs e)
        {
            ReferencesTransferIdentificationSetMatch();
        }

        private void ReferencesTransferIdentificationSetMatch()
        {
            if (radioButtonReferencesIdentificationMatchExistence.Checked) _ReferencesTransferIdentification.setMatch(DiversityCollection.Maintenance.ReferencesTransfer.Match.Existence);
            //else if (radioButtonReferencesSpecimenMatchUri.Checked) _ReferencesTransferSpecimen.setMatch(DiversityCollection.Maintenance.ReferencesTransfer.Match.URI);
            //else if (radioButtonReferencesSpecimenMatchAll.Checked) _ReferencesTransferSpecimen.setMatch(DiversityCollection.Maintenance.ReferencesTransfer.Match.AllColumns);
            else _ReferencesTransferIdentification.setMatch(DiversityCollection.Maintenance.ReferencesTransfer.Match.Title);
        }

        #endregion

        #endregion

        #endregion

        #region Collector

        private System.Data.DataTable _DtCollectorsSequence;
        private Microsoft.Data.SqlClient.SqlConnection _sqlConnectionCollectorsSequence;
        private void buttonCollectorsSequenceSearch_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            this.CollectorsSequenceSearch();
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private void CollectorsSequenceSearch()
        {
            string SQL = "SELECT CollectionSpecimenID, CollectorsSequence, MIN(CollectorsName) AS [First collector], MAX(CollectorsName) AS [Last collector], COUNT(*) AS [Number of colletors] " +
                "FROM CollectionAgent AS A " +
                "GROUP BY CollectionSpecimenID, CollectorsSequence " +
                "HAVING(COUNT(*) > 1)";
            _DtCollectorsSequence = new DataTable();
            DiversityWorkbench.Forms.FormFunctions.SqlFillTable(SQL, ref _DtCollectorsSequence);
            this.labelCollectorsSequenceResult.Text = this._DtCollectorsSequence.Rows.Count.ToString() + " datasets with same collector sequence detected";
            this.dataGridViewCollectorsSequence.DataSource = _DtCollectorsSequence;

        }

        private void buttonCollectorsSequenceUpdate_Click(object sender, EventArgs e)
        {
            this.Cursor = System.Windows.Forms.Cursors.WaitCursor;
            if (CollectorsSequenceUpdate())
                this.CollectorsSequenceSearch();
            this.Cursor = System.Windows.Forms.Cursors.Default;
        }

        private bool CollectorsSequenceUpdate()
        {
            if (_sqlConnectionCollectorsSequence == null)
            {
                _sqlConnectionCollectorsSequence = new Microsoft.Data.SqlClient.SqlConnection(DiversityWorkbench.Settings.ConnectionString);
                _sqlConnectionCollectorsSequence.Open();
            }
            if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(this.CollectorsSequenceTempTable(), _sqlConnectionCollectorsSequence))
            {
                if (DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(this.CollectorsSequenceFillTempTable(), _sqlConnectionCollectorsSequence))
                {
                    return DiversityWorkbench.Forms.FormFunctions.SqlExecuteNonQuery(this.CollectorsSequenceUpdateCommand(), _sqlConnectionCollectorsSequence);
                }
            }
            return false;
        }

        private string CollectorsSequenceTempTable()
        {
            return "BEGIN TRY\r\n" +
 //               "DROP TABLE  #CollectionAgent;\r\n" +
                "CREATE TABLE #CollectionAgent(\r\n" +
                "[CollectionSpecimenID] [int] NOT NULL,\r\n" +
                "[CollectorsName] [nvarchar](255) NOT NULL,\r\n" +
                "[CollectorsSequence] [datetime2](7) NULL,\r\n" +
                "[CollectorsCount] [int] NULL,\r\n" +
                "CONSTRAINT[PK_#CollectionAgent] PRIMARY KEY CLUSTERED\r\n" +
                "([CollectionSpecimenID] ASC, [CollectorsName] ASC))\r\n" +
                "END TRY\r\n" +
                "BEGIN CATCH\r\n" +
                "TRUNCATE TABLE #CollectionAgent\r\n" +
                "END CATCH;\r\n";
        }

        private string CollectorsSequenceRemoveTempTable()
        {
            return "BEGIN TRY\r\n" +
                "DROP TABLE  #CollectionAgent;\r\n" +
                "END TRY\r\n" +
                "BEGIN CATCH\r\n" +
                "END CATCH;\r\n";
        }


        private string CollectorsSequenceFillTempTable()
        {
            return "INSERT INTO #CollectionAgent(CollectionSpecimenID, CollectorsName, CollectorsSequence, CollectorsCount)\r\n" +
                "SELECT CollectionSpecimenID, MAX(CollectorsName) AS [Last collector], CollectorsSequence, COUNT(*) AS [Number of colletors]\r\n" +
                "FROM CollectionAgent AS A\r\n" +
                "GROUP BY CollectionSpecimenID, CollectorsSequence\r\n" +
                "HAVING(COUNT(*) > 1)";
        }

        private string CollectorsSequenceUpdateCommand()
        {
            return "UPDATE A SET A.CollectorsSequence = DATEADD(ms, T.CollectorsCount, T.CollectorsSequence) \r\n" +
                "FROM CollectionAgent AS A\r\n" +
                "INNER JOIN #CollectionAgent T ON T.CollectionSpecimenID = A.CollectionSpecimenID AND T.CollectorsName COLLATE database_default = A.CollectorsName COLLATE database_default\r\n";
        }

        private void splitContainerCollectorsSequence_HelpRequested(object sender, HelpEventArgs hlpevent)
        {
            string Link = global::DiversityCollection.Properties.Settings.Default.DiversityCollectionManualUrl;
            Help.ShowHelp(this, Link + "/maintenance/collectors/index.html");
        }

        #endregion

        #region Manual

        /// <summary>
        /// Adding event deletates to form and controls
        /// </summary>
        /// <returns></returns>
        private async System.Threading.Tasks.Task InitManual()
        {
            try
            {

                DiversityWorkbench.DwbManual.Hugo manual = new Hugo(this.helpProvider, this);
                if (manual != null)
                {
                    await manual.addKeyDownF1ToForm();
                }
            }
            catch (Exception ex) { DiversityWorkbench.ExceptionHandling.WriteToErrorLogFile(ex); }
        }

        /// <summary>
        /// ensure that init is only done once
        /// </summary>
        private bool _InitManualDone = false;


        /// <summary>
        /// KeyDown of the form adding event deletates to form and controls within the form
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private async void Form_KeyDown(object sender, KeyEventArgs e)
        {
            try
            {
                if (!_InitManualDone)
                {
                    await this.InitManual();
                    _InitManualDone = true;
                }
            }
            catch (Exception ex) { MessageBox.Show(ex.Message); }
        }

        #endregion

    }

}